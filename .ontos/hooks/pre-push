#!/bin/bash
# Ontos pre-push hook - enforces session archiving before push
#
# Behavior controlled by ENFORCE_ARCHIVE_BEFORE_PUSH in ontos_config.py:
# - True (default): BLOCK push until session is archived
# - False: Advisory only - show reminder but allow push
#
# To bypass in emergencies: git push --no-verify

MARKER_FILE=".ontos/session_archived"
SCRIPTS_DIR=".ontos/scripts"

# Check if Ontos is installed
if [ ! -d "$SCRIPTS_DIR" ]; then
    # No Ontos installation, skip check
    exit 0
fi

# Check config: is blocking enabled?
# We call Python to read the config (keeps logic centralized)
ENFORCE_BLOCKING=$(python3 -c "
import sys
sys.path.insert(0, '$SCRIPTS_DIR')
try:
    from ontos_config import ENFORCE_ARCHIVE_BEFORE_PUSH
    print('true' if ENFORCE_ARCHIVE_BEFORE_PUSH else 'false')
except:
    print('true')  # Default to blocking if config can't be read
" 2>/dev/null)

# Check if marker file exists
if [ -f "$MARKER_FILE" ]; then
    # Marker exists - session was archived, allow push
    echo ""
    echo "âœ… Session archived. Proceeding with push..."
    echo ""

    # Delete marker (one archive = one push)
    rm -f "$MARKER_FILE"
    exit 0
fi

# No marker - behavior depends on config
if [ "$ENFORCE_BLOCKING" = "true" ]; then
    # BLOCKING MODE: Reject the push
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           âŒ PUSH BLOCKED - NO SESSION ARCHIVED            â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘                                                            â•‘"
    echo "â•‘  You must archive your session before pushing.             â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  Run: \"Archive Ontos\" (or ontos_end_session.py)           â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  This ensures your decisions and context are captured      â•‘"
    echo "â•‘  before code leaves your machine.                          â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  Emergency bypass: git push --no-verify                    â•‘"
    echo "â•‘  (Use sparingly - you'll lose context!)                    â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  To disable blocking: set ENFORCE_ARCHIVE_BEFORE_PUSH      â•‘"
    echo "â•‘  to False in .ontos/scripts/ontos_config.py                â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
else
    # ADVISORY MODE: Show reminder but allow push
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           ğŸ’¡ SESSION LOG REMINDER                          â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘                                                            â•‘"
    echo "â•‘  No session log created for this work.                     â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  Consider running \"Archive Ontos\" to capture your          â•‘"
    echo "â•‘  decisions and changes.                                    â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Proceeding with push (advisory mode)..."
    exit 0
fi
