# v3.0.0 D.1 PR Review — Chief Architect

**PR:** https://github.com/ohjona/Project-Ontos/pull/47
**Branch:** pr-47 (target: v3.0.0)
**Date:** 2026-01-17
**Reviewer:** Chief Architect (Codex)

---

## Part 1: Quick Checks

| Check | Command | Expected | Actual |
|-------|---------|----------|--------|
| Tests pass | `pytest tests/ -v` | All pass | ✅ 417 passed in 6.65s |
| `ontos agents` works | `python -m ontos agents --help` | Help displayed | ✅ |
| `ontos agents` generates AGENTS.md | `python -m ontos agents` | File created | ⚠️ File already existed; `--force` required to regenerate |
| `ontos agents --format=cursor` works | `python -m ontos agents --format=cursor --force` | `.cursorrules` created | ✅ |
| `ontos agents --all` works | `python -m ontos agents --all --force` | Both files created | ✅ |
| `ontos map --strict` clean | `python -m ontos map --strict` | Exit 0, no errors | ❌ Exit 1; 37 errors, 234 warnings |
| `ontos doctor` includes staleness | `python -m ontos doctor` | Agents check present | ✅ (shows `agents_staleness`) |

---

## Part 2: Spec Compliance

Reference: `v3.0.0-Implementation-Specs-v1.1.md` (repo copy in `.ontos-internal/strategy/proposals/v3.0.0/`).

### Feature 1: ontos agents

| Requirement | Spec Section | Implemented? | Correctly? | Notes |
|-------------|--------------|--------------|------------|-------|
| FR1: `ontos agents` CLI command with default AGENTS.md | §3.1 | ✅ | ✅ | Works; default path is repo root |
| FR2: `--format=cursor` outputs .cursorrules | §3.1 | ✅ | ✅ | Output in repo root |
| FR3: `--all` outputs both files | §3.1 | ✅ | ✅ | Both files created |
| FR4: Template includes top-5 commands | §3.1, Appendix A | ✅ | ✅ | Matches template |
| FR5: Template includes stats (doc count, last updated) | §3.1, Appendix A | ✅ | ⚠️ | `last_updated` uses first log file, not max mtime |
| FR6: Template includes staleness warning | §3.1, Appendix A | ✅ | ✅ | Present |
| FR7: Single-source generation (AGENTS canonical) | §3.1 | ✅ | ✅ | .cursorrules derived from AGENTS content |
| FR8: `ontos export` renamed/aliased to agents | §3.1 | ✅ | ✅ | Alias warns and delegates |
| FR9: .cursorrules uses v3.0 commands | §3.1 | ✅ | ✅ | No v2.x paths seen |
| FR10: Generation metadata (version + timestamp) | §3.1 | ✅ | ✅ | Present |
| FR11: `--force` creates .bak backup | §3.1 | ✅ | ✅ | `.cursorrules.bak` and `AGENTS.md.bak` created |
| NFR5: Template injection mitigation | §3.2 | ✅ | ✅ | Only numeric/timestamp placeholders used |
| Path safety (output inside repo root) | §4.5 | ✅ | ✅ | `relative_to` check present |

### Feature 2: PyPI Publishing

| Requirement | Spec Section | Implemented? | Correctly? | Notes |
|-------------|--------------|--------------|------------|-------|
| FR1: Workflow triggers on `v*` tags | §3.1 | ✅ | ✅ | `.github/workflows/publish.yml` |
| FR2: TestPyPI before PyPI | §3.1 | ✅ | ✅ | Job order enforced |
| FR3: Trusted publisher (OIDC) | §3.1 | ✅ | ✅ | `id-token: write` |
| FR5: README git+ fallback | §3.1 | ❌ | ❌ | README missing git+ fallback line |
| FR6: TestPyPI install verification | §3.1 | ✅ | ✅ | Verify job uses `pip install` + `ontos --version` |
| FR7: Tests pass before publish | §3.1 | ✅ | ✅ | `test` job gates build/publish |
| Workflow file exists | §4.2 | ✅ | ✅ | `.github/workflows/publish.yml` |

### Feature 3: Init Exit Code

| Requirement | Spec Section | Implemented? | Correctly? | Notes |
|-------------|--------------|--------------|------------|-------|
| FR1: Return 0 if already initialized | §3.1 | ✅ | ✅ | `return 0` on existing config |
| FR2: Same message text | §3.1 | ✅ | ✅ | Message unchanged |

### Feature 4: Init Auto-Generation

| Requirement | Spec Section | Implemented? | Correctly? | Notes |
|-------------|--------------|--------------|------------|-------|
| FR1: Init generates AGENTS.md | §3.1 | ✅ | ✅ | `_generate_agents_file()` invoked |
| FR2: Init succeeds even if agents fails | §3.1 | ✅ | ✅ | Try/except with warnings |
| FR3: Warning printed on agents failure | §3.1 | ✅ | ✅ | Warnings emitted |
| FR5: Success message references `ontos agents` | §3.1 | ✅ | ✅ | Tip updated |

### Feature 5: Doctor Staleness

| Requirement | Spec Section | Implemented? | Correctly? | Notes |
|-------------|--------------|--------------|------------|-------|
| FR1: Staleness check added to doctor | §3.1 | ✅ | ✅ | `agents_staleness` present |
| FR2: Compare to context map, archives, config | §3.1 | ✅ | ⚠️ | Uses cwd paths; repo-root helper not used |
| FR3: Warning only (no auto-fix) | §3.1 | ✅ | ✅ | Warn only |
| FR4: Specific warning message | §3.1 | ✅ | ✅ | Matches spec |
| Missing sources handling | §4.5 | ✅ | ✅ | Warns if no sources |

### Feature 6: Data Cleanup

| Requirement | Spec Section | Implemented? | Correctly? | Notes |
|-------------|--------------|--------------|------------|-------|
| FR1: Stale `depends_on` references fixed | §3.1 | ❌ | ❌ | `ontos map --strict` reports 37 errors |
| FR2: `ontos map --strict` exits 0 | §3.1 | ❌ | ❌ | Exit 1 with errors |

---

## Part 3: Scope Check

| Question | Answer |
|----------|--------|
| Any files modified that aren't in the spec? | Unable to diff vs `v3.0.0` (branch appears identical); no obvious scope creep in code review. |
| Any features added beyond spec? | None observed. |
| Any spec requirements skipped? | Data cleanup, README git+ fallback, golden tests for agents outputs, repo-root helper usage in doctor. |

**Scope creep detected?** No

---

## Part 4: Commit Quality

| Aspect | Assessment |
|--------|------------|
| Atomic commits | Unable to assess (no commit delta vs `v3.0.0` branch) |
| Commit messages follow convention | Unable to assess |
| Logical ordering | Unable to assess |

---

## Part 5: Issues Found

**Critical (Blocks Review Board):**

| # | Issue | File/Location | Why Critical |
|---|-------|---------------|--------------|
| CA-C1 | Data cleanup not complete; `ontos map --strict` still fails with 37 errors | `Ontos_Context_Map.md` generation / `.ontos-internal` docs | Spec requires clean map before release |

**Major (Review Board should see):**

| # | Issue | File/Location | Recommendation |
|---|-------|---------------|----------------|
| CA-M1 | README missing git+ fallback install line | `README.md` | Add fallback install command per spec FR5 |
| CA-M2 | Golden baselines for AGENTS/.cursorrules not present | `tests/golden/` | Add required golden tests per spec v1.1 |
| CA-M3 | Doctor staleness check ignores repo-root helper | `ontos/commands/doctor.py` | Use same repo-root resolution as `agents` |
| CA-M4 | `last_updated` uses first log file only (not max mtime) | `ontos/commands/agents.py` | Use max log mtime or skip logs when none |

**Minor (Note for later):**

| # | Issue | File/Location | Suggestion |
|---|-------|---------------|------------|
| CA-m1 | `.cursorrules` backup file created in repo root even for hidden file | `ontos/commands/agents.py` | Acceptable, but confirm naming is desired |

---

## Part 6: Verdict

**Tests pass:** ✅
**Matches spec:** ❌
**No scope creep:** ✅
**Clean commits:** ⚠️ (cannot assess due to missing diff)

**Recommendation:** Needs fixes first

**Required actions before Review Board:**
1. Complete data cleanup so `python -m ontos map --strict` exits 0.
2. Add README git+ fallback install line.
3. Add required golden baselines for AGENTS.md (and .cursorrules if tested).
4. Update doctor staleness check to use repo-root helper.
5. Fix `last_updated` calculation to use max log mtime (not first log).

---

## Notes on Test Artifacts

I generated `AGENTS.md`, `.cursorrules`, and backups in the repo during smoke tests. These are not part of the PR and should not be committed.
