---
id: ontos_technical_architecture_map
type: atom
status: active
depends_on: [v3_0_technical_architecture]
---

# Project Ontos: Technical Architecture Map

**Version:** 1.0
**Date:** 2026-01-13
**Ontos Version:** 3.0.1
**Generated By:** Gemini CLI (Technical Co-Founder)

---

## Quick Reference

| Metric | Value |
|--------|-------|
| Language | Python 3.9+ |
| Total Lines of Code | ~4,200 (core package) |
| Total Files | 114 .py files |
| Package Size | ~3 MB |
| Dependencies | `pyyaml`, `tomli` (py<3.11) |
| Commands | 13 CLI commands |
| Test Files | 46 |

---

## 1. Directory Structure

```
ontos/                      # Root package (57 lines)
├── __init__.py            # Package init, version
├── __main__.py            # Entry point: python -m ontos
├── cli.py                 # CLI setup, argument parsing (457 lines)
│
├── core/                  # Pure business logic (no I/O)
│   ├── __init__.py        # Exports (86 lines)
│   ├── context.py         # SessionContext (271 lines)
│   ├── graph.py           # Dependency Graph (175 lines)
│   ├── validation.py      # Validation Orchestrator (178 lines)
│   ├── types.py           # Dataclasses/Enums (134 lines)
│   └── ...
│
├── io/                    # File system, git operations
│   ├── __init__.py        # Exports (73 lines)
│   ├── git.py             # Git subprocess calls (195 lines)
│   ├── files.py           # File operations (193 lines)
│   ├── toml.py            # TOML config I/O (128 lines)
│   └── yaml.py            # YAML helpers (103 lines)
│
├── ui/                    # Output formatting, user interaction
│   ├── __init__.py        # Exports (34 lines)
│   ├── output.py          # OutputHandler (108 lines)
│   └── json_output.py     # JSON formatter (126 lines)
│
├── commands/              # CLI command implementations
│   ├── __init__.py        # Exports (149 lines)
│   ├── init.py            # `ontos init` (255 lines)
│   ├── map.py             # `ontos map` (271 lines)
│   ├── log.py             # `ontos log` (221 lines)
│   ├── doctor.py          # `ontos doctor` (427 lines)
│   └── ...
│
└── _hooks/                # Git hook shims
    ├── pre-commit
    └── pre-push

tests/                     # Test suite
├── core/                  # Unit tests for core/
├── io/                    # Unit tests for io/
├── commands/              # Integration tests for commands
├── golden/                # Golden master tests
└── ...

.ontos-internal/           # Project strategy docs (not in package)
docs/                      # Documentation
```

### 1.1 Directory Purposes

| Directory | Purpose | Import Constraints |
|-----------|---------|-------------------|
| `ontos/core/` | Pure business logic, algorithms | Cannot import from `io/` or `ui/` |
| `ontos/io/` | File system, git, external I/O | Cannot import from `ui/` or `commands/` |
| `ontos/ui/` | Output formatting, colors, JSON | Cannot import from `io/` or `commands/` |
| `ontos/commands/` | CLI command handlers | Can import from all |
| `ontos/` (root) | Entry points (`cli.py`, `__main__.py`) | Can import from all |
| `tests/` | Test suite | Mirrors `ontos/` structure |

### 1.2 File Counts

| Directory | .py Files | Lines of Code (approx) |
|-----------|-----------|------------------------|
| `ontos/core/` | 14 | ~2,100 |
| `ontos/io/` | 6 | ~700 |
| `ontos/ui/` | 3 | ~270 |
| `ontos/commands/` | 13 | ~2,200 |
| `ontos/` (root) | 4 | ~600 |
| `tests/` | 46 | ~3,500 |
| **Total** | **86** | **~9,370** |

---

## 2. Code Metrics

### 2.1 Largest Files (Complexity Indicators)

| Rank | File | Lines | Notes |
|------|------|-------|-------|
| 1 | `ontos/cli.py` | 457 | Main entry point, arg parsing |
| 2 | `ontos/commands/doctor.py` | 427 | Comprehensive diagnostics |
| 3 | `ontos/core/schema.py` | 421 | Schema validation & migration logic |
| 4 | `ontos/core/staleness.py` | 379 | Staleness detection logic |
| 5 | `ontos/core/paths.py` | 345 | Path resolution logic |

### 2.2 Code Distribution

```
core/     ████████████████████  (~35%)
commands/ ████████████████████  (~35%)
io/       ████████              (~12%)
ui/       ███                   (~5%)
cli/init  ███████               (~13%)
```

---

## 3. Package Architecture

### 3.1 Entry Points

```toml
# From pyproject.toml
[project.scripts]
ontos = "ontos.cli:main"
```

**Entry Point Flow:**
```
$ ontos [command] [args]
    │
    ▼
ontos/__main__.py
    │
    ▼
ontos/cli.py:main()
    │
    ▼
argparse dispatches to:
    │
    ├─▶ ontos/commands/[command].py:run()
    │       │
    │       ├─▶ ontos/core/[module].py (business logic)
    │       ├─▶ ontos/io/[module].py (file/git operations)
    │       └─▶ ontos/ui/[module].py (output formatting)
    │
    └─▶ sys.exit([exit_code])
```

### 3.2 Layer Architecture

```
┌─────────────────────────────────────────┐
│              CLI Layer                  │
│         ontos/cli.py                    │
│         ontos/commands/*.py             │
└────────────────┬────────────────────────┘
                 │ calls
        ┌────────┼────────┐
        ▼        ▼        ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│  core/  │ │   io/   │ │   ui/   │
│         │ │         │ │         │
│ Logic   │ │ Files   │ │ Output  │
│ Rules   │ │ Git     │ │ Format  │
│ Models  │ │ Config  │ │ Colors  │
└─────────┘ └─────────┘ └─────────┘
     │            │           │
     └────────────┴───────────┘
            NO cross-imports
            (core cannot import io/ui)
```

### 3.3 Module Dependencies (Internal)

- `ontos.core` is STRICTLY pure. It does not import `io`, `ui`, or `commands`.
- `ontos.io` handles all side effects.
- `ontos.commands` orchestrates.

---

## 4. CLI Reference

### 4.1 Command Summary

| Command | Purpose |
|---------|---------|
| `ontos init` | Initialize Ontos in a project |
| `ontos map` | Generate context map |
| `ontos log` | End session logging |
| `ontos doctor` | Health check and diagnostics |
| `ontos export` | Generate CLAUDE.md for AI assistants |
| `ontos hook` | Git hook dispatcher (internal) |
| `ontos verify` | Verify describes dates |
| `ontos query` | Search documents |
| `ontos migrate` | Schema migration |
| `ontos consolidate` | Archive old logs |
| `ontos promote` | Promote curation level |
| `ontos scaffold` | Generate scaffolds |
| `ontos stub` | Create stub documents |

### 4.2 Global Options

| Option | Description |
|--------|-------------|
| `--help`, `-h` | Show help message |
| `--version`, `-V` | Show version |
| `--json` | Output in JSON format |
| `--quiet`, `-q` | Suppress non-essential output |

---

## 5. Core Modules

### 5.1 `ontos/core/`

#### `context.py` (271 lines)
Manages the `SessionContext`, tracking read/write operations transactionally. Ensures atomicity of multi-file updates.

#### `graph.py` (175 lines)
Builds the dependency graph, detects cycles, and finds orphans. Uses purely in-memory data structures.

#### `validation.py` (178 lines)
Orchestrates validation rules (schema, staleness, broken links) and aggregates errors/warnings instead of failing fast.

#### `types.py` (134 lines)
Shared data classes and enums (`DocumentType`, `Status`, `ValidationError`) used across the system.

### 5.2 `ontos/io/`

#### `git.py` (195 lines)
Wraps `subprocess` calls to git. Handles `git diff`, `git log`, and hook installation.

#### `files.py` (193 lines)
Handles filesystem operations: finding the project root (walking up to `.ontos.toml`), scanning for markdown files, and reading content.

#### `toml.py` (128 lines)
Handles `.ontos.toml` reading and writing. Uses `tomli` for Python < 3.11.

### 5.3 `ontos/ui/`

#### `output.py` (108 lines)
Handles terminal output with emoji and colors (via `rich` if available, or fallbacks).

#### `json_output.py` (126 lines)
Serializes internal objects (`ValidationResult`, `ContextMap`) into structured JSON for the `--json` flag.

---

## 6. Configuration

### 6.1 Config File

**Location:** `.ontos.toml` (in repository root)

**Format:**
```toml
[ontos]
version = "3.0"

[paths]
docs_dir = "docs"
logs_dir = "docs/logs"

[workflow]
require_source_in_logs = true
```

### 6.3 Config Locations (Priority Order)

1. Command-line arguments (highest)
2. Environment variables (`ONTOS_*`)
3. `.ontos.toml` in repo
4. Built-in defaults (lowest)

---

## 7. Dependencies

### 7.1 Runtime Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `pyyaml` | `>=6.0` | YAML parsing for frontmatter |
| `tomli` | `>=2.0` | TOML parsing (Python < 3.11) |

### 7.2 Development Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `pytest` | `>=7.0` | Testing |
| `pytest-cov` | `>=4.0` | Coverage |

---

## 8. Testing

### 8.1 Test Structure

```
tests/
├── commands/            # 7 files
├── core/                # 2 files + legacy mapping
├── io/                  # 2 files
├── ui/                  # 1 file
├── golden/              # Golden master output tests
└── ...
```

### 8.2 Test Counts
- **Total Test Files:** 46
- **Golden Master:** Ensures v3 output matches v2 behavior exactly.

---

## 9. Build & Distribution

### 9.1 Building

```bash
python -m build
# Output: dist/ontos-3.0.1-py3-none-any.whl
```

### 9.2 Installing

```bash
pip install ontos
```

### 9.3 PyPI Status

- **Package:** `ontos`
- **Version:** `3.0.1`
- **License:** MIT

---

*Document generated: 2026-01-13*
*Ontos Version: 3.0.1*
