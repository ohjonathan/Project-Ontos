---
id: ontos_technical_architecture_map_codex
type: atom
status: active
depends_on: [v3_0_technical_architecture]
concepts: [architecture, cli, package-structure, metrics, testing]
---

# Project Ontos: Technical Architecture Map Codex

**Version:** 2.0
**Date:** 2026-01-17
**Ontos Version:** 3.0.2
**Generated By:** Claude Opus 4.5

---

## Quick Reference Table

| Metric | Value |
|--------|-------|
| Language | Python 3.9+ |
| Package LOC | ~12,647 |
| Test LOC | ~6,243 |
| Python Files | 64 |
| Test Files | 41 |
| CLI Commands | 14 |
| Dependencies | 2 runtime (pyyaml, tomli) |
| Entry Point | `ontos.cli:main` |

---

## 1. Directory Structure

```
ontos/                          # Root package
├── __init__.py                 # Package metadata, version (57 lines)
├── __main__.py                 # Entry: python -m ontos (13 lines)
├── cli.py                      # CLI setup, argument parsing (511 lines)
│
├── core/                       # Pure business logic (16 files, ~3,812 lines)
│   ├── __init__.py             # Public API exports
│   ├── config.py               # Config defaults
│   ├── context.py              # SessionContext
│   ├── curation.py             # Three-tier curation (489 lines)
│   ├── frontmatter.py          # YAML parsing
│   ├── graph.py                # Dependency graph
│   ├── history.py              # Decision history
│   ├── ontology.py             # Type definitions (193 lines)
│   ├── paths.py                # Path resolution (345 lines)
│   ├── proposals.py            # Proposal helpers
│   ├── schema.py               # Schema versioning (421 lines)
│   ├── staleness.py            # Staleness detection (379 lines)
│   ├── suggestions.py          # Impact/concept suggestions
│   ├── tokens.py               # Token estimation
│   ├── types.py                # Dataclasses/Enums
│   └── validation.py           # ValidationOrchestrator
│
├── commands/                   # CLI command handlers (15 files, ~2,413 lines)
│   ├── __init__.py             # Command exports
│   ├── agents.py               # `ontos agents` (315 lines)
│   ├── consolidate.py          # `ontos consolidate`
│   ├── doctor.py               # `ontos doctor` (515 lines)
│   ├── export.py               # `ontos export` (deprecated)
│   ├── hook.py                 # Git hook dispatcher
│   ├── init.py                 # `ontos init`
│   ├── log.py                  # `ontos log` (316 lines)
│   ├── map.py                  # `ontos map`
│   ├── migrate.py              # `ontos migrate`
│   ├── promote.py              # `ontos promote`
│   ├── query.py                # `ontos query`
│   ├── scaffold.py             # `ontos scaffold`
│   ├── stub.py                 # `ontos stub`
│   └── verify.py               # `ontos verify`
│
├── io/                         # I/O operations (6 files, ~767 lines)
│   ├── __init__.py             # I/O exports
│   ├── config.py               # Config loading
│   ├── files.py                # File operations
│   ├── git.py                  # Git subprocess calls
│   ├── toml.py                 # TOML config I/O
│   └── yaml.py                 # YAML helpers
│
├── ui/                         # Output formatting (3 files, ~268 lines)
│   ├── __init__.py             # UI exports
│   ├── json_output.py          # JSON formatter
│   └── output.py               # OutputHandler
│
├── _scripts/                   # Legacy scripts (17 files, ~4,777 lines)
│   ├── ontos.py                # Legacy entry point
│   ├── ontos_consolidate.py    # (466 lines)
│   ├── ontos_end_session.py    # Session logging
│   ├── ontos_generate_context_map.py
│   ├── ontos_migrate_schema.py # (337 lines)
│   ├── ontos_pre_commit_check.py
│   ├── ontos_pre_push_check.py # (387 lines)
│   ├── ontos_promote.py        # (453 lines)
│   ├── ontos_query.py          # (322 lines)
│   ├── ontos_scaffold.py
│   ├── ontos_stub.py
│   ├── ontos_update.py         # (521 lines)
│   ├── ontos_verify.py
│   └── ...
│
├── _templates/                 # Template files (2 files, ~27 lines)
├── _hooks/                     # Git hook shims (1 file)
└── mcp/                        # MCP stub (1 file)

tests/                          # Test suite (41 files, ~6,243 lines)
├── commands/                   # Command integration tests
├── core/                       # Unit tests for core/
├── io/                         # Unit tests for io/
├── golden/                     # Golden master tests
└── ...
```

---

## 2. Code Metrics

### 2.1 Lines by Directory

| Directory | Files | Lines | % of Package |
|-----------|-------|-------|--------------|
| `ontos/core/` | 16 | ~3,812 | 30% |
| `ontos/commands/` | 15 | ~2,413 | 19% |
| `ontos/_scripts/` | 17 | ~4,777 | 38% |
| `ontos/io/` | 6 | ~767 | 6% |
| `ontos/ui/` | 3 | ~268 | 2% |
| `ontos/` (root) | 4 | ~581 | 5% |
| **Total Package** | **64** | **~12,647** | **100%** |
| `tests/` | 41 | ~6,243 | — |

### 2.2 Largest Files

| Rank | File | Lines | Purpose |
|------|------|-------|---------|
| 1 | `_scripts/ontos_update.py` | 521 | Self-update logic |
| 2 | `commands/doctor.py` | 515 | Comprehensive diagnostics |
| 3 | `cli.py` | 511 | CLI argument parsing |
| 4 | `core/curation.py` | 489 | Three-tier curation logic |
| 5 | `_scripts/ontos_consolidate.py` | 466 | Log consolidation |
| 6 | `_scripts/ontos_promote.py` | 453 | Curation promotion |
| 7 | `core/schema.py` | 421 | Schema validation |
| 8 | `_scripts/ontos_pre_push_check.py` | 387 | Pre-push hook logic |
| 9 | `core/staleness.py` | 379 | Staleness detection |
| 10 | `core/paths.py` | 345 | Path resolution |

### 2.3 Code Distribution

```
core/     ██████████████████████████████  30%
scripts/  ██████████████████████████████████████  38%
commands/ ███████████████████  19%
io/       ██████  6%
ui/       ██  2%
root/     █████  5%
```

---

## 3. Package Architecture

### 3.1 Entry Point

```toml
# From pyproject.toml
[project.scripts]
ontos = "ontos.cli:main"
```

**Invocation Flow:**
```
$ ontos [command] [args]
    │
    ▼
ontos/__main__.py
    │
    ▼
ontos/cli.py:main()
    │
    ▼
argparse dispatches to:
    │
    ├─▶ ontos/commands/[command].py:run()
    │       │
    │       ├─▶ ontos/core/[module].py (pure logic)
    │       ├─▶ ontos/io/[module].py (I/O operations)
    │       └─▶ ontos/ui/[module].py (output formatting)
    │
    └─▶ sys.exit([exit_code])
```

### 3.2 Layer Architecture

```
┌─────────────────────────────────────────┐
│              CLI Layer                  │
│         ontos/cli.py                    │
│         ontos/commands/*.py             │
└────────────────┬────────────────────────┘
                 │ calls
        ┌────────┼────────┐
        ▼        ▼        ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│  core/  │ │   io/   │ │   ui/   │
│         │ │         │ │         │
│ Logic   │ │ Files   │ │ Output  │
│ Rules   │ │ Git     │ │ Format  │
│ Models  │ │ Config  │ │ Colors  │
└─────────┘ └─────────┘ └─────────┘
     │            │           │
     └────────────┴───────────┘
            NO cross-imports
            (core cannot import io/ui)
```

### 3.3 Dependency Rules

- **CLI Layer** → Command Layer → Core Layer → (nothing)
- **CLI Layer** → I/O Layer (for output, config loading)
- **Command Layer** → I/O Layer (for git, files)
- **Core Layer** MUST NOT import from Command, CLI, or I/O layers

---

## 4. CLI Reference

### 4.1 All Commands

| Command | Purpose | Implementation |
|---------|---------|----------------|
| `ontos init` | Initialize Ontos in a project | `commands/init.py` |
| `ontos map` | Generate context map | `commands/map.py` → `_scripts/` |
| `ontos log` | End session logging | `commands/log.py` |
| `ontos doctor` | Health check and diagnostics | `commands/doctor.py` |
| `ontos agents` | Generate AGENTS.md/.cursorrules | `commands/agents.py` |
| `ontos export` | (Deprecated) Alias for agents | `commands/export.py` |
| `ontos hook` | Git hook dispatcher (internal) | `commands/hook.py` |
| `ontos verify` | Verify describes dates | wrapper → `_scripts/` |
| `ontos query` | Search documents | wrapper → `_scripts/` |
| `ontos migrate` | Schema migration | wrapper → `_scripts/` |
| `ontos consolidate` | Archive old logs | wrapper → `_scripts/` |
| `ontos promote` | Promote curation level | wrapper → `_scripts/` |
| `ontos scaffold` | Generate scaffolds | wrapper → `_scripts/` |
| `ontos stub` | Create stub documents | wrapper → `_scripts/` |

### 4.2 Global Options

| Option | Description |
|--------|-------------|
| `--help`, `-h` | Show help message |
| `--version`, `-V` | Show version |
| `--json` | Output in JSON format |
| `--quiet`, `-q` | Suppress non-essential output |

### 4.3 Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Validation Error |
| 2 | Configuration Error |
| 3 | User Input Error |
| 4 | Git Error |
| 5 | Internal Error |

---

## 5. Core Modules Breakdown

### 5.1 `ontos/core/`

| Module | Lines | Purpose |
|--------|-------|---------|
| `ontology.py` | 193 | **Single source of truth** for type/field definitions |
| `curation.py` | 489 | Three-tier curation (L0/L1/L2) validation |
| `schema.py` | 421 | Schema version detection and migration |
| `staleness.py` | 379 | `describes` validation, staleness detection |
| `paths.py` | 345 | Path resolution, project root detection |
| `context.py` | ~270 | SessionContext for transactional writes |
| `graph.py` | ~175 | Dependency graph, cycle detection |
| `validation.py` | ~180 | ValidationOrchestrator, error aggregation |
| `frontmatter.py` | ~100 | YAML frontmatter parsing |
| `types.py` | ~135 | Dataclasses, enums |
| `suggestions.py` | ~200 | Impact/concept suggestions |
| `tokens.py` | ~50 | Token estimation |
| `config.py` | ~70 | Config defaults |
| `history.py` | ~220 | Decision history generation |
| `proposals.py` | ~150 | Proposal detection |

### 5.2 Key Core Concepts

**SessionContext** (`context.py`)
- Manages transactional file operations
- Tracks read/write intents
- Executes via `commit()` in I/O layer

**ValidationOrchestrator** (`validation.py`)
- Collects all errors before returning (no hard exits)
- Unified error/warning aggregation
- Returns `ValidationResult` with exit code

**TypeDefinition** (`ontology.py`)
- Defines the 5 document types (kernel, strategy, product, atom, log)
- Specifies ranks, allowed dependencies, valid statuses
- Immutable dataclass (frozen=True)

---

## 6. Configuration

### 6.1 `.ontos.toml` Schema

```toml
[ontos]
version = "3.0"
required_version = ">=3.0.0"

[paths]
docs_dir = "docs"
logs_dir = "docs/logs"
context_map = "Ontos_Context_Map.md"

[scanning]
skip_patterns = ["_template.md", "archive/*"]

[validation]
max_dependency_depth = 5
allowed_orphan_types = ["atom"]
strict = false

[workflow]
enforce_archive_before_push = true
require_source_in_logs = true
log_retention_count = 20

[hooks]
pre_push = true
pre_commit = true
```

### 6.2 Config Resolution Order

```
CLI Flags (highest priority)
    ↓
Environment Variables (ONTOS_*)
    ↓
.ontos.toml
    ↓
Built-in Defaults (lowest priority)
```

---

## 7. Dependencies

### 7.1 Runtime Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `pyyaml` | `>=6.0,<7.0` | YAML parsing for frontmatter |
| `tomli` | `>=2.0.1,<3.0` | TOML parsing (Python < 3.11 only) |

**Note:** Python 3.11+ uses stdlib `tomllib` — no external TOML dependency.

### 7.2 Development Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `pytest` | `>=7.0,<9.0` | Testing framework |
| `pytest-cov` | `>=4.0,<6.0` | Coverage reporting |
| `pre-commit` | `>=3.0,<5.0` | Git hooks |

### 7.3 Optional Dependencies

| Group | Packages | Purpose |
|-------|----------|---------|
| `dev` | pytest, pytest-cov, pre-commit | Development |
| `mcp` | pydantic>=2.0 | MCP server (v4.0) |

---

## 8. Testing Structure

### 8.1 Test Organization

```
tests/
├── commands/           # Integration tests for CLI commands
├── core/               # Unit tests for core/ modules
├── io/                 # Unit tests for I/O operations
├── ui/                 # Unit tests for output formatting
├── golden/             # Golden master output tests
├── fixtures/           # Test data
└── conftest.py         # Shared fixtures
```

### 8.2 Test Metrics

| Metric | Value |
|--------|-------|
| Test Files | 41 |
| Test LOC | ~6,243 |
| Target Coverage (core/) | 90%+ |
| Target Coverage (commands/) | 80%+ |
| Target Coverage (overall) | 80%+ |

### 8.3 Testing Patterns

- **Unit tests:** Pure function tests in `tests/core/`
- **Integration tests:** Multi-module tests in `tests/commands/`
- **Golden master:** Output comparison tests in `tests/golden/`

---

## 9. Build & Distribution

### 9.1 Package Build

```bash
python -m build
# Output: dist/ontos-3.0.2-py3-none-any.whl
```

### 9.2 Installation

```bash
# From PyPI
pip install ontos

# From source (editable)
pip install -e .
```

### 9.3 Package Discovery

```toml
# pyproject.toml
[tool.setuptools.packages.find]
where = ["."]
include = ["ontos", "ontos.*"]

[tool.setuptools.package-data]
"ontos._scripts" = ["*.py"]
"ontos._templates" = ["*"]
"ontos._hooks" = ["*"]
```

---

## 10. Performance Targets

| Operation | Target |
|-----------|--------|
| CLI startup | <100ms |
| `ontos map` (<100 docs) | <500ms |
| `ontos map` (100-500 docs) | <2s |
| `ontos doctor` | <1s |

---

## 11. v4.0 Extension Points

| Feature | Extension Point | v3.0 Preparation |
|---------|-----------------|------------------|
| **MCP Server** | `ontos/mcp/` | Clean core/IO separation |
| **Daemon Mode** | `ontos/daemon/` | Stateless commands |
| **Export Templates** | `ui/formatters/` | OutputHandler pattern |
| **Watch Mode** | `commands/watch.py` | File change detection |

---

## 12. Key Reference Paths

| Reference | Path |
|-----------|------|
| CLI Entry | `ontos/cli.py:main` |
| Ontology Source | `ontos/core/ontology.py` |
| Configuration | `.ontos.toml` |
| Context Map | `Ontos_Context_Map.md` |
| Version | `ontos/__init__.py:__version__` |
| Type Definitions | `ontos/core/ontology.py:TYPE_DEFINITIONS` |
| Field Definitions | `ontos/core/ontology.py:FIELD_DEFINITIONS` |

---

*End of Technical Architecture Map Codex*
