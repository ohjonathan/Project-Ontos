---
id: ontos_technical_architecture_map_codex
type: atom
status: active
depends_on: [v3_0_technical_architecture]
---

# Project Ontos: Technical Architecture Map

**Version:** 1.1
**Date:** 2026-01-14
**Ontos Version:** 3.0.1 (git describe: v3.0.1-11-g05ffb1e)
**Generated By:** Codex CLI (Deep Research)

---

## Quick Reference

| Metric | Value |
|--------|-------|
| Language | Python 3.9+ |
| Total Lines of Code | 38,530 (excluding `.venv/`) |
| Total .py Files | 176 (excluding `.venv/`) |
| Package Size | 532K (`ontos/` directory) |
| Dependencies | 2 runtime, 3 dev, 1 optional |
| Commands | 13 CLI commands |
| Test Files | 40 total (`test_*.py`: 30) |

---

## 1. Directory Structure

```
ontos/                      # Root package
├── __init__.py             # Package metadata
├── __main__.py             # Entry point: python -m ontos
├── cli.py                  # CLI setup, argument parsing
│
├── core/                   # Pure logic (stdlib-first)
├── io/                     # File system + git I/O
├── ui/                     # Output formatting, JSON
├── commands/               # CLI command implementations
├── _scripts/               # Legacy script wrappers (v2 parity)
├── _hooks/                 # Git hook shims
├── _templates/             # Init templates
└── mcp/                    # Placeholder for MCP layer

tests/                      # Test suite
.ontos/                     # Legacy scripts (repo-local)
.ontos-internal/            # Strategy + analysis docs
.docs/                      # User documentation
```

### 1.1 Directory Purposes

| Directory | Purpose | Import Constraints |
|-----------|---------|-------------------|
| `ontos/core/` | Pure business logic, validation, graph | Should not import `io/` or `ui/` (legacy exceptions noted in code) |
| `ontos/io/` | File system + git operations | No `ui/` imports |
| `ontos/ui/` | Output formatting, JSON | No `io/` imports |
| `ontos/commands/` | CLI orchestration | Can import from all layers |
| `ontos/_scripts/` | Legacy wrappers | Bridges v2 script behavior |
| `tests/` | Test suite | Mirrors `ontos/` structure |

### 1.2 File Counts & Lines

| Directory | .py Files | Lines of Code |
|-----------|-----------|---------------|
| `ontos/core/` | 16 | 3,812 |
| `ontos/commands/` | 14 | 1,870 |
| `ontos/io/` | 6 | 765 |
| `ontos/ui/` | 3 | 268 |
| `ontos/` (root) | 3 | 527 |
| `ontos/_scripts/` | 17 | 4,773 |
| `tests/` | 40 | 5,972 |

---

## 2. Code Metrics

### 2.1 Largest Files (Core Package)

| Rank | File | Lines | Notes |
|------|------|-------|-------|
| 1 | `ontos/cli.py` | 457 | Main CLI + dispatch |
| 2 | `ontos/commands/doctor.py` | 427 | Health checks |
| 3 | `ontos/core/schema.py` | 421 | Schema validation |
| 4 | `ontos/core/staleness.py` | 379 | Staleness detection |
| 5 | `ontos/core/paths.py` | 345 | Path resolution |

### 2.2 Legacy Script Footprint

Legacy scripts are retained for compatibility in `ontos/_scripts/` and `.ontos/scripts/` with large monolithic files (e.g., `ontos_generate_context_map.py` at ~1,288 lines, `ontos_end_session.py` at ~1,896 lines in `.ontos/scripts/`).

### 2.3 Code Distribution (ontos/ package)

```
core/     ████████████████████  (~32%)
_scripts/ ████████████          (~40%)
commands/ █████████             (~16%)
io/       ████                  (~6%)
ui/       ██                    (~2%)
root/     ██                    (~4%)
```

---

## 3. Package Architecture

### 3.1 Entry Points

```toml
[project.scripts]
ontos = "ontos.cli:main"
```

**Entry Flow:**
```
$ ontos [command] [args]
    │
    ▼
ontos/__main__.py
    │
    ▼
ontos/cli.py:main()
    │
    ▼
argparse dispatches to ontos/commands/*.py
```

### 3.2 Layer Architecture

```
CLI (cli.py)
  └─ commands/ (orchestration)
        ├─ core/ (logic)
        ├─ io/ (file+git)
        └─ ui/ (output)
```

### 3.3 Layer Constraints

- Core is intended to be stdlib-only and pure; some functions are explicitly marked “impure” (legacy I/O).
- I/O layer owns filesystem and git subprocess calls.
- Commands orchestrate and pass data between layers.

---

## 4. CLI Reference

### 4.1 Command Summary

| Command | Purpose |
|---------|---------|
| `ontos init` | Initialize Ontos in a repo |
| `ontos map` | Generate context map |
| `ontos log` | Record session log |
| `ontos doctor` | Health diagnostics |
| `ontos export` | Generate CLAUDE.md |
| `ontos hook` | Git hook dispatcher |
| `ontos verify` | Staleness verification |
| `ontos query` | Graph queries |
| `ontos migrate` | Schema migration |
| `ontos consolidate` | Log consolidation |
| `ontos promote` | Curation promotion |
| `ontos scaffold` | Scaffold docs |
| `ontos stub` | Stub docs |

### 4.2 Global Options

| Option | Description |
|--------|-------------|
| `--help`, `-h` | Show help |
| `--quiet`, `-q` | Suppress non-essential output |
| `--json` | JSON output mode |
| `--version`, `-V` | Show version |

### 4.3 Exit Codes (Global Convention)

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Validation error |
| 2 | Configuration error |
| 3 | User input / partial success (command-specific) |
| 4 | Git error |
| 5 | Internal error |

---

## 5. Core Modules (ontos/core)

| Module | Purpose |
|--------|---------|
| `context.py` | Transactional `SessionContext` for writes |
| `frontmatter.py` | YAML frontmatter parsing/normalization |
| `graph.py` | Dependency graph build + cycle detection |
| `validation.py` | Aggregated validation orchestration |
| `schema.py` | Schema rules and migration helpers |
| `staleness.py` | Staleness detection for `describes` |
| `types.py` | Dataclasses and enums |
| `curation.py` | Curation level logic |
| `history.py` | Log parsing for decision history |
| `paths.py` | Path resolution + repo root logic |
| `suggestions.py` | Impact/concept suggestions |
| `tokens.py` | Token estimation |

---

## 6. I/O Modules (ontos/io)

| Module | Purpose |
|--------|---------|
| `git.py` | Git subprocess wrappers |
| `files.py` | Document scanning + read/write |
| `toml.py` | `.ontos.toml` I/O |
| `yaml.py` | YAML helpers |
| `config.py` | Config discovery + load/save |

---

## 7. Configuration

**Primary config:** `.ontos.toml` (repo root)

```toml
[ontos]
version = "3.0"
required_version = ""

[paths]
docs_dir = "docs"
logs_dir = "docs/logs"
context_map = "Ontos_Context_Map.md"

[scanning]
skip_patterns = ["_template.md", "archive/*"]

[validation]
max_dependency_depth = 5
allowed_orphan_types = ["atom"]
strict = false

[workflow]
enforce_archive_before_push = true
require_source_in_logs = true
log_retention_count = 20

[hooks]
pre_push = true
pre_commit = true
```

**Resolution Order:** CLI flags → environment (`ONTOS_*`) → `.ontos.toml` → defaults.

---

## 8. Dependencies

### 8.1 Runtime

| Package | Version | Purpose |
|---------|---------|---------|
| `pyyaml` | `>=6.0` | YAML frontmatter parsing |
| `tomli` | `>=2.0.1` (py<3.11) | TOML parsing fallback |

### 8.2 Dev

| Package | Version | Purpose |
|---------|---------|---------|
| `pytest` | `>=7.0` | Tests |
| `pytest-cov` | `>=4.0` | Coverage |
| `pre-commit` | `>=3.0` | Hook tooling |

### 8.3 Optional

| Package | Version | Purpose |
|---------|---------|---------|
| `pydantic` | `>=2.0` | MCP layer (future) |

---

## 9. Testing

### 9.1 Structure

```
tests/
├── commands/
├── core/
├── io/
├── ui/
├── golden/
└── legacy/
```

### 9.2 Running Tests

```bash
pytest tests/ -v
pytest tests/golden/ -v
pytest tests/ -v --cov=ontos --cov-report=term-missing
```

---

## 10. Build & Distribution

### 10.1 Build

```bash
pip install build twine
python -m build
```

### 10.2 Install

```bash
pip install ontos
# or
pip install -e .
```

### 10.3 Release Notes

- Version defined in `pyproject.toml` and `ontos/__init__.py`
- Tag format: `vX.Y.Z`

---

## 11. Extension Points

### 11.1 Add a New Command

1. Add `ontos/commands/<name>.py`
2. Register in `ontos/cli.py` subparsers
3. Add tests under `tests/commands/`

### 11.2 Add New Output Format

1. Add formatter in `ontos/ui/`
2. Register in `ontos/ui/__init__.py`
3. Wire via `--json` or new flag

---

## Appendix

### 11.1 Repo Stats

- Total `.py` files (excluding `.venv/`): 176
- Total LOC (excluding `.venv/`): 38,530
- `ontos/` package size: 532K

### 11.2 References

- `pyproject.toml`
- `ontos/cli.py`
- `docs/reference/Ontos_Manual.md`
- `docs/reference/ontology_spec.md`
- `.ontos-internal/strategy/v3.0/V3.0-Technical-Architecture.md`

---

*Document generated: 2026-01-14*
*Source version: v3.0.1 (git describe: v3.0.1-11-g05ffb1e)*
