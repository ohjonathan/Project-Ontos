---
id: v2_5_promises_implementation_plan
type: strategy
status: draft
depends_on: [v2_strategy, mission]
---

# Ontos v2.5 Implementation Plan: "The Promises"

**Version:** 2.5.0
**Theme:** The Promises
**Date:** 2025-12-16
**Status:** Draft - Pending Review

---

## 1. Executive Summary

### Problem
Users won't remember to consolidate logs. The current system relies on passive warnings that get ignored, violating the "zero friction" promise of automated mode.

### Solution
Implement mode-based consolidation behavior:
- **Automated mode:** Auto-consolidate on commit (pre-commit hook)
- **Prompted mode:** Agent reminder at activation
- **Advisory mode:** Warning only (current behavior)

### Key Innovation
Use **pre-commit** hook instead of pre-push. This allows consolidation changes to be included in the commit, avoiding the "left behind" paradox.

---

## 2. The Promises (User-Facing)

These messages will be shown during `ontos_init.py` mode selection:

### Automated
> "Zero friction â€” just works."
>
> Push your code â€” sessions are archived, old logs are consolidated, nothing is left behind. You focus on building.

### Prompted
> "Keep me in the loop."
>
> You stay in control of what gets archived and when. Perfect for teams who want visibility.

### Advisory
> "Maximum flexibility."
>
> Ontos watches and advises but never blocks. You run consolidation and archiving on your own schedule.

---

## 3. Behavior Matrix

| Behavior | automated | prompted | advisory |
|----------|-----------|----------|----------|
| **Session Archiving** | Auto on push | Blocks push until archived | Warning only |
| **Consolidation** | Auto on commit (pre-commit) | Agent reminder at activation | Warning only |
| **Auto-stage changes** | Yes | No | No |
| **Source attribution** | Optional (uses DEFAULT_SOURCE) | Required | Optional |
| **Log enrichment** | Optional (auto-generated OK) | Encouraged | Optional |

### Hook Configuration

| Hook | automated | prompted | advisory |
|------|-----------|----------|----------|
| **pre-commit** | Consolidate if over threshold â†’ auto-stage | â€” | â€” |
| **pre-push** | Auto-archive session | Block until archived | Warn if unarchived |
| **activation** | â€” | Remind if consolidation needed | â€” |

---

## 4. Architecture Decision: Pre-commit vs Pre-push

### The "Dirty Push" Paradox (Why not pre-push)

If consolidation runs in pre-push:
1. User runs `git push`
2. Pre-push hook runs consolidation â†’ moves files
3. Hook exits 0 (success)
4. Push sends ORIGINAL state to remote
5. User now has DIRTY working tree with uncommitted changes
6. User must run `git add . && git commit && git push` AGAIN

This violates the "zero friction" promise.

### The Pre-commit Solution

```
Timeline:
1. User stages changes: git add .
2. User runs: git commit -m "feat: something"
3. [PRE-COMMIT HOOK FIRES]
4. Hook detects: logs > threshold
5. Consolidation runs â†’ moves files, updates decision_history.md
6. Hook runs: git add (consolidated files)
7. Commit proceeds with BOTH user changes AND consolidation
```

**Result:** Everything is in one commit. User never sees "dirty" state. True zero friction.

---

## 5. Deliverables

### 5.1 Update `ontos_init.py` - Promise Messaging

**File:** `ontos_init.py`
**Function:** `prompt_for_mode()` (lines 29-63)

Replace current mode selection with visually distinct promise messaging:

```python
def prompt_for_mode() -> str:
    """Interactive mode selection with promises."""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Choose Your Workflow                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

   [1] Automated (recommended for solo devs)

       "Zero friction â€” just works."

       â€¢ Sessions auto-archived on push
       â€¢ Old logs auto-consolidated on commit
       â€¢ Nothing left behind, you focus on building

   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   [2] Prompted (recommended for teams) [DEFAULT]

       "Keep me in the loop."

       â€¢ Push blocked until you archive
       â€¢ Agent reminds you to consolidate
       â€¢ Full control with gentle guidance

   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   [3] Advisory (for power users)

       "Maximum flexibility."

       â€¢ Warnings only, never blocks
       â€¢ You decide if/when to archive
       â€¢ Run consolidation on your schedule

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

    while True:
        choice = input("Enter choice [1-3, default=2]: ").strip()
        if choice == '' or choice == '2':
            return 'prompted'
        elif choice == '1':
            return 'automated'
        elif choice == '3':
            return 'advisory'
        else:
            print("Please enter 1, 2, or 3")
```

**Rationale:** The promise is the first thing users see. It sets expectations and builds trust.

---

### 5.2 Create Pre-commit Hook

**New File:** `.ontos/hooks/pre-commit`

```bash
#!/bin/bash
# Ontos pre-commit hook v2.5
# Auto-consolidates old logs in automated mode

SCRIPTS_DIR=".ontos/scripts"
HOOK_SCRIPT="$SCRIPTS_DIR/ontos_pre_commit_check.py"

# Bypass if Ontos not installed
if [ ! -f "$HOOK_SCRIPT" ]; then
    exit 0
fi

# Hand off to Python
python3 "$HOOK_SCRIPT"
exit $?
```

**Rationale:** Thin bash wrapper delegates to Python for testability and complex logic.

---

### 5.3 Create Pre-commit Check Script

**New File:** `.ontos/scripts/ontos_pre_commit_check.py`

```python
"""Pre-commit hook for Ontos auto-consolidation (v2.5)."""

import os
import sys
import subprocess

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from ontos_lib import resolve_config
from ontos_config import PROJECT_ROOT, LOGS_DIR, __version__


def get_mode() -> str:
    """Get current Ontos mode."""
    return resolve_config('ONTOS_MODE', 'prompted')


def get_log_count() -> int:
    """Count active logs in logs directory."""
    if not os.path.exists(LOGS_DIR):
        return 0
    return len([f for f in os.listdir(LOGS_DIR)
                if f.endswith('.md') and f[0].isdigit()])


def should_consolidate() -> bool:
    """Check if consolidation should run based on mode and threshold."""
    mode = get_mode()

    # Only auto-consolidate in automated mode
    if mode != 'automated':
        return False

    # Check if feature is enabled (allows override)
    auto_on_commit = resolve_config('AUTO_CONSOLIDATE_ON_COMMIT', True)
    if not auto_on_commit:
        return False

    # Check threshold
    log_count = get_log_count()
    threshold = resolve_config('LOG_RETENTION_COUNT', 15)

    return log_count > threshold


def run_consolidation() -> tuple[bool, str]:
    """Run consolidation in quiet, auto mode.

    Returns:
        (success, output) tuple
    """
    script = os.path.join(PROJECT_ROOT, '.ontos', 'scripts', 'ontos_consolidate.py')
    threshold_days = resolve_config('CONSOLIDATION_THRESHOLD_DAYS', 30)

    result = subprocess.run(
        [sys.executable, script, '--all', '--quiet', '--days', str(threshold_days)],
        capture_output=True,
        text=True
    )
    return result.returncode == 0, result.stdout


def stage_consolidated_files() -> None:
    """Stage files modified by consolidation.

    Stages:
    - Modified tracked files (decision_history.md)
    - Archive directory contents
    - Removes deleted files from index (moved logs)
    """
    # Stage all changes to tracked files
    subprocess.run(['git', 'add', '-u'], capture_output=True)

    # Stage archive directory (mode-aware path)
    from ontos_config import is_ontos_repo
    if is_ontos_repo():
        archive_dir = os.path.join(PROJECT_ROOT, '.ontos-internal', 'archive')
    else:
        archive_dir = os.path.join(PROJECT_ROOT, 'docs', 'archive')

    if os.path.exists(archive_dir):
        subprocess.run(['git', 'add', archive_dir], capture_output=True)


def main() -> int:
    """Main entry point for pre-commit hook.

    Returns:
        0 always (never block commit)
    """
    if not should_consolidate():
        return 0

    log_count = get_log_count()
    threshold = resolve_config('LOG_RETENTION_COUNT', 15)

    print(f"ðŸ“¦ Auto-consolidating ({log_count} logs > {threshold} threshold)...")

    success, output = run_consolidation()

    if success:
        stage_consolidated_files()
        print("   âœ“ Consolidated and staged")
    else:
        # Don't print error - consolidation might have found no old logs
        print("   âœ“ No logs old enough to consolidate")

    return 0  # Never block commit


if __name__ == "__main__":
    sys.exit(main())
```

**Design Decisions:**
1. **Never blocks:** Returns 0 always. Consolidation failure shouldn't stop commits.
2. **Quiet mode:** Uses `--quiet` to avoid cluttering commit output.
3. **Auto-stages:** Adds consolidated files to staging so they're in the commit.
4. **Mode-aware:** Only runs in `automated` mode, respects config overrides.

---

### 5.4 Update Hook Installation in `ontos_init.py`

**File:** `ontos_init.py`
**Location:** After pre-push installation (~line 333)

```python
# Install pre-commit hook (v2.5)
pre_commit_src = os.path.join(PROJECT_ROOT, '.ontos', 'hooks', 'pre-commit')
pre_commit_dst = os.path.join(HOOKS_DIR, 'pre-commit')

if os.path.exists(pre_commit_src):
    try:
        # Check for existing hook
        if os.path.exists(pre_commit_dst):
            # Back up existing hook if different
            with open(pre_commit_src, 'r') as src, open(pre_commit_dst, 'r') as dst:
                if src.read() != dst.read():
                    backup = pre_commit_dst + '.backup'
                    shutil.copy2(pre_commit_dst, backup)
                    print(f"   â„¹ Backed up existing pre-commit to {backup}")

        shutil.copy2(pre_commit_src, pre_commit_dst)
        st = os.stat(pre_commit_dst)
        os.chmod(pre_commit_dst, st.st_mode | 0o111)  # Make executable
        print("   âœ“ Installed pre-commit hook")
    except Exception as e:
        print(f"   âš  Warning: Failed to install pre-commit hook: {e}")
else:
    print("   âš  Warning: Pre-commit hook source not found")
```

---

### 5.5 Update Agent Instructions

**File:** `docs/reference/Ontos_Agent_Instructions.md`
**Section:** "Ontos" (Activate)

```markdown
### "Ontos" (Activate)
1. Check for `Ontos_Context_Map.md`
2. If missing: `python3 .ontos/scripts/ontos_generate_context_map.py`
3. Read map, identify relevant IDs for user's request
4. **Check consolidation status (prompted/advisory modes only):**
   - Count logs in logs directory
   - If count > LOG_RETENTION_COUNT (default: 15):
     ```
     print("âš ï¸ {count} active logs (threshold: {limit}). Run 'Consolidate Ontos' to archive old sessions.")
     ```
   - Note: In automated mode, consolidation happens automatically on commit
5. Read ONLY those files
6. print("Loaded: [id1, id2]")
```

---

### 5.6 Update Mode Presets

**File:** `.ontos/scripts/ontos_config_defaults.py`
**Section:** MODE_PRESETS (~line 193)

```python
MODE_PRESETS = {
    'automated': {
        'AUTO_ARCHIVE_ON_PUSH': True,
        'ENFORCE_ARCHIVE_BEFORE_PUSH': False,
        'REQUIRE_SOURCE_IN_LOGS': False,
        'AUTO_CONSOLIDATE': True,
        'AUTO_CONSOLIDATE_ON_COMMIT': True,  # NEW v2.5
    },
    'prompted': {
        'AUTO_ARCHIVE_ON_PUSH': False,
        'ENFORCE_ARCHIVE_BEFORE_PUSH': True,
        'REQUIRE_SOURCE_IN_LOGS': True,
        'AUTO_CONSOLIDATE': True,
        'AUTO_CONSOLIDATE_ON_COMMIT': False,  # NEW v2.5
    },
    'advisory': {
        'AUTO_ARCHIVE_ON_PUSH': False,
        'ENFORCE_ARCHIVE_BEFORE_PUSH': False,
        'REQUIRE_SOURCE_IN_LOGS': False,
        'AUTO_CONSOLIDATE': False,
        'AUTO_CONSOLIDATE_ON_COMMIT': False,  # NEW v2.5
    },
}
```

**Also add documentation:**

```python
# Auto-consolidate on commit (v2.5+)
# - True: Pre-commit hook consolidates old logs automatically
# - False: Manual consolidation only (or agent reminder in prompted mode)
# Only applies to 'automated' mode by default
AUTO_CONSOLIDATE_ON_COMMIT = False
```

---

### 5.7 Update Documentation

**File:** `docs/reference/Ontos_Manual.md`
**Section:** Configuration Modes

```markdown
### Configuration Modes (v2.5)

Ontos offers three workflow modes to match your preferences:

| Mode | Promise | Archiving | Consolidation |
|------|---------|-----------|---------------|
| **automated** | "Zero friction â€” just works" | Auto on push | Auto on commit |
| **prompted** | "Keep me in the loop" | Blocks push | Agent reminder |
| **advisory** | "Maximum flexibility" | Warning only | Manual only |

**Choosing Your Mode:** During installation, `ontos_init.py` shows each mode's promise. Change later with:
```bash
python3 ontos_init.py --reconfig
```
```

**File:** `Ontos_CHANGELOG.md`

```markdown
## [2.5.0] - 2025-12-XX

### Theme: "The Promises"

Clear, honest communication about what each mode delivers.

### Added
- **Mode Promises**: Redesigned setup flow showing clear promises for each mode
- **Pre-commit hook**: Auto-consolidation for automated mode
- **`AUTO_CONSOLIDATE_ON_COMMIT`**: New config setting for pre-commit consolidation
- **Agent consolidation reminders**: Prompted mode reminds at activation when logs exceed threshold

### Changed
- `ontos_init.py`: Visually distinct mode selection with promise messaging
- `MODE_PRESETS`: Added consolidation-on-commit settings per mode
- `Ontos_Agent_Instructions.md`: Added consolidation check to activation flow

### Technical
- Pre-commit hook stages consolidated files automatically
- Consolidation never blocks commit (graceful degradation)
```

---

## 6. File Changes Summary

| File | Action | Lines Changed (est.) |
|------|--------|---------------------|
| `ontos_init.py` | MODIFY | +60 (promise UI), +20 (hook install) |
| `.ontos/hooks/pre-commit` | CREATE | ~15 |
| `.ontos/scripts/ontos_pre_commit_check.py` | CREATE | ~100 |
| `.ontos/scripts/ontos_config_defaults.py` | MODIFY | +15 |
| `docs/reference/Ontos_Agent_Instructions.md` | MODIFY | +10 |
| `docs/reference/Ontos_Manual.md` | MODIFY | +15 |
| `Ontos_CHANGELOG.md` | MODIFY | +25 |

**Total:** ~260 lines added/modified

---

## 7. Testing Plan

### 7.1 Unit Tests

**New File:** `tests/test_pre_commit_check.py`

```python
"""Tests for pre-commit consolidation hook."""

import pytest
import os
import tempfile

class TestPreCommitCheck:

    def test_automated_mode_triggers_consolidation(self, mock_config):
        """In automated mode with logs over threshold, should consolidate."""
        mock_config['ONTOS_MODE'] = 'automated'
        mock_config['LOG_RETENTION_COUNT'] = 5
        # Create 10 mock logs
        assert should_consolidate() == True

    def test_prompted_mode_skips_consolidation(self, mock_config):
        """In prompted mode, should never auto-consolidate."""
        mock_config['ONTOS_MODE'] = 'prompted'
        assert should_consolidate() == False

    def test_advisory_mode_skips_consolidation(self, mock_config):
        """In advisory mode, should never auto-consolidate."""
        mock_config['ONTOS_MODE'] = 'advisory'
        assert should_consolidate() == False

    def test_under_threshold_skips_consolidation(self, mock_config):
        """Even in automated mode, skip if under threshold."""
        mock_config['ONTOS_MODE'] = 'automated'
        mock_config['LOG_RETENTION_COUNT'] = 50
        # Create only 5 mock logs
        assert should_consolidate() == False

    def test_config_override_disables_consolidation(self, mock_config):
        """AUTO_CONSOLIDATE_ON_COMMIT=False should disable even in automated."""
        mock_config['ONTOS_MODE'] = 'automated'
        mock_config['AUTO_CONSOLIDATE_ON_COMMIT'] = False
        assert should_consolidate() == False

    def test_main_returns_zero_always(self):
        """Hook should never block commit."""
        assert main() == 0
```

### 7.2 Integration Tests

**Manual Test Script:**

```bash
#!/bin/bash
# Test auto-consolidation flow

# Setup
cd /tmp
mkdir test-ontos && cd test-ontos
git init
cp -r /path/to/ontos/.ontos .
python3 ontos_init.py  # Select automated mode

# Create test logs (over threshold)
for i in {1..20}; do
    date=$(date -v-${i}d +%Y-%m-%d)
    cat > docs/logs/${date}_test-${i}.md << EOF
---
id: log_${date}_test_${i}
type: log
status: active
event_type: chore
impacts: []
---
# Test Log ${i}
EOF
done

# Make a change and commit
echo "test" > test.txt
git add .
git commit -m "test: trigger consolidation"

# Verify consolidation happened
ls docs/logs/        # Should have fewer logs
ls docs/archive/     # Should have archived logs
git log --oneline -1 # Should include consolidated files
```

---

## 8. Migration Notes

### For Existing Users

1. **No breaking changes** - Existing configs continue to work
2. **New hook on reinstall** - Run `python3 ontos_init.py` to install pre-commit hook
3. **Opt-in for prompted users** - Consolidation reminder is additive, not breaking

### For New Users

1. **Promise shown first** - Mode selection explains what they're getting
2. **Hooks installed automatically** - Both pre-commit and pre-push
3. **Default is prompted** - Safe, visible behavior for new users

---

## 9. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Pre-commit hook slows commits | Medium | Only runs when over threshold; uses `--quiet` |
| Consolidation fails mid-commit | Low | Hook returns 0 always; failure is silent |
| Existing pre-commit hook conflict | Low | Back up existing hook before overwriting |
| Users confused by auto-staged files | Low | Print message showing what was consolidated |

---

## 10. Success Metrics

1. **Quantitative**
   - Users in automated mode never have >20 active logs
   - Pre-commit hook adds <2s to commit time
   - Zero support issues about "left behind" consolidation files

2. **Qualitative**
   - Users understand mode promises after setup
   - Prompted mode users see consolidation reminders
   - No complaints about unexpected behavior

---

## 11. Future Considerations

### v2.6 and Beyond

- **Smart consolidation timing:** Only consolidate if commit touches docs/ directory
- **Consolidation dry-run at setup:** Show what would be consolidated during mode selection
- **Agent-assisted consolidation:** In prompted mode, agent could offer to consolidate inline

---

## 12. Approval Checklist

- [ ] Architecture review (pre-commit vs pre-push decision)
- [ ] Promise messaging review (tone, clarity)
- [ ] Test plan review
- [ ] Documentation review
- [ ] Ready for implementation

---

*End of v2.5 Implementation Plan*
