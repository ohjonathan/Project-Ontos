---
id: v3_0_implementation_roadmap
type: strategy
status: active
depends_on: [v3_0_technical_architecture, v3_0_strategy_decisions]
---

# Ontos v3.0 Implementation Roadmap

**Version:** 1.7
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-13
**Status:** Approved for Implementation

**Change History:**
| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-12 | Initial draft |
| 1.1 | 2026-01-12 | Incorporated peer review feedback (4 reviewers). See `Chief_Architect_Roadmap_Response.md` for details. |
| 1.2 | 2026-01-12 | Round 2 verification fixes: added `io/toml.py` to Section 4.1 table; added shim hook edge case note. |
| 1.3 | 2026-01-12 | **Phase 0 Complete.** Golden Master testing infrastructure merged (PR #39). |
| 1.4 | 2026-01-12 | **Phase 1 Complete.** Package structure implemented and verified (PR #40). |
| 1.5 | 2026-01-13 | **Phase 2 Complete.** Core decomposition, God Script reduction, module extraction (PR #41). |
| 1.6 | 2026-01-13 | **Phase 3 Complete.** Configuration & Init with `.ontos.toml` (PR #43). |
| 1.7 | 2026-01-13 | **Phase 4 Complete.** Full CLI Release with doctor, export, hook commands (PR #44). |

**Related Documents:**
- `V3.0-Technical-Architecture.md` — Architecture specification (v1.4)
- `V3.0-Strategy-Decisions-Final.md` — Strategy decisions Q1-Q13

---

## 1. Roadmap Overview

### 1.1 Release Timeline

| Version | Theme | Phase | Status |
|---------|-------|-------|--------|
| Pre-alpha | Golden Master Testing | 0 | **Complete** |
| v3.0.0-alpha | Package Structure | 1 | **Complete** |
| v3.0.0-beta | Core Decomposition | 2 | **Complete** |
| v3.0.0-rc | Configuration & Init | 3 | **Complete** |
| v3.0.0 | Full CLI Release | 4 | **Complete** |
| v3.0.1+ | Polish & Fixes | 5 | Not Started |
| v3.1.0 | Bridge Features | — | Planned |
| v3.2.0+ | Protocol Preparation | — | Planned |

### 1.2 Scope Summary

**v3.0.x (Distribution & Polish):**
- Transform from repo-injected scripts to `pip install ontos`
- Global CLI + local data (git-like model)
- Break 3,199-line "God Scripts" into modular structure
- JSON output mode for scripting
- Declarative `.ontos.toml` configuration
- Shim hooks delegating to global CLI
- `ontos export` for CLAUDE.md generation (minimal stub)

**v3.1.x (Bridge Features):**
- `ontos deinit` clean uninstallation
- Export `--append` mode
- Version pinning enforcement (upgrade from warn-only)
- Enhanced security preparation for MCP

**v3.2.x+ (Protocol Preparation):**
- MCP layer stub (`pip install ontos[mcp]`)
- Additional export templates based on user feedback
- Foundation for v4.0

**v4.0 (Agent-First — Out of Scope for This Roadmap):**
- MCP as primary interface
- Daemon as default
- Full template system
- Lazy loading with `ontos://` URIs

### 1.3 Current Codebase Metrics

| Metric | Value |
|--------|-------|
| Total lines (`.ontos/scripts/`) | 8,685 |
| Script count | 22 |
| Largest (`ontos_end_session.py`) | 1,904 lines |
| Second (`ontos_generate_context_map.py`) | 1,295 lines |
| Core modules | 10 |
| Test count | 303 |

---

## 2. Pre-Release: Golden Master Testing

**Purpose:** Create a safety net before decomposing God Scripts. These tests capture v2.9.x behavior exactly, enabling confident refactoring.

### 2.1 Deliverables

| Deliverable | Description | Acceptance Criteria |
|-------------|-------------|---------------------|
| Golden Master fixtures | Representative project structures | Small (5 docs), Medium (25 docs), Large (100+ docs) |
| Capture scripts | Record v2.9.x output | stdout, stderr, exit codes, generated files |
| Comparison harness | Diff v2 vs v3 output | Exact match or documented deviation |
| Baseline documentation | Known acceptable differences | Timestamps, file paths, version strings |

### 2.2 Tasks

- [ ] Create `tests/fixtures/golden/small/` with 5-document project
- [ ] Create `tests/fixtures/golden/medium/` with 25-document project
- [ ] Create `tests/fixtures/golden/large/` with 100+ document project
- [ ] Create `.ontos.toml` for each fixture (enables config-dependent tests)
- [ ] Write capture script: `scripts/capture_golden_master.py`
  - Run `python3 ontos.py map` and capture stdout/stderr/exit code
  - Run `python3 ontos.py log -e test -t "Test"` and capture output
  - Record generated `Ontos_Context_Map.md` content
- [ ] Write comparison script: `scripts/compare_golden_master.py`
  - Load captured baseline
  - Run v3 command
  - Diff output (ignoring timestamps, paths)
- [ ] Document baseline in `tests/golden/README.md`
- [ ] Add Golden Master tests to CI

### 2.3 Exit Criteria

- [x] All three fixture sizes created (small, medium; large deferred per spec)
- [x] Capture script successfully records v2.9.x behavior
- [x] Comparison harness runs and reports clean on v2.9.x
- [x] Baseline documentation complete
- [x] CI integration configured

### 2.4 Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Flaky tests due to timestamps | Normalize timestamps before comparison |
| Path differences across machines | Use relative paths in comparisons |
| Large fixture takes too long | Set timeout, consider subset for CI |

---

## 3. v3.0.0-alpha: Package Structure

**Theme:** "Make it installable"

**Goal:** `pip install -e .` works. No behavior changes yet.

### 3.1 Deliverables

| Deliverable | Source | Destination | Notes |
|-------------|--------|-------------|-------|
| `pyproject.toml` | NEW | `./pyproject.toml` | Package metadata, entry points |
| Package root | NEW | `./ontos/__init__.py` | Version, exports |
| Entry point | NEW | `./ontos/__main__.py` | `python -m ontos` support |
| Core modules | `.ontos/scripts/ontos/core/` | `./ontos/core/` | Move, no changes |
| UI modules | `.ontos/scripts/ontos/ui/` | `./ontos/ui/` | Move, no changes |

### 3.2 `pyproject.toml` Specification

```toml
[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"

[project]
name = "ontos"
version = "3.0.0a1"
description = "Local-first documentation management for AI-assisted development"
readme = "README.md"
requires-python = ">=3.9"
license = {text = "MIT"}
authors = [{name = "Ontos Project"}]
keywords = ["documentation", "ai", "context", "llm"]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Environment :: Console",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
]
dependencies = [
    "tomli>=2.0.1; python_version<'3.11'"  # TOML parsing for older Python
]

[project.optional-dependencies]
mcp = ["pydantic>=2.0"]  # For v3.x/v4 MCP layer
dev = ["pytest>=7.0", "pytest-cov"]

[project.scripts]
ontos = "ontos.cli:main"

[project.urls]
Homepage = "https://github.com/ohjona/Project-Ontos"
Documentation = "https://github.com/ohjona/Project-Ontos/docs"
```

### 3.3 Tasks

- [ ] Create `pyproject.toml` with metadata (see spec above)
- [ ] Create `ontos/__init__.py` with `__version__ = "3.0.0a1"`
- [ ] Create `ontos/__main__.py`:
  ```python
  from ontos.cli import main
  if __name__ == "__main__":
      main()
  ```
- [ ] Create minimal `ontos/cli.py`:
  ```python
  def main():
      print("ontos 3.0.0-alpha")
  ```
- [ ] Move `ontos/core/` modules (no changes to code yet)
- [ ] Move `ontos/ui/` modules (no changes to code yet)
- [ ] Create `__init__.py` files with public exports
- [ ] Update internal imports to use new paths
- [ ] Verify `pip install -e .` succeeds
- [ ] Verify existing tests pass (update import paths as needed)
- [ ] Tag `v3.0.0-alpha`

### 3.4 Acceptance Criteria

- [ ] `pip install -e .` completes without error
- [ ] `python -m ontos` prints version
- [ ] `ontos` command available in PATH after install
- [ ] All 303 existing tests pass (with import fixes)
- [ ] Golden Master tests pass
- [ ] No behavior changes from v2.9.x

### 3.5 Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Import path breakage | Update all imports before moving files |
| Circular imports | Review dependency graph first |
| Test discovery issues | Update pytest config paths |

---

## 4. v3.0.0-beta: God Script Decomposition

**Theme:** "Break the monoliths"

**Goal:** Extract modules from 1,904-line `ontos_end_session.py` and 1,295-line `ontos_generate_context_map.py`. This is the highest-risk phase.

### 4.1 New Modules to Create

| Module | Est. Lines | Source | Description |
|--------|------------|--------|-------------|
| `core/graph.py` | ~200 | `ontos_generate_context_map.py:428-560` | Dependency graph building, cycle detection |
| `core/validation.py` | ~300 | `ontos_generate_context_map.py:695-920` | ValidationOrchestrator, error collection |
| `core/types.py` | ~150 | Various | Enums (DocumentType, Status), dataclasses |
| `core/suggestions.py` | ~200 | `ontos_end_session.py:1193-1400` | Impact/concept suggestions |
| `core/tokens.py` | ~50 | `ontos_generate_context_map.py:71-104` | Token estimation |
| `io/git.py` | ~150 | Various | Git subprocess calls (mtime, diff, log) |
| `io/files.py` | ~200 | Various + NEW | File ops, `find_project_root()`, `write_text_file()` |
| `io/toml.py` | ~100 | NEW | TOML config load/write (moved from Phase 3) |
| `commands/map.py` | ~300 | `ontos_generate_context_map.py:925-1128` | Map command orchestration |
| `commands/log.py` | ~500 | `ontos_end_session.py` | Log command orchestration |

### 4.2 Modules to Refactor (I/O Extraction)

| Module | Current Lines | Issue | Refactoring Required |
|--------|---------------|-------|---------------------|
| `staleness.py` | 353 | Contains `subprocess.run(["git", ...])` | Extract to `io/git.py:get_file_mtime()` |
| `history.py` | ~220 | Contains `subprocess.run(["git", "log", ...])` | Extract to `io/git.py:get_commits()` |
| `paths.py` | ~300 | Uses `__file__`-relative paths | Accept injected `repo_root` parameter |
| `proposals.py` | ~150 | Contains `Path.read_text()` | Accept file content as parameter |

### 4.3 Detailed Tasks — `core/graph.py`

- [ ] Create `core/graph.py`
- [ ] Define `@dataclass DependencyGraph`:
  ```python
  @dataclass
  class DependencyGraph:
      nodes: Dict[str, GraphNode]
      edges: Dict[str, List[str]]  # id -> depends_on
      reverse_edges: Dict[str, List[str]]  # id -> depended_by
  ```
- [ ] Implement `build_graph(docs: Dict[str, DocumentData]) -> DependencyGraph`
- [ ] Implement `detect_cycles(graph: DependencyGraph) -> List[List[str]]`
  - Use O(V+E) DFS with `visited` and `in_stack` sets
  - Do NOT use `path.index()` pattern (O(N²))
- [ ] Implement `detect_orphans(graph, allowed_types) -> List[str]`
- [ ] Implement `calculate_depths(graph) -> Dict[str, int]`
- [ ] Write unit tests (target: >90% coverage)
- [ ] Verify Golden Master tests pass

### 4.4 Detailed Tasks — `core/validation.py`

- [ ] Create `core/validation.py`
- [ ] Define `ValidationErrorType` enum:
  ```python
  class ValidationErrorType(Enum):
      BROKEN_LINK = "broken_link"
      CYCLE = "cycle"
      ORPHAN = "orphan"
      ARCHITECTURE = "architecture"
      SCHEMA = "schema"
      STATUS = "status"
      STALENESS = "staleness"
      CURATION = "curation"
  ```
- [ ] Define `@dataclass ValidationError`:
  ```python
  @dataclass
  class ValidationError:
      error_type: ValidationErrorType
      doc_id: str
      filepath: str
      message: str
      fix_suggestion: str
      severity: Literal['error', 'warning', 'info']
  ```
- [ ] Define `@dataclass ValidationResult`:
  ```python
  @dataclass
  class ValidationResult:
      errors: List[ValidationError]
      warnings: List[ValidationError]
      exit_code: int
  ```
- [ ] Implement `ValidationOrchestrator`:
  - `__init__(docs, config)`
  - `validate_all() -> ValidationResult`
  - `validate_frontmatter()`, `validate_graph()`, `validate_status()`, etc.
- [ ] Ensure no hard exits — collect all errors before returning
- [ ] Write unit tests
- [ ] Verify Golden Master tests pass

### 4.5 Detailed Tasks — `core/types.py`

- [ ] Create `core/types.py`
- [ ] Define `DocumentType` enum (KERNEL, STRATEGY, PRODUCT, ATOM, LOG)
- [ ] Define `DocumentStatus` enum (DRAFT, ACTIVE, DEPRECATED, REJECTED, COMPLETE)
- [ ] Define `CurationLevel` IntEnum (SCAFFOLD=0, STUB=1, FULL=2)
- [ ] Define `@dataclass DocumentData`
- [ ] Define `@dataclass OntosConfig`
- [ ] Update all modules to import from `core/types.py`
- [ ] Write unit tests

### 4.6 Detailed Tasks — `io/git.py`

- [ ] Create `io/git.py`
- [ ] Implement `get_current_branch() -> Optional[str]`
- [ ] Implement `get_file_mtime(filepath: Path) -> Optional[datetime]`
- [ ] Implement `get_commits_since_push() -> List[CommitInfo]`
- [ ] Implement `get_diff_stat() -> DiffStat`
- [ ] Implement `is_dirty() -> bool`
- [ ] Implement `get_remote_url() -> Optional[str]`
- [ ] Implement `get_changed_files_since_push() -> List[Path]`
- [ ] Implement `install_hooks(hook_dir: Path, hooks: List[str]) -> None`
- [ ] Write unit tests (mock subprocess)

### 4.7 Detailed Tasks — `io/files.py`

- [ ] Create `io/files.py`
- [ ] Implement `find_project_root(start_path: Path) -> Path`:
  - Resolution: 1) nearest `.ontos.toml`, 2) git root, 3) raise with hint
- [ ] Implement `scan_documents(dirs, skip_patterns) -> List[Path]`
- [ ] Implement `read_document(path: Path) -> Tuple[Dict, str]`
- [ ] Implement `get_file_mtime(path: Path) -> Optional[datetime]`
- [ ] Implement `write_text_file(path, content, encoding="utf-8") -> None`
- [ ] Write unit tests

### 4.8 Detailed Tasks — `commands/map.py`

- [ ] Create `commands/map.py`
- [ ] Implement `run(config: OntosConfig, strict: bool = False, json_output: bool = False) -> int`
- [ ] Wire together:
  - Load config via `io/toml.py`
  - Scan documents via `io/files.py`
  - Parse frontmatter via `core/frontmatter.py`
  - Build graph via `core/graph.py`
  - Validate via `core/validation.py`
  - Generate output
  - Write via `SessionContext`
- [ ] Verify Golden Master tests pass

**Note:** `commands/map.py` should return JSON-serializable data structures. Actual JSON formatting is handled by `ui/json_output.py` in Phase 4.

### 4.9 Detailed Tasks — `commands/log.py`

- [ ] Create `commands/log.py`
- [ ] Implement main orchestration (~500 lines)
- [ ] Wire together:
  - Get branch/commits via `io/git.py`
  - Suggest impacts via `core/suggestions.py`
  - Create log file via `SessionContext`
  - Check staleness via `core/staleness.py`
  - Detect proposal graduation via `core/proposals.py`
- [ ] Implement Q4 confirmation step:
  - Display changed files to user
  - Prompt: "Create log for these changes? [Y/n]"
  - Skip prompt if `--auto` flag provided
- [ ] Verify Golden Master tests pass

### 4.10 Detailed Tasks — REFACTOR Modules

- [ ] Refactor `staleness.py`:
  - Remove `subprocess.run(["git", ...])` calls
  - Add parameter for git mtime data
  - Update callers to pass data from `io/git.py`
- [ ] Refactor `history.py`:
  - Remove `subprocess.run(["git", "log", ...])` calls
  - Add parameter for commit data
  - Update callers to pass data from `io/git.py`
- [ ] Refactor `paths.py`:
  - Remove `__file__`-relative path calculation
  - Add `repo_root: Path` parameter to functions
  - Update callers to inject repo root
- [ ] Refactor `proposals.py`:
  - Remove `Path.read_text()` calls
  - Add parameter for file content
  - Update callers to pass data from `io/files.py`

### 4.11 Tasks — `io/toml.py`

**Note:** Moved from Phase 3 to Phase 2 to resolve config loading dependency. Commands need to load config before they can be built.

- [ ] Create `io/toml.py`
- [ ] Implement tomllib/tomli compatibility:
  ```python
  try:
      import tomllib
  except ImportError:
      import tomli as tomllib
  ```
- [ ] Implement `load_config(path: Path) -> Dict`
- [ ] Implement `write_config(path: Path, config: Dict)`
- [ ] Implement `merge_configs(base: Dict, override: Dict) -> Dict`
- [ ] Bundle `tomli` for Python 3.9-3.10 support
- [ ] Write unit tests

### 4.12 Tasks — Minor Command Migration

Migrate existing scripts to `commands/` package. These are simpler than God Script decomposition — mostly file moves with minor I/O extraction.

| Script | Target | Est. Lines | Notes |
|--------|--------|------------|-------|
| `ontos_verify_describes.py` | `commands/verify.py` | ~150 | Extract git calls to `io/git.py` |
| `ontos_query.py` | `commands/query.py` | ~100 | Pure logic, minimal changes |
| `ontos_migrate_schema.py` | `commands/migrate.py` | ~200 | Extract file I/O |
| `ontos_consolidate_logs.py` | `commands/consolidate.py` | ~150 | Extract file I/O |
| `ontos_promote.py` | `commands/promote.py` | ~100 | Extract file I/O |
| `ontos_scaffold.py` | `commands/scaffold.py` | ~150 | Extract file I/O |
| `ontos_stub.py` | `commands/stub.py` | ~100 | Extract file I/O |

- [ ] Migrate `ontos_verify_describes.py` → `commands/verify.py`
- [ ] Migrate `ontos_query.py` → `commands/query.py`
- [ ] Migrate `ontos_migrate_schema.py` → `commands/migrate.py`
- [ ] Migrate `ontos_consolidate_logs.py` → `commands/consolidate.py`
- [ ] Migrate `ontos_promote.py` → `commands/promote.py`
- [ ] Migrate `ontos_scaffold.py` → `commands/scaffold.py`
- [ ] Migrate `ontos_stub.py` → `commands/stub.py`
- [ ] Update imports in all migrated commands
- [ ] Write/update unit tests for each
- [ ] Verify Golden Master tests pass

### 4.13 Phase 2 Implementation Order

Execute Phase 2 tasks in this order to manage dependencies:

**1. Foundation Layer** (Days 1-2)
- `io/toml.py` — Config loading (blocks all commands)
- `core/types.py` — Shared types (blocks most modules)
- `io/files.py` — File operations (blocks commands)
- `io/git.py` — Git operations (blocks commands)

**2. Minor Command Migration** (Days 2-3)
- All 7 commands from Section 4.12
- Establishes patterns for command structure
- Lower risk, builds confidence

**3. God Script Decomposition** (Days 3-10)
- `core/graph.py`, `core/validation.py`, `core/suggestions.py`, `core/tokens.py`
- `commands/map.py` (from `ontos_generate_context_map.py`)
- `commands/log.py` (from `ontos_end_session.py`)
- REFACTOR module purification

**Rationale:** This order ensures prerequisites exist before dependent tasks, and uses simpler migrations as warm-up before high-risk God Script decomposition.

### 4.14 Acceptance Criteria

- [ ] All NEW modules created with specified interfaces
- [ ] All REFACTOR modules purified (no direct I/O in `core/`)
- [ ] God Scripts reduced to <300 lines each (or deleted entirely)
- [ ] 303+ existing tests pass
- [ ] Golden Master tests pass (exact behavior match)
- [ ] No external dependencies added to `core/`
- [ ] Tag `v3.0.0-beta`

### 4.15 Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Hidden dependencies in God Scripts | High | High | Golden Master tests catch behavior changes |
| I/O leaking into core during extraction | Medium | Medium | PR review checklist, import guards |
| Unaccounted lines (~500-750) | Medium | Low | Some become glue code, some deleted |
| Circular imports from extraction | Medium | Medium | Careful interface design, types.py first |

---

## 5. v3.0.0-rc: Configuration Migration

**Theme:** "Make it configurable"

**Goal:** `.ontos.toml` works, `ontos init` creates it, config resolution follows spec.

### 5.1 Deliverables

| Deliverable | Description |
|-------------|-------------|
| `commands/init.py` | Repository initialization command |
| Config resolution | CLI → env → .ontos.toml → defaults |
| Legacy detection | Warn if `.ontos/scripts/` exists |
| Hook installation | Shim hooks with collision safety |

**Note:** `io/toml.py` moved to Phase 2 (Section 4.11) to resolve dependency ordering.

### 5.2 `io/toml.py` Specification

```python
def load_config(path: Path) -> Dict[str, Any]:
    """Load .ontos.toml file. Returns empty dict if not found."""

def write_config(path: Path, config: Dict[str, Any]) -> None:
    """Write config to .ontos.toml. Uses template to preserve comments."""

def merge_configs(base: Dict, override: Dict) -> Dict:
    """Deep merge two config dicts (override wins)."""
```

**Dependencies:**
- Python 3.11+: Use stdlib `tomllib` for reading
- Python 3.9-3.10: Use bundled `tomli` for reading
- Writing: Template-based string generation (preserve comments)

### 5.3 Tasks — `commands/init.py`

- [ ] Create `commands/init.py`
- [ ] Implement initialization flow:
  1. Check if `.ontos.toml` already exists
  2. Detect project type (existing docs directory)
  3. **Detect legacy `.ontos/scripts/`** — Warn if found
  4. Create `.ontos.toml` with smart defaults
  5. **Install hooks with collision safety**:
     - If hook doesn't exist: Install shim
     - If hook exists and IS Ontos shim: Replace (update)
     - If hook exists and NOT Ontos shim: Warn and skip
     - `--force` flag: Overwrite regardless
  6. Create initial context map
  7. **Print tip**: "Tip: Run `ontos export` for AI assistant integration"
- [ ] Implement exit codes:
  - 0: Success
  - 1: Already initialized (with `--force` hint)
  - 2: Not a git repository
  - 3: Hooks skipped due to existing non-Ontos hooks
- [ ] Write unit tests
- [ ] Write integration tests

### 5.4 Tasks — Config Resolution

- [ ] Update `cli.py` to implement resolution order:
  1. CLI flags (highest priority)
  2. Environment variables (`ONTOS_*`)
  3. `.ontos.toml` file
  4. Default values (lowest priority)
- [ ] Document resolution in code comments
- [ ] Write tests for each precedence level

### 5.5 `.ontos.toml` Default Template

```toml
[ontos]
version = "3.0"
# required_version = ">=3.0.0"  # Uncomment to warn on version mismatch

[paths]
docs_dir = "docs"
logs_dir = "docs/logs"
context_map = "Ontos_Context_Map.md"

[scanning]
skip_patterns = ["_template.md", "archive/*"]

[validation]
max_dependency_depth = 5
allowed_orphan_types = ["atom"]
strict = false

[workflow]
enforce_archive_before_push = true
require_source_in_logs = true

[hooks]
pre_push = true
pre_commit = true
```

### 5.6 Acceptance Criteria

- [ ] `ontos init` creates valid `.ontos.toml`
- [ ] Config resolution works: CLI > env > file > defaults
- [ ] Legacy `.ontos/scripts/` detection warns appropriately
- [ ] Hook collision safety works (warn and skip)
- [ ] `--force` flag overwrites hooks
- [ ] Export tip printed after successful init
- [ ] 303+ tests pass
- [ ] Golden Master tests pass
- [ ] Tag `v3.0.0-rc`

---

## 6. v3.0.0: Full CLI Release

**Theme:** "Ship it"

**Goal:** Complete CLI with all commands, hooks, JSON output, and PyPI-ready.

### 6.1 Deliverables

| Deliverable | Description |
|-------------|-------------|
| `cli.py` | Full argparse CLI with all commands |
| `commands/doctor.py` | Health check and diagnostics |
| `commands/hook.py` | Git hook dispatcher |
| `commands/export.py` | CLAUDE.md generation |
| `ui/json_output.py` | JSON formatting for `--json` mode |
| Shim hooks | Python-based with `sys.executable` fallback |
| Deletion | Remove `ontos_lib.py`, deprecated scripts |

### 6.2 Commands Checklist

| Command | Status | JSON | Phase | Notes |
|---------|--------|------|-------|-------|
| `ontos init` | ✅ rc | ✅ | 3 | Creates .ontos.toml, hooks |
| `ontos map` | ✅ beta | ✅ | 2 | From ontos_generate_context_map.py |
| `ontos log` | ✅ beta | ✅ | 2 | From ontos_end_session.py |
| `ontos doctor` | NEW | ✅ | 4 | Health diagnostics |
| `ontos export` | NEW | ❌ | 4 | CLAUDE.md generation |
| `ontos verify` | Migrate | ✅ | 2 | Staleness verification |
| `ontos query` | Migrate | ✅ | 2 | Graph queries |
| `ontos migrate` | Migrate | ✅ | 2 | Schema migration |
| `ontos consolidate` | Migrate | ✅ | 2 | Log consolidation |
| `ontos promote` | Migrate | ✅ | 2 | Curation promotion |
| `ontos scaffold` | Migrate | ✅ | 2 | L0 scaffold generation |
| `ontos stub` | Migrate | ✅ | 2 | L1 stub creation |
| `ontos hook` | NEW | ❌ | 4 | Hook dispatcher (internal) |

### 6.3 Tasks — `cli.py`

- [ ] Create full `cli.py` with argparse
- [ ] Implement global options:
  - `--version, -V` — Show version and exit
  - `--help, -h` — Show help and exit
  - `--quiet, -q` — Suppress non-essential output
  - `--json` — Output in JSON format
- [ ] Register all commands as subparsers
- [ ] Implement command dispatch
- [ ] Exit code convention:
  - 0: Success
  - 1: Validation Error
  - 2: Configuration Error
  - 3: User Input Error
  - 4: Git Error
  - 5: Internal Error
- [ ] Write CLI integration tests

### 6.4 Tasks — `commands/doctor.py`

- [ ] Create `commands/doctor.py`
- [ ] Implement health checks:
  1. `.ontos.toml` exists and valid
  2. Git hooks installed and point to correct `ontos` binary
  3. Python version compatible (≥3.9)
  4. Docs directory exists
  5. Context map parseable
  6. No validation errors in current documents
  7. `ontos` CLI accessible in PATH
- [ ] Output format (normal mode):
  ```
  ✅ Configuration: .ontos.toml valid
  ✅ Git hooks: pre-push, pre-commit installed
  ✅ Python: 3.11.0 (>=3.9 required)
  ✅ Docs: 25 documents in docs/
  ⚠️  Validation: 2 warnings (run `ontos map --strict`)
  ```
- [ ] JSON output mode
- [ ] Exit codes: 0 (all pass), 1 (any fail)
- [ ] Write tests

### 6.5 Tasks — `commands/hook.py`

- [ ] Create `commands/hook.py`
- [ ] Implement hook dispatcher:
  - Detect hook type from first argument (`pre-push`, `pre-commit`)
  - Load config
  - Check if hook enabled in config
  - For `pre-push`: Run validation, check context map fresh
  - For `pre-commit`: Check consolidation status, warn if docs modified without log
- [ ] Exit codes: 0 (allow), 1 (block)
- [ ] Write tests

### 6.6 Tasks — `commands/export.py`

- [ ] Create `commands/export.py`
- [ ] Implement `run(config, output_type="claude-md", force=False) -> int`
- [ ] File safety check:
  - If file exists and no `--force`: Abort with message
  - If file exists and `--force`: Overwrite
  - If file doesn't exist: Create
- [ ] Template content (v3-only):
  ```markdown
  # CLAUDE.md

  ## Ontos Activation

  This project uses **Ontos** for documentation management.

  At the start of every session:
  1. Run `ontos map` to generate the context map
  2. Read `Ontos_Context_Map.md` to understand the project documentation structure

  When ending a session:
  3. Run `ontos log` to record your work

  ## What is Ontos?

  Ontos is a local-first documentation management system that:
  - Maintains a context map of all project documentation
  - Tracks documentation dependencies and status
  - Ensures documentation stays synchronized with code changes

  For more information, see `docs/reference/Ontos_Manual.md`.
  ```
- [ ] Exit codes: 0 (success), 1 (file exists), 2 (config error)
- [ ] Write tests

### 6.7 Tasks — `ui/json_output.py`

- [ ] Create `ui/json_output.py`
- [ ] Implement `JsonOutputHandler`:
  - `emit(data: Dict) -> None`
  - `error(message: str, code: str) -> None`
  - `result(data: Any) -> None`
- [ ] Implement JSON converters:
  - `to_json(result: ValidationResult) -> Dict`
  - `to_json(context_map: ContextMap) -> Dict`
- [ ] Ensure valid JSON output for all supported commands
- [ ] Write tests

### 6.8 Tasks — `ui/progress.py`

- [ ] Create `ui/progress.py`
- [ ] Implement `ProgressIndicator` class:
  - `start(message: str) -> None`
  - `update(current: int, total: int) -> None`
  - `complete(message: str) -> None`
- [ ] Support quiet mode (no output)
- [ ] Support non-TTY (simple text output)
- [ ] Write unit tests

### 6.9 Tasks — Shim Hooks

- [ ] Create shim hook template (Python-based):
  ```python
  #!/usr/bin/env python3
  """Ontos pre-push hook (shim). Delegates to global CLI."""
  import subprocess
  import sys

  def run_ontos():
      """Try multiple methods to invoke ontos CLI."""
      args = ["hook", "pre-push"] + sys.argv[1:]

      # Method 1: PATH lookup (preferred)
      try:
          return subprocess.call(["ontos"] + args)
      except FileNotFoundError:
          pass

      # Method 2: sys.executable -m ontos (installed but not in PATH)
      try:
          return subprocess.call([sys.executable, "-m", "ontos"] + args)
      except Exception:
          pass

      # Method 3: Give up gracefully
      print("Warning: ontos not found. Skipping hook.", file=sys.stderr)
      return 0

  sys.exit(run_ontos())
  ```
- [ ] Update `commands/init.py` to install this shim
- [ ] Test on macOS, Linux, Windows (best-effort)

**Implementation Note:** The `sys.executable -m ontos` fallback may fail in edge cases:
- Virtual environments where ontos is installed globally but not in venv
- Conda environments with non-standard Python locations
- Systems where Python was installed via pyenv/asdf with shims

Mitigation: Method 3 (graceful skip) ensures git operations aren't blocked. Users experiencing issues can reinstall ontos in their active environment or add it to PATH.

### 6.10 Tasks — Deletion

| File | Reason | Action |
|------|--------|--------|
| `ontos_lib.py` | Deprecated shim | Delete |
| `install.py` | Replaced by pip | Delete |
| `.ontos/scripts/*.py` | Migrated to package | Archive or delete |

- [ ] Delete `ontos_lib.py`
- [ ] Delete `install.py`
- [ ] Archive `.ontos/scripts/` (keep for reference, mark deprecated)
- [ ] Update any documentation referencing deleted files

### 6.11 Acceptance Criteria

- [ ] All 13 commands working per architecture spec
- [ ] `--json` produces valid JSON for all supported commands
- [ ] Shim hooks install correctly on macOS, Linux
- [ ] Shim hooks work on Windows (best-effort)
- [ ] `ontos export` generates valid CLAUDE.md
- [ ] Exit codes correct per spec
- [ ] 303+ tests pass
- [ ] Golden Master tests pass
- [ ] `pip install ontos` works (test from test PyPI)
- [ ] Tag `v3.0.0`

---

## 7. v3.0.1+: Polish & Documentation

**Theme:** "Make it shine"

### 7.1 v3.0.1 Candidates

| Item | Type | Priority | Notes |
|------|------|----------|-------|
| Performance profiling | Optimization | Medium | Target <500ms for <100 docs |
| Documentation updates | Docs | High | README, Manual, Migration guide |
| Bug fixes from v3.0.0 | Fix | As needed | Community-reported issues |
| PyPI publication | Release | High | Publish to production PyPI |

### 7.2 Documentation Deliverables

- [ ] Update `README.md` for v3.0
- [ ] Update `docs/reference/Ontos_Manual.md`:
  - Installation via pip
  - New CLI commands
  - `.ontos.toml` configuration
  - Migration from v2.x
- [ ] Create migration guide: `docs/reference/Migration_v2_to_v3.md`
  - Step-by-step upgrade process
  - Breaking changes
  - FAQ
- [ ] Update `docs/reference/Ontos_Agent_Instructions.md` for v3 commands

### 7.3 Performance Targets

| Operation | Target | Measurement |
|-----------|--------|-------------|
| `ontos map` (<100 docs) | <500ms | Time from invocation to output |
| `ontos map` (100-500 docs) | <2s | Time from invocation to output |
| CLI startup | <100ms | Time to `--version` output |

### 7.4 Acceptance Criteria

- [ ] Performance targets met
- [ ] All documentation updated
- [ ] Published to PyPI
- [ ] No critical bugs open
- [ ] Tag `v3.0.1`

---

## 8. v3.1.0: Bridge Features

**Theme:** "Prepare for Protocol"

**Target:** After v3.0.x stabilizes

### 8.1 Planned Features

| Feature | Source | Description | Effort |
|---------|--------|-------------|--------|
| `ontos deinit` | Deferred from v3.0 | Clean uninstallation command | ~1 day |
| Export `--append` mode | Deferred from v3.0 | Append to existing CLAUDE.md | ~0.5 days |
| Version pinning enforcement | Q5 decision | Upgrade from warn-only | ~1 day |
| Enhanced security prep | Q9 decision | Pre-MCP security hardening | ~2-3 days |
| Obsidian compatibility | Deferred from v2.9.7 | tags, aliases, wikilinks, --obsidian flag | ~3-5 days |
| `--dry-run` for `ontos init` | Install UX debt | Preview changes before applying | ~1 hour |

### 8.2 `ontos deinit` Specification

**Behavior:**
1. Remove shim hooks from `.git/hooks/`
2. Optionally remove `.ontos.toml`
3. Leave documentation intact (unless `--all` flag)
4. Print summary of what was removed

**Exit Codes:**
- 0: Success
- 1: Not initialized (nothing to remove)

### 8.3 Scope Boundaries

**In Scope:**
- Commands: `deinit`
- Flags: `export --append`, `map --obsidian`
- Config: Version enforcement
- Security: Basic hardening
- Obsidian: tags, aliases, wikilinks

**Out of Scope (v3.2+ or v4.0):**
- MCP layer
- Daemon
- Full template system
- Lazy loading

### 8.4 Acceptance Criteria

- [ ] `ontos deinit` works correctly
- [ ] `ontos export --append` works correctly
- [ ] Version pinning blocks (not just warns) on mismatch
- [ ] Security hardening documented and tested
- [ ] Obsidian compatibility works per v3.1.0 spec (see `.ontos-internal/strategy/v3.1/`)
- [ ] Tag `v3.1.0`

---

## 9. v3.2.0+: Protocol Preparation

**Theme:** "Foundation for v4"

### 9.1 Potential Features

| Feature | Dependency | Notes |
|---------|------------|-------|
| MCP layer stub | v3.1 security | `pip install ontos[mcp]` |
| Pydantic in MCP layer | MCP layer | Per Q10 decision |
| Additional export templates | v3.0 export | Based on user feedback |

### 9.2 MCP Layer Stub

**Package Structure:**
```
ontos/
└── mcp/
    ├── __init__.py      # Check for pydantic
    └── server.py        # Stub implementation
```

**Installation:**
```bash
pip install ontos[mcp]  # Adds pydantic dependency
```

### 9.3 v4.0 Readiness Checklist

Before v4.0 can begin:
- [ ] Core/IO separation validated in production
- [ ] Extension points tested with real usage
- [ ] Security model defined
- [ ] MCP ecosystem maturity assessed
- [ ] User feedback on v3.x collected
- [ ] Performance baseline established

---

## 10. Deferred to v4.0

These features are explicitly out of scope for all v3.x releases:

| Feature | Reason | Reference |
|---------|--------|-----------|
| MCP as primary interface | Ecosystem maturity | Strategy Q decision |
| Daemon as default | Operational complexity | Strategy Q decision |
| Full template system | Scope control | Strategy Q2 |
| Lazy loading / context slicing | Complexity | Strategy Q3 |
| Auto-configure MCP clients | Depends on MCP | Strategy Q7 |
| Cross-repo federation | Enterprise scope | Strategy decision |
| S3 archive backend | Local-first philosophy | Strategy decision |
| `ontos activate` command | Agent UX (single-command session init) | Install UX debt |

**User Persona Note:**
- v3.0: Both humans and agents
- v4.0: Agents primary, humans secondary

---

## 11. Dependencies & Sequencing

### 11.1 Dependency Graph

```
Phase 0 (Golden Master)
    │
    ▼
Phase 1 (Package Structure)
    │
    ▼
Phase 2 (God Script Decomposition) ◀── Highest Risk
    │
    ├──────────────────┐
    ▼                  ▼
Phase 3 (Config)    (can parallelize documentation)
    │
    ▼
Phase 4 (CLI & Hooks)
    │
    ▼
v3.0.0 Release
    │
    ▼
Phase 5 (Polish) ──► v3.0.1+
    │
    ▼
v3.1.0 (Bridge Features)
    │
    ▼
v3.2.0+ (Protocol Prep)
    │
    ▼
v4.0 (Agent-First)
```

### 11.2 Critical Path

The critical path for v3.0.0:

1. **Phase 0: Golden Master** — Blocks everything. Cannot safely refactor without tests.
2. **Phase 2: God Script Decomposition** — Highest risk, longest duration. Blocks CLI completion.
3. **Phase 4: CLI Implementation** — Cannot ship without complete CLI.

### 11.3 Parallelization Opportunities

| Can Parallelize | After | Notes |
|-----------------|-------|-------|
| `io/toml.py` | Phase 1 | Independent of God Script decomposition |
| `commands/doctor.py` | Phase 2 | New command, no migration needed |
| `ui/json_output.py` | Phase 2 | Independent formatting layer |
| Documentation | Phase 3 | Can draft while Phase 4 completes |
| `commands/export.py` | Phase 3 | New command, independent |

### 11.4 Blocking Dependencies

| Blocked Task | Blocks On | Reason |
|--------------|-----------|--------|
| Any refactoring | Phase 0 | Need Golden Master safety net |
| `commands/map.py` | `core/graph.py`, `core/validation.py` | Core modules must exist first |
| `commands/log.py` | `core/suggestions.py`, `io/git.py` | Core and I/O modules must exist first |
| `commands/init.py` | `io/toml.py` | Config system must exist first |
| CLI completion | All commands | All commands must be migrated/created |

---

## 12. Effort Estimates

### 12.1 By Phase

| Phase | Theme | Est. Days | Risk | Notes |
|-------|-------|-----------|------|-------|
| 0 | Golden Master | 2-3 | Low | Testing infrastructure |
| 1 | Package Structure | 1-2 | Low | Mostly file moves |
| 2 | God Script Decomposition | **6-10** | **High** | Complex extraction + minor commands + io/toml.py |
| 3 | Configuration Migration | 2-3 | Medium | New config system |
| 4 | CLI & Hooks | 3-5 | Medium | CLI completion |
| 5 | Polish | 2-3 | Low | Documentation, fixes |
| **Total v3.0.0** | | **16-26** | | |

### 12.2 Risk-Adjusted Estimate

Given Phase 2 complexity and expanded scope:
- **Optimistic:** 16 days
- **Realistic:** 24 days
- **Pessimistic:** 32 days

**Recommendation:** Plan for 22-28 days to v3.0.0.

### 12.3 v3.1.0 Estimate

| Feature | Est. Days |
|---------|-----------|
| `ontos deinit` | 1 |
| Export `--append` | 0.5 |
| Version enforcement | 1 |
| Security hardening | 2-3 |
| **Total v3.1.0** | **5-6** |

### 12.4 Module-Level Estimates

| Module | Est. Days | Complexity |
|--------|-----------|------------|
| `core/graph.py` | 1-2 | Medium |
| `core/validation.py` | 1-2 | Medium |
| `core/types.py` | 0.5 | Low |
| `core/suggestions.py` | 1 | Medium |
| `core/tokens.py` | 0.25 | Low |
| `io/git.py` | 1 | Medium |
| `io/files.py` | 1 | Medium |
| `io/toml.py` | 0.5 | Low |
| `commands/map.py` | 1-2 | High |
| `commands/log.py` | 2-3 | High |
| REFACTOR modules | 1-2 | Medium |

---

## 13. Success Criteria

### 13.1 v3.0.0 Release Criteria

**Functional:**
- [ ] All 13 commands functional per architecture spec
- [ ] `pip install ontos` works from PyPI
- [ ] `ontos init` + `ontos map` workflow functional
- [ ] Shim hooks work on macOS, Linux, Windows (best-effort)
- [ ] `--json` flag produces valid JSON

**Quality:**
- [ ] Golden Master tests pass (no behavior regression)
- [ ] 303+ unit tests passing
- [ ] No critical bugs open
- [ ] Documentation updated

**Performance:**
- [ ] `ontos map` <500ms for <100 docs
- [ ] CLI startup <100ms

### 13.2 v3.x Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Command execution time | <500ms for <100 docs | Benchmark suite |
| CLI startup | <100ms | Time to `--version` |
| Test coverage (core/) | >90% | pytest-cov |
| Test coverage (overall) | >80% | pytest-cov |
| Bug escape rate | <5 critical in first month | Issue tracker |

### 13.3 Phase Exit Criteria

| Phase | Exit Criteria | Status |
|-------|---------------|--------|
| 0 | Golden Master tests capturing v2.9.x behavior | **Complete** |
| 1 | `pip install -e .` works, tests pass | Not Started |
| 2 | God Scripts decomposed, Golden Master passes | Not Started |
| 3 | `ontos init` creates valid config, hooks install | Not Started |
| 4 | All commands work, ready for PyPI | Not Started |
| 5 | Published to PyPI, documentation complete | Not Started |

---

## 14. Open Questions

Questions to resolve during implementation:

| # | Question | When to Decide | Owner | Options |
|---|----------|----------------|-------|---------|
| 1 | PyPI package name | Phase 1 | Founder | `ontos` vs `project-ontos` |
| 2 | Minimum Python version | Phase 1 | Architect | 3.9 (broader) vs 3.10 (cleaner) |
| 3 | CI platform | Phase 0 | Implementation team | GitHub Actions vs other |
| 4 | Test coverage target | Phase 0 | Architect | 80% vs 90% |
| 5 | Bundle tomli or require install? | Phase 3 | Architect | Bundle (simpler) vs optional dep |

### 14.1 Resolved Questions (from Strategy/Architecture)

| Question | Decision | Reference |
|----------|----------|-----------|
| TOML parser for 3.9-3.10 | Bundle tomli | Architecture Q1 |
| Watch mode in v3.0? | Defer to v3.1 | Architecture Q2 |
| Interactive prompts | Built-in input() | Architecture Q3 |
| Windows support | Best-effort | Architecture Q4 |
| JSON vs Markdown primary | Markdown primary | Strategy Q13 |
| Python vs Node for MCP | Python | Strategy Q12 |

---

*End of Implementation Roadmap*

*Document version 1.3 — 2026-01-12*
*Chief Architect: Claude Opus 4.5*
*Reviewed by: Codex (A), Claude (B), Gemini (C), Gemini (D)*
