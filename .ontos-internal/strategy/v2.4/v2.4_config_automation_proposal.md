---
id: v2_4_config_automation_proposal
type: strategy
status: draft
depends_on: [v2_strategy, mission]
---

# Ontos v2.4 Proposal: Configuration Automation & UX Overhaul

**Authors:** Jonathan Oh, Claude Code
**Date:** 2025-12-15 (Second revision after v2 architectural review)
**Status:** Draft - Revised based on Claude/Codex/Gemini v2 feedback
**Version:** 1.2

---

## Executive Summary

This document proposes a significant UX improvement to Ontos configuration. The goal is to reduce friction for new users while preserving power-user flexibility.

**Key changes from v1.0:**
- **Session Appending Model** (from Gemini) - One log per branch per day, not per push
- **Quality Signals** (from Claude) - `status: auto-generated` for lint warnings
- **Environment Variable Support** (from Codex) - `ONTOS_SOURCE` for CI/shared machines

**Key changes from v1.1 (v2 feedback):**
- **üî¥ CRITICAL: No consolidation in pre-push** - Creates "Dirty Push" paradox (Gemini/Claude consensus)
- **Branch validation in frontmatter** - Prevents wrong-log-appended bugs (Claude)
- **Exact match before glob** - Fixes greedy pattern matching (Claude)
- **Visible warnings on skip** - "Zero friction" ‚â† "zero visibility" (Claude)
- **Commit deduplication** - Prevents duplicate entries on amend+push (Claude)
- **`--enhance` flag** - Agent workflow for enriching auto-generated logs (Claude)
- **Hook timeout** - Prevents slow hooks from frustrating users (Codex)

---

## 1. Problem Statement

### 1.1 Current Pain Points

1. **Configuration is fragmented and technical**
   - Users must understand 10+ individual settings
   - No clear guidance on which settings work well together
   - Default values assume "strict team mode" which frustrates solo devs

2. **Maintenance rituals are forgotten**
   - `Consolidate Ontos` is documented but rarely executed
   - No enforcement or automation for log cleanup
   - Active logs grow unbounded in most projects

3. **Installation doesn't capture user intent**
   - `ontos_init.py` creates config but doesn't ask preferences
   - Users must manually edit `ontos_config.py` to customize
   - No guided setup for different use cases

4. **Archiving ceremony creates friction**
   - Pre-push hook blocks until manual archive
   - Users resort to `--no-verify` to bypass
   - Context is lost when ceremony is skipped

---

## 2. Design Evolution

### 2.1 Original Design (v1.0)

Three modes: `automated`, `prompted`, `advisory`
- Automated mode creates log on every push
- Simple and intuitive

### 2.2 Reviewer Feedback Summary

| Reviewer | Key Insight | Impact |
|----------|-------------|--------|
| **Claude** | Auto-generated logs need quality signal | Add `status: auto-generated` |
| **Codex** | Need env var support for CI | Add `ONTOS_SOURCE` |
| **Gemini** | 5 pushes = 5 logs is noise ("Ghost Logs") | **Session Appending model** |

### 2.3 The "Ghost Log" Problem (Gemini's Insight)

**Original model (flawed):**
```
Push #1 ‚Üí creates 2025-12-14_feature-login.md
Push #2 ‚Üí creates 2025-12-14_feature-login-2.md  ‚Üê noise
Push #3 ‚Üí creates 2025-12-14_feature-login-3.md  ‚Üê more noise
```

A developer pushing WIP commits throughout the day would generate multiple empty logs. This floods the Context Map with low-value nodes‚Äîworse than nothing because it creates false confidence.

**Why this matters:**
> "If a log contains no manual curation and is just auto-generated from the branch name and diff, it is functionally identical to a git commit. You are duplicating git history into Markdown without adding the 'Ontological' value (the *why*)." ‚Äî Gemini

### 2.4 The Solution: Session Appending

**Revised model:**
```
Push #1 ‚Üí creates 2025-12-14_feature-login.md (new log)
Push #2 ‚Üí appends to 2025-12-14_feature-login.md (same log)
Push #3 ‚Üí appends to 2025-12-14_feature-login.md (same log)
```

**Result:** One log per branch per day, accumulating commits. This:
- Prevents ghost log pollution
- Maintains 1:1 relationship with eventual squashed merge
- Still captures all commit history within the log

**Implementation:** `ontos_end_session.py` gains `--append` behavior:
1. Check if log exists for this branch + today's date
2. If yes ‚Üí append new commits to "Raw Session History" section
3. If no ‚Üí create new log

---

## 3. Revised Architecture

### 3.1 Two-Tier Configuration (Unchanged)

The core model remains: **Modes + Individual Overrides**

```python
# Tier 1: Choose a mode (sets sensible defaults)
ONTOS_MODE = "automated"

# Tier 2: Override specific settings if needed
# AUTO_ARCHIVE_ON_PUSH = True  # uncomment to override
```

### 3.2 Mode Presets (Revised)

| Setting | `automated` | `prompted` | `advisory` |
|---------|-------------|------------|------------|
| `AUTO_ARCHIVE_ON_PUSH` | True | False | False |
| `ENFORCE_ARCHIVE_BEFORE_PUSH` | False | True | False |
| `REQUIRE_SOURCE_IN_LOGS` | False | True | False |
| `AUTO_CONSOLIDATE` | True | True | False |

**Note on AUTO_CONSOLIDATE (v1.2):** This setting controls behavior in `Maintain Ontos`, NOT during push. Even in `automated` mode, consolidation never runs silently during `git push`‚Äîonly during explicit maintenance.

**Note on mode naming:** We considered alternatives (`autopilot`/`guided`/`relaxed`) but kept original names because:
- "Automated" clearly means "does things automatically"
- "Prompted" clearly means "prompts you to act"
- "Advisory" clearly means "advises but doesn't enforce"

### 3.3 New: Status Field for Auto-Generated Logs

**Why:** Claude identified that auto-generated logs need a quality signal so users know which logs need human enhancement.

```yaml
---
id: log_20251214_feature_login
type: log
status: auto-generated  # NEW: signals this needs review
event_type: feature
concepts: []
impacts: []
---
```

**Lint behavior:**
```
$ python3 ontos_generate_context_map.py --lint

‚ö†Ô∏è  Data Quality Warnings:
   - 3 auto-generated logs need human review:
     - log_20251214_feature_login
     - log_20251214_fix_auth
     - log_20251215_chore_deps
```

**Why not reject minimal logs entirely?**

Gemini argued "minimal auto-log is worse than no log." We disagree because:
1. A log with branch name, date, and commits IS a breadcrumb‚Äîuseful for reconstruction
2. The ghost log problem was about *quantity*, not *quality*‚Äîsession appending solves this
3. Marking as `auto-generated` lets users enhance later without blocking workflow

### 3.4 ~~New: Consolidation in Pre-Push Hook~~ REMOVED (v1.2)

**Original plan (v1.1):** Pre-push hook triggers consolidation if log count exceeds threshold.

**Why removed:** Both Gemini and Claude independently identified a critical flaw‚Äîthe "Dirty Push" Paradox:

```
1. User runs `git push`
2. Pre-push hook runs consolidation ‚Üí moves files, updates decision_history.md
3. Hook exits 0 (success)
4. Push sends ORIGINAL state to remote (before consolidation)
5. User now has DIRTY working tree with uncommitted consolidation changes
6. User must run `git add . && git commit && git push` AGAIN
```

This defeats the "zero friction" goal. Mutating files during pre-push creates more work, not less.

**Revised approach:** Consolidation is ADVISORY only in pre-push:

```python
# In ontos_pre_push_check.py (all modes)

if count_active_logs() > LOG_RETENTION_COUNT:
    print(f"‚ö†Ô∏è  {count} logs exceed threshold. Run 'Maintain Ontos' to consolidate.")
    # Do NOT run consolidation here - just warn
```

**Where consolidation happens:**
1. **Manual:** Run `python3 .ontos/scripts/ontos_consolidate.py`
2. **In `Maintain Ontos`:** If `AUTO_CONSOLIDATE = True`, maintenance runs consolidation
3. **Never during push** - no silent file mutations during git operations

This aligns with Gemini's recommendation: "Automated mode should automate *capture* (logging), not *janitorial work* (consolidation), because janitorial work requires a commit."

### 3.5 New: Environment Variable Support

**Why:** Codex identified that `DEFAULT_SOURCE` doesn't support CI or shared machines.

**Resolution order:**
1. `ONTOS_SOURCE` environment variable (highest priority)
2. `DEFAULT_SOURCE` in config
3. `git config user.name`
4. Prompt user (if interactive)

```python
def get_source():
    return (
        os.environ.get('ONTOS_SOURCE') or
        getattr(config, 'DEFAULT_SOURCE', None) or
        get_git_user_name() or
        prompt_for_source()
    )
```

**Use case:** CI pipelines can set `ONTOS_SOURCE=CI Bot` without modifying config.

### 3.6 New: Dirty Git Check (Revised v1.2)

**Why:** Codex identified that auto-archiving with uncommitted changes could create confusing partial logs.

**Behavior:** In automated mode, if `git status` shows uncommitted changes:
```
‚ö†Ô∏è  Uncommitted changes detected. Skipping auto-archive.
    Commit your changes first, or run 'Archive Ontos' manually.
```

**v1.2 clarification: "Zero friction" ‚â† "zero visibility"**

Claude v2 correctly identified that silent skips are confusing‚Äîusers don't know their session wasn't logged. The warning above is printed visibly, even though it doesn't block the push. This maintains zero friction (push proceeds) while ensuring transparency (user knows what happened).

### 3.7 New: Hook Timeout (v1.2)

**Why:** Codex identified that slow hooks create `--no-verify` pressure.

**Behavior:** Pre-push hook operations have a maximum timeout:
```python
HOOK_TIMEOUT_SECONDS = 10  # Fail gracefully, don't hang

try:
    result = subprocess.run(cmd, timeout=HOOK_TIMEOUT_SECONDS)
except subprocess.TimeoutExpired:
    print("‚ö†Ô∏è  Ontos check timed out. Proceeding with push.")
    print("    Run 'Maintain Ontos' to check status.")
```

**Why timeout instead of block?**

A hanging hook is worse than a skipped check. Users will reach for `--no-verify` if Ontos becomes unpredictable. Better to degrade gracefully and let maintenance catch issues later.

### 3.8 New: Agent Workflow Enhancement (v1.2)

**Why:** Claude v2 identified that agents need a way to enrich auto-generated logs.

**Problem:** In automated mode, pre-push creates `status: auto-generated` logs. When an agent later runs `Archive Ontos`, the existing script says "Log already exists" and exits.

**Solution:** Add `--enhance` flag to `ontos_end_session.py`:

```bash
python3 .ontos/scripts/ontos_end_session.py --enhance
# Opens most recent auto-generated log for enrichment
```

**Agent workflow updated:**
```markdown
### "Archive Ontos" (When Log Exists)

If a log exists with `status: auto-generated`:
1. Read the existing log
2. Fill in Goal, Key Decisions, Alternatives Considered
3. Add concepts and verify impacts
4. Change status from `auto-generated` to `active`
5. Commit the enriched log
```

This preserves the commit history captured by auto-archive while allowing agents to add the "ontological value" (the *why*).

---

## 4. Installation Flow (Revised)

### 4.1 Interactive Mode

```
Welcome to Project Ontos Setup
==============================

1. How should Ontos handle session archiving?

   [1] Fully Automatic (recommended for solo devs)
       - Auto-archives session on git push
       - One log per branch per day (appends on subsequent pushes)
       - Zero friction, best practices enforced silently

   [2] Prompted (recommended for teams) [DEFAULT]
       - Push blocked until you archive
       - You choose event type, slug, and details
       - More control, ensures quality

   [3] Advisory (minimal)
       - Push shows reminder only
       - You decide if/when to archive
       - Maximum flexibility, risk of forgetting

2. What name should appear in logs?

   Enter name (or blank to prompt each time): Claude Code

   Tip: Set ONTOS_SOURCE env var to override per-session

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Configuration saved to ontos_config.py
You can change these anytime by editing the file
or running: python3 ontos_init.py --reconfig
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
```

**Key changes:**
- Default is now `prompted` (press Enter without choosing)
- Removed separate consolidation question (follows mode automatically)
- Added tip about `ONTOS_SOURCE` env var

**Why default to prompted?**

> "Ontos is a *discipline* tool. If you default to 'Automated', users will generate weeks of empty logs, realize the Context Map is useless noise, and uninstall. You must force them to see the value of *curation* at least once before allowing them to automate it away." ‚Äî Gemini

We agree partially: the *default* should be prompted, but users who explicitly choose automated know what they want.

### 4.2 Non-Interactive Mode (New)

**Why:** Claude identified that CI environments need non-interactive setup.

```bash
python3 ontos_init.py --non-interactive --mode=automated --source="CI Bot"
```

Uses sensible defaults, no prompts. Essential for automated deployments.

---

## 5. Config File Structure (Revised)

### 5.1 Template-Based Generation

**Why:** Gemini identified that string concatenation is brittle.

**New approach:** Ship `.ontos/templates/ontos_config.py.template`:

```python
"""Ontos Configuration.

Generated by ontos_init.py. Edit this file to customize behavior.
Run `python3 ontos_init.py --reconfig` to reconfigure via prompts.
"""

# =============================================================================
# QUICK SETUP: Choose your mode
# =============================================================================
# "automated" - Zero friction, archives on push, auto-consolidates
# "prompted"  - Blocked until archived, you control details (DEFAULT)
# "advisory"  - Reminders only, maximum flexibility
#
# This sets sensible defaults. Override individual settings below if needed.

ONTOS_MODE = "{{MODE}}"

# Your name for log attribution (can override with ONTOS_SOURCE env var)
# Note: Template generator must properly quote this value
DEFAULT_SOURCE = {{SOURCE_QUOTED}}  # e.g., "Claude Code" or None

# =============================================================================
# ADVANCED: Individual settings (override mode defaults)
# =============================================================================
# Uncomment to customize. These override ONTOS_MODE defaults.

# --- Archiving Behavior ---
# AUTO_ARCHIVE_ON_PUSH = True        # Auto-create log on push
# ENFORCE_ARCHIVE_BEFORE_PUSH = True # Block push until archived
# REQUIRE_SOURCE_IN_LOGS = True      # Require --source flag

# --- Consolidation ---
# AUTO_CONSOLIDATE = True            # Auto-archive old logs in Maintain
# CONSOLIDATION_THRESHOLD_DAYS = 30  # Age threshold for consolidation

# --- Validation ---
# SMALL_CHANGE_THRESHOLD = 20        # Lines below this = "small change"
# LOG_RETENTION_COUNT = 15           # Warn when logs exceed this
```

**Why template over string concatenation?**

1. Easier to maintain‚Äîedit template, not Python code
2. Comments stay synchronized with options
3. Less error-prone‚Äîno escaping issues
4. Reviewable‚Äîtemplate is just a file

### 5.2 Config Debug Command (New)

**Why:** Codex suggested `ontos config show` for debugging.

```bash
$ python3 .ontos/scripts/ontos_config.py --show

Effective Configuration:
========================
ONTOS_MODE = "automated"
  ‚Üí AUTO_ARCHIVE_ON_PUSH = True (from mode)
  ‚Üí ENFORCE_ARCHIVE_BEFORE_PUSH = False (from mode)
  ‚Üí AUTO_CONSOLIDATE = True (from mode)

DEFAULT_SOURCE = "Claude Code" (explicit)
ONTOS_SOURCE env var = not set

Overrides: none
```

Helps users understand what settings are active and where they come from.

---

## 6. Failure Modes (New Section)

**Why:** Claude identified this as a critical gap.

### 6.1 Fallback Chain for Auto-Archive

| Scenario | Fallback | Behavior |
|----------|----------|----------|
| Normal branch | Branch name ‚Üí slug | `feat/login` ‚Üí `login` |
| Blocked branch name (`main`, `master`) | Last commit subject | `fix: auth bug` ‚Üí `fix-auth-bug` |
| Detached HEAD | Last commit subject | Same as above |
| No commits since last archive | Skip | Don't create empty log |
| `DEFAULT_SOURCE` not set, no env var | `git config user.name` | Use git identity |
| All fallbacks fail | **Prompt user** | Never silently skip |

**Key principle:** Even in automated mode, a complete failure should surface, not disappear. Silent failures defeat the purpose of Ontos.

### 6.2 Slug Collision Handling

**Why:** Claude identified that same-day, same-branch pushes could collide.

With session appending, this is mostly solved (we append instead of create). But if somehow a collision occurs:

```
2025-12-14_feature-login.md     (first)
2025-12-14_feature-login-2.md   (collision fallback)
```

---

## 7. Implementation Scope (Revised)

### 7.1 Files to Modify

| File | Changes |
|------|---------|
| `ontos_config_defaults.py` | Add `ONTOS_MODE`, `AUTO_ARCHIVE_ON_PUSH`, mode presets, `HOOK_TIMEOUT_SECONDS` |
| `ontos_lib.py` | Add `resolve_config()` function (not new file) |
| `ontos_init.py` | New installation prompts, `--reconfig`, `--non-interactive`, config migration |
| `ontos_end_session.py` | Add `--auto` flag, `--enhance` flag (v1.2), session appending logic, `status: auto-generated`, branch validation (v1.2), commit deduplication (v1.2) |
| `ontos_pre_push_check.py` | Auto-archive logic, consolidation **warning** (not trigger - v1.2), dirty git check with visible warning (v1.2), hook timeout (v1.2) |
| `ontos_generate_context_map.py` | Lint warning for auto-generated logs |

### 7.2 New Files

| File | Purpose |
|------|---------|
| `.ontos/templates/ontos_config.py.template` | Config file template with proper quoting (v1.2) |

### 7.3 Tests to Add

- Mode preset resolution
- Session appending (existing log detection, append behavior)
- **v1.2:** Branch validation in frontmatter
- **v1.2:** Exact match before glob for log detection
- **v1.2:** Commit deduplication on append
- Auto-archive on push (mock git operations)
- Branch prefix ‚Üí event type inference
- Fallback chain for slug/source
- Dirty git detection **with visible warning** (v1.2)
- **v1.2:** Hook timeout handling
- Non-interactive mode
- **v1.2:** `--enhance` flag for agent workflow
- **v1.2:** Config migration in `--reconfig`

---

## 8. What We're NOT Doing (And Why)

| Rejected Idea | Source | Why Ignored |
|---------------|--------|-------------|
| Mode renaming (`autopilot`/`guided`/`relaxed`) | Claude | Original names are clear. "Autopilot" sounds passive. |
| Personas ("solo", "team", "compliance") | Codex | Over-engineering. 3 modes is sufficient complexity. |
| Telemetry / observability | Codex | Contradicts local-first philosophy. "No API keys, no vendor lock-in." |
| `BRANCH_PREFIX_MAP` config | Claude | 95% use conventional prefixes. Edge case doesn't justify complexity. |
| Checksum mode drift detection | Codex | Magic behavior, hard to debug. Users who edit config know what they're doing. |
| Performance optimization for >10k files | Codex | Premature. If you have 10k logs, you've misunderstood Ontos. |
| Single-toggle `PRE_PUSH_BEHAVIOR` | Claude | Modes are more intuitive than orthogonal settings. |
| Separate config resolver file | Original | Keep in `ontos_lib.py` per Gemini's feedback. |

---

## 9. Migration Path

### 9.1 Existing Users

- `ontos_config.py` continues to work as-is
- No `ONTOS_MODE` ‚Üí individual settings respected (backward compatible)
- Running `ontos_init.py --reconfig` offers migration to new system

### 9.2 New Users

- Installation prompts for mode selection
- Default is `prompted` if user just presses Enter
- Config file generated from template

### 9.3 Backward Compatibility

All existing settings remain valid. The mode system is purely additive. Users who never touch `ONTOS_MODE` see no change.

---

## 10. Success Metrics

| Metric | Target |
|--------|--------|
| New user setup time | < 2 minutes |
| `--no-verify` usage | Reduced (users don't need to bypass) |
| Consolidation rate | Increased (actually happens in automated mode) |
| Ghost logs | Zero (session appending prevents them) |
| Auto-generated logs enhanced | Lint warns, users act |

---

## 11. Known Limitations

### 11.1 CI/CD Blindspot

**Limitation:** Automated mode is local-only. PR merges via GitHub UI won't create logs.

**Why acceptable:** Ontos is designed for capturing developer context during work. Merge commits are administrative, not context-rich. If needed, a GitHub Action could be added later.

### 11.2 Squash Merge Alignment

**Limitation:** Multiple logs over several days for one branch will exist, even if the PR is squash-merged into one commit.

**Why acceptable:** The logs capture the *journey*, not just the destination. Session appending ensures one log per day per branch, which is reasonable granularity.

---

## 12. Recommendation

**Proceed with implementation.** The v1.2 design addresses all critical concerns from two rounds of architectural review:

**From v1.0 ‚Üí v1.1:**
1. ‚úÖ Ghost log problem ‚Üí Session appending
2. ‚úÖ Quality signal ‚Üí `status: auto-generated`
3. ‚úÖ Silent failures ‚Üí Defined fallback chain
4. ‚úÖ CI support ‚Üí `ONTOS_SOURCE` env var + `--non-interactive`

**From v1.1 ‚Üí v1.2:**
5. ‚úÖ "Dirty Push" paradox ‚Üí Consolidation removed from pre-push (warn only)
6. ‚úÖ Wrong-log-appended ‚Üí Branch validation in frontmatter
7. ‚úÖ Greedy glob pattern ‚Üí Exact match first
8. ‚úÖ Silent skips ‚Üí Visible warnings ("zero friction" ‚â† "zero visibility")
9. ‚úÖ Duplicate commits ‚Üí Deduplication on append
10. ‚úÖ Agent workflow gap ‚Üí `--enhance` flag
11. ‚úÖ Slow hook frustration ‚Üí Hook timeout with graceful degradation

**Reviewer consensus achieved:**
- Gemini: CONDITIONALLY APPROVED ‚Üí all conditions addressed
- Claude: 4 must-fix items ‚Üí all fixed in v1.2
- Codex: Core concerns addressed, optional suggestions deferred

**Suggested version:** v2.4.0 (minor version bump‚Äînew feature, backward compatible)

---

## Appendix A: Reviewer Feedback Analysis

### What We Adopted (v1.0 ‚Üí v1.1)

| Feedback | Source | Implementation |
|----------|--------|----------------|
| Session appending | Gemini | One log per branch/day, append on subsequent pushes |
| `status: auto-generated` | Claude | New status value, lint warnings |
| Failure mode documentation | Claude | Fallback chain, never silently fail |
| ~~Consolidation in pre-push~~ | ~~Gemini~~ | ~~Trigger when log count > threshold~~ (REVERSED in v1.2) |
| `ONTOS_SOURCE` env var | Codex | Resolution: env ‚Üí config ‚Üí git ‚Üí prompt |
| `--non-interactive` flag | Claude | For CI/CD environments |
| Config template file | Gemini | `.ontos/templates/ontos_config.py.template` |
| Slug collision handling | Claude | Counter suffix as fallback |
| `--show` config debug | Codex | Print resolved values |
| Default mode = prompted | Gemini | Explicit Enter = prompted, not automated |
| Dirty git check | Codex | Skip auto-archive if uncommitted changes |

### What We Adopted (v1.1 ‚Üí v1.2)

| Feedback | Source | Implementation |
|----------|--------|----------------|
| **üî¥ Remove consolidation from pre-push** | Gemini+Claude | "Dirty Push" paradox‚Äîwarn only, never mutate during push |
| Branch name in frontmatter | Claude | Validates append is to correct log, prevents wrong-log-appended |
| Exact match before glob | Claude | Fixes greedy pattern matching `login*` ‚Üí `login-flow` |
| Template quoting fix | Claude | `{{SOURCE_QUOTED}}` generates valid Python |
| Visible skip warnings | Claude | "Zero friction" ‚â† "zero visibility" |
| Commit deduplication | Claude | Skip already-present hashes on append |
| `--enhance` flag | Claude | Agent workflow for enriching auto-generated logs |
| Hook timeout | Codex | Graceful degradation for slow hooks |
| Config migration | Gemini | `--reconfig` handles existing configs |

### What We Rejected

| Feedback | Source | Reason |
|----------|--------|--------|
| Mode renaming | Claude | Original names are intuitive enough |
| Personas | Codex | Over-engineering; 3 modes is sufficient |
| Telemetry | Codex | Contradicts local-first philosophy |
| `BRANCH_PREFIX_MAP` | Claude | Edge case; not worth complexity |
| Checksum drift detection | Codex | Magic behavior; users who edit know what they're doing |
| >10k file optimization | Codex | Premature; misuse of Ontos |
| Single-toggle alternative | Claude | Modes more intuitive than orthogonal settings |
| "Minimal log is worse than no log" | Gemini | Disagree; breadcrumb is useful, session appending solves quantity |

### What We Deferred (v1.2)

| Feedback | Source | Reason |
|----------|--------|--------|
| Mode orthogonality refactor | Claude | Valid architectural point, but modes are simpler for v2.4. Revisit if users request unsupported combinations. |

---

## Appendix B: Session Appending Implementation Detail (Revised v1.2)

### Detection Logic (Fixed v1.2)

**Problem (v1.1):** The glob pattern `{today}_{branch_slug}*.md` was too greedy‚Äîit matched `login-flow.md` when searching for `login`.

**Solution:** Exact match first, then collision variants:

```python
def find_existing_log_for_today(branch_slug: str, branch_name: str) -> Optional[str]:
    """Find existing log for this branch created today.

    v1.2: Exact match first, then collision variants. Validates branch name.
    """
    today = datetime.now().strftime('%Y-%m-%d')

    # 1. Try exact match first (most common case)
    exact = os.path.join(LOGS_DIR, f"{today}_{branch_slug}.md")
    if os.path.exists(exact):
        if validate_branch_in_log(exact, branch_name):
            return exact
        # Log exists but for different branch - collision!
        print(f"‚ö†Ô∏è  Slug collision: {exact} belongs to different branch")

    # 2. Check collision variants (-2, -3, etc.)
    for i in range(2, 10):
        variant = os.path.join(LOGS_DIR, f"{today}_{branch_slug}-{i}.md")
        if os.path.exists(variant):
            if validate_branch_in_log(variant, branch_name):
                return variant

    return None  # No existing log found


def validate_branch_in_log(log_path: str, expected_branch: str) -> bool:
    """Check if log's frontmatter branch matches expected.

    v1.2: Prevents wrong-log-appended bugs.
    """
    content = read_file(log_path)
    # Extract branch from frontmatter
    match = re.search(r'^branch:\s*(.+)$', content, re.MULTILINE)
    if match:
        return match.group(1).strip() == expected_branch
    # Legacy logs without branch field - assume match
    return True
```

### Frontmatter Enhancement (v1.2)

**Problem:** `feat/login` and `fix/login` both map to slug `login`, causing wrong-log-appended bugs.

**Solution:** Store full branch name in frontmatter:

```yaml
---
id: log_20251214_login
type: log
status: auto-generated
branch: feat/login  # NEW v1.2: validates append is to correct log
event_type: feature
concepts: []
impacts: []
---
```

### Append Behavior (Revised v1.2)

```python
def append_to_log(log_path: str, new_commits: list):
    """Append new commits to existing log's Raw Session History.

    v1.2: Deduplicates commits to handle amend+push scenarios.
    """
    content = read_file(log_path)

    # Extract existing commit hashes to prevent duplicates
    existing_hashes = set(re.findall(r'^([a-f0-9]{7,40}) -', content, re.MULTILINE))

    # Filter out duplicates
    unique_commits = [c for c in new_commits if c.hash[:7] not in existing_hashes]

    if not unique_commits:
        print("‚ÑπÔ∏è  No new commits to append (all already present)")
        return

    # Find Raw Session History section
    marker = "## Raw Session History"
    if marker in content:
        # Append new commits
        new_history = format_commits(unique_commits)
        content = content.replace(
            "```\n\n---",  # End of history block
            f"{new_history}\n```\n\n---"
        )

    write_file(log_path, content)
    print(f"üìù Appended {len(unique_commits)} commits to {log_path}")
```

---

*Document history:*
- *v1.0: 2025-12-14 ‚Äî Initial proposal*
- *v1.1: 2025-12-14 ‚Äî Revised after Claude/Codex/Gemini v1 review (Session Appending, status:auto-generated)*
- *v1.2: 2025-12-15 ‚Äî Revised after Claude/Codex/Gemini v2 review (Dirty Push fix, branch validation, exact match, deduplication, --enhance, hook timeout)*

*Document revised 2025-12-15 after two rounds of architectural review by Claude, Codex, and Gemini.*
