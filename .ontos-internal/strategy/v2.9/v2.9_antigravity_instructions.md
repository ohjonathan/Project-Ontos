---
id: antigravity_v2_9_instructions
type: strategy
status: active
depends_on: [v2_9_implementation_plan, master_plan_v4]
concepts: [implementation, onboarding, v2.9]
---

# Antigravity v2.9 Implementation Instructions

**To:** Antigravity (Implementation Agent)
**From:** Chief Architect (Claude Code)
**Date:** 2025-12-22
**Subject:** Complete instructions for implementing v2.9

---

## 0. Executive Summary

You are tasked with implementing **v2.9** of Project Ontos, a "conscious memory system" for AI-native development teams. This release bridges V2 â†’ V3 with four major features:

| Feature | Purpose | Risk |
|---------|---------|------|
| **Schema Versioning** | Forward compatibility for V3 migration | Medium |
| **Curation Levels** | Lower adoption barrier with tiered validation | Low |
| **Deprecation Warnings** | Prepare users for V3 breaking changes | Low |
| **install.py Bootstrap** | Single-file curl-based installation | Medium |

**Your primary reference:** `.ontos-internal/strategy/v2.9/v2.9_implementation_plan.md` (3,250 lines, approved v1.3.0)

---

## 1. Understanding Project Ontos

### 1.1 What is Ontos?

Ontos is a **structured knowledge graph** for software projects, stored as markdown files with YAML frontmatter. It provides:

- **Deterministic context retrieval** (no vector search)
- **Causal reasoning** via explicit `depends_on` relationships
- **Time-indexed history** via session logs
- **Staleness detection** via `describes` field linking docs to code

### 1.2 The Hierarchy

```
kernel/     â†’ Mission, principles (rarely changes)
strategy/   â†’ Roadmaps, plans (changes quarterly)
product/    â†’ Features, specs (changes weekly)
atoms/      â†’ Technical docs (changes daily)
logs/       â†’ Session histories (append-only)
```

### 1.3 The Philosophy

From the Master Plan:

> **The Librarian's Wager:** We trade **Higher Friction** (manual curation) for **Higher Signal** (deterministic context).

Users manually curate documents with frontmatter. In return, they get precise, non-hallucinated context retrieval.

---

## 2. Current State (v2.8.6)

### 2.1 What's Already Built

| Component | Status | Location |
|-----------|--------|----------|
| SessionContext (transactions) | âœ… Complete | `.ontos/scripts/ontos/core/context.py` |
| Unified CLI (ontos.py) | âœ… Complete | `ontos.py` |
| Frontmatter parsing | âœ… Complete | `.ontos/scripts/ontos/core/frontmatter.py` |
| Staleness detection | âœ… Complete | `.ontos/scripts/ontos/core/staleness.py` |
| OutputHandler (UI) | âœ… Complete | `.ontos/scripts/ontos/ui/output.py` |
| 285+ tests passing | âœ… Complete | `.ontos/scripts/tests/` |

### 2.2 Key Files to Understand

**CRITICAL - Read these before writing any code:**

```
ontos.py                                    # CLI dispatcher (entry point)
.ontos/scripts/ontos/core/context.py        # SessionContext class
.ontos/scripts/ontos/core/frontmatter.py    # parse_frontmatter()
.ontos/scripts/ontos_lib.py                 # Legacy shim (being deprecated)
.ontos/scripts/ontos_config_defaults.py     # Default configuration
ontos_config.py                             # User configuration (not in git)
```

### 2.3 Architecture Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ontos.py (CLI)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ontos/ui/output.py (UI)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ontos/core/context.py (SessionContext)           â”‚
â”‚    ontos/core/frontmatter.py (Parsing)              â”‚
â”‚    ontos/core/staleness.py (Detection)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              File System (git repo)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Functional Core, Imperative Shell:**
- Core functions are PURE (no I/O, no print)
- SessionContext buffers all writes, commits atomically
- UI layer handles all user-facing output

---

## 3. Core Invariants (DO NOT VIOLATE)

### 3.1 Zero-Dependency Rule

```
âš ï¸ CRITICAL: v2.x tools must use Python Standard Library ONLY (3.9+)
             NO pip install. NO third-party libraries.
```

This means:
- âŒ No `yaml` (PyYAML) - use custom parsing/serialization
- âŒ No `ruamel.yaml` - even for comment preservation
- âŒ No `requests` - use `urllib.request`
- âŒ No `click` - use `argparse` or manual parsing
- âœ… Use `json`, `pathlib`, `dataclasses`, `typing`, `re`, etc.

### 3.2 SessionContext Transaction Pattern

```python
# CORRECT: Use SessionContext for all file operations
ctx = SessionContext.from_repo(Path.cwd())
content = ctx.read_file(filepath)        # Reads are direct
ctx.buffer_write(filepath, new_content)  # Writes are buffered
ctx.commit()                             # Atomic commit

# WRONG: Direct file operations
with open(filepath, 'w') as f:           # NO! Bypasses transactions
    f.write(content)
```

### 3.3 Functional Core

```python
# CORRECT: Pure function
def process_frontmatter(fm: dict) -> dict:
    """Pure transformation - no I/O."""
    result = fm.copy()
    result['status'] = 'active'
    return result

# WRONG: Impure function
def process_frontmatter(fm: dict) -> dict:
    print(f"Processing {fm['id']}...")   # NO! I/O in core
    result = fm.copy()
    result['status'] = 'active'
    return result
```

### 3.4 Backward Compatibility

- All 285+ existing tests MUST pass
- Existing documents MUST continue to work
- New features are additive, not breaking
- Schema inference handles legacy documents without `ontos_schema`

---

## 4. Implementation Strategy

### 4.1 PR Order (Dependencies Matter)

```
PR #31: Schema Versioning     â”€â”€â”
                                â”œâ”€â”€ PR #34: install.py Bootstrap
PR #32: Curation Levels      â”€â”€â”˜          â”‚
                                          â”‚
PR #33: Deprecation Warnings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                          â”‚
                              PR #35: Documentation & Release
```

### 4.2 PR #31: Schema Versioning (Start Here)

**Goal:** Add `ontos_schema` field and migration tooling

**New Files:**
```
.ontos/scripts/ontos/core/schema.py       # Schema detection, validation
.ontos/scripts/ontos_migrate_schema.py    # Migration script
.ontos/scripts/tests/test_schema.py       # Tests
```

**Key Functions to Implement:**

```python
# In ontos/core/schema.py

def parse_version(version_str: str) -> Tuple[int, int]:
    """Parse '2.1' to (2, 1). Raise ValueError on invalid input."""

def detect_schema_version(frontmatter: dict) -> str:
    """Detect schema version from frontmatter.
    Priority: explicit ontos_schema > field inference > '1.0'
    """

def check_compatibility(doc_version: str, tool_version: str) -> SchemaCompatibility:
    """Check if tool can read document."""

def serialize_frontmatter(fm: dict) -> str:
    """Serialize dict to YAML-like string using STDLIB ONLY.
    Must handle: strings, lists, booleans, integers, multiline strings.
    """
```

**Schema Specification (from plan Section 3.2):**

| Schema | Required Fields | Optional Fields |
|--------|-----------------|-----------------|
| 1.0 | `id` | `type`, `depends_on` |
| 2.0 | `id`, `type` | `status`, `depends_on`, `concepts` |
| 2.1 | `id`, `type`, `status` | `describes`, `describes_verified` |
| 2.2 | `id`, `type`, `status` | `ontos_schema`, `curation_level` |
| 3.0 | `id`, `type`, `status`, `ontos_schema` | `implements`, `tests`, `deprecates` |

**Inference Rules (for legacy docs only):**
```python
if 'ontos_schema' in fm:
    return fm['ontos_schema']  # Explicit
if 'implements' in fm or 'tests' in fm:
    return '3.0'
if 'describes' in fm:
    return '2.1'
if 'event_type' in fm:
    return '2.0'
return '1.0'
```

### 4.3 PR #32: Curation Levels

**Goal:** Tiered validation (L0 Scaffold â†’ L1 Stub â†’ L2 Full)

**New Files:**
```
.ontos/scripts/ontos/core/curation.py     # Level detection, validation
.ontos/scripts/ontos_scaffold.py          # Generate L0 scaffolds
.ontos/scripts/ontos_promote.py           # Promote L0/L1 â†’ L2
.ontos/scripts/tests/test_curation.py     # Tests
```

**Curation Levels:**

| Level | Name | Required Fields | Validation |
|-------|------|-----------------|------------|
| 0 | Scaffold | `id`, `type` (heuristic) | Minimal |
| 1 | Stub | `id`, `type`, `status`, `goal` | Type valid |
| 2 | Full | `id`, `type`, `status`, `depends_on`, `concepts` | Complete |

**Key Features:**
- `scaffold` command defaults to `--dry-run`, requires `--apply`
- `.ontosignore` file excludes paths from scaffolding
- `promote` command with interactive UX and goalâ†’summary seeding
- Context map shows `[L0]`/`[L1]`/`[L2]` markers
- `--strict` mode excludes L0/L1 from graph, exit code 1

### 4.4 PR #33: Deprecation Warnings

**Goal:** Warn users about v3.0 breaking changes

**Changes to Existing Files:**
```
.ontos/scripts/ontos_lib.py               # Add FutureWarning on import
.ontos/scripts/ontos_end_session.py       # Add CLI notice if direct exec
# (Same pattern for other scripts)
```

**Key Pattern:**
```python
# In ontos_lib.py (top of file)
import warnings
warnings.warn(
    "Importing from 'ontos_lib' is deprecated. "
    "Import from 'ontos.core' instead. "
    "This module will be removed in v3.0.",
    FutureWarning,  # Visible by default (not DeprecationWarning)
    stacklevel=2
)

# In scripts (bottom, in __main__ block)
def emit_deprecation_notice(message: str) -> None:
    print(f"[DEPRECATION] {message}", file=sys.stderr)

if __name__ == '__main__':
    if not os.environ.get('ONTOS_CLI_DISPATCH'):
        if not os.environ.get('ONTOS_NO_DEPRECATION_WARNINGS'):
            emit_deprecation_notice("Use 'python3 ontos.py log' instead.")
```

### 4.5 PR #34: install.py Bootstrap

**Goal:** Single-file installer with SHA256 verification

**New Files:**
```
install.py                                # Root-level installer
checksums.json                            # SHA256 checksums per version
.ontos/scripts/ontos_create_bundle.py     # Bundle creation for releases
```

**Security Requirements:**
- Checksums fetched from tag-aligned URL (not main)
- Bundle includes `manifest.json` for version-aware verification
- Symlink attacks blocked in `extract_bundle()`
- Sentinel file `.install_incomplete` for atomic installs
- `--latest` flag fetches from GitHub API

**Key Functions:**
```python
def fetch_checksums(version: str) -> dict:
    """Fetch from v{version}/checksums.json, not main."""

def verify_checksum(filepath: Path, version: str) -> bool:
    """SHA256 verification with clear error messages."""

def extract_bundle(bundle_path: Path, dest_dir: Path) -> bool:
    """Extract with path traversal AND symlink protection."""

def detect_existing_installation() -> dict:
    """Detect installed version AND incomplete installations."""
```

---

## 5. Testing Requirements

### 5.1 Test Coverage Targets

| Module | Minimum Tests | Focus Areas |
|--------|---------------|-------------|
| schema.py | 10+ | Version parsing, inference, compatibility |
| curation.py | 15+ | Level detection, validation, heuristics |
| install.py | 10+ | Security (path traversal, symlinks, checksums) |

### 5.2 Running Tests

```bash
# Run all tests
cd .ontos/scripts && python3 -m pytest tests/ -v

# Run specific module tests
python3 -m pytest tests/test_schema.py -v

# Run with coverage
python3 -m pytest tests/ --cov=ontos --cov-report=html
```

### 5.3 Test Patterns

```python
# Use tmp_path fixture for file operations
def test_scaffold_creates_frontmatter(tmp_path):
    # Create test file
    doc = tmp_path / "docs" / "test.md"
    doc.parent.mkdir(parents=True)
    doc.write_text("# Test Document\n\nSome content.")

    # Run scaffold
    ctx = SessionContext(tmp_path)
    scaffold = create_scaffold(doc)

    assert scaffold['id'] == 'test'
    assert scaffold['type'] in VALID_TYPES

# Mock external calls
def test_fetch_checksums_handles_network_error(monkeypatch):
    def mock_urlopen(*args, **kwargs):
        raise urllib.error.URLError("Network error")

    monkeypatch.setattr(urllib.request, 'urlopen', mock_urlopen)
    result = fetch_checksums("2.9.0")
    assert result == {}
```

---

## 6. Common Pitfalls (From LLM Review Board)

These issues were caught during 3 rounds of review. Avoid them:

### 6.1 YAML Import (CRITICAL)

```python
# WRONG - violates zero-dependency
import yaml
yaml.dump(frontmatter)

# CORRECT - use stdlib serialization
def serialize_frontmatter(fm: dict) -> str:
    lines = []
    for key, value in fm.items():
        if isinstance(value, list):
            lines.append(f"{key}: [{', '.join(str(v) for v in value)}]")
        else:
            lines.append(f"{key}: {value}")
    return '\n'.join(lines)
```

### 6.2 URL Consistency

```python
# WRONG - checksums from main, installer from tag
CHECKSUMS_URL = f"{GITHUB_RAW}/main/checksums.json"  # Breaks reproducibility!

# CORRECT - all from same tag
checksums_url = f"{GITHUB_RAW}/v{version}/checksums.json"
```

### 6.3 Scaffold Safety

```python
# WRONG - auto-applies changes
parser.add_argument('--dry-run', action='store_true')
# dry_run defaults to False, changes are applied!

# CORRECT - dry-run by default
parser.add_argument('--apply', action='store_true')
dry_run = not args.apply  # Safe by default
```

### 6.4 Type Heuristics

```python
# WRONG - matches "login" as "log"
TYPE_HEURISTICS = {'log': [r'log', r'session']}

# CORRECT - word boundaries
TYPE_HEURISTICS = {'log': [r'\blog\b', r'\bsession\b']}
```

### 6.5 Symlink Attacks

```python
# WRONG - only checks path traversal
for member in tar.getmembers():
    if '..' in member.name:
        return False

# CORRECT - also checks symlinks
for member in tar.getmembers():
    if '..' in member.name or member.name.startswith('/'):
        return False
    if member.issym() or member.islnk():  # Symlink attack!
        return False
```

---

## 7. File Locations Reference

### 7.1 Where to Create New Files

```
# Schema module
.ontos/scripts/ontos/core/schema.py

# Curation module
.ontos/scripts/ontos/core/curation.py

# New scripts
.ontos/scripts/ontos_scaffold.py
.ontos/scripts/ontos_promote.py
.ontos/scripts/ontos_migrate_schema.py
.ontos/scripts/ontos_create_bundle.py

# Tests
.ontos/scripts/tests/test_schema.py
.ontos/scripts/tests/test_curation.py
.ontos/scripts/tests/test_install.py

# Root-level installer
install.py
checksums.json
```

### 7.2 Files to Modify

```
# Add new commands
ontos.py                                  # Add: scaffold, promote, migrate

# Add schema detection to map generation
.ontos/scripts/ontos_generate_context_map.py

# Add deprecation warnings
.ontos/scripts/ontos_lib.py
.ontos/scripts/ontos_end_session.py
# ... other scripts

# Update for curation levels
.ontos/scripts/ontos_maintain.py

# Update defaults
.ontos/scripts/ontos_config_defaults.py   # Add CURRENT_SCHEMA_VERSION
```

---

## 8. Getting Started Checklist

### 8.1 Before Writing Code

- [ ] Read `v2.9_implementation_plan.md` (Sections 1-5 minimum)
- [ ] Read `master_plan.md` (Section 0: Meta-Instructions)
- [ ] Read `.ontos/scripts/ontos/core/context.py` (understand SessionContext)
- [ ] Read `.ontos/scripts/ontos/core/frontmatter.py` (understand parsing)
- [ ] Run existing tests: `cd .ontos/scripts && python3 -m pytest tests/ -v`

### 8.2 PR #31 First Steps

1. Create `.ontos/scripts/ontos/core/schema.py`
2. Implement `parse_version()` with validation
3. Implement `detect_schema_version()` with inference
4. Implement `serialize_frontmatter()` using stdlib only
5. Write tests in `.ontos/scripts/tests/test_schema.py`
6. Run tests, ensure all 285+ existing tests still pass
7. Create `ontos_migrate_schema.py` with `--check`, `--dry-run`, `--apply`
8. Add `migrate` command to `ontos.py`

### 8.3 Commit Guidelines

```bash
# Conventional commits format
git commit -m "feat(schema): add schema detection module

- Implement parse_version with validation
- Implement detect_schema_version with inference
- Add serialize_frontmatter using stdlib only
- 15 new tests, all passing

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## 9. Success Criteria

### 9.1 PR #31 Done When:

- [ ] `ontos/core/schema.py` exists with all functions
- [ ] `ontos_migrate_schema.py` works with `--check`, `--dry-run`, `--apply`
- [ ] `ontos.py migrate` command works
- [ ] 10+ new tests for schema module
- [ ] All 285+ existing tests pass
- [ ] Documents without `ontos_schema` are inferred correctly
- [ ] Documents with future schema (3.0) fail gracefully

### 9.2 Full v2.9 Done When:

- [ ] All 4 features implemented
- [ ] `install.py` downloads and installs correctly
- [ ] Schema migration works for all existing documents
- [ ] Curation levels validated correctly
- [ ] Deprecation warnings visible in CLI
- [ ] 50+ new tests added
- [ ] All existing tests pass
- [ ] Manual updated with v2.9 features

---

## 10. Questions & Escalation

### 10.1 If You Get Stuck

1. Check the implementation plan (Section 10 has detailed code examples)
2. Look at existing code patterns in `ontos/core/`
3. Check the review files in `strategy/proposals/v2.9/` for context

### 10.2 Decisions Already Made

| Question | Decision | Source |
|----------|----------|--------|
| Schema numbering | Independent (2.0, 2.1, 2.2), not Ontos-aligned | Q1 in plan |
| Archive format | tar.gz (stdlib support) | Q3 in plan |
| Warning type | FutureWarning (visible by default) | Codex R1 |
| Scaffold default | Dry-run (require --apply) | Gemini R1 |
| Comment preservation | Deferred to v3.0 (stdlib only in v2.x) | Master Plan |
| PyPI distribution | Deferred to v3.0 | Master Plan |

### 10.3 Out of Scope for v2.9

- Windows-specific instructions
- Cryptographic signing (GPG/minisign)
- Offline/air-gapped installation
- ruamel.yaml for comment preservation
- PyPI distribution

---

## 11. Reference Links

| Document | Location | Purpose |
|----------|----------|---------|
| Implementation Plan | `.ontos-internal/strategy/v2.9/v2.9_implementation_plan.md` | Detailed specs |
| Master Plan | `.ontos-internal/strategy/master_plan.md` | Philosophy, invariants |
| Context Map | `Ontos_Context_Map.md` | Document graph |
| Agent Instructions | `docs/reference/Ontos_Agent_Instructions.md` | How to use Ontos |
| Manual | `docs/reference/Ontos_Manual.md` | User documentation |

---

*Good luck, Antigravity. Build something great.*

*â€” Chief Architect*
