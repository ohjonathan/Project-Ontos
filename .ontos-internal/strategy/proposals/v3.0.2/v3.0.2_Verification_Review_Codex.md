# v3.0.2 Targeted Verification: Adversarial Review (Codex)

**Version:** 1.0  
**Date:** 2026-01-18  
**Role:** Adversarial Reviewer (Verification)  
**Model:** Codex (OpenAI)  
**Phase:** Post-Revision Verification  
**Scope:** Verify B3 fix (sys.path shadowing) actually works

---

## 1. Context

You previously identified a critical issue (B3): the original `sys.path.insert(0, SCRIPTS_DIR)` fix would shadow the `ontos` package with `ontos/_scripts/ontos.py`, causing `ModuleNotFoundError`.

The Chief Architect claims this is fixed in commit `c00165f` using a different approach:

```python
# 1. Remove scripts dir from sys.path[0]
SCRIPTS_DIR = Path(__file__).parent.resolve()
if sys.path and Path(sys.path[0]).resolve() == SCRIPTS_DIR:
    sys.path.pop(0)

# 2. Import ontos package FIRST
from ontos.core.context import SessionContext
from ontos.core.frontmatter import parse_frontmatter
# ...

# 3. Then append scripts dir for local imports
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.append(str(SCRIPTS_DIR))
from ontos_config_defaults import PROJECT_ROOT
```

**Goal:** Verify this fix actually works. Try to break it.

---

## 2. Input Documents

| Document | Purpose |
|----------|---------|
| `v3.0.2-Implementation-Spec-v1.1.md` | Revised spec with new fix |
| `v3.0.2_Chief_Architect_Response.md` | CA's response to B3 finding |
| Commit `c00165f` | The actual fix |

---

## 3. Verification Tasks

### Task 1: Confirm the Shadowing File Exists

**Commands:**
```bash
ls -la ontos/_scripts/ontos*.py
head -20 ontos/_scripts/ontos.py
```

| Check | Result |
|-------|--------|
| `ontos/_scripts/ontos.py` exists | ✅ |
| It could shadow `ontos/` package | ✅ |

---

### Task 2: Verify the Fix is Actually Applied

**Commands:**
```bash
rg -n "sys.path.pop(0)" ontos/_scripts/ontos_scaffold.py ontos/_scripts/ontos_stub.py ontos/_scripts/ontos_promote.py ontos/_scripts/ontos_migrate_schema.py
rg -n "sys.path.append" ontos/_scripts/ontos_scaffold.py ontos/_scripts/ontos_stub.py ontos/_scripts/ontos_promote.py ontos/_scripts/ontos_migrate_schema.py
rg -n "sys.path.insert" ontos/_scripts/ontos_scaffold.py ontos/_scripts/ontos_stub.py ontos/_scripts/ontos_promote.py ontos/_scripts/ontos_migrate_schema.py
```

| File | Has `pop(0)` | Has `append` | Has `insert(0,...)` |
|------|--------------|--------------|---------------------|
| `ontos_scaffold.py` | ✅ | ✅ | ❌ |
| `ontos_stub.py` | ✅ | ✅ | ❌ |
| `ontos_promote.py` | ✅ | ✅ | ❌ |
| `ontos_migrate_schema.py` | ✅ | ✅ | ❌ |

---

### Task 3: Reproduce Your Original Attack (Should FAIL Now)

**OLD (broken) approach:**
```bash
python3 -c "
import sys
from pathlib import Path
SCRIPTS_DIR = Path('ontos/_scripts').resolve()
sys.path.insert(0, str(SCRIPTS_DIR))
try:
    from ontos.core.context import SessionContext
    print('OLD APPROACH: Import succeeded (unexpected)')
except ModuleNotFoundError as e:
    print(f'OLD APPROACH: Import failed as expected - {e}')
"
```

**Result:**
- `OLD APPROACH: Import failed as expected - No module named 'ontos.core'; 'ontos' is not a package`

**NEW (fixed) approach:**
```bash
python3 -c "
import sys
from pathlib import Path
SCRIPTS_DIR = Path('ontos/_scripts').resolve()
if sys.path and Path(sys.path[0]).resolve() == SCRIPTS_DIR:
    sys.path.pop(0)
try:
    from ontos.core.context import SessionContext
    print('NEW APPROACH: ontos.core import succeeded')
except ModuleNotFoundError as e:
    print(f'NEW APPROACH: ontos.core import FAILED - {e}')
    exit(1)
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.append(str(SCRIPTS_DIR))
try:
    from ontos_config_defaults import PROJECT_ROOT
    print('NEW APPROACH: ontos_config_defaults import succeeded')
except ModuleNotFoundError as e:
    print(f'NEW APPROACH: ontos_config_defaults import FAILED - {e}')
"
```

**Result:**
- `NEW APPROACH: ontos.core import succeeded`
- `NEW APPROACH: ontos_config_defaults import succeeded`

| Test | Expected | Actual |
|------|----------|--------|
| OLD approach fails | ModuleNotFoundError | ✅ |
| NEW approach succeeds for `ontos.core` | Success | ✅ |
| NEW approach succeeds for `ontos_config_defaults` | Success | ✅ |

---

### Task 4: Test Actual CLI Commands

**Commands:**
```bash
python3 -m ontos scaffold --help
python3 -m ontos stub --help
python3 -m ontos promote --help
python3 -m ontos migrate --help
```

| Command | Result | Error (if any) |
|---------|--------|----------------|
| `ontos scaffold --help` | ✅ | None |
| `ontos stub --help` | ✅ | None |
| `ontos promote --help` | ✅ | None |
| `ontos migrate --help` | ✅ | None |

---

### Task 5: Edge Case Attacks

#### 5.1: Symlink Attack
```bash
ln -s /Users/jonathanoh/Dev/Project-Ontos/ontos/_scripts /tmp/ontos_scripts_link
python3 -c "
import sys
sys.path.insert(0, '/tmp/ontos_scripts_link')
from pathlib import Path
SCRIPTS_DIR = Path('ontos/_scripts').resolve()
print('Symlink resolves same?', Path('/tmp/ontos_scripts_link').resolve() == SCRIPTS_DIR)
"
rm /tmp/ontos_scripts_link
```
**Result:** `Symlink resolves same? True`

#### 5.2: Double Import Attack
```bash
python3 -c "
import sys
from pathlib import Path
SCRIPTS_DIR = Path('ontos/_scripts').resolve()
if sys.path and Path(sys.path[0]).resolve() == SCRIPTS_DIR:
    sys.path.pop(0)
from ontos.core.context import SessionContext
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.append(str(SCRIPTS_DIR))
count1 = len([p for p in sys.path if '_scripts' in p])
print('After first cycle:', count1, 'scripts entries')
if sys.path and Path(sys.path[0]).resolve() == SCRIPTS_DIR:
    sys.path.pop(0)
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.append(str(SCRIPTS_DIR))
count2 = len([p for p in sys.path if '_scripts' in p])
print('After second cycle:', count2, 'scripts entries')
"
```
**Result:**
- `After first cycle: 1 scripts entries`
- `After second cycle: 1 scripts entries`

#### 5.3: Different Working Directory
```bash
cd /tmp && python3 -m ontos scaffold --help 2>&1 | head -3
cd / && python3 -m ontos scaffold --help 2>&1 | head -3
```
**Result:** Help output displayed in both directories.

| Edge Case | Result | Issue? |
|-----------|--------|--------|
| Symlink resolution | ✅ | No |
| Double import | ✅ | No |
| Different cwd | ✅ | No |

---

### Task 6: Verify Import Order is Correct

**Command:**
```bash
sed -n '1,80p' ontos/_scripts/ontos_scaffold.py
```

**Checks:**
- [x] `sys.path.pop(0)` comes BEFORE any `from ontos.*` imports
- [x] `from ontos.*` imports come BEFORE `sys.path.append()`
- [x] `from ontos_config_defaults` comes AFTER `sys.path.append()`

---

## 4. Issues Found

**Critical (Fix Doesn't Work):**
| # | Issue | Evidence |
|---|-------|----------|
| X-C1 | None | All verification tasks passed |

**High (Fix Works But Has Holes):**
| # | Issue | Attack Vector |
|---|-------|---------------|
| X-H1 | None | No high-severity gaps found in targeted verification |

**Medium (Edge Cases):**
| # | Issue | Recommendation |
|---|-------|----------------|
| X-M1 | None | N/A |

---

## 5. Verdict

**Fix Verification:**
| Check | Status |
|-------|--------|
| Shadowing file exists | ✅ |
| Fix pattern applied to all 4 files | ✅ |
| OLD approach fails (as expected) | ✅ |
| NEW approach succeeds | ✅ |
| CLI commands work | ✅ |
| Edge cases handled | ✅ |

**Overall:** VERIFIED — Fix Works

**Recommendation:** Approve for Release

---

*End of Verification Review*
