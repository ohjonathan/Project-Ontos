# v3.3 Track B Alignment Review

**Date:** 2026-02-11
**Reviewer:** Alignment Reviewer (Track B)
**Target:** `v3.3_Track_B_Implementation_Spec.md`

---

## 1. Alignment Issues

### Concern: Restrictive Bare-ID Boundary Definition (Usability Risk)
**Section 4.3 (Body-Link Parser)** defines the `BOUNDARY` set as `[" ", "	", "
", "[", "]", "(", ")", "`", ","]`.
This set notably excludes standard punctuation marks: `.` (period), `;` (semicolon), `:` (colon), `!` (exclamation), `?` (question).
**Consequence:** A natural language reference like `"See v3_2."` (at end of sentence) or `"Ref: v3_2;"` will **fail to match** and thus will not be renamed or link-checked.
**Context:** This strictly adheres to Binding Decision **B1** ("No substring matches") and prevents false positives like matching `v3_2` inside `v3_2.1` (where `.` acts as a connector). However, the trade-off creates significant false negatives in prose.
**Recommendation:** Confirm this trade-off is intentional. The spec chooses strict safety over prose usability.

### Observation: JSON Schema Precedent
**Section 4.4 and 5.5** define specific JSON envelopes (`status`, `scope`, `exit_code`, `summary`).
**Context:** Track A3 is tasked with harmonizing command output and JSON contracts.
**Note:** Track B is establishing a schema precedent here. Track A3 may need to align with this or request changes later. This is acceptable for B to proceed, but A3 implementers should be aware.

---

## 2. Binding Decision Compliance Matrix

| Decision | Requirement | In Spec? | Correctly Applied? | Notes |
|----------|-------------|---------|-------------------|-------|
| **B1** | Bare-ID strict exact-match, bounded by whitespace/syntax chars. Test vectors. | Yes | Yes | `BOUNDARY` set defined explicitly. Vectors included. |
| **B2** | One parser module, two consumers (link-check/rename). | Yes | Yes | `core/body_refs.py` shared. |
| **B3** | Dry-run body matches: context, zone, match type. | Yes | Yes | Spec 4.3 & 5.5 detail exact output fields. |
| **B4** | `docs` default, `--scope library` opt-in. All commands migrated. | Yes | Yes | Spec 3.1 & 3.2 cover migration matrix comprehensively. |
| **B5** | Detect duplicates via `DocumentLoadResult`. Report/Abort. | Yes | Yes | Spec 5.2 & 5.6 enforce strict duplicate checks. |
| **S1** | Exit codes: 0=clean, 1=broken/dupes, 2=orphans. | Yes | Yes | Spec 4.5 defines exact truth table. |
| **S3** | Targeted frontmatter update. No round-trip. | Yes | Yes | Spec 5.3 details raw patching strategy. |
| **S4** | IO YAML parser canonical. Skip+warn. | Yes | Yes | Spec 4.2 & 5.2 mandate canonical parser. |
| **S5** | Post-rename warning to regenerate artifacts. | Yes | Yes | Spec 5.6 specifies exact warning text. |

---

## 3. Backward Compatibility Assessment

**Behavioral Changes (Intentional per B4):**
The unification of scan scopes introduces intentional breaking changes for commands that previously had implicit broad scopes:
- **`promote`, `schema-migrate`, `export data`, `migration-report`**: Default scope narrows from "docs + .ontos-internal" to just "docs". Users targeting strategy documents (in `.ontos-internal`) must now explicitly add `--scope library`.
- **`query`, `verify`**: Default scope narrows to "docs".
- **`doctor`**: Scans defined by config, not just `docs/*.md`.

**Mitigation:**
The spec preserves the ability to access the old broader scope via the new `--scope library` flag. This satisfies the "system-wide flag" requirement of B4.

**API Stability:**
No removal of public API surface detected. New modules are additive.

---

## 4. Architectural Consistency Assessment

**Layer Boundaries:**
- **Core:** `body_refs.py`, `link_diagnostics.py` correctly placed in `core/` (pure logic).
- **IO:** `scan_scope.py` correctly placed in `io/` (filesystem/config access).
- **Commands:** Thin wrappers around core/io logic.
- **Consistency:** High. Respects the A1-established boundaries.

**Infrastructure Usage:**
- Builds correctly on Track A1's `io/files.py` canonical loader.
- Adopts `DocumentLoadResult` and `duplicate_ids` from A1.
- Uses `SessionContext` for atomic writes.

**Patterns:**
- `rename` follows the `--apply` pattern (idempotent/dry-run default).
- `link-check` follows standard CLI registration.

---

## 5. Verdict

**Approve with Observations**

The specification is rigorously aligned with all Binding Decisions (B1-B5, S1-S5) and the architectural constraints of Track A1. The one significant concern (prose punctuation in bare-ID matching) is a direct consequence of strict adherence to the safety requirements of B1. The backward compatibility breaks are intentional and mandated by B4.

The spec is architecturally sound and ready for implementation.
