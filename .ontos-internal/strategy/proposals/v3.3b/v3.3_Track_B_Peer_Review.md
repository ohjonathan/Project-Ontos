---
id: v3_3_track_b_peer_review
type: review
status: draft
depends_on:
  - v3_3_track_b_implementation_spec
  - v3_3_release_plan
  - v3_3_track_a1_implementation_spec
  - v3_3_track_a1_adversarial_review
  - v3_2_4_prea_consolidation
concepts:
  - v3.3b
  - track-b
  - peer-review
  - implementation-spec
---

# v3.3 Track B Peer Review

## Spec Gaps

### Critical (Blocks Spec Approval)

1. Apply-mode `--json` contract is missing.
Evidence: `--json` is declared as dry-run/apply output in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:612`, but only dry-run JSON is specified in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:743`.
Why this blocks: Gemini Flash 3 must invent apply JSON shape, which creates contract drift in tests and CLI output.
Required fix: Add explicit apply JSON schema, including success/failure envelope and partial-commit warning payload.

2. Parse-failure abort rule for rename is underspecified.
Evidence: `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:637` says abort if skipped files contain a target "discovered by raw scan", but does not define raw-scan semantics.
Why this blocks: Implementer cannot determine if this means substring search, boundary-aware match, markdown-aware scan, or parser reuse.
Required fix: Define exact detection algorithm and matching semantics for parse-failed files.

3. Frontmatter patch precondition conflicts with A1 parser boundary behavior.
Evidence: rename patching assumes frontmatter only when it exists "at file start" in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:651`, while A1 explicitly documents lenient `.lstrip()` frontmatter detection in `.ontos-internal/strategy/proposals/v3.3a/v3.3_Track_A1_Adversarial_Review.md:209`.
Why this blocks: A file can pass semantic checks via canonical parser but fail raw patch extraction rules, causing undefined behavior.
Required fix: Align patcher frontmatter boundary with canonical parser contract, or define strict rejection criteria before planning.

4. Body-link parser still leaves key markdown cases undefined.
Evidence: parser defines zones and basic `[label](target)` extraction in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:347` and `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:419`, but does not specify behavior for nested parentheses in targets, escaped `\)`, optional link titles, reference-style links, or autolinks.
Why this blocks: Different reasonable implementations will produce different matches and rewrite spans.
Required fix: Add explicit supported/unsupported markdown-link grammar and skip behavior.

### Major (Should Fix)

1. Dry-run default and clean-git guard are in tension.
Evidence: command is "Dry-run by default" in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:618`, but pre-validation starts with mandatory clean git state in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:629`.
Risk: Literal implementation blocks dry-run on dirty trees, reducing safety/usability.
Fix: State explicitly whether clean-git check is apply-only or mandatory for both modes.

2. Targeted patcher does not fully define unsupported YAML detection.
Evidence: unsupported structures are listed in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:670`, but detection rules are not specified.
Risk: Inconsistent safe-fail behavior across implementations.
Fix: Define deterministic detection criteria and failure message schema.

3. Parser zone policy omits explicit EOF rule for unclosed code fences.
Evidence: fence open/close rules in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:355` do not explicitly state EOF handling for unclosed fences.
Risk: Implementers may either treat remainder as `code_fence` or fall back to normal text.
Fix: Add explicit rule and test vector.

4. Scope migration intentionally changes defaults for multiple existing commands without a migration section.
Evidence: behavior changes are documented for `query`, `verify`, `promote`, `schema-migrate`, export/report in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:170`.
Risk: Operator confusion and perceived regression despite B4 compliance.
Fix: Add explicit user-facing migration notes and examples for prior behavior restoration.

5. A1 normalization/severity utilities are referenced but not operationalized in rename/link-check flows.
Evidence: utilities are listed in dependencies in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:984`, but call-level usage (for `normalize_reference_list` and concrete severity-map wiring) is not explicitly specified.
Risk: Flash may bypass intended A1 behavior and reintroduce local normalization/policy drift.
Fix: Add explicit call points and required override object shape.

### Minor (Polish)

1. Link-check JSON schema should define `location` as optional/null for frontmatter refs.
Evidence: schema example implies `location` object in each broken ref in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:485`, while field notes say it is omitted for frontmatter refs in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:555`.

2. Bare-ID boundary punctuation rationale is not documented.
Evidence: period is intentionally excluded from boundary set in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:394` but no sentence-end vector is provided.

3. `--quiet` behavior could be more explicit.
Evidence: declared in both commands in `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:238` and `.ontos-internal/strategy/proposals/v3.3b/v3.3_Track_B_Implementation_Spec.md:613`, but exact retained lines are unspecified.

## Settled Decision Compliance Matrix

| Decision | In Spec? | Correctly Applied? | Notes |
|---|---|---|---|
| B1: Bare-ID strict exact-match | Yes | Yes | Explicit boundary model and test vectors are present. |
| B2: Shared body-link parser | Yes | Yes | Single parser module is shared by link-check and rename. |
| B3: Dry-run line-level context | Yes | Yes | Human output includes line-level context and skipped-zone reason. |
| B4: Unified scan scope | Yes | Yes | Shared scope utility and command migration matrix are explicit. |
| B5: Duplicate ID handling | Yes | Yes | link-check reports duplicates; rename aborts on duplicates. |
| S1: Exit codes (0/1/2) | Yes | Yes | Truth table is explicit for link-check. |
| S3: Targeted frontmatter update | Yes | Partial | Mechanism is specified, but parser-boundary mismatch and unsupported-format detection are incomplete. |
| S4: Canonical parser, skip+warn | Yes | Partial | Principle is stated; parse-failure raw-scan rule is underspecified. |
| S5: Post-rename regeneration warning | Yes | Yes | Exact required warning text is present. |

## Developer Readiness Assessment

Not ready for Gemini Flash 3 as-is.
Core architecture and sequencing are strong, but the current spec still has implementation-blocking ambiguity in parser grammar, parse-failure safety policy, and rename output contract. A literal implementer would make design decisions that should be specified by the document.

## Positive Observations

1. The scope migration matrix is broad and concrete, with explicit behavioral-change annotations per command.
2. The spec correctly anchors Track B on A1 infrastructure (`load_documents`, `duplicate_ids`, `build_graph`, `ValidationOrchestrator`, `SessionContext`) instead of creating parallel primitives.
3. `link-check` output design is high quality: clear human section order, structured JSON shape, and explicit exit-code truth table.
4. Rename safety posture is improved over earlier proposals: dry-run default, full in-memory planning before write, targeted frontmatter patching, and post-apply regeneration warning.
5. Test strategy includes both unit corpus and required integration tests, including dry-run/apply verification and negative cases (collision, dirty git, duplicates).

## Verdict

**Request Revision**

The spec is close, but Critical items must be resolved before implementation hand-off.
