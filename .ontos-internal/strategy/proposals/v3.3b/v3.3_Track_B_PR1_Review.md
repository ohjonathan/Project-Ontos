---
id: v3_3_track_b_pr1_review
type: review
status: active
depends_on:
  - v3_3_track_b_implementation_spec_v2
concepts:
  - v3.3b
  - track-b
  - code-review
  - scan-scope
  - pr-review
---

# v3.3 Track B PR1 Review — Unified Scan Scope

**PR:** #68 (`feature/v3.3-track-b-scan-scope`)
**Spec:** `v3.3_Track_B_Implementation_Spec_v2.md` — Section 3
**Developer:** Codex
**Reviewer:** Claude Code (Tier 1 Review Team)
**Date:** 2026-02-11
**Commit:** `7614229`

---

## Verdict: Approve with Changes

No blocking issues. The implementation is architecturally clean, correctly implements the spec's intent, and provides a solid foundation for PR 2 (link-check) and PR 3 (rename). All intentional B4 behavioral narrowings are per-spec. Three non-blocking items should be addressed before merge.

**Recommended changes:**
1. NB-1: Add `ScanScopePlan` dataclass or remove it from spec v2.
2. NB-2: Update spec migration matrix for `agents` — doc count source IS narrowed.
3. NB-3: Add integration test for `doctor --scope library`.

---

## Pass 1: Spec Compliance

### New Module: `ontos/io/scan_scope.py` (105 lines)

| Check | Status | Notes |
|-------|--------|-------|
| Module location (`io/` layer, not `core/` or `commands/`) | PASS | |
| `ScanScope(str, Enum)` with `DOCS`/`LIBRARY` | PASS | Exact match to spec |
| `ScanScopePlan` frozen dataclass | **MISSING** | Spec Section 3.1 defines it; not present. See NB-1. |
| `resolve_scan_scope()` signature | PASS | Three-tier precedence: CLI > config > docs. Invalid values warn + fallback. |
| `build_scope_roots()` signature | PASS | docs: docs_dir + scan_paths. library: + .ontos-internal. Deduplicates via resolved path. |
| `collect_scoped_documents()` signature | PASS | explicit_dirs overrides scope roots. Delegates to `scan_documents()`. |

### Config Addition

`default_scope: str = "docs"` added to `ScanningConfig` in `ontos/core/config.py`. TOML round-trip verified by `test_load_project_config_reads_default_scope`. Default verified by `test_default_config_has_scan_scope_default`. **COMPLIANT.**

### CLI Registration

`_add_scope_argument(parser)` helper at `cli.py:97–104`. Matches spec Section 3.3 exactly:

```python
parser.add_argument(
    "--scope",
    choices=["docs", "library"],
    default=None,
    help="Scan scope: docs (default) or library (includes .ontos-internal)",
)
```

Registered on all 15 migrated commands (12 matrix commands + `tree`, `validate`, `agent-export` aliases). `export claude` and `consolidate` correctly excluded. **COMPLIANT.**

### Migration Matrix Verification

Every row in the spec's Section 3.2 migration matrix was verified by tracing old (main) and new (branch) code paths.

| Command | Old Scan Removed? | Uses Shared Utility? | Default Parity? | `--scope` Works? |
|---------|:-:|:-:|:-:|:-:|
| map | Yes | Yes | **Yes** — identical file set | Yes |
| maintain | Yes | Yes | **Yes** — identical file set | Yes |
| query | Yes | Yes | No — intentional B4 narrowing | Yes |
| verify | Yes | Yes | No — intentional B4 narrowing | Yes |
| scaffold | Yes | Yes | No — intentional B4 narrowing | Yes |
| promote | Yes | Yes | No — intentional B4 narrowing | Yes |
| schema-migrate | Yes | Yes | No — intentional B4 narrowing | Yes |
| agents | Yes | Yes | No — see NOTABLE-1 | Yes |
| export data | Yes (via snapshot) | Yes (via snapshot) | No — intentional B4 narrowing | Yes |
| migration-report | Yes (via snapshot) | Yes (via snapshot) | No — intentional B4 narrowing | Yes |
| migrate | N/A (passes through) | Yes (via children) | Mirrors children | Yes |
| doctor | Yes | Yes | No — see NOTABLE-2 | Yes |

**All "No" parity entries are intentional per B4** except NOTABLE-1 and NOTABLE-2 which have nuances documented below.

### Backward Compatibility (Section 3.4)

- `map` and `maintain` produce identical output with default scope. **Verified.**
- All narrowed commands restore old breadth with `--scope library`. **Verified.**
- No new required flags or arguments. **Verified.**
- `consolidate` is unchanged (correctly excluded from matrix). **Verified.**
- `init` adapted to pass `paths=[project_root]` to preserve root-wide scan. **Verified.**

---

## Pass 2: Regression & Edge Cases

### Behavioral Regression Check

Three commands traced in detail (old vs new code paths):

**1. `map` — No regression**
- Main: `scan_documents([docs_dir] + scan_paths, skip=config.skip + [context_map])`
- Branch: `collect_scoped_documents(docs, base_skip=config.skip + [context_map])`
- Both produce identical root lists and skip lists. Confirmed by `test_map_default_scope_excludes_internal_docs`.

**2. `maintain` — No regression**
- Main: `_scan_dirs = [docs_dir] + scan_paths`; `_scan_docs = scan_documents(_scan_dirs, skip=config.skip + [context_map])`
- Branch: `_scan_dirs = build_scope_roots(docs)`; `_scan_docs = collect_scoped_documents(docs, base_skip=config.skip, extra_skip=[context_map])`
- Identical roots and skip lists. Additionally, scope is threaded through to sub-tasks (regenerate_map, health_check). Confirmed by `test_maintain_scan_docs_default_scope_excludes_internal`.

**3. `query` — Intentional narrowing**
- Main: `scan_docs_for_query(root)` → `scan_documents([root], skip=ontosignore)` — scans from PROJECT ROOT.
- Branch: `scan_docs_for_query(root, scope)` → `collect_scoped_documents(docs, skip=ontosignore)` — scans from DOCS DIR.
- `--dir` option correctly mapped to `explicit_dirs` which bypasses scope.
- Confirmed by `test_query_scope_library_includes_internal`.

### NOTABLE-1: `agents` doc count source narrowed

| Aspect | Old (main) | New (branch) |
|--------|-----------|-------------|
| Scan roots | `docs_dir + logs_dir + .ontos-internal/archive/logs` | `docs_dir + scan_paths` |
| Archive logs | Explicitly included | Excluded from `docs` scope |
| logs_dir outside docs_dir | Included | Excluded |

The spec migration matrix states: "No for AGENTS generation semantics; doc-count source standardized." This understates the change. The doc count in AGENTS.md WILL decrease for projects where:
- `logs_dir` is configured outside `docs_dir`, or
- `.ontos-internal/archive/logs/` contains markdown files

Test evidence: `test_counts_md_files` expected count changed from "2" to "1". `test_counts_archive_logs` now requires `scope="library"`.

**Impact:** Low-to-medium. Default config has `logs_dir = "docs/logs"` (inside docs_dir), so most users are unaffected. But the spec should acknowledge this as a behavioral change.

### NOTABLE-2: `doctor` now applies skip patterns

| Aspect | Old (main) | New (branch) |
|--------|-----------|-------------|
| File discovery | `docs_dir.rglob("*.md")` — raw, no skip patterns | `collect_scoped_documents(scope, base_skip=config.scanning.skip_patterns)` |
| Template files | Included in count | Excluded by `_template.md` pattern |
| Archive files | Included in count | Excluded by `archive/*` pattern |

Checks 4 (`check_docs_directory`) and 6 (`check_validation`) are affected. Doctor will now report fewer files than before if skip patterns match real content. This is more consistent with other commands but changes health check semantics.

**Impact:** Low. The consistency gain is positive. Doctor previously over-counted by including files that every other command excluded.

### Edge Cases

| Edge Case | Handling | Tested? |
|-----------|----------|---------|
| `--scope library` with no `.ontos-internal/` | Silently skipped at `scan_documents` level (`if not dir_path.exists(): continue`) | Yes: `test_collect_scoped_documents_library_mode_missing_internal_is_ok` |
| Empty `docs/` directory | Empty file list returned; commands handle gracefully | Implicitly |
| Custom `docs_path` in config | Respected by `build_scope_roots` | Yes: `test_collect_scoped_documents_respects_docs_path_override` |
| Root deduplication (duplicate scan_paths) | Resolved-path set dedup in `build_scope_roots` | Yes: `test_build_scope_roots_docs_and_scan_paths` |
| Relative `explicit_dirs` | Resolved against `repo_root` in `collect_scoped_documents` | Yes: `test_collect_scoped_documents_explicit_dirs_override_scope` |
| Invalid `--scope` CLI value | Rejected by argparse `choices=["docs", "library"]` | No (argparse standard behavior) |
| Invalid config `default_scope` value | Warning + fallback to docs | Yes: `test_resolve_scan_scope_invalid_falls_back_with_warning` |

### PR 2/PR 3 Foundation Assessment

**Solid foundation.** The scan utility API is clean and sufficient for downstream consumers:

- **link-check** can call `collect_scoped_documents()` → `load_documents()` → `build_graph()` with no adaptation needed.
- **rename** can call with `--scope library` for full-coverage reference rewriting.
- **Cross-scope reference detection** is buildable: call `build_scope_roots(library)` to discover all roots, then compare against docs-scope graph.
- **explicit_dirs** escape hatch available for targeted per-file operations.

---

## Non-Blocking Issues

| ID | Category | Finding | Recommendation |
|----|----------|---------|----------------|
| NB-1 | Spec deviation | `ScanScopePlan` dataclass defined in spec Section 3.1 is not implemented. No function returns or consumes it. | Either add the dataclass (PR 2/3 may want a plan object) or remove from spec v2. |
| NB-2 | Documentation | Spec matrix says "No behavioral change" for `agents`, but doc count source IS narrowed for projects with `logs_dir` outside `docs_dir`. | Update spec matrix row or add migration note to Section 3.5. |
| NB-3 | Behavioral | `doctor` checks 4/6 now apply `config.scanning.skip_patterns` where they previously used raw `rglob("*.md")`. | Document in spec Section 3.2 doctor row. Minor: health check consistency improved. |

---

## Test Coverage Assessment

### Coverage Summary

| Area | Tests | Adequate? |
|------|-------|-----------|
| Scope resolution precedence | 4 unit tests | Yes |
| Root building (docs/library) | 2 unit tests | Yes |
| Document collection (5 modes) | 5 unit tests | Yes |
| CLI flag registration | 15 commands parametrized | Yes |
| Per-command scope behavior | 11 integration tests | **Gap**: doctor |
| map default/library | 2 new tests | Yes |
| maintain default/library | 2 new tests | Yes |
| snapshot default/library | 2 new tests | Yes |
| config default_scope | 2 new tests | Yes |

### Test Gaps

1. **No integration test for `doctor --scope library`** — Unit test for `check_docs_directory("library")` exists, but no subprocess integration test running the full doctor command with `--scope`.
2. **No end-to-end test for config `default_scope = "library"`** — The TOML round-trip is tested, but no test shows a command respecting the config default without the CLI flag.
3. **No test for invalid `--scope` CLI value** — argparse rejects it at parse time (standard behavior), but no explicit test.

**Overall test quality: Strong.** 690 tests passing, 2 skipped, 1 warning. The integration suite is particularly thorough, covering 11 commands with default vs library scope assertions.

---

## Codebase Verification

### Files Created
- `ontos/io/scan_scope.py` (105 lines) — Clean, well-factored module

### Files Modified (implementation)
- `ontos/cli.py` — `_add_scope_argument` + scope plumbing to 15 commands
- `ontos/core/config.py` — `default_scope` field added to `ScanningConfig`
- `ontos/io/snapshot.py` — `scope` parameter added to `create_snapshot()`
- `ontos/commands/agents.py` — Migrated to shared scope
- `ontos/commands/doctor.py` — Migrated checks 4/6 to shared scope
- `ontos/commands/maintain.py` — Migrated `_scan_dirs`/`_scan_docs`
- `ontos/commands/map.py` — Migrated scan roots
- `ontos/commands/query.py` — Migrated scan + --dir to explicit_dirs
- `ontos/commands/verify.py` — Migrated both scan paths
- `ontos/commands/scaffold.py` — Migrated both scan paths
- `ontos/commands/promote.py` — Migrated from hardcoded dirs
- `ontos/commands/migrate.py` — Migrated from hardcoded dirs
- `ontos/commands/migrate_cmd.py` — Scope threading to children
- `ontos/commands/migration_report.py` — Scope threading to snapshot
- `ontos/commands/export_data.py` — Scope threading to snapshot
- `ontos/commands/init.py` — Adapted to preserve root-wide scan

### Files Modified (tests)
- `tests/io/test_scan_scope.py` (112 lines, new)
- `tests/commands/test_scan_scope_integration.py` (266 lines, new)
- `tests/commands/test_map.py` — 2 new tests
- `tests/commands/test_maintain.py` — 2 new tests
- `tests/commands/test_doctor_phase4.py` — 1 new test
- `tests/commands/test_agents.py` — 2 tests modified
- `tests/commands/test_promote_parity.py` — Test fixtures adapted to docs scope
- `tests/commands/test_verify_parity.py` — Test fixtures adapted to docs scope
- `tests/core/test_snapshot.py` — 2 new tests
- `tests/core/test_config_phase3.py` — 1 new test
- `tests/io/test_config_phase3.py` — 1 new test

### Change Volume
- **+4,906 / -378 lines** across 37 files
- ~3,200 lines are documentation (specs, reviews) included in the branch
- ~1,700 lines are implementation + tests — within the spec's estimated ~1.7k-2.4k LOC range

---

## Appendix: Verified Correct Implementations

These areas were specifically attacked and found correctly implemented:

- **Scope resolution precedence** — CLI overrides config overrides default. Invalid config values produce `RuntimeWarning` and fallback to docs. Tested.
- **Root deduplication** — `build_scope_roots` dedupes via `root.resolve()` in a seen set. Preserves unresolved paths in output (correct for relative path display).
- **explicit_dirs bypass** — When provided, scope roots are completely bypassed. Relative dirs resolved against repo_root. Used correctly by query `--dir`, schema-migrate `--dirs`, scaffold `paths`, promote `files`.
- **scan_documents delegation** — `collect_scoped_documents` correctly delegates to the existing `io/files.py:scan_documents` which handles non-existent dirs, glob matching, and sorted output.
- **Scope threading through sub-commands** — `maintain` correctly passes scope to `map` (regenerate_map task) and `doctor` (health_check task).
- **Snapshot scope parameter** — `create_snapshot` correctly accepts optional `scope`, resolves it via `resolve_scan_scope`, and passes through to `collect_scoped_documents`.
- **init root-wide preservation** — `init.py` correctly passes `paths=[project_root]` to `find_untagged_files`, which uses the `paths` code path that bypasses scope and does a root-wide scan.
