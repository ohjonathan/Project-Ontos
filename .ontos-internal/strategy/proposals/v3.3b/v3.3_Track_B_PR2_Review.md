---
id: v3_3_track_b_pr2_review
type: review
status: active
depends_on:
  - v3_3_track_b_implementation_spec_v2
concepts:
  - v3.3b
  - track-b
  - code-review
  - link-check
  - body-parser
  - pr-review
---

# v3.3 Track B PR2 Review — `ontos link-check`

**PR:** #69 (`feature/v3.3-track-b-link-check`)
**Spec:** `v3.3_Track_B_Implementation_Spec_v2.md` — Sections 4, 6
**Developer:** Codex
**Reviewer:** Claude Code (Tier 1 Review Team)
**Date:** 2026-02-11
**Commit:** `b221c9c`

---

## Verdict: Approve

No blocking issues. All three review passes clean. The implementation correctly delivers the zone-aware body parser, shared link diagnostics core, and `ontos link-check` command as specified in Sections 4 and 6. Both critical findings from the adversarial review (CRIT-01: boundary false negatives, CRIT-02: cross-scope false broken links) are verified fixed. PR 3 (rename) foundation is solid with all required metadata present in parser output. Maintain task 7 cleanly integrated via shared diagnostics.

**Recommended changes:**
1. NB-1: Consider adding `--no-suggestions` CLI flag for CI noise reduction.
2. NB-2: Add isolated tests for broken `impacts` and `describes` frontmatter references.
3. NB-3: Add `--scope library` integration test for `link-check`.

---

## Pass 1: Body Parser Verification

### New Module: `ontos/core/body_refs.py` (677 lines)

The shared body-reference parser is the highest-risk new infrastructure in Track B. All subsections verified against spec Section 4.3.

### Zone Segmentation — CORRECT

| Check | Status | Notes |
|-------|--------|-------|
| Code fence basic (``` and ~~~, run >= 3) | PASS | `_detect_fence_opener` handles both marker types |
| Code fence with language info string | PASS | Opener detection ignores info string after marker |
| Nested code fence (inner fences as text) | PASS | Only matching closer type/length closes outer fence |
| Unclosed fence at EOF | PASS | `in_fence` remains True, all remaining lines skipped |
| Inline code backtick run matching | PASS | `_split_inline_code_segments` with run-length matching |
| Double backtick inline code | PASS | Backtick run length matching handles correctly |
| Escaped backticks | PASS | `_is_escaped` detects escaped backticks |
| Unclosed backtick (no speculative skip) | PASS | Remaining text stays in `normal_text` |

Test coverage: `test_nested_fence_content_skipped_until_matching_closer`, `test_unclosed_fence_eof_skips_remainder`, plus 3 additional zone unit tests.

### Two-Tier Boundary Model — CORRECT (CRIT-01 Fix Verified)

Implementation at lines 63–92:

```python
_HARD_BOUNDARY = {" ", "\t", "\n", "[", "]", "(", ")", "`", ","}
_TRAILING_PUNCT_BOUNDARY = {".", ":", ";", "!", "?", "|", "\"", "'", ">"}
```

All spec test vectors from Section 4.3 traced and verified:

| Text | Target | Leading | Trailing | Expected | Result |
|------|--------|---------|----------|----------|--------|
| `see v3_2_4_proposal.` | `v3_2_4_proposal` | space (hard) | `.` (punct) + EOL | Match | **PASS** |
| `v3_2_4_proposal: details` | `v3_2_4_proposal` | None | `:` (punct) + space | Match | **PASS** |
| `\| v3_2_4_proposal \|` | `v3_2_4_proposal` | space (hard) | space (hard) | Match | **PASS** |
| `v3_2_4_proposal; also` | `v3_2_4_proposal` | None | `;` (punct) + space | Match | **PASS** |
| `v3_2_4_proposal?` | `v3_2_4_proposal` | None | `?` (punct) + EOL | Match | **PASS** |
| `v3.0.4_Code_Review_Claude.` | `v3.0.4_Code_Review_Claude` | None | `.` (punct) + EOL | Match | **PASS** |
| `v3.0.4_Code_Review_Claude.pdf` | `v3.0.4_Code_Review_Claude` | None | `.` (punct) + `p` (not boundary) | No match | **PASS** |
| `v3_2` in `v3_2_1_proposal` | `v3_2` | None | `_` (not in any set) | No match | **PASS** |
| `(v3_2_4_proposal)` | `v3_2_4_proposal` | `(` (hard) | `)` (hard) | Match | **PASS** |
| `[v3_2_4_proposal]` | `v3_2_4_proposal` | `[` (hard) | `]` (hard) | Match | **PASS** |
| `> see v3_2_4_proposal` | `v3_2_4_proposal` | space (hard) | EOL | Match | **PASS** |

Test coverage: `test_sentence_punctuation_boundaries_match` (5 variants), `test_period_inside_id_not_treated_as_boundary`, `test_table_and_blockquote_boundaries_match`.

Regex metacharacter safety: `re.escape(target)` at line 618 handles dots and other metacharacters correctly.

### Markdown Link Extraction — CORRECT

| Check | Status | Notes |
|-------|--------|-------|
| `[text](target)` basic form | PASS | Normalized correctly |
| Title stripping (`"title"`, `'title'`) | PASS | `_is_supported_optional_title` handles both quote types |
| Fragment stripping (`target#section`) | PASS | `target.split("#", 1)[0]` at line 606 |
| External URL rejection | PASS | `_SCHEME_RE` rejects `http:`, `https:`, `mailto:`, etc. |
| Relative path normalization | PASS | `/` detected, basename stem extracted |
| Balanced parentheses in target | PASS | `_parse_link_payload` tracks paren depth |
| Escaped close paren | PASS | Backslash-escaped `)` handled correctly |

Test coverage: `test_markdown_link_with_title_matches`, `test_markdown_link_target_external_url_is_ignored`, `test_markdown_link_with_balanced_parentheses_and_escaped_close_paren`.

### Unsupported Markdown Forms — CORRECT

All five unsupported forms are explicitly detected and ignored:

| Form | Detection | Behavior |
|------|-----------|----------|
| Reference-style `[text][ref]` | `_REFERENCE_STYLE_RE` | Marked as unsupported span |
| Reference definitions `[ref]: target` | `_is_reference_definition_line` | Line skipped entirely |
| Wikilinks `[[target]]` | `_WIKILINK_RE` | Marked as unsupported span |
| HTML `<a href="...">` | `_HTML_OR_AUTOLINK_RE` | Marked as unsupported span |
| Autolinks `<http://...>` | `_HTML_OR_AUTOLINK_RE` | Marked as unsupported span |

Test coverage: `test_unsupported_markdown_forms_are_ignored` covers all five forms in a single test.

### PR 3 (Rename) Foundation — ALL REQUIREMENTS MET

| Requirement | Present? | Field/Mechanism |
|-------------|----------|-----------------|
| Exact character positions | Yes | `col_start`, `col_end`, `abs_start`, `abs_end` |
| Raw matched text | Yes | `raw_match` field |
| Match type distinction | Yes | `MatchType.MARKDOWN_LINK_TARGET` vs `BARE_ID_TOKEN` |
| Zone classification | Yes | `ZoneType` enum + `zone` field |
| Individual file scanning | Yes | `scan_body_references(path, body, ...)` |
| Rewritable flag + skip reason | Yes | `rewritable` bool + `skip_reason` string |
| Rename-target focused mode | Yes | `rename_target` parameter |
| Include-skipped for dry-run | Yes | `include_skipped` parameter |
| Frontmatter separation | Yes | Diagnostics validates frontmatter via orchestrator, body via parser |

---

## Pass 2: Spec Compliance

### Module Structure

| Module | Location | Lines | Correct Layer? |
|--------|----------|-------|----------------|
| `ontos/core/body_refs.py` | `core/` | 677 | PASS |
| `ontos/core/link_diagnostics.py` | `core/` | 589 | PASS |
| `ontos/commands/link_check.py` | `commands/` | 220 | PASS |
| CLI registration in `ontos/cli.py` | | | PASS |

### Command Interface (Section 4.1)

| Check | Status | Notes |
|-------|--------|-------|
| `--scope` flag | PASS | Via `_add_scope_argument(p)` |
| `--json` flag | PASS | Via global parent parser |
| `--quiet` flag | PASS | Via global parent parser |
| Help text matches spec | PASS | Summary and scope help per Section 4.1 |

Note: `--no-suggestions` is not a CLI flag. `LinkCheckOptions.suggestions` exists for API use but the spec CLI definition (Section 4.1) only defines `--scope`, `--json`, and `--quiet`. **Per-spec.**

### Reference Detection (Section 4.2)

| Source | Infrastructure Used | Status |
|--------|-------------------|--------|
| Frontmatter `depends_on` | `build_graph()` with `_LINK_CHECK_SEVERITY` | PASS |
| Frontmatter `impacts` | `orchestrator.validate_impacts(severity="error")` | PASS |
| Frontmatter `describes` | `orchestrator.validate_describes(severity="error")` | PASS |
| Body markdown links | `scan_body_references()` → `MatchType.MARKDOWN_LINK_TARGET` | PASS |
| Body bare tokens | `scan_body_references()` → `MatchType.BARE_ID_TOKEN` | PASS |

Selective validation constraint verified: `link-check` does NOT call `validate_all()` or `validate_concepts()`. Severity map wired explicitly as `_LINK_CHECK_SEVERITY` with all `"error"` values. **COMPLIANT.**

### Cross-Scope Resolution (Section 4.2C, CRIT-02 Fix Verified)

| Check | Status | Notes |
|-------|--------|-------|
| `--scope docs`: secondary `.ontos-internal/` scan | PASS | `_load_external_scope_info` scans library-scope root |
| External references classified as `ExternalReference` | PASS | `_classify_reference` checks `external_ids` |
| External references do NOT trigger exit 1 | PASS | `_resolve_exit_code` ignores externals |
| `--scope library`: empty external set | PASS | No external references in library mode |
| Orphan filtering by `external_depends_on_index` | PASS | Lines 366–371 in `link_diagnostics.py` |
| JSON output `external_references` section | PASS | Present in `to_json()` schema |

Test coverage: `test_cross_scope_reference_is_external_not_broken` (unit + integration).

### Output Format (Section 4.4)

Human-readable section order verified against spec:

1. Scope + file census (scope, roots, file count, parse warnings)
2. Summary (duplicates, broken, external, parse-failed, orphans, exit code)
3. Duplicate IDs (each with full path list)
4. Broken references by source field
5. External references (docs scope only)
6. Parse-failed candidate references
7. Suggestions (with confidence scores)
8. Orphans (capped at 20 + "and N more")
9. Parse/load warnings
10. Status line

JSON schema verified: all fields present with correct types. `location` is `null` for frontmatter refs and populated for body refs. External references and parse-failed candidates sections included. **COMPLIANT.**

### Exit Code Logic (Section 4.5)

All decision table entries verified via `_resolve_exit_code`:

| Duplicates | Broken | External only | Orphans | Expected Exit | Tested? |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 0 | 0 | 0 | 0 | 0 | Yes |
| 1+ | any | any | any | 1 | Yes |
| 0 | 1+ | any | any | 1 | Yes |
| 0 | 0 | 1+ | 0 | 0 | Yes |
| 0 | 0 | any | 1+ | 2 | Yes |

Parse-failed candidates do not affect exit code. **COMPLIANT.**

### Maintain Task 7 Integration (Section 4.6)

| Check | Status | Notes |
|-------|--------|-------|
| Uses `run_link_diagnostics` (shared core) | PASS | No duplicate diagnostic logic |
| `include_body=False` | PASS | Maintain does not scan body |
| `include_external_scope_resolution=True` | PASS | Cross-scope resolution enabled |
| `include_suggestions=True` | PASS | Suggestion engine active |
| Passes `load_result` to avoid double-loading | PASS | Reuses existing load |
| Old custom code fully replaced | PASS | No residual maintain-specific graph/link logic |

Test coverage: `test_check_links_task_uses_shared_link_diagnostics` verifies `include_body=False` and `include_external_scope_resolution=True`. `test_check_links_task_reports_broken_dependencies` verifies exit behavior.

### Absorbed Audit Items (Section 6)

| Audit Item | Resolution | Verified? |
|-----------|-----------|:-:|
| #38 (CC-07): Nine different scan scopes | Unified scan via PR 1 + link-check consuming shared scope | PASS |
| #11 (C-9): Maintain link check drift | Maintain routing through shared `run_link_diagnostics` | PASS |

---

## Pass 3: Integration & Foundation

### Pipeline Trace — CORRECT

Complete execution path traced through 15 steps:

1. `link_check_command` entry point
2. `find_project_root()` — locates `.ontos.toml`
3. `load_project_config()` — loads config
4. `resolve_scan_scope()` — CLI > config > default precedence
5. `build_scope_roots()` — computes scan directories
6. `collect_scoped_documents()` — discovers markdown files
7. `run_link_diagnostics(include_body=True, include_external_scope_resolution=True)`
8. Inside diagnostics: `load_documents()` then `build_graph()` with severity map
9. `ValidationOrchestrator.validate_impacts` + `validate_describes` — selective validation
10. Body scan via `scan_body_references()` for each document
11. External IDs scanned (secondary scan of `.ontos-internal/` when scope is docs)
12. Classification via `_classify_reference()` — external vs broken
13. Orphan detection + `external_depends_on` filtering
14. Parse-failed candidate collection (raw scan of unparseable files)
15. Exit code resolution + output rendering (human or JSON)

Each step uses correct A1/PR1 infrastructure. No gaps in pipeline. No ad-hoc scan roots or custom loading.

---

## Non-Blocking Issues

| ID | Category | Finding | Recommendation |
|----|----------|---------|----------------|
| NB-1 | Convenience | `--no-suggestions` CLI flag not registered. `LinkCheckOptions.suggestions` exists for API use but is not exposed. Spec does not mandate it. | Add `p.add_argument("--no-suggestions", ...)` for CI noise reduction. Low priority. |
| NB-2 | Test gap | No isolated test for broken `impacts` or `describes` frontmatter refs. Infrastructure is correct but the specific field routing through `ValidationOrchestrator` to `_classify_reference` is untested end-to-end. | Add test with `impacts: [nonexistent_id]` and `describes: [nonexistent_id]`. |
| NB-3 | Test gap | No integration test for `ontos link-check --scope library` (only cross-scope DOCS test exists). | Add test running `link-check --scope library` confirming `.ontos-internal/` docs included. |

---

## Test Coverage Assessment

### Coverage Summary

| Area | Tests | Adequate? |
|------|-------|-----------|
| Body zones (fence/inline/normal) | 5 unit tests | Yes |
| Two-tier boundary model | 4 unit tests (all vectors) | Yes |
| Markdown link extraction | 4 unit tests | Yes |
| False positive prevention | 1 test (5 unsupported forms) | Yes |
| Nested/unclosed fences | 2 unit tests | Yes |
| Link diagnostics aggregation | 7 unit tests | Yes |
| Cross-scope resolution | 2 tests (unit + integration) | Yes |
| Exit code truth table | 4 integration tests | Yes |
| JSON output schema | 1 integration test | Yes |
| `--quiet` behavior | 1 integration test | Yes |
| Maintain task 7 integration | 2 tests (contract + behavior) | Yes |
| Config `default_scope` | 1 integration test | Yes |
| Rename-target mode (PR 3 prep) | 1 unit test | Adequate |

### Test Gaps

1. **No isolated test for broken `impacts` frontmatter reference** — infrastructure correct but end-to-end field routing untested.
2. **No isolated test for broken `describes` frontmatter reference** — same.
3. **No integration test for `ontos link-check --scope library`** — only cross-scope DOCS test exists.
4. **No test for parse-failed candidates via CLI** — only core-level test exists.

**Overall test quality: Strong.** 731 tests passing, 2 skipped. The body parser tests are thorough, covering all spec test vectors. Integration tests cover the full exit code truth table and cross-scope resolution.

---

## Codebase Verification

### Files Created

- `ontos/core/body_refs.py` (677 lines) — Zone-aware body-reference parser
- `ontos/core/link_diagnostics.py` (589 lines) — Shared link diagnostics orchestrator
- `ontos/commands/link_check.py` (220 lines) — CLI command module
- `tests/core/test_body_refs.py` (133 lines, new)
- `tests/core/test_link_diagnostics.py` (165 lines, new)
- `tests/commands/test_link_check.py` (171 lines, new)

### Files Modified (implementation)

- `ontos/cli.py` — `link-check` subparser registration + handler
- `ontos/commands/maintain.py` — Task 7 refactored to `run_link_diagnostics`

### Files Modified (tests)

- `tests/commands/test_maintain.py` — 2 tests added/updated for shared diagnostics
- `tests/commands/test_scan_scope_integration.py` — `link-check` added to parametrized help test
- `tests/test_cli.py` — `link-check` added to command lists
- `tests/test_cli_phase4.py` — New `test_link_check_help()` test

### Change Volume

- **+2,080 / -42 lines** across 12 files
- ~1,486 lines implementation + tests
- Within spec estimate range

---

## Appendix: Verified Correct Implementations

These areas were specifically attacked and found correctly implemented:

- **Zone segmentation state machine** — Fence opener/closer matching by marker type and run length. Nested fences treated as content. EOF rule correctly marks remainder as code_fence. Inline code uses backtick run length matching with escaped-backtick awareness.
- **Two-tier boundary model** — Hard boundaries (whitespace, brackets, parens, backtick, comma) provide immediate match. Trailing punctuation boundaries (period, colon, semicolon, etc.) require lookahead to next character for match confirmation. All 11 spec test vectors verified by hand-tracing.
- **Regex metacharacter safety** — `re.escape(target)` prevents dot-containing IDs (e.g., `v3.0.4_Code_Review_Claude`) from acting as wildcard patterns.
- **Markdown link parsing** — Balanced parenthesis tracking, escaped close-paren handling, title stripping (double + single quotes), fragment removal, external URL rejection via scheme detection, relative path normalization to basename stem.
- **Cross-scope resolution** — Secondary `.ontos-internal/` scan produces `external_ids` and `external_depends_on_index`. External references classified as info-only and excluded from exit code. Orphan set reduced by external inbound dependencies.
- **Selective validation** — Only `validate_impacts` and `validate_describes` called with explicit severity. `validate_all()` and `validate_concepts()` correctly avoided per VUL-06 caveat.
- **Maintain task 7 integration** — Old custom link-checking logic fully replaced by `run_link_diagnostics(include_body=False)`. No duplicate code paths remain. `load_result` passed through to avoid double-loading.
- **Parse-failed candidate handling** — Raw scan of parse-failed files with `known_ids` filter (active + external). Candidates are informational only, do not affect exit code, and are deduped by `(path, line, match_type, candidate)` tuple.
