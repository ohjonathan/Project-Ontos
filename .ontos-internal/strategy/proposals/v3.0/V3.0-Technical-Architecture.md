# Ontos v3.0 Technical Architecture

**Version:** 1.2
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-12
**Status:** Reviewed — Ready for Implementation Planning

**Change History:**
| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-11 | Initial draft |
| 1.1 | 2026-01-12 | Added Section 2 "Distribution Model" |
| 1.2 | 2026-01-12 | Incorporated peer review feedback (4 reviewers) |

---

## Executive Summary

This document defines the technical architecture for Ontos v3.0, the "Distribution & Polish" release. Ontos transforms from repo-injected scripts (~8,685 lines across 22 scripts) into a properly distributed Python package (`pip install ontos`). The architecture preserves the functional core/imperative shell pattern already established in `ontos/core/`, extends it to encompass all commands, and prepares extension points for v4.0 features (MCP, daemon, export templates).

**Key Architectural Decisions:**
- Global CLI + local data (git-like model)
- Zero-dependency core (stdlib only)
- Markdown primary output, JSON optional (`--json` flag)
- Declarative `.ontos.toml` configuration
- Shim hooks delegating to global CLI
- ValidationOrchestrator pattern for unified error handling

---

## Review Status

This architecture was reviewed by 4 peer architects (Codex, Claude, Gemini Architectural, Gemini DeepThink). All 4 approved with changes. Key updates from review:

- Added missing module specifications (`core/suggestions.py`, `core/tokens.py`, I/O interfaces)
- Fixed Windows hook incompatibility (Python-based shim replaces shell shim)
- Marked I/O-containing core modules as REFACTOR (not EXISTS)
- Added Q4 confirmation step and Q5 version pinning per strategy decisions
- Added Golden Master testing phase to migration strategy
- Clarified config loading via Inversion of Control pattern

For full review deliberation, see:
- `CONSOLIDATED_Review.md` — Merged peer feedback
- `Chief_Architect_Response.md` — Architect's response and change log

---

## 1. Architecture Overview

### 1.1 System Boundaries

**What Ontos IS:**
- A local-first documentation management system
- A context map generator for AI agents and humans
- A session logging and curation workflow tool
- A git hook integration for documentation discipline

**What Ontos is NOT:**
- A cloud service or SaaS product
- A real-time collaboration tool
- A database or document storage system
- An AI agent itself (it serves agents, doesn't act as one)

### 1.2 User Personas

| Persona | Interaction Mode | Primary Commands |
|---------|------------------|------------------|
| **Human Developer** | CLI, reads Markdown files | `ontos log`, `ontos map`, `ontos doctor` |
| **Human Reader** | Reads `Ontos_Context_Map.md` directly | N/A (passive consumption) |
| **AI Agent** | Reads Markdown files in context | N/A (passive consumption) |
| **CI/CD Pipeline** | CLI with `--json` flag | `ontos map --json`, exit codes |
| **Future MCP Client** | MCP protocol (v4.0) | MCP tools/resources |

### 1.3 Core Architectural Principles

1. **Zero-Dep Core**: Core logic uses only Python stdlib (3.9+). No external dependencies.
2. **Local-First**: All operations work offline. No network calls in core operations.
3. **Functional Core / Imperative Shell**: Core modules (`core/`) are stdlib-only, deterministic, and perform no external I/O. They receive data as arguments and return results. All I/O (file reads, git subprocess calls, user interaction) happens in `commands/`, `ui/`, and `io/` layers. `SessionContext` manages write *intents* in core; actual writes execute via `commit()` in the I/O layer.
4. **Transactional Writes**: All file modifications go through `SessionContext` for atomicity.
5. **Progressive Disclosure**: Simple defaults, advanced options discoverable.
6. **Readable, Not Retrievable**: Markdown primary; optimized for human/agent reading.

### 1.4 Layered Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      CLI Entry Point                             │
│  ontos/__main__.py → cli.py                                     │
│  • Argument parsing (argparse)                                   │
│  • Command dispatch                                              │
│  • Global flags (--json, --quiet, --version)                    │
│  • Config loading (via io/toml.py)                              │
├─────────────────────────────────────────────────────────────────┤
│                      Command Layer                               │
│  ontos/commands/{map,log,init,doctor,...}.py                    │
│  • Orchestrates core + I/O                                       │
│  • Handles SessionContext lifecycle                              │
│  • Manages OutputHandler                                         │
├─────────────────────────────────────────────────────────────────┤
│                      Core Logic Layer                            │
│  ontos/core/{context,frontmatter,staleness,schema,...}.py       │
│  • Stdlib-only, deterministic functions                          │
│  • Validation logic                                              │
│  • Graph operations                                              │
│  • Data transformations                                          │
├─────────────────────────────────────────────────────────────────┤
│                      I/O Layer                                   │
│  ontos/ui/output.py, ontos/io/{git,files,toml}.py               │
│  • OutputHandler (formatting, emoji, colors)                     │
│  • File system operations                                        │
│  • Git subprocess calls                                          │
│  • SessionContext.commit() execution                             │
└─────────────────────────────────────────────────────────────────┘
```

**Dependency Rules:**
- CLI Layer → Command Layer → Core Layer → (nothing)
- CLI Layer → I/O Layer (for output, config loading)
- Command Layer → I/O Layer (for git, files)
- Core Layer MUST NOT import from Command, CLI, or I/O layers

---

## 2. Distribution Model: Global CLI + Local Data

This section defines the **core architectural decision** of v3.0. Everything else in this document flows from this model.

### 2.1 The Defining v3.0 Decision

v3.0's defining architectural choice is the **"Global CLI + Local Data"** model, directly inspired by Git's distribution pattern. Ontos transforms from repo-injected scripts to a globally-installed package while preserving per-repository documentation ownership.

**The Git Analogy:**

Just as `git` is installed once globally but each repository maintains its own `.git/` directory with commits, branches, and history, Ontos follows the same pattern:

| Git | Ontos |
|-----|-------|
| `git` binary (global) | `ontos` CLI (global via pip) |
| `.git/` directory (per-repo) | `.ontos.toml` + docs (per-repo) |
| Repo history travels with clone | Documentation travels with clone |

### 2.2 Why This Model?

**Design Rationale:**

1. **Portability**: Clone a repo → documentation travels with it. No tool installation required to *read* docs.
2. **Single Source of Truth**: One CLI version across all projects eliminates version drift.
3. **Separation of Concerns**: Tool logic (global, maintained by Ontos) vs. project knowledge (local, owned by project).
4. **Offline-First**: Documentation readable without any tooling installed—just Markdown files.
5. **Update Simplicity**: `pip install --upgrade ontos` updates all projects instantly.

**What This Model Rejects:**

- ❌ Scripts copied into each repo (v2.x pattern)
- ❌ Cloud-based documentation storage
- ❌ Tool-specific formats requiring Ontos to read
- ❌ Per-repo tool versioning/configuration complexity

### 2.3 What Lives Where

```
┌─────────────────────────────────────────────────────────────────┐
│                     GLOBAL (pip install ontos)                   │
│  ~/.local/lib/python3.x/site-packages/ontos/                    │
│  ├── cli.py           # Command dispatch                        │
│  ├── core/            # Pure validation logic                   │
│  ├── commands/        # Command implementations                 │
│  ├── ui/              # Output formatting                       │
│  └── io/              # File/git operations                     │
│                                                                  │
│  Managed by: pip install ontos                                  │
│  Updated by: pip install --upgrade ontos                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                    delegates to global CLI
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     PER-REPOSITORY (local data)                  │
│  my-project/                                                     │
│  ├── .ontos.toml              # Configuration (declarative)     │
│  ├── Ontos_Context_Map.md     # Generated context map           │
│  ├── .git/hooks/              # Shim hooks → global CLI         │
│  │   ├── pre-push             # Python shim, delegates to ontos │
│  │   └── pre-commit           # Python shim, delegates to ontos │
│  └── docs/                    # (or .ontos-internal/)           │
│      ├── logs/                # Session logs                    │
│      ├── kernel/              # Kernel documents                │
│      ├── strategy/            # Strategy documents              │
│      └── ...                  # Project documentation           │
│                                                                  │
│  Managed by: ontos init, ontos map, ontos log                   │
│  Owned by: The project repository                               │
└─────────────────────────────────────────────────────────────────┘
```

**Explicit Ownership Table:**

| Component | Location | Owner | Format |
|-----------|----------|-------|--------|
| CLI binary | Global (pip) | Ontos maintainers | Python package |
| Core logic | Global (pip) | Ontos maintainers | Python modules |
| Configuration | Repo: `.ontos.toml` | Project | TOML (declarative) |
| Context map | Repo: `Ontos_Context_Map.md` | Project (generated) | Markdown |
| Session logs | Repo: `docs/logs/` | Project | Markdown |
| Documentation | Repo: `docs/` | Project | Markdown |
| Git hooks | Repo: `.git/hooks/` | Project (generated) | Python shims |

### 2.4 How v3.0 Differs from v2.x

| Aspect | v2.x (Current) | v3.0 (Target) |
|--------|----------------|---------------|
| **Installation** | Copy `.ontos/scripts/` into each repo | `pip install ontos` once globally |
| **CLI Entry** | `python3 .ontos/scripts/ontos.py` | `ontos` (in PATH) |
| **Updates** | Manual copy to each repo | `pip install --upgrade ontos` |
| **Hook Scripts** | Full Python scripts in `.git/hooks/` | Python shims delegating to global CLI |
| **Configuration** | `ontos_config.py` (executable Python) | `.ontos.toml` (declarative TOML) |
| **Script Count per Repo** | 22 scripts (~8,685 lines) | 0 scripts (config + data only) |
| **Version Control** | Scripts versioned with repo | Tool version independent of repo |

**Visual Migration:**

```
v2.x repo:                              v3.0 repo:
├── .ontos/                             ├── .ontos.toml (10 lines)
│   └── scripts/                        ├── Ontos_Context_Map.md
│       ├── ontos.py                    └── docs/
│       ├── ontos_end_session.py            └── (unchanged)
│       ├── ontos_generate_context_map.py
│       ├── ontos_lib.py
│       ├── ontos/
│       │   ├── core/
│       │   └── ui/
│       └── ... (22 scripts total)
└── docs/
    └── (unchanged)

Removed: ~8,685 lines of scripts per repo
Added: ~10 lines of .ontos.toml
```

### 2.5 Benefits Summary

| Benefit | v2.x Pain Point | v3.0 Solution |
|---------|-----------------|---------------|
| **No Script Duplication** | 8,685 lines copied to each repo | Scripts live in pip package |
| **Easier Updates** | Manual copy to N repos | Single `pip upgrade` |
| **Repo Stays Clean** | 22 scripts polluting repo | Only config + output files |
| **Version Consistency** | Different Ontos versions per repo | All projects use same version |
| **Simpler Onboarding** | "Copy these scripts to your repo" | `pip install ontos && ontos init` |
| **CI/CD Simplicity** | Maintain scripts in each repo's CI | `pip install ontos` in pipeline |
| **Documentation Portability** | Docs readable without scripts | Docs readable without any tooling |

### 2.6 Design Constraints from This Model

This distribution model imposes specific constraints on all other v3.0 architecture decisions:

1. **No Repo-Specific Code in Global CLI**: The global CLI cannot contain repo-specific logic or hardcoded paths.

2. **Configuration Must Be Declarative**: `.ontos.toml` is data, not executable code. No Python config files.

3. **Shim Hooks Must Be Minimal**: Hooks contain only delegation logic. All real logic lives in global CLI.

4. **Graceful Degradation Required**: If `ontos` is not in PATH, hooks must warn but not block git operations.

5. **Backward Read Compatibility**: v3.0 CLI must read v2.x documentation without requiring migration.

6. **No Network Calls**: Global CLI operates entirely offline. No phone-home, no remote config.

7. **Repo Root Detection**: CLI must reliably detect repo root from any subdirectory (like `git`).

8. **Working Directory Independence**: Commands must work correctly when invoked from any subdirectory within a repository. The CLI detects repo root by walking up from CWD to find `.git/` or `.ontos.toml`.

---

## 3. Package Structure

### 3.1 Target Structure for `pip install ontos`

```
ontos/
├── __init__.py              # Package metadata, version
├── __main__.py              # Entry: `python -m ontos`
├── cli.py                   # Argument parsing, command dispatch
├── version.py               # __version__, schema versions
│
├── core/                    # Pure logic (STDLIB ONLY)
│   ├── __init__.py          # Public API exports
│   ├── context.py           # SessionContext (EXISTS - 272 lines)
│   ├── frontmatter.py       # YAML parsing (EXISTS)
│   ├── staleness.py         # Describes validation (REFACTOR - 353 lines)
│   ├── schema.py            # Schema versioning (EXISTS - 421 lines)
│   ├── curation.py          # Curation levels (EXISTS - 489 lines)
│   ├── history.py           # Decision history (REFACTOR)
│   ├── paths.py             # Path resolution (EXISTS)
│   ├── config.py            # Config defaults (EXISTS)
│   ├── proposals.py         # Proposal helpers (REFACTOR)
│   ├── graph.py             # Dependency graph (NEW)
│   ├── validation.py        # ValidationOrchestrator (NEW)
│   ├── types.py             # Type definitions, enums (NEW)
│   ├── suggestions.py       # Impact/concept suggestions (NEW)
│   └── tokens.py            # Token estimation (NEW)
│
├── commands/                # Command implementations (NEW)
│   ├── __init__.py
│   ├── init.py              # `ontos init`
│   ├── map.py               # `ontos map` (from ontos_generate_context_map.py)
│   ├── log.py               # `ontos log` (from ontos_end_session.py)
│   ├── doctor.py            # `ontos doctor` (NEW)
│   ├── verify.py            # `ontos verify`
│   ├── query.py             # `ontos query`
│   ├── migrate.py           # `ontos migrate`
│   ├── consolidate.py       # `ontos consolidate`
│   ├── promote.py           # `ontos promote`
│   ├── scaffold.py          # `ontos scaffold`
│   ├── stub.py              # `ontos stub`
│   └── hook.py              # `ontos hook pre-push|pre-commit`
│
├── ui/                      # Output formatting
│   ├── __init__.py
│   ├── output.py            # OutputHandler (EXISTS - 109 lines)
│   ├── json_output.py       # JSON formatting (NEW)
│   └── progress.py          # Progress indicators (NEW)
│
├── io/                      # External system interactions (NEW)
│   ├── __init__.py
│   ├── git.py               # Git subprocess calls
│   ├── files.py             # File system operations
│   └── toml.py              # .ontos.toml parsing
│
└── mcp/                     # Optional MCP layer (v3.x/v4)
    ├── __init__.py          # Stub for now
    └── server.py            # MCP server (DEFERRED to v4.0)
```

### 3.2 Directory Specifications

#### `ontos/core/` — Pure Logic Layer

**Purpose:** Contains all business logic as pure functions. Stdlib-only, deterministic, no external I/O. Functions receive data as arguments and return results.

**Dependencies:** Python stdlib only. MUST NOT import from `commands/`, `ui/`, `io/`, or `mcp/`.

**Key Modules:**
| Module | Status | Lines | Description |
|--------|--------|-------|-------------|
| `context.py` | EXISTS | 272 | SessionContext with transactional write intents |
| `frontmatter.py` | EXISTS | ~100 | YAML frontmatter parsing and normalization |
| `staleness.py` | **REFACTOR** | 353 | Describes validation, staleness detection. *Requires I/O extraction: git subprocess calls must move to `io/git.py`.* |
| `schema.py` | EXISTS | 421 | Schema version detection and compatibility |
| `curation.py` | EXISTS | 489 | Three-tier curation level validation |
| `history.py` | **REFACTOR** | ~220 | Decision history generation. *Requires I/O extraction: git log calls must move to `io/git.py`.* |
| `paths.py` | EXISTS | ~300 | Path resolution and directory helpers |
| `config.py` | EXISTS | ~70 | Configuration defaults only (not loading) |
| `proposals.py` | **REFACTOR** | ~150 | Proposal detection and graduation. *Requires I/O extraction: file reads must move to `io/files.py`.* |
| `graph.py` | **NEW** | ~200 | Dependency graph building and validation |
| `validation.py` | **NEW** | ~300 | ValidationOrchestrator, unified error handling |
| `types.py` | **NEW** | ~150 | Enums, dataclasses, type definitions |
| `suggestions.py` | **NEW** | ~200 | Impact and concept suggestion logic |
| `tokens.py` | **NEW** | ~50 | Token estimation for context maps |

**REFACTOR Note:** Modules marked REFACTOR currently contain I/O operations (git subprocess calls, direct file reads) that violate the "no external I/O in core" principle. During v3.0 implementation, these will be purified: I/O operations extracted to `io/` modules, and core functions refactored to accept data as arguments.

#### `ontos/commands/` — Command Layer

**Purpose:** Implements CLI commands. Orchestrates core logic and I/O. Manages SessionContext lifecycle.

**Dependencies:** May import from `core/`, `ui/`, `io/`. MUST NOT import from `mcp/` (optional layer).

**Key Modules:**
| Module | Source | Est. Lines | Description |
|--------|--------|------------|-------------|
| `map.py` | `ontos_generate_context_map.py` | ~300 | Context map generation (decomposed) |
| `log.py` | `ontos_end_session.py` | ~500 | Session log creation (decomposed) |
| `init.py` | NEW | ~200 | Repository initialization, hook setup |
| `doctor.py` | NEW | ~150 | Health check and diagnostics |
| `hook.py` | NEW | ~100 | Git hook dispatcher |

#### `ontos/ui/` — Output Formatting

**Purpose:** All output formatting, emoji, colors, JSON mode. The ONLY layer that knows about display format.

**Dependencies:** May import from `core/` for data types. MUST NOT perform I/O except `print()`.

#### `ontos/io/` — External System Interactions

**Purpose:** All file system and subprocess operations. Isolates I/O for testability.

**Dependencies:** May import from `core/` for types. MUST NOT import from `commands/`.

---

## 4. Module Specifications

### 4.1 New Modules

#### `core/graph.py`

**Purpose:** Builds and validates dependency graphs. Extracted from `ontos_generate_context_map.py` (lines 428-560).

**Public Interface:**
```python
@dataclass
class DependencyGraph:
    nodes: Dict[str, GraphNode]
    edges: Dict[str, List[str]]  # id -> depends_on
    reverse_edges: Dict[str, List[str]]  # id -> depended_by

def build_graph(docs: Dict[str, DocumentData]) -> DependencyGraph
def detect_cycles(graph: DependencyGraph) -> List[List[str]]
def detect_orphans(graph: DependencyGraph, allowed_types: Set[str]) -> List[str]
def calculate_depths(graph: DependencyGraph) -> Dict[str, int]
def validate_type_hierarchy(graph: DependencyGraph, hierarchy: Dict) -> List[str]
```

**Internal Dependencies:** `core/types.py`

**External Dependencies:** None (stdlib only)

**Constraints:**
- All functions must be pure (no I/O)
- Cycle detection must use O(V+E) DFS with `visited` and `in_stack` sets. Do NOT use `path.index()` pattern (O(N²)).

---

#### `core/validation.py`

**Purpose:** Unified validation orchestration. Replaces hard-exit pattern with error collection.

**Public Interface:**
```python
class ValidationErrorType(Enum):
    BROKEN_LINK = "broken_link"
    CYCLE = "cycle"
    ORPHAN = "orphan"
    ARCHITECTURE = "architecture"
    SCHEMA = "schema"
    STATUS = "status"
    STALENESS = "staleness"
    CURATION = "curation"

@dataclass
class ValidationError:
    error_type: ValidationErrorType
    doc_id: str
    filepath: str
    message: str
    fix_suggestion: str
    severity: Literal['error', 'warning', 'info']

@dataclass
class ValidationResult:
    errors: List[ValidationError]
    warnings: List[ValidationError]
    exit_code: int

class ValidationOrchestrator:
    def __init__(self, docs: Dict[str, DocumentData], config: OntosConfig)
    def validate_all(self) -> ValidationResult
    def validate_frontmatter(self) -> None
    def validate_graph(self) -> None
    def validate_status(self) -> None
    def validate_staleness(self) -> None
    def validate_curation(self) -> None
```

**Constraints:**
- MUST collect all errors before returning (no hard exits)
- MUST NOT call `print()` or perform I/O

---

#### `core/types.py`

**Purpose:** Central type definitions, enums, and dataclasses used across core modules.

**Public Interface:**
```python
class DocumentType(Enum):
    KERNEL = "kernel"
    STRATEGY = "strategy"
    PRODUCT = "product"
    ATOM = "atom"
    LOG = "log"

class DocumentStatus(Enum):
    DRAFT = "draft"
    ACTIVE = "active"
    DEPRECATED = "deprecated"
    REJECTED = "rejected"
    COMPLETE = "complete"

class CurationLevel(IntEnum):
    SCAFFOLD = 0
    STUB = 1
    FULL = 2

@dataclass
class DocumentData:
    id: str
    type: DocumentType
    status: DocumentStatus
    filepath: Path
    frontmatter: Dict[str, Any]
    content: str

@dataclass
class OntosConfig:
    docs_dir: Path
    logs_dir: Path
    skip_patterns: List[str]
    log_retention_count: int
    required_version: Optional[str]
```

---

#### `core/suggestions.py`

**Purpose:** Suggests impacts and concepts for session logs. Extracted from `ontos_end_session.py` (lines 1193-1400).

**Public Interface:**
```python
def suggest_impacts(
    changed_files: List[Path],
    docs: Dict[str, DocumentData],
    git_log: List[CommitInfo]
) -> List[str]:
    """Suggest document IDs that may be impacted by changes."""

def suggest_concepts(
    title: str,
    event_type: str,
    existing_concepts: Set[str]
) -> List[str]:
    """Suggest concepts based on title and event type."""
```

**Internal Dependencies:** `core/types.py`

**External Dependencies:** None (stdlib only)

**Constraints:**
- Pure functions (no I/O)
- Receives pre-fetched data as arguments

---

#### `core/tokens.py`

**Purpose:** Token estimation for context map generation. Extracted from `ontos_generate_context_map.py` (lines 71-104).

**Public Interface:**
```python
def estimate_tokens(content: str) -> int:
    """Estimate token count using word-based heuristic (~0.75 tokens/word)."""

def format_token_count(tokens: int) -> str:
    """Format token count for display (e.g., '~2,500 tokens')."""
```

**Internal Dependencies:** None

**External Dependencies:** None (stdlib only)

---

#### `io/toml.py`

**Purpose:** TOML configuration loading and writing.

**Public Interface:**
```python
def load_config(path: Path) -> Dict[str, Any]:
    """Load .ontos.toml file. Returns empty dict if not found."""

def write_config(path: Path, config: Dict[str, Any]) -> None:
    """Write config to .ontos.toml. Uses template to preserve comments."""

def merge_configs(base: Dict, override: Dict) -> Dict:
    """Deep merge two config dicts (override wins)."""
```

**Write Strategy:** Use template-based approach to preserve comments and formatting. Don't use `toml.dumps()` directly as it strips comments.

**Dependencies:**
- Python 3.11+: Use stdlib `tomllib` for reading
- Python 3.9-3.10: Use `tomli` for reading
- Writing: Template-based string generation

---

#### `io/files.py`

**Purpose:** File system operations for document scanning and reading.

**Public Interface:**
```python
def scan_documents(
    dirs: List[Path],
    skip_patterns: List[str]
) -> List[Path]:
    """Recursively find .md files, excluding skip patterns."""

def read_document(path: Path) -> Tuple[Dict, str]:
    """Read document, return (frontmatter, content)."""

def get_file_mtime(path: Path) -> Optional[datetime]:
    """Get file modification time (filesystem, not git)."""
```

---

#### `commands/init.py`

**Purpose:** Initialize Ontos in a repository. Creates `.ontos.toml`, installs shim hooks.

**Behavior:**
1. Check if already initialized (`.ontos.toml` exists)
2. Detect project type (detect existing docs directory)
3. Create `.ontos.toml` with smart defaults
4. Install shim hooks in `.git/hooks/`
5. Create initial context map

**Exit Codes:**
- 0: Success
- 1: Already initialized (with `--force` hint)
- 2: Not a git repository

---

#### `commands/doctor.py`

**Purpose:** Health check and diagnostics for Ontos installation.

**Checks Performed:**
1. `.ontos.toml` exists and valid
2. Git hooks installed and point to correct `ontos` binary
3. Python version compatible
4. Docs directory exists
5. Context map parseable
6. No validation errors in current documents
7. `ontos` CLI accessible in PATH

**Output (normal mode):**
```
✅ Configuration: .ontos.toml valid
✅ Git hooks: pre-push, pre-commit installed
✅ Python: 3.11.0 (>=3.9 required)
✅ Docs: 25 documents in docs/
⚠️  Validation: 2 warnings (run `ontos map --strict`)
```

---

#### `ui/json_output.py`

**Purpose:** JSON formatting for `--json` mode.

**Public Interface:**
```python
class JsonOutputHandler:
    def __init__(self)
    def emit(self, data: Dict) -> None
    def error(self, message: str, code: str) -> None
    def result(self, data: Any) -> None

def to_json(result: ValidationResult) -> Dict
def to_json(context_map: ContextMap) -> Dict
```

---

#### `io/git.py`

**Purpose:** All git subprocess interactions.

**Public Interface:**
```python
def get_current_branch() -> Optional[str]
def get_file_mtime(filepath: Path) -> Optional[datetime]
def get_commits_since_push() -> List[CommitInfo]
def get_diff_stat() -> DiffStat
def is_dirty() -> bool
def get_remote_url() -> Optional[str]
def get_changed_files_since_push() -> List[Path]
def install_hooks(hook_dir: Path, hooks: List[str]) -> None
```

---

### 4.2 God Script Decomposition

#### `ontos_end_session.py` (1,904 lines) → Multiple Targets

| Function Group | Target Location | Lines |
|----------------|-----------------|-------|
| Proposal graduation (46-302) | `core/proposals.py` (REFACTOR) | ~250 |
| Branch/slug handling (304-400) | `io/git.py` | ~100 |
| Log file operations (401-600) | `commands/log.py` | ~200 |
| Git log/commit tracking (496-600) | `io/git.py` | ~100 |
| Changelog handling (975-1192) | `commands/log.py` | ~220 |
| Impact suggestion (1193-1400) | `core/suggestions.py` (NEW) | ~200 |
| Main orchestration (1608-1888) | `commands/log.py` | ~280 |
| Deprecation notice (1889-1904) | DELETE | ~16 |

**Target `commands/log.py`:** ~500 lines

**Note:** The decomposition accounts for ~1,350 lines. The remaining ~500-750 lines will become glue code in `commands/log.py`, be deleted as duplicated logic, or be absorbed during the purification of REFACTOR modules.

---

#### `ontos_generate_context_map.py` (1,295 lines) → Multiple Targets

| Function Group | Target Location | Lines |
|----------------|-----------------|-------|
| Token estimation (71-104) | `core/tokens.py` | ~35 |
| Document scanning (201-275) | `io/files.py` | ~75 |
| Dependency validation (428-560) | `core/graph.py` | ~135 |
| Status validation (695-799) | `core/validation.py` | ~105 |
| Staleness audit (851-920) | `core/staleness.py` (REFACTOR) | ~70 |
| Main generation (925-1128) | `commands/map.py` | ~200 |

**Target `commands/map.py`:** ~300 lines

---

## 5. Data Flow Diagrams

### 5.1 `ontos init` — First-Time Setup

```
User runs: ontos init
           │
           ▼
┌─────────────────────────┐
│ cli.py                  │
│ • Parse args            │
│ • Dispatch to init      │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ commands/init.py        │
│ • Check .ontos.toml     │◀── io/toml.py: load_config()
│ • Detect project layout │◀── io/files.py: scan_for_docs()
│ • Create config         │──▶ io/toml.py: write_config()
│ • Install hooks         │──▶ io/git.py: install_hooks()
│ • Run initial map       │──▶ commands/map.py: run()
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ ui/output.py            │
│ • Print success message │
└─────────────────────────┘

Files Created:
  .ontos.toml
  .git/hooks/pre-push (Python shim)
  .git/hooks/pre-commit (Python shim)
  Ontos_Context_Map.md
```

### 5.2 `ontos map` — Generate Context Map

```
User runs: ontos map [--strict] [--json]
           │
           ▼
┌─────────────────────────────────────────────────────┐
│ commands/map.py                                      │
│                                                      │
│  1. Load config ◀────── io/toml.py                  │
│  2. Scan documents ◀─── io/files.py                 │
│  3. Parse frontmatter ◀─ core/frontmatter.py        │
│  4. Build graph ◀─────── core/graph.py              │
│  5. Validate all ◀────── core/validation.py         │
│     └── ValidationOrchestrator.validate_all()       │
│  6. Generate output                                  │
│  7. Write context map ◀─ SessionContext.commit()    │
└───────────┬─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────┐     ┌─────────────────────┐
│ ui/output.py (normal)   │ OR  │ ui/json_output.py   │
│ • Emoji status          │     │ • JSON result       │
└─────────────────────────┘     └─────────────────────┘
```

### 5.3 `ontos log` — Create Session Log

```
User runs: ontos log -e feature -t "Add dark mode" [--auto]
           │
           ▼
┌─────────────────────────────────────────────────────┐
│ commands/log.py                                      │
│                                                      │
│  1. Get current branch ◀──── io/git.py              │
│  2. Find existing log ◀───── io/files.py            │
│  3. Get commits since push ◀─ io/git.py             │
│  4. Detect changed files ◀─── io/git.py             │
│                                                      │
│  5. CONFIRM CHANGES (Q4 Decision)                   │
│     ├── Display changed files to user               │
│     ├── Ask: "Create log for these changes? [Y/n]"  │
│     └── Skip if --auto flag provided                │
│                                                      │
│  6. Suggest impacts ◀──────── core/suggestions.py   │
│  7. Validate concepts ◀────── core/validation.py    │
│  8. Create log file via SessionContext              │
│  9. Check stale docs ◀─────── core/staleness.py     │
│ 10. Detect proposal graduation ◀─ core/proposals.py │
│ 11. Commit writes                                    │
└─────────────────────────────────────────────────────┘
```

### 5.4 `ontos doctor` — Health Check

```
User runs: ontos doctor [--json]
           │
           ▼
┌─────────────────────────────────────────────────────┐
│ commands/doctor.py                                   │
│                                                      │
│  1. Check .ontos.toml ◀───── io/toml.py             │
│     └── Validate schema, required fields            │
│                                                      │
│  2. Check git hooks ◀─────── io/git.py              │
│     └── pre-push, pre-commit exist and valid        │
│                                                      │
│  3. Check Python version ◀── sys.version_info       │
│     └── >= 3.9 required                             │
│                                                      │
│  4. Check docs directory ◀── io/files.py            │
│     └── Exists and contains .md files               │
│                                                      │
│  5. Check context map ◀───── io/files.py            │
│     └── Parseable, not stale                        │
│                                                      │
│  6. Run validation ◀──────── core/validation.py     │
│     └── Report errors/warnings                      │
│                                                      │
│  7. Check CLI in PATH ◀───── subprocess             │
│     └── `which ontos` succeeds                      │
└───────────┬─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────┐
│ ui/output.py            │
│ • Checkmark/X per item  │
│ • Summary line          │
│ • Exit code 0/1         │
└─────────────────────────┘

Exit Codes:
  0: All checks pass
  1: One or more checks failed
```

### 5.5 `ontos hook` — Git Hook Dispatch

```
Git invokes: .git/hooks/pre-push (Python shim)
           │
           ▼
┌─────────────────────────────────────────────────────┐
│ Python shim                                          │
│ subprocess.call(["ontos", "hook", "pre-push", ...]) │
└───────────┬─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────┐
│ cli.py → commands/hook.py                            │
│                                                      │
│  1. Detect hook type (pre-push, pre-commit)         │
│  2. Load config ◀───────── io/toml.py               │
│  3. Check if hook enabled in config                 │
│                                                      │
│  For pre-push:                                       │
│  4. Get changed files ◀──── io/git.py               │
│  5. Run validation ◀─────── core/validation.py      │
│  6. Check context map fresh                         │
│  7. Return exit code                                │
│                                                      │
│  For pre-commit:                                     │
│  4. Check consolidation status                      │
│  5. Warn if docs modified without log               │
│  6. Return exit code (always 0 unless --strict)    │
└───────────┬─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────┐
│ Exit code to git        │
│ 0: Allow push/commit    │
│ 1: Block push/commit    │
└─────────────────────────┘
```

---

## 6. Configuration Architecture

### 6.1 `.ontos.toml` Schema

```toml
[ontos]
version = "3.0"
required_version = ">=3.0.0"  # Q5: Warn if CLI version doesn't match

[paths]
docs_dir = "docs"
logs_dir = "docs/logs"
context_map = "Ontos_Context_Map.md"

[scanning]
skip_patterns = ["_template.md", "archive/*"]

[validation]
max_dependency_depth = 5
allowed_orphan_types = ["atom"]
strict = false

[workflow]
enforce_archive_before_push = true
require_source_in_logs = true
log_retention_count = 20

[hooks]
pre_push = true
pre_commit = true
```

**Version Checking (Q5 Decision):**
- If `required_version` is set and CLI version doesn't satisfy it, emit warning (not error)
- Format: semver range (e.g., `">=3.0.0"`, `"~3.0"`, `"3.0.x"`)
- Check runs on every CLI invocation

### 6.2 Config Resolution Order

```
CLI Flags (highest priority)
    ↓
Environment Variables (ONTOS_*)
    ↓
.ontos.toml
    ↓
Built-in Defaults (lowest priority)
```

### 6.3 Migration from v2.x

1. `ontos init --migrate` detects `ontos_config.py`
2. Extracts configuration values
3. Generates equivalent `.ontos.toml`
4. v3.0: Both configs read (toml priority)
5. v3.1+: `ontos_config.py` ignored with warning

### 6.4 Config Loading Pattern (Inversion of Control)

To maintain the "core modules perform no I/O" principle, config loading uses Inversion of Control:

```
┌─────────────────────────────────────────────────────┐
│ cli.py (Entry Point)                                 │
│                                                      │
│  1. Detect repo root                                │
│  2. Call io/toml.py:load_config(repo_root)          │
│  3. Merge with CLI flags and env vars               │
│  4. Construct OntosConfig dataclass                 │
│  5. Pass OntosConfig to command function            │
└─────────────────────────────────────────────────────┘
```

**Rules:**
- `io/toml.py` handles all TOML reading/writing (I/O layer)
- `core/config.py` only defines `OntosConfig` dataclass and default values (no I/O)
- `core/` modules receive `OntosConfig` as a parameter, never load it themselves
- Commands receive config as constructor/function argument

---

## 7. CLI Architecture

### 7.1 Command Structure

```
ontos <command> [options]

Global Options:
  --version, -V     Show version and exit
  --help, -h        Show help and exit
  --quiet, -q       Suppress non-essential output
  --json            Output in JSON format

Commands:
  init              Initialize Ontos in current repo
  map               Generate context map
  log               Create/enhance session log
  doctor            Health check and diagnostics
  verify            Verify describes dates
  query             Search documents
  migrate           Migrate schema versions
  consolidate       Archive old logs
  promote           Promote L0/L1 to Level 2
  scaffold          Generate L0 scaffolds
  stub              Create L1 stub document
  hook              Git hook dispatcher (internal)
```

### 7.2 Exit Code Convention

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Validation Error |
| 2 | Configuration Error |
| 3 | User Input Error |
| 4 | Git Error |
| 5 | Internal Error |

---

## 8. Git Integration Architecture

### 8.1 Shim Hook Pattern

**`.git/hooks/pre-push` (installed by `ontos init`):**
```python
#!/usr/bin/env python3
"""Ontos pre-push hook (shim). Delegates to global CLI."""
import subprocess
import sys

try:
    sys.exit(subprocess.call(["ontos", "hook", "pre-push"] + sys.argv[1:]))
except FileNotFoundError:
    print("Warning: ontos not found in PATH. Skipping.", file=sys.stderr)
    sys.exit(0)
```

**Why Python (not shell):**
- Cross-platform: Works on Windows, macOS, Linux
- `#!/bin/sh` fails to parse on Windows Command Prompt/PowerShell
- Python must be in PATH anyway for Ontos to work

### 8.2 Git-Based Change Detection (Q4 Decision)

```python
# io/git.py
def get_changed_files_since_push() -> List[Path]:
    result = subprocess.run(
        ["git", "diff", "--name-only", "@{push}..HEAD"],
        capture_output=True, text=True
    )
    return [Path(f) for f in result.stdout.strip().split('\n') if f]
```

**Edge Cases:**
- First push (no `@{push}`): Fall back to `HEAD~10` comparison
- No upstream: Fall back to comparing against default branch
- Shallow clone: May have incomplete history; warn user

---

## 9. Scalability Architecture

### 9.1 Thresholds

| Metric | Threshold | Behavior Change |
|--------|-----------|-----------------|
| Document count | >100 | Auto-enable summary mode |
| Total tokens | >50,000 | Truncate tree depth to 2 |
| Dependency depth | >5 | Validation warning |

### 9.2 Depth Flags

```
ontos map --depth=1      # Top-level only
ontos map --depth=2      # Two levels (default for large)
ontos map --depth=full   # Complete tree
ontos map --depth=auto   # Auto-detect (default)
```

### 9.3 Performance Targets

| Operation | Target |
|-----------|--------|
| `ontos map` (<100 docs) | <500ms |
| `ontos map` (100-500 docs) | <2s |
| CLI startup | <100ms |

---

## 10. Testing Architecture

### 10.1 Test Organization

```
tests/
├── unit/core/           # Pure function tests
├── integration/         # Multi-module tests
├── cli/                 # CLI-level tests
└── fixtures/            # Test data
```

### 10.2 Coverage Requirements

| Component | Required |
|-----------|----------|
| `core/*` | 90%+ |
| `commands/*` | 80%+ |
| `ui/*` | 70%+ |
| `io/*` | 60%+ |
| **Overall** | 80%+ |

---

## 11. v4.0 Extension Points

| v4.0 Feature | Extension Point | v3.0 Preparation |
|--------------|-----------------|------------------|
| **MCP Server** | `ontos/mcp/` | Clean core/IO separation; JSON output; OutputHandler supports stream injection |
| **Daemon** | `ontos/daemon/` | Stateless commands; no global state |
| **Export Templates** | `ui/formatters/` | OutputHandler pattern |
| **Lazy Loading** | `core/context.py` | URI-based document references |

---

## 12. Constraints & Requirements

### 12.1 Dependency Constraints

**Core:** Stdlib only (no external dependencies)

**Optional:**
```toml
[project.optional-dependencies]
mcp = ["mcp>=1.0", "pydantic>=2.0"]
```

**Allowed for 3.9-3.10:** `tomli` (TOML parsing)

**Note on `tomli`:** This is a conditional dependency for Python <3.11 only. On Python 3.11+, stdlib `tomllib` is used. This maintains zero external dependencies for modern Python installations.

### 12.2 Compatibility

- Python 3.9+ (tested on 3.9, 3.10, 3.11, 3.12)
- Must read schema versions 1.0, 2.0, 2.1, 2.2
- macOS/Linux fully supported
- Windows: best-effort (Python shim hooks address primary gap)

### 12.3 Behavioral Constraints

1. All file writes through `SessionContext.commit()`
2. Core modules MUST NOT call `print()`
3. `SessionContext` passed explicitly, never global
4. No network calls in core operations
5. Core modules MUST NOT call `input()`. User interaction is UI layer responsibility.

---

## 13. Migration Strategy

### 13.1 Module Classification

**Reuse As-Is:** `context.py`, `frontmatter.py`, `schema.py`, `curation.py`, `paths.py`, `config.py` (6 modules)

**Refactor (I/O extraction):** `staleness.py`, `proposals.py`, `history.py` (3 modules)

**Decompose:**
- `ontos_end_session.py` (1,904 lines) → `commands/log.py` + extracted
- `ontos_generate_context_map.py` (1,295 lines) → `commands/map.py` + extracted

**Delete:**
- `ontos_lib.py` (deprecated shim)
- Deprecation notices in all scripts

### 13.2 Migration Phases

```
Phase 0: Golden Master Testing (NEW)
├── Create integration tests capturing v2 behavior
├── Tests record: stdout, file artifacts, exit codes
├── Run on representative fixtures (small, medium, large projects)
└── Verify: v3 commands must produce identical output

Phase 1: Package Structure (v3.0.0-alpha)
├── Create ontos/ package at repo root
├── Move core/ and ui/ modules
├── Create pyproject.toml
└── Verify: `pip install -e .` works

Phase 2: God Script Decomposition (v3.0.0-beta)
├── Extract graph.py, validation.py, types.py, suggestions.py, tokens.py
├── Create commands/map.py, commands/log.py
├── Create io/git.py, io/files.py, io/toml.py
├── Purify REFACTOR modules (extract I/O to io/ layer)
└── Verify: 303 tests pass + Golden Master tests pass

Phase 3: Configuration Migration (v3.0.0-rc)
├── Create io/toml.py with load/write
├── Create commands/init.py
├── Implement config resolution with IoC pattern
└── Verify: Both config methods work

Phase 4: CLI & Hooks (v3.0.0)
├── Create cli.py with argparse
├── Add --json to all commands
├── Create commands/doctor.py, commands/hook.py
├── Implement Python-based shim hooks
└── Delete deprecated ontos_lib.py

Phase 5: Polish & Documentation (v3.0.1+)
├── Performance optimization
├── Documentation updates
└── pip publish to PyPI
```

---

## 14. Open Architectural Questions

| # | Question | Options | Status |
|---|----------|---------|--------|
| 1 | TOML parser for 3.9-3.10 | A) Bundle tomli, B) Require 3.11+ | **Resolved: A) Bundle tomli** |
| 2 | Watch mode in v3.0? | A) Include, B) Defer to v3.1 | **Resolved: B) Defer** |
| 3 | Interactive prompts | A) Built-in input(), B) questionary | **Resolved: A) Built-in** |
| 4 | Windows support | A) Full, B) Best-effort | **Resolved: B) Best-effort** (Python shim addresses primary gap) |

---

## Appendix A: Glossary

| Term | Definition |
|------|------------|
| **Atom** | Smallest document type |
| **Context Map** | Generated Markdown summarizing all documents |
| **Contributor Mode** | Running in Ontos repo itself |
| **Curation Level** | 0=Scaffold, 1=Stub, 2=Full |
| **Functional Core** | Pure, stdlib-only logic with no external I/O |
| **God Script** | Monolithic script with too many responsibilities |
| **Golden Master Test** | Integration test that captures expected output and compares against it |
| **Imperative Shell** | I/O layer calling pure core |
| **Inversion of Control (IoC)** | Pattern where dependencies (like config) are injected rather than fetched |
| **SessionContext** | Transactional file operations |
| **Shim Hook** | Lightweight Python hook delegating to global CLI |

---

## Appendix B: Reference Documents

| Document | Purpose |
|----------|---------|
| V3.0-Strategy-Decisions-Final.md | Final decisions on Q1-Q13 |
| V3.0-Board-Review-Analysis.md | 5-LLM deliberation |
| V3.0-Validation-Maintainability-Technical-Analysis.md | Validation system analysis |
| CONSOLIDATED_Review.md | Merged peer review from 4 architects |
| Chief_Architect_Response.md | Architect's response to peer review |

---

## Appendix C: Current Codebase Metrics

| Metric | Value |
|--------|-------|
| Total lines (`.ontos/scripts/`) | 8,685 |
| Script count | 22 |
| Largest (`ontos_end_session.py`) | 1,904 lines |
| Second (`ontos_generate_context_map.py`) | 1,295 lines |
| Core modules | 10 |
| Test count | 303 |

---

*End of Technical Architecture Specification v1.2*

*Generated by Claude Opus 4.5 — 2026-01-12*
*Reviewed by: Codex, Claude, Gemini Architectural, Gemini DeepThink*
