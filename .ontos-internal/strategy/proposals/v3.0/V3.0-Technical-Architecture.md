# Ontos v3.0 Technical Architecture

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-12
**Status:** Draft — Pending LLM Review Board Review

> **v1.1 Change:** Added Section 2 "Distribution Model: Global CLI + Local Data" to explicitly document the core v3.0 architectural decision. All subsequent sections renumbered.

---

## Executive Summary

This document defines the technical architecture for Ontos v3.0, the "Distribution & Polish" release. Ontos transforms from repo-injected scripts (~8,685 lines across 22 scripts) into a properly distributed Python package (`pip install ontos`). The architecture preserves the functional core/imperative shell pattern already established in `ontos/core/`, extends it to encompass all commands, and prepares extension points for v4.0 features (MCP, daemon, export templates).

**Key Architectural Decisions:**
- Global CLI + local data (git-like model)
- Zero-dependency core (stdlib only)
- Markdown primary output, JSON optional (`--json` flag)
- Declarative `.ontos.toml` configuration
- Shim hooks delegating to global CLI
- ValidationOrchestrator pattern for unified error handling

---

## 1. Architecture Overview

### 1.1 System Boundaries

**What Ontos IS:**
- A local-first documentation management system
- A context map generator for AI agents and humans
- A session logging and curation workflow tool
- A git hook integration for documentation discipline

**What Ontos is NOT:**
- A cloud service or SaaS product
- A real-time collaboration tool
- A database or document storage system
- An AI agent itself (it serves agents, doesn't act as one)

### 1.2 User Personas

| Persona | Interaction Mode | Primary Commands |
|---------|------------------|------------------|
| **Human Developer** | CLI, reads Markdown files | `ontos log`, `ontos map`, `ontos doctor` |
| **Human Reader** | Reads `Ontos_Context_Map.md` directly | N/A (passive consumption) |
| **AI Agent** | Reads Markdown files in context | N/A (passive consumption) |
| **CI/CD Pipeline** | CLI with `--json` flag | `ontos map --json`, exit codes |
| **Future MCP Client** | MCP protocol (v4.0) | MCP tools/resources |

### 1.3 Core Architectural Principles

1. **Zero-Dep Core**: Core logic uses only Python stdlib (3.9+). No external dependencies.
2. **Local-First**: All operations work offline. No network calls in core operations.
3. **Functional Core / Imperative Shell**: Pure logic in `core/`, I/O in `commands/` and `ui/`.
4. **Transactional Writes**: All file modifications go through `SessionContext` for atomicity.
5. **Progressive Disclosure**: Simple defaults, advanced options discoverable.
6. **Readable, Not Retrievable**: Markdown primary; optimized for human/agent reading.

### 1.4 Layered Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      CLI Entry Point                             │
│  ontos/__main__.py → cli.py                                     │
│  • Argument parsing (argparse)                                   │
│  • Command dispatch                                              │
│  • Global flags (--json, --quiet, --version)                    │
├─────────────────────────────────────────────────────────────────┤
│                      Command Layer                               │
│  ontos/commands/{map,log,init,doctor,...}.py                    │
│  • Orchestrates core + I/O                                       │
│  • Handles SessionContext lifecycle                              │
│  • Manages OutputHandler                                         │
├─────────────────────────────────────────────────────────────────┤
│                      Core Logic Layer                            │
│  ontos/core/{context,frontmatter,staleness,schema,...}.py       │
│  • Pure functions (no I/O except marked IMPURE)                 │
│  • Validation logic                                              │
│  • Graph operations                                              │
│  • Data transformations                                          │
├─────────────────────────────────────────────────────────────────┤
│                      I/O Layer                                   │
│  ontos/ui/output.py, ontos/io/{git,files}.py                    │
│  • OutputHandler (formatting, emoji, colors)                     │
│  • File system operations                                        │
│  • Git subprocess calls                                          │
│  • SessionContext.commit() execution                             │
└─────────────────────────────────────────────────────────────────┘
```

**Dependency Rules:**
- CLI Layer → Command Layer → Core Layer → (nothing)
- CLI Layer → I/O Layer (for output)
- Command Layer → I/O Layer (for git, files)
- Core Layer MUST NOT import from Command, CLI, or I/O layers

---

## 2. Distribution Model: Global CLI + Local Data

This section defines the **core architectural decision** of v3.0. Everything else in this document flows from this model.

### 2.1 The Defining v3.0 Decision

v3.0's defining architectural choice is the **"Global CLI + Local Data"** model, directly inspired by Git's distribution pattern. Ontos transforms from repo-injected scripts to a globally-installed package while preserving per-repository documentation ownership.

**The Git Analogy:**

Just as `git` is installed once globally but each repository maintains its own `.git/` directory with commits, branches, and history, Ontos follows the same pattern:

| Git | Ontos |
|-----|-------|
| `git` binary (global) | `ontos` CLI (global via pip) |
| `.git/` directory (per-repo) | `.ontos.toml` + docs (per-repo) |
| Repo history travels with clone | Documentation travels with clone |

### 2.2 Why This Model?

**Design Rationale:**

1. **Portability**: Clone a repo → documentation travels with it. No tool installation required to *read* docs.
2. **Single Source of Truth**: One CLI version across all projects eliminates version drift.
3. **Separation of Concerns**: Tool logic (global, maintained by Ontos) vs. project knowledge (local, owned by project).
4. **Offline-First**: Documentation readable without any tooling installed—just Markdown files.
5. **Update Simplicity**: `pip install --upgrade ontos` updates all projects instantly.

**What This Model Rejects:**

- ❌ Scripts copied into each repo (v2.x pattern)
- ❌ Cloud-based documentation storage
- ❌ Tool-specific formats requiring Ontos to read
- ❌ Per-repo tool versioning/configuration complexity

### 2.3 What Lives Where

```
┌─────────────────────────────────────────────────────────────────┐
│                     GLOBAL (pip install ontos)                   │
│  ~/.local/lib/python3.x/site-packages/ontos/                    │
│  ├── cli.py           # Command dispatch                        │
│  ├── core/            # Pure validation logic                   │
│  ├── commands/        # Command implementations                 │
│  ├── ui/              # Output formatting                       │
│  └── io/              # File/git operations                     │
│                                                                  │
│  Managed by: pip install ontos                                  │
│  Updated by: pip install --upgrade ontos                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                    delegates to global CLI
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     PER-REPOSITORY (local data)                  │
│  my-project/                                                     │
│  ├── .ontos.toml              # Configuration (declarative)     │
│  ├── Ontos_Context_Map.md     # Generated context map           │
│  ├── .git/hooks/              # Shim hooks → global CLI         │
│  │   ├── pre-push             # 5 lines, delegates to ontos     │
│  │   └── pre-commit           # 5 lines, delegates to ontos     │
│  └── docs/                    # (or .ontos-internal/)           │
│      ├── logs/                # Session logs                    │
│      ├── kernel/              # Kernel documents                │
│      ├── strategy/            # Strategy documents              │
│      └── ...                  # Project documentation           │
│                                                                  │
│  Managed by: ontos init, ontos map, ontos log                   │
│  Owned by: The project repository                               │
└─────────────────────────────────────────────────────────────────┘
```

**Explicit Ownership Table:**

| Component | Location | Owner | Format |
|-----------|----------|-------|--------|
| CLI binary | Global (pip) | Ontos maintainers | Python package |
| Core logic | Global (pip) | Ontos maintainers | Python modules |
| Configuration | Repo: `.ontos.toml` | Project | TOML (declarative) |
| Context map | Repo: `Ontos_Context_Map.md` | Project (generated) | Markdown |
| Session logs | Repo: `docs/logs/` | Project | Markdown |
| Documentation | Repo: `docs/` | Project | Markdown |
| Git hooks | Repo: `.git/hooks/` | Project (generated) | Shell shims |

### 2.4 How v3.0 Differs from v2.x

| Aspect | v2.x (Current) | v3.0 (Target) |
|--------|----------------|---------------|
| **Installation** | Copy `.ontos/scripts/` into each repo | `pip install ontos` once globally |
| **CLI Entry** | `python3 .ontos/scripts/ontos.py` | `ontos` (in PATH) |
| **Updates** | Manual copy to each repo | `pip install --upgrade ontos` |
| **Hook Scripts** | Full Python scripts in `.git/hooks/` | 5-line shims delegating to global CLI |
| **Configuration** | `ontos_config.py` (executable Python) | `.ontos.toml` (declarative TOML) |
| **Script Count per Repo** | 22 scripts (~8,685 lines) | 0 scripts (config + data only) |
| **Version Control** | Scripts versioned with repo | Tool version independent of repo |

**Visual Migration:**

```
v2.x repo:                              v3.0 repo:
├── .ontos/                             ├── .ontos.toml (10 lines)
│   └── scripts/                        ├── Ontos_Context_Map.md
│       ├── ontos.py                    └── docs/
│       ├── ontos_end_session.py            └── (unchanged)
│       ├── ontos_generate_context_map.py
│       ├── ontos_lib.py
│       ├── ontos/
│       │   ├── core/
│       │   └── ui/
│       └── ... (22 scripts total)
└── docs/
    └── (unchanged)

Removed: ~8,685 lines of scripts per repo
Added: ~10 lines of .ontos.toml
```

### 2.5 Benefits Summary

| Benefit | v2.x Pain Point | v3.0 Solution |
|---------|-----------------|---------------|
| **No Script Duplication** | 8,685 lines copied to each repo | Scripts live in pip package |
| **Easier Updates** | Manual copy to N repos | Single `pip upgrade` |
| **Repo Stays Clean** | 22 scripts polluting repo | Only config + output files |
| **Version Consistency** | Different Ontos versions per repo | All projects use same version |
| **Simpler Onboarding** | "Copy these scripts to your repo" | `pip install ontos && ontos init` |
| **CI/CD Simplicity** | Maintain scripts in each repo's CI | `pip install ontos` in pipeline |
| **Documentation Portability** | Docs readable without scripts | Docs readable without any tooling |

### 2.6 Design Constraints from This Model

This distribution model imposes specific constraints on all other v3.0 architecture decisions:

1. **No Repo-Specific Code in Global CLI**: The global CLI cannot contain repo-specific logic or hardcoded paths.

2. **Configuration Must Be Declarative**: `.ontos.toml` is data, not executable code. No Python config files.

3. **Shim Hooks Must Be Minimal**: Hooks contain only delegation logic (5 lines). All real logic lives in global CLI.

4. **Graceful Degradation Required**: If `ontos` is not in PATH, hooks must warn but not block git operations.

5. **Backward Read Compatibility**: v3.0 CLI must read v2.x documentation without requiring migration.

6. **No Network Calls**: Global CLI operates entirely offline. No phone-home, no remote config.

7. **Repo Root Detection**: CLI must reliably detect repo root from any subdirectory (like `git`).

---

## 3. Package Structure

### 3.1 Target Structure for `pip install ontos`

```
ontos/
├── __init__.py              # Package metadata, version
├── __main__.py              # Entry: `python -m ontos`
├── cli.py                   # Argument parsing, command dispatch
├── version.py               # __version__, schema versions
│
├── core/                    # Pure logic (STDLIB ONLY)
│   ├── __init__.py          # Public API exports
│   ├── context.py           # SessionContext (EXISTS - 272 lines)
│   ├── frontmatter.py       # YAML parsing (EXISTS)
│   ├── staleness.py         # Describes validation (EXISTS - 353 lines)
│   ├── schema.py            # Schema versioning (EXISTS - 421 lines)
│   ├── curation.py          # Curation levels (EXISTS - 489 lines)
│   ├── history.py           # Decision history (EXISTS)
│   ├── paths.py             # Path resolution (EXISTS)
│   ├── config.py            # Config helpers (EXISTS)
│   ├── proposals.py         # Proposal helpers (EXISTS)
│   ├── graph.py             # Dependency graph (NEW)
│   ├── validation.py        # ValidationOrchestrator (NEW)
│   └── types.py             # Type definitions, enums (NEW)
│
├── commands/                # Command implementations (NEW)
│   ├── __init__.py
│   ├── init.py              # `ontos init`
│   ├── map.py               # `ontos map` (from ontos_generate_context_map.py)
│   ├── log.py               # `ontos log` (from ontos_end_session.py)
│   ├── doctor.py            # `ontos doctor` (NEW)
│   ├── verify.py            # `ontos verify`
│   ├── query.py             # `ontos query`
│   ├── migrate.py           # `ontos migrate`
│   ├── consolidate.py       # `ontos consolidate`
│   ├── promote.py           # `ontos promote`
│   ├── scaffold.py          # `ontos scaffold`
│   ├── stub.py              # `ontos stub`
│   └── hook.py              # `ontos hook pre-push|pre-commit`
│
├── ui/                      # Output formatting
│   ├── __init__.py
│   ├── output.py            # OutputHandler (EXISTS - 109 lines)
│   ├── json_output.py       # JSON formatting (NEW)
│   └── progress.py          # Progress indicators (NEW)
│
├── io/                      # External system interactions (NEW)
│   ├── __init__.py
│   ├── git.py               # Git subprocess calls
│   ├── files.py             # File system operations
│   └── toml.py              # .ontos.toml parsing
│
└── mcp/                     # Optional MCP layer (v3.x/v4)
    ├── __init__.py          # Stub for now
    └── server.py            # MCP server (DEFERRED to v4.0)
```

### 3.2 Directory Specifications

#### `ontos/core/` — Pure Logic Layer

**Purpose:** Contains all business logic as pure functions. No I/O operations except functions explicitly marked as IMPURE in docstrings.

**Dependencies:** Python stdlib only. MUST NOT import from `commands/`, `ui/`, `io/`, or `mcp/`.

**Key Modules:**
| Module | Status | Lines | Description |
|--------|--------|-------|-------------|
| `context.py` | EXISTS | 272 | SessionContext with transactional file operations |
| `frontmatter.py` | EXISTS | ~100 | YAML frontmatter parsing and normalization |
| `staleness.py` | EXISTS | 353 | Describes field validation, staleness detection |
| `schema.py` | EXISTS | 421 | Schema version detection and compatibility |
| `curation.py` | EXISTS | 489 | Three-tier curation level validation |
| `history.py` | EXISTS | ~220 | Decision history generation |
| `paths.py` | EXISTS | ~300 | Path resolution and directory helpers |
| `config.py` | EXISTS | ~70 | Configuration constants and helpers |
| `proposals.py` | EXISTS | ~150 | Proposal detection and graduation |
| `graph.py` | **NEW** | ~200 | Dependency graph building and validation |
| `validation.py` | **NEW** | ~300 | ValidationOrchestrator, unified error handling |
| `types.py` | **NEW** | ~150 | Enums, dataclasses, type definitions |

#### `ontos/commands/` — Command Layer

**Purpose:** Implements CLI commands. Orchestrates core logic and I/O. Manages SessionContext lifecycle.

**Dependencies:** May import from `core/`, `ui/`, `io/`. MUST NOT import from `mcp/` (optional layer).

**Key Modules:**
| Module | Source | Est. Lines | Description |
|--------|--------|------------|-------------|
| `map.py` | `ontos_generate_context_map.py` | ~300 | Context map generation (decomposed) |
| `log.py` | `ontos_end_session.py` | ~500 | Session log creation (decomposed) |
| `init.py` | NEW | ~200 | Repository initialization, hook setup |
| `doctor.py` | NEW | ~150 | Health check and diagnostics |
| `hook.py` | NEW | ~100 | Git hook dispatcher |

#### `ontos/ui/` — Output Formatting

**Purpose:** All output formatting, emoji, colors, JSON mode. The ONLY layer that knows about display format.

**Dependencies:** May import from `core/` for data types. MUST NOT perform I/O except `print()`.

#### `ontos/io/` — External System Interactions

**Purpose:** All file system and subprocess operations. Isolates I/O for testability.

**Dependencies:** May import from `core/` for types. MUST NOT import from `commands/`.

---

## 4. Module Specifications

### 4.1 New Modules

#### `core/graph.py`

**Purpose:** Builds and validates dependency graphs. Extracted from `ontos_generate_context_map.py` (lines 428-560).

**Public Interface:**
```python
@dataclass
class DependencyGraph:
    nodes: Dict[str, GraphNode]
    edges: Dict[str, List[str]]  # id -> depends_on
    reverse_edges: Dict[str, List[str]]  # id -> depended_by

def build_graph(docs: Dict[str, DocumentData]) -> DependencyGraph
def detect_cycles(graph: DependencyGraph) -> List[List[str]]
def detect_orphans(graph: DependencyGraph, allowed_types: Set[str]) -> List[str]
def calculate_depths(graph: DependencyGraph) -> Dict[str, int]
def validate_type_hierarchy(graph: DependencyGraph, hierarchy: Dict) -> List[str]
```

**Internal Dependencies:** `core/types.py`

**External Dependencies:** None (stdlib only)

**Constraints:**
- All functions must be pure (no I/O)
- Cycle detection must use O(V+E) DFS, not O(n) path lookup

---

#### `core/validation.py`

**Purpose:** Unified validation orchestration. Replaces hard-exit pattern with error collection.

**Public Interface:**
```python
class ValidationErrorType(Enum):
    BROKEN_LINK = "broken_link"
    CYCLE = "cycle"
    ORPHAN = "orphan"
    ARCHITECTURE = "architecture"
    SCHEMA = "schema"
    STATUS = "status"
    STALENESS = "staleness"

@dataclass
class ValidationError:
    error_type: ValidationErrorType
    doc_id: str
    filepath: str
    message: str
    fix_suggestion: str
    severity: Literal['error', 'warning', 'info']

@dataclass
class ValidationResult:
    errors: List[ValidationError]
    warnings: List[ValidationError]
    exit_code: int

class ValidationOrchestrator:
    def __init__(self, docs: Dict[str, DocumentData], config: OntosConfig)
    def validate_all(self) -> ValidationResult
    def validate_frontmatter(self) -> None
    def validate_graph(self) -> None
    def validate_status(self) -> None
    def validate_staleness(self) -> None
```

**Constraints:**
- MUST collect all errors before returning (no hard exits)
- MUST NOT call `print()` or perform I/O

---

#### `core/types.py`

**Purpose:** Central type definitions, enums, and dataclasses used across core modules.

**Public Interface:**
```python
class DocumentType(Enum):
    KERNEL = "kernel"
    STRATEGY = "strategy"
    PRODUCT = "product"
    ATOM = "atom"
    LOG = "log"

class DocumentStatus(Enum):
    DRAFT = "draft"
    ACTIVE = "active"
    DEPRECATED = "deprecated"
    REJECTED = "rejected"
    COMPLETE = "complete"

class CurationLevel(IntEnum):
    SCAFFOLD = 0
    STUB = 1
    FULL = 2

@dataclass
class DocumentData:
    id: str
    type: DocumentType
    status: DocumentStatus
    filepath: Path
    frontmatter: Dict[str, Any]
    content: str

@dataclass
class OntosConfig:
    docs_dir: Path
    logs_dir: Path
    skip_patterns: List[str]
    log_retention_count: int
```

---

#### `commands/init.py`

**Purpose:** Initialize Ontos in a repository. Creates `.ontos.toml`, installs shim hooks.

**Behavior:**
1. Check if already initialized (`.ontos.toml` exists)
2. Detect project type (detect existing docs directory)
3. Create `.ontos.toml` with smart defaults
4. Install shim hooks in `.git/hooks/`
5. Create initial context map

**Exit Codes:**
- 0: Success
- 1: Already initialized (with `--force` hint)
- 2: Not a git repository

---

#### `commands/doctor.py`

**Purpose:** Health check and diagnostics for Ontos installation.

**Checks Performed:**
1. `.ontos.toml` exists and valid
2. Git hooks installed and point to correct `ontos` binary
3. Python version compatible
4. Docs directory exists
5. Context map parseable
6. No validation errors in current documents
7. `ontos` CLI accessible in PATH

**Output (normal mode):**
```
✅ Configuration: .ontos.toml valid
✅ Git hooks: pre-push, pre-commit installed
✅ Python: 3.11.0 (>=3.9 required)
✅ Docs: 25 documents in docs/
⚠️  Validation: 2 warnings (run `ontos map --strict`)
```

---

#### `ui/json_output.py`

**Purpose:** JSON formatting for `--json` mode.

**Public Interface:**
```python
class JsonOutputHandler:
    def __init__(self)
    def emit(self, data: Dict) -> None
    def error(self, message: str, code: str) -> None
    def result(self, data: Any) -> None

def to_json(result: ValidationResult) -> Dict
def to_json(context_map: ContextMap) -> Dict
```

---

#### `io/git.py`

**Purpose:** All git subprocess interactions.

**Public Interface:**
```python
def get_current_branch() -> Optional[str]
def get_file_mtime(filepath: Path) -> Optional[datetime]
def get_commits_since_push() -> List[CommitInfo]
def get_diff_stat() -> DiffStat
def is_dirty() -> bool
def get_remote_url() -> Optional[str]
```

---

### 4.2 God Script Decomposition

#### `ontos_end_session.py` (1,904 lines) → Multiple Targets

| Function Group | Target Location | Lines |
|----------------|-----------------|-------|
| Proposal graduation (46-302) | `core/proposals.py` (EXISTS) | ~250 |
| Branch/slug handling (304-400) | `io/git.py` | ~100 |
| Log file operations (401-600) | `commands/log.py` | ~200 |
| Git log/commit tracking (496-600) | `io/git.py` | ~100 |
| Changelog handling (975-1192) | `commands/log.py` | ~220 |
| Impact suggestion (1193-1400) | `core/suggestions.py` (NEW) | ~200 |
| Main orchestration (1608-1888) | `commands/log.py` | ~280 |
| Deprecation notice (1889-1904) | DELETE | ~16 |

**Target `commands/log.py`:** ~500 lines

---

#### `ontos_generate_context_map.py` (1,295 lines) → Multiple Targets

| Function Group | Target Location | Lines |
|----------------|-----------------|-------|
| Token estimation (71-104) | `core/tokens.py` | ~35 |
| Document scanning (201-275) | `io/files.py` | ~75 |
| Dependency validation (428-560) | `core/graph.py` | ~135 |
| Status validation (695-799) | `core/validation.py` | ~105 |
| Staleness audit (851-920) | `core/staleness.py` (EXISTS) | ~70 |
| Main generation (925-1128) | `commands/map.py` | ~200 |

**Target `commands/map.py`:** ~300 lines

---

## 5. Data Flow Diagrams

### 5.1 `ontos init` — First-Time Setup

```
User runs: ontos init
           │
           ▼
┌─────────────────────────┐
│ cli.py                  │
│ • Parse args            │
│ • Dispatch to init      │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ commands/init.py        │
│ • Check .ontos.toml     │◀── io/toml.py: load_config()
│ • Detect project layout │◀── io/files.py: scan_for_docs()
│ • Create config         │──▶ io/toml.py: write_config()
│ • Install hooks         │──▶ io/git.py: install_hooks()
│ • Run initial map       │──▶ commands/map.py: run()
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ ui/output.py            │
│ • Print success message │
└─────────────────────────┘

Files Created:
  .ontos.toml
  .git/hooks/pre-push (shim)
  .git/hooks/pre-commit (shim)
  Ontos_Context_Map.md
```

### 5.2 `ontos map` — Generate Context Map

```
User runs: ontos map [--strict] [--json]
           │
           ▼
┌─────────────────────────────────────────────────────┐
│ commands/map.py                                      │
│                                                      │
│  1. Load config ◀────── io/toml.py                  │
│  2. Scan documents ◀─── io/files.py                 │
│  3. Parse frontmatter ◀─ core/frontmatter.py        │
│  4. Build graph ◀─────── core/graph.py              │
│  5. Validate all ◀────── core/validation.py         │
│     └── ValidationOrchestrator.validate_all()       │
│  6. Generate output                                  │
│  7. Write context map ◀─ SessionContext.commit()    │
└───────────┬─────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────┐     ┌─────────────────────┐
│ ui/output.py (normal)   │ OR  │ ui/json_output.py   │
│ • Emoji status          │     │ • JSON result       │
└─────────────────────────┘     └─────────────────────┘
```

### 5.3 `ontos log` — Create Session Log

```
User runs: ontos log -e feature -t "Add dark mode"
           │
           ▼
┌─────────────────────────────────────────────────────┐
│ commands/log.py                                      │
│                                                      │
│  1. Get current branch ◀──── io/git.py              │
│  2. Find existing log ◀───── io/files.py            │
│  3. Get commits since push ◀─ io/git.py             │
│  4. Suggest impacts ◀──────── core/suggestions.py   │
│  5. Validate concepts ◀────── core/validation.py    │
│  6. Create log file via SessionContext              │
│  7. Check stale docs ◀─────── core/staleness.py     │
│  8. Detect proposal graduation ◀─ core/proposals.py │
│  9. Commit writes                                    │
└─────────────────────────────────────────────────────┘
```

---

## 6. Configuration Architecture

### 6.1 `.ontos.toml` Schema

```toml
[ontos]
version = "3.0"

[paths]
docs_dir = "docs"
logs_dir = "docs/logs"
context_map = "Ontos_Context_Map.md"

[scanning]
skip_patterns = ["_template.md", "archive/*"]

[validation]
max_dependency_depth = 5
allowed_orphan_types = ["atom"]
strict = false

[workflow]
enforce_archive_before_push = true
require_source_in_logs = true
log_retention_count = 20

[hooks]
pre_push = true
pre_commit = true
```

### 6.2 Config Resolution Order

```
CLI Flags (highest priority)
    ↓
Environment Variables (ONTOS_*)
    ↓
.ontos.toml
    ↓
Built-in Defaults (lowest priority)
```

### 6.3 Migration from v2.x

1. `ontos init --migrate` detects `ontos_config.py`
2. Extracts configuration values
3. Generates equivalent `.ontos.toml`
4. v3.0: Both configs read (toml priority)
5. v3.1+: `ontos_config.py` ignored with warning

---

## 7. CLI Architecture

### 7.1 Command Structure

```
ontos <command> [options]

Global Options:
  --version, -V     Show version and exit
  --help, -h        Show help and exit
  --quiet, -q       Suppress non-essential output
  --json            Output in JSON format

Commands:
  init              Initialize Ontos in current repo
  map               Generate context map
  log               Create/enhance session log
  doctor            Health check and diagnostics
  verify            Verify describes dates
  query             Search documents
  migrate           Migrate schema versions
  consolidate       Archive old logs
  promote           Promote L0/L1 to Level 2
  scaffold          Generate L0 scaffolds
  stub              Create L1 stub document
  hook              Git hook dispatcher (internal)
```

### 7.2 Exit Code Convention

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Validation Error |
| 2 | Configuration Error |
| 3 | User Input Error |
| 4 | Git Error |
| 5 | Internal Error |

---

## 8. Git Integration Architecture

### 8.1 Shim Hook Pattern

**`.git/hooks/pre-push` (installed by `ontos init`):**
```bash
#!/bin/sh
# Ontos pre-push hook (shim)

if command -v ontos >/dev/null 2>&1; then
    ontos hook pre-push "$@"
    exit $?
else
    echo "Warning: ontos not found in PATH. Skipping."
    exit 0
fi
```

### 8.2 Git-Based Change Detection (Q4 Decision)

```python
# io/git.py
def get_changed_files_since_push() -> List[Path]:
    result = subprocess.run(
        ["git", "diff", "--name-only", "@{push}..HEAD"],
        capture_output=True, text=True
    )
    return [Path(f) for f in result.stdout.strip().split('\n') if f]
```

---

## 9. Scalability Architecture

### 9.1 Thresholds

| Metric | Threshold | Behavior Change |
|--------|-----------|-----------------|
| Document count | >100 | Auto-enable summary mode |
| Total tokens | >50,000 | Truncate tree depth to 2 |
| Dependency depth | >5 | Validation warning |

### 9.2 Depth Flags

```
ontos map --depth=1      # Top-level only
ontos map --depth=2      # Two levels (default for large)
ontos map --depth=full   # Complete tree
ontos map --depth=auto   # Auto-detect (default)
```

### 9.3 Performance Targets

| Operation | Target |
|-----------|--------|
| `ontos map` (<100 docs) | <500ms |
| `ontos map` (100-500 docs) | <2s |
| CLI startup | <100ms |

---

## 10. Testing Architecture

### 10.1 Test Organization

```
tests/
├── unit/core/           # Pure function tests
├── integration/         # Multi-module tests
├── cli/                 # CLI-level tests
└── fixtures/            # Test data
```

### 10.2 Coverage Requirements

| Component | Required |
|-----------|----------|
| `core/*` | 90%+ |
| `commands/*` | 80%+ |
| `ui/*` | 70%+ |
| `io/*` | 60%+ |
| **Overall** | 80%+ |

---

## 11. v4.0 Extension Points

| v4.0 Feature | Extension Point | v3.0 Preparation |
|--------------|-----------------|------------------|
| **MCP Server** | `ontos/mcp/` | Clean core/IO separation; JSON output |
| **Daemon** | `ontos/daemon/` | Stateless commands; no global state |
| **Export Templates** | `ui/formatters/` | OutputHandler pattern |
| **Lazy Loading** | `core/context.py` | URI-based document references |

---

## 12. Constraints & Requirements

### 12.1 Dependency Constraints

**Core:** Stdlib only (no external dependencies)

**Optional:**
```toml
[project.optional-dependencies]
mcp = ["mcp>=1.0", "pydantic>=2.0"]
```

**Allowed for 3.9-3.10:** `tomli` (TOML parsing)

### 12.2 Compatibility

- Python 3.9+ (tested on 3.9, 3.10, 3.11, 3.12)
- Must read schema versions 1.0, 2.0, 2.1, 2.2
- macOS/Linux fully supported
- Windows: best-effort

### 12.3 Behavioral Constraints

1. All file writes through `SessionContext.commit()`
2. Core modules MUST NOT call `print()`
3. `SessionContext` passed explicitly, never global
4. No network calls in core operations

---

## 13. Migration Strategy

### 13.1 Module Classification

**Reuse As-Is:** `ontos/core/*` (10 modules, ~2,500 lines)

**Decompose:**
- `ontos_end_session.py` (1,904 lines) → `commands/log.py` + extracted
- `ontos_generate_context_map.py` (1,295 lines) → `commands/map.py` + extracted

**Delete:**
- `ontos_lib.py` (deprecated shim)
- Deprecation notices in all scripts

### 13.2 Migration Phases

```
Phase 1: Package Structure (v3.0.0-alpha)
├── Create ontos/ package at repo root
├── Move core/ and ui/ modules
├── Create pyproject.toml
└── Verify: `pip install -e .` works

Phase 2: God Script Decomposition (v3.0.0-beta)
├── Extract graph.py, validation.py, types.py
├── Create commands/map.py, commands/log.py
├── Create io/git.py, io/files.py
└── Verify: 303 tests pass

Phase 3: Configuration Migration (v3.0.0-rc)
├── Create io/toml.py
├── Create commands/init.py
├── Implement config resolution
└── Verify: Both config methods work

Phase 4: CLI & Hooks (v3.0.0)
├── Create cli.py with argparse
├── Add --json to all commands
├── Create commands/doctor.py, commands/hook.py
├── Implement shim hooks
└── Delete deprecated ontos_lib.py

Phase 5: Polish & Documentation (v3.0.1+)
├── Performance optimization
├── Documentation updates
└── pip publish to PyPI
```

---

## 14. Open Architectural Questions

| # | Question | Options | Recommendation |
|---|----------|---------|----------------|
| 1 | TOML parser for 3.9-3.10 | A) Bundle tomli, B) Require 3.11+ | **A) Bundle tomli** |
| 2 | Watch mode in v3.0? | A) Include, B) Defer to v3.1 | **B) Defer** |
| 3 | Interactive prompts | A) Built-in input(), B) questionary | **A) Built-in** |
| 4 | Windows support | A) Full, B) Best-effort | **B) Best-effort** |

---

## Appendix A: Glossary

| Term | Definition |
|------|------------|
| **Atom** | Smallest document type |
| **Context Map** | Generated Markdown summarizing all documents |
| **Contributor Mode** | Running in Ontos repo itself |
| **Curation Level** | 0=Scaffold, 1=Stub, 2=Full |
| **Functional Core** | Pure logic with no I/O |
| **God Script** | Monolithic script with too many responsibilities |
| **Imperative Shell** | I/O layer calling pure core |
| **SessionContext** | Transactional file operations |
| **Shim Hook** | Lightweight hook delegating to global CLI |

---

## Appendix B: Reference Documents

| Document | Purpose |
|----------|---------|
| V3.0-Strategy-Decisions-Final.md | Final decisions on Q1-Q13 |
| V3.0-Board-Review-Analysis.md | 5-LLM deliberation |
| V3.0-Validation-Maintainability-Technical-Analysis.md | Validation system analysis |

---

## Appendix C: Current Codebase Metrics

| Metric | Value |
|--------|-------|
| Total lines (`.ontos/scripts/`) | 8,685 |
| Script count | 22 |
| Largest (`ontos_end_session.py`) | 1,904 lines |
| Second (`ontos_generate_context_map.py`) | 1,295 lines |
| Core modules | 10 |
| Test count | 303 |

---

*End of Technical Architecture Specification*

*Generated by Claude Opus 4.5 — 2026-01-12*
