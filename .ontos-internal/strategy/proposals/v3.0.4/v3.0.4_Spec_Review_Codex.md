# Adversarial Review: Ontos v3.0.4 Implementation Spec (Phase B.1)

## Part 1: Assumption Attack

| Assumption in Spec | Why It Might Be Wrong | Impact If Wrong |
|--------------------|----------------------|-----------------|
| `Path.cwd()` returns the project root | User runs from a subdirectory, or from a symlinked path | `ONTOS_PROJECT_ROOT` points at subdir, legacy scripts may stop walking up and fail to find `.ontos.toml` |
| Subprocess inherits CWD correctly | Some launchers or wrappers may change CWD; Windows shell quirks | Wrapper commands still run in wrong dir, fix ineffective on some platforms |
| `ONTOS_PROJECT_ROOT` is actually read | Legacy scripts might ignore env var or use different precedence | New env var is dead code, bug persists |
| Legacy scripts use `find_project_root()` | Some scripts use local path logic (`__file__`-relative) | `Path.cwd()` and env var do not affect the actual root selection |
| Native commands are unaffected | Shared utilities might call `_get_subprocess_env()` indirectly | Regression in native commands or tests |
| `PYTHONPATH` change is harmless | CWD may contain conflicting modules or malicious code | Import shadowing, arbitrary code execution risk |
| CWD is always accessible | CWD deleted or permission denied (CI cleanup, temp dirs) | `Path.cwd()` raises, wrapper commands crash |
| Overwriting `ONTOS_PROJECT_ROOT` is safe | Users may set it intentionally to target a different repo | Breaks workflows that rely on explicit root |

## Part 2: Edge Case Analysis

| Scenario | Handled in Spec? | What Actually Happens? | Acceptable? |
|----------|------------------|------------------------|-------------|
| Run from project root | Sec 7: Yes | CWD == root, works | Yes |
| Run from `docs/` subdirectory | Sec 7: Yes | `ONTOS_PROJECT_ROOT` set to `docs/`, legacy scripts might not walk up | Maybe (risk if env var short-circuits search) |
| Run from `/tmp/` (no project) | Sec 7: Yes | Adds `/tmp` to `PYTHONPATH`, may import stray `ontos_config.py` if present | Maybe (security/confusion) |
| Run from `/` (root filesystem) | Sec 7: Yes | Same as above, plus permission errors on write | Maybe |
| Run from symlinked directory | Not mentioned | `Path.cwd()` returns symlink path; config discovery might mismatch real path | Unknown |
| Run with `ONTOS_PROJECT_ROOT` already set | Not mentioned | Overwritten unconditionally | Possibly not acceptable |
| Run from Windows path with spaces | Not mentioned | `PYTHONPATH` entry is fine, but subprocess invocation may differ | Probably acceptable, untested |
| Run from path with unicode chars | Not mentioned | Path encoded in env, may fail on older shells | Likely OK but untested |
| Concurrent runs from different dirs | Not mentioned | Each process has its own env, OK | Acceptable |
| Run via `cron` or script (no TTY) | Not mentioned | Should be OK, but if CWD is `/`, writes fail | Acceptable if errors are clear |

**Missing Edge Cases:**
- CWD removed between process start and `_get_subprocess_env()` (Path.cwd raises)
- CWD contains an `ontos.py` or `ontos/` package that shadows the installed package
- CWD is an NFS mount or has slow path resolution (Path.cwd latency)
- Wrapper commands invoked with an explicit `--config` or `--root` (if supported) should override CWD

## Part 3: Failure Mode Analysis

| Failure | How It Happens | Detection | Recovery | Severity |
|---------|----------------|-----------|----------|----------|
| `Path.cwd()` throws exception | CWD deleted or permission denied | None documented | Crash | High |
| `ONTOS_PROJECT_ROOT` overrides user intent | User sets env var to target another repo | No warning | Confusing behavior | Medium |
| Legacy scripts ignore `ONTOS_PROJECT_ROOT` | Env var not used or lower precedence | Wrapper commands still broken | None | High |
| Import shadowing via PYTHONPATH | CWD contains `ontos` or `ontos_config` | No detection | Potential code execution | High |
| Subprocess still runs in wrong dir | Launcher changes CWD or wrappers set it | Only manual test | None | High |
| CWD is not a project but contains `ontos_config.py` | Accidental import from unrelated dir | None | Confusing, wrong outputs | Medium |
| Windows path normalization issues | Backslashes/drive letters in PYTHONPATH | None | Wrapper commands fail on Windows | Medium |

## Part 4: Regression Hunt

| What Currently Works | Could This Fix Break It? | How? |
|----------------------|--------------------------|------|
| Native commands (`map`, `doctor`, etc.) | Possibly | If `_get_subprocess_env()` is reused or imported in native paths |
| Source checkout workflow | Yes | CWD PYTHONPATH could shadow installed package or use wrong root |
| Existing Ontos projects | Possibly | Running from subdir could now set root to subdir, changing behavior |
| CI/CD pipelines | Possibly | CI often runs from repo root, but some jobs `cd` into subdir; behavior changes |
| IDE integrations | Possibly | IDEs sometimes launch from workspace root or temp dir; CWD might not be the project |

**Regression Concerns:**
- Overwriting `ONTOS_PROJECT_ROOT` can break workflows that intentionally set it.
- Adding CWD to `PYTHONPATH` can change import resolution order, causing subtle behavior changes.
- Running from subdirectories could regress if legacy scripts treat `ONTOS_PROJECT_ROOT` as authoritative.

## Part 5: Security Review

| Attack Vector | Applicable? | Mitigated in Spec? | Notes |
|---------------|-------------|---------------------|-------|
| PATH injection via PYTHONPATH | Yes | No | CWD prepended to PYTHONPATH allows shadowing `ontos` or `ontos_config` |
| Env var injection | Low | No | `ONTOS_PROJECT_ROOT` overwritten; could be abused if running in untrusted dir |
| Command injection in subprocess | No | N/A | Commands are hardcoded |

**Security Concerns:**
- Prepending arbitrary CWD to `PYTHONPATH` is an attack surface when users run `ontos` in untrusted directories.
- `ONTOS_PROJECT_ROOT` overwrite removes user's ability to constrain to a safe root.

## Part 6: Blind Spot Identification

| Area | Why Suspicious | What Could Go Wrong |
|------|----------------|---------------------|
| Cross-platform behavior | Tests are Linux/macOS-centric | Windows path and shell differences break wrapper commands |
| Subprocess CWD inheritance | Assumed "obvious" | Shell wrappers or entrypoints may not preserve CWD |
| Legacy script compatibility | Assumes env var is honored | If ignored, fix does nothing for wrappers |
| PYTHONPATH change | "Harmless" assumption | Import shadowing or executing malicious code |
| Subdirectory execution | Assumes `find_project_root()` walks up | `ONTOS_PROJECT_ROOT` may short-circuit search |

**What seems too easy?**
- The fix is tiny, but it changes process-wide import behavior. If the root cause is also old installed scripts or config resolution logic, this might only solve part of the problem and introduce new risks.

## Part 7: Test Strategy Attack

| Test Gap | Why It's a Gap | Suggested Addition |
|----------|----------------|-------------------|
| No automated tests | Manual-only verification is brittle | Add pytest integration with temp dirs to check wrapper CWD behavior |
| Only happy path tests | Subdir, non-project, symlink not tested | Add tests for subdir and symlinked cwd |
| No Windows/macOS testing | Platform-specific differences | At least document platform limitations or add CI matrix |
| No `ONTOS_PROJECT_ROOT` override test | Overwrite behavior untested | Add test where env var is preset |
| No import shadowing test | PYTHONPATH injection risk | Test when CWD has `ontos_config.py` and `ontos/` |

## Part 8: Verification Protocol Gaps

| Step | Actually Tests the Fix? | Gap? |
|------|------------------------|------|
| Syntax check | No | Does not validate behavior |
| Version check | No | Only confirms bump |
| Native command check | Indirect | Regression only, not fix |
| Wrapper command check | Yes | Only covers `--help` for some commands |
| Test suite | Maybe | Likely lacks integration coverage |

**Protocol Issues:**
- The critical failure mode (subdir + env var override) is not tested.
- No negative tests (non-project dir with stray config) to catch import shadowing.
- No Windows path test, despite subprocess and env changes.

## Part 9: Issues Found

**Critical (Could Cause Failure):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-C1 | `ONTOS_PROJECT_ROOT` set to subdir may short-circuit upward search | Run from `docs/` | Wrapper commands still fail to find `.ontos.toml` |
| X-C2 | PYTHONPATH includes untrusted CWD | Run in repo with malicious `ontos_config.py` or `ontos/` | Arbitrary code execution/import shadowing |
| X-C3 | `Path.cwd()` exception not handled | CWD deleted / permission denied | Wrapper commands crash |

**High (Significant Risk):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-H1 | `ONTOS_PROJECT_ROOT` overwrite breaks explicit targeting | User sets env var intentionally | Wrong project used, confusing outputs |
| X-H2 | Legacy scripts ignore env var | Env var precedence not guaranteed | Fix does not resolve reported bug |

**Medium (Should Consider):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-M1 | Windows path handling untested | Windows users | Wrapper commands still broken on Windows |
| X-M2 | Symlinked CWD mismatch | `pwd` is symlink | Config discovery mismatch |
| X-M3 | `--help` tests don't validate real execution | Only help output | False confidence about fix |

## Part 10: Verdict

**Spec Robustness:** [ ] Robust / [ ] Adequate / [x] Fragile

**Recommendation:** [ ] Approve / [x] Request Changes

**Top 3 Concerns:**
1. `ONTOS_PROJECT_ROOT` forced to CWD may break subdirectory execution and override user intent.
2. Adding arbitrary CWD to `PYTHONPATH` introduces import shadowing and security risks.
3. No automated tests for wrapper CWD behavior; manual checks miss key failure modes.

**The thing most likely to bite us:**
- Wrapper commands still fail from subdirectories because `ONTOS_PROJECT_ROOT` stops upward search, so the "fix" regresses valid workflows.

---
**Review signed by:**
- **Role:** Adversarial Reviewer
- **Model:** Codex (OpenAI)
- **Date:** 2026-01-19
- **Review Type:** Spec Review (Phase B.1)
- **Spec Version:** v1.0
