# v3.0.4 Implementation Prompt for Antigravity (Codex)

**Phase:** C.1 - Implementation
**Risk Level:** LOW
**Files Modified:** 2
**Estimated Changes:** ~15 lines

---

## Overview

This fix resolves the CLI wrapper command CWD bug where `ontos wrap` fails in newly-cloned repositories because the subprocess inherits the package installation directory instead of the user's current working directory.

**Root Cause:** `_get_subprocess_env()` uses `Path(__file__).parent.parent` (package location) instead of `Path.cwd()` (user's project).

---

## Pre-Implementation Checklist

- [ ] Create feature branch: `git checkout -b fix/cli-wrapper-cwd-v304`
- [ ] Verify baseline tests pass: `python -m pytest tests/ -v`
- [ ] Confirm you're working from a clean state: `git status`

---

## Task 1: Update `_get_subprocess_env()`

**File:** `ontos/cli.py` lines 19-32

### Current Code (REPLACE THIS):

```python
def _get_subprocess_env() -> dict:
    """Get environment for subprocess calls with PYTHONPATH set.

    Ensures subprocesses can import from ontos package in source checkouts
    by adding the project root to PYTHONPATH.
    """
    env = os.environ.copy()
    project_root = str(Path(__file__).parent.parent)
    existing_pythonpath = env.get('PYTHONPATH', '')
    if existing_pythonpath:
        env['PYTHONPATH'] = f"{project_root}{os.pathsep}{existing_pythonpath}"
    else:
        env['PYTHONPATH'] = project_root
    return env
```

### New Code (REPLACE WITH):

```python
def _get_subprocess_env() -> dict:
    """Get environment for subprocess calls.

    Sets:
    - ONTOS_PROJECT_ROOT: User's current working directory (for legacy script compatibility)
    - PYTHONPATH: Includes user's project root for config imports
    """
    env = os.environ.copy()
    # Use user's CWD as project root, not package installation directory
    try:
        project_root = str(Path.cwd())
    except OSError:
        # CWD deleted or inaccessible; subprocess will fail gracefully
        project_root = "/"
    env.setdefault('ONTOS_PROJECT_ROOT', project_root)
    # Add project root to PYTHONPATH for legacy config imports
    existing_pythonpath = env.get('PYTHONPATH', '')
    if existing_pythonpath:
        env['PYTHONPATH'] = f"{project_root}{os.pathsep}{existing_pythonpath}"
    else:
        env['PYTHONPATH'] = project_root
    return env
```

**Key Changes:**
1. Changed `Path(__file__).parent.parent` to `Path.cwd()` - uses user's directory
2. Added `try/except OSError` - handles edge case where CWD is deleted
3. Added `env.setdefault('ONTOS_PROJECT_ROOT', project_root)` - for legacy compatibility
4. Updated docstring to reflect new behavior

---

## Task 2: Remove `cwd=` Parameter

**File:** `ontos/cli.py` line 410

### Current Code (REPLACE THIS):

```python
        result = subprocess.run(cmd, capture_output=True, text=True, env=_get_subprocess_env(), cwd=str(Path(__file__).parent.parent))
```

### New Code (REPLACE WITH):

```python
        result = subprocess.run(cmd, capture_output=True, text=True, env=_get_subprocess_env())
```

**Rationale:** The `cwd=` parameter forced subprocess execution in the package directory. Removing it allows subprocess to inherit the user's CWD (the correct behavior).

---

## Task 3: Bump Version

**File:** `ontos/__init__.py` line 10

### Current:
```python
__version__ = "3.0.3"
```

### New:
```python
__version__ = "3.0.4"
```

---

## Post-Implementation Verification

Execute these checks in order:

### 1. Syntax Check
```bash
python -c "import ontos.cli"
```
**Expected:** No output (clean import)

### 2. Version Check
```bash
python -c "import ontos; print(ontos.__version__)"
```
**Expected:** `3.0.4`

### 3. Native Command Regression Test
```bash
ontos status
```
**Expected:** Normal output, no errors

### 4. Wrapper Command Fix Verification

Test in a fresh repository to confirm the fix:

```bash
# Create temporary test directory
cd /tmp
mkdir ontos-test-v304
cd ontos-test-v304
git init

# Test wrapper command
ontos wrap echo "CWD is: \$(pwd)"
```

**Expected Output:**
```
CWD is: /tmp/ontos-test-v304
```

**NOT:**
```
CWD is: /path/to/ontos/package/installation
```

### 5. Test Suite
```bash
python -m pytest tests/ -v
```
**Expected:** All tests pass

### 6. Cleanup
```bash
rm -rf /tmp/ontos-test-v304
```

---

## Commit Strategy

Create 3 atomic commits:

### Commit 1: Core fix
```bash
git add ontos/cli.py
git commit -m "fix(cli): use CWD instead of package path for subprocess env

- Change _get_subprocess_env() to use Path.cwd() instead of Path(__file__)
- Add OSError handling for deleted CWD edge case
- Set ONTOS_PROJECT_ROOT env var for legacy compatibility
- Remove hardcoded cwd= parameter from subprocess.run()

Fixes wrapper commands failing in newly-cloned repositories."
```

### Commit 2: Version bump
```bash
git add ontos/__init__.py
git commit -m "chore: bump version to 3.0.4"
```

### Commit 3: (Optional) Update CHANGELOG if exists
```bash
git add CHANGELOG.md
git commit -m "docs: add v3.0.4 release notes"
```

---

## PR Template

**Branch:** `fix/cli-wrapper-cwd-v304`

**Title:** `fix(cli): resolve wrapper command CWD bug in new repositories`

**Description:**
```markdown
## Summary

Fixes a bug where `ontos wrap` commands fail in newly-cloned repositories because subprocesses were using the package installation directory instead of the user's current working directory.

## Changes

- `ontos/cli.py`: Updated `_get_subprocess_env()` to use `Path.cwd()` instead of `Path(__file__).parent.parent`
- `ontos/cli.py`: Removed hardcoded `cwd=` parameter from `subprocess.run()` call
- `ontos/__init__.py`: Version bump to 3.0.4

## Testing

- [x] Syntax check passes
- [x] Version displays 3.0.4
- [x] Native commands work (regression test)
- [x] Wrapper commands work in fresh repos (bug fix verification)
- [x] Test suite passes

## Risk Assessment

**LOW** - Changes are isolated to subprocess environment setup. No changes to core logic.
```

---

## Rollback Plan

If issues are discovered post-merge:

```bash
git revert HEAD~2..HEAD  # Revert both commits
# OR
git checkout main~2 -- ontos/cli.py ontos/__init__.py
```

---

## References

- Spec: `v3.0.4_Implementation_Spec.md` (Section 5, approved v1.1)
- Bug Report: CLI wrapper CWD issue in fresh repositories
- Review Consolidation: `v3.0.4_Spec_Review_Consolidation.md`
