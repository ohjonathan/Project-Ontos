# v3.0.4 Fix Summary (D.4)

**Date:** 2026-01-19
**Implementer:** Antigravity, powered by Gemini 2.5 Pro
**PR:** https://github.com/ohjona/Project-Ontos/pull/50

---

## B1: Wrapper Commands Crash — FIXED ✅

### Symptom
```bash
cd /tmp && mkdir test && cd test && git init
python3 -m ontos init
python3 -m ontos verify  # CRASHED
# ModuleNotFoundError: No module named 'ontos.core'; 'ontos' is not a package
```

### Root Cause
File `ontos/_scripts/ontos.py` **shadowed the `ontos` package**.

When Python runs a script directly (e.g., `python3 /path/to/ontos/_scripts/ontos_verify.py`), it automatically adds the script's parent directory to `sys.path[0]`. The file `ontos.py` was being imported as the `ontos` module, masking the actual `ontos/` package directory.

### Fix
```bash
git mv ontos/_scripts/ontos.py ontos/_scripts/ontos_legacy_cli.py
```

### Verification
```bash
cd /tmp && rm -rf verify-test && mkdir verify-test && cd verify-test
git init
python3 -m ontos init
python3 -m ontos verify     # ✅ Now works (exit code 0)
python3 -m ontos query      # ✅ Works
python3 -m ontos scaffold   # ✅ Works
python3 -m ontos stub       # ✅ Works
python3 -m ontos promote    # ✅ Works
python3 -m ontos consolidate # ✅ Works
python3 -m ontos migrate    # ✅ Works
```

---

## B2: PYTHONPATH Spec Deviation — Awaiting CA Decision

### Issue
Implementation adds `package_root` to PYTHONPATH, which was not in the approved spec v1.1.

### Spec v1.1 Said
```python
env['PYTHONPATH'] = f"{project_root}{os.pathsep}{existing_pythonpath}"
```

### Current Implementation
```python
path_parts = [project_root, package_root]  # Added package_root
if existing_pythonpath:
    path_parts.append(existing_pythonpath)
env['PYTHONPATH'] = os.pathsep.join(path_parts)
```

### Justification
**Required for correctness.** Without `package_root` in PYTHONPATH, legacy scripts cannot import `ontos.core` when run as subprocesses. The B1 fix only eliminates shadowing—it doesn't solve the import path problem.

### Options
- **A: CA approves deviation** → Amend spec to v1.2
- **B: Revert** → Would break wrapper commands in fresh repos

**Recommendation:** Approve Option A.

---

## Test Results

| Check | Status |
|-------|--------|
| pytest (423 tests) | ✅ Pass |
| Native commands (`doctor`, `map`) | ✅ Pass |
| Wrapper commands (all 7) | ✅ Pass |

---

## Commits

1. `fix(cli): resolve import shadowing in wrapper commands` — Renames `ontos.py` → `ontos_legacy_cli.py`

---

**Ready for D.5: Codex Verification**
