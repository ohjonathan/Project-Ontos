---
id: v3_0_4_cli_wrapper_fix_proposal
type: strategy
status: approved
depends_on: [v3_0_3_implementation_spec]
concepts: [cli, subprocess, wrapper-commands, bug-fix]
---

# v3.0.4 Fix: CLI Commands Don't Work in New Repositories

**Theme:** "Complete CLI Portability - New Repository Support"
**Status:** APPROVED
**Date:** 2026-01-19
**Author:** Claude Opus 4.5 (Chief Architect)

---

## 1. Problem Summary

Running `ontos map` or wrapper commands in a new repository fails with:
- `ModuleNotFoundError: No module named 'ontos_config'`
- Scans wrong directory: `site-packages/docs/` instead of user's project
- Outputs to wrong location: `site-packages/Ontos_Context_Map.md`
- `.ontos.toml` is completely ignored

Users must use `PYTHONPATH="$(pwd)"` or `PYTHONPATH=path/to/source` hacks.

| Impact | Severity | Scope |
|--------|----------|-------|
| First-run experience broken | **P0** | All new Ontos adopters |
| Commands affected | 7 wrapper commands | verify, query, migrate, consolidate, promote, scaffold, stub |
| Fix complexity | **Low** | 2 files, ~10 lines changed |

---

## 2. Root Cause Analysis

**Two distinct issues identified:**

### Issue 1: Outdated Installed Package (User-side)

The user's `site-packages/ontos/` is an older version that routes `python -m ontos map` through the **legacy** script dispatcher (`_scripts/ontos.py` → `_scripts/ontos_generate_context_map.py`).

The legacy script uses `_scripts/ontos_config.py:find_project_root()` which:
```python
# ontos/_scripts/ontos_config.py:27
current = os.path.dirname(os.path.abspath(__file__))  # ← Starts from script location!
```
This starts from `site-packages/ontos/_scripts/` and never finds the user's project.

**Fix**: User needs to reinstall Ontos from current source (`pip install -e .` or `pip install --upgrade`)

### Issue 2: Wrapper Command CWD Bug (Code-side)

Even with the latest version, **wrapper commands** (`verify`, `query`, `migrate`, etc.) have incorrect subprocess invocation:

```python
# ontos/cli.py:410
result = subprocess.run(
    cmd, capture_output=True, text=True,
    env=_get_subprocess_env(),
    cwd=str(Path(__file__).parent.parent)  # ← WRONG: Package dir, not user's project!
)
```

And `_get_subprocess_env()` (lines 19-32) doesn't set `ONTOS_PROJECT_ROOT`:
```python
def _get_subprocess_env() -> dict:
    env = os.environ.copy()
    project_root = str(Path(__file__).parent.parent)  # ← Package dir!
    # Missing: env['ONTOS_PROJECT_ROOT'] = ...
```

### Why Native Commands Work (v3.0.3+)

Native commands (`map`, `init`, `log`, `doctor`, `agents`) use `ontos/io/files.py:find_project_root()`:
```python
# ontos/io/files.py:37-38
if start_path is None:
    start_path = Path.cwd()  # ← Correct: Uses user's CWD!
```

### Command Type Asymmetry

| Command Type | Path Resolution | Status |
|--------------|-----------------|--------|
| **Native** (`map`, `init`, `doctor`, `agents`, `log`) | Uses `Path.cwd()` via `find_project_root()` | Works |
| **Wrapper** (`verify`, `query`, `migrate`, etc.) | Uses `subprocess.run(cwd=package_dir)` | **Broken** |

---

## 3. Solution

### 3.1 User-Side Fix (Required for `ontos map` to work)

Users with an older installed version must reinstall:
```bash
# From Project-Ontos source directory
pip install -e .

# OR upgrade from PyPI (if published)
pip install --upgrade ontos
```

### 3.2 Code Fix Overview

| Change | Location | Lines |
|--------|----------|-------|
| Update `_get_subprocess_env()` | `ontos/cli.py` | 19-32 |
| Update `_cmd_wrapper()` | `ontos/cli.py` | 410 |
| Bump version | `ontos/__init__.py` | 10 |

### 3.3 Code Fix 1: Update `_get_subprocess_env()` (lines 19-32)

**Change from package directory to user's CWD, add `ONTOS_PROJECT_ROOT`:**

```python
def _get_subprocess_env() -> dict:
    """Get environment for subprocess calls.

    Sets:
    - ONTOS_PROJECT_ROOT: User's current working directory (for legacy scripts)
    - PYTHONPATH: Includes user's project root for config imports
    """
    env = os.environ.copy()
    # Use user's CWD as project root, not package installation directory
    project_root = str(Path.cwd())
    env['ONTOS_PROJECT_ROOT'] = project_root
    # Add project root to PYTHONPATH for legacy config imports
    existing_pythonpath = env.get('PYTHONPATH', '')
    if existing_pythonpath:
        env['PYTHONPATH'] = f"{project_root}{os.pathsep}{existing_pythonpath}"
    else:
        env['PYTHONPATH'] = project_root
    return env
```

### 3.4 Code Fix 2: Update `_cmd_wrapper()` (line 410)

**Remove the `cwd=` parameter - subprocess inherits user's CWD:**

```python
# Before:
result = subprocess.run(cmd, capture_output=True, text=True, env=_get_subprocess_env(), cwd=str(Path(__file__).parent.parent))

# After:
result = subprocess.run(cmd, capture_output=True, text=True, env=_get_subprocess_env())
```

### 3.5 Code Fix 3: Bump Version (\_\_init\_\_.py:10)

```python
# Before:
__version__ = "3.0.3"

# After:
__version__ = "3.0.4"
```

---

## 4. Files to Modify

| File | Lines | Change |
|------|-------|--------|
| `ontos/cli.py` | 19-32 | Rewrite `_get_subprocess_env()` to use `Path.cwd()` and set `ONTOS_PROJECT_ROOT` |
| `ontos/cli.py` | 410 | Remove `cwd=str(Path(__file__).parent.parent)` parameter |
| `ontos/__init__.py` | 10 | Bump version `"3.0.3"` → `"3.0.4"` |

---

## 5. Implementation Steps

1. **Edit `ontos/cli.py` lines 19-32**: Rewrite `_get_subprocess_env()`:
   - Change `project_root = str(Path(__file__).parent.parent)` → `project_root = str(Path.cwd())`
   - Add `env['ONTOS_PROJECT_ROOT'] = project_root`
   - Update docstring

2. **Edit `ontos/cli.py` line 410**: In `_cmd_wrapper()`:
   - Remove `, cwd=str(Path(__file__).parent.parent)` from `subprocess.run()` call

3. **Edit `ontos/__init__.py` line 10**: Bump version:
   - Change `__version__ = "3.0.3"` → `__version__ = "3.0.4"`

4. **Reinstall locally** to test:
   ```bash
   pip install -e .
   ```

5. **Run verification tests** (see Section 6)

---

## 6. Verification

### 6.1 Pre-Implementation: Confirm Bug Exists

```bash
cd /tmp && mkdir verify-bug && cd verify-bug
git init
python3 -m ontos init
python3 -m ontos map
# Should see: ModuleNotFoundError: No module named 'ontos_config' (if old version installed)
# Or it should work (if already using source version)
```

### 6.2 Post-Implementation: Full Test

```bash
# 1. Reinstall from source
cd /path/to/Project-Ontos
pip install -e .

# 2. Create fresh test environment
cd /tmp && rm -rf test-v304 && mkdir test-v304 && cd test-v304
git init

# 3. Initialize Ontos
python3 -m ontos init
python3 -m ontos --version
# Expected: ontos 3.0.4

# 4. Create test document
cat > docs/test.md << 'EOF'
---
id: test_doc
type: atom
status: active
---
# Test Document
EOF

# 5. Test native commands
python3 -m ontos map
# Expected: "Context map generated: /tmp/test-v304/Ontos_Context_Map.md"

python3 -m ontos doctor
# Expected: Shows checks for /tmp/test-v304/

# 6. Test wrapper commands (the main fix)
python3 -m ontos verify --help
python3 -m ontos query --help
# Expected: Should show help without ModuleNotFoundError

# 7. Verify context map location
ls -la Ontos_Context_Map.md
# Expected: File exists in /tmp/test-v304/ (not in site-packages)

# 8. Clean up
cd /tmp && rm -rf test-v304
```

### 6.3 Regression Check

```bash
cd /path/to/Project-Ontos
pytest tests/ -v --ignore=tests/golden/
```

---

## 7. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Regression in native commands | Low | High | Native commands don't use `_get_subprocess_env()` |
| Breaking source checkouts | Low | Medium | PYTHONPATH still includes project root |
| Edge case: non-project dir | Low | Low | Behavior unchanged - still fails gracefully |

**Overall Risk: LOW** - Changes are isolated to subprocess invocation

---

## 8. Future Improvement (v3.1+)

Migrate all wrapper commands to native Python implementations (like `map_command()`). This eliminates:
- Subprocess overhead
- Config loading complexity
- The need for `ONTOS_PROJECT_ROOT` env var

| Command | Priority | Complexity |
|---------|----------|------------|
| `verify` | High | Medium |
| `query` | High | Low |
| `consolidate` | Medium | Low |

---

## 9. References

- Implementation spec: `.ontos-internal/strategy/proposals/v3.0.4/v3.0.4_Implementation_Spec.md`

---

*Claude Opus 4.5 - 2026-01-19*
