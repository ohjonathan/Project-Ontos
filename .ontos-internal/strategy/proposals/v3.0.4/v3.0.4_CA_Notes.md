---
id: v3_0_4_chief_architect_notes
type: strategy
status: active
depends_on: [phase_v3_0_4_implementation_spec]
concepts: [chief-architect, review-notes, implementation-decisions]
---

# v3.0.4 Chief Architect Notes

**Author:** Claude Opus 4.5 (Chief Architect)
**Date:** 2026-01-19
**Spec Version:** Phase-v3.0.4-Implementation-Spec.md v1.0

---

## 1. Deviations from Draft Proposal

### 1.1 Wrapper Command Status Correction

**Draft Proposal Claim:** Some wrapper commands were marked "Working" while others needed "FIXING" (verify, query, consolidate).

**Correction:** All 7 wrapper commands (`verify`, `query`, `migrate`, `consolidate`, `promote`, `scaffold`, `stub`) use the **same** `_cmd_wrapper()` function. They all have the identical bug. The v3.0.3 spec incorrectly claimed some were working.

**Evidence:**
- All 7 commands route through `_cmd_wrapper()` at line 410
- The `cwd=str(Path(__file__).parent.parent)` parameter affects all equally
- v3.0.2 fix (sys.path in scripts) was necessary but not sufficient

**Resolution:** All 7 are now marked as **FIXED** in the spec.

### 1.2 Earlier Spec Version Discrepancy

**Draft v3.0.4_Implementation_Spec.md (v1.1):** Claimed only 3 commands fixed.

**This Spec (v1.0):** Correctly identifies all 7 wrapper commands as fixed.

The earlier spec version was incomplete. This version supersedes it.

---

## 2. Concerns & Caveats

### 2.1 PYTHONPATH Includes User's CWD

**Change:** The fix adds the user's CWD to `PYTHONPATH`.

**Concern:** Could theoretically cause import conflicts if user has a module named `ontos` in their project root.

**Assessment:** LOW RISK
- This is the same pattern used by editable installs (`pip install -e .`)
- Users with a local `ontos/` directory would shadow the package regardless
- The fix is required for `ontos_config.py` imports to work

**Decision:** Accept. The benefit (working commands) outweighs the edge case.

### 2.2 Legacy Script Architecture Debt

**Observation:** This fix is a band-aid. The real solution is migrating all wrapper commands to native Python implementations (v3.1+ roadmap).

**Current State:**
- 6 native commands: work correctly, use `Path.cwd()` via `find_project_root()`
- 7 wrapper commands: need subprocess + env vars + path manipulation

**Recommendation:** Track this as technical debt. Prioritize native migration in v3.1.

### 2.3 No Automated Tests for This Fix

**Gap:** The manual verification protocol is comprehensive but manual.

**Reason:** Testing subprocess CWD behavior in pytest is complex because:
1. Tests run from the repo root (not a fresh directory)
2. Mocking `Path.cwd()` doesn't test the real behavior
3. Integration tests would need to create temp directories

**Mitigation:**
- Manual verification protocol covers all scenarios
- The fix is simple and well-understood
- Regression risk is low (native commands unaffected)

**Future:** Consider adding integration tests in v3.1 when wrapper commands are refactored.

---

## 3. Decisions Made & Rationale

### 3.1 Use `Path.cwd()` Instead of Config-Based Root

**Decision:** Use `Path.cwd()` directly rather than trying to find `.ontos.toml` first.

**Alternatives Considered:**
1. Use `find_project_root()` from `io/files.py`
2. Require `ONTOS_PROJECT_ROOT` to be set externally
3. Use `Path.cwd()` (chosen)

**Rationale:**
- Option 1: Would require importing from `ontos.io.files` in `_get_subprocess_env()`, adding a dependency that could cause import order issues
- Option 2: Shifts burden to user, poor UX
- Option 3: Simple, matches how native commands work, no import dependencies

### 3.2 Set `ONTOS_PROJECT_ROOT` Unconditionally

**Decision:** Always set `ONTOS_PROJECT_ROOT` in subprocess environment.

**Alternative:** Only set if not already set (`env.setdefault()`).

**Rationale:**
- The CWD at subprocess invocation time is the authoritative project location
- If user explicitly set `ONTOS_PROJECT_ROOT`, they can override via CLI or config
- Simplicity wins: one source of truth (CWD at invocation)

### 3.3 Remove `cwd=` Parameter Entirely

**Decision:** Remove `cwd=` from `subprocess.run()` rather than changing its value.

**Alternative:** Change to `cwd=str(Path.cwd())`.

**Rationale:**
- When `cwd=` is omitted, subprocess inherits the parent's CWD
- This is the correct behavior: subprocess runs where user invoked CLI
- Explicit `cwd=Path.cwd()` is redundant and less clear
- Simpler code = fewer bugs

---

## 4. Verification Checklist (Pre-Review)

| Item | Status | Notes |
|------|--------|-------|
| Code changes are minimal and isolated | Yes | 2 files, ~15 lines |
| Root cause is verified | Yes | `Path(__file__).parent.parent` confirmed |
| Fix aligns with native command behavior | Yes | Uses same `Path.cwd()` pattern |
| Backward compatibility maintained | Yes | No behavior changes for working commands |
| Edge cases documented | Yes | Section 7 of spec |
| Manual verification protocol complete | Yes | Section 6.3 of spec |

---

## 5. Open Items for Review Board

1. **Approve spec status change:** Draft â†’ Approved
2. **Confirm commit message:** `fix(cli): resolve wrapper command CWD bug in new repos`
3. **Verify no outstanding questions:** None identified

---

*Chief Architect: Claude Opus 4.5*
*Date: 2026-01-19*
