# Chief Architect: Spec Review Response

**Project:** Ontos v3.0.5
**Phase:** B.3 (Spec Review Response)
**Purpose:** Address review board findings and update spec
**Date:** 2026-01-20

---

## Part 1: Blocking Issue Response

### B1: VER-1 Targets "3.0.4" Instead of "3.0.5"

**Decision:** ACCEPT

I will update all references from "3.0.4" to "3.0.5" in spec v1.1.

**Acknowledgment:** This was an oversight. The spec was written to fix the *previous* mismatch (3.0.3 → 3.0.4) without accounting for the fact that v3.0.5 is the release being shipped. Shipping v3.0.5 with `ONTOS_VERSION="3.0.4"` would immediately recreate the version mismatch problem.

**Changes in v1.1:**

| Section | v1.0 | v1.1 |
|---------|------|------|
| 3.1 VER-1 New Code | `ONTOS_VERSION = "3.0.4"` | `ONTOS_VERSION = "3.0.5"` |
| 5.1 Verification grep | `# Expected: No matches for 3.0.3` | `# Expected: No matches for 3.0.4` |
| 9 Checklist | `Update to "3.0.4"` | `Update to "3.0.5"` |
| 10 Commit message | `Sync legacy script version to 3.0.4` | `Sync legacy script version to 3.0.5` |

---

## Part 2: Non-Blocking Recommendations

| # | Issue | Decision | Rationale |
|---|-------|----------|-----------|
| N1 | MCP Warning | **Keep FutureWarning** | Semantically correct—this placeholder *will* become real functionality in Phase 2. `FutureWarning` signals "coming soon" rather than "going away." |
| N2 | Ctrl+C Semantics | **Abort init** | Users universally expect Ctrl+C to abort operations. Partial success (config created, hooks skipped) violates principle of least surprise. |
| N3 | Terminology | **Accept** | "Behavioral Change" accurately describes the addition of a consent prompt. Nothing is removed or broken. |
| N4 | Script/CI Clarity | **Accept** | Will clarify that only TTY-attached scripts need `--yes`. Piped/backgrounded scripts proceed automatically. |
| N5 | UX-1 Confirmation | **Confirmed** | Spec accurately implements ChatGPT challenge resolution: preflight message, TTY prompt, `--yes` flag, default=Yes for BC, non-TTY proceeds. |
| N6 | stacklevel | **Verify during implementation** | Will test actual call stack depth during implementation. Default `stacklevel=2` is standard for warnings in `__init__.py`. |
| N7 | Ctrl+C Test | **Add to spec** | Important edge case. Will add test for KeyboardInterrupt behavior. |

---

## Part 3: Detailed Responses

### N1: MCP Warning Visibility

**Decision:** Keep FutureWarning

**Rationale:**
- `FutureWarning` is semantically correct—the MCP module is a placeholder for *future* functionality
- `UserWarning` or `DeprecationWarning` would be misleading (module isn't deprecated, it's not-yet-implemented)
- Users who explicitly import `ontos.mcp` are power users who will see warnings
- Python's default warning filters show `FutureWarning` in `__main__`

**No spec change required.**

---

### N2: Ctrl+C Semantics

**Decision:** Abort init (re-raise KeyboardInterrupt)

**Rationale:**
- Users expect Ctrl+C to abort operations entirely
- Partial success state (config exists, hooks skipped) is confusing
- Clear abort with message is better than silent partial completion
- User can re-run with explicit `--skip-hooks` if that's their intent

**Spec Change:** Update `_confirm_hooks()` exception handling:

```python
    except (EOFError, KeyboardInterrupt):
        print("\nAborted.")
        raise  # Re-raise to abort init entirely
```

**Additional Change:** Update `init_command` to handle the re-raised exception appropriately, returning exit code 130 (standard for SIGINT).

---

### N3: Terminology — "Breaking Change" vs "Behavioral Change"

**Decision:** Accept

**Spec Change:** Section 7.1 heading changes from "Breaking Change Note" to "Behavioral Change Note"

---

### N4: Script/CI Clarity

**Decision:** Accept

**Updated Text for Section 7.1:**

> **Behavioral Change Note**
>
> Scripts that run `ontos init` interactively (with TTY stdin attached) will now see a confirmation prompt. To preserve non-interactive behavior:
> - Use `--yes` flag: `ontos init --yes`
> - Use `--skip-hooks` flag: `ontos init --skip-hooks`
> - Run without TTY: `ontos init < /dev/null`
>
> Scripts run via CI pipelines, cron jobs, or with redirected stdin automatically proceed without prompts.

---

### N5: UX-1 Scope Expansion Confirmation

**Confirmation:** Yes, the spec accurately implements the ChatGPT challenge resolution.

**Evidence:** The challenge resolution (`v3.0.5_Triage_Validation_ChatGPT.md`) explicitly approved:
- Preflight message listing hooks ✓
- TTY confirmation prompt ✓
- `--yes` flag for non-interactive mode ✓
- Default answer = Yes (backward compatible) ✓
- Non-TTY contexts proceed without prompt ✓

The spec faithfully implements all five requirements.

---

### N6: stacklevel Verification

**Decision:** Verify during implementation

**Note:** The warning is emitted directly in `ontos/mcp/__init__.py`. When a user writes `from ontos import mcp`, the call stack is:
1. User code (`from ontos import mcp`)
2. `ontos/mcp/__init__.py` (warning emitted here)

With `stacklevel=2`, the warning will point to the user's import statement, which is the correct behavior. Will verify during implementation and adjust if needed.

---

### N7: Add Ctrl+C Test

**Decision:** Add test to spec

**New Test Case:**
```python
    def test_ctrl_c_aborts_init(self, git_repo, monkeypatch):
        """Ctrl+C during hook confirmation aborts entire init."""
        # Simulate KeyboardInterrupt during input()
        def mock_input(prompt):
            raise KeyboardInterrupt()
        monkeypatch.setattr('builtins.input', mock_input)
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo)

        with pytest.raises(KeyboardInterrupt):
            init_command(options)

        # Config should NOT exist (init aborted)
        assert not (git_repo / ".ontos.toml").exists()
```

**Note:** This test requires that the KeyboardInterrupt propagate before config is written. The current implementation writes config at step 4, before hook confirmation at step 7. Two options:

1. **Reorder steps:** Move hook confirmation earlier (before config write)
2. **Cleanup on abort:** Delete config if hook confirmation is aborted

**Recommendation:** Option 2 (cleanup on abort) is less invasive. Add cleanup logic to `init_command` when KeyboardInterrupt is caught.

---

## Part 4: Spec v1.1 Changelog

| Section | Change | Reason |
|---------|--------|--------|
| Header | Version 1.0 → 1.1 | Review board feedback incorporated |
| 3.1 VER-1 | "3.0.4" → "3.0.5" | B1: Version must match release |
| 3.3.4 | Updated KeyboardInterrupt handling | N2: Abort entire init on Ctrl+C |
| 3.4 | Added Ctrl+C test case | N7: Test edge case |
| 5.1 | Updated verification grep | B1: Check for 3.0.4, not 3.0.3 |
| 7.1 | "Breaking Change" → "Behavioral Change" | N3: Accurate terminology |
| 7.1 | Clarified TTY-attached script behavior | N4: Disambiguation |
| 9 | Updated checklist version target | B1: Sync with v1.1 changes |
| 10 | Updated commit message | B1: Sync with v1.1 changes |

---

## Part 5: Implementation Notes

### Ctrl+C Handling Architecture

The Ctrl+C abort requires careful handling because config is written before hook confirmation. Recommended approach:

```python
def init_command(options: InitOptions) -> Tuple[int, str]:
    # ... steps 1-6 (config, directories, context map) ...

    # 7. Install hooks (with collision safety and consent)
    try:
        if _confirm_hooks(options):
            hooks_status = _install_hooks(project_root, options)
        else:
            hooks_status = 0  # Skipped by user choice
    except KeyboardInterrupt:
        # Cleanup partial initialization
        config_path = project_root / ".ontos.toml"
        if config_path.exists():
            config_path.unlink()
        print("\nInit aborted. No changes made.")
        raise  # Re-raise for exit code 130

    # ... step 8-9 ...
```

This ensures clean abort state regardless of when Ctrl+C is pressed.

---

*Chief Architect — 2026-01-20*
