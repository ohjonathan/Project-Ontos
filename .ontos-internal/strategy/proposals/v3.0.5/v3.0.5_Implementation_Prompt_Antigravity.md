# Phase C: Implementation Prompt — Antigravity

**Project:** Ontos v3.0.5
**Phase:** C (Implementation)
**Theme:** Tech Debt Patching + UX Improvement
**Model:** Codex (OpenAI)
**Date:** 2026-01-20

---

## Your Role

You are **Antigravity** (Developer). Your job is to implement the v3.0.5 spec exactly as written.

**Rules:**
1. Follow the spec literally — do not improvise
2. If something is unclear, flag it — do not guess
3. Run tests after each change
4. Commit at checkpoints
5. Create a PR when complete

---

## Context

**Release:** v3.0.5 (Patch/Polish)
**Spec Version:** 1.1 (Review board approved)
**Branch:** `fix/v3.0.5-tech-debt-ux`

**Scope:**
| ID | Issue | Summary |
|----|-------|---------|
| VER-1 | Version string mismatch | Update legacy constant to "3.0.5" |
| MCP-1 | MCP extra is no-op | Add import warning |
| UX-1 | Init hooks consent | TTY confirmation + `--yes` flag + Ctrl+C abort |
| WRP-1 | Wrapper command testing | Test all 7 wrappers, document |
| UX-2 | Known Issues outdated | Update README |

---

## Pre-Implementation Checklist

```bash
# 1. Verify you're on main and up to date
git checkout main
git pull origin main

# 2. Create feature branch
git checkout -b fix/v3.0.5-tech-debt-ux

# 3. Verify tests pass before changes
pytest tests/ -v

# 4. Verify current state
grep -r "3.0.3\|3.0.4" ontos/  # Check version strings
python -c "from ontos import mcp"  # Should not warn yet
```

---

## Task Sequence

### Task 1: VER-1 — Version String Fix

**Priority:** P0
**Effort:** Trivial
**Risk:** None

**File:** `ontos/_scripts/ontos_config_defaults.py`

**Current Code (Line 56):**
```python
ONTOS_VERSION = "3.0.3"
```

**New Code:**
```python
ONTOS_VERSION = "3.0.5"
```

**Steps:**
1. Open `ontos/_scripts/ontos_config_defaults.py`
2. Find line 56: `ONTOS_VERSION = "3.0.3"`
3. Change to `ONTOS_VERSION = "3.0.5"`
4. Save

**Verification:**
```bash
# Should return "3.0.5"
python -c "from ontos._scripts.ontos_config_defaults import ONTOS_VERSION; print(ONTOS_VERSION)"

# Should find no matches for old versions
grep -r "3.0.3\|3.0.4" ontos/_scripts/
```

**Commit:**
```bash
git add ontos/_scripts/ontos_config_defaults.py
git commit -m "fix(version): sync legacy ONTOS_VERSION to 3.0.5

VER-1: Legacy scripts now report correct version."
```

---

### Task 2: MCP-1 — MCP Import Warning

**Priority:** P0
**Effort:** Low
**Risk:** None

**File:** `ontos/mcp/__init__.py`

**Current Code:**
```python
"""MCP module - Placeholder for Phase 2."""
```

**New Code:**
```python
"""MCP module - Placeholder for Phase 2."""
import warnings

warnings.warn(
    "The 'ontos.mcp' module is a placeholder for Phase 2. "
    "No functionality is currently available.",
    FutureWarning,
    stacklevel=2
)
```

**Steps:**
1. Open `ontos/mcp/__init__.py`
2. Add the import and warning after the docstring
3. Save

**Verification:**
```bash
# Should emit FutureWarning
python -W all -c "from ontos import mcp"

# Expected output (stderr):
# <string>:1: FutureWarning: The 'ontos.mcp' module is a placeholder for Phase 2. No functionality is currently available.
```

**Note:** Verify `stacklevel=2` points to the user's import statement, not internal code. Adjust if needed.

**Commit:**
```bash
git add ontos/mcp/__init__.py
git commit -m "fix(mcp): add FutureWarning for placeholder module

MCP-1: Users importing ontos.mcp now see a clear warning that
the module is a placeholder with no current functionality."
```

---

### Task 3: UX-1 — Init Hooks Consent

**Priority:** P0
**Effort:** Low
**Risk:** Low (behavioral change, BC preserved)

This task has multiple sub-steps.

#### Task 3.1: Add `--yes` Flag to CLI

**File:** `ontos/cli.py`

**Find (around lines 103-111):**
```python
def _register_init(subparsers, parent):
    """Register init command."""
    p = subparsers.add_parser("init", help="Initialize Ontos in a project", parents=[parent])
    p.add_argument("--force", "-f", action="store_true",
                   help="Overwrite existing config and hooks")
    p.add_argument("--skip-hooks", action="store_true",
                   help="Don't install git hooks")
    p.set_defaults(func=_cmd_init)
```

**Replace with:**
```python
def _register_init(subparsers, parent):
    """Register init command."""
    p = subparsers.add_parser("init", help="Initialize Ontos in a project", parents=[parent])
    p.add_argument("--force", "-f", action="store_true",
                   help="Overwrite existing config and hooks")
    p.add_argument("--skip-hooks", action="store_true",
                   help="Don't install git hooks")
    p.add_argument("--yes", "-y", action="store_true",
                   help="Non-interactive mode: accept all defaults")
    p.set_defaults(func=_cmd_init)
```

#### Task 3.2: Update `_cmd_init` to Pass `yes` Flag

**File:** `ontos/cli.py`

**Find (around lines 234-240):**
```python
    options = InitOptions(
        path=Path.cwd(),
        force=args.force,
        skip_hooks=getattr(args, "skip_hooks", False),
    )
```

**Replace with:**
```python
    options = InitOptions(
        path=Path.cwd(),
        force=args.force,
        skip_hooks=getattr(args, "skip_hooks", False),
        yes=getattr(args, "yes", False),
    )
```

#### Task 3.3: Update `InitOptions` Dataclass

**File:** `ontos/commands/init.py`

**Find (around lines 14-21):**
```python
@dataclass
class InitOptions:
    """Configuration for init command."""
    path: Path = None
    force: bool = False
    interactive: bool = False  # Reserved for v3.1
    skip_hooks: bool = False
```

**Replace with:**
```python
@dataclass
class InitOptions:
    """Configuration for init command."""
    path: Path = None
    force: bool = False
    interactive: bool = False  # Reserved for v3.1
    skip_hooks: bool = False
    yes: bool = False
```

#### Task 3.4: Add `_confirm_hooks()` Function

**File:** `ontos/commands/init.py`

**Insert after the `InitOptions` dataclass (before `init_command`):**
```python
def _confirm_hooks(options: InitOptions) -> bool:
    """Confirm hook installation with user in TTY contexts.

    Returns:
        True if hooks should be installed, False otherwise.

    Raises:
        KeyboardInterrupt: If user presses Ctrl+C (aborts entire init)

    Behavioral matrix:
        skip_hooks=True  -> False (user explicitly skipped)
        yes=True         -> True  (non-interactive mode)
        non-TTY          -> True  (CI/scripts proceed)
        TTY              -> prompt user
    """
    if options.skip_hooks:
        return False  # User explicitly skipped
    if options.yes:
        return True   # Non-interactive mode
    if not sys.stdin.isatty():
        return True   # Non-TTY: proceed (CI/scripts)

    # Print preflight message
    print("\nGit hooks to be installed:")
    print("  - pre-commit: Validates documentation before commits")
    print("  - pre-push: Ensures context map exists before push")
    print("\nHooks location: .git/hooks/")
    print("Use --skip-hooks to skip installation.\n")

    try:
        response = input("Install git hooks? [Y/n] ").strip().lower()
        return response in ('', 'y', 'yes')
    except EOFError:
        print("\nSkipping hooks.")
        return False
    except KeyboardInterrupt:
        print("\nAborted.")
        raise  # Re-raise to abort init entirely
```

**Note:** Verify `sys` is imported at the top of the file. If not, add `import sys`.

#### Task 3.5: Update `init_command` to Use `_confirm_hooks()`

**File:** `ontos/commands/init.py`

**Find (around lines 63-64):**
```python
    # 7. Install hooks (with collision safety)
    hooks_status = _install_hooks(project_root, options)
```

**Replace with:**
```python
    # 7. Install hooks (with collision safety and consent)
    try:
        if _confirm_hooks(options):
            hooks_status = _install_hooks(project_root, options)
        else:
            hooks_status = 0  # Skipped by user choice
    except KeyboardInterrupt:
        # Cleanup partial initialization on Ctrl+C
        config_path = project_root / ".ontos.toml"
        if config_path.exists():
            config_path.unlink()
        print("Init aborted. No changes made.")
        return 130, "Aborted by user"  # Standard SIGINT exit code
```

#### Task 3.6: Verification
```bash
# Test 1: Check --help shows new flag
ontos init --help
# Should show: --yes, -y  Non-interactive mode: accept all defaults

# Test 2: TTY prompt (run in terminal)
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
ontos init
# Expected: Shows preflight message + "Install git hooks? [Y/n]"
# Type 'n' to skip

# Test 3: --yes flag
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
ontos init --yes
ls -la .git/hooks/pre-commit
# Expected: Hook file exists, no prompt shown

# Test 4: --skip-hooks
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
ontos init --skip-hooks
ls -la .git/hooks/
# Expected: No ontos hooks, no prompt

# Test 5: Non-TTY (CI simulation)
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
echo "" | ontos init
ls -la .git/hooks/pre-commit
# Expected: Hook file exists, no prompt shown

# Test 6: Ctrl+C aborts (manual test)
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
ontos init
# Press Ctrl+C at prompt
# Expected: "Aborted." message, no .ontos.toml created
ls .ontos.toml  # Should not exist

# Cleanup
cd /tmp && rm -rf test-ux1

# Run existing tests
pytest tests/commands/test_init*.py -v
```

**Commit:**
```bash
git add ontos/cli.py ontos/commands/init.py
git commit -m "feat(init): add hook consent prompt with --yes flag

UX-1: Users now see a preflight message and confirmation prompt
before git hooks are installed in TTY contexts.

- Add --yes/-y flag for non-interactive mode
- Add _confirm_hooks() with TTY detection
- --skip-hooks takes precedence over --yes
- CI/scripts (non-TTY) proceed without prompt
- Ctrl+C aborts entire init with cleanup
- Default answer is Yes (backward compatible)"
```

---

### Task 4: UX-1 Tests — Add Confirmation Flow Tests

**Priority:** P1
**Effort:** Low
**Risk:** None

**File:** `tests/commands/test_init_phase3.py`

**Append to file:**
```python
class TestHookConfirmation:
    """Tests for hook confirmation flow (v3.0.5 UX-1)."""

    def test_skip_hooks_flag_skips_confirmation(self, git_repo):
        """--skip-hooks bypasses confirmation entirely."""
        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)

        assert code == 0
        # No hooks should be installed
        pre_commit = git_repo / ".git" / "hooks" / "pre-commit"
        if pre_commit.exists():
            assert ONTOS_HOOK_MARKER not in pre_commit.read_text()

    def test_yes_flag_skips_confirmation(self, git_repo):
        """--yes installs hooks without prompting."""
        options = InitOptions(path=git_repo, yes=True)
        code, _ = init_command(options)

        assert code in (0, 3)  # 0 success, 3 if collision
        # In clean repo, hooks should be installed
        if code == 0:
            pre_commit = git_repo / ".git" / "hooks" / "pre-commit"
            assert pre_commit.exists()
            assert ONTOS_HOOK_MARKER in pre_commit.read_text()

    def test_skip_hooks_wins_over_yes(self, git_repo):
        """--skip-hooks takes precedence over --yes."""
        options = InitOptions(path=git_repo, skip_hooks=True, yes=True)
        code, _ = init_command(options)

        assert code == 0
        pre_commit = git_repo / ".git" / "hooks" / "pre-commit"
        if pre_commit.exists():
            assert ONTOS_HOOK_MARKER not in pre_commit.read_text()

    def test_ctrl_c_aborts_init(self, git_repo, monkeypatch):
        """Ctrl+C during hook confirmation aborts entire init."""
        # Simulate KeyboardInterrupt during input()
        def mock_input(prompt):
            raise KeyboardInterrupt()
        monkeypatch.setattr('builtins.input', mock_input)
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo)
        code, msg = init_command(options)

        # Should return SIGINT exit code
        assert code == 130
        assert "Aborted" in msg

        # Config should NOT exist (init aborted and cleaned up)
        assert not (git_repo / ".ontos.toml").exists()
```

**Note:** Ensure `ONTOS_HOOK_MARKER` is imported at the top of the file. Check existing imports.

**Verification:**
```bash
pytest tests/commands/test_init_phase3.py::TestHookConfirmation -v
```

**Commit:**
```bash
git add tests/commands/test_init_phase3.py
git commit -m "test(init): add hook confirmation flow tests

UX-1: Tests for --skip-hooks, --yes, precedence, and Ctrl+C abort behavior."
```

---

### Task 5: WRP-1 — Wrapper Command Testing

**Priority:** P1
**Effort:** Medium
**Risk:** None (testing only)

**Purpose:** Test all 7 wrapper commands and document their behavior.

**Commands to Test:**
```bash
# Test each with --help
ontos verify --help
ontos query --help
ontos consolidate --help
ontos migrate --help
ontos promote --help
ontos scaffold --help
ontos stub --help

# Test basic execution (in the Ontos repo itself)
ontos verify
ontos query --help  # May need specific args
ontos consolidate
ontos migrate --help  # May need specific args
ontos promote
ontos scaffold
ontos stub --help  # May need specific args
```

**Document Results:**

Fill in the following table based on test results:

| Command | --help works | Basic Execution | Limitations |
|---------|--------------|-----------------|-------------|
| verify | ✅/❌ | ✅/⚠️/❌ | [Notes] |
| query | ✅/❌ | ✅/⚠️/❌ | [Notes] |
| consolidate | ✅/❌ | ✅/⚠️/❌ | [Notes] |
| migrate | ✅/❌ | ✅/⚠️/❌ | [Notes] |
| promote | ✅/❌ | ✅/⚠️/❌ | [Notes] |
| scaffold | ✅/❌ | ✅/⚠️/❌ | [Notes] |
| stub | ✅/❌ | ✅/⚠️/❌ | [Notes] |

**Common Limitations to Check:**
- Does command show deprecation warning?
- Does command require specific arguments?
- Does command work in non-TTY context?
- Does command honor `.ontos.toml` config?
- Does command crash or error unexpectedly?

**No commit yet** — Results feed into UX-2.

---

### Task 6: UX-2 — Update README Known Issues

**Priority:** P2
**Effort:** Low
**Risk:** None
**Depends on:** WRP-1 results

**File:** `README.md`

**Find (around lines 216-219):**
```markdown
## Known Issues (v3.0.4)

No known critical issues as of 2026-01-19. See [Changelog](https://github.com/ohjona/Project-Ontos/blob/main/Ontos_CHANGELOG.md) and [Issues](https://github.com/ohjona/Project-Ontos/issues) for updates.
```

**Replace with (fill in based on WRP-1 findings):**
```markdown
## Known Issues (v3.0.5)

### Wrapper Commands

Some commands delegate to legacy scripts and may have limitations:

| Command | Status | Notes |
|---------|--------|-------|
| `verify` | [Status] | [Notes from WRP-1] |
| `query` | [Status] | [Notes from WRP-1] |
| `consolidate` | [Status] | [Notes from WRP-1] |
| `migrate` | [Status] | [Notes from WRP-1] |
| `promote` | [Status] | [Notes from WRP-1] |
| `scaffold` | [Status] | [Notes from WRP-1] |
| `stub` | [Status] | [Notes from WRP-1] |

**Workaround:** For full functionality, use native commands: `map`, `doctor`, `agents`, `log`, `init`.

### Configuration

Legacy wrapper commands do not honor `.ontos.toml` configuration. This will be addressed in v3.1.

See [Changelog](https://github.com/ohjona/Project-Ontos/blob/main/Ontos_CHANGELOG.md) and [Issues](https://github.com/ohjona/Project-Ontos/issues) for updates.
```

**Verification:**
- Read through the Known Issues section
- Ensure it accurately reflects WRP-1 findings
- Ensure version number is v3.0.5

**Commit:**
```bash
git add README.md
git commit -m "docs: update Known Issues for v3.0.5

WRP-1/UX-2: Document wrapper command status and limitations.
Legacy commands do not honor .ontos.toml (deferred to v3.1)."
```

---

## Final Verification

```bash
# 1. Run full test suite
pytest tests/ -v

# 2. Verify all changes
git diff main --stat

# 3. Check for version string consistency
grep -r "3.0.3\|3.0.4" ontos/
# Expected: No matches

# 4. Verify MCP warning
python -W all -c "from ontos import mcp"

# 5. Verify init --help
ontos init --help
# Should show --yes flag

# 6. Final smoke test
cd /tmp && rm -rf final-test && mkdir final-test && cd final-test && git init
ontos init --yes
ontos doctor
cd /tmp && rm -rf final-test
```

---

## PR Preparation

**Branch:** `fix/v3.0.5-tech-debt-ux`

**PR Title:** `fix: v3.0.5 — Tech Debt Patching + UX Improvement`

**PR Description:**
```markdown
## Summary

v3.0.5 patch release addressing tech debt and UX improvements.

## Changes

### VER-1: Version String Fix
- Updated `ONTOS_VERSION` in legacy scripts to "3.0.5"

### MCP-1: MCP Import Warning
- Added `FutureWarning` when importing placeholder `ontos.mcp` module

### UX-1: Init Hooks Consent
- Added preflight message showing hooks to be installed
- Added TTY confirmation prompt: `Install git hooks? [Y/n]`
- Added `--yes/-y` flag for non-interactive mode
- CI/scripts (non-TTY) proceed without prompt
- `--skip-hooks` takes precedence over `--yes`
- Ctrl+C aborts entire init and cleans up partial state

### WRP-1: Wrapper Command Testing
- Tested all 7 wrapper commands
- Documented status and limitations

### UX-2: Known Issues Update
- Updated README Known Issues for v3.0.5
- Documented wrapper command limitations

## Testing

- [x] All existing tests pass
- [x] New tests added for hook confirmation flow (including Ctrl+C)
- [x] Manual verification of TTY prompt behavior
- [x] Manual verification of --yes and --skip-hooks flags
- [x] Manual verification of Ctrl+C abort behavior

## Checklist

- [x] VER-1: Version constant updated
- [x] MCP-1: Warning emits on import
- [x] UX-1: Consent flow works in TTY
- [x] UX-1: --yes bypasses prompt
- [x] UX-1: --skip-hooks takes precedence
- [x] UX-1: Non-TTY proceeds without prompt
- [x] UX-1: Ctrl+C aborts and cleans up
- [x] WRP-1: All wrappers tested
- [x] UX-2: README updated
```

**Create PR:**
```bash
git push -u origin fix/v3.0.5-tech-debt-ux
gh pr create --title "fix: v3.0.5 — Tech Debt Patching + UX Improvement" --body-file pr_body.md
```

---

## Blockers / Questions

If you encounter any of the following, **stop and flag**:

1. Line numbers don't match spec
2. `ONTOS_HOOK_MARKER` constant not found in test file
3. `sys` not already imported in `init.py`
4. Any test failures before your changes
5. Wrapper commands crash in unexpected ways
6. Ctrl+C test doesn't work as expected (mock not triggering)

---

## Reference Documents

- **Spec:** `.ontos-internal/strategy/proposals/v3.0.5/v3.0.5_Implementation_Spec.md` (v1.1)
- **CA Response:** `.ontos-internal/strategy/proposals/v3.0.5/v3.0.5_Spec_Review_Response_CA.md`
- **Triage Response:** `.ontos-internal/strategy/proposals/v3.0.5/v3.0.5_Chief_Architect_Triage_Response.md`

---

*Phase C Implementation Prompt — Antigravity*
*v3.0.5 | 2026-01-20*
