# Phase D.2: Code Review — Adversarial Reviewer

**Project:** Ontos v3.0.5
**Phase:** D.2 (Code Review)
**Role:** Adversarial Reviewer
**Model:** Codex (OpenAI)
**Date:** 2026-01-20

---

## Your Role

You are the **Adversarial Reviewer**. Hunt for bugs, edge cases, and regressions.

---

## Focus Areas

1. **Regressions** — Did changes break existing functionality?
2. **Edge cases** — Are unusual inputs handled?
3. **Error handling** — What happens when things fail?
4. **Test adequacy** — Do tests actually catch issues?

---

## Input

**PR:** #[N] `fix/v3.0.5-tech-debt-ux`
**Spec:** v3.0.5-Implementation-Spec.md (v1.1)

---

## Review Template

### Part 1: Regression Hunt
````bash
# Run full test suite
pytest tests/ -v

# Specific regression tests
pytest tests/commands/test_init*.py -v
````

| Area | Regression Found? | Evidence |
|------|-------------------|----------|
| `ontos init` basic | Not run | Code inspection only; prompt added only for TTY paths. |
| `ontos init --skip-hooks` | Not run | `_confirm_hooks` short-circuits on skip flag. `ontos/commands/init.py:39-41` |
| `ontos init --force` | Not run | No logic changes in force path. |
| MCP import | Not run | Import emits FutureWarning on module load. `ontos/mcp/__init__.py:1-8` |
| Version reporting | Not run | `ONTOS_VERSION = "3.0.5"`. `ontos/_scripts/ontos_config_defaults.py:41` |

### Part 2: Edge Case Testing

Test the implementation against edge cases:
````bash
# Ctrl+C during prompt
cd /tmp && rm -rf edge-test && mkdir edge-test && cd edge-test && git init
ontos init
# Press Ctrl+C at prompt
# Observe: Does it abort? Skip hooks? Continue?

# Ctrl+D (EOF)
cd /tmp && rm -rf edge-test && mkdir edge-test && cd edge-test && git init
ontos init
# Press Ctrl+D at prompt

# Redirected stdin
cd /tmp && rm -rf edge-test && mkdir edge-test && cd edge-test && git init
echo "n" | ontos init
ls -la .git/hooks/

# /dev/null stdin
cd /tmp && rm -rf edge-test && mkdir edge-test && cd edge-test && git init
ontos init < /dev/null
ls -la .git/hooks/

# Various inputs
cd /tmp && rm -rf edge-test && mkdir edge-test && cd edge-test && git init
echo "YES" | ontos init  # uppercase
# ...

# Not in git repo
cd /tmp && rm -rf edge-test && mkdir edge-test && cd edge-test
ontos init --yes
# Should fail gracefully

# Cleanup
cd /tmp && rm -rf edge-test
````

| Edge Case | Handled? | Behavior | Acceptable? |
|-----------|----------|----------|-------------|
| Ctrl+C | ✅ | Aborts init and returns 130; only `.ontos.toml` is removed. `ontos/commands/init.py:104-116` | ❌ (leaves dirs/context map; message says “No changes made.”) |
| Ctrl+D | ✅ | Catches EOFError, prints “Skipping hooks.” and continues. `ontos/commands/init.py:56-58` | ✅ |
| Redirected stdin | ✅ | Non-TTY auto-installs hooks; piped input ignored. `ontos/commands/init.py:43-44` | ✅ (per spec) |
| /dev/null | ✅ | Non-TTY auto-installs hooks. `ontos/commands/init.py:43-44` | ✅ |
| Uppercase input | ✅ | Lowercased to `yes`. `ontos/commands/init.py:54-55` | ✅ |
| Whitespace input | ✅ | `.strip()` yields empty -> treated as yes. `ontos/commands/init.py:54-55` | ⚠️ (surprising but consistent with default-yes prompt) |
| Not in git repo | ✅ | Returns code 2 with message. `ontos/commands/init.py:84-140` | ✅ |

### Part 3: Error Handling Review

| Error Scenario | Code Path | Handling | Adequate? |
|----------------|-----------|----------|-----------|
| `input()` raises exception | `_confirm_hooks` | Catches EOFError, KeyboardInterrupt; abort flows to `init_command`. `ontos/commands/init.py:53-116` | ✅ (see partial cleanup issue) |
| Hook dir doesn't exist | `_install_hooks` | `_get_hooks_dir` creates hooks dir. `ontos/commands/init.py:240-252` | ✅ |
| Hook file not writable | `_install_hooks` | Catches PermissionError; warns; returns 3 if skipped. `ontos/commands/init.py:274-292` | ✅ |

### Part 4: Test Adequacy

| Test | Actually Tests What It Claims? | Notes |
|------|-------------------------------|-------|
| test_skip_hooks_flag_skips_confirmation | ✅ | Verifies no hooks installed; does not assert no prompt. `tests/commands/test_init_phase3.py:182-191` |
| test_yes_flag_skips_confirmation | ✅ | Validates hooks installed when code == 0. `tests/commands/test_init_phase3.py:193-203` |
| test_skip_hooks_wins_over_yes | ✅ | Verifies skip wins. `tests/commands/test_init_phase3.py:205-213` |

**Missing Tests:**

| Scenario | Should Have Test? | Blocking? |
|----------|-------------------|-----------|
| Ctrl+C handling | ❌ | ❌ (covered) |
| Ctrl+D handling | ✅ | ❌ |
| TTY detection | ✅ | ❌ |
| Non-TTY behavior | ✅ | ❌ |

### Part 5: Code Inspection

| Code | Potential Issue | Severity |
|------|-----------------|----------|
| `response in ('', 'y', 'yes')` | Whitespace-only input treated as “yes.” | Low |
| `stacklevel=2` | Correct for import location; no issue found. | None |
| `getattr(args, "yes", False)` | Safe defaulting; no issue found. | None |
| Exception handling scope | Ctrl+C cleanup only removes `.ontos.toml`, leaves directories/context map while message claims no changes. `ontos/commands/init.py:94-116` | Medium |

### Part 6: Issues Found

**Critical:**

| # | Issue | How to Trigger | Impact |
|---|-------|----------------|--------|
| X-C1 | None | | |

**High:**

| # | Issue | How to Trigger | Impact |
|---|-------|----------------|--------|
| X-H1 | None | | |

**Medium:**

| # | Issue | How to Trigger | Impact |
|---|-------|----------------|--------|
| X-M1 | Ctrl+C cleanup claims “No changes made” but leaves directories/context map and any generated files. `ontos/commands/init.py:94-116` | Run `ontos init` in a git repo, press Ctrl+C at the prompt. | Leaves partial initialization artifacts; message is misleading and breaks expectation of clean abort. |
| X-M2 | `test_hook_collision_force_overwrites` lacks assertions validating hook replacement. `tests/commands/test_init_phase3.py:162-178` | Regression could slip if overwrite logic breaks. | Test gives false confidence; overwrite behavior is unverified. |

### Part 7: Verdict

**Recommendation:** Request Changes
**Top 3 Concerns:**
1. Ctrl+C cleanup leaves partial state while claiming no changes.
2. Missing assertions for force-overwrite hook test.
3. Non-TTY behavior and EOF paths lack test coverage.

---

*Phase D.2 — Adversarial Code Review*
