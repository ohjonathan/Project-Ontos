---
id: v3_1_1_chief_architect_response
type: strategy
status: active
depends_on: [v3_1_1_init_improvements_proposal]
concepts: [init, scaffold, architecture-review, decisions]
---

# v3.1.1 Chief Architect Response

**Author:** Claude Opus 4.5 (Chief Architect)
**Date:** 2026-01-22
**Input:** `v3.1.1_Spec_Review_Consolidation.md` (3 reviewers, 0/3 approve)
**Output:** All blocking issues resolved. Spec updated to v1.1.

---

## 1. Blocking Issues Response

### B1: Whole-repo scan without `.ontosignore` can traverse dependency dirs

**Response:** Accept

**Reasoning:** The legacy script (`ontos/_scripts/ontos_scaffold.py:68-70`) already had hardcoded DEFAULT_IGNORES but the native `scaffold.py` (v3.0) dropped them during the rewrite. This is a regression, not a design choice. The native command must have the same safety as the legacy one.

**Action:** Add a `DEFAULT_IGNORES` constant to `ontos/commands/scaffold.py`. Apply these patterns in `find_untagged_files()` regardless of whether `.ontosignore` exists.

**Patterns:**
```python
DEFAULT_IGNORES = [
    'node_modules', '.venv', 'venv', 'vendor',
    '__pycache__', '.pytest_cache', '.mypy_cache',
    'dist', 'build', '.tox', '.eggs',
]
```

**Spec Change:** New Section 2.3 "Scanner Safety" added. Section 2.2.4 updated to document DEFAULT_IGNORES behavior.

---

### B2: Custom path can escape project root

**Response:** Accept

**Action:** In `_prompt_scaffold()`, after resolving the custom path, validate:
```python
resolved = custom_path.resolve()
if not resolved.is_relative_to(project_root.resolve()):
    print(f"Error: Path must be within project root.", file=sys.stderr)
    return None  # Skip scaffold
```

Uses `Path.is_relative_to()` (Python 3.9+, our minimum version).

**Spec Change:** Section 2.2.7 error handling table updated with new row.

---

### B3: Dual Mode Matrix contradiction

**Response:** Accept (update Matrix)

**Reasoning:** The Dual Mode Matrix (line 28-29) says kernel and atom should be "flat (`docs/`)" in user mode. This was written during v2.5.2 when the philosophy was that users don't need the full hierarchy. The v3.1.1 proposal explicitly reverses this: visible type directories improve onboarding, aid type inference, and provide structural guidance.

The Matrix is a reference document (`type: atom`), not a constitutional constraint. The constitution says nothing about directory layout -- only about curation, locality, and determinism. Creating type directories is consistent with "Structure Over Search" (philosophy).

**Action:**
1. Update `Dual_Mode_Matrix.md` Section 1:
   - Kernel row: `docs/` (flat) -> `docs/kernel/`
   - Atom row: `docs/` (flat) -> `docs/atom/`
   - Add `docs/product/` row
2. Add version entry: "v3.1.1 | Added kernel/, product/, atom/ subdirectories in user mode"

**Spec Change:** `Dual_Mode_Matrix.md` added to Files to Modify table.

---

## 2. High-Priority Issues Response

| Issue | Decision | Rationale | Action |
|-------|----------|-----------|--------|
| H1: Non-fatal scaffold hides broken onboarding | **Address** | Silent failure is poor UX. Users should know if files weren't processed. | Print summary: "Scaffolded N files." or "Warning: Scaffold completed with errors (M files unprocessed)." |
| H2: Prompt can hang in TTY contexts | **Defer to v3.2** | Timeout requires `signal.alarm` (Unix-only) or threading. Same limitation exists for hook prompts. | Document limitation in code comments. |
| H3: Invalid scope input undefined | **Address** | Trivial fix, improves robustness. | If input not in ('1','2','3',''), default to '1' with message "Invalid choice, using docs/ directory." |
| H4: Non-TTY asymmetry undocumented | **Address** | Documentation-only, low risk. | Add docstring comment + update behavioral matrix in spec. |
| H5: CLI --scaffold path argument | **Defer to v3.2** | Patch should be minimal. Interactive prompt covers scope selection. | Add to v3.2 backlog. |

---

## 3. Open Questions Decisions

### Q1: Should init create a starter `kernel/mission.md` stub?

**Decision:** NO

**Reasoning:** Ontos philosophy is "Intent Over Automation" and "Curated, Not Automatic." Creating content the user didn't request violates both principles. The empty `kernel/` directory provides sufficient structural guidance.

---

### Q2: Should scaffold prompt show preview before applying?

**Decision:** NO

**Reasoning:** Scaffold is non-destructive (prepends YAML header, preserves content). Double-prompt friction (first "scaffold?", then "these files okay?") harms UX. Instead, the confirmation prompt explains what scaffold does: "Scaffold adds YAML headers to identify each file."

---

### Q3: Hardcoded exclusion patterns for whole-repo scan?

**Decision:** YES

**Reasoning:** Unanimous reviewer agreement. Legacy script had these. Fresh projects lack `.ontosignore`. Safety measure, not over-engineering. Covered by B1 response.

---

### Q4: Should `--scaffold` accept optional path argument?

**Decision:** Defer to v3.2

**Reasoning:** Keep patch minimal. Interactive prompt covers scope selection. CLI parity can follow in v3.2.

---

### Q5: `reference/` directory -- keep, rename, or remove?

**Decision:** Keep

**Reasoning:** Backwards compatible, actively used, documented in the Matrix. No benefit to changing in a patch release.

---

### Q6: Should type directories be configurable in `.ontos.toml`?

**Decision:** NO

**Reasoning:** Convention over configuration. The type hierarchy is ontological (kernel -> strategy -> product -> atom). Making it configurable implies these categories are arbitrary, undermining the type system. Users with non-standard layouts can rely on frontmatter `type:` -- directories are guidance, not enforcement.

---

### D5: Should cleanup on abort include scaffolded files?

**Decision:** NO (RESOLVED)

**Reasoning:** `SessionContext.commit()` writes buffered files atomically. Attempting to undo is fragile (need original content), risky (corruption if interrupted during undo), and unnecessary (scaffold preserves content). Document: "Scaffold writes persist even if init is subsequently aborted."

---

## 4. Edge Cases Response

| Edge Case | Decision | Implementation |
|-----------|----------|----------------|
| Custom path escapes project root | Covered by B2 | `Path.is_relative_to()` check |
| Whole-repo scan without .ontosignore | Covered by B1 | DEFAULT_IGNORES constant |
| Invalid scope input (not 1/2/3) | Address | Default to '1' with message |
| 1000+ untagged files | Address | Print warning: "Found N files. This may take a moment." for N > 50 |

---

## 5. Test Plan Additions

| Test | Scenario | Expected |
|------|----------|----------|
| `test_default_ignores_node_modules` | Repo with `node_modules/README.md`, whole-repo scan | File NOT scaffolded |
| `test_default_ignores_venv` | Repo with `.venv/docs/guide.md`, whole-repo scan | File NOT scaffolded |
| `test_custom_path_escape_rejected` | User enters `../outside` as custom path | Error printed, scaffold skipped |
| `test_custom_path_absolute_rejected` | User enters `/tmp/other` as custom path | Error printed, scaffold skipped |
| `test_invalid_scope_defaults` | User enters '5' for scope | Defaults to docs/, prints message |
| `test_large_file_count_warning` | 100+ untagged files | Warning printed before proceeding |
| `test_dual_mode_matrix_user_dirs` | Init in user mode | kernel/, product/, atom/ created |

---

## 6. Verification Review Decision

**Required?** No

**Reasoning:** All blocking issues resolved by accepting consolidation recommendations. No recommendations rejected. Changes are additive safety guards that don't alter core design. Matrix update is documentation alignment, not architectural change.

---

## 7. Changelog (v1.0 -> v1.1)

| Section | Change | Source |
|---------|--------|--------|
| New 2.3 | "Scanner Safety" section with DEFAULT_IGNORES | B1, Q3 |
| 2.2.4 | DEFAULT_IGNORES applied to "Entire repository" scan | B1 |
| 2.2.4 | Prompt text explains scaffold action | Q2 |
| 2.2.4 | Large file count warning (N > 50) | Edge case |
| 2.2.6 | Summary output line for scaffold result | H1 |
| 2.2.7 | "Path escapes project root" row added | B2 |
| 2.2.7 | "Invalid scope input" handling | H3 |
| 2.2.3 | Non-TTY asymmetry rationale documented | H4 |
| 2.1 | Dual Mode Matrix update noted | B3 |
| 3 | `Dual_Mode_Matrix.md` in files to modify | B3 |
| 5 | D5 marked RESOLVED: NO | D5 |
| 6 | 7 new test cases added | Review gaps |
