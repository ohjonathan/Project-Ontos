# v3.1.1 Spec Review Consolidation

**Prepared by:** Antigravity (Gemini 2.5 Pro) — Review Consolidator  
**Date:** 2026-01-22  
**Document Type:** Decision-Ready Synthesis

---

## 1. Verdict Summary

| Reviewer | Role | Verdict | Blocking Issues |
|----------|------|---------|-----------------|
| Gemini | Peer | Approve with Changes | 1 |
| Claude | Alignment | Request Changes | 1 |
| Codex | Adversarial | Request Changes | 2 |

**Consensus:** 0/3 Approve  
**Overall:** **Needs Revision** — All three reviewers flagged blocking issues.

---

## 2. Blocking Issues

| # | Issue | Flagged By | Category | Impact | De-duped? |
|---|-------|------------|----------|--------|-----------|
| B1 | **Whole-repo scan without `.ontosignore` can traverse dependency dirs** (node_modules, vendor, etc.) | Gemini (P-M1), Claude (A-M2), Codex (X-C2) | Safety | Large unintended modifications; performance regression; possible data corruption | — |
| B2 | **Custom path can escape project root** — User can enter `../` or absolute path, modifying files outside repo | Codex (X-C1) | Security | Files modified outside project; trust breach | No |
| B3 | **Dual Mode Matrix contradiction** — Proposal creates `docs/kernel/`, `docs/atom/` in user mode, contradicting active reference doc | Claude (A-C1) | Architecture | Conflicting authoritative sources | No |

---

## 3. High-Priority Issues (Non-Blocking)

| # | Issue | Flagged By | Category | Recommendation |
|---|-------|------------|----------|----------------|
| H1 | Non-fatal scaffold hides broken onboarding (silent failures leave docs untagged) | Codex (X-H1) | UX | Surface scaffold failure more prominently; consider warning banner if files remain untagged |
| H2 | Prompt can hang in unexpected TTY contexts (IDE terminals, wrappers) | Codex (X-H2) | Robustness | Add input timeout or document TTY detection limitations |
| H3 | Invalid scope input (not 1/2/3) is undefined behavior | Codex (X-H3) | Input Validation | Add input validation loop with re-prompt |
| H4 | Non-TTY asymmetry (hooks=proceed, scaffold=skip) is undocumented | Claude (A-M1) | Consistency | Add code comments + behavioral matrix documentation |
| H5 | CLI argument parity — `--scaffold` doesn't allow path argument like interactive mode | Gemini (P-m2) | UX | Consider `--scaffold [PATH]` with `nargs='?'` |

---

## 4. Required Actions for Chief Architect

| Priority | Action | Addresses Issue(s) | Decision Type |
|----------|--------|-------------------|---------------|
| 1 | **Define DEFAULT_IGNORES list** in scanner (node_modules, .venv, vendor, __pycache__, dist, build, .git) | B1 | Must fix |
| 2 | **Add project-root guard** to custom path input — reject paths outside `find_project_root()` | B2 | Must fix |
| 3 | **Resolve Dual Mode Matrix conflict** — Either update Matrix to v3.1.1 intent OR revise proposal to keep flat layout | B3 | Must decide |
| 4 | Decide: Should `--scaffold` accept optional path argument? | H5 | Should decide |
| 5 | Decide: Add input validation loop for scope prompt? | H3 | Should decide |
| 6 | Document non-TTY behavioral asymmetry | H4 | Should fix |

---

## 5. Open Question Recommendations

| Question | Gemini | Claude | Codex | Agreement | Consolidation Recommendation |
|----------|--------|--------|-------|-----------|------------------------------|
| Q1: Starter mission.md | **YES** — create stub for valid graph | **NO** — violates "intent over automation" | No position | Disagree | **NO.** Claude's philosophy alignment is persuasive. Directory existence provides sufficient guidance without implicit content creation. |
| Q2: Preview before applying | **NO** — extra friction | **NO** — scaffold non-destructive | No position | Agree | **NO.** Skip preview; add parenthetical note to prompt about header modification. |
| Q3: Hardcoded exclusions | **YES (CRITICAL)** | **YES** — add to `find_untagged_files` | Not directly asked, but flagged as X-C2 | Agree | **YES.** All three converge. Mandatory hardcoded exclusions for major dependency dirs. |
| Q4: --scaffold path arg | **YES** — `nargs='?'` for parity | **DEFER** — keep simple for patch | No position | Disagree | **DEFER.** Follow Claude's recommendation; patch release should be minimal. Add to v3.2 backlog. |
| Q5: reference/ directory | **KEEP** — maintain backward compat | **KEEP** — actively used | No position | Agree | **KEEP.** No structural changes to reference/ in v3.1.1. |
| Q6: Configurable type dirs | **NO** — convention over config | **NO** — type hierarchy is ontological | No position | Agree | **NO.** Fixed hierarchy is part of opinionated design. |
| D5: Cleanup scaffolded files | No explicit position (P-m1 tangential) | **NO** — consistent with existing logic | X-M3 notes partial state risk | Agree | **NO.** Do not cleanup scaffolded files on abort. Scaffold is atomic per-file; partial undo unsafe. Document that scaffold writes persist even on abort. |

---

## 6. Agreement Analysis

**Strong Agreement (All 3 reviewers):**

| Topic | Consensus Position |
|-------|-------------------|
| Hardcoded exclusions needed (Q3) | Must have DEFAULT_IGNORES for node_modules, .venv, etc. |
| No scaffold preview (Q2) | Skip preview in interactive flow |
| Keep reference/ directory (Q5) | No structural changes in patch release |
| No configurable type dirs (Q6) | Convention over configuration |

**Partial Agreement (2 of 3):**

| Topic | Majority View | Dissent | Recommendation |
|-------|---------------|---------|----------------|
| --scaffold path argument (Q4) | Gemini: YES | Claude: DEFER | Follow Claude — defer to v3.2; keep patch minimal |

**Disagreement (Split):**

| Topic | Views | Analysis | Recommendation |
|-------|-------|----------|----------------|
| Starter mission.md (Q1) | Gemini: YES (valid graph), Claude: NO (violates intent principle) | Gemini's rationale is practical (graph needs root node); Claude's is philosophical (don't create content user didn't request) | **Follow Claude.** In a patch release, philosophy alignment takes precedence. Revisit for v3.2 with a `--skeleton` flag if needed. |
| Severity of non-fatal scaffold | Codex: HIGH concern (X-H1) | Gemini/Claude: accept as pattern-consistent | Monitor but keep current design. Non-fatal matches existing agents/map pattern. Add warning if 0 files scaffolded as enhancement. |

---

## 7. Edge Cases & Failure Modes Summary

**Unhandled (Must Address):**

| Edge Case | Risk | Recommended Fix |
|-----------|------|-----------------|
| Custom path escapes project root (`../` or absolute) | HIGH — modifies external files | Validate path is under project root; reject with error if not |
| Whole-repo scan without .ontosignore | HIGH — performance + wrong files | Hardcoded DEFAULT_IGNORES |
| Invalid scope input (not 1/2/3) | MEDIUM — undefined behavior | Input validation loop with re-prompt |
| 1000+ untagged files | MEDIUM — long runtime, appears hung | Add progress indicator or file count warning |

**Unhandled (Acceptable for v3.1.1):**

| Edge Case | Risk | Why Acceptable |
|-----------|------|----------------|
| Concurrent `ontos init` in same directory | LOW — race condition | Rare edge case; standard file system behavior prevails |
| Read-only filesystem | LOW — creation fails | Error message sufficient; not a target environment |
| Repo without git (no project root) | LOW | `find_project_root` already handles this with fallback; document behavior |
| scaffold_command hangs indefinitely | LOW | Rare; Ctrl+C handler exists; timeout adds complexity |
| Hidden markdown files (.hidden.md) | LOW | Intentionally hidden; reasonable to skip |

**Already Handled:**

| Edge Case | How Addressed |
|-----------|---------------|
| `docs/` doesn't exist when scaffold runs | Init creates dirs first (spec section 2.2.4) |
| `--scaffold --no-scaffold` conflict | Argparse mutually_exclusive_group (spec section 2.2.2) |
| Non-TTY detection | Auto-skip scaffold (spec section 2.2.3) |
| Already-initialized repo | Early exit (existing behavior preserved) |

---

## 8. Test Plan Gaps

| Gap | Flagged By | Suggested Test |
|-----|------------|----------------|
| DEFAULT_IGNORES behavior | Gemini, Claude, Codex | Test `ontos init` in repo with `node_modules/` containing `.md` files; verify they're excluded from scaffold |
| Custom path validation | Codex | Test `../outside` and `/absolute/path` inputs; expect error, not scaffold of external files |
| Invalid scope input handling | Codex | Test non-numeric and out-of-range inputs; expect re-prompt |
| Large file count performance | Codex | Benchmark init with 1000+ markdown files; ensure reasonable runtime |
| Dual Mode Matrix consistency | Claude | After fix, verify docs/ structure matches updated Matrix |

---

## 9. Decision Summary

**Spec Status:** **Major Revision Needed**

**Chief Architect must:**

1. **Define and implement DEFAULT_IGNORES** (node_modules, .venv, vendor, __pycache__, dist, build, .git) in scanner — addresses B1
2. **Add project-root boundary check** for custom path input — addresses B2
3. **Resolve Dual Mode Matrix contradiction** — either:
   - Update Matrix with v3.1.1 design intent (recommended by Claude), OR
   - Revise proposal to keep flat layout for kernel/atom
4. **Decide on Q1 (mission.md stub)** — recommendation: NO
5. **Decide on Q4 (--scaffold path)** — recommendation: DEFER to v3.2
6. Add test cases for DEFAULT_IGNORES, path validation, and input handling
7. Update spec to v1.1 incorporating the above

**Estimated scope of changes:** **Moderate revisions** — 3 blocking issues require spec updates and implementation guards, but core design is sound.

---

*Consolidation complete. 2026-01-22.*
