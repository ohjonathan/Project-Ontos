---
id: v3_1_1_spec_review_claude
type: atom
status: complete
depends_on: [v3_1_1_init_improvements_proposal, ontos_philosophy_and_ontology, dual_mode_matrix]
concepts: [review, alignment, init, v3.1.1, philosophy]
---

# v3.1.1 Alignment Review: `ontos init` Improvements

**Reviewer:** Claude Opus 4.5 (Alignment Reviewer)
**Date:** 2026-01-22
**Reviewed Document:** `v3_1_1_init_improvements_proposal.md`
**Phase Type:** Patch/Polish (v3.1.1 after v3.1.0)

---

## Part 1: Philosophy Alignment

| Principle | Spec Compliant? | Evidence/Concern |
|-----------|-----------------|------------------|
| Intent over automation | ✅ | Scaffold is opt-in (prompt with `[y/N]` default NO); non-TTY skips; `--yes` does NOT auto-scaffold. User must express intent to modify files. |
| Opinionated defaults | ✅ | Type directories created by default (signals where docs go). Scaffold scope defaults to `docs/` (safest). Default prompt answer is "no." |
| Type hierarchy as organizing principle | ✅ | Directory structure maps 1:1 to TYPE_DEFINITIONS ranks (kernel=0, strategy=1, product=2, atom=3). Enables path-based type inference. |
| Non-destructive by default | ✅ | Scaffold only adds frontmatter (no content modification). Prompt required before modifying user files. Non-TTY environments never modify. |

**Philosophy Tensions:**

| Tension | Analysis |
|---------|----------|
| Scaffold prompt asks consent for what should be pure ceremony | Scaffolding is classified as "Ceremony (We Eliminate)" in the philosophy doc (line 98). Asking consent to perform ceremony seems contradictory. However, the distinction is that scaffold *modifies existing user files* -- the non-destructive principle overrides the ceremony-elimination principle. Consent is about modification, not about curation. Spec is correct but rationale should cite non-destructive principle explicitly. |
| Q1 (starter mission.md) creates content without user intent | Creating a stub file is content generation, not ceremony automation. The user has not expressed intent to document a mission. This violates "intent over automation" -- the directory existing is sufficient signal. **Recommendation: NO.** |

---

## Part 2: Architecture Compliance

| Constraint | Spec Compliant? | Evidence |
|------------|-----------------|----------|
| Commands import from core, not vice versa | ✅ | `_run_scaffold()` imports `scaffold_command` from `ontos.commands.scaffold`. This is command-to-command (established pattern: init already imports `map_command` and `agents_command`). Core modules are not affected. |
| Non-fatal patterns match existing commands | ✅ | Proposed `_run_scaffold()` uses try/except with stderr warning, matching `_generate_agents_file()` at init.py:229 and `_generate_initial_context_map()` at init.py:185. |
| Config paths used consistently | ✅ | Uses `config.paths.docs_dir` for directory construction. No hardcoded paths. |
| Error handling matches established patterns | ✅ | Non-fatal failures print to stderr and continue. Exit codes unchanged. KeyboardInterrupt triggers cleanup. |

**Architecture Issue: AR-DUAL-MODE (BLOCKING)**

The **Dual Mode Matrix** (`.ontos-internal/reference/Dual_Mode_Matrix.md:28-29`) is an active reference document that explicitly states:

```
| Kernel docs | .ontos-internal/kernel/ | docs/ (flat) | Users don't need kernel/ |
| Atom docs   | .ontos-internal/atom/   | docs/ (flat) | Users don't need atom/ |
```

The proposal creates `docs/kernel/`, `docs/product/`, and `docs/atom/` in user mode, directly contradicting this documented design decision. The proposal's rationale (path-based type inference) is sound, but the prior decision must be formally superseded.

**Resolution options:**
1. Update the Dual Mode Matrix to reflect the new design intent and add version history entry
2. Keep flat layout for kernel/atom and only add `product/` (which is not mentioned in the Matrix)
3. Add a formal "supersedes" note in the proposal explaining why the prior decision no longer holds

**Recommendation:** Option 1 -- the type hierarchy directories are a net improvement for onboarding. The "Users don't need kernel/" reasoning was from v2.5.2 when Ontos had less emphasis on the type hierarchy as a core concept. The v3.0 architecture makes types central.

**Architecture Issue: AR-DRY (LOW)**

`_create_directories()` at init.py:172-182 is dead code -- it is defined but never called from `init_command()`. The inline directory list at lines 105-111 is the active code path. The proposal says these must be "kept in sync" but the correct fix is to remove the dead helper or refactor `init_command()` to call it.

---

## Part 3: Consistency Check

| Existing Pattern | Spec Consistent? | Notes |
|------------------|------------------|-------|
| `--yes` behavior (accept defaults) | ✅ | `--yes` accepts defaults. Default for hooks = install. Default for scaffold = skip. Both follow the principle. See BC-YES for help text improvement. |
| Non-TTY detection and skip | ⚠️ | Hooks: non-TTY = auto-proceed. Scaffold: non-TTY = auto-skip. Opposite behaviors. Justified by non-destructive principle but undocumented. See BC-NONTTY. |
| Cleanup on abort | ✅ | D5 correctly proposes NO cleanup of scaffolded files. Consistent with existing cleanup logic (only removes tracked `created_paths`, never undoes content changes). |
| Warning vs error exit codes | ✅ | Scaffold failure is non-fatal (warning only, no exit code change). Matches agents/map pattern. |
| Mutually exclusive flag groups | ✅ | `--scaffold`/`--no-scaffold` uses `add_mutually_exclusive_group()`. Same pattern as query command's `--deps`/`--rdeps` groups. |

**BC-NONTTY (MEDIUM):** The non-TTY behavioral asymmetry between hooks and scaffold is the right choice but should be explicitly documented:

| Context | Non-TTY Behavior | Reason |
|---------|-------------------|--------|
| Hooks | Auto-proceed (install) | Creates new infrastructure files in `.git/hooks/` -- non-destructive to user content |
| Scaffold | Auto-skip (don't run) | Modifies existing user markdown files -- requires explicit consent |

**Recommendation:** Add a comment in the code and a note in the behavioral matrix explaining this distinction.

**BC-YES (LOW):** The `--yes` flag's help text currently says "accept all defaults." Since scaffold's default is "no," this creates potential confusion. Recommend updating help text to: `"Accept defaults non-interactively (installs hooks; scaffold requires --scaffold flag)"`.

---

## Part 4: Backward Compatibility

| Interface | Changed? | Breaking? | Mitigation |
|-----------|----------|-----------|------------|
| CLI flags | Yes (additive) | No | New `--scaffold`/`--no-scaffold` flags. Existing flags unchanged. |
| Exit codes | No | No | All exit codes (0, 2, 3, 130) unchanged. Scaffold failure is non-fatal. |
| Directory structure | Yes (additive) | No | New directories created alongside existing ones. No removal. |
| `.ontos.toml` schema | No | No | No new config fields. Type dirs derived from `docs_dir`. |
| Existing project behavior | No | No | Already-initialized projects still return exit 0. New dirs NOT retroactively created. |

**Compatibility Concerns:**

| Concern | Severity | Recommendation |
|---------|----------|----------------|
| Existing projects don't get new type directories on upgrade | LOW | Acceptable for v3.1.1. Track need for `ontos init --upgrade` or `ontos doctor --fix` in v3.2 backlog. |
| `--yes` behavior unchanged (does not scaffold) | NONE | Correct -- no regression for CI scripts using `ontos init --yes`. |

---

## Part 5: Issues Found

**Critical (Alignment):**

| # | Issue | Type | Why Critical |
|---|-------|------|--------------|
| A-C1 | Proposal creates `docs/kernel/` and `docs/atom/` in user mode, contradicting the active Dual Mode Matrix which says these should be flat (`docs/`) | Architecture | Active reference document contradiction. Must be resolved before implementation to avoid conflicting authoritative sources. |

**Major (Alignment):**

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-M1 | Non-TTY asymmetry (hooks=proceed, scaffold=skip) is undocumented | Consistency | Add explicit documentation in code comments and behavioral matrix explaining the non-destructive principle distinction. |
| A-M2 | Whole-repo scan has no hardcoded exclusions for dependency directories | Architecture | `find_untagged_files()` should exclude `node_modules/`, `vendor/`, `.venv/`, `__pycache__/` when scanning broadly. Fresh projects have no `.ontosignore`. The legacy script has these exclusions (line 69-70 of `ontos/_scripts/ontos_scaffold.py`) but the native `scan_documents()` does not. |

**Minor (Alignment):**

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-m1 | `_run_scaffold()` should pass `quiet=True` to `ScaffoldOptions` | Consistency | Avoids double output (init prints its own status; scaffold would print per-file messages). |
| A-m2 | Dead `_create_directories()` helper at init.py:172 | Architecture | Remove dead code or refactor `init_command()` to use it. Don't maintain two lists. |
| A-m3 | D5 marked "Decision needed" but proposes the answer | Completeness | Commit to the decision: NO cleanup of scaffolded files. Mark D5 as RESOLVED. |
| A-m4 | `--yes` help text ambiguity | Consistency | Update help description to clarify scope of "accept defaults." |

---

## Part 6: Verdict

**Alignment Status:** Minor Deviations (one blocking issue, resolvable)

**Recommendation:** Request changes -- resolve A-C1 (Dual Mode Matrix contradiction) before implementation. All other issues are refinements that can be addressed during implementation.

**Blocking issues:** 1

**Resolution path for A-C1:** Update the Dual Mode Matrix to reflect the v3.0+ design intent that user-mode projects DO get type hierarchy directories. Add a version history entry noting "v3.1.1: Type directories added for user mode (kernel/, product/, atom/) to enable path-based type inference." The ontological reasoning is sound -- the prior flat-layout decision predates the v3.0 emphasis on type hierarchy as an organizing principle.

---

## Open Questions Dispositions

| Question | Recommendation | Rationale |
|----------|----------------|-----------|
| Q1: Starter mission.md | **NO** | Violates "intent over automation." Creating content the user did not request adds noise, not signal. The directory existing is sufficient guidance. |
| Q2: Scaffold preview | **NO** for v3.1.1 | Extra friction on ceremony automation. Scaffold is non-destructive (adds frontmatter only). Users can run `ontos scaffold --dry-run` separately for previews. |
| Q3: Exclusion patterns | **YES** -- add hardcoded exclusions | Real risk for fresh projects without `.ontosignore`. Add `node_modules/`, `vendor/`, `.venv/`, `__pycache__/` to `find_untagged_files()` when scope is broad (not docs-only). |
| Q4: --scaffold path arg | **DEFER** | Keep simple for patch release. `--scaffold-path` could be a separate flag in v3.2 if needed. Mixing enable-flag with configuration is poor UX. |
| Q5: reference/ directory | **KEEP** | Established pattern, actively used in both contributor and user mode per Dual Mode Matrix. |
| Q6: Configurable type dirs | **NO** | Over-engineering. Type hierarchy is ontological (defined in `ontology.py`), not configurational. Adding config complexity for a hypothetical need violates the constitution's minimal-dependencies principle. |
| D5: Cleanup scaffolded files | **RESOLVED: NO** | Consistent with existing cleanup logic (only removes `created_paths`). `scaffold_command` commits atomically; partial undo is unsafe. |

---

*Review complete. 2026-01-22.*
