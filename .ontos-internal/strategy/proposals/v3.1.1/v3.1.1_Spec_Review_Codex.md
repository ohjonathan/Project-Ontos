# v3.1.1 Spec Review (Adversarial) — Codex

Loaded: [v3_1_1_init_improvements_proposal, v3_0_technical_architecture, mission, philosophy, constitution]

## Part 1: Assumption Attack

| Assumption in Spec | Why It Might Be Wrong | Impact If Wrong |
|--------------------|----------------------|-----------------|
| Users want type directories created automatically | Some repos treat `docs/` as curated; auto-creating extra dirs may be noise or conflicting with existing structure conventions. | New dirs appear unexpectedly, breaks repo conventions or policies; init seen as intrusive. |
| Interactive prompts are acceptable UX | CI, git hooks, or tooling wrappers may expect non-interactive behavior even in TTY contexts (e.g., IDE terminals). | Init hangs or blocks automated scripts; perceived regression. |
| `docs_dir` is the right default scope for `--scaffold` | Many repos keep markdown in root or elsewhere; `docs/` may be empty. | `--scaffold` does nothing and gives false sense of success. |
| Scaffold failure should be non-fatal | If scaffold is required to avoid map errors or validation failures later, non-fatal hides broken state. | Users get a green init but a broken or incomplete map; silent failures. |
| `find_untagged_files` is fast enough to run during init | Large repos or network FS could make scans slow; init might become sluggish. | Init becomes slow or times out in automation; perceived regression. |
| Path-based type inference is correct once dirs exist | Some users may put mixed-type docs in a directory; inference may be wrong. | Wrong frontmatter leads to misclassification and bad map output. |
| Skipping scaffold in non-TTY is safe | Some CI pipelines might want scaffold even without TTY. | Automated onboarding cannot scaffold without extra flags; inconsistent behavior. |
| `--yes` default meaning "no scaffold" is intuitive | Users may expect `--yes` to accept all prompts, including scaffold. | Surprise: scaffold not run; onboarding incomplete. |
| `.ontosignore` exists or hidden dirs exclusion is sufficient | Fresh repo often lacks ignore; hidden dirs filter does not exclude `node_modules` or `vendor`. | Whole-repo scan hits huge trees; performance issues or wrong files scaffolded. |
| Invalid custom path can safely fall back to `docs_dir` | Silent fallback can scaffold different files than user intended. | Unexpected file modifications in `docs/`. |
| Cleanup not undoing scaffold writes is acceptable | For aborted init, users may expect no file mutations. | Partial frontmatter injected without config; confusing, could be hard to revert. |
| Mutually exclusive flags prevent conflicting behaviors | Users can still combine `--scaffold --no-scaffold` via scripting errors in wrappers or config merges. | Ambiguous behavior, possibly undefined; hard to debug. |

## Part 2: Edge Case Analysis

| Scenario | Handled? | If Not, What Happens? |
|----------|----------|----------------------|
| `ontos init` in repo with 1000+ untagged markdown files | ❌ | Long scan + long scaffold with no progress; init feels hung; risk of timeouts. |
| User types invalid choice (not 1/2/3) at scope prompt | ❌ | Likely falls to default or loops? Spec does not define; could crash or mis-handle input. |
| Custom path is outside project root | ❌ | Could scan and modify files outside project; security and correctness risk. |
| Custom path contains spaces or special characters | ⚠️ | Input parsing may trim or mis-handle; scaffold might fail or scan wrong path. |
| `scaffold_command` hangs indefinitely | ❌ | Init blocks forever; no timeout; user forced to interrupt. |
| User runs `ontos init --scaffold --no-scaffold` | ⚠️ | Argparse group should prevent, but wrappers or config-based invocation could still pass; error messaging unclear. |
| `.ontosignore` doesn't exist during whole-repo scan | ❌ | Scan includes `node_modules`/`vendor` or large dirs; performance regression. |
| `docs/` directory doesn't exist when scaffold runs | ✅ | Init creates dirs first; ok unless init fails before scaffold step. |
| Concurrent `ontos init` in same directory | ❌ | Race: double scaffold, partial dirs, or conflicting writes. |
| Read-only filesystem | ❌ | Directory creation, `.ontos.toml`, scaffold writes fail; non-fatal scaffold hides partial failure. |
| Repo without git (no project root) | ⚠️ | `find_project_root` may fail; init behavior unclear; scaffold scope invalid. |
| Existing untagged files with conflicting frontmatter style | ⚠️ | Scaffold may inject frontmatter format different from existing conventions. |
| Hidden markdown files (`.hidden.md`) | ❌ | Hidden dir skip may ignore valid docs; scaffold misses them. |
| Mixed newline encodings (CRLF) | ⚠️ | Scaffold might normalize or corrupt newline style. |
| Files without write permissions | ❌ | Scaffold fails on specific files; error handling may be global, leaving partial modifications. |
| Large file (MBs) | ⚠️ | Scaffold may be slow or memory-heavy; no streaming mentioned. |

## Part 3: Failure Mode Analysis

| Failure | How It Happens | Detection | Recovery |
|---------|----------------|-----------|----------|
| Scaffold modifies wrong files | Custom path outside root or missing `.ontosignore`; whole-repo scan picks vendor files | None unless user notices | Manual revert; no automatic rollback. |
| Init creates partial directory structure then fails | Exception after some dirs created (e.g., scaffold crash or map generation) | Possibly warnings; exit code may still be 0 | User must manually clean up; no rollback. |
| Type inference assigns wrong type | Path-based inference uses new dirs but docs contain mixed content | No validation; map shows incorrect type | Manual frontmatter edits; re-scaffold. |
| Prompt hangs waiting for input that never comes | TTY detected in CI or wrapper that doesn't provide stdin | Process appears hung | User interrupts; partial init state. |
| Scaffold runs against stale config | `.ontos.toml` created but not fully written or flushed before scaffold reads | Hard to detect; subtle | Rerun scaffold manually. |
| Scaffold errors swallowed | `find_untagged_files` raises or scaffold returns non-zero | Warning only or silent skip | User assumes success; missing tags persist. |
| KeyboardInterrupt during scaffold | Outer handler runs cleanup but not rollback of scaffold changes | User expects abort to revert | Manual cleanup. |

## Part 4: Regression Hunt

| Existing Behavior | Could This Break It? | Evidence |
|-------------------|---------------------|----------|
| `ontos init` in fresh repo | ✅ | New dirs added; prompt in TTY introduces new interactive step. |
| `ontos init` in already-initialized repo | ⚠️ | Behavior should remain early exit; but new logic might run before detection if order changes. |
| `ontos init --yes` in CI pipeline | ✅ | TTY detection or prompt logic could still trigger; also new dirs may be created unexpectedly. |
| Scripts that parse `ontos init` output | ✅ | New prompt/warnings change stdout/stderr; non-fatal warnings can break parsers. |
| Projects with custom `docs_dir` | ⚠️ | New dirs use `docs_dir` but scaffold defaults to it; assumes it exists and is correct. |

## Part 5: Blind Spot Identification

**What's the architect not seeing?**
- The risk of scanning or modifying files outside the repo when custom path is allowed.
- Performance impact of whole-repo scan on monorepos and dependency directories without `.ontosignore`.
- The user expectation that `--yes` means “accept all prompts,” including scaffold.
- Effects on tooling that parse `ontos init` output (new prompts/warnings).

**What seems too easy?**
- "Non-fatal" scaffold failure assumes init can succeed without tags; this hides onboarding defects.
- KeyboardInterrupt handling is assumed safe, but cleanup does not revert scaffold writes.

**What's conspicuously absent?**
- No timeout/circuit-breaker for scaffold on large repos.
- No explicit guard preventing custom path from escaping project root.
- No decision on behavior when `find_untagged_files` returns huge list (progress, confirmation, or limits).
- No test for concurrency or read-only FS failures.

## Part 6: Issues Found

**Critical (Adversarial):**
| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-C1 | Custom path can escape project root | User enters `../` or absolute path | Scaffold modifies files outside repo; security and trust breach. |
| X-C2 | Whole-repo scan without `.ontosignore` can traverse dependency dirs | New repo with `node_modules/` or `vendor/` | Large unintended modifications, long runtimes; potential data corruption. |

**High (Adversarial):**
| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-H1 | Non-fatal scaffold hides broken onboarding | `scaffold_command` fails silently or warns | Users think init succeeded but docs remain untagged; map incomplete. |
| X-H2 | Prompt can hang in unexpected TTY contexts | IDE terminal or tooling wrapper | Init blocks; CI/local automation regression. |
| X-H3 | Invalid scope input is undefined | User types invalid choice | Crash or wrong scan path; potential wrong-file modification. |

**Medium (Adversarial):**
| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-M1 | `--yes` doesn’t trigger scaffold | User expects fully automated init | Incomplete onboarding; confusion. |
| X-M2 | Duplicate directory list drift | Two lists in init.py | Inconsistent behavior; missing dirs if one list updated later. |
| X-M3 | Cleanup doesn’t revert scaffold writes | Ctrl+C after scaffold | Partial modifications remain without config; messy state. |

## Part 7: Verdict

**Spec Robustness:** Fragile
**Recommendation:** Request changes
**Top 3 Concerns:**
1. Custom path can escape project root, enabling out-of-repo modifications.
2. Whole-repo scan on fresh repos without `.ontosignore` can be slow and destructive.
3. Non-fatal scaffold failures hide onboarding defects and make regressions hard to detect.
