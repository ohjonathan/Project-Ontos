---
id: v3_1_1_implementation_spec
type: strategy
status: approved
depends_on: [v3_1_1_init_improvements_proposal, v3_1_1_chief_architect_response]
concepts: [init, scaffold, directory-structure, onboarding, type-hierarchy, safety]
---

# v3.1.1 Implementation Spec: `ontos init` Improvements

**Version:** 1.1
**Author:** Claude Opus 4.5 (Chief Architect)
**Date:** 2026-01-22
**Status:** Approved for implementation

**Change History:**
| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-22 | Initial proposal |
| 1.1 | 2026-01-22 | Incorporated 3-reviewer feedback: DEFAULT_IGNORES, path escape guard, input validation, Matrix update, summary output |

---

## 1. Scope

Two changes to `ontos init`:
1. **Full type hierarchy directories** -- add `kernel/`, `product/`, `atom/`
2. **Interactive scaffold integration** -- prompt to tag existing files during init

Plus safety improvements identified during review:
3. **DEFAULT_IGNORES** -- hardcoded exclusions for dependency directories
4. **Path escape guard** -- prevent scaffold from modifying files outside project root

---

## 2. Implementation

### 2.1 Full Type Hierarchy Directories

**File:** `ontos/commands/init.py` (lines 105-111 and 174-180)

**Change:** Expand directory list from:
```python
dirs = [
    config.paths.docs_dir,
    config.paths.logs_dir,
    f"{config.paths.docs_dir}/strategy",
    f"{config.paths.docs_dir}/reference",
    f"{config.paths.docs_dir}/archive",
]
```

To:
```python
dirs = [
    config.paths.docs_dir,
    config.paths.logs_dir,
    f"{config.paths.docs_dir}/kernel",
    f"{config.paths.docs_dir}/strategy",
    f"{config.paths.docs_dir}/product",
    f"{config.paths.docs_dir}/atom",
    f"{config.paths.docs_dir}/reference",
    f"{config.paths.docs_dir}/archive",
]
```

Apply to both `init_command()` inline list and `_create_directories()` helper.

**Dual Mode Matrix update required:** See Section 4.

---

### 2.2 Interactive Scaffold Integration

#### 2.2.1 New `InitOptions` Fields

**File:** `ontos/commands/init.py`

```python
@dataclass
class InitOptions:
    path: Path = None
    force: bool = False
    interactive: bool = False
    skip_hooks: bool = False
    yes: bool = False
    scaffold: bool = False      # Force scaffold without prompt
    no_scaffold: bool = False   # Suppress scaffold prompt entirely
```

#### 2.2.2 New CLI Flags

**File:** `ontos/cli.py` (`_register_init` function)

```python
scaffold_group = p.add_mutually_exclusive_group()
scaffold_group.add_argument("--scaffold", action="store_true",
                            help="Auto-scaffold untagged files (uses docs/ scope)")
scaffold_group.add_argument("--no-scaffold", action="store_true",
                            help="Skip scaffold prompt")
```

Pass to InitOptions in `_cmd_init`.

#### 2.2.3 Behavioral Matrix

| Condition | Result |
|-----------|--------|
| `--no-scaffold` | Skip entirely |
| `--scaffold` | Force scaffold, docs_dir scope, no prompt |
| Non-TTY (no `--scaffold`) | Skip silently |
| TTY, 0 untagged files | Skip silently |
| TTY, 1-50 untagged files | Prompt: confirm + scope |
| TTY, 51+ untagged files | Warn about count, then prompt: confirm + scope |

**Non-TTY asymmetry rationale:** Hooks proceed in non-TTY because they don't modify user files (they add new files to `.git/hooks/`). Scaffold modifies existing user files, so it requires explicit opt-in (`--scaffold` flag) in non-interactive contexts.

#### 2.2.4 Interactive Flow

```
Found 5 untagged markdown file(s).
Scaffold adds YAML headers to identify each file.
Would you like to scaffold them? [y/N] y

Where should we scan?
  (1) docs/ directory only
  (2) Entire repository (excludes node_modules, .venv, etc.)
  (3) Custom path
Choice [1]: _
```

- Default choice is `1` (docs/ only)
- Choice `2` scans project root with DEFAULT_IGNORES applied (see Section 2.3)
- Choice `3` prompts for a path, validates it's within project root

**Input validation:** If scope input not in ('1', '2', '3', ''), print "Invalid choice, using docs/ directory." and default to option 1.

**Large file count:** If untagged count > 50, print "Note: Found N files. This may take a moment." before the prompt.

#### 2.2.5 Execution Order

```
Step 4: Create .ontos.toml
Step 5: Create directory structure (full type hierarchy)
Step 5.5: Scaffold integration (NEW)
Step 6: Generate initial context map
Step 7: Install hooks
Step 8: Generate AGENTS.md
```

#### 2.2.6 Non-Fatal Design with Summary Output

**File:** `ontos/commands/init.py`

```python
def _run_scaffold(project_root: Path, paths: List[Path]) -> None:
    """Run scaffold on given paths. Non-fatal on failure."""
    try:
        from ontos.commands.scaffold import ScaffoldOptions, scaffold_command
        options = ScaffoldOptions(paths=paths, apply=True, dry_run=False)
        exit_code, message = scaffold_command(options)
        if exit_code == 0:
            # Extract count from message (format: "Processed N files")
            print(f"  Scaffold complete.", file=sys.stderr)
        else:
            print(f"Warning: Scaffold completed with errors: {message}", file=sys.stderr)
    except Exception as e:
        print(f"Warning: Could not run scaffold: {e}", file=sys.stderr)
```

#### 2.2.7 Error Handling

| Scenario | Behavior |
|----------|----------|
| `EOFError` during prompt | Skip scaffold, continue init |
| `KeyboardInterrupt` during prompt | Skip scaffold, continue init (NOT abort) |
| `KeyboardInterrupt` during scaffold_command | Outer `except KeyboardInterrupt` triggers cleanup |
| Invalid scope input | Default to docs/ with message |
| Custom path escapes project root | Print error, skip scaffold |
| Non-existent custom path | Print error, skip scaffold |
| `find_untagged_files` raises | Skip scaffold silently |
| `scaffold_command` non-zero | Print warning, continue init |
| scaffold_command success | Print summary |

**Note on abort:** Scaffold writes (frontmatter additions) persist even if init is subsequently aborted via Ctrl+C. This is by design -- scaffold is non-destructive (content is preserved) and undoing atomic writes is unsafe.

---

### 2.3 Scanner Safety (DEFAULT_IGNORES)

**File:** `ontos/commands/scaffold.py`

Add constant at module level:
```python
DEFAULT_IGNORES = [
    'node_modules', '.venv', 'venv', 'vendor',
    '__pycache__', '.pytest_cache', '.mypy_cache',
    'dist', 'build', '.tox', '.eggs',
]
```

In `find_untagged_files()`, after the hidden-directory filter (line 60), add:
```python
# Skip DEFAULT_IGNORES directories (safety: prevents modifying dependency files)
if any(ignore in str(rel_path) for ignore in DEFAULT_IGNORES):
    continue
```

**Rationale:** The legacy script (`_scripts/ontos_scaffold.py:68-70`) had these exclusions. The native rewrite dropped them, creating a regression. Fresh projects lack `.ontosignore`, making dependency directories vulnerable to unintended scaffolding.

**These patterns apply to ALL scaffold invocations**, not just init-triggered ones. This is correct behavior -- users should never accidentally scaffold files inside dependency directories.

---

### 2.4 Path Escape Guard

**File:** `ontos/commands/init.py` (inside `_prompt_scaffold`)

When user selects custom path (choice '3'):
```python
custom_path = Path(custom_input)
if not custom_path.is_absolute():
    custom_path = project_root / custom_path
resolved = custom_path.resolve()
if not resolved.is_relative_to(project_root.resolve()):
    print("Error: Path must be within project root.", file=sys.stderr)
    return None  # Skip scaffold
if not resolved.exists():
    print(f"Error: Path '{custom_input}' does not exist.", file=sys.stderr)
    return None  # Skip scaffold
return [resolved]
```

---

## 3. Files to Modify

| File | Changes |
|------|---------|
| `ontos/commands/init.py` | Expand dirs, add InitOptions fields, add `_prompt_scaffold()`, add `_run_scaffold()`, insert call between steps 5 and 6 |
| `ontos/commands/scaffold.py` | Add `DEFAULT_IGNORES` constant, apply in `find_untagged_files()` |
| `ontos/cli.py` | Add `--scaffold`/`--no-scaffold` mutually exclusive group to `_register_init`, pass in `_cmd_init` |
| `.ontos-internal/reference/Dual_Mode_Matrix.md` | Update kernel/atom/product rows in Section 1, add version entry |
| `tests/commands/test_init_phase3.py` | Update directory assertions to include `kernel/`, `product/`, `atom/` |

## 4. New Files

| File | Purpose |
|------|---------|
| `tests/commands/test_init_scaffold.py` | Scaffold integration tests + safety tests |

---

## 4. Dual Mode Matrix Update

**File:** `.ontos-internal/reference/Dual_Mode_Matrix.md`

Update Section 1 table:

| Directory | Contributor Mode | User Mode | Notes |
|-----------|------------------|-----------|-------|
| Kernel docs | `.ontos-internal/kernel/` | `docs/kernel/` | v3.1.1+ (was flat) |
| Product docs | (N/A) | `docs/product/` | v3.1.1+ (new) |
| Atom docs | `.ontos-internal/atom/` | `docs/atom/` | v3.1.1+ (was flat) |

Add to Section 9 (Version History):
```
| v3.1.1 | Full type hierarchy in user mode: kernel/, product/, atom/ subdirectories |
```

---

## 5. Design Decisions (Final)

| ID | Decision | Rationale |
|----|----------|-----------|
| D1 | `--yes` does NOT auto-scaffold | Scaffold modifies files; default is "no." Use `--yes --scaffold` for full automation. |
| D2 | `--scaffold` defaults to docs_dir scope | Safest for CI. Whole-repo only via interactive prompt. |
| D3 | Scaffold uses `apply=True` during init | User already confirmed. No dry-run friction. |
| D4 | `reference/` and `archive/` retained | Backwards compatible, actively used. |
| D5 | No cleanup of scaffolded files on abort | RESOLVED: Atomic writes, undo unsafe, content preserved. |
| D6 | No starter `kernel/mission.md` stub | "Intent over automation." Empty dir is sufficient guidance. |
| D7 | No preview before applying scaffold | Non-destructive operation. Prompt explains action. |
| D8 | Type directories are NOT configurable | Convention over configuration. Ontological hierarchy is fixed. |

---

## 6. Test Plan

### Directory Tests

```python
def test_init_creates_full_type_hierarchy(git_repo):
    """Init creates all type directories."""
    init_command(InitOptions(path=git_repo, skip_hooks=True, no_scaffold=True))
    for subdir in ['kernel', 'strategy', 'product', 'atom', 'logs', 'reference', 'archive']:
        assert (git_repo / "docs" / subdir).is_dir()
```

### Scaffold Integration Tests

| Test | Scenario | Expected |
|------|----------|----------|
| `test_no_scaffold_flag_skips` | `--no-scaffold` | No prompt, no scaffold |
| `test_scaffold_flag_forces` | `--scaffold` with existing untagged file | File gets frontmatter, no prompt |
| `test_non_tty_skips` | Non-TTY env | No prompt, no scaffold |
| `test_no_untagged_skips` | TTY, all files tagged | No prompt shown |
| `test_prompt_decline` | User answers 'n' | No scaffold |
| `test_prompt_accept_docs_scope` | User answers 'y', '1' | Only docs/ scanned |
| `test_prompt_accept_repo_scope` | User answers 'y', '2' | Entire repo scanned |
| `test_prompt_custom_path` | User answers 'y', '3', valid path | Custom path scanned |
| `test_eof_skips_gracefully` | EOFError during prompt | Init succeeds, no scaffold |
| `test_keyboard_interrupt_skips` | Ctrl+C during prompt | Init succeeds, scaffold skipped |
| `test_scaffold_failure_nonfatal` | `scaffold_command` raises | Init succeeds with warning |
| `test_invalid_custom_path` | Non-existent path entered | Error, scaffold skipped |

### Safety Tests (from review)

| Test | Scenario | Expected |
|------|----------|----------|
| `test_default_ignores_node_modules` | Repo with `node_modules/README.md`, whole-repo scan | File NOT scaffolded |
| `test_default_ignores_venv` | Repo with `.venv/docs/guide.md`, whole-repo scan | File NOT scaffolded |
| `test_custom_path_escape_rejected` | User enters `../outside` | Error printed, scaffold skipped |
| `test_custom_path_absolute_rejected` | User enters `/tmp/other` | Error printed, scaffold skipped |
| `test_invalid_scope_defaults` | User enters '5' for scope | Defaults to docs/, prints message |
| `test_large_file_count_warning` | 100+ untagged files | Warning printed before proceeding |
| `test_dual_mode_matrix_user_dirs` | Init in user mode | kernel/, product/, atom/ created |

---

## 7. Implementation Sequence

1. Add `DEFAULT_IGNORES` to `ontos/commands/scaffold.py` and apply in `find_untagged_files()`
2. Expand directory list in `init.py` (both locations)
3. Add `scaffold`/`no_scaffold` fields to `InitOptions`
4. Implement `_prompt_scaffold()` with input validation + path escape guard
5. Implement `_run_scaffold()` with summary output
6. Insert scaffold step between steps 5 and 6 in `init_command`
7. Update `_register_init` and `_cmd_init` in `cli.py`
8. Update `Dual_Mode_Matrix.md` Section 1 and Section 9
9. Update existing directory tests in `test_init_phase3.py`
10. Create `test_init_scaffold.py` with all test cases
11. Run full test suite

---

## 8. Verification

1. `pytest tests/commands/test_init_phase3.py tests/commands/test_init_scaffold.py -v`
2. `pytest tests/commands/test_scaffold.py -v` (DEFAULT_IGNORES behavior)
3. Manual test:
   ```bash
   mkdir /tmp/t && cd /tmp/t && git init
   mkdir node_modules && echo "# x" > node_modules/x.md
   mkdir docs && echo "# y" > docs/y.md
   ontos init
   # Verify: docs/kernel/ exists, node_modules/x.md NOT scaffolded
   ```
4. `pytest tests/ -v` (full regression)

---

## 9. Deferred to v3.2

| Item | Source |
|------|--------|
| `--scaffold [PATH]` optional path argument | H5, Q4 |
| Input timeout for TTY prompts | H2 |
| Starter `kernel/mission.md` via `--skeleton` flag | Q1 (revisit) |
