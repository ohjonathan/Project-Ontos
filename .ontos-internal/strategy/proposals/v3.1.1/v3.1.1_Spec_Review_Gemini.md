# Review: v3.1.1 Init Improvements Proposal

**Reviewer:** Gemini CLI (Powered by Gemini 2.5 Pro)
**Date:** 2026-01-22
**Version Reviewed:** v3.1.1_init_improvements_proposal (Draft)

---

## Part 1: Completeness Check

| Expected Section | Present? | Adequate? | Notes |
|------------------|----------|-----------|-------|
| Motivation | ✅ | ✅ | Clear identification of onboarding gaps. |
| Proposed Changes | ✅ | ✅ | Detailed code changes and logic provided. |
| Files to Modify | ✅ | ✅ | Comprehensive list including tests. |
| Error Handling | ✅ | ✅ | Robust matrix for interactive/non-interactive failures. |
| Test Plan | ✅ | ✅ | Covers key scenarios; needs explicit test for default ignores. |
| Compatibility | ✅ | ✅ | Addressed for existing projects and config versions. |

---

## Part 2: Quality Assessment

| Aspect | Rating | Notes |
|--------|--------|-------|
| **Technical Approach** | **Good** | Using `InitOptions` and reusing `scaffold_command` is cleaner than duplicating logic. The execution order (post-directory creation, pre-map) is correct for data consistency. |
| **Behavioral Matrix** | **Good** | The matrix clearly defines behavior for CI/TTY/flags. The "non-fatal" failure mode for scaffold is the right choice for an init process. |
| **Test Coverage** | **Adequate** | Covers the interactive flow well. **Missing:** Explicit tests ensuring `node_modules` and other common junk folders are ignored during the "Entire repository" scan (see Q3). |
| **UX Design** | **Good** | The prompts are clear. Defaulting to `docs/` scope reduces "blast radius" risk. |

---

## Part 3: Open Questions Research

| Question | Research/Analysis | Recommendation | Confidence |
|----------|-------------------|----------------|------------|
| **Q1: Starter mission.md stub** | `ontos map` relies on a root node to build a meaningful graph. Without a kernel doc, the graph is often fragmented. Creating a stub allows `ontos map` to succeed immediately with a valid structure. | **YES**. Create `docs/kernel/mission.md` with `type: kernel` and a placeholder prompt ("What is the purpose of this project?"). This validates the "Activate Ontos" promise immediately. | High |
| **Q2: Preview before applying** | Interactive flows should be low-friction. `ontos scaffold` is non-destructive to content (only adds frontmatter). A preview step doubles the "click" cost. | **NO**. Skip the preview in the interactive `init` flow. Add a parenthetical note to the prompt: `(This will modify file headers)` to set expectations. | High |
| **Q3: Hardcoded exclusion patterns** | **CRITICAL.** v2 `ontos_scaffold.py` *did* have default ignores (`node_modules`, `.venv`, etc.). If v3 `io/files.py` lacks these, running "Entire repository" scan on a JS/Python project without `.ontosignore` will be catastrophic (tagging library files). | **YES**. You MUST implement hardcoded default excludes for `node_modules`, `.venv`, `.git`, `dist`, `build`, etc., merged with any `.ontosignore` found. Relying solely on a missing `.ontosignore` is unsafe for new users. | **High** |
| **Q4: `--scaffold` path argument** | CLI parity is important. Users automating setup might want to scaffold a specific source dir (e.g., `src/notes`) without interactivity. | **YES**. Update `argparse` to allow `--scaffold [PATH]` (nargs='?'). Default to `docs_dir` if flag is present but no value given. | Med |
| **Q5: `reference/` directory fate** | This is a "Patch/Polish" release. Removing or renaming directories triggers breaking changes for scripts relying on the v3.0 layout. | **KEEP AS-IS**. Do not rename or remove in v3.1.1. Defer structural cleanup to v4.0 to maintain strict backward compatibility. | High |
| **Q6: Configurable type directories** | Type inference in `ontos scaffold` relies on these directory names. Making them configurable requires refactoring inference logic to read config, adding complexity and "magic." | **NO**. Stick to "Convention over Configuration." The fixed hierarchy (`kernel`, `strategy`, etc.) is part of the Ontos opinionated structure. | High |

---

## Part 4: Issues Found

### Major Issues (Must Fix)
| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| **P-M1** | **Unsafe Scanning Defaults** | Q3 / 2.2.4 | The proposal notes "Risk: A fresh project won't have .ontosignore". This is an unacceptable risk for the "Entire repository" option. **Fix:** Explicitly mandate that the scanner must use a hardcoded `DEFAULT_IGNORES` list (node_modules, .venv, etc.) in addition to `.ontosignore`. Do not ship without this safety net. |

### Minor Issues (Consider)
| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| **P-m1** | **Partial Init State** | 2.2.7 | If `init` crashes after scaffold but before map/config completion, user is left with modified files but no config. While non-fatal, consider adding a `try/finally` block to ensure `ontos.toml` is written even if scaffold crashes, or ensure scaffold is the *last* step before the "Success" message (but before `map` is tricky). **Mitigation:** Ensure the "Success" message explicitly tells users if init completed but scaffold failed (which the spec handles). |
| **P-m2** | **CLI Argument Parity** | 2.2.2 | If interactive mode allows custom paths, the CLI flag `--scaffold` should technically allow it too (`nargs='?'`). Current spec locks CLI users to `docs/` scope only. |

---

## Part 5: Verdict

**Recommendation:** **Approve with Changes**

The proposal is solid and addresses a clear gap in the onboarding experience. However, **Issue P-M1 (Unsafe Scanning)** is a blocking regression risk compared to v2 behavior and must be addressed before implementation.

**Required Changes before Implementation:**
1.  **Mandate Default Ignores:** Update spec to ensure `node_modules`, `.venv`, etc., are ignored by default when scanning, even if `.ontosignore` is missing.
2.  **Add Mission Stub:** Include the creation of `docs/kernel/mission.md` in the directory creation step.
3.  **CLI Args:** Update spec to allow `--scaffold=[path]` for parity with interactive mode.

**Blocking issues:** 1 (P-M1)
