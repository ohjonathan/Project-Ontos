---
id: v3_2_1_external_review_remediation
type: strategy
status: draft
depends_on: []
concepts: [bugfix, quality, release, v3.2.1, external-review]
---

# v3.2.1 Implementation Spec: External Review Remediation

**Date:** 2026-02-05
**Author:** Chief Architect
**Trigger:** Thorough external LLM review of v3.2.0 release identified 15 issues (4 critical, 5 high, 6 medium). All independently verified against source code.

---

## 1. Status Enum: Silent Data Corruption

### Why this matters

When a user runs `ontos scaffold --apply`, the generated frontmatter contains `status: scaffold`. When `ontos map` later loads that document, `load_document_from_content()` in `ontos/io/files.py:155-158` tries to match `"scaffold"` against the `DocumentStatus` enum. It fails, and silently falls back to `DocumentStatus.DRAFT`:

```python
# ontos/io/files.py:155-158
try:
    doc_status = DocumentStatus(status_str)
except ValueError:
    doc_status = DocumentStatus.DRAFT  # silent corruption
```

The user wrote `status: scaffold`. The system reads it as `status: draft`. No warning, no error. The user's intent is lost.

Additionally, `ontos/commands/map.py:191` filters for documents with `status == "in_progress"`:

```python
# ontos/commands/map.py:191
in_progress = [d for d in docs.values()
    if (d.status.value if hasattr(d.status, 'value') else str(d.status)) == "in_progress"]
```

But `"in_progress"` is not in the `DocumentStatus` enum either. This filter **never matches anything**. The entire "In Progress" section of Tier 1 is dead code.

### Current enum (5 values)

```python
# ontos/core/types.py:37-43
class DocumentStatus(Enum):
    DRAFT = "draft"
    ACTIVE = "active"
    DEPRECATED = "deprecated"
    REJECTED = "rejected"
    COMPLETE = "complete"
```

### What to change

Add exactly 2 values — the ones the system actually generates or checks for:

```python
# ontos/core/types.py — add after COMPLETE
    SCAFFOLD = "scaffold"       # Level 0: auto-generated by ontos scaffold
    IN_PROGRESS = "in_progress" # Active work in progress
```

**Why only 2, not more?** The legacy `VALID_STATUS` set in `_scripts/ontos_config_defaults.py:138-142` also includes `pending_curation` and `archived`. We are NOT adding those because:
- `pending_curation` is redundant with the curation level system (level 1 = pending curation)
- `archived` has no command that generates or filters for it today
- Principle: only add enum values when there's code that produces or consumes them

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/core/types.py` | 43 | Add `SCAFFOLD` and `IN_PROGRESS` after `COMPLETE` |

### Also fix the In Progress filter

Now that `IN_PROGRESS` exists in the enum, fix the filter in `map.py:191` to use the enum properly:

```python
# Before (string comparison against non-existent value)
in_progress = [d for d in docs.values()
    if (d.status.value if hasattr(d.status, 'value') else str(d.status)) == "in_progress"]

# After (use the enum)
in_progress = [d for d in docs.values() if d.status == DocumentStatus.IN_PROGRESS]
```

This requires adding `DocumentStatus` to the imports in `map.py`.

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/commands/map.py` | 191 | Use `DocumentStatus.IN_PROGRESS` enum comparison |
| `ontos/commands/map.py` | imports | Add `DocumentStatus` to imports from `ontos.core.types` |

---

## 2. Hardcoded Critical Paths: Every User's Context Map Is Wrong

### Why this matters

`_generate_tier1_summary()` in `map.py` outputs a "Critical Paths" section with literal string paths from the Ontos-dev repository itself:

```python
# ontos/commands/map.py:203-208
cp_lines = ["### Critical Paths"]
cp_lines.append("- **Entry:** `docs/reference/Ontos_Manual.md`")
cp_lines.append("- **Strategy:** `.ontos-internal/strategy/`")
cp_lines.append("- **Logs:** `.ontos-internal/logs/`")
```

For any user who is not a contributor to Ontos itself:
- `docs/reference/Ontos_Manual.md` doesn't exist in their project
- `.ontos-internal/strategy/` doesn't exist (that's contributor-mode only)
- `.ontos-internal/logs/` doesn't exist

The config system has `paths.docs_dir` and `paths.logs_dir` that are completely ignored here.

### What to change

**Remove the hardcoded Critical Paths section entirely.** Replace it with a dynamically computed "Key Documents" section that shows the top 3 most-depended-on documents in the project (highest in-degree in the dependency graph).

This is better because:
- It reflects the user's actual project structure
- It tells an AI agent "start reading here" — which is the purpose of Tier 1
- If there are no dependencies yet, the section is omitted (no stale info)

### How it works

The dependency graph is already built by `generate_context_map()` at `map.py:64-68` via `ValidationOrchestrator`. The graph's `reverse_edges` dict maps `doc_id → [list of docs that depend on it]`. The top docs by `len(reverse_edges[doc_id])` are the most-depended-on.

However, `_generate_tier1_summary` currently receives only `docs`, `config`, and `options` — it doesn't have access to the graph. We need to either:
- **(A)** Pass the graph into `_generate_tier1_summary`, or
- **(B)** Compute in-degree from `docs` directly (each doc has `depends_on` list)

Option **(B)** is simpler — no signature changes needed. Count in-degree by iterating `docs` and tallying each `depends_on` target:

```python
# Compute in-degree from docs
in_degree: Dict[str, int] = {}
for doc in docs.values():
    for dep_id in doc.depends_on:
        if dep_id in docs:  # only count existing docs
            in_degree[dep_id] = in_degree.get(dep_id, 0) + 1

# Top 3 by in-degree
if in_degree:
    top_docs = sorted(in_degree.items(), key=lambda x: -x[1])[:3]
    kd_lines = ["### Key Documents"]
    for doc_id, count in top_docs:
        doc = docs[doc_id]
        rel_path = doc.filepath.name  # or relative to project root
        kd_lines.append(f"- `{doc_id}` ({count} dependents) — {rel_path}")
    kd_lines.append("")
    sections.append("\n".join(kd_lines))
```

If no docs have any dependents (empty graph), omit the section entirely.

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/commands/map.py` | 203-209 | Replace hardcoded Critical Paths with dynamic Key Documents |

---

## 3. Version Constant Unification + GitHub URL Fixes

### Why this matters

The package has **5+ divergent version values**:

| Location | Value | File |
|----------|-------|------|
| Package version | `3.2.0` | `ontos/__init__.py:10`, `pyproject.toml:7` |
| Legacy source scripts | `3.0.5` | `ontos/_scripts/ontos_config_defaults.py:56` |
| Bundled deployed copy | `3.0.3` | `.ontos/scripts/ontos_config_defaults.py:46` |
| Config schema default | `3.0` | `ontos/core/config.py:38` |
| User config file | `3.0` | `.ontos.toml:2` |

The GitHub URL is also wrong in two places:
- `ontos/_scripts/ontos_config_defaults.py:59` → `ohjonathan/project-ontos` (lowercase repo name)
- `.ontos/scripts/ontos_config_defaults.py:49` → `ohjona/project-ontos` (wrong username, **404**)
- Actual: `ohjonathan/Project-Ontos`

### What to change

**For the version in legacy scripts:** These are being deleted (see item 4 below), so no fix needed in `ontos/_scripts/`. But `.ontos/scripts/ontos_config_defaults.py` is a separate bundled copy at the repo root that may be used by legacy workflows. Fix its version to import from `ontos.__version__`, and fix its URLs.

**For `core/config.py:38`:** The `version: str = "3.0"` default in `OntosSection` is the schema version, not the package version. This is a separate concept and should be documented as such, but doesn't need to match the package version. No change needed here.

**For `core/proposals.py:80`:** This file imports `ONTOS_VERSION` from the legacy config. After `_scripts/` is deleted, this import will break. Change it to `from ontos import __version__`.

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `.ontos/scripts/ontos_config_defaults.py` | 46 | Change `ONTOS_VERSION` to import from `ontos.__version__` or set to `"3.2.1"` |
| `.ontos/scripts/ontos_config_defaults.py` | 49-50 | Fix `ohjona` → `ohjonathan`, `project-ontos` → `Project-Ontos` |
| `ontos/core/proposals.py` | 80 | Change `from ontos_config_defaults import ONTOS_VERSION` to `from ontos import __version__ as ONTOS_VERSION` |

---

## 4. Delete `ontos/_scripts/` Directory (4,803 Lines of Dead Code)

### Why this matters

The `_scripts/` directory contains 17 Python files totaling 4,803 lines. Ten of these directly overlap with native implementations in `commands/`. The `_cmd_wrapper` function in `cli.py:978-1045` was supposed to delegate to these scripts via `subprocess.run`, but it was **never registered with any subparser** — it's unreachable dead code.

The only active dependency is `ontos/core/paths.py`, which imports `PROJECT_ROOT` and `is_ontos_repo()` from `_scripts/ontos_config_defaults.py` in **8 places** (lines 103, 176, 200, 234, 258, 294, 318 — each with a try/except fallback pattern). There's also one import in `ontos/core/proposals.py:80`.

### What to change

**Step 1: Migrate `PROJECT_ROOT` and `is_ontos_repo()` into `core/paths.py` itself.**

These are simple definitions:

```python
# Currently in _scripts/ontos_config_defaults.py:43,46-53
PROJECT_ROOT = os.environ.get("ONTOS_PROJECT_ROOT", os.getcwd())

def is_ontos_repo() -> bool:
    return os.path.exists(os.path.join(PROJECT_ROOT, '.ontos-internal'))
```

Move these to the top of `ontos/core/paths.py` (which already imports `os`). Then replace all 8 try/except import blocks with direct references. Each block currently looks like:

```python
try:
    try:
        from ontos._scripts.ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
    except ImportError:
        from ontos_config_defaults import PROJECT_ROOT, is_ontos_repo
except ImportError:
    return 'docs/logs'  # fallback
```

After migration, these become just `PROJECT_ROOT` and `is_ontos_repo()` — no import needed since they're in the same file.

Also, `resolve_config()` at `paths.py:31-34` imports the entire `ontos_config_defaults` module. After migration, this function either needs to be simplified (it resolves legacy config settings that are mostly obsolete with the TOML config system) or kept with a graceful fallback if the module is gone.

**Step 2: Fix `ontos/core/proposals.py:80`** — change to `from ontos import __version__`.

**Step 3: Delete the entire `ontos/_scripts/` directory.**

**Step 4: Remove dead code from `cli.py`:**
- Delete `_cmd_wrapper` function (lines 978-1045)
- Delete `_get_subprocess_env` function (lines 20-46) — only used by `_cmd_wrapper`

**Step 5: Update `pyproject.toml:58`** — remove `"ontos._scripts" = ["*.py"]` from `[tool.setuptools.package-data]`.

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/core/paths.py` | top of file | Add `PROJECT_ROOT` and `is_ontos_repo()` definitions |
| `ontos/core/paths.py` | 8 blocks | Remove try/except import blocks, use local definitions |
| `ontos/core/paths.py` | 31-34 | Simplify or remove `resolve_config()` dependency on legacy defaults |
| `ontos/core/proposals.py` | 80 | `from ontos import __version__ as ONTOS_VERSION` |
| `ontos/cli.py` | 978-1045 | Delete `_cmd_wrapper` function |
| `ontos/cli.py` | 20-46 | Delete `_get_subprocess_env` function |
| `ontos/cli.py` | 10 | Remove `import subprocess` if no longer used |
| `pyproject.toml` | 58 | Remove `"ontos._scripts" = ["*.py"]` |
| `ontos/_scripts/` | entire dir | **Delete** (4,803 lines) |

### Risk note

`resolve_config()` in `paths.py:15-61` is the most complex migration piece. It tries to load user-level `ontos_config.py` files (a legacy concept superseded by `.ontos.toml`). After deleting `_scripts/`, the `from ontos._scripts import ontos_config_defaults as defaults` at line 32 will fail, falling through to `import ontos_config_defaults as defaults` (bare module import — would only work if the module is on `PYTHONPATH`). If both fail, `resolve_config` returns the provided `default` parameter, which is the correct behavior for post-migration users. However, this function should be reviewed to determine if it's still needed at all — most of its callers also have their own fallback defaults.

---

## 5. Fix scan_documents Scope

### Why this matters

The `map_command` in `ontos/commands/map.py:596-599` scans **both** `docs_dir` and `project_root`:

```python
# ontos/commands/map.py:596-599
doc_paths = scan_documents(
    [docs_dir, project_root],
    skip_patterns=config.scanning.skip_patterns
)
```

The default `skip_patterns` are only `["_template.md", "archive/*"]` (from `ontos/core/config.py:53`). This means every markdown file at the repo root — `README.md`, `CHANGELOG.md`, `AGENTS.md`, `CONTRIBUTING.md`, the generated `Ontos_Context_Map.md` — gets treated as an Ontos document.

The legacy `SKIP_PATTERNS` in `_scripts/ontos_config_defaults.py:174-181` explicitly excluded `README.md`, `.git/`, `node_modules/`, and `__pycache__/`. This knowledge was **lost** during the migration to the TOML config system.

Worse: because `Ontos_Context_Map.md` is generated with frontmatter and lives at project root, it gets picked up as a document on the next `ontos map` run — a self-referential loop that inflates the document count on each run.

### What to change

**A. Change scan to only use `docs_dir` by default:**

```python
# ontos/commands/map.py:596-599 — change to:
scan_dirs = [docs_dir]
if config.scanning.scan_paths:
    scan_dirs.extend([project_root / p for p in config.scanning.scan_paths])

doc_paths = scan_documents(scan_dirs, skip_patterns=config.scanning.skip_patterns)
```

**B. Add `scan_paths` to config:**

```python
# ontos/core/config.py — add to ScanningConfig (line 51-53)
@dataclass
class ScanningConfig:
    skip_patterns: List[str] = field(default_factory=lambda: ["_template.md", "archive/*"])
    scan_paths: List[str] = field(default_factory=list)  # extra dirs to scan beyond docs_dir
```

**C. Expand default `skip_patterns`** — as a safety net even if project root isn't scanned:

```python
skip_patterns: List[str] = field(default_factory=lambda: [
    "_template.md",
    "archive/*",
    ".git/*",
    "node_modules/*",
    "__pycache__/*",
])
```

**D. Add context map to implicit skip list** — in the map command, always skip the context map output path:

```python
# In map_command, after determining output_path:
skip = list(config.scanning.skip_patterns)
skip.append(str(output_path.name))  # skip context map itself
doc_paths = scan_documents(scan_dirs, skip_patterns=skip)
```

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/commands/map.py` | 596-599 | Scan only `docs_dir` + configured `scan_paths`; add context map to skip list |
| `ontos/core/config.py` | 51-53 | Add `scan_paths` field; expand default `skip_patterns` |

---

## 6. Remove MCP Placeholder Module

### Why this matters

`ontos/mcp/__init__.py` is a 10-line file that emits a `FutureWarning` on import. It ships in the package and does nothing. The optional dependency `pip install ontos[mcp]` installs `pydantic>=2.0` for zero functionality.

```python
# ontos/mcp/__init__.py (entire file)
"""MCP module - Placeholder for Phase 2."""
import warnings
warnings.warn(
    "The 'ontos.mcp' module is a placeholder for Phase 2. "
    "No functionality is currently available.",
    FutureWarning,
    stacklevel=2
)
```

### What to change

Delete the directory and remove the optional dependency.

### Files

| File | Change |
|------|--------|
| `ontos/mcp/` | **Delete** entire directory |
| `pyproject.toml:40-42` | Remove `mcp` optional dependency group |

---

## 7. Fix TOML Serialization of `None` Values

### Why this matters

When `ontos init` generates `.ontos.toml`, the `required_version` field defaults to `None` in the `OntosSection` dataclass (`core/config.py:39`). During serialization, `write_config()` in `io/toml.py:76-79` converts `None` to an empty string:

```python
# ontos/io/toml.py:78-79
if v is None:
    return '""'  # TOML doesn't have null, use empty string
```

This produces `required_version = ""` in the output file, which is semantically confusing — an empty string suggests "no version required" when the actual intent is "field not set."

### What to change

Skip `None` values during serialization instead of writing empty strings. Modify the serialization loops in `write_config()`:

```python
# In the nested dict loop (line 98-99):
for k, v in value.items():
    if v is not None:  # skip None values
        lines.append(f'{k} = {_format_value(v)}')

# In the top-level loop (line 101-102):
else:
    if value is not None:  # skip None values
        lines.append(f'{key} = {_format_value(value)}')
```

The `_format_value` `None` → `""` case can remain as a safety net but should no longer be reached.

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/io/toml.py` | 95-102 | Skip `None` values during serialization |

---

## 8. Hide Deprecated/Internal Commands from Help

### Why this matters

`ontos --help` shows 20 commands including 3 deprecated aliases (`tree`, `validate`, `agent-export`) and 1 internal command (`hook`). For a new user, this is overwhelming and confusing. The deprecated commands show help text like `(Deprecated) Use 'ontos map' instead` but they still clutter the listing.

### What to change

Use `argparse.SUPPRESS` for the help text of deprecated and internal commands. This hides them from `--help` output while keeping them functional:

```python
# Example for tree alias:
p = subparsers.add_parser("tree", help=argparse.SUPPRESS, parents=[parent])
```

Apply to:
- `_register_agent_export` (`cli.py:219`) — `help=argparse.SUPPRESS`
- `_register_hook` (`cli.py:280`) — `help=argparse.SUPPRESS`
- `_register_tree_alias` (`cli.py:482`) — `help=argparse.SUPPRESS`
- `_register_validate_alias` (`cli.py:496`) — `help=argparse.SUPPRESS`

The commands still work. They just don't show up in `ontos --help`.

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `ontos/cli.py` | 219 | `agent-export` → `help=argparse.SUPPRESS` |
| `ontos/cli.py` | 280 | `hook` → `help=argparse.SUPPRESS` |
| `ontos/cli.py` | 482 | `tree` → `help=argparse.SUPPRESS` |
| `ontos/cli.py` | 496 | `validate` → `help=argparse.SUPPRESS` |

---

## 9. Fix `.ontos/scripts/` Bundled Copy

### Why this matters

`.ontos/scripts/ontos_config_defaults.py` is a separate copy of the legacy config that lives at the repo root (not inside the Python package). It has:
- Wrong username: `ohjona` instead of `ohjonathan` (line 49) — **404 URL**
- Wrong repo casing: `project-ontos` instead of `Project-Ontos` (line 49-50)
- Stale version: `3.0.3` (line 46)

This file is referenced by the legacy `ontos_config.py.template` and may be used by users who initialized their projects with older Ontos versions.

### What to change

Fix the three values. Also evaluate whether this entire `.ontos/scripts/` directory is still needed — if it's only used by legacy pre-v3.0 workflows, it should be marked for deprecation.

### Files

| File | Line(s) | Change |
|------|---------|--------|
| `.ontos/scripts/ontos_config_defaults.py` | 46 | `ONTOS_VERSION = "3.2.1"` (or import from package) |
| `.ontos/scripts/ontos_config_defaults.py` | 49 | `ohjonathan/Project-Ontos` |
| `.ontos/scripts/ontos_config_defaults.py` | 50 | `ohjonathan/Project-Ontos/main` |

---

## Implementation Order

These changes have dependencies. Recommended order:

1. **Enum expansion** (item 1) — standalone, no dependencies
2. **Critical Paths replacement** (item 2) — standalone
3. **Migrate `core/paths.py` imports** (item 4, step 1-2) — must come before deletion
4. **Fix `core/proposals.py` import** (item 3) — must come before deletion
5. **Delete `_scripts/`** (item 4, step 3) — depends on 3 and 4
6. **Delete `_cmd_wrapper` and `_get_subprocess_env`** (item 4, step 4) — after deletion
7. **Update `pyproject.toml`** (items 4+6) — remove `_scripts` data, remove MCP dep
8. **Delete `ontos/mcp/`** (item 6) — standalone
9. **Fix scan_documents** (item 5) — standalone
10. **Fix TOML serialization** (item 7) — standalone
11. **Hide commands** (item 8) — standalone
12. **Fix `.ontos/scripts/` bundled copy** (item 9) — standalone
13. **Bump version to 3.2.1** — last step

---

## Files Summary

### Modified
| File | Items |
|------|-------|
| `ontos/core/types.py` | 1 |
| `ontos/commands/map.py` | 1, 2, 5 |
| `ontos/core/paths.py` | 4 |
| `ontos/core/proposals.py` | 3 |
| `ontos/core/config.py` | 5 |
| `ontos/io/toml.py` | 7 |
| `ontos/cli.py` | 4, 8 |
| `pyproject.toml` | 4, 6 |
| `.ontos/scripts/ontos_config_defaults.py` | 9 |
| `ontos/__init__.py` | version bump |

### Deleted
| Path | Lines removed | Item |
|------|---------------|------|
| `ontos/_scripts/` (17 files) | ~4,803 | 4 |
| `ontos/mcp/` (1 file) | 10 | 6 |

**Net: ~4,813 lines removed.**

---

## Verification Plan

| # | Test | Validates |
|---|------|-----------|
| 1 | `pytest tests/` | Nothing broken |
| 2 | `ontos scaffold --apply` on test doc → load it → verify status loads as `scaffold` not `draft` | Item 1 |
| 3 | `ontos map` on a non-Ontos project → no `Ontos_Manual.md` or `.ontos-internal` paths in output | Item 2 |
| 4 | `ontos map` on project with README.md at root → README not in document index | Item 5 |
| 5 | `ontos map` run twice → document count identical both times | Item 5 (context map skip) |
| 6 | `ontos --version` matches `python -c "import ontos; print(ontos.__version__)"` | Item 3 |
| 7 | `grep -r "ontos_config_defaults\|_scripts" ontos/` → zero hits | Item 4 |
| 8 | `ontos --help` → no `tree`, `validate`, `agent-export`, or `hook` in listing | Item 8 |
| 9 | `ontos tree` → still works (redirects to `map`) | Item 8 (backward compat) |
| 10 | Fresh `ontos init` → `.ontos.toml` has no `required_version = ""` line | Item 7 |
| 11 | `import ontos.mcp` → `ModuleNotFoundError` | Item 6 |
| 12 | No `ohjona` or `project-ontos` (lowercase) in any shipped file | Items 3, 9 |
| 13 | Cut GitHub release for v3.2.1 | Release |

---

## What's Deferred (requires design work or new features)

| Item | Why deferred |
|------|-------------|
| Global `--debug` flag + structured logging | Touches 34 files, needs logging architecture |
| Enforce core/IO purity boundary | Architectural refactor of `core/frontmatter.py`, `core/config.py` |
| `ontos status` command | New feature, needs UX design |
| Colored CLI output | New dependency, design decisions |
| Improved token estimation | Functional, just imprecise |
| Remove `os.chdir` from init | Needs `map_command` refactor |
| Audit 22 silent exception swallowing instances | Each needs individual judgment |
