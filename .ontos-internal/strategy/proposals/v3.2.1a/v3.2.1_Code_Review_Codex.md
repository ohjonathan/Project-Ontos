# v3.2.1 Code Review (Adversarial) — PR #61

**Review signed by:**
- **Role:** Adversarial Reviewer
- **Model:** Codex (OpenAI)
- **Review Type:** Code Review (Phase D.2)

---

## Part 1: Regression Hunt

**Test suite**
- `pytest tests/ -v` → **PASS** (552 passed, 2 skipped)

**Smoke tests**
- `ontos --version` → `ontos 3.2.1`
- `ontos --help` → **PASS** (note: deprecated/internal commands still listed with `==SUPPRESS==`)
- `ontos map --help` → **PASS**
- `ontos scaffold --help` → **PASS**
- `ontos tree --help` → **PASS** (deprecated alias still works)
- `ontos validate --help` → **PASS** (deprecated alias still works)

| Area | Regression Found? | Evidence |
|------|-------------------|----------|
| Test suite | No | 552 passed, 2 skipped |
| CLI commands | **Yes (minor)** | `ontos --help` still lists suppressed commands with `==SUPPRESS==` |
| Deprecated aliases | No | `ontos tree --help`, `ontos validate --help` ok |
| Version output | No | `ontos 3.2.1` |

---

## Part 2: Import Chain Attack

Commands executed:
- `rg "_scripts" ontos/ --type py` → only comment in `ontos/commands/scaffold.py`
- `rg "ontos_config_defaults" ontos/ --type py` → references in `ontos/core/ontology.py`, `ontos/core/paths.py`
- `python -c "from ontos.core.paths import PROJECT_ROOT, is_ontos_repo; print(PROJECT_ROOT); print(is_ontos_repo())"` → OK
- `python -c "from ontos.core.proposals import ONTOS_VERSION; print(ONTOS_VERSION)"` → **FAIL**
- `python -c "import ast; ..."` → no lingering subprocess import
- `python -c "import ontos._scripts"` → ModuleNotFoundError (expected)
- `python -c "import ontos.mcp"` → ModuleNotFoundError (expected)

| Import Path | Works? | Error (if any) |
|-------------|--------|-----------------|
| `ontos.core.paths.PROJECT_ROOT` | Yes | — |
| `ontos.core.paths.is_ontos_repo` | Yes | — |
| `ontos.core.proposals.ONTOS_VERSION` | **No** | `ImportError: cannot import name 'ONTOS_VERSION' ...` |
| `ontos._scripts.*` (should fail) | Yes (fails) | ModuleNotFoundError |
| `ontos.mcp` (should fail) | Yes (fails) | ModuleNotFoundError |

**Finding:** `ONTOS_VERSION` constant is no longer exportable from `ontos.core.proposals`, breaking the import path used in the review instructions and potentially any external code relying on it.

---

## Part 3: Edge Case Analysis

### Item 1 — Enum Expansion

Manual checks via `load_document_from_content`:

| Edge Case | Handled? | Test? |
|-----------|----------|-------|
| `status: scaffold` | Yes | Parsed as `scaffold` |
| `status: in_progress` | Yes | Parsed as `in_progress` |
| `status: garbage_value` | **Fallback to draft** | Warning emitted, status set to `draft` |
| `status: pending_curation` | **Fallback to draft** | Warning emitted, status set to `draft` |
| Case sensitivity (`Scaffold`) | **Fallback to draft** | Warning emitted, status set to `draft` |

**Risk:** `pending_curation` is still a valid curation status in ontology/config, but it is not in `DocumentStatus`, so it silently downgrades to `draft` in document parsing.

### Item 2 — Dynamic Key Documents

Manual checks via `_generate_tier1_summary`:

| Edge Case | Handled? | Test? |
|-----------|----------|-------|
| Zero documents with dependencies | Yes | “No dependency data yet.” |
| All documents depend on one document | Yes | Only that doc listed |
| Circular dependencies | Yes | No recursion in in-degree calc |
| Missing dependency IDs | Yes | Ignored (no crash) |
| >3 docs tied in-degree | **Partially** | Order stable but based on insertion; **spec says top 3 but code returns top 5** |

### Item 4 — _scripts/ Deletion

| Edge Case | Handled? | Test? |
|-----------|----------|-------|
| `resolve_config()` no legacy config | Yes | Always returns default |
| `resolve_config()` with `ontos_config.py` on `PYTHONPATH` | **No** | Returns default (legacy override ignored) |
| Fresh install | Likely | Path helpers resolve under repo root |
| Upgrade from v3.0.x with legacy config | **Risk** | Legacy overrides now ignored (breaking) |

### Item 5 — `scan_documents` Scope

| Edge Case | Handled? | Test? |
|-----------|----------|-------|
| `docs_dir` doesn’t exist | Yes | Empty scan, map still writes |
| `docs_dir` is symlink | Likely | `Path.rglob` follows dirs |
| `scan_paths` points to nonexistent directory | Yes | Silently ignored |
| Context map manually renamed | **No** | Only configured output path is skipped |
| Multiple `ontos map` runs | Yes | Stable counts in practice |

### Item 7 — TOML None Serialization

Manual serialization test:

| Edge Case | Handled? | Test? |
|-----------|----------|-------|
| Field is `None` | Yes | Skipped entirely |
| Field is empty string `""` | Yes | Written as `""` |
| Field is `0` | Yes | Written as `0` |
| Field is `False` | Yes | Written as `false` |
| Field is `[]` | Yes | Written as `[]` |

---

## Part 4: Failure Mode Analysis

| Failure | How It Happens | Detection | Impact |
|---------|----------------|-----------|--------|
| Legacy config ignored | `resolve_config()` stub always returns default | Not tested; only manual check | **High** — legacy user configs silently ignored |
| Key Documents mismatch vs spec | Code returns top 5, spec says top 3 | Manual reading | **Medium** — spec divergence, doc quality regression |
| Deprecated/internal commands still shown | `argparse.SUPPRESS` used but help output still lists | `ontos --help` | **Low** — UX regression |
| `ONTOS_VERSION` import missing | Constant removed from `ontos.core.proposals` | ImportError | **Medium** — API break for anyone relying on it |
| `pending_curation` downgraded | Status not in `DocumentStatus` | Warning + fallback | **Medium** — status semantics lost in map/filters |

---

## Part 5: Test Adequacy

| Item | Test File | Actually Tests the Fix? | Confidence |
|------|-----------|--------------------------|------------|
| 1 | `tests/test_validation.py` | **Partial** (legacy VALID_STATUS only; not `DocumentStatus` parsing/in_progress list) | Low |
| 2 | None found | **No** | Low |
| 3 | None found | **No** | Low |
| 4 | `tests/test_session_context.py` (new import paths) | **Partial** (no legacy config behavior) | Low |
| 5 | None found | **No** | Low |
| 6 | None found | **No** | Low |
| 7 | None found | **No** | Low |
| 8 | `tests/test_cli.py` | **No** (help still lists suppressed commands) | Low |
| 9 | None found | **No** | Low |

---

## Part 6: The Uncomfortable Questions (Answers)

1. **`resolve_config()` in `paths.py`** — It now always returns the default. Legacy config resolution via `ontos_config.py` is effectively dead. This is a breaking change for any user still relying on legacy overrides.

2. **Silent DRAFT fallback** — Unknown statuses (including `pending_curation` and capitalization variants) are still silently coerced to `draft` with a warning. This keeps the system running but masks semantic intent.

3. **`.ontos/scripts/` vs `ontos/_scripts/`** — They appear independent. `.ontos/scripts/ontos_config_defaults.py` loads `ontos/core/ontology.py` from a bundled copy under `.ontos/scripts/ontos/`, not from the package. No direct coupling to `ontos/_scripts/` found.

4. **`docs_dir = "."`** — The map scan will traverse the repo root. Only the configured context map path is skipped; other tooling files or prior maps could be included unless covered by skip patterns.

5. **`_format_value` dead code** — `_format_value(None)` remains, but `write_config()` now skips `None` values before calling it. This is effectively dead code and may confuse future maintainers.

---

## Part 7: Issues Found

**Critical (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| — | — | — | — |

**High (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-H1 | Legacy config overrides ignored (`resolve_config()` always default) | Simulated `ontos_config.py` on `PYTHONPATH` still yields `None` | **Breaking change** for legacy users; patch release regression |

**Medium (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-M1 | `ONTOS_VERSION` no longer importable from `ontos.core.proposals` | Import test fails with `ImportError` | API break for any external code expecting the constant |
| X-M2 | Key Documents shows top **5** despite spec calling for top **3** | Code inspection + output check | Spec divergence / UX inconsistency |
| X-M3 | `pending_curation` status coerced to `draft` | Frontmatter parse test | Curation semantics lost in map/filtering |

**Low (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-L1 | `argparse.SUPPRESS` not hiding deprecated commands | `ontos --help` output | Deprecated/internal commands still visible |

---

## Part 8: Verdict

**Robustness:** Fragile
**Recommendation:** Request changes
**Top 3 concerns:**
1. Legacy config overrides are silently ignored (breaking behavior in patch release).
2. `ONTOS_VERSION` import removed from `ontos.core.proposals` (API regression).
3. Key Documents spec mismatch (top 5 vs top 3) + status coercion for `pending_curation`.

