---
id: v3_2_1_alignment_review_claude
type: atom
status: complete
depends_on: [v3_2_1_external_review_remediation]
concepts: [alignment, code-review, pr-61, v3.2.1]
---

# v3.2.1 External Review Remediation — Alignment Review

**Review signed by:**
- **Role:** Alignment Reviewer
- **Model:** Claude Opus 4.6
- **Date:** 2026-02-06
- **Review Type:** Code Review (Alignment)

**PR:** https://github.com/ohjonathan/Project-Ontos/pull/61
**Spec:** `.ontos-internal/strategy/proposals/v3.2.1_External_Review_Remediation.md`
**Scope:** 9-item patch release (29 files changed, ~5,000 lines removed, ~116 added)

---

## 1. Spec Compliance — Detailed Check

### Item 1: Status Enum (SCAFFOLD + IN_PROGRESS)

**Spec says:**
> Add `SCAFFOLD = "scaffold"` and `IN_PROGRESS = "in_progress"` after `COMPLETE` in `DocumentStatus` enum.
> Fix `map.py:191` to use `DocumentStatus.IN_PROGRESS` enum comparison.

**Code does:**
- `ontos/core/types.py`: Adds both values after `COMPLETE`.
- `ontos/commands/map.py:191`: Uses `d.status == DocumentStatus.IN_PROGRESS`.
- `DocumentStatus` import added at `map.py:20`.

**Compliant?** Yes

---

### Item 2: Replace Hardcoded Critical Paths with Key Documents

**Spec says:**
> Remove hardcoded Critical Paths. Replace with dynamic "Key Documents" showing top 3 by in-degree.
> Format: `` - `{doc_id}` ({count} dependents) — {rel_path} ``
> If no docs have any dependents (empty graph), omit the section entirely.

**Code does (map.py:203-227):**
- Replaces hardcoded Critical Paths with dynamic in-degree computation. **Matches intent.**
- Shows top **5** instead of top 3 (`[:5]` at line 213). **Does not match spec.**
- Format uses `**{doc_id}**` (bold) instead of `` `{doc_id}` `` (backtick), and omits `{rel_path}`. **Does not match spec.**
- Always emits the `### Key Documents` header, even when empty. **Contradicts spec.**
- Adds cold-start fallback (lines 217-224) that lists kernel and strategy docs by `DocumentType`. **Not in spec. Spec says: "omit the section entirely."**
- Cold-start fallback required importing `DocumentType` at line 20, which is not in the spec's import list.

**Compliant?** No — 4 deviations (D3, D4, D5, D6)

---

### Item 3: Version Constant Unification + GitHub URL Fixes

**Spec says:**
> Fix `.ontos/scripts/ontos_config_defaults.py` version and URLs.
> Fix `core/proposals.py:80` to import from `ontos.__version__`.

**Code does:**
- `.ontos/scripts/ontos_config_defaults.py`: Version set to `"3.2.1"`, URLs corrected to `ohjonathan/Project-Ontos`.
- `ontos/core/proposals.py`: Changed to `from ontos import __version__`.

**Compliant?** Yes

---

### Item 4: Delete `ontos/_scripts/` (4,803 Lines of Dead Code)

**Spec says:**
> Step 1: Migrate `PROJECT_ROOT` and `is_ontos_repo()` into `core/paths.py`.
> `PROJECT_ROOT = os.environ.get("ONTOS_PROJECT_ROOT", os.getcwd())`
> Step 2: Fix `core/proposals.py:80`.
> Step 3: Delete `ontos/_scripts/`.
> Step 4: Delete `_cmd_wrapper` and `_get_subprocess_env` from `cli.py`.
> Step 5: Update `pyproject.toml`.

**Code does:**
- `PROJECT_ROOT` migrated to `paths.py:20`, but using `os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))` instead of spec's `os.environ.get("ONTOS_PROJECT_ROOT", os.getcwd())`. **Does not match spec (D1).**
- `is_ontos_repo()` migrated correctly (checks `.ontos-internal` in `PROJECT_ROOT`).
- All 8 try/except import blocks removed.
- `resolve_config()` simplified to return default only.
- `ontos/_scripts/` deleted (17 files, 4,803 lines).
- `_cmd_wrapper` and `_get_subprocess_env` deleted from `cli.py`.
- `pyproject.toml` updated.
- `import os` also removed from `cli.py` (spec only mentioned `import subprocess`). **(D9 — minor)**
- Whitespace normalized throughout `paths.py`. **(D10 — cosmetic)**
- **Template file `ontos/_templates/ontos_config.py.template:11` still contains `from ontos._scripts.ontos_config_defaults import *`.** This template is used by `ontos init` and will produce a broken config file. **(D2 — critical, missed scope)**

**Compliant?** Partial — steps executed correctly, but `PROJECT_ROOT` implementation semantically differs from spec, and template update was missed.

---

### Item 5: Fix scan_documents Scope

**Spec says:**
> A: Scan only `docs_dir` by default + `scan_paths` from config.
> B: Add `scan_paths` field to `ScanningConfig`.
> C: Expand default `skip_patterns` with `.git/*`, `node_modules/*`, `__pycache__/*`.
> D: Skip context map output: `skip.append(str(output_path.name))`

**Code does:**
- 5A: `map.py:614` scans `[docs_dir] + [project_root / p for p in config.scanning.scan_paths]`. **Matches.**
- 5B: `config.py` adds `scan_paths: List[str]`. **Matches.**
- 5C: `config.py` expands defaults with `.git/*`, `node_modules/*`, `__pycache__/*`. **Matches.**
- 5D: `map.py:617` uses `skip.append(str(output_path.resolve()))` (full path) instead of spec's `skip.append(str(output_path.name))` (filename only). **(D8 — minor)**

**Compliant?** Partial — 5A/5B/5C match, 5D uses different approach.

---

### Item 6: Remove MCP Placeholder Module

**Spec says:**
> Delete `ontos/mcp/` directory. Remove `mcp` optional dependency from `pyproject.toml`.

**Code does:**
- `ontos/mcp/__init__.py` deleted.
- `pyproject.toml` updated to remove MCP dependency.

**Compliant?** Yes

---

### Item 7: Fix TOML Serialization of None Values

**Spec says:**
> Skip `None` values during serialization instead of writing empty strings.

**Code does:**
- `io/toml.py`: Adds `if v is None` and `if value is None` checks in both serialization loops.

**Compliant?** Yes

---

### Item 8: Hide Deprecated/Internal Commands

**Spec says:**
> Use `argparse.SUPPRESS` for `agent-export`, `hook`, `tree`, `validate`.

**Code does:**
- All four commands now use `help=argparse.SUPPRESS`.

**Compliant?** Yes

---

### Item 9: Fix `.ontos/scripts/` Bundled Copy

**Spec says:**
> Fix version to `"3.2.1"`, fix username to `ohjonathan`, fix repo casing to `Project-Ontos`.

**Code does:**
- Version set to `"3.2.1"`, username and casing corrected.

**Compliant?** Yes

---

## 2. Spec Compliance Summary Table

| Item | Spec Requirement | Code Implementation | Match? |
|------|------------------|---------------------|--------|
| 1 — Enum: SCAFFOLD + IN_PROGRESS | Add after COMPLETE | Added after COMPLETE | Yes |
| 1 — Fix in_progress filter | Use `DocumentStatus.IN_PROGRESS` | Uses `DocumentStatus.IN_PROGRESS` | Yes |
| 2 — Replace Critical Paths | Dynamic top 3, omit if empty | Top 5, always shows with fallback | **No** (D3, D4, D5, D6) |
| 3 — proposals.py import | `from ontos import __version__` | `from ontos import __version__` | Yes |
| 3 — .ontos/scripts version | Set to "3.2.1" or import | Set to "3.2.1" | Yes |
| 3 — .ontos/scripts URLs | `ohjonathan/Project-Ontos` | `ohjonathan/Project-Ontos` | Yes |
| 4 — Migrate PROJECT_ROOT | `os.environ.get(...)` / `os.getcwd()` | `os.path.dirname(... __file__)` | **No** (D1) |
| 4 — Migrate is_ontos_repo | Check .ontos-internal in PROJECT_ROOT | Check .ontos-internal in PROJECT_ROOT | Yes |
| 4 — Remove try/except blocks | Remove 8 blocks | Removed all 8 | Yes |
| 4 — Simplify resolve_config | Review/simplify | Returns default only | Yes |
| 4 — Delete _scripts/ | Delete entire directory | Deleted | Yes |
| 4 — Delete _cmd_wrapper | Delete function | Deleted | Yes |
| 4 — Delete _get_subprocess_env | Delete function | Deleted | Yes |
| 4 — Update pyproject.toml | Remove _scripts from package-data | Removed | Yes |
| 5A — Scan docs_dir only | Remove project_root from scan | Removed | Yes |
| 5B — Add scan_paths | Add field to ScanningConfig | Added | Yes |
| 5C — Expand skip_patterns | Add .git/*, node_modules/*, __pycache__/* | Added exactly those | Yes |
| 5D — Skip context map | `skip.append(str(output_path.name))` | `skip.append(str(output_path.resolve()))` | **Partial** (D8) |
| 6 — Delete mcp/ | Delete directory | Deleted | Yes |
| 6 — Remove mcp dep | Remove from pyproject.toml | Removed | Yes |
| 7 — Skip None in TOML | Skip None during serialization | Skips None in both loops | Yes |
| 8 — Hide agent-export | `argparse.SUPPRESS` | `argparse.SUPPRESS` | Yes |
| 8 — Hide hook | `argparse.SUPPRESS` | `argparse.SUPPRESS` | Yes |
| 8 — Hide tree | `argparse.SUPPRESS` | `argparse.SUPPRESS` | Yes |
| 8 — Hide validate | `argparse.SUPPRESS` | `argparse.SUPPRESS` | Yes |
| 9 — Fix version | "3.2.1" | "3.2.1" | Yes |
| 9 — Fix username | ohjonathan | ohjonathan | Yes |
| 9 — Fix repo casing | Project-Ontos | Project-Ontos | Yes |

**Summary:** 27 of 31 line items match. 4 deviate.

---

## 3. Deviations Found

### Critical

| # | File(s) | Description | Impact |
|---|---------|-------------|--------|
| D1 | `ontos/core/paths.py:20` | `PROJECT_ROOT` uses `os.path.dirname(... __file__)` (package install path) instead of spec's `os.environ.get("ONTOS_PROJECT_ROOT", os.getcwd())` (user working directory). | For pip-installed users, `PROJECT_ROOT` points to site-packages, not their project. All `paths.py` helper functions (`get_logs_dir`, `get_archive_dir`, `get_decision_history_path`, `get_proposals_dir`, etc.) would resolve to wrong locations. These may be dead code superseded by TOML config, but this is semantically dangerous and unverified. |
| D2 | `ontos/_templates/ontos_config.py.template:11` | Template still contains `from ontos._scripts.ontos_config_defaults import *`. This module was deleted in this PR. | **`ontos init` is broken.** Users running `ontos init` get a generated config that immediately raises `ModuleNotFoundError` on import. This is a spec gap (spec never mentioned updating the template) AND an implementation gap. |

### Major

| # | File(s) | Description | Impact |
|---|---------|-------------|--------|
| D3 | `ontos/commands/map.py:213` | Key Documents shows top 5, spec says top 3. | Shows 2 extra documents in Tier 1 summary. Minor user-facing difference, but deviates from spec. |
| D4 | `ontos/commands/map.py:216-224` | Cold-start fallback added when no dependency data exists. Spec says: "omit the section entirely." | Gold-plating. Adds functionality the spec explicitly excluded. Required importing `DocumentType` (not in spec's import list). |
| D5 | `ontos/commands/map.py:215` | Output format uses `**{doc_id}** ({count} dependents)` instead of spec's `` `{doc_id}` ({count} dependents) — {rel_path} ``. | Formatting differs: bold vs backtick, missing relative path. |
| D6 | `ontos/commands/map.py:204` | `### Key Documents` header always emitted, even when empty (cold-start content fills it). Spec says "omit the section entirely" when empty. | Coupled with D4. The section is never omitted. |

### Minor

| # | File(s) | Description | Impact |
|---|---------|-------------|--------|
| D7 | `ontos/io/files.py:158-159` | Adds stderr warning for unknown status fallback. Not in spec. | Harmless improvement. Addresses the "silent corruption" concern from the spec's own motivation text. |
| D8 | `ontos/commands/map.py:617` | Context map skip uses `output_path.resolve()` (full path) instead of spec's `output_path.name` (filename). | Code approach is arguably more robust (avoids false positive skips of unrelated files with same name). May be moot since project root is no longer scanned. |
| D9 | `ontos/cli.py` | `import os` also removed. Spec only mentioned removing `import subprocess`. | Correct — `os` is genuinely unused after changes. Spec was simply incomplete. |
| D10 | `ontos/core/paths.py` | Whitespace normalization throughout (trailing spaces in docstrings). | Zero semantic impact. |

---

## 4. Scope Creep (Added, Not in Spec)

| File | Change | In Spec? | Risk |
|------|--------|----------|------|
| `ontos/io/files.py:158-159` | stderr warning for unknown status | No (D7) | Low |
| `ontos/commands/map.py:216-224` | Cold-start fallback for Key Documents | No (D4) | Medium — contradicts spec |
| `ontos/commands/map.py:20` | Import `DocumentType` (supports cold-start) | No | Low — enables D4 |
| `ontos/core/paths.py` throughout | Whitespace normalization | No (D10) | None |

---

## 5. Missing Scope (In Spec, Not in PR)

| Spec Item | Missing | Impact |
|-----------|---------|--------|
| 4 — Template update | `ontos/_templates/ontos_config.py.template` still imports `ontos._scripts` | **Critical** — `ontos init` produces broken output (D2) |

---

## 6. Backward Compatibility

| Interface | Changed? | Breaking? | Evidence |
|-----------|----------|-----------|----------|
| `ontos scaffold` output | No | No | Commands unchanged |
| `ontos map` output format | Yes | Minor | New "Key Documents" replaces "Critical Paths" |
| `ontos init` output | **Yes — broken** | **Yes** | Template imports deleted module (D2) |
| `ontos --help` | Yes | No | 4 commands hidden, still functional |
| `ontos tree` / `validate` / etc. | No | No | Still registered, still work |
| `.ontos.toml` schema | Yes | No | Additive `scan_paths` field, empty default |
| `from ontos import __version__` | Yes (3.2.0 → 3.2.1) | No | Expected version bump |
| Exit codes | No | No | Unchanged |
| `pip install ontos[mcp]` | Yes (removed) | Possibly | Modern pip warns but succeeds; older pip may fail |
| `from ontos._scripts import ...` | Yes (deleted) | Yes (internal) | Module removed — was never public API |
| `from ontos.mcp import ...` | Yes (deleted) | Yes (placeholder) | Module removed — was a FutureWarning stub |
| `ontos/core/paths.py:PROJECT_ROOT` | Yes (semantic change) | Possibly | CWD-based → package-path-based (D1) |

---

## 7. Implementation Order Compliance

All steps followed spec's recommended implementation order. No dependency violations detected. The deletion of `_scripts/` correctly occurred after migration of `PROJECT_ROOT` and `is_ontos_repo()`.

---

## 8. Verification Plan Coverage

| # | Verification | Executable? | Result |
|---|-------------|-------------|--------|
| 1 | `pytest tests/` | Yes | 552 passed, 2 skipped per PR |
| 2 | Scaffold → load → verify status | Yes | Needs manual test |
| 3 | `ontos map` on non-Ontos project | Yes | Key Documents replaces Critical Paths |
| 4 | README.md not in document index | Yes | project_root no longer scanned |
| 5 | `ontos map` idempotent count | Yes | Context map skip added |
| 6 | `--version` matches `__version__` | Yes | Both 3.2.1 |
| 7 | grep for _scripts references | **FAILS** | Template still has reference (D2) |
| 8 | `--help` hides deprecated commands | Yes | `argparse.SUPPRESS` confirmed |
| 9 | `ontos tree` still works | Yes | Still registered |
| 10 | `ontos init` → no `required_version=""` | **BLOCKED** | `ontos init` may crash due to D2 |
| 11 | `import ontos.mcp` → `ModuleNotFoundError` | Yes | Directory deleted |
| 12 | No `ohjona` or lowercase `project-ontos` | Yes (in shipped code) | Only in archived docs |

**2 of 12 verification steps fail or are blocked due to D2.**

---

## 9. Blocking Issues — Detail

### D2: Template still imports deleted `_scripts` module (CRITICAL)

**File:** `ontos/_templates/ontos_config.py.template:11`

**Content:**
```python
from ontos._scripts.ontos_config_defaults import *
```

**Why this is blocking:**
1. `ontos init` is the primary onboarding command for new users.
2. The template is used to generate the user's `ontos_config.py`.
3. The generated file will immediately fail with `ModuleNotFoundError` because `ontos._scripts` no longer exists.
4. This is a user-facing regression in a core workflow.

**Required fix:** Update the template to either remove the import line entirely (since the TOML config system supersedes it) or replace it with a valid import path. If the template concept is itself legacy (superseded by `.ontos.toml`), consider whether `ontos init` should stop generating this file.

---

### D1: `PROJECT_ROOT` semantic change (REQUIRES JUSTIFICATION)

**Spec says:**
```python
PROJECT_ROOT = os.environ.get("ONTOS_PROJECT_ROOT", os.getcwd())
```

**Code does:**
```python
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
```

**Why this needs justification:**
1. The spec's approach is dynamic (CWD-based). The code's approach is static (package-path-based).
2. For `pip install -e .` (development mode), both resolve identically.
3. For standard `pip install ontos`, the code's approach resolves to the site-packages directory. All `paths.py` helper functions (`get_logs_dir()`, `get_archive_dir()`, `get_decision_history_path()`, `get_proposals_dir()`, etc.) would construct paths inside site-packages — which is wrong.
4. The callers of these functions may be effectively dead code (superseded by the TOML config system's separate project root resolution via `Path.cwd()` in `find_project_root()`). If so, this deviation is harmless in practice.

**Required action:** The CA should explain:
- Are all `paths.py` helper function callers dead code paths?
- If not, which callers are live and how do they handle the incorrect root?
- Why was the package-path approach chosen over the spec's env-var/CWD approach?

If the CA confirms these are dead code paths, this should be documented (e.g., deprecation comment) and accepted. If any callers are live, this must be fixed.

---

## 10. Non-Blocking Issues — Recommendations

### D3-D6: Item 2 deviations (Key Documents)

**Recommendation:** Either update the code to match spec (top 3, backtick format with rel_path, omit if empty) or amend the spec to reflect the implemented behavior (top 5, bold format, cold-start fallback). The cold-start fallback (D4) is the most significant deviation since the spec explicitly said "omit the section entirely."

**Suggested resolution path:**
- If the CA believes top 5 and cold-start fallback are better UX decisions, update the spec with a brief rationale.
- If the spec is authoritative, update the code to `[:3]`, restore backtick formatting with rel_path, and remove the cold-start block.

### D7: Unspecified stderr warning

**Recommendation:** Acknowledge as an improvement. Add to spec's Item 1 section for traceability. No code change needed.

### D8: Full path vs filename for context map skip

**Recommendation:** The code's approach (`output_path.resolve()`) is defensible and arguably more robust. Acknowledge the deviation and update the spec. No code change needed.

---

## 11. Verdict

**Alignment Status:** Major Deviations

**Recommendation:** Request changes

**Blocking issues:** 2

1. **D2 (Critical):** `ontos/_templates/ontos_config.py.template` still imports `ontos._scripts.ontos_config_defaults`, a module deleted in this PR. `ontos init` is broken for all users. Fix the template or remove the legacy config generation.

2. **D1 (Needs justification):** `PROJECT_ROOT` in `paths.py` uses package-path traversal instead of the spec's CWD/env-var approach. The CA must confirm whether all callers of `paths.py` helper functions are dead code. If they are not, this introduces incorrect path resolution for pip-installed users.

**Non-blocking issues to address:** D3-D6 (Item 2 deviations should be reconciled with spec), D7 (acknowledge), D8 (acknowledge).

**What went right:**
- Items 1, 3, 6, 7, 8, 9 are fully compliant.
- The `_scripts/` deletion (-4,803 lines) was executed cleanly with correct migration order.
- The scan scope fix (Item 5) correctly narrows the scan and adds safety-net patterns.
- All 552 tests pass.

**What needs attention:**
- The template oversight (D2) is the kind of "blast radius" gap that external review processes exist to catch. The spec focused on `ontos/_scripts/` deletion but did not account for the template that references it.
- The `PROJECT_ROOT` change (D1) may be a deliberate improvement over the spec, but it was not communicated or documented as a deviation.

---

**Review signed by:**
- **Role:** Alignment Reviewer
- **Model:** Claude Opus 4.6
- **Date:** 2026-02-06
- **Review Type:** Code Review (Phase D.2)
