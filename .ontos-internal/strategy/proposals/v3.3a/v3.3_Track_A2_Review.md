---
id: v3_3_track_a2_review
type: review
status: active
depends_on:
  - v3_3_track_a2_implementation_spec
concepts:
  - v3.3a
  - track-a2
  - code-review
  - command-safety
  - hardening
  - pr-review
---

# v3.3 Track A2 Review — Command Safety & State Integrity Hardening

**Branch:** `feature/v3.3-track-a2-command-safety`
**PR:** #71
**Spec:** `v3.3_Track_A2_Implementation_Spec.md`
**Developer:** Codex
**Reviewer:** Claude Code (Tier 1 Review Team)
**Date:** 2026-02-11
**Commit:** `6c2a934`

---

## Verdict: Approve

No blocking issues across both review passes. All 13 fixes are spec-compliant. The implementation is minimal, focused, and well-tested — each fix addresses its specific defect without scope creep. Backward compatibility is preserved throughout via optional parameters with defaults. Full test suite: 782 passed, 2 skipped.

**Recommended changes:**
1. NB-2: Add explicit outside-project `doctor_command()` integration test.
2. NB-3: Add test that `--apply` mode actually writes files to disk.
3. NB-4: Add test that valid boolean values pass `_parse_bool` without warning.

---

## Pass 1: Per-Fix Spec Compliance

### Group 1: Consolidate (#45, #26, #12, #13)

#### #45 — `--count 0` Validation

| Check | Status | Notes |
|-------|--------|-------|
| Validation at command entry (not deep in logic) | PASS | `consolidate.py` line 185, first check in `consolidate_command()` |
| `count < 1` when `by_age is False` → exit 1 | PASS | `if not options.by_age and options.count < 1: return 1, "count must be >= 1"` |
| Error message matches: "count must be >= 1" | PASS | Exact string |
| Age mode behavior unchanged | PASS | Guard only fires when `not options.by_age` |
| Test exists | PASS | `test_consolidate_rejects_count_zero()` |

#### #26 — Scalar `impacts` Normalization

| Check | Status | Notes |
|-------|--------|-------|
| Uses A1's `normalize_reference_list()` | PASS | Import from `ontos.core.frontmatter`; called at line 219 |
| Applied before history row formatting | PASS | Normalized before `', '.join(impacts)` |
| `impacts: foo` → renders `foo` not `f, o, o` | PASS | Scalar string wrapped into list by normalizer |
| List impacts (`impacts: [a, b]`) still work | PASS | List input passes through normalizer unchanged |
| Test exists with scalar input | PASS | `test_consolidate_normalizes_scalar_impacts()` |

#### #12 — Consolidation Ordering/Atomicity

| Check | Status | Notes |
|-------|--------|-------|
| One `SessionContext` instance per command run | PASS | `ctx = SessionContext.from_repo(root)` at line 203 |
| Per-log commit boundaries (buffer + commit per log) | PASS | `ctx.commit()` at line 249 inside per-log loop |
| Decision-history append buffered BEFORE archive move | PASS | `append_to_decision_history(..., ctx=ctx)` at line 244, then `ctx.buffer_move()` at line 248 |
| Commit groups both operations | PASS | Single `ctx.commit()` after both buffers |
| Append failure prevents move for that log | PASS | `if not append_to_decision_history(...)` → `ctx.rollback(); continue` |
| Test covers transaction failure path | PASS | `test_consolidate_append_failure_does_not_move_log()` |

#### #13 — Non-zero Exit on Per-Log Failures

| Check | Status | Notes |
|-------|--------|-------|
| `succeeded` / `failed` lists tracked | PASS | Lines 204–205: `succeeded: List[str]`, `failed: List[Tuple[str, Path, str]]` |
| Processing continues after one log fails | PASS | `failed.append(...)` then `continue` (not `return`) |
| Exit 0 when all succeed | PASS | Line 275: `return 0, f"{action} {consolidated_count} logs"` |
| Exit 1 when any fail | PASS | Line 272: `return 1, f"Consolidated {consolidated_count} logs with {len(failed)} failures"` |
| Summary includes both lists | PASS | Lines 266–270: succeeded and failed printed with per-entry detail |
| Reconciliation guidance for failed logs | PASS | `"Reconciliation: verify listed failed logs and decision history entries before re-running consolidate."` |
| Test covers partial failure scenario | PASS | `test_consolidate_commit_failure_reports_partial_results()` |

---

### Group 2: Path Resolution (#15, #14)

#### #15 — Path Helpers Anchored to Runtime Root

| Check | Status | Notes |
|-------|--------|-------|
| Optional `repo_root` parameter on all path getters | PASS | `get_logs_dir(repo_root=None)`, `get_archive_dir(repo_root=None)`, etc. — all updated |
| Fallback root discovery uses `@lru_cache` | PASS | `@lru_cache(maxsize=128)` on `_discover_runtime_root_cached()` |
| Cache key is resolved start path (not raw cwd) | PASS | `_normalize_start_path()` resolves before caching |
| Root precedence: `.ontos.toml` → `.ontos`/`.ontos-internal` → `.git` → fail | PASS | Lines 27–38 in `_discover_runtime_root_cached()` |
| Existing callers still work without changes | PASS | All parameters optional with `None` default |
| Legacy fallback warnings preserved | PASS | `_runtime_docs_and_logs_dirs()` falls back to `resolve_config()` with deprecation warnings |
| Test: helpers resolve relative to runtime root | PASS | `test_get_logs_dir_resolves_runtime_root_from_subdirectory()` |
| Test: cached resolution doesn't re-walk | PASS | `test_runtime_root_discovery_uses_cache()` — verifies `cache_info().hits` increments |

#### #14 — Doctor Project-Root Anchoring

| Check | Status | Notes |
|-------|--------|-------|
| Root resolved once at command start | PASS | `resolve_project_root()` called at entry; result passed to all checks |
| Root passed through ALL checks | PASS | `check_configuration(repo_root=root)`, `check_git_hooks(repo_root=root)`, etc. |
| No remaining `Path.cwd()` usage in doctor | PASS | All checks accept and use `repo_root` parameter |
| Subdirectory invocation = project-root invocation | PASS | `test_check_docs_directory_from_subdirectory_matches_project_root()` |
| Outside-project → non-zero exit with root-discovery error | PASS | Root resolution failure returns CheckResult with `status="fail"` |
| Test: subdirectory parity | PASS | Present in `test_doctor_phase4.py` |
| Test: outside-project error | PASS | `test_fails_cleanly_outside_project()` — exits 1 with project_root check failure |

---

### Group 3: Parser/History (#27, #28)

#### #27 — Separator Row Filtering

| Check | Status | Notes |
|-------|--------|-------|
| Regex matches spec pattern: `^\|\s*:?-{3,}\s*(\|\s*:?-{3,}\s*)+\|?$` | PASS | `_TABLE_SEPARATOR_RE` at `proposals.py` line 14 — exact match |
| Separator rows skipped | PASS | `if _TABLE_SEPARATOR_RE.match(line.strip()): continue` at line 116 |
| Header rows still skipped | PASS | Existing `line.startswith('| Date')` guard preserved |
| Data rows still parse correctly | PASS | Separator check precedes data parsing; no data row matches separator pattern |
| Test with `\|---\|---\|` and `\|:---\|---:\|` variants | PASS | `test_load_decision_history_entries_skips_table_separator_rows()` |

#### #28 — Bare Filename dirname Fallback

| Check | Status | Notes |
|-------|--------|-------|
| `out_dir = os.path.dirname(output_path) or "."` | PASS | `history.py` line 259 — exact spec implementation |
| `output_path="decision_history.md"` works | PASS | `dirname("")` → `""` → fallback `"."` |
| `output_path="some/dir/file.md"` still works | PASS | `dirname("some/dir/file.md")` → `"some/dir"` — truthy, no fallback |
| Test exists | PASS | `test_writes_to_bare_filename_output_path()` in `test_immutable_history.py` |

---

### Group 4: Migration (#29, #48)

#### #29 — Apply/Dry-Run/Check Mode Enforcement

| Check | Status | Notes |
|-------|--------|-------|
| Mode guard at command entry | PASS | `_validate_migrate_mode(options)` called at line 67, before any processing |
| Rejects: `check` + `dry_run` | PASS | `sum(selected) != 1` catches any multi-mode |
| Rejects: `check` + `apply` | PASS | Same guard |
| Rejects: `dry_run` + `apply` | PASS | Same guard |
| Rejects: no mode specified | PASS | `sum(selected) != 1` when sum is 0 |
| `dry_run=True` never writes (trace write paths) | PASS | Line 176: `continue` before `buffer_write` when dry_run |
| `apply=True` required for writes | PASS | Only path reaching `ctx.buffer_write()` is non-dry-run, non-check |
| Test covers all invalid combinations | PASS | `test_migrate_mode_guard_rejects_missing_mode()`, `test_migrate_mode_guard_rejects_conflicting_mode()` |

#### #48 — Unsupported Schema Reporting

| Check | Status | Notes |
|-------|--------|-------|
| Unsupported = not in `SCHEMA_DEFINITIONS` OR read-only/incompatible | PASS | Lines 104–109: checks membership, then `check_compatibility()` |
| Report includes file path + schema value | PASS | `unsupported.append((f, schema, reason))` |
| `--check`: includes unsupported, non-zero exit | PASS | Lines 138–142: prints unsupported list, returns 1 |
| `--dry-run`: warnings only | PASS | Dry-run path prints but does not write |
| `--apply`: skips unsupported, counts as errors, non-zero exit | PASS | Line 191: `errors += len(unsupported)`; line 193: returns 1 |
| No `--force` flag added | PASS | Not present in CLI registration |
| Test for check mode + unsupported | PASS | `test_schema_migrate_check_reports_unsupported_schema()` |
| Test for apply mode + unsupported | PASS | `test_schema_migrate_apply_nonzero_with_unsupported_schema()` |

---

### Group 5: Template/Config/Typing (#51, #60, #61)

#### #51 — Nested USER CUSTOM Markers

| Check | Status | Notes |
|-------|--------|-------|
| Opening = FIRST `<!-- USER CUSTOM -->` | PASS | `existing_content.find(open_marker)` — first occurrence |
| Closing = LAST `<!-- /USER CUSTOM -->` | PASS | `existing_content.rfind(close_marker)` — last occurrence |
| Inner markers preserved as plain content | PASS | Extraction spans outer boundaries; inner tokens become literal text |
| Malformed/unbalanced → return generated content unchanged | PASS | `if existing_close < existing_open + len(open_marker): return content` |
| No truncation on bad markers | PASS | Every guard path returns `content` (full generated output) |
| Test: nested markers preserved | PASS | `test_preserve_user_custom_section_outermost_markers_win_with_nested_markers()` |
| Test: unbalanced markers safe | PASS | `test_preserve_user_custom_section_unbalanced_markers_do_not_truncate()` |

#### #60 — `_parse_bool` Warning Semantics

| Check | Status | Notes |
|-------|--------|-------|
| Accepted true: `1`, `true`, `yes`, `on` | PASS | `if normalized in {"1", "true", "yes", "on"}: return True` |
| Accepted false: `0`, `false`, `no`, `off` | PASS | `if normalized in {"0", "false", "no", "off"}: return False` |
| Empty string → default + `RuntimeWarning` | PASS | `if normalized == "":` → `warnings.warn(...)` → `return default` |
| Unknown token → default + `RuntimeWarning` | PASS | Fall-through after true/false sets → `warnings.warn(...)` → `return default` |
| Warning includes raw value + accepted set | PASS | `f"Unrecognized boolean value {value!r}; using default={default}. Accepted values: {accepted}."` |
| Test for empty and unknown values | PASS | `test_parse_bool_warns_on_empty_and_unknown()` |

#### #61 — `TaskResult.status` Constrained Type

| Check | Status | Notes |
|-------|--------|-------|
| `TaskStatus = Literal["success", "failed", "skipped"]` defined | PASS | Line 30 in `maintain.py` |
| `TaskResult.status` typed as `TaskStatus` | PASS | Dataclass field at line 44 |
| `TaskExecution.status` typed as `TaskStatus` | PASS | Dataclass field at line 53 |
| Runtime guard: unknown status → failed with detail | PASS | `_normalize_task_status()` returns `(STATUS_FAILED, error_message)` for non-canonical values |
| Built-in tasks unaffected | PASS | All built-in tasks return canonical constants |
| Test: invalid status → failed execution | PASS | `test_maintain_invalid_task_status_becomes_failed()` |
| Test: built-in tasks still emit valid statuses | PASS | Covered by existing maintain test suite |

---

## Pass 2: Regression & Cross-Fix Interaction

### Cross-Fix Interaction Verification

| Interaction | Risk | Status | Verification |
|-------------|------|--------|--------------|
| #15 (path helpers) + #14 (doctor) | Doctor should use same root discovery as path helpers | PASS | Doctor imports and calls `resolve_project_root()` from `ontos.core.paths` — same resolver |
| #12 (SessionContext) + #13 (per-log failures) | Failed commit must be caught, not crash the loop | PASS | `try/except` around `ctx.commit()` catches exception, appends to `failed`, calls `ctx.rollback()`, then `continue` |
| #26 (normalize impacts) + A1 normalization | Must use A1's utility, not local reimplementation | PASS | Import: `from ontos.core.frontmatter import normalize_reference_list` — exact A1 function |
| #29 (mode guard) + #48 (unsupported schema) | Unsupported behavior depends on mode; both fixes must be consistent | PASS | Mode guard validates first (line 67); unsupported detection respects active mode (check → report + exit 1; apply → skip + count as errors) |
| #60 (parse_bool) + #61 (TaskStatus) | Both tighten typing in maintain.py; no conflict expected | PASS | Independent functions, no shared state. `_parse_bool` handles config; `_normalize_task_status` handles task results |

### Backward Compatibility Verification

| Area | Check | Status |
|------|-------|--------|
| Path helpers | All signatures preserve `repo_root=None` default — existing callers work unchanged | PASS |
| Doctor checks | All accept optional `repo_root` parameter — existing callers work unchanged | PASS |
| Consolidate CLI | No CLI changes; internal refactoring only | PASS |
| Migrate CLI | No CLI changes; guard hardens API call path (CLI already enforces mutual exclusion) | PASS |
| Maintain types | `TaskStatus` constraint is additive; runtime guard absorbs invalid values gracefully | PASS |
| `_parse_bool` | Valid inputs ("true"/"false") return same values without warnings | PASS |

### Behavioral Regression Check

**Consolidate:**
- Normal `--count 3` consolidation still works end-to-end: PASS (test_consolidate_non_dry_run_updates_history_and_archives)
- List-form `impacts: [a, b]` still renders correctly: PASS (normalize_reference_list passes lists through)
- Successful consolidation still exits 0: PASS (return 0 when `failed` list empty)

**Path Resolution:**
- Commands from project root behave identically: PASS (resolve_project_root finds root at cwd)
- All existing callers work without modification: PASS (optional parameters with defaults)

**Doctor:**
- All health checks still run: PASS (check functions accept optional root, resolve internally if not provided)
- Pass/fail thresholds unchanged: PASS (no threshold modifications in diff)

**Migration:**
- CLI-invoked migration behaves identically: PASS (CLI already enforces mutual exclusion; API guard adds defense-in-depth)
- Supported schemas still migrate correctly: PASS (unsupported detection only adds new code path for non-COMPATIBLE schemas)

**Maintain:**
- Existing tasks with valid statuses behave identically: PASS (_normalize_task_status returns canonical status unchanged)
- `_parse_bool("true")` and `_parse_bool("false")` return expected values: PASS (no warnings for recognized values)

---

## Non-Blocking Issues

| ID | Category | Finding | Recommendation |
|----|----------|---------|----------------|
| NB-1 | Consistency | Path helpers accept `Optional[Union[Path, str]]` but doctor checks accept `Optional[Path]`. Minor type inconsistency across modules. | Standardize to `Optional[Union[Path, str]]` in follow-up. Non-functional — `Path` is a subset of the union. |
| NB-2 | Test gap | #14: `test_fails_cleanly_outside_project()` tests the `project_root` check result, but there is no test that exercises the full `doctor_command()` from outside a project directory to verify the command-level exit code and output. | Add `test_doctor_command_outside_project_exits_nonzero()`. |
| NB-3 | Test gap | #29: Mode guard tests verify rejection of invalid modes, but no test verifies that `--apply` mode actually writes modified files to disk (vs dry-run). | Add `test_schema_migrate_apply_writes_files()`. |
| NB-4 | Test gap | #60: `test_parse_bool_warns_on_empty_and_unknown()` verifies warning behavior but doesn't test that recognized values (`"true"`, `"false"`, `"yes"`, `"no"`, `"1"`, `"0"`, `"on"`, `"off"`) pass through without warning. | Add `test_parse_bool_accepts_valid_values_without_warning()`. |

---

## Test Coverage Assessment

### Per-Group Coverage

| Group | Fix | Test File | Tests | Spec Section 4 Items Covered |
|-------|-----|-----------|-------|------------------------------|
| 1: Consolidate | #45 | test_consolidate_root_regression.py | 1 | count=0 → exit 1 ✓ |
| | #26 | test_consolidate_root_regression.py | 1 | scalar impacts normalized ✓ |
| | #12 | test_consolidate_root_regression.py | 2 | append failure blocks move ✓; commit failure + rollback ✓ |
| | #13 | test_consolidate_root_regression.py | 1 | partial failure exit code + reporting ✓ |
| 2: Path Resolution | #15 | test_paths_runtime_root.py | 4 | subdirectory ✓; outside-project ✓; explicit root ✓; caching ✓ |
| | #14 | test_doctor_phase4.py | 2 | subdirectory parity ✓; outside-project check ✓ |
| 3: Parser/History | #27 | test_proposals_runtime_paths.py | 1 | separator rows skipped ✓ |
| | #28 | test_immutable_history.py | 1 | bare filename writes ✓ |
| 4: Migration | #29 | test_migrate_parity.py | 2 | missing mode rejected ✓; conflicting mode rejected ✓ |
| | #48 | test_migrate_parity.py | 2 | check mode reports unsupported ✓; apply mode exits non-zero ✓ |
| 5: Template/Config | #51 | test_instruction_protocol.py | 2 | nested markers ✓; unbalanced markers ✓ |
| | #60 | test_maintain.py | 1 | empty/unknown values warn ✓ |
| | #61 | test_maintain.py | 1 | invalid status → failed ✓ |

**New/modified tests:** 43 across 9 test files (+392 lines)
**Full suite:** 782 passed, 2 skipped

### Test Gaps

1. #14: No full `doctor_command()` integration test from outside-project (individual check tested, not command-level).
2. #29: No test that `--apply` writes files to disk.
3. #60: No test that valid booleans pass without warning.
4. #60: No test for `_parse_bool(True)` / `_parse_bool(False)` (bool input passthrough).

**Overall test quality: Strong.** All 13 fixes have dedicated regression tests. The gaps are in secondary verification paths, not in core safety logic. No fix is untested.

---

## Codebase Verification

### Files Changed (18 total)

| File | Lines Changed | Fixes |
|------|--------------|-------|
| `ontos/commands/consolidate.py` | +46 / -20 | #45, #26, #12, #13 |
| `ontos/commands/doctor.py` | +109 / -61 | #14 |
| `ontos/commands/instruction_protocol.py` | +23 / -16 | #51 |
| `ontos/commands/maintain.py` | +35 / -5 | #60, #61 |
| `ontos/commands/migrate.py` | +89 / -13 | #29, #48 |
| `ontos/core/history.py` | +2 / -1 | #28 |
| `ontos/core/paths.py` | +131 / -55 | #15 |
| `ontos/core/proposals.py` | +4 / -0 | #27 |
| `.ontos-internal/strategy/proposals/v3.3a/v3.3_Track_A2_Implementation_Spec.md` | +392 / -0 | Spec |
| `tests/commands/test_consolidate_root_regression.py` | +122 / -0 | New |
| `tests/commands/test_doctor_phase4.py` | +27 / -0 | New |
| `tests/commands/test_instruction_protocol.py` | +33 / -0 | New |
| `tests/commands/test_maintain.py` | +38 / -1 | Modified |
| `tests/commands/test_migrate_parity.py` | +68 / -0 | New |
| `tests/commands/test_scan_scope_integration.py` | +1 / -1 | Modified |
| `tests/core/test_paths_runtime_root.py` | +64 / -0 | New |
| `tests/core/test_proposals_runtime_paths.py` | +25 / -0 | New |
| `tests/test_immutable_history.py` | +14 / -0 | Modified |

### Change Volume

- **+1,223 / -173 lines** across 18 files
- ~439 lines implementation (8 source files)
- ~392 lines tests (9 test files)
- ~392 lines spec
- Within expected range for 13 targeted hardening fixes
