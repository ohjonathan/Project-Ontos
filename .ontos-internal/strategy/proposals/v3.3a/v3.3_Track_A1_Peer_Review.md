# v3.3 Track A1 Peer Review

**Reviewer:** Gemini (Peer Reviewer)
**Target:** PR #67 (`feature/v3.3-track-a1-unified-loader`)
**Status:** Approve with Minor Changes

---

## 1. Executive Summary

This PR successfully implements the foundational unified loader and validation hardening required for Track A1. The implementation of `load_documents` with duplicate detection and error tracking is a significant improvement over the fragmented legacy state. The normalization logic is robust, and the test coverage for new contracts is solid.

I have found **no critical blocking issues**. The changes align well with the specification and correctly address the 12 audit findings.

There are minor opportunities for cleanup and documentation polish, particularly in `ontos/core/types.py` and `ontos/io/files.py`.

---

## 2. Completeness Check

| # | ID | Item | Status | Verification |
|---|-----|------|--------|--------------|
| 1 | CC-03 | Two frontmatter parsers → canonical path | ✅ Done | `load_documents` uses `parse_frontmatter_content` canonically. Legacy `parse_frontmatter` marked non-canonical. |
| 8 | C-5 | `validate_describes_field()` list crash | ✅ Done | `validate_describes_field` now iterates `doc.describes` list safely. |
| 9 | C-7 | `depends_on`/`impacts` non-list TypeError | ✅ Done | `normalize_reference_list` handles scalars and mixed types gracefully. |
| 10 | C-8 | Duplicate ID silent overwrite | ✅ Done | `load_documents` detects collisions and returns `DocumentLoadIssue(code="duplicate_id")`. |
| 25 | C-6 | Enum coercion ValueError-only catch | ✅ Done | `normalize_type`/`normalize_status` handle coercion and report errors via callback. |
| 33 | CC-01 | Core→IO layer violation in snapshot.py | ✅ Done | `create_snapshot` moved to `ontos/io/snapshot.py`. Core module only holds types. |
| 36 | CC-05 | Duplicate `build_graph()` in query.py | ✅ Done | `query.py` refactored to use `ontos.core.graph.build_graph`. |
| 37 | CC-06 | 21 obsolete defensive enum checks | ✅ Done | `build_graph`, `snapshot.py`, etc., now access `.value` directly on guaranteed enums. |
| 40 | CC-09 | Five document loading patterns | ✅ Done | `load_documents` consolidates loading logic. |
| 41 | CC-11 | Duplicate `normalize_depends_on` | ✅ Done | `frontmatter.py` now uses shared `normalize_reference_list`. |
| 42 | CC-16 | `validate_concepts()` never called | ✅ Done | `validate_concepts()` added to `ValidationOrchestrator` with structural checks. |
| 44 | CC-19 | Asymmetric validation severity | ✅ Done | `ValidationOrchestrator` uses configurable `severity_map`. |

---

## 3. Issues Found

### Major (Should Fix Before Merge)

*None found.*

### Minor (Consider)

1.  **Duplicate Import in `ontos/io/files.py`:**
    *   File: `ontos/io/files.py`
    *   Issue: `from ontos.core.cache import DocumentCache` is imported but seemingly unused inside `load_document_from_content`. It is used in `load_documents`, so the import at module level is fine, but the local import inside `load_document_from_content` (lines 294-300 in diff) seems redundant or misplaced if `DocumentCache` isn't used there.
    *   Suggestion: Remove the unused local import.

2.  **`CurationLevel` Move:**
    *   File: `ontos/core/types.py`
    *   Observation: `CurationLevel` was moved here. This is good for circular deps, but existing code in `curation.py` might need to be double-checked to ensure it doesn't try to re-define it if the import fails (though the diff shows it imports it).
    *   Verification: `ontos/core/curation.py` correctly imports it.

3.  **Typos in Severity Map Keys:**
    *   File: `ontos/core/validation.py`
    *   Observation: `REFERENCE_SEVERITY_DEFAULT` uses "orphan" (singular). `ValidationErrorType.ORPHAN` matches this. Just noting to ensure config keys in `.ontos.toml` (if exposed) match this singular/plural convention.

---

## 4. Spec Deviations

*   **Deviation:** `load_frontmatter` was added as a public helper in `ontos/io/files.py`.
    *   **Impact:** Improvement. Makes single-file loading with error tracking easier for tests and edge cases.
*   **Deviation:** `DocumentLoadIssue` includes `doc_id`, `field`, `value` attributes.
    *   **Impact:** Improvement. Allows for structured error reporting in the future (e.g. JSON output).

---

## 5. Positive Observations

*   **Robust Duplicate ID Detection:** The `duplicate_ids` dictionary in `DocumentLoadResult` is a great design choice. It allows the caller to decide how to handle collisions (e.g., report all paths) rather than just failing hard on the first one.
*   **Configurable Severity:** The `severity_map` injection into `ValidationOrchestrator` is excellent for the upcoming `link-check` command, which needs to distinguish between "hard errors" (broken depends_on) and "warnings" (orphans).
*   **Test Coverage:** The new tests in `tests/test_document_loading_contract_a1.py` cover the edge cases (bad enums, bad references) exactly as requested in the audit.

---

## 6. Verdict

**Approve with Minor Changes**

The code is solid and ready for the `v3.3` feature track. Please address the minor unused import in `ontos/io/files.py` before merging.
