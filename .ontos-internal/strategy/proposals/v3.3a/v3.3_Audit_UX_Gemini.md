# Codebase Audit: UX Consistency & CLI Behavior Gaps

**Auditor:** Gemini (Gemini 2.5 Pro)
**Date:** 2026-02-10
**Scope:** Project Ontos v3.2.3

---

## Executive Summary

The Project Ontos CLI has evolved significantly, but it suffers from "interface drift" where individual commands have developed their own dialect for flags, status reporting, and JSON output. The most critical UX gaps are the **overloaded `-f` short flag**, **hallucinated features in the documentation**, and **broken JSON output contracts** in several core commands.

---

## Cross-Command Findings

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-1` |
| **Command(s)** | `init`, `map`, `env`, `agents`, `export data`, `export claude`, `migration-report`, `migrate` |
| **Category** | Flag Consistency |
| **Severity** | P1 |
| **Current behavior** | The `-f` short flag is overloaded with three different meanings: `--force` (in most commands), `--filter` (in `map`), and `--format` (in `env`). |
| **Expected behavior** | Short flags should be globally consistent or at least avoid direct conflict for high-use operations. `-f` should almost certainly be reserved for `--force` given its prevalence. |
| **Effort** | Small (Update `cli.py` registration) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-2` |
| **Command(s)** | `log`, `promote`, `query`, `consolidate`, `verify` |
| **Category** | Output Format |
| **Severity** | P1 |
| **Current behavior** | The `--json` flag is registered globally but ignored or partially broken in many commands. `OutputHandler` prints emojis and formatted text to stdout even when `--json` is requested, resulting in unparseable mixed output. |
| **Expected behavior** | Commands must respect the `--json` flag by either suppressing all `OutputHandler` calls and emitting a final JSON result, or by using `JsonOutputHandler` for all structured communication. |
| **Effort** | Large (Refactor `OutputHandler` or command-level handlers) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-3` |
| **Command(s)** | `scaffold`, `maintain`, `consolidate`, `schema-migrate` |
| **Category** | Flag Consistency |
| **Severity** | P2 |
| **Current behavior** | Inconsistent "Dry Run" UX. `maintain` uses `--dry-run, -n` (default OFF). `scaffold` uses `--apply` and `--dry-run` (default ON). `schema-migrate` uses `--dry-run, -n` and `--apply` as mutually exclusive required flags. |
| **Expected behavior** | Unified pattern for destructive operations. Standard recommendation: `--dry-run` is the default for high-risk operations, with `-n` as a consistent alias. |
| **Effort** | Medium (CLI registration + handler logic) |

---

## Command-Specific Findings

### `map`

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-4` |
| **Command(s)** | `map` |
| **Category** | Help Text |
| **Severity** | P2 |
| **Current behavior** | `map --help` claims `--obsidian` enables "wikilinks, tags". Codebase inspection of `map.py` shows zero tag-related output logic; it only handles wikilink formatting. |
| **Expected behavior** | Help text should accurately reflect implemented features. |
| **Effort** | Small (Update `cli.py`) |

### `log`

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-5` |
| **Command(s)** | `log` |
| **Category** | Doc Drift |
| **Severity** | P1 |
| **Current behavior** | `Ontos_Manual.md` documents `--enhance` and `--list-concepts` flags for `ontos log`. These flags do not exist in the CLI parser or the command handler. |
| **Expected behavior** | Remove from documentation or implement the missing features. |
| **Effort** | Small (Doc fix) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-6` |
| **Command(s)** | `log` |
| **Category** | Flag Consistency |
| **Severity** | P2 |
| **Current behavior** | `log` uses `--auto` to skip confirmation. `init` uses `--yes/-y`. `consolidate` uses `--all/-a`. `promote` uses `--all-ready`. |
| **Expected behavior** | Use a consistent "non-interactive" flag like `--yes` or `--non-interactive` across all commands that prompt. |
| **Effort** | Small |

### `doctor` & `maintain`

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-7` |
| **Command(s)** | `doctor`, `maintain` |
| **Category** | Output Format |
| **Severity** | P2 |
| **Current behavior** | `doctor` reports statuses as `[pass, fail, warn]`. `maintain` reports statuses as `[success, failed, skipped]`. |
| **Expected behavior** | Unified status terminology for internal diagnostics and task runners. |
| **Effort** | Medium |

### `query`

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-8` |
| **Command(s)** | `query` |
| **Category** | Output Format |
| **Severity** | P2 |
| **Current behavior** | `query --health` produces a custom report with its own ASCII styling (`ðŸ“Š Graph Health Report`) that ignores the global `--quiet` flag for its main report body. |
| **Expected behavior** | Diagnostic reports should follow `OutputHandler` patterns and respect quiet/JSON flags. |
| **Effort** | Small |

### `agents` & `export`

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-9` |
| **Command(s)** | `agents`, `export claude` |
| **Category** | Discoverability |
| **Severity** | P2 |
| **Current behavior** | `agents` generates `AGENTS.md` and `.cursorrules`. `export claude` (buried under `export` subcommands) generates `CLAUDE.md`. These are all "AI Agent instructions" but are split across unrelated command branches. |
| **Expected behavior** | Consolidate agent instruction generation under a single command or clear hierarchy (e.g., `ontos agents --format claude`). |
| **Effort** | Medium |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-10` |
| **Command(s)** | `agents` |
| **Category** | Discoverability |
| **Severity** | P3 |
| **Current behavior** | `agents` has a hidden alias `agent-export`. |
| **Expected behavior** | Deprecated aliases should be visible with a warning (like `export`) or removed if v3.0 cleanup is active. |
| **Effort** | Small |

---

## Documentation vs. Code Drift

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-11` |
| **Command(s)** | All |
| **Category** | Doc Drift |
| **Severity** | P1 |
| **Current behavior** | `Ontos_Manual.md` and various `README` files still use `python3 ontos.py [cmd]` in examples. The tool has been a native package since v3.0, and `ontos.py` does not exist in the root (it is `ontos/__main__.py`). |
| **Expected behavior** | All documentation should use the `ontos [cmd]` syntax. |
| **Effort** | Small |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-12` |
| **Command(s)** | `update` |
| **Category** | Doc Drift |
| **Severity** | P2 |
| **Current behavior** | `Ontos_Manual.md` Section 10 lists `update` as a command. `cli.py` has no `update` command registered. |
| **Expected behavior** | Implement `update` (for pip package updates) or remove from command list. |
| **Effort** | Small |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-13` |
| **Command(s)** | `maintain` |
| **Category** | Doc Drift |
| **Severity** | P2 |
| **Current behavior** | `Ontos_Manual.md` lists `Migrate` as task 1 of `maintain`. The code and `--help` call it `migrate_untagged`. |
| **Expected behavior** | Align task names between documentation and CLI help. |
| **Effort** | Small |

---

## Error Handling

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-G-14` |
| **Command(s)** | All |
| **Category** | Error Messages |
| **Severity** | P2 |
| **Current behavior** | CLI catch-all (`cli.py:1053`) prints `Error: [Exception Message]`. If an internal error occurs (like `KeyError` or `ImportError`), the user gets a cryptic python message without context. |
| **Expected behavior** | Differentiate between `UserError` (bad flags/missing files) and `InternalError` (code bugs). Internal errors should suggest reporting a bug. |
| **Effort** | Medium |

---

**Total Findings:** 14
**P1 Severity:** 4
**P2 Severity:** 9
**P3 Severity:** 1

**Report Concluded.**
