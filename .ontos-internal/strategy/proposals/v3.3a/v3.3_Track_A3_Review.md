---
id: v3_3_track_a3_review
type: review
status: active
depends_on:
  - v3_3_release_plan
concepts:
  - v3.3a
  - track-a3
  - code-review
  - cli-surface
  - json-envelope
  - pr-review
---

# v3.3 Track A3 Review (Re-Review) — CLI Surface, Output & Taxonomy

**Branch:** `feature/v3.3-track-a3-cli-surface`
**PR:** #73
**Spec:** v3.3 Track A3 — 20 items from release plan
**Developer:** Codex
**Reviewer:** Claude Code (Tier 1 Review Team)
**Date:** 2026-02-12
**Commits:** 4 (`132740b`, `0d33bce`, `a251230`, `7fb36b6`)

---

## Verdict: Approve

All 20/20 spec items pass. Previous blocking issue B-1 (JSON envelope helpers unused) is fully resolved — `_emit_handler_result_json()` is now called 18× across CLI command handlers. The remediation commit (`7fb36b6`) unified JSON envelopes, consolidated instruction exports, and addressed all 16 previously-unimplemented items.

**Recommended changes (non-blocking):**
1. NB-1: Migrate `rename.py` ad-hoc JSON to envelope helpers.
2. NB-3: Expand parameterized envelope conformance test to cover more commands.

---

## Previous Review Summary

| Review | Date | Verdict | Items Passing | Blocking Issues |
|--------|------|---------|---------------|-----------------|
| Initial | 2026-02-11 | Request Changes | 4/20 | B-1: `emit_command_success` never called |
| **Re-Review** | **2026-02-12** | **Approve** | **20/20** | **None** |

B-1 Resolution: `_emit_handler_result_json()` helper introduced in `cli.py:33-57`. Delegates to `emit_command_success()`/`emit_command_error()`. Called by 18 of 20 CLI command handlers. Remaining 2 (`map`, `log`) call envelope helpers directly within their command modules.

---

## Pass 1: Per-Item Spec Compliance

### Group 1: JSON Envelope & Error Taxonomy (#3, #6, #24)

#### #3 — JSON Envelope Schema v3.3

| Check | Status | Notes |
|-------|--------|-------|
| `emit_command_success()` emits all 8 required keys | PASS | `json_output.py:116` — schema_version, command, status, exit_code, message, data, warnings, error |
| `emit_command_error()` emits all 8 required keys | PASS | `json_output.py:140` — same 8 keys; error object has code + optional details |
| `schema_version` = "3.3" | PASS | Default parameter in both helpers |
| `_emit_handler_result_json()` delegates correctly | PASS | `cli.py:33-57` — success → `emit_command_success()`, failure → `emit_command_error()` |
| Command handlers use envelope | PASS | 18 call sites of `_emit_handler_result_json` in cli.py; map and log call helpers directly |
| Deprecated `emit_error()` warns | PASS | `DeprecationWarning` issued, delegates to `emit_command_error()` |
| Test: envelope schema (success) | PASS | `test_json_output.py` — verifies all 8 required keys |
| Test: envelope schema (error) | PASS | `test_json_output.py` — verifies all keys + error object |
| Test: multi-command conformance | PASS | `test_json_contract_a3.py` — parameterized test across query, doctor, export data |

#### #6 — Error Taxonomy

| Check | Status | Notes |
|-------|--------|-------|
| `OntosUserError` exists (message, code, details) | PASS | `core/errors.py:10` — frozen dataclass, `code="E_USER_INPUT"` default |
| `OntosInternalError` exists (message, code, details) | PASS | `core/errors.py:22` — frozen dataclass, `code="E_INTERNAL"` default |
| `OntosUserError` → exit 2 in CLI | PASS | `cli.py` main() — catches, emits JSON envelope, returns 2 |
| `OntosInternalError` → exit 5 in CLI | PASS | `cli.py` main() — catches, emits JSON envelope, returns 5 |
| Unexpected `Exception` → exit 5 | PASS | `cli.py` main() — catches, emits `E_INTERNAL`, returns 5 |
| `KeyboardInterrupt` → exit 130 | PASS | Separate handler, prints "Interrupted" to stderr |

#### #24 — Return Contract Normalization

| Check | Status | Notes |
|-------|--------|-------|
| All public `*_command(options)` return `int` | PASS | 22 commands verified |
| Internal `_run_*` preserve `Tuple[int, str]` | PASS | Message passed via tuple to CLI handler for envelope emission |
| No tuple returns leak to CLI dispatcher | PASS | All `_cmd_*` extract int from tuple, return `int` |
| Test: public command returns int | PASS | Multiple test files assert `isinstance(result, int)` |

---

### Group 2: CLI Flag & Alias Normalization (#2, #7, #16, #17, #18, #35)

#### #2 — Map `-f` → `-F` with Deprecation

| Check | Status | Notes |
|-------|--------|-------|
| `-F` registered as primary flag | PASS | `cli.py:167` — `"--filter", "-F", "-f"` |
| `-f` still accepted | PASS | Listed as third option in `add_argument` |
| Deprecation warning on `-f` | PASS | `cli.py:670` — `Warning: map -f is deprecated; use -F.` to stderr |
| Help text mentions deprecation | PASS | `"Use -F; -f is deprecated."` |

#### #7 — Log `--auto`/`--yes` Alias

| Check | Status | Notes |
|-------|--------|-------|
| `--auto` and `--yes` both registered | PASS | `cli.py:190` — `"--auto", "--yes", dest="auto"` |
| Both route to same dest | PASS | `dest="auto"` |

#### #16 — Scaffold Dry-Run Default

| Check | Status | Notes |
|-------|--------|-------|
| `ScaffoldOptions.dry_run` defaults to `True` | PASS | `scaffold.py:31` — `dry_run: bool = True` |
| `--apply` / `--dry-run` flags in parser | PASS | CLI registration has both flags |

#### #17 — Env `-f` Deprecation

| Check | Status | Notes |
|-------|--------|-------|
| `--format` registered as primary | PASS | `cli.py:289` — `"--format", "-f"` |
| Deprecation help text | PASS | `"Short flag -f is deprecated."` |
| Deprecation warning on `-f` | PASS | `cli.py:796` — `Warning: env -f is deprecated; use --format.` to stderr |

#### #18 — Consolidate `--all`/`--yes` Aliases

| Check | Status | Notes |
|-------|--------|-------|
| `--all`, `-a`, `--yes` all registered | PASS | `cli.py:501` — `"--all", "-a", "--yes"` |
| All route to same dest | PASS | Single `action="store_true"` |

#### #35 — Promote `--yes` Flag

| Check | Status | Notes |
|-------|--------|-------|
| `--yes` registered on promote | PASS | CLI promote parser |
| Interactive prompt bypassed when set | PASS | promote.py checks `options.yes` before prompting |

---

### Group 3: Command Hardening (#39, #43, #46, #47, #49, #50)

#### #39 — Promote/Verify Commit Exception Wrapping

| Check | Status | Notes |
|-------|--------|-------|
| promote.py `ctx.commit()` wrapped | PASS | Lines 233-236, 292-295 — `try/except Exception as exc` |
| verify.py `ctx.commit()` wrapped | PASS | Lines 149-151, 214-217, 258-261 — `try/except Exception as exc` |
| Error reported via `output.error()` | PASS | Both modules print commit failure message |
| No `OntosInternalError` raised | PASS | Correct — commit failure is operational, not internal |

#### #43 — Dead `dry_run` Fields Removal

| Check | Status | Notes |
|-------|--------|-------|
| `EndSessionOptions.dry_run` removed | PASS | log.py — field no longer present |
| `GenerateMapOptions.dry_run` removed | PASS | map.py — field no longer present |
| No callers broken | PASS | Fields were unused |

#### #46 — Stub Validation → `OntosUserError`

| Check | Status | Notes |
|-------|--------|-------|
| `_validate_stub_params()` exists | PASS | `stub.py:186` |
| Missing ID raises `OntosUserError` | PASS | `stub.py:190` — `code="E_USER_INPUT"` |
| Invalid type raises `OntosUserError` | PASS | `stub.py:192-199` |
| Invalid depends-on raises `OntosUserError` | PASS | `stub.py:208-211` |
| Empty dependency raises `OntosUserError` | PASS | `stub.py:211` |
| All → exit 2 via main() routing | PASS | `OntosUserError` caught in cli.py → returns 2 |

#### #47 — Scaffold Exception Hardening

| Check | Status | Notes |
|-------|--------|-------|
| Specific exception types | PASS | `scaffold.py:113` — `(OSError, UnicodeDecodeError, ValueError)` |
| `runtime_failures` tracking | PASS | `scaffold.py:35` — `List[str]` field, accumulated through discovery and processing |
| Per-path failures surfaced | PASS | `discovery_failures` and processing `failures` merged into `options.runtime_failures` |

#### #49 — Query `--health` Cycle Detection

| Check | Status | Notes |
|-------|--------|-------|
| `detect_cycles` imported | PASS | `query.py:11` — from `ontos.core.graph` |
| Cycles computed in health | PASS | `query.py:94` — `cycles = detect_cycles(graph)` |
| Count and samples in output | PASS | `query.py:138-139` — `'cycles': len(cycles), 'cycle_samples': cycles[:10]` |
| Display formatting | PASS | `format_health()` includes `Cycles:` line and sample display |

#### #50 — Maintain `--skip` Unknown Validation

| Check | Status | Notes |
|-------|--------|-------|
| Unknown skip names detected | PASS | `maintain.py:786` — `unknown_skips = sorted(skip_names - known_names)` |
| Raises `OntosUserError` | PASS | `maintain.py:789-790` — includes valid task list in message |
| → exit 2 via main() routing | PASS | `OntosUserError` caught in cli.py → returns 2 |

---

### Group 4: Module Restructuring & Output (#19, #21, #34, #58, #62)

#### #19 — Doctor Vocabulary Migration

| Check | Status | Notes |
|-------|--------|-------|
| `CheckResult.status` uses new vocabulary | PASS | `doctor.py:24` — comment: `# "success", "failed", "warning"` |
| `DoctorResult.status` property updated | PASS | `doctor.py:48-52` — returns "success"/"failed"/"warning" |
| All individual checks use new values | PASS | Grep confirms "success", "failed", "warning" throughout; no "pass"/"fail"/"warn" |
| Tests updated | PASS | `test_doctor_phase4.py` uses new vocabulary |

#### #21 — Shared Instruction Backend

| Check | Status | Notes |
|-------|--------|-------|
| `core/instruction_artifacts.py` exists | PASS | 407 lines — centralizes AGENTS.md, .cursorrules, CLAUDE.md generation |
| `core/instruction_protocol.py` exists | PASS | 147 lines — protocol config, rendering helpers |
| Key functions present | PASS | `find_repo_root()`, `gather_stats()`, `generate_agents_content()`, `generate_agents_files()`, `generate_claude_file()`, `transform_to_cursorrules()`, `generate_all_instruction_exports()` |

#### #34 — Agents.md / .cursorrules Extraction

| Check | Status | Notes |
|-------|--------|-------|
| `agents.py` stripped | PASS | Reduced from 405 to ~49 lines (−377 lines) |
| Delegates to `instruction_artifacts` | PASS | Imports `generate_agents_content`, `generate_agents_files` |
| No logic duplication | PASS | All generation logic lives in `core/instruction_artifacts.py` |

#### #58 — OutputHandler Migration

| Check | Status | Notes |
|-------|--------|-------|
| `doctor.py` uses OutputHandler | PASS | Imports from `ontos.ui.output` |
| `init.py` uses OutputHandler | PASS | Imports from `ontos.ui.output` |
| `log.py` uses OutputHandler | PASS | `log.py:257` — `OutputHandler(quiet=...)` |
| JSON via envelope helpers | PASS | All three use `emit_command_success`/`emit_command_error` |

#### #62 — Export `--all`

| Check | Status | Notes |
|-------|--------|-------|
| `--all` flag registered | PASS | `cli.py:304` — `"--all", dest="all_formats"` |
| Imports from `instruction_artifacts` | PASS | `cli.py:947` — `from ontos.core.instruction_artifacts import ...` |
| Generates AGENTS.md + .cursorrules + CLAUDE.md | PASS | `generate_all_instruction_exports()` called |
| Test exists | PASS | `test_export_all.py` — verifies all three artifacts generated |

---

## Pass 2: Regression & Cross-Fix Interaction

### Cross-Fix Interaction Verification

| Interaction | Risk | Status | Verification |
|-------------|------|--------|--------------|
| #3 + #6: Envelope error routing | Error taxonomy must emit full envelope | PASS | `main()` catches `OntosUserError`/`OntosInternalError`, emits envelope via `emit_command_error()` with correct exit codes (2, 5) |
| #3 + #24: Envelope + return contracts | CLI handler must emit JSON before returning int | PASS | `_emit_handler_result_json()` reads exit_code + message from `_run_*()` tuple, emits envelope, then returns `int` |
| #21 + #34 + #62: Instruction backend | No duplication between agents.py and export --all | PASS | Both delegate to `instruction_artifacts`. No shared-state conflicts |
| #19 + #58: Doctor vocabulary + OutputHandler | OutputHandler and JSON must use same vocabulary | PASS | OutputHandler for human text; JSON envelope uses vocabulary-migrated values from `DoctorResult.status` |
| #39 + #6: Commit wrapping + error taxonomy | Commit failure should NOT raise typed error (operational, not user error) | PASS | Both promote.py and verify.py catch with generic `Exception`, report via `output.error()` |
| #46 + #50 + #6: User error routing | Stub and maintain --skip both raise OntosUserError | PASS | Both caught in `main()` → exit 2 with JSON envelope in `--json` mode |
| #2 + #17: Flag deprecation consistency | Both flags emit stderr warnings with same pattern | PASS | Same pattern: `Warning: X is deprecated; use Y.` |

### Backward Compatibility

| Area | Check | Status |
|------|-------|--------|
| Public command signatures | All preserve optional parameters with defaults | PASS |
| CLI flags | New aliases don't remove existing flags | PASS |
| JSON output | `emit_error()` deprecated but still functional (issues `DeprecationWarning`) | PASS |
| Return types | Public `*_command()` → `int` (was Tuple); all internal callers updated | PASS |
| A2 fixes | No A2 code paths modified or broken | PASS |
| Track B commands | `link-check` and `rename` unaffected | PASS |

### Exit Code Consistency

| Code | Meaning | Usage | Status |
|------|---------|-------|--------|
| 0 | Success | All commands on success | PASS |
| 1 | Operation failure | Broken refs, task failures, partial scaffold | PASS |
| 2 | Usage error | No command, `OntosUserError`, stub/maintain validation | PASS |
| 5 | Internal error | `OntosInternalError`, unexpected Exception | PASS |
| 130 | KeyboardInterrupt | SIGINT handler | PASS |

---

## Non-Blocking Issues

| ID | Category | Finding | Recommendation |
|----|----------|---------|----------------|
| NB-1 | Consistency | `rename.py` uses ad-hoc `json.dumps()` (L1143) instead of envelope helpers. Rename JSON output does not conform to v3.3 envelope schema. | Migrate rename JSON output to envelope helpers in follow-up. |
| NB-2 | Consistency | `hook` command returns directly without any JSON handling. If `--json` is passed, no JSON output is emitted. | Add envelope support if hook is expected to support `--json` mode. |
| NB-3 | Test gap | Envelope conformance test (`test_json_contract_a3.py`) covers only 3 commands (query, doctor, export data). Other commands (init, agents, scaffold, stub, etc.) not tested for envelope shape. | Expand parameterized test to cover more commands. |

---

## Test Coverage Assessment

### New Tests

| Test File | Lines | Coverage |
|-----------|-------|----------|
| `tests/commands/test_json_contract_a3.py` | 61 (new) | Parameterized envelope conformance: query, doctor, export data |
| `tests/commands/test_export_all.py` | 55 (new) | Export --all generates all 3 artifacts; JSON envelope; failure handling |

### Updated Tests (11 files)

| Test File | Changes | Key Updates |
|-----------|---------|-------------|
| `tests/test_cli_phase4.py` | +73 | CLI error routing, envelope tests, global option propagation |
| `tests/ui/test_json_output.py` | +51 | Envelope helper schema tests |
| `tests/commands/test_doctor_phase4.py` | +29/−27 | Vocabulary migration (success/failed/warning) |
| `tests/commands/test_agents.py` | +19/−8 | Return contract, instruction_artifacts delegation |
| `tests/commands/test_init_scaffold.py` | +22/−22 | Return contract normalization |
| `tests/commands/test_init_phase3.py` | +17/−16 | Return contract normalization |
| `tests/commands/test_export_phase4.py` | +22 | Return contract normalization |
| `tests/commands/test_env.py` | +19 | Return contract normalization |
| `tests/commands/test_consolidate_root_regression.py` | +10 | Return contract normalization |
| `tests/commands/test_maintain.py` | +10 | Return contract normalization |
| `tests/test_cli.py` | +14 | CLI dispatch tests |

**Full suite:** 795 passed, 2 skipped. All 5 CI matrix jobs passing.

---

## Codebase Verification

### Change Volume

- **4 commits**, **43 files changed**, **+2,005 / −1,046 lines**
- Dominated by: CLI handler envelope migration (+463/−114 in cli.py), instruction_artifacts extraction (+407 new + −377 from agents.py), return contract normalization (18 modules × wrapper pattern)

### Key New/Modified Files

| File | Change | Items |
|------|--------|-------|
| `ontos/cli.py` | +463/−114 | #2, #3, #6, #7, #16, #17, #18, #24, #35, #62 |
| `ontos/core/instruction_artifacts.py` | +407 (new) | #21, #34, #62 |
| `ontos/core/instruction_protocol.py` | +147 (new) | #21 |
| `ontos/core/errors.py` | +30 (new) | #6 |
| `ontos/ui/json_output.py` | +73 | #3 |
| `ontos/commands/doctor.py` | +142/−66 | #19, #58 |
| `ontos/commands/scaffold.py` | +98/−23 | #47 |
| `ontos/commands/maintain.py` | +82/−19 | #50 |
| `ontos/commands/promote.py` | +63/−14 | #35, #39 |
| `ontos/commands/stub.py` | +55/−12 | #46 |
| `ontos/commands/query.py` | +36/−12 | #49 |
| `ontos/commands/agents.py` | −377/+25 | #34 |
| `ontos/commands/log.py` | +33/−11 | #43, #58 |
| `ontos/commands/map.py` | +51/−9 | #2, #43 |
| `ontos/commands/verify.py` | +25/−6 | #39 |
| `ontos/commands/init.py` | +23/−8 | #58 |

---

## Summary

Track A3 is complete. The PR delivers:

1. **JSON envelope schema v3.3** (#3) — 8 required keys, adopted by 18+ CLI handlers via `_emit_handler_result_json()`. Verified by parameterized conformance test.
2. **Error taxonomy** (#6) — `OntosUserError` (exit 2), `OntosInternalError` (exit 5), with full CLI routing.
3. **Return contract normalization** (#24) — all 22 public commands return `int`; internal `_run_*()` return `Tuple[int, str]`.
4. **CLI flag normalization** (#2, #7, #16, #17, #18, #35) — deprecation warnings, aliases, dry-run defaults.
5. **Command hardening** (#39, #43, #46, #47, #49, #50) — commit wrapping, stub validation, scaffold exceptions, cycle detection, maintain --skip.
6. **Module restructuring** (#19, #21, #34, #58, #62) — doctor vocabulary, shared instruction backend, OutputHandler migration, export --all.

Previous blocking issue B-1 resolved. All 20 items pass. Recommend merge.
