# v3.2 Spec Review — Peer Reviewer (Gemini)

**Version:** v3.2.0
**Document Under Review:** v3.2 Env Detection + Candidate Suggestions Implementation Plan
**Role:** Peer Reviewer
**Model:** Gemini 2.5 Pro
**Date:** 2026-01-29

---

## Part 1: Completeness Check

| Expected Section | Present? | Adequate? | Notes |
|------------------|----------|-----------|-------|
| Executive Summary | ✅ | ✅ | Clear scope and deferred items. |
| Scope Definition (In/Out) | ✅ | ✅ | Well-defined boundaries. |
| Technical Design | ✅ | ✅ | Detailed code snippets provided. |
| Data Structures | ✅ | ✅ | `ManifestInfo` and `EnvResult` defined clearly. |
| Error Handling | ✅ | ⚠️ | Mentions graceful degradation, but misses critical import handling (see Issues). |
| Test Strategy | ✅ | ✅ | Unit and integration tests included. |
| Risks & Mitigations | ✅ | ✅ | Identified `tomllib` version risk, but mitigation in code is incomplete. |
| Success Criteria | ✅ | ✅ | Specific and measurable. |

---

## Part 2: Quality Assessment

| Aspect | Rating | Notes |
|--------|--------|-------|
| Technical approach (env detection) | **Adequate** | Logic is sound, but Python version compatibility (3.9/3.10) implementation is flawed. |
| Technical approach (candidate suggestions) | **Good** | Standard, effective algorithms (substring, alias, Levenshtein) used. |
| Code organization | **Good** | Logical separation; leveraging existing `ontos.core` structure. |
| API design (`ontos env` flags) | **Good** | Consistent with CLI patterns; `--write` is useful. |
| User experience | **Good** | Doctor integration and "Did you mean?" suggestions significantly improve UX. |
| Testability | **Good** | Pure functions facilitate easy unit testing. |

---

## Part 3: Feature-Specific Review

#### Environment Detection (`ontos env`)

| Question | Assessment |
|----------|------------|
| Is the manifest detection logic sound? | Yes, covers standard files and logic is straightforward. |
| Are the supported manifest types appropriate for v3.2.0? | Yes, covers major ecosystems (Python, Node, System, Runtimes). |
| Is the output format (text/json) well-designed? | Yes, follows standard CLI practices. |
| Does `--write` make sense as a flag vs. subcommand? | Yes, simpler for this use case than a separate subcommand. |
| Is the doctor integration approach correct? | Yes, consistent with existing checks. |
| Are bootstrap commands accurate per package manager? | Yes, logic to refine based on lockfile is good. |

#### Candidate Suggestions

| Question | Assessment |
|----------|------------|
| Is the matching algorithm (substring + alias + Levenshtein) appropriate? | Yes, robust for common typos and mental model mismatches. |
| Is the 0.6 default threshold reasonable? | Code uses 0.5 in one place and 0.85 in another. Plan mentions 0.5 default. Reasonable start. |
| Is capping at 3 suggestions correct? | Yes, prevents noise in the console. |
| Will this actually help users fix broken refs? | Yes, highly valuable for "fat finger" errors. |

---

## Part 4: Implementation Clarity

| # | Ambiguity | Section | What's Unclear |
|---|-----------|---------|----------------|
| 1 | `tomllib` import on Python < 3.11 | 1.1 New File | The code does `import tomllib`. This will crash on Python 3.9/3.10. The plan mentions "Graceful fallback" in parsing, but the crash happens at import time. |
| 2 | `ontos/core/suggestions.py` imports | 2.1 New Function | Section header implies "New Function" but file exists. Code block shows new imports. Implementer must ensure existing imports are preserved/merged. |

---

## Part 5: Issues Found

**Major (Should Fix Before Implementation):**

| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| P-M1 | **Crash on Python < 3.11** | 1.1 New File | The project supports Python 3.9+. `tomllib` is only available in 3.11+. The code snippet shows a direct import. This contradicts the project's compatibility guarantees.<br><br>**Fix:** Use conditional import with `tomli` fallback (which is already in `pyproject.toml`).<br>`try: import tomllib`<br>`except ImportError: import tomli as tomllib` |

**Minor (Consider):**

| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| P-m1 | Inconsistent threshold | 2.1 & 2.2 | `suggest_candidates_for_broken_ref` default is 0.5, but graph integration uses 0.5 explicitly. Substring match uses 0.85 hardcoded. Clarify if 0.5 is the intended base threshold for fuzzy matches. |
| P-m2 | `ontos/core/suggestions.py` context | 2.1 | Explicitly state that this file exists and the new function should be appended, merging imports. |

---

## Part 6: What's Missing?

1.  **Explicit `tomli` fallback code:** The plan mentions `tomllib` risks but provides code that fails to mitigate them.
2.  **Manifest Type Descriptions:** The list of manifest types is good, but ensuring `Pipfile` (pipenv) is explicitly considered out-of-scope or added would be nice, given `pyproject.toml` support. (Not blocking).

---

## Part 7: Verdict

**Recommendation:** **Approve with changes**

**Blocking issues:** 1 (P-M1: Python version compatibility)

**Summary:**
The plan is solid and delivers high-value UX improvements with low complexity. The environment detection logic is sound, and the candidate suggestion algorithm is appropriate. However, the implementation of `pyproject.toml` parsing **must** be updated to handle Python 3.9/3.10 compatibility correctly by using `tomli` as a fallback, as `tomllib` is not available in the standard library for those versions. Once the import logic is fixed, this is ready to build.
