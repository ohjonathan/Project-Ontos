# D.5 Follow-up: Fix Prompt for Antigravity (Remaining Issues)

**Context:** Codex verification for PR #58 found remaining issues. Please address these specific gaps without expanding scope.

---

## Remaining Issues to Fix

### 1) X-H1: Multi-lockfile ambiguity when no tool section
**Problem:** `pyproject.toml` with only PEP 621 `[project]` and multiple lock files (e.g., `poetry.lock` + `pdm.lock`) still defaults to Poetry with no warning.

**Expected Behavior:**
- If no `[tool.poetry|pdm|uv]` section exists AND multiple Python lockfiles are present, **do not pick a default silently**.
- Instead, emit a **parse warning or ambiguity warning** and either:
  - choose a deterministic fallback (documented), or
  - omit bootstrap command (or use a neutral `pip install .`) and warn.

**Suggested Implementation (low risk):**
- In `_parse_pyproject()` after `pm_detected == False`, detect multiple lock files present and add a warning string (via `_parse_manifest` return).
- Prefer: return warning like `pyproject.toml: multiple lock files detected (poetry.lock, pdm.lock); cannot infer package manager`.
- Decide: either skip bootstrap command or set to `pip install .` with warning.

**Add Test(s):**
- New test in `tests/commands/test_env.py`:
  - Create `pyproject.toml` with `[project]` only + `poetry.lock` + `pdm.lock`.
  - Assert `parse_warnings` includes ambiguity message.
  - Assert bootstrap command is neutral (or empty) depending on decision.

---

### 2) X-M3: Invalid workspace path returns success
**Problem:** `env_command()` returns success and “No manifests detected” when `options.path` doesn’t exist or is a file.

**Expected Behavior:**
- If `options.path` does not exist or is not a directory, return non-zero exit **and** a clear error message.

**Suggested Implementation:**
- At start of `env_command()`:
  ```python
  if not workspace.exists():
      return 1, f"Error: workspace path does not exist: {workspace}"
  if not workspace.is_dir():
      return 1, f"Error: workspace path is not a directory: {workspace}"
  ```

**Add Test(s):**
- Add to `tests/commands/test_env.py`:
  - Non-existent path → `exit_code == 1` and error message.
  - Path to a temp file → `exit_code == 1` and error message.

---

### 3) X-R2: `ontos tree` / `ontos validate` missing
**Problem:** Verification checklist uses `ontos tree` and `ontos validate`, but CLI rejects these commands. This may be outdated docs/tests, or missing aliases.

**Expected Behavior (choose one):**
- **Option A (preferred if historical behavior exists):** Re-introduce `tree` and `validate` as aliases (or add helpful deprecation messages pointing to replacements).
- **Option B:** Update docs / verification checklist to remove these commands if intentionally removed.

**Suggested Implementation:**
- If aliases are expected:
  - In `ontos/cli.py`, register alias commands:
    - `tree` → maybe map to `map` or `graph` equivalent if exists.
    - `validate` → map to `verify` or `doctor` if that’s the intended replacement.
  - Provide a console warning for deprecated aliases.

**Add Test(s):**
- If aliases added, add CLI tests to ensure command works and warns.

---

## Verification Steps (After Fix)

```bash
pytest tests/ -v
ontos env
ontos env --format json | jq .
ontos env --write --force

# Edge cases:
python - <<'PY'
from pathlib import Path
import tempfile
from ontos.commands.env import env_command, EnvOptions

# Multi-lockfile ambiguity
with tempfile.TemporaryDirectory() as d:
    p = Path(d)
    (p/"pyproject.toml").write_text("[project]\nname='x'\n")
    (p/"poetry.lock").write_text("")
    (p/"pdm.lock").write_text("")
    code, out = env_command(EnvOptions(path=p, format="text"))
    print(code)
    print(out)

# Invalid path
p = Path("/tmp/ontos-nonexistent-xyz")
code, out = env_command(EnvOptions(path=p, format="text"))
print(code)
print(out)
PY
```

---

## Deliverables

- Code fixes in PR #58
- Tests added/updated
- Short fix summary comment on PR

---

## Notes

Do not expand scope beyond the three items above. The rest of the fixes were verified as complete.
