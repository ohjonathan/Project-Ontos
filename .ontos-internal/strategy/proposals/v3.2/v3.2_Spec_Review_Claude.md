---
id: v3_2_spec_review_claude
type: atom
status: complete
depends_on: [v3_2_env_detection_candidate_suggestions_implementation_plan]
concepts: [review, alignment, architecture, v3.2]
---

# Phase B.1: Spec Review - Alignment Reviewer (Claude)

**Version:** v3.2.0
**Document Under Review:** v3.2 Env Detection + Candidate Suggestions Implementation Plan
**Role:** Alignment Reviewer
**Model:** Claude Opus 4.5

---

## Your Role

You are the **Alignment Reviewer**. Verify the spec aligns with approved documents, constraints, and established patterns.

**Your job:** Check compliance. Flag deviations. Ensure consistency.

**Mindset:** Deviations from approved documents are issues, not style choices. Flag them objectively - let the Chief Architect justify.

---

## Part 1: Philosophy Alignment

The spec states alignment with "Document, don't manage" philosophy.

| Principle | Spec Compliant? | Evidence |
|-----------|-----------------|----------|
| Detection only (no auto-install) | **YES** | `ontos env` only detects manifests, does not install anything. Out-of-scope explicitly includes `--check` which would compare installed vs documented. |
| User controls output | **YES** | `--write` flag required to generate output file; default is display-only. `--format json` for tooling integration. |
| Non-invasive (doesn't modify project) | **YES** | Only writes to `.ontos/environment.md` (Ontos's own directory); never modifies project manifest files. |
| Informational, not prescriptive | **YES** | Presents detected manifests and bootstrap commands as informational; does not enforce usage. Onboarding steps are suggestions, not requirements. |

**Philosophy Concerns:**

| Concern | Severity |
|---------|----------|
| None identified | - |

**Assessment:** The spec strongly aligns with "Document, don't manage" philosophy. The `ontos env` command documents environment manifests without managing them - this is the core philosophy in action.

---

## Part 2: Architecture Compliance

| Constraint | Spec Compliant? | Evidence |
|------------|-----------------|----------|
| New command follows existing CLI patterns | **YES** | Uses `EnvOptions` dataclass, returns `Tuple[int, str]`, follows handler pattern in `cli.py` |
| New module in correct location (`ontos/commands/`) | **YES** | Spec creates `ontos/commands/env.py` - correct layer for command implementations |
| Core logic separate from CLI layer | **PARTIAL** | Core detection logic is in `commands/env.py` rather than `core/`. See A-M1 below. |
| No cross-layer imports violated | **YES** | `doctor.py` imports from `commands/env.py` (valid: commands can import other commands) |
| Consistent with existing dataclass patterns | **YES** | Uses `@dataclass` with `field(default_factory=list)` pattern matching `types.py` |

**Architecture Violations:**

| Violation | Spec Section | Correct Approach |
|-----------|--------------|------------------|
| A-M1: Detection logic in commands layer | Section 1.1 | Consider extracting `detect_manifests()` and `MANIFEST_PATTERNS` to `ontos/core/environment.py` per functional core/imperative shell principle. Commands layer should orchestrate, not contain pure logic. |

---

## Part 3: CLI Consistency Check

Compare `ontos env` design against existing commands:

| Aspect | Existing Pattern | Spec Follows? | Notes |
|--------|------------------|---------------|-------|
| Flag naming (`--write`, `--format`) | `--output/-o` for file writes, `--format/-f` for output format | **PARTIAL** | Uses `--write/-w` instead of `--output/-o`. See A-m1. |
| Output format options | `text`, `json` as format choices | **YES** | Matches `doctor`, `query` patterns |
| Exit codes | 0=success, 1=error, 2=strict warnings | **YES** | Always returns 0 (detection is informational, not validation) |
| Error messaging style | `CheckResult` with `name`, `status`, `message`, `details` | **YES** | Doctor integration uses existing `CheckResult` pattern |
| Quiet mode behavior | Suppress non-essential output | **YES** | Respects `options.quiet` flag |
| Global `--json` flag | All commands inherit from parent parser | **YES** | Handler checks `args.json or options.format == "json"` |

**Minor flag naming note:** Existing commands use `--output/-o` for file paths (e.g., `map --output`, `stub --output`). The spec uses `--write/-w` as a boolean flag. This is actually appropriate since `--write` is a mode switch (write to fixed location) not a path specification. No issue.

---

## Part 4: Backward Compatibility

| Interface | Changed? | Breaking? | Notes |
|-----------|----------|-----------|-------|
| `ontos doctor` output | Yes | **No** | Adds new check `environment_manifests`; existing checks unchanged |
| `ontos map` output | Yes | **No** | Adds `fix_suggestion` display to errors; existing format preserved |
| Exit codes | No | No | No changes to exit code semantics |
| JSON output schemas | Yes | **Minimal** | New `$schema: "ontos-env-v1"` for `env` command; existing schemas unchanged |

**Breaking Changes Identified:**

| Change | Impact | Acceptable? |
|--------|--------|-------------|
| `fix_suggestion` now displayed in map errors | Users/scripts parsing map output may see additional lines | **YES** - Additive change, enriches output |
| New doctor check | Doctor output has one more check | **YES** - Additive change |

**Assessment:** No breaking changes. All modifications are additive.

---

## Part 5: Consistency with Prior Decisions

| Prior Decision/Pattern | Spec Consistent? | Notes |
|------------------------|------------------|-------|
| Suggestions module location (`ontos/core/suggestions.py`) | **YES** | Spec adds `suggest_candidates_for_broken_ref()` to existing `suggestions.py` |
| Error output format | **YES** | Uses existing `ValidationError` dataclass with `fix_suggestion` field |
| Doctor check structure | **YES** | New `check_environment_manifests()` follows `CheckResult` return pattern exactly |
| Graph integration patterns | **YES** | Modifies `build_graph()` to enrich `fix_suggestion` field during validation |

**Important Note:** The existing `suggestions.py` contains impact/concept suggestion functions for session logs. Adding `suggest_candidates_for_broken_ref()` is semantically appropriate (same module, different suggestion use case).

---

## Part 6: Scope Alignment

| Planned for v3.2 | In Spec Scope? | Correctly Scoped? |
|------------------|----------------|-------------------|
| Environment Detection | YES | YES |
| Candidate Suggestions | YES | YES |
| Re-architecture support | NO (v3.2 main track) | YES - separate feature |

**Unauthorized Scope Additions:**

| Addition | Should Be Deferred? |
|----------|---------------------|
| None identified | - |

**Missing Planned Items:**

| Missing Item | Impact |
|--------------|--------|
| None - spec covers both planned features | - |

**Deferred Items (correctly identified in spec):**
- `ontos doctor --fix` (auto-repair mode) - deferred to v3.2.1
- `ontos init --env` integration - deferred
- `ontos env --check` (compare installed vs documented) - explicitly out of scope as "invasive"
- Monorepo support - deferred
- Additional manifest types (devcontainer.json, flake.nix, Dockerfile) - Phase 2

All deferrals are appropriate given "ship detection first" philosophy.

---

## Part 7: Issues Found

### Critical (Alignment):

| # | Issue | Type | Why Critical |
|---|-------|------|--------------|
| - | None | - | - |

### Major (Alignment):

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-M1 | Pure detection logic in commands layer | Architecture | Consider extracting `detect_manifests()`, `MANIFEST_PATTERNS`, parsing functions to `ontos/core/environment.py`. This follows the "functional core / imperative shell" principle where core modules contain pure stdlib-only logic. The command module should orchestrate, importing from core. **However:** This is a soft violation - the code is still testable and the pattern is used elsewhere (e.g., doctor checks inline). Acceptable if CA acknowledges trade-off. |

### Minor (Alignment):

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-m1 | `tomllib` requires Python 3.11+ | Compatibility | Spec acknowledges this in risks table. Current Ontos supports Python 3.9+. Recommend adding fallback import: `try: import tomllib except ImportError: import tomli as tomllib` or graceful degradation as specified. |
| A-m2 | `_parse_manifest` exception handling | Robustness | Line 209-211 uses bare `except Exception`. Consider catching specific exceptions (`FileNotFoundError`, `json.JSONDecodeError`, `tomllib.TOMLDecodeError`) for cleaner error handling. |
| A-m3 | Map validation section doesn't show suggestions | Consistency | Current `_generate_validation_section()` (map.py:175-191) shows `error.message` but NOT `error.fix_suggestion`. Spec modifies this but diff shows minimal change. Verify the actual enhancement includes the suggestion line. |

---

## Part 8: Verdict

**Alignment Status:** **Minor Deviations**

**Recommendation:** **Approve with notes**

**Blocking issues:** 0

**Summary:**
The spec demonstrates strong alignment with Ontos's "Document, don't manage" philosophy and existing architectural patterns. The `ontos env` command correctly documents environment manifests without managing them. All CLI patterns are followed (dataclass options, exit codes, output formatting). The candidate suggestions feature cleanly integrates with existing `suggestions.py` and `graph.py` modules.

One architectural note: pure detection logic could be extracted to `ontos/core/environment.py` per functional core principles, but this is a soft guideline and the current placement in `commands/env.py` is acceptable given the self-contained nature of the feature. All changes are backward-compatible (additive only).

---

## Review signed by:
- **Role:** Alignment Reviewer
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-29
- **Review Type:** Spec Review (Phase B.1)

---

## Appendix: Reference Documents Consulted

| Document | Path | Relevance |
|----------|------|-----------|
| Spec under review | `.ontos-internal/strategy/proposals/v3.2/v3.2_Env_Detection_Candidate_Suggestions_Implementation_Plan.md` | Primary |
| Philosophy & Ontology | `.ontos-internal/reference/Ontos_Philosophy_and_Ontology.md` | Curation vs Ceremony, Document don't manage |
| Technical Architecture | `.ontos-internal/strategy/v3.0/V3.0-Technical-Architecture.md` | Layered architecture, functional core principle |
| Existing suggestions.py | `ontos/core/suggestions.py` | Current module structure |
| Existing graph.py | `ontos/core/graph.py` | Broken link validation pattern (lines 62-72) |
| Existing doctor.py | `ontos/commands/doctor.py` | CheckResult pattern |
| Existing map.py | `ontos/commands/map.py` | Validation section output (lines 175-191) |
| CLI patterns | `ontos/cli.py` | Handler patterns, global options |
