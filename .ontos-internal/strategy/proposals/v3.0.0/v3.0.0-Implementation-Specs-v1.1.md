# Ontos v3.0.0 Implementation Specs

Date: 2026-01-16
Role: Chief Architect (Claude with codebase access)
Status: APPROVED — Ready for Implementation

---

## Codebase Exploration Findings

### CLI Architecture
- Entry point: `ontos/cli.py` (argparse-based; registers subcommands; routes to command handlers). Registration in `create_parser()` lines 35-82, handlers lines 196+.
- Command registration: `_register_*` functions in `ontos/cli.py` (e.g., `_register_export` lines 129-136).
- Existing commands (native or wrapper):
  - `init` -> `ontos/commands/init.py` (native)
  - `map` -> `ontos/commands/map.py` (native)
  - `log` -> `ontos/commands/log.py` (native)
  - `doctor` -> `ontos/commands/doctor.py` (native)
  - `export` -> `ontos/commands/export.py` (native)
  - `hook` -> `ontos/commands/hook.py` (native)
  - wrappers: `verify`, `query`, `migrate`, `consolidate`, `promote`, `scaffold`, `stub` in `ontos/commands/*.py` (delegates to `ontos/_scripts/*`).

### Export Command (Current State)
- Location: `ontos/commands/export.py`.
- Current functionality: generates `CLAUDE.md` from in-file template string `CLAUDE_MD_TEMPLATE` (lines 20-41). Writes to repo root or custom `--output` path (lines 74-90).
- Output format: static `CLAUDE.md` with minimal Ontos activation instructions.
- Gaps vs v3.0.0: no AGENTS.md support, no `.cursorrules` output, no stats, no top-5 command list, no staleness warning, no multi-format output.

### Init Command (Current State)
- Location: `ontos/commands/init.py`.
- Exit code logic: returns `(1, "Already initialized...")` when `.ontos.toml` exists and `--force` not set (lines 39-42). Success returns `hooks_status` (line 72).
- Post-init hooks: creates config/dirs, generates context map, installs git hooks; no agents/export invocation (lines 54-72).

### Doctor Command (Current State)
- Location: `ontos/commands/doctor.py`.
- Existing checks (7): configuration, git hooks, python version, docs directory, context map, validation (basic), CLI availability (lines 51-354). No staleness check.
- Check pattern: each check is a standalone function returning `CheckResult`, gathered in a list in `doctor_command()` (lines 346-372).

### Templates
- Locations: `ontos/_templates/` and `.ontos/templates/` with existing templates for config and docs.
- Existing templates: `common_concepts_template.md`, `decision_history_template.md`, `ontos_config.py.template`, `templates.py`. No AGENTS template.

### Instruction Files
- `.cursorrules` exists and references v2.x script paths (`python3 .ontos/scripts/ontos_generate_context_map.py`), per `v3.0.0_Strategic_Review.md` lines 26-39.
- `AGENTS.md` not present (strategic review lines 28-29).
- `CLAUDE.md` not present (strategic review line 28).

### GitHub Actions
- CI workflow exists: `.github/workflows/ci.yml` (tests, golden master, coverage). Triggered on push/pull_request.
- Publishing workflow: missing (no PyPI release workflow).

### Data Cleanup Targets
- Validation issues likely exist (CI notes map may exit 1 due to broken dependencies in repo).
- Stale references likely in `.ontos-internal` docs (e.g., Phase 2/3/4 content under `.ontos-internal/strategy/v3.0/Phase*`). Exact stale references not yet enumerated; requires running `ontos map --strict` to list.
- Estimated cleanup effort: 1-2 hours (per decision); likely focused on markdown frontmatter `depends_on` references.

### Environment Notes
- `tree` command not available; directory structure captured via `find`.
- Co-Founder response located at `.ontos-internal/strategy/proposals/v3.0.0/v3.0.0_Cofounder_Response.md` and used for decision references below.

---

# ontos agents Command Implementation Spec

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-16
**Status:** Draft — Pending Review

---

## 1. Overview

**Feature:** ontos agents command (AGENTS.md + .cursorrules generation)
**Priority:** P0
**Estimated Effort:** 6-8 hours
**Risk Level:** Medium

**Co-Founder Decision Reference:**
- `v3.0.0_Cofounder_Response.md` lines 341-353: `ontos agents`, default `AGENTS.md`, flags `--format=cursor` and `--all`, template includes activation/end protocol, quick reference, stats, staleness warning.
- `v3.0.0_Cofounder_Response.md` lines 28-31 and 311-314: `.cursorrules` fix is P0; Cursor users must not be broken.
- `v3.0.0_Cofounder_Response.md` lines 39-42 and 151-159: single-source template system, AGENTS.md canonical, generate other formats.
- `v3.0.0_Cofounder_Response.md` lines 403-420: rename `ontos export` -> `ontos agents` (parallel naming with `ontos map`).

---

## 2. Current State

**What exists today:**
- CLI has `export` command registered in `ontos/cli.py` lines 129-136.
- `ontos/commands/export.py` generates `CLAUDE.md` from a static template string (lines 20-90).
- No `AGENTS.md` exists in repo by default. `.cursorrules` exists at repo root and references v2.x scripts (stale). Strategic review confirms the v2.x path example and broken activation (see `v3.0.0_Strategic_Review.md` lines 26-45).

**What needs to change:**
- Introduce `ontos agents` command to generate `AGENTS.md` (default) and `.cursorrules` (optional), with template and stats.
- Rename `export` to `agents` and integrate single-source generation; decide whether to keep `export` as alias.

---

## 3. Requirements

### 3.1 Functional Requirements

| # | Requirement | Source |
|---|-------------|--------|
| FR1 | Add `ontos agents` CLI command with default output `AGENTS.md`. | Co-Founder Decision (lines 343-345) |
| FR2 | Support `--format=cursor` to output `.cursorrules` instead of AGENTS. | Co-Founder Decision (lines 345-345) |
| FR3 | Support `--all` to output both AGENTS.md and `.cursorrules`. | Co-Founder Decision (lines 345-345) |
| FR4 | Template includes top-5 Ontos commands (map, agents, doctor, log -e "slug", query <id>). | Co-Founder Decision (lines 103-116) |
| FR5 | Template includes project stats: doc count, last updated. | Co-Founder Decision (lines 346-351) |
| FR6 | Template includes staleness warning for humans. | Co-Founder Decision (lines 352-352, 385-386) |
| FR7 | Single-source generation: AGENTS.md is canonical; other formats derived from it. | Co-Founder Decision (lines 151-159) |
| FR8 | `ontos export` is renamed to `ontos agents` (export may remain as deprecated alias if needed). | Co-Founder Decision (lines 403-420) |
| FR9 | `.cursorrules` output must use v3.0 commands (no v2.x script paths). | Co-Founder Decision (lines 28-31, 311-314) |
| FR10 | AGENTS.md includes generation metadata (Ontos version + generated timestamp). | Reviewer finding (Claude X-H1) |
| FR11 | On `--force`, create a `.bak` backup of the existing file before overwrite. | Reviewer finding (Claude X-H5) |

### 3.2 Non-Functional Requirements

| # | Requirement | Rationale |
|---|-------------|-----------|
| NFR1 | Output path must be within repository root. | Parity with export path safety; avoid writing outside repo. |
| NFR2 | Must work without `.ontos.toml` (best-effort defaults). | Similar to doctor/map behavior; avoid hard fail. |
| NFR3 | Deterministic output (stable ordering) for tests. | Golden tests and CI stability. |
| NFR4 | AGENTS.md content should be reviewed for model clarity (prompt quality). | Advisor feedback (`v3.0.0_Strategic_Advisor_Review_Gemini.md` lines 200-210). |
| NFR5 | Output should avoid user-controlled strings in template placeholders (prevent brace injection). | Reviewer finding (Claude X-H3) |

### 3.3 Constraints

| Constraint | Description |
|------------|-------------|
| Back-compat | `export` currently exists and generates `CLAUDE.md`; rename to `agents` is required, alias decision remains. |
| Template | Use ASCII-only content. |

---

## 4. Technical Design

### 4.1 Architecture

Add a new command module `ontos/commands/agents.py` that mirrors the structure of `export.py` (dataclass options, `*_command` returning `(exit_code, message)`), but generates AGENTS.md by default and derives other formats from that content. Register it in `ontos/cli.py` and rename `export` to `agents`, keeping `export` as a deprecated alias that prints a warning to stderr and delegates to `agents`.

### 4.2 Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `ontos/commands/agents.py` | CREATE | New command implementation for agents generation. |
| `ontos/cli.py` | MODIFY | Register `agents` subcommand and handler. |
| `ontos/commands/export.py` | MODIFY | Deprecate or alias to agents after rename. |
| `ontos/_templates/agents_template.md` | CREATE | Canonical AGENTS.md template. |
| `tests/commands/test_agents.py` | CREATE | Unit tests for agents command behaviors. |
| `tests/golden/baselines/...` | MODIFY | Add baselines if output content is golden-tested. |

### 4.3 Implementation Details

#### 4.3.1 Agents Command

**Purpose:** Generate AGENTS.md (canonical) and optional `.cursorrules` output.

**Location:** `ontos/commands/agents.py`

**Code Structure:**
```python
@dataclass
class AgentsOptions:
    output_path: Optional[Path] = None
    force: bool = False
    format: str = "agents"  # agents|cursor
    all_formats: bool = False


def agents_command(options: AgentsOptions) -> Tuple[int, str]:
    # 1) resolve repo root
    # 2) build AGENTS.md content (canonical)
    # 3) write AGENTS.md unless format==cursor only and not --all
    # 4) if format==cursor or --all: derive .cursorrules content from AGENTS
    # 5) return exit code + summary message
    pass
```

**Key Logic:**
1. Resolve repo root using a shared helper: prefer `.ontos.toml` in current or parent dirs, else use `git rev-parse --show-toplevel` when available, else fall back to current `find_repo_root()` walk. This avoids nested `.git` ambiguity in monorepos.
2. Gather stats:
   - `doc_count`: count `*.md` under docs directory (from `.ontos.toml` if available; else `docs/`), iterating as a generator and capping at 5000 files (`5000+` if exceeded) to avoid slow scans.
   - `last_updated`: max mtime among `Ontos_Context_Map.md`, logs directory (from config), and `.ontos.toml` (fallback to existing files). Format as `YYYY-MM-DD HH:MM:SS UTC`.
3. Fill AGENTS template placeholders (project declaration, activation + session end protocols, quick reference, stats, staleness warning block, generation metadata).
4. Write to `AGENTS.md` (or `options.output_path` if provided). Create parent directories if needed. Validate output is inside repo root.
5. If `.cursorrules` requested, transform AGENTS content to cursor-specific format.
6. Respect `--force` for overwrites; otherwise return exit code 1 with a clear message. If `--force`, create `.bak` backup before overwrite.

#### 4.3.2 Template and Transform

**Purpose:** Keep AGENTS.md canonical and derive `.cursorrules` from it.

**Location:** `ontos/_templates/agents_template.md`

**Template Notes:**
- Include a short project declaration (e.g., "This project uses Ontos for documentation management.").
- Include activation protocol and session end protocol (per §11.1).
- Include Quick Reference table with the 5 commands and exact forms from §D3.
- Include stats fields such as `Doc Count` and `Last Updated` (string formatted).
- Include generation metadata (`Generated by Ontos vX.Y.Z` and timestamp).
- Include a short "Staleness" note reminding humans to regenerate if files change.

**Transform Strategy:**
- Simple mapping from AGENTS sections to cursor format, e.g.:
  - Keep Activation and Session End instructions.
  - Ensure `.cursorrules` uses v3.0 command paths (no `python3 .ontos/scripts/...`).
  - Ensure `.cursorrules` remains a valid plain-text instruction file.

### 4.4 Data Structures

| Structure | Purpose | Schema |
|----------|---------|--------|
| AgentsOptions | Options for agents command | `output_path: Path?`, `force: bool`, `format: str`, `all_formats: bool` |
| AgentsStats | Stats embedded in template | `doc_count: int`, `last_updated: str` |

### 4.5 Error Handling

| Error Condition | Handling | User Message |
|----------------|----------|--------------|
| Output exists and no `--force` | return exit code 1 | `AGENTS.md already exists... Use --force to overwrite.` |
| Output path outside repo | return exit code 2 | `Error: Output path must be within repository root` |
| Stats gathering fails | continue with `Unknown` placeholders | `Warning: Unable to compute stats; using defaults.` |
| Permission error writing file | return exit code 2 | `Permission denied writing AGENTS.md. Close the file or adjust permissions.` |

---

## 5. Interface Design

### 5.1 CLI Interface

`ontos agents [--force] [--format=cursor] [--all] [--output PATH]`

Options:
- `--force`, `-f`: overwrite existing files.
- `--format=cursor`: output `.cursorrules` only (default path: repo root `.cursorrules`).
- `--all`: output both `AGENTS.md` and `.cursorrules`.
- `--output`, `-o`: output path for AGENTS.md (ignored for `.cursorrules` unless a separate flag is added later).

Examples:
- `ontos agents`
- `ontos agents --format=cursor`
- `ontos agents --all`
- `ontos export` (deprecated alias, if retained)

### 5.2 Output Format

AGENTS.md example (template excerpt):
```
# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{version} on {generated_at}

## Ontos Activation
1. Run `ontos map`
2. Read `Ontos_Context_Map.md`

## Session End
1. Run `ontos log -e "slug"`

## Quick Reference
| Command | Purpose |
|---------|---------|
| `ontos map` | Regenerate context map |
| `ontos agents` | Generate instruction files |
| `ontos doctor` | Health check and validation |
| `ontos log -e "slug"` | Archive session work |
| `ontos query <id>` | Find document by ID |

## Project Stats
- Doc Count: 42
- Last Updated: 2026-01-16 19:33:42 UTC

## Core Invariants
- Do not edit `Ontos_Context_Map.md` manually; regenerate with `ontos map`.
- If AGENTS.md seems stale, regenerate with `ontos agents`.
- If a command fails, read the error message and avoid guessing fixes.

## Staleness
If `AGENTS.md` is older than the context map or logs, regenerate with `ontos agents`.
```

---

## 6. Test Strategy

### 6.1 Unit Tests

| Test | Purpose | File |
|------|---------|------|
| `test_agents_default_creates_agents_md` | Creates AGENTS.md in temp repo | `tests/commands/test_agents.py` |
| `test_agents_force_overwrite` | Overwrite behavior | `tests/commands/test_agents.py` |
| `test_agents_format_cursor` | Creates `.cursorrules` only | `tests/commands/test_agents.py` |
| `test_agents_all_formats` | Creates both outputs | `tests/commands/test_agents.py` |
| `test_agents_path_safety` | Rejects path outside repo | `tests/commands/test_agents.py` |
| `test_export_alias_warns` | `ontos export` warns and delegates to agents | `tests/commands/test_agents.py` |

### 6.2 Integration Tests

| Test | Purpose |
|------|---------|
| CLI smoke test | `python -m ontos agents` executes successfully in fixture repo |

### 6.3 Golden Tests

| Output | Baseline File |
|--------|---------------|
| AGENTS.md | `tests/golden/baselines/...` (required) |
| .cursorrules | `tests/golden/baselines/...` (required if `--format=cursor` implemented) |

### 6.4 Manual Testing

| Test | Steps | Expected Result |
|------|-------|----------------|
| Default | Run `ontos agents` | `AGENTS.md` created, message printed |
| Cursor | Run `ontos agents --format=cursor` | `.cursorrules` created with v3.0 command paths |
| All | Run `ontos agents --all` | Both files created |
| LLM onboarding | Follow AGENTS.md with 2 LLMs | Both complete activation without confusion (advisor success criteria) |

---

## 7. Migration / Compatibility

### 7.1 Backward Compatibility

| Aspect | Impact | Mitigation |
|--------|--------|------------|
| `ontos export` | Existing users may rely on CLAUDE.md generation | Provide alias or deprecation warning (see Open Questions). |

### 7.2 Migration Steps

- If `export` is deprecated, update docs to use `ontos agents`.

---

## 8. Documentation Updates

| Document | Update Required |
|----------|-----------------|
| `README.md` | Replace `ontos export` mention with `ontos agents`. |
| `docs/reference/Ontos_Agent_Instructions.md` | Update activation workflow to reference AGENTS.md. |

---

## 9. Acceptance Criteria

- [ ] `ontos agents` generates AGENTS.md by default.
- [ ] `ontos agents --format=cursor` generates `.cursorrules` only.
- [ ] `ontos agents --all` generates both outputs.
- [ ] Template includes top-5 commands, stats, staleness warning.
- [ ] `.cursorrules` output uses v3.0 command paths (no v2.x scripts).
- [ ] AGENTS.md includes generation metadata (version + timestamp).
- [ ] `--force` creates `.bak` backup before overwrite.
- [ ] Golden test baselines are added for AGENTS.md (and .cursorrules if tested).
- [ ] Path safety enforced; errors are clear.
- [ ] All tests pass.
- [ ] Documentation updated.

---

## 10. Open Questions

| # | Question | Options | Recommendation |
|---|----------|---------|----------------|
| Q1 | Keep `ontos export` as alias? | A) Alias to agents with deprecation warning. B) Remove export in v3.0.0. | A, to preserve existing behavior. |
| Q2 | Add a lightweight "success signal" step (e.g., `ontos doctor` + map exists) to AGENTS.md? (advisor note in `v3.0.0_Strategic_Advisor_Review_Codex.md` lines 206-210) | A) Add now. B) Defer. | B, unless reviewers require. |

---

## 11. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Template mapping misses Cursor-specific needs | M | M | Keep `.cursorrules` section minimal and tested. |
| Stats gathering is slow in large repos | L | M | Use shallow scan and ignore non-md files. |
| LLMs ignore AGENTS.md | M | M | Consider README fallback snippet or additional format in v3.0.3 (advisor note in `v3.0.0_Strategic_Advisor_Review_Codex.md` lines 216-220). |

Spec Version: 1.1 Ready for Review Board

---

# PyPI Publishing Workflow Implementation Spec

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-16
**Status:** Draft — Pending Review

---

## 1. Overview

**Feature:** PyPI publishing workflow via GitHub Actions
**Priority:** P0
**Estimated Effort:** 3-4 hours
**Risk Level:** Medium

**Co-Founder Decision Reference:**
- `v3.0.0_Cofounder_Response.md` lines 355-361: publish workflow, tag trigger `v*`, trusted publisher, TestPyPI first.
- `v3.0.0_Cofounder_Response.md` lines 199-203 and 423-424: include `pip install git+...` fallback in README.

---

## 2. Current State

**What exists today:**
- `pyproject.toml` defines `ontos` package version 3.0.0.
- CI workflows exist (`.github/workflows/ci.yml`, `golden-master.yml`), but no release workflow.

**What needs to change:**
- Add GitHub Actions workflow for build + publish to TestPyPI then PyPI using trusted publishing.
- Update README with git+ fallback install line.

---

## 3. Requirements

### 3.1 Functional Requirements

| # | Requirement | Source |
|---|-------------|--------|
| FR1 | Workflow triggers on `v*` tags. | Co-Founder Decision (lines 358-360) |
| FR2 | Publish to TestPyPI first; only publish to PyPI on success. | Co-Founder Decision (lines 360-361) |
| FR3 | Use trusted publisher (OIDC) for PyPI. | Co-Founder Decision (lines 360-360) |
| FR4 | Package name is `ontos`. | Co-Founder Decision (line 357) |
| FR5 | README includes git+ fallback install command. | Co-Founder Decision (lines 199-203, 423-424) |
| FR6 | Release workflow must verify install from TestPyPI before publishing to PyPI. | Reviewer finding (Gemini P-M1) |
| FR7 | Publish only after tests pass (CI or in-workflow tests). | Reviewer finding (Claude X-H2) |

### 3.2 Non-Functional Requirements

| # | Requirement | Rationale |
|---|-------------|-----------|
| NFR1 | Workflow must build sdist and wheel. | PyPI best practices. |
| NFR2 | Release should be reproducible from tag. | CI integrity. |

### 3.3 Constraints

| Constraint | Description |
|------------|-------------|
| Secrets | Trusted publishing avoids stored PyPI tokens. |
| PyPI readiness | PyPI account + `ontos` project claimed; OIDC trusted publisher configured before release (lines 169-170, 275-276). |

---

## 4. Technical Design

### 4.1 Architecture

Add a release workflow under `.github/workflows/publish.yml` that triggers on tag creation. It should build distributions with `python -m build`, publish to TestPyPI using `pypa/gh-action-pypi-publish`, then publish to PyPI if TestPyPI step succeeds.

### 4.2 Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `.github/workflows/publish.yml` | CREATE | Release pipeline for TestPyPI + PyPI. |
| `README.md` | MODIFY | Add git+ fallback install example. |

### 4.3 Implementation Details

#### 4.3.1 Publish Workflow

**Purpose:** Automate tagged releases.

**Location:** `.github/workflows/publish.yml`

**Key Logic:**
1. Trigger on `push` tags `v*`.
2. Checkout, set up Python 3.11.
3. Run tests (either call `pytest` directly or gate on CI success via `workflow_run`).
4. Install build tools (`pip install build`).
5. Build `dist/`.
6. Publish to TestPyPI with `repository-url: https://test.pypi.org/legacy/`.
7. Verify install from TestPyPI: `pip install --index-url https://test.pypi.org/simple/ --no-deps ontos` and run `ontos --version`.
8. Publish to PyPI with trusted publisher (no token) only if verification succeeds.

### 4.4 Data Structures

None.

### 4.5 Error Handling

| Error Condition | Handling | User Message |
|----------------|----------|--------------|
| TestPyPI publish fails | Stop workflow, do not publish to PyPI | GitHub Actions step failure |

---

## 5. Interface Design

N/A (CI workflow)

---

## 6. Test Strategy

### 6.1 Unit Tests

N/A

### 6.2 Integration Tests

| Test | Purpose |
|------|---------|
| Release workflow run on tag | End-to-end publish path |

### 6.3 Golden Tests

N/A

### 6.4 Manual Testing

| Test | Steps | Expected Result |
|------|-------|----------------|
| Dry run on tag in fork | Push `vX.Y.Z` tag | Workflow runs, TestPyPI upload succeeds |

---

## 7. Migration / Compatibility

### 7.1 Backward Compatibility

No impact.

### 7.2 Migration Steps

None.

---

## 8. Documentation Updates

| Document | Update Required |
|----------|-----------------|
| `README.md` | Add `pip install git+https://github.com/ohjona/Project-Ontos.git` fallback (per decision). |

---

## 9. Acceptance Criteria

- [ ] Publish workflow exists and triggers on `v*` tags.
- [ ] TestPyPI publish happens before PyPI publish.
- [ ] TestPyPI install verification step passes before PyPI publish.
- [ ] Trusted publisher configuration used.
- [ ] PyPI project claimed and trusted publisher configured.
- [ ] README updated with git+ fallback.
- [ ] All tests pass.

---

## 10. Open Questions

| # | Question | Options | Recommendation |
|---|----------|---------|----------------|
| Q1 | Use a manual approval step between TestPyPI and PyPI? | A) Automatic with verification step. B) Require approval. | A, to keep release flow simple. |

---

## 11. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Trusted publisher not configured in PyPI | M | H | Verify PyPI project OIDC settings before tag release. |

Spec Version: 1.1 Ready for Review Board

---

# Init Exit Code Change Implementation Spec

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-16
**Status:** Draft — Pending Review

---

## 1. Overview

**Feature:** Change init exit code for already-initialized projects
**Priority:** P0
**Estimated Effort:** 0.5 hours
**Risk Level:** Low

**Co-Founder Decision Reference:**
- `v3.0.0_Cofounder_Response.md` lines 69-85 and 363-368: change exit code to 0 with same message when already initialized.

---

## 2. Current State

**What exists today:**
- `ontos/commands/init.py` returns `(1, "Already initialized...")` at lines 39-42.

**What needs to change:**
- Return exit code 0 for the already-initialized case, preserving message text.

---

## 3. Requirements

### 3.1 Functional Requirements

| # | Requirement | Source |
|---|-------------|--------|
| FR1 | If `.ontos.toml` exists and no `--force`, return exit code 0. | Co-Founder Decision (lines 365-368) |
| FR2 | Keep the same message string. | Co-Founder Decision (lines 81-83, 365-368) |

### 3.2 Non-Functional Requirements

| # | Requirement | Rationale |
|---|-------------|-----------|
| NFR1 | No change in file outputs. | Limit scope. |

### 3.3 Constraints

| Constraint | Description |
|------------|-------------|
| Minimal change | One-line change to return code only. |

---

## 4. Technical Design

### 4.1 Architecture

Modify `init_command()` to return `(0, "Already initialized...")` on the early exit path.

### 4.2 Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `ontos/commands/init.py` | MODIFY | Change return code at line 42. |

### 4.3 Implementation Details

#### 4.3.1 Return Code Change

**Purpose:** Ensure LLM-friendly behavior (non-zero not treated as error).

**Location:** `ontos/commands/init.py` line 42.

**Key Logic:**
- Replace `return 1, "Already initialized..."` with `return 0, "Already initialized..."`.

### 4.4 Data Structures

None.

### 4.5 Error Handling

No change.

---

## 5. Interface Design

No CLI change; only exit code changes.

---

## 6. Test Strategy

### 6.1 Unit Tests

| Test | Purpose | File |
|------|---------|------|
| `test_init_already_initialized_returns_zero` | Verify exit code for existing config | `tests/commands/test_init.py` |

### 6.2 Integration Tests

N/A

### 6.3 Golden Tests

N/A

### 6.4 Manual Testing

| Test | Steps | Expected Result |
|------|-------|----------------|
| Init twice | Run `ontos init` twice | Second run exits 0, message unchanged |

---

## 7. Migration / Compatibility

No impact.

---

## 8. Documentation Updates

None.

---

## 9. Acceptance Criteria

- [ ] Second `ontos init` returns exit code 0 with same message.
- [ ] Existing behavior unchanged otherwise.

---

## 10. Open Questions

None.

---

## 11. Risks

None.

Spec Version: 1.1 Ready for Review Board

---

# Init Auto-Generation Implementation Spec

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-16
**Status:** Draft — Pending Review

---

## 1. Overview

**Feature:** Auto-generate AGENTS.md on init
**Priority:** P0
**Estimated Effort:** 1-2 hours
**Risk Level:** Low

**Co-Founder Decision Reference:**
- `v3.0.0_Cofounder_Response.md` lines 376-381: `ontos init` auto-runs `ontos agents`, zero-friction activation, non-fatal on agents failure.

---

## 2. Current State

**What exists today:**
- `init_command()` performs config/dirs, context map generation, hook installation, and returns a success message (lines 54-72). No agents/export generation.

**What needs to change:**
- Add a post-init step to generate AGENTS.md and optionally `.cursorrules` using the new agents module. Init must not fail if agents generation fails.
- Update the init success message tip to reference `ontos agents` instead of `ontos export`.

---

## 3. Requirements

### 3.1 Functional Requirements

| # | Requirement | Source |
|---|-------------|--------|
| FR1 | `ontos init` generates AGENTS.md automatically. | Co-Founder Decision (lines 378-379) |
| FR2 | Init succeeds even if agents generation fails. | Co-Founder Decision (lines 381-381) |
| FR3 | Warning is printed if agents generation fails. | Co-Founder Decision (lines 381-381) |
| FR4 | Success path: `pip install ontos && ontos init` results in AGENTS.md present. | Co-Founder Decision (lines 379-380) |
| FR5 | Init success message references `ontos agents` (not `ontos export`). | Reviewer finding (Claude unique insight) |

### 3.2 Non-Functional Requirements

| # | Requirement | Rationale |
|---|-------------|-----------|
| NFR1 | Keep init under 30s; no long-running work. | UX. |

### 3.3 Constraints

| Constraint | Description |
|------------|-------------|
| No subprocess required | Prefer direct function call to agents command to avoid env issues. |

---

## 4. Technical Design

### 4.1 Architecture

Import and invoke `agents_command()` in `ontos/commands/init.py` after hooks installation and before the final message is built. Capture return code; do not alter init exit code on failure (except log warning).

### 4.2 Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `ontos/commands/init.py` | MODIFY | Call agents command after init steps. |
| `ontos/commands/agents.py` | MODIFY | Ensure a programmatic API usable by init. |

### 4.3 Implementation Details

#### 4.3.1 Post-Init Agents Generation

**Purpose:** Zero-friction activation.

**Location:** `ontos/commands/init.py` after hooks installation (post line 65).

**Key Logic:**
1. Instantiate `AgentsOptions` with default output and `force=False`.
2. Call `agents_command()`.
3. If non-zero, print warning to stderr and continue.
4. Keep final exit code based on hook status only.

### 4.4 Data Structures

None beyond AgentsOptions.

### 4.5 Error Handling

| Error Condition | Handling | User Message |
|----------------|----------|--------------|
| AGENTS generation fails | Continue, warn only | `Warning: Could not generate AGENTS.md: <msg>` |

---

## 5. Interface Design

No CLI changes.

---

## 6. Test Strategy

### 6.1 Unit Tests

| Test | Purpose | File |
|------|---------|------|
| `test_init_triggers_agents_generation` | Ensure agents called | `tests/commands/test_init.py` |
| `test_init_agents_failure_non_fatal` | Non-zero agents does not fail init | `tests/commands/test_init.py` |

### 6.2 Integration Tests

| Test | Purpose |
|------|---------|
| Init in empty temp repo | AGENTS.md exists after init |

### 6.3 Golden Tests

N/A

### 6.4 Manual Testing

| Test | Steps | Expected Result |
|------|-------|----------------|
| Init | `ontos init` | AGENTS.md present in repo root |

---

## 7. Migration / Compatibility

No impact.

---

## 8. Documentation Updates

| Document | Update Required |
|----------|-----------------|
| `README.md` | Mention AGENTS.md auto-generation on init. |

---

## 9. Acceptance Criteria

- [ ] AGENTS.md is created on `ontos init` success path.
- [ ] `pip install ontos && ontos init` leaves AGENTS.md in repo root.
- [ ] Init exit code unaffected by agents failures.
- [ ] Warning printed on agents failure.
- [ ] Init success message references `ontos agents`.

---

## 10. Open Questions

None.

---

## 11. Risks

None.

Spec Version: 1.1 Ready for Review Board

---

# Doctor Staleness Check Implementation Spec

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-16
**Status:** Draft — Pending Review

---

## 1. Overview

**Feature:** `ontos doctor` staleness check for AGENTS.md
**Priority:** P0
**Estimated Effort:** 2-3 hours
**Risk Level:** Medium

**Co-Founder Decision Reference:**
- `v3.0.0_Cofounder_Response.md` lines 383-391 and 182-185: `ontos doctor` checks AGENTS.md staleness vs context map, archives, config; warn only.

---

## 2. Current State

**What exists today:**
- `ontos/commands/doctor.py` defines 7 checks and assembles them in `doctor_command()` (lines 346-372). No AGENTS check.

**What needs to change:**
- Add an additional check that compares AGENTS.md mtime to relevant sources and emits warning if stale.

---

## 3. Requirements

### 3.1 Functional Requirements

| # | Requirement | Source |
|---|-------------|--------|
| FR1 | Add AGENTS staleness check to `ontos doctor`. | Co-Founder Decision (lines 383-389) |
| FR2 | Compare AGENTS.md mtime to Context_Map, session archives, config. | Co-Founder Decision (lines 385-387) |
| FR3 | Warning only (no auto-fix). | Co-Founder Decision (lines 389-391) |
| FR4 | Warning message should say: `AGENTS.md may be stale. Run 'ontos agents' to regenerate.` | Co-Founder Decision (lines 385-386) |

### 3.2 Non-Functional Requirements

| # | Requirement | Rationale |
|---|-------------|-----------|
| NFR1 | Check must be fast; avoid full file reads. | Doctor performance. |

### 3.3 Constraints

| Constraint | Description |
|------------|-------------|
| Compatibility | Doctor exit code remains 0 unless fails exist; warning should not set fail. |

---

## 4. Technical Design

### 4.1 Architecture

Add `check_agents_staleness()` alongside existing checks, append to checks list in `doctor_command()` after `check_context_map()` or near validation. Use the same repo-root resolution as `agents`/`export` to avoid inconsistencies, and use filesystem mtimes only.

### 4.2 Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `ontos/commands/doctor.py` | MODIFY | Add new check and include in checks list. |

### 4.3 Implementation Details

#### 4.3.1 Staleness Check

**Purpose:** Detect if AGENTS.md is outdated.

**Location:** `ontos/commands/doctor.py`.

**Key Logic:**
1. Resolve repo root (similar to `export`/`agents` find repo root).
2. Determine AGENTS path: `repo_root / "AGENTS.md"`.
3. Resolve source files:
   - Context map: from `.ontos.toml` if available, else `Ontos_Context_Map.md`.
   - Session archives: newest file in logs directory (`config.paths.logs_dir` or `docs/logs`).
   - Config: `.ontos.toml` mtime.
4. If AGENTS.md missing: warn with message to run `ontos agents`.
5. Compare AGENTS mtime to max source mtime; if AGENTS is older, warn.

### 4.4 Data Structures

| Structure | Purpose | Schema |
|----------|---------|--------|
| StalenessSources | Track file mtimes | `dict[str, float]` |

### 4.5 Error Handling

| Error Condition | Handling | User Message |
|----------------|----------|--------------|
| Cannot read a source path | Skip that source | Include details if `--verbose` |
| AGENTS missing | warn | `AGENTS.md not found. Run 'ontos agents'.` |
| All sources missing | warn | `Cannot determine AGENTS.md staleness - no source files found` |

---

## 5. Interface Design

No CLI changes. Output example:
```
WARN: agents_staleness: AGENTS.md may be stale. Run 'ontos agents' to regenerate.
```

---

## 6. Test Strategy

### 6.1 Unit Tests

| Test | Purpose | File |
|------|---------|------|
| `test_doctor_agents_missing_warns` | Missing AGENTS -> warn | `tests/commands/test_doctor.py` |
| `test_doctor_agents_stale_warns` | Stale AGENTS -> warn | `tests/commands/test_doctor.py` |
| `test_doctor_agents_fresh_passes` | Fresh AGENTS -> pass | `tests/commands/test_doctor.py` |

### 6.2 Integration Tests

| Test | Purpose |
|------|---------|
| Doctor in temp repo | Ensure status includes agents check |

### 6.3 Golden Tests

N/A

### 6.4 Manual Testing

| Test | Steps | Expected Result |
|------|-------|----------------|
| Stale AGENTS | Touch context map, run doctor | Warning about staleness |

---

## 7. Migration / Compatibility

No impact.

---

## 8. Documentation Updates

| Document | Update Required |
|----------|-----------------|
| `README.md` | Mention staleness warning in doctor. |

---

## 9. Acceptance Criteria

- [ ] Doctor includes AGENTS staleness check.
- [ ] Stale AGENTS yields WARN, not FAIL.
- [ ] Missing AGENTS yields WARN with guidance.

---

## 10. Open Questions

| # | Question | Options | Recommendation |
|---|----------|---------|----------------|
| Q1 | Should logs directory default to `.ontos-internal/logs` or `docs/logs`? | A) Use config path. B) Hardcode docs/logs. | A, use config path. |
| Q2 | Add time-based staleness (e.g., warn if AGENTS.md older than 7 days)? | A) Add time-based check. B) Mtime vs sources only. | B, defer (advisor note in `v3.0.0_Strategic_Advisor_Review_Gemini.md` lines 208-212). |

---

## 11. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Log directory is large | M | L | Use max mtime via `rglob` with early exit on max; ignore non-md. |
| Warning ignored by LLMs | M | M | Keep warning for humans; consider surfacing in README later (advisor note in `v3.0.0_Strategic_Advisor_Review_Gemini.md` lines 243-248). |

Spec Version: 1.1 Ready for Review Board

---

# Data Cleanup (Prerequisite) Implementation Spec

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-16
**Status:** Draft — Pending Review

---

## 1. Overview

**Feature:** Data cleanup of stale references before feature work
**Priority:** Prerequisite
**Estimated Effort:** 1-2 hours
**Risk Level:** Low

**Co-Founder Decision Reference:**
- `v3.0.0_Cofounder_Response.md` lines 48-63 and 370-374: clean up stale `depends_on` references in Phase 2/3/4 docs before feature work.

---

## 2. Current State

**What exists today:**
- Context map generation can fail due to broken dependencies (noted in CI workflow comment). Strategic review enumerates broken references: Phase 3/4 docs referencing archived `phase2_implementation_spec`, logs referencing missing atom docs (`cli`, `hook`, `export`), depth warnings, architecture violations, and lint warnings (`v3.0.0_Strategic_Review.md` lines 70-76).
- Broken references likely in `.ontos-internal/strategy/v3.0/Phase*` (per review).

**What needs to change:**
- Identify broken `depends_on` entries and fix/remove them to restore clean validation.

---

## 3. Requirements

### 3.1 Functional Requirements

| # | Requirement | Source |
|---|-------------|--------|
| FR1 | Remove or fix stale `depends_on` references. | Co-Founder Decision (lines 60-61, 372-374) |
| FR2 | `ontos map --strict` produces zero validation errors. | Co-Founder Decision (lines 372-374) |

### 3.2 Non-Functional Requirements

| # | Requirement | Rationale |
|---|-------------|-----------|
| NFR1 | Do not change document content outside frontmatter unless required. | Minimal scope. |

### 3.3 Constraints

| Constraint | Description |
|------------|-------------|
| Scope | Focus on Phase 2/3/4 docs and known stale links only. |

---

## 4. Technical Design

### 4.1 Architecture

Manual cleanup using `ontos map --strict` output to locate broken references and update frontmatter `depends_on` lists, then confirm `ontos doctor` validation is clean.

### 4.2 Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `.ontos-internal/strategy/v3.0/Phase2/*` | MODIFY | Fix stale `depends_on` links if present. |
| `.ontos-internal/strategy/v3.0/Phase3/*` | MODIFY | Fix stale `depends_on` links if present. |
| `.ontos-internal/strategy/v3.0/Phase4/*` | MODIFY | Fix stale `depends_on` links if present. |

### 4.3 Implementation Details

#### 4.3.1 Cleanup Process

**Purpose:** Ensure context map validation passes.

**Key Logic:**
1. Run `python -m ontos map --strict` and capture errors.
2. For each broken reference, either:
   - Remove from `depends_on` if doc no longer exists, or
   - Update to the correct ID if renamed.
3. Re-run `python -m ontos map --strict` until clean.
4. Run `python -m ontos doctor` and confirm validation check reports no errors.

### 4.4 Data Structures

None.

### 4.5 Error Handling

| Error Condition | Handling | User Message |
|----------------|----------|--------------|
| Validation errors persist | Continue iterating | Re-run strict map and fix next set |

---

## 5. Interface Design

N/A

---

## 6. Test Strategy

### 6.1 Unit Tests

N/A

### 6.2 Integration Tests

| Test | Purpose |
|------|---------|
| `ontos map --strict` | Verify no validation errors |
| `ontos doctor` | Verify validation check shows no errors |

### 6.3 Golden Tests

N/A

### 6.4 Manual Testing

| Test | Steps | Expected Result |
|------|-------|----------------|
| Strict map | Run `python -m ontos map --strict` | Exit code 0 |

---

## 7. Migration / Compatibility

No impact.

---

## 8. Documentation Updates

None.

---

## 9. Acceptance Criteria

- [ ] `ontos map --strict` returns 0 with no validation errors.
- [ ] `ontos doctor` shows 0 validation errors.
- [ ] `Ontos_Context_Map.md` Dependency Audit shows 0 broken references.
- [ ] Only frontmatter references adjusted.

---

## 10. Open Questions

| # | Question | Options | Recommendation |
|---|----------|---------|----------------|
| Q1 | Which exact docs are stale? | A) Use map strict output. | A |

---

## 11. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Over-correction removes needed dependencies | L | M | Verify each removal; prefer updating IDs where possible. |

Spec Version: 1.1 Ready for Review Board

---

## Changelog

### v1.1 (2026-01-17)
- Added: Complete AGENTS.md template (Appendix A)
- Added: .cursorrules transform rules (Appendix B)
- Added: Generation metadata with version stamp (FR10)
- Added: Backup before --force overwrite (FR11)
- Added: Template injection mitigation (NFR5)
- Added: Stats cap at 5000 files
- Added: PyPI test gating and TestPyPI verification step
- Added: Golden test requirement for agents output
- Changed: Data cleanup verification includes `ontos doctor`
- Changed: Repo root resolution uses `.ontos.toml` → `git rev-parse` hierarchy
- Fixed: Doctor staleness uses consistent repo-root helper
- Fixed: Init tip message references `ontos agents`
- Added: Missing sources handling for doctor staleness check
- Added: Backtick preservation in .cursorrules transform rules

---

## Review Preparation Notes

- Include `v3.0.0_Cofounder_Response.md` from `.ontos-internal/strategy/proposals/v3.0.0/` with the review packet.
- Reference architecture docs for reviewers if needed: `V3.0-Technical-Architecture.md`, `V3.0-Implementation-Roadmap.md`.
- Highlight success criteria from the decision doc (`v3.0.0_Cofounder_Response.md` lines 325-333): 3/3 fresh machine activations in <5 minutes; golden test validates agents output; 2+ LLMs follow activation without confusion.
- Focus areas:
  - Gemini: completeness of requirements and UX clarity.
  - Claude: strategy alignment with Co-Founder decisions (AGENTS canonical, OIDC publish).
  - Codex: implementation feasibility, edge cases (path safety, mtimes, log directory).

---

## Appendix A: AGENTS.md Template (v1.1)

```markdown
# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{ontos_version} on {generated_at}

## Ontos Activation
1. Run `ontos map` to regenerate the context map.
2. Read `Ontos_Context_Map.md` to understand the documentation graph.
3. Load only the relevant documents for the task.
4. Follow `depends_on` upward as needed.
5. Confirm: "Loaded: [ids]".

## Session End
1. Run `ontos log -e "slug"` to archive session work.
2. Fill in Goal, Key Decisions, Alternatives Considered, and Impacts.

## Quick Reference
| Command | Purpose |
|---------|---------|
| `ontos map` | Regenerate context map |
| `ontos agents` | Generate instruction files |
| `ontos doctor` | Health check and validation |
| `ontos log -e "slug"` | Archive session work |
| `ontos query <id>` | Find document by ID |

## Project Stats
- Doc Count: {doc_count}
- Last Updated: {last_updated}

## Core Invariants
- Do not edit `Ontos_Context_Map.md` manually; regenerate with `ontos map`.
- Do not edit `AGENTS.md` manually; regenerate with `ontos agents`.
- If a command fails, read the error message and avoid guessing fixes.

## Staleness
If `AGENTS.md` is older than the context map or logs, regenerate with `ontos agents`.
```

---

## Appendix B: .cursorrules Transform Rules (v1.1)

| AGENTS.md Section | .cursorrules Treatment |
|-------------------|------------------------|
| Title (`# AGENTS.md`) | Replace with `# Ontos Protocol for Cursor` |
| Project declaration | Keep as-is |
| Generation metadata | Keep as-is |
| `## Ontos Activation` | Rename to `## Activation` and keep numbered steps. Prepend: `When the user says "Ontos" or "Activate Ontos":` |
| `## Session End` | Keep section and steps. Prepend: `When ending a session:` |
| `## Quick Reference` | Keep table as-is (Markdown) |
| `## Project Stats` | Keep bullet list as-is |
| `## Core Invariants` | Keep as-is |
| `## Staleness` | Keep as-is |
| Any other section | Remove |

Additional rules:
- Ensure all commands use v3.0 CLI (`ontos map`, `ontos agents`, etc.); no v2.x script paths.
- Output filename for cursor format is always `.cursorrules` at repo root.
- Preserve ASCII-only content.
- Preserve backticks around commands (e.g., `ontos map`) in .cursorrules output.
