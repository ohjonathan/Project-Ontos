---
id: v3_3_merged_audit_findings
type: strategy
status: active
depends_on: [v3_3_audit_architecture_claude_code, v3_2_backlog]
concepts: [v3.3, audit, consolidated-findings, tech-debt, backlog]
---

# v3.3 Merged Audit & Backlog Findings

> **Consolidator:** Antigravity, powered by Gemini 2.5 Pro
> **Date:** 2026-02-10
> **Sources:** UX Audit (Gemini), Correctness Audit (Codex), Architecture Audit (Claude Code), v3.2 Backlog

---

## Merge Legend

- **Original IDs are preserved** in every row.
- Where multiple auditors found the same issue, all IDs are listed and the row is marked as a **merge**.
- ⚠️ = auditor conflict on severity or recommendation (see §Conflicts).
- Backlog items (X-*) are integrated inline. Items marked `resolved` in the backlog are excluded.

---

## Auditor Conflicts

Issues where auditors disagree on severity, scope, or recommendation.

| # | Topic | Auditor A | Auditor B | Conflict Type | Resolution Recommendation |
|---|-------|-----------|-----------|---------------|---------------------------|
| 1 | **Dry-run / `--apply` inconsistency** | Gemini (`G-3`, P2): UX inconsistency across `scaffold`, `maintain`, `consolidate`, `schema-migrate` | Codex (`C-4`, P1): `scaffold --apply --dry-run` silently writes — mutual exclusion not enforced | Severity (P2 vs P1) + Scope (UX pattern vs correctness bug) | Codex is right that the _bug_ is P1 (data safety). Gemini is right that the _pattern_ is P2 (UX). Fix the bug first (C-4), then unify the pattern (G-3). |
| 2 | **`--json` broken across commands** | Gemini (`G-2`, P1): `OutputHandler` emits mixed text+JSON | Codex (`C-2`, P1 / `C-3`, P2): `env` and `query` specifically ignore `--json` | Scope | Same root cause, different granularity. G-2 is the systemic view; C-2/C-3 are specific instances. Treat as one work item with C-2/C-3 as acceptance criteria for G-2. |
| 3 | **`validate_concepts()` never called** | Claude Code (`CC-16`, P2): Dead code — never invoked by `ValidationOrchestrator` | Gemini: not flagged | No conflict, noting coverage | CC-16 stands. Gemini didn't audit validation internals. |
| 4 | **Duplicate ID silent overwrite** | Codex (`C-8`, P1): Correctness bug — nondeterministic graph output | Claude Code (`CC-07`, P2 — scope inconsistency context): Noted as part of scan scope fragmentation | Severity (P1 vs P2 context) | Codex's P1 is correct — this is a correctness bug independent of scan scope. |
| 5 | **Command import layering** | Claude Code (`CC-02`, P2): agents → instruction_protocol → claude_template → export chain | Backlog (`X-M7`, P3): "Re-evaluate command-to-command imports in `maintain.py`" | Scope + Severity | CC-02 is broader (4 commands, not just maintain). Subsumes X-M7. Use CC-02 as primary, retire X-M7. |
| 6 | **`export claude` vs `agents` consolidation** | Gemini (`G-9`, P2): Consolidate under `agents --format claude` | Backlog (`X-M12`, P3): "Evaluate command-surface consolidation" | Severity (P2 vs P3) | Same item. Gemini provides the concrete recommendation. Use G-9 as primary. |

---

## Merged Findings

### P1 — Critical

| # | IDs | Title | Category | Auditor(s) | Files | Effort |
|---|-----|-------|----------|------------|-------|--------|
| 1 | `CC-03` | **Two frontmatter parsers with incompatible error contracts** — `parse_frontmatter()` returns None (silent), `parse_frontmatter_content()` raises ValueError (loud). 10+ callers handle differently. Third parser variant `parse_frontmatter_yaml()` is dead code. | Contract Inconsistency | Claude Code | `core/frontmatter.py`, `io/yaml.py`, 10 command callers | Large |
| 2 | `G-1` | **`-f` short flag overloaded** — means `--force` (most), `--filter` (map), `--format` (env) | Flag Consistency | Gemini | `cli.py` | Small |
| 3 | ⚠️ `G-2`, `C-2`, `C-3` | **`--json` flag broken/ignored in multiple commands** — `OutputHandler` emits mixed text+JSON; `env` ignores global `--json`; `query` never branches on `json_output` | Output Format | Gemini (P1), Codex (P1, P2) | `cli.py`, `env.py`, `query.py`, `log.py`, `promote.py`, `consolidate.py`, `verify.py` | Large |
| 4 | `G-5` | **Hallucinated `log` flags in manual** — `--enhance` and `--list-concepts` documented but don't exist | Doc Drift | Gemini | `Ontos_Manual.md` | Small |
| 5 | `G-11` | **Documentation uses `python3 ontos.py`** — tool has been native package since v3.0 | Doc Drift | Gemini | `Ontos_Manual.md`, READMEs | Small |
| 6 | `C-1` | **No-command exits 0** — missing command should be non-zero exit | Input Validation | Codex | `cli.py:1037-1043` | Small |
| 7 | ⚠️ `C-4`, `G-3` | **`scaffold --apply --dry-run` silently writes** — mutual exclusion not enforced. Part of broader dry-run UX inconsistency (G-3, P2). | Input Validation | Codex (P1), Gemini (P2) | `cli.py:444-975` | Small (bug) / Medium (UX pattern) |
| 8 | `C-5` | **`validate_describes_field()` crashes on list input** — assumes `describes` is scalar; list input throws `TypeError` | Edge Case | Codex | `validation.py:40-41` | Small |
| 9 | `C-7` | **`depends_on`/`impacts` non-list values cause `TypeError`** — numeric/object values not normalized | Input Validation | Codex | `files.py:167-174`, `graph.py:64`, `validation.py:160` | Medium |
| 10 | `C-8` | **Duplicate IDs silently overwritten** — `dict` assignment makes graph nondeterministic | Edge Case | Codex | `map.py:737`, `maintain.py:255`, `snapshot.py:152`, `query.py:44` | Medium |
| 11 | `C-9` | **`_load_docs_for_graph()` silently skips parse failures** — swallows exceptions, under-reports broken links | Silent Failure | Codex | `maintain.py:251-258` | Small |
| 12 | `C-10` | **`consolidate` moves files before ledger commit** — partial state on failure | Edge Case | Codex | `consolidate.py:230-240` | Medium |
| 13 | `C-11` | **`consolidate` exits 0 on per-log errors** | Silent Failure | Codex | `consolidate.py:237-246` | Small |
| 14 | `C-13` | **`doctor` uses `Path.cwd()` instead of repo root** — false failures from subdirectories | Edge Case | Codex | `doctor.py:216-290` | Medium |
| 15 | `C-14` | **Path helpers anchored to package install, not project root** — commands target wrong filesystem tree | Edge Case | Codex | `paths.py:22-144` | Large |

### P2 — Major

| # | IDs | Title | Category | Auditor(s) | Files | Effort |
|---|-----|-------|----------|------------|-------|--------|
| 16 | ⚠️ `G-3` | **Dry-run UX inconsistency** — `maintain` (default OFF), `scaffold` (default ON), `schema-migrate` (mutually exclusive). See also P1 #7 (C-4). | Flag Consistency | Gemini | `scaffold.py`, `maintain.py`, `consolidate.py`, `schema-migrate` | Medium |
| 17 | `G-4` | **`map --obsidian` help text claims tag support** — only wikilinks implemented | Help Text | Gemini | `cli.py` | Small |
| 18 | `G-6` | **Inconsistent confirmation-skip flags** — `--auto` (log), `--yes` (init), `--all` (consolidate), `--all-ready` (promote) | Flag Consistency | Gemini | Multiple commands | Small |
| 19 | `G-7` | **Status terminology split** — `doctor` uses `[pass, fail, warn]`; `maintain` uses `[success, failed, skipped]` | Output Format | Gemini | `doctor.py`, `maintain.py` | Medium |
| 20 | `G-8` | **`query --health` ignores `--quiet`** — custom ASCII report bypasses `OutputHandler` | Output Format | Gemini | `query.py` | Small |
| 21 | ⚠️ `G-9`, `X-M12` | **Agent instruction commands fragmented** — `agents` and `export claude` should consolidate | Discoverability | Gemini (P2), Backlog (P3) | `agents.py`, `export_claude.py` | Medium |
| 22 | `G-12` | **Manual lists nonexistent `update` command** | Doc Drift | Gemini | `Ontos_Manual.md` | Small |
| 23 | `G-13` | **Manual calls task "Migrate" but code uses "migrate_untagged"** | Doc Drift | Gemini | `Ontos_Manual.md` | Small |
| 24 | `G-14` | **CLI catch-all gives cryptic errors** — no `UserError` vs `InternalError` distinction | Error Messages | Gemini | `cli.py:1053` | Medium |
| 25 | `C-6` | **Enum coercion catches `ValueError` only** — `TypeError` from list/dict for `type`/`status` bubbles up | Input Validation | Codex | `files.py:151-157` | Small |
| 26 | `C-12` | **`consolidate` joins scalar `impacts` into characters** — `', '.join("foo")` → `"f, o, o"` | Input Validation | Codex | `consolidate.py:112-180` | Small |
| 27 | `C-15` | **Proposal-ledger parser captures table separators as entries** | Edge Case | Codex | `proposals.py:48-51` | Small |
| 28 | `C-16` | **`generate_decision_history()` fails on bare filename** — empty dirname from `os.path.dirname("file.md")` | Input Validation | Codex | `history.py:259` | Small |
| 29 | `C-17` | **`MigrateOptions.apply` declared but unused** — writes possible with `apply=False, dry_run=False` | Input Validation | Codex | `migrate.py:23-140` | Small |
| 30 | `C-18` | **No tests for core graph primitives** (`build_graph`, cycle/orphan/depth) | Test Gap | Codex | `graph.py` | Medium |
| 31 | `C-19` | **No tests for schema parse/serialize** — unknown schemas & round-trip edge cases unguarded | Test Gap | Codex | `schema.py` | Medium |
| 32 | `C-20` | **No command-level tests for `log`** — coverage is indirect via golden harness | Test Gap | Codex | `log.py` | Medium |
| 33 | `CC-01` | **Core→IO layer violation in `snapshot.py`** — imports `ontos.io` from `ontos.core` | Layer Violation | Claude Code | `snapshot.py:106-109` | Medium |
| 34 | ⚠️ `CC-02`, `X-M7` | **Cross-command import chain** — agents → instruction_protocol → claude_template → export. Subsumes backlog X-M7 (maintain.py imports). | Layer Violation | Claude Code (P2), Backlog (P3) | `agents.py`, `claude_template.py`, `export.py`, `export_claude.py` | Medium |
| 35 | `CC-04` | **Three command return type contracts** — `int` vs `Tuple[int, str]` vs `Tuple[int, DoctorResult]` | Contract Inconsistency | Claude Code | 15+ command files | Medium |
| 36 | `CC-05` | **Duplicate `build_graph()` with incompatible signatures** — core vs query.py local version | Duplication | Claude Code | `graph.py`, `query.py:58-69` | Small |
| 37 | `CC-06` | **21 obsolete defensive enum checks** — `doc.type.value if hasattr(doc.type, 'value') else str(doc.type)` | Contract Inconsistency | Claude Code | 6 files, 21 locations | Small |
| 38 | `CC-07` | **Nine different scan scopes across commands** — 5 distinct scope patterns, no shared constant | Contract Inconsistency | Claude Code | 9 command files | Medium |
| 39 | `CC-08` | **`SessionContext.commit()` exceptions unhandled by 5 callers** — RuntimeError/IOError propagates to generic catch-all | Error Handling | Claude Code | `context.py`, scaffold, promote, verify, stub, consolidate | Small |
| 40 | `CC-09` | **Five document loading patterns** — raw dict vs DocumentData, no guidance for new commands | Duplication | Claude Code | query, map, maintain, verify, promote | Large |
| 41 | `CC-11` | **Duplicate `normalize_depends_on` logic** — function in frontmatter.py vs inline in files.py | Duplication | Claude Code | `frontmatter.py:154-171`, `files.py:166-178` | Small |
| 42 | `CC-16` | **`validate_concepts()` never called by `ValidationOrchestrator`** — concepts field unvalidated | Dead Code | Claude Code | `suggestions.py:127-149`, `validation.py:72-86` | Small |
| 43 | `CC-18` | **`dry_run` field declared but never checked** in `GenerateMapOptions` and `EndSessionOptions` | Dead Code | Claude Code | `map.py:39`, `log.py:47` | Small |
| 44 | `CC-19` | **Asymmetric validation severity** — broken `depends_on` = error, broken `impacts`/`describes` = warning, undocumented | Contract Inconsistency | Claude Code | `graph.py:74-81`, `validation.py:155-178` | Small |
| 45 | `X-H2` | **`consolidate --count 0` undefined semantics** | Input Validation | Backlog | `consolidate.py` | Small |
| 46 | `X-M1` | **`stub` accepts invalid type/id silently** | Input Validation | Backlog | `stub.py` | Small |
| 47 | `X-M2` | **`scaffold` silent on permission denied / invalid paths** | Error Messaging | Backlog | `scaffold.py` | Small |
| 48 | `X-M3` | **`migrate` ignores unsupported schema versions** | Input Validation | Backlog | `migrate.py` | Small |
| 49 | `X-M4` | **`query --health` doesn't detect dependency cycles** | Edge Case | Backlog | `query.py`, `graph.py` | Medium |
| 50 | `X-M5` | **`maintain --skip unknown_task` warns but exits 0** | Input Validation | Backlog | `maintain.py` | Small |
| 51 | `X-M10` | **Nested `USER CUSTOM` marker parsing** — truncation risk | Edge Case | Backlog | Template handling | Medium |

### P3 — Minor

| # | IDs | Title | Category | Auditor(s) | Files | Effort |
|---|-----|-------|----------|------------|-------|--------|
| 52 | `G-10` | **Hidden `agent-export` alias** — should warn or remove | Discoverability | Gemini | `cli.py` | Small |
| 53 | `CC-10` | **Duplicate `load_common_concepts()` definitions** — frontmatter.py (dead) vs suggestions.py (active) | Duplication | Claude Code | `frontmatter.py:199-239`, `suggestions.py:45-77` | Small |
| 54 | `CC-12` | **Dead code: `extract_doc_ids_from_text()`** — defined, exported, never called | Dead Code | Claude Code | `suggestions.py:152-169` | Small |
| 55 | `CC-13` | **Dead code: `parse_frontmatter_yaml()`** — third parser, never called | Dead Code | Claude Code | `io/yaml.py:45-74` | Small |
| 56 | `CC-14` | **Dead code: `DocumentCache` class** — complete caching implementation, never instantiated | Dead Code | Claude Code | `core/cache.py` | Small |
| 57 | `CC-15` | **Unused config options** — `enforce_archive_before_push`, `require_source_in_logs`, `strict` | Dead Code | Claude Code | `config.py:70-80` | Small |
| 58 | `CC-17` | **`OutputHandler` bypassed in 3 commands** — `doctor`, `init`, `log` use direct `print()` | Contract Inconsistency | Claude Code | `doctor.py`, `init.py`, `log.py` | Medium |
| 59 | `CC-20` | **Dead code: exported `verify_document()`** — exported but never imported | Dead Code | Claude Code | `commands/__init__.py:145` | Small |
| 60 | `X-M8` | **`_parse_bool` empty-string semantics** — silent default vs explicit warning | Input Validation | Backlog | Config parsing | Small |
| 61 | `X-M9` | **`TaskResult.status` is free-form string** — should be enum/literal | Type Strictness | Backlog | `maintain.py` | Small |
| 62 | `X-M11` | **`ontos export --all` command** — single command for all instruction files | Feature Request | Backlog | New command | Medium |

---

## Backlog Item Cross-Reference

| Backlog ID | Status | Merged Into | Notes |
|------------|--------|-------------|-------|
| X-H2 | **Active** | #45 (P2) | Standalone — no audit overlap |
| X-M1 | **Active** | #46 (P2) | Standalone — no audit overlap |
| X-M2 | **Active** | #47 (P2) | Standalone — no audit overlap |
| X-M3 | **Active** | #48 (P2) | Standalone — no audit overlap |
| X-M4 | **Active** | #49 (P2) | Standalone — no audit overlap |
| X-M5 | **Active** | #50 (P2) | Standalone — no audit overlap |
| X-M6 | **Resolved** | — | Excluded (resolved 2026-02-10) |
| X-M7 | **Subsumed** | #34 → `CC-02` | CC-02 is broader (4 commands vs 1). Retire X-M7 in favor of CC-02. |
| X-M8 | **Active** | #60 (P3) | Standalone — no audit overlap |
| X-M9 | **Active** | #61 (P3) | Standalone — no audit overlap |
| X-M10 | **Active** | #51 (P2) | Standalone — no audit overlap |
| X-M11 | **Active** | #62 (P3) | Standalone — no audit overlap |
| X-M12 | **Subsumed** | #21 → `G-9` | Gemini provides concrete recommendation. Retire X-M12 in favor of G-9. |

### Planned Features (from backlog)

| ID | Feature | Notes |
|----|---------|-------|
| F-M1 | `ontos retrofit` | Active in v3.2.4 discovery / proposal process |
| F-M2 | `ontos rename` | Active in v3.2.4 proposal (under review) |
| F-M3 | `ontos link-check` | Active in v3.2.4 proposal (under review) |
| F-M4 | `doctor --repair` | Deferred — no audit overlap |

---

## Summary Statistics

| Severity | Gemini (UX) | Codex (Correctness) | Claude Code (Architecture) | Backlog | **Total Unique** |
|----------|-------------|---------------------|---------------------------|---------|------------------|
| P1 | 4 | 10 | 1 | 0 | **15** |
| P2 | 9 | 7 | 12 | 8 | **36** |
| P3 | 1 | 0 | 7 | 4 | **11** |
| **Total** | **14** | **17** | **20** | **12** | **62** |

> Raw input count: 14 + 20 + 20 + 13 active backlog items = 67. After merging duplicates (G-2/C-2/C-3, C-4/G-3, G-9/X-M12, CC-02/X-M7) and excluding resolved X-M6: **62 unique items**.

### v3.2.4 Prerequisites

These findings directly affect `link-check` and `rename` and should be resolved before or during v3.2.4:

| # | ID(s) | Why |
|---|-------|-----|
| 1 | `CC-03` | `rename` must pick a parser — currently no canonical choice |
| 38 | `CC-07` | `--scope` flag adds 6th scope definition to existing 5 |
| 40 | `CC-09` | `rename` must pick a loading pattern — currently 5 options |
| 42 | `CC-16` | `link-check` inherits the gap if it claims "all references validated" |
| 44 | `CC-19` | `link-check` severity model inherits undocumented asymmetry |
| 10 | `C-8` | Both commands build graphs on duplicate-vulnerable loaders |
