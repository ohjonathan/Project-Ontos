---
id: v3_3_track_a1_review_consolidation_remediation
type: strategy
status: active
depends_on: [v3_3_track_a1_peer_review, v3_3_track_a1_alignment_review, v3_3_track_a1_adversarial_review]
concepts: [v3.3, track-a1, phase-d, review-consolidation, remediation-plan]
---

# v3.3 Track A1 — Review Consolidation & Remediation Plan

## 1. Review Assessment

| Finding | Agree/Disagree | Severity Assessment | Notes |
|---|---|---|---|
| **Peer-M1**: unused local `DocumentCache` import in `ontos/io/files.py` | Agree | Low | Valid cleanup item. No correctness impact. |
| **Peer-M2**: verify `CurationLevel` move did not break `curation.py` | Agree | Informational | Verified: `ontos/core/curation.py` imports `CurationLevel` from `ontos/core/types.py`. No defect. |
| **Peer-M3**: severity key naming (`orphan` singular) may confuse config usage | Agree | Low | Naming is internally consistent; this is docs/API clarity, not runtime correctness. |
| **Peer-D1**: `load_frontmatter` public helper is a spec deviation/improvement | Agree | Informational | Positive deviation; improves single-file contract handling. |
| **Peer-D2**: richer `DocumentLoadIssue` fields are an improvement | Agree | Informational | Positive deviation; enables better diagnostics. |
| **Align-C1**: missing `REFERENCE_SEVERITY_RATIONALE` dict from spec | Agree | Low | Spec mismatch is real; runtime rationale exists in comments/constants. Non-blocking unless Track B needs machine-readable rationale. |
| **Align-C2**: `map` uses `broken_link: warning` override | Partially agree | Low | Factually true; not a defect by itself. Map still fails on load-time fatal issues. This preserves lenient map validation behavior. |
| **Align-C3**: `scaffold.py` scope extended beyond parser migration | Agree | Low | Scope extension is real but defensive. No concrete regression found from this alone. |
| **Align-O1**: `has_fatal_errors` treats duplicates as fatal everywhere | Agree | **High / Merge blocker** | Real and impactful. Conflicts with A1 policy table for `query`/snapshot warn+continue behavior. This is the same underlying issue as VUL-03. |
| **Align-O2**: `known_concepts` in `map` is self-referential union-of-docs | Agree | Medium (non-blocking) | Correct observation. Vocabulary check is near-no-op in `map` for unknown-term detection. Structural concept validation still works. Same root issue as VUL-06. |
| **Align-O3**: `has_errors` naming is overloaded (`has_any_issues`) | Agree | Low | API naming clarity issue; not correctness-blocking. |
| **Align-Note**: pre-existing `core/config.py` imports from IO | Agree | Informational / out-of-scope | Not introduced by A1. Keep for later architecture debt track. |
| **VUL-01**: `validate_concepts()` crashes on unhashable concept values | Agree | **Critical / Merge blocker** | Reproduced against current branch: dict inside `concepts` causes `TypeError` in duplicate check (`set(concepts)`). |
| **VUL-02**: `normalize_describes()` warns “dropped” but keeps via `str()` | Partially agree | **High / Merge blocker** | Contract inconsistency is real. “Silent data corruption” wording is overstated, but behavior is still wrong/misleading and creates ghost describes targets. |
| **VUL-03**: duplicate IDs are universally fatal via `has_fatal_errors` | Partially agree | **Critical / Merge blocker** | Core issue is real. “Every command blocked” is overstated, but `query` and other paths hard-fail where spec requires caller-specific severity. |
| **VUL-04**: `.lstrip()` changed frontmatter boundary semantics | Partially agree | Medium (non-blocking) | Behavior change exists. It is likely intentional leniency, but currently undocumented/untested as policy. |
| **VUL-05**: maintain ignores `has_fatal_errors` and may degrade silently | Partially agree | Medium (non-blocking) | `check_links` does handle duplicates explicitly; other maintain tasks may run best-effort on partial loads. Valid consistency concern, not immediate blocker. |
| **VUL-06**: concept vocabulary check is effectively no-op in `map` | Agree | Medium (non-blocking) | Same substance as Align-O2. Valid limitation, not a crash/corruption blocker. |
| **VUL-07**: residual `hasattr(doc, ...)` checks contradict CC-06 | Disagree (as blocking defect) | Low | These are not the same enum-migration pattern removed by CC-06. Cleanup opportunity only. |
| **VUL-08**: unused `parse_frontmatter` imports in commands | Agree | Low | True dead imports; cleanup only. |
| **VUL-09**: `parse_frontmatter_yaml()` wrapper retained | Agree | Low | Theoretical API-surface cleanup. Not a runtime correctness issue. |
| **VUL-10**: bare `except:` in `io/snapshot.py` | Agree | Low | Valid defensive hardening item (`except Exception:`). Not currently causing known failures. |
| **VUL-11**: duplicate detection is case-sensitive and undocumented | Agree | Low | Behavior is deterministic and likely acceptable; needs explicit policy/docs for Track B rename semantics. |
| **VUL-12**: `io/snapshot.py` runs validation with empty config | Partially agree | Low | Vocabulary omission is expected with current design; the meaningful risk is inherited from VUL-01 crash path. |

### Explicit tie-breaks requested

- **VUL-03 vs Align-O1:** adversarial severity is directionally correct for merge gating. The implementation currently violates A1’s caller-specific duplicate severity policy in normal query usage. Alignment’s “observation” label is too soft.
- **VUL-06 vs Align-O2:** both are factually correct. This is a design limitation (value/noise issue), not a crash or corruption defect. Non-blocking for A1 merge.
- **VUL-07 vs CC-06 framing:** residual checks are not the same as the removed enum fallback pattern. This is consistency cleanup, not evidence CC-06 was improperly implemented.

---

## 2. Remediation Plan (Pre-Merge)

| # | Finding | Fix Description | Files | Acceptance Criteria | Effort |
|---|---|---|---|---|---|
| 1 | **VUL-01** (`validate_concepts` unhashable crash) | Make duplicate-concept detection robust to unhashable list members. Only run duplicate detection on hashable/string concepts, or guard `set()` path with a safe fallback. Keep non-string warning behavior. | `ontos/core/validation.py`, `tests/test_validation_concepts_a1.py` | 1) `ValidationOrchestrator.validate_concepts()` does not raise for `concepts: [{"k":"v"}, "x"]`. 2) Warning is emitted for non-string concept member. 3) `ontos map` no longer crashes on such input. | Small (<30 LOC) |
| 2 | **VUL-02** (`normalize_describes` drop/keep mismatch) | Align behavior and messaging. Recommended: truly drop non-string list members (remove coercive append), matching warning text and `normalize_reference_list()` semantics. | `ontos/core/staleness.py`, `tests/test_document_loading_contract_a1.py` (or `tests/test_describes.py`) | 1) Non-string `describes` members are excluded from normalized output. 2) Warning text accurately reflects behavior (“dropped”). 3) No ghost describes targets generated from coerced values. | Small (<30 LOC) |
| 3 | **VUL-03 + Align-O1** (duplicate severity policy broken) | Make duplicate severity caller-controlled per spec. Recommended contract: `has_fatal_errors` covers parse/io only; callers that must fail on duplicates check `duplicate_ids` explicitly. Update `map` to fail on duplicates; update `query` to warn and continue with canonical kept doc. | `ontos/io/files.py`, `ontos/commands/map.py`, `ontos/commands/query.py`, tests in `tests/commands/test_map.py` and `tests/commands/test_query_parity.py` (or new targeted tests) | 1) `map` exits non-zero when duplicates exist. 2) `query` emits duplicate warning(s) but still returns health/query output using canonical doc set. 3) Duplicate handling remains deterministic (sorted paths, first-wins). | Medium (30-100 LOC) |

---

## 3. Deferred Items (Valid, Non-Blocking)

| Finding | Why Defer | Target |
|---|---|---|
| Peer-M1 (unused local import in `io/files.py`) | Cleanup only; no runtime impact. | A2 cleanup batch |
| Align-C1 (missing `REFERENCE_SEVERITY_RATIONALE` dict) | Spec polish gap; runtime rationale exists today. Add when user-facing explainability is implemented. | Track B (or A3 if not needed in B) |
| Align-C3 (`scaffold` scope extension) | No concrete defect; mainly scope/documentation clarity. | PR notes now; deeper tuning in A2 if needed |
| Align-O2 / VUL-06 (self-referential vocabulary) | Real limitation but needs product decision on authoritative vocabulary source. | A3 or Track B follow-up design |
| Align-O3 (`has_errors` naming) | API ergonomics only. | A3 |
| VUL-04 (`.lstrip()` boundary policy) | Behavior is plausible/intentional leniency; needs explicit test+docs, not emergency rollback. | A2 |
| VUL-05 (maintain asymmetry outside `check_links`) | Consistency concern; no immediate crash/corruption in core path. | A2 |
| VUL-07 (residual `hasattr`) | Consistency cleanup only. | A2 |
| VUL-08 (unused `parse_frontmatter` imports) | Dead-import hygiene only. | A2 |
| VUL-09 (`parse_frontmatter_yaml` wrapper retained) | Legacy API-surface cleanup, no active defect. | A3 |
| VUL-10 (bare `except` in `io/snapshot.py`) | Defensive hardening; low immediate risk. | A2 |
| VUL-11 (case-sensitivity documentation) | Policy/docs clarity item for rename semantics. | Track B spec/docs |
| VUL-12 (snapshot empty config for concepts vocab) | Not wrong under current optional-vocabulary model; revisit when authoritative vocab source exists. | A3 / Track B vocabulary design |

---

## 4. Test Additions (Adversarial Gap Analysis)

| Gap | Accept/Reject | Merge Blocker? | Plan |
|---|---|---|---|
| 1. Unhashable concepts crash test | Accept | **Yes** | Add test for dict/list concept member and assert no exception + warning emitted. |
| 2. `load_documents()` duplicate handling test | Accept | **Yes** | Add deterministic duplicate-ID test: first-wins, issue recorded, `duplicate_ids` populated with all paths. |
| 3. `load_documents()` end-to-end orchestration test | Accept | No (post-merge) | Add focused integration test in A2 after blocker fixes land. |
| 4. `.lstrip()` boundary behavior test | Accept | No (post-merge) | Codify intended behavior (leading newline before `---`) in A2. |
| 5. `query --health` parity regression test | Accept | No (post-merge) | Add parity fixture test in A2/A3. |
| 6. `normalize_describes()` drop/keep contract test | Accept | **Yes** | Add pre-merge with VUL-02 fix to lock behavior. |
| 7. `parse_frontmatter_content()` many `---` separators test | Accept | No (post-merge) | Add parser robustness test in A2. |
| 8. `normalize_type()` list-input test | Reject (as new gap) | No | This path is already exercised in existing legacy test set; not an A1-specific blocker. |
| 9. Concepts warning-noise rate on real corpus | Reject (as CI test) | No | Keep as manual QA metric for Track B readiness, not deterministic CI gate. |

---

## Merge Recommendation

**Do not merge yet.**

Implement the three pre-merge remediations above (VUL-01, VUL-02, VUL-03/O1), plus their blocker tests. After those land, A1 is fit to pass review board final sign-off and unblock Track B.
