---
id: v3_3_track_a1_implementation_spec
type: strategy
status: active
depends_on: [v3_3_release_plan, v3_3_merged_audit_findings]
concepts: [v3.3, implementation-spec, track-a1, parser-contracts, graph-integrity]
---

# v3.3 Track A1 Implementation Spec

## 1. Overview

Track A1 delivers the **core contract foundation** for v3.3:
- canonical parsing/loading behavior
- deterministic duplicate-ID handling
- input normalization hardening at the IO boundary
- explicit validation severity policy
- elimination of graph-builder duplication
- removal of one core-layer boundary violation (`core/snapshot.py -> io/*`)

**Target version:** v3.3 (Track A1)

**Risk level:** High (cross-cutting, multi-module contract changes)

This track is release-critical because Track B (`--scope`, `link-check`, `rename`) depends directly on these contracts (prereqs: `#1`, `#10`, `#42`, `#44`).

---

## 2. Scope

### In Scope (all 12 A1 items)

- [ ] `#1 (CC-03)` Canonical parser contract and caller convergence
- [ ] `#8 (C-5)` `validate_describes_field()` list-safe behavior
- [ ] `#9 (C-7)` `depends_on`/`impacts` normalization for non-list input
- [ ] `#10 (C-8)` Duplicate-ID detection without silent overwrite
- [ ] `#25 (C-6)` Enum coercion catches `TypeError` + `ValueError`
- [ ] `#33 (CC-01)` Remove core->io dependency in `core/snapshot.py`
- [ ] `#36 (CC-05)` Remove duplicate `build_graph()` in `query.py`
- [ ] `#37 (CC-06)` Replace 21 obsolete enum defensive checks
- [ ] `#40 (CC-09)` Canonical document loading pattern for key commands
- [ ] `#41 (CC-11)` Single source of truth for `depends_on` normalization
- [ ] `#42 (CC-16)` Integrate concept validation into orchestrator
- [ ] `#44 (CC-19)` Explicit validation severity model (documented + codified)

### Out of Scope (explicitly not in Track A1)

- Unified scan scope/`--scope` rollout (`Track B`)
- New body-link parser (`Track B`)
- New commands (`link-check`, `rename`) (`Track B`)
- Command-surface UX harmonization (`Track A3`: flags/help/error UX)
- Dead-code purge beyond what is required to satisfy A1 contracts (`Track A4`)

---

## 3. Dependencies

### Prerequisites

- None. This is the first track.

### Blockers and Mitigations

1. Blocker: Parser and loader changes touch many callers (`#1`, `#40`).
   Mitigation: Introduce canonical loader APIs first; migrate callers in one pass; keep legacy `parse_frontmatter()` callable but marked internal-legacy.

2. Blocker: Duplicate-ID policy affects command outcomes (`#10`).
   Mitigation: Central duplicate detection in loader; command-level severity policy table (warn vs fail) implemented in each caller.

3. Blocker: Snapshot refactor can break downstream imports (`#33`).
   Mitigation: Move runtime snapshot assembly to IO layer and update all internal imports in same track; include compatibility note in release notes.

---

## 4. Technical Design

Implementation order follows release plan:
1. Canonical parser/loader contract (`#1`, `#40`, `#41`)
2. Input normalization + duplicate detection (`#25`, `#8`, `#9`, `#10`)
3. Graph/validation contract cleanup (`#36`, `#37`, `#42`, `#44`)
4. Layer-boundary cleanup (`#33`)

## 4.1 Parser/Loader Unification (`#1`, `#40`, `#41`, `#25`, `#9`)

### Purpose

Resolve the two-parser/five-loader ambiguity by defining one loading contract rooted in `io.yaml.parse_frontmatter_content()` (S4), then migrate key commands to that contract.

### File Changes

**Create**
- `ontos/io/snapshot.py` (see 4.4; runtime loader wrapper)

**Modify**
- `ontos/io/files.py`
- `ontos/core/frontmatter.py`
- `ontos/io/yaml.py`
- `ontos/commands/map.py`
- `ontos/commands/maintain.py`
- `ontos/commands/query.py`
- `ontos/commands/verify.py`
- `ontos/commands/promote.py`
- `ontos/commands/scaffold.py`
- `ontos/commands/migrate.py`
- `ontos/commands/consolidate.py`

### Canonical Loader Contract (new APIs in `ontos/io/files.py`)

Add these dataclasses:

```python
@dataclass
class DocumentLoadIssue:
    code: str  # parse_error | duplicate_id | invalid_enum | invalid_reference_type
    path: Path
    message: str
    doc_id: Optional[str] = None
    field: Optional[str] = None
    value: Optional[Any] = None

@dataclass
class DocumentLoadResult:
    documents: Dict[str, DocumentData]
    issues: List[DocumentLoadIssue]
    duplicate_ids: Dict[str, List[Path]]  # sorted; first path is canonical kept doc
```

Add loader functions:

```python
def load_frontmatter(
    path: Path,
    frontmatter_parser: Callable[[str], Tuple[Dict[str, Any], str]],
) -> Tuple[Optional[Dict[str, Any]], Optional[str]]


def load_documents(
    paths: List[Path],
    frontmatter_parser: Callable[[str], Tuple[Dict[str, Any], str]],
) -> DocumentLoadResult
```

Contract details:
- Parser is always `parse_frontmatter_content` (S4).
- Parse failure: file is skipped, issue recorded (`code="parse_error"`), processing continues.
- No-frontmatter files are allowed by loader (they produce `DocumentData` via existing fallback behavior).
- Duplicate IDs are detected once, centrally; never silently overwritten.
- Determinism: paths processed in sorted order; first encountered ID is canonical.

### Normalization Contract (`#41`, `#9`, `#25`)

In `ontos/core/frontmatter.py`:
- Add `normalize_reference_list(value, field_name, on_warning=None) -> List[str]`
- Keep `normalize_depends_on()` as a wrapper delegating to `normalize_reference_list(..., field_name="depends_on")`.

Normalization rules (`depends_on`, `impacts`):
- `None` -> `[]`
- `str` -> `[trimmed]` (empty string drops)
- scalar (`int`, `float`, `bool`) -> `[str(value)]`
- `list` -> each element normalized if scalar/string; invalid nested types dropped with warning
- other container/object (`dict`, custom object) -> `[]` + warning

In `ontos/io/files.py` `load_document_from_content()`:
- Replace inline `depends_on`/`impacts` normalization with `normalize_reference_list`.
- Enum coercion catches both `ValueError` and `TypeError` for `DocumentType` and `DocumentStatus` (`#25`).
- Invalid enum/value conditions emit `DocumentLoadIssue(code="invalid_enum", ...)` instead of only printing to stderr.

### Parser Convergence (`#1`)

`parse_frontmatter_content()` remains canonical parser.

`parse_frontmatter()` in `core/frontmatter.py` becomes **legacy-compatible only**:
- keep callable for compatibility
- update docstring to mark as non-canonical internal API
- remove new internal command usage in A1 (all target callers move to loader APIs)

`parse_frontmatter_yaml()` in `io/yaml.py`:
- keep function for compatibility
- reimplement as a thin wrapper using `parse_frontmatter_content()` semantics (no third contract)

### Command Migration (`#40` + `#1` convergence)

Migrate command internals to `load_documents`/`load_frontmatter`:

1. `ontos/commands/map.py`
- Replace per-file manual load loop (`docs[doc.id] = doc`) with `load_documents(...)`.
- Preserve existing filter behavior (`matches_filter`) after load.

2. `ontos/commands/maintain.py`
- `_load_docs_for_graph()` uses `load_documents(...)` and returns both documents + issues.
- `check_links` task must report parse issues (from loader) in task details/metrics.

3. `ontos/commands/query.py`
- Replace raw dict loading path with canonical `DocumentData` loading.
- Keep existing query output semantics.

4. `ontos/commands/verify.py`
- `find_stale_documents_list()` loads documents through canonical loader path.
- Single-file mode uses `load_frontmatter()` for consistent parse error messaging.

5. `ontos/commands/promote.py`
- file-scan phase uses canonical loader/frontmatter utility.

Additional parser callers migrated for consistency (`#1`):
- `ontos/commands/scaffold.py`
- `ontos/commands/migrate.py`
- `ontos/commands/consolidate.py`

Implementation readiness check: **Yes**. Functions, call sites, and edge-case behavior are fully specified.

---

## 4.2 Graph Integrity (`#10`, `#36`, `#8`)

### Purpose

Make graph construction deterministic and safe for malformed references while eliminating query-specific graph drift.

### File Changes

**Modify**
- `ontos/io/files.py`
- `ontos/commands/map.py`
- `ontos/commands/maintain.py`
- `ontos/commands/query.py`
- `ontos/core/validation.py`
- `ontos/core/types.py`

### Duplicate ID Handling (`#10`)

Add `ValidationErrorType.DUPLICATE_ID` in `ontos/core/types.py`.

Command policy table (context-dependent severity, as required by `#10` and Track B prereq `B5` groundwork):
- `map`: treat duplicates as validation **errors** (exit 1)
- `maintain` task `check_links`: treat duplicates as task **failed**
- `query`: **warn** and continue with canonical kept doc
- snapshot path (see 4.4): **warn** and continue with canonical kept doc

Reporting requirements:
- show duplicate ID
- show all file paths participating in collision
- never allow silent overwrite

### Query Graph Builder Dedup (`#36`)

In `ontos/commands/query.py`:
- delete local `build_graph(files_data)` (lines flagged in audit)
- import and use `ontos.core.graph.build_graph`
- adapt dependent-by and health calculations to core graph/reverse_edges

No parallel graph implementation remains after this change.

### Describes List Safety (`#8`)

In `ontos/core/validation.py`:
- change `validate_describes_field()` from scalar-only logic to normalized list-aware logic
- new accepted input forms:
  - scalar string
  - list of strings
- invalid entries (non-string list members) generate warning-level schema validation errors, do not raise exceptions
- return value becomes list of `ValidationError` instead of single optional error
- update `ValidationOrchestrator.validate_describes()` accordingly

Implementation readiness check: **Yes**. Behavior for duplicates and list handling is explicit and deterministic.

---

## 4.3 Validation Contract (`#42`, `#44`)

### Purpose

Make validation rules explicit and extensible so Track B can inherit them without hidden policy drift.

### File Changes

**Modify**
- `ontos/core/validation.py`
- `ontos/core/graph.py`
- `ontos/commands/map.py`

### Concepts Validation Integration (`#42`)

In `ValidationOrchestrator.validate_all()` add `self.validate_concepts()`.

New method behavior (`validate_concepts`):
- reads `concepts` from each document frontmatter
- normalization:
  - missing field -> skip
  - scalar string -> one concept
  - list -> iterate
- invalid concept forms (non-string, empty string) -> warning
- duplicate concepts in one doc -> warning
- vocabulary check:
  - if `config["known_concepts"]` provided, unknown concepts -> warning
  - if not provided, structural checks still run, vocabulary check is skipped

`ontos/commands/map.py` must populate `known_concepts` when available (from project concept source) into validation config passed to `ValidationOrchestrator`.

### Severity Model Codification (`#44`)

In `ontos/core/validation.py` define constants:

```python
REFERENCE_SEVERITY_DEFAULT = {
    "depends_on": "error",
    "impacts": "warning",
    "describes": "warning",
    "concepts": "warning",
}

REFERENCE_SEVERITY_RATIONALE = {
    "depends_on": "Structural graph edge; broken edge invalidates dependency graph.",
    "impacts": "Informational lineage edge; should be fixed but not structural.",
    "describes": "Staleness/coverage metadata; important but non-structural.",
    "concepts": "Taxonomy metadata; non-structural.",
}
```

Apply through a helper (config-overridable), e.g. `reference_severity_overrides` in validator config.

In `ontos/core/graph.py`:
- parameterize broken `depends_on` severity via optional argument (default from model above)
- remove hard-coded severity literals in graph and validation paths

This explicitly documents current asymmetry while making Track B free to override severities without duplicating logic.

Implementation readiness check: **Yes**. Severity is now explicit, documented in code, and configurable.

---

## 4.4 Cleanup and Layer Boundary (`#37`, `#33`)

### Purpose

Remove legacy enum fallback debt and restore architecture boundary by eliminating IO imports from core snapshot.

### File Changes

**Create**
- `ontos/io/snapshot.py`

**Modify**
- `ontos/core/snapshot.py`
- `ontos/commands/export_data.py`
- `ontos/commands/migration_report.py`
- `ontos/core/migration.py`
- `ontos/commands/map.py`
- `ontos/commands/export_data.py`
- `ontos/core/graph.py`
- `ontos/core/validation.py`
- tests that construct fake docs with raw strings

### Remove Defensive Enum Checks (`#37`)

Replace every occurrence of:
- `doc.type.value if hasattr(doc.type, 'value') else str(doc.type)`
- `doc.status.value if hasattr(doc.status, 'value') else str(doc.status)`

with direct enum access:
- `doc.type.value`
- `doc.status.value`

Known affected files (from audit):
- `ontos/core/graph.py`
- `ontos/core/migration.py`
- `ontos/core/snapshot.py`
- `ontos/core/validation.py`
- `ontos/commands/export_data.py`
- `ontos/commands/map.py`

Test fixtures using string mocks must be migrated to `DocumentType`/`DocumentStatus` enums.

### Snapshot Layer Refactor (`#33`)

Current violation: `core/snapshot.py` imports `ontos.io.*` in runtime path.

Refactor design:
1. `ontos/core/snapshot.py` becomes pure domain module:
- keep `SnapshotFilters`, `DocumentSnapshot`, `_matches_filter`
- add pure constructor, e.g. `build_snapshot(...)` from already-loaded `DocumentData`
- remove all `ontos.io.*` imports

2. `ontos/io/snapshot.py` becomes runtime assembly layer:
- loads config
- scans files
- loads documents using canonical `load_documents`
- calls core snapshot constructor
- returns `DocumentSnapshot`

3. Update call sites:
- `ontos/commands/export_data.py` import snapshot creation from IO layer
- `ontos/commands/migration_report.py` same

Compatibility note:
- `ontos.core.snapshot.create_snapshot` is no longer runtime loader API in v3.3.
- Internal imports must be updated in the same PR as the refactor.

Implementation readiness check: **Yes**. Boundaries and call-site moves are explicit.

---

## 4.5 Per-Item Implementation Cards

| Item | Purpose | Files (create/modify/delete) | Implementation Approach | Constraints |
|---|---|---|---|---|
| `#1 CC-03` | One parser contract in runtime code paths | Modify: `ontos/io/files.py`, `ontos/io/yaml.py`, `ontos/core/frontmatter.py`, parser callers in commands | Route runtime loads through `parse_frontmatter_content` via `load_documents`/`load_frontmatter`; keep `parse_frontmatter()` legacy-only | Must obey S4: parse failures skip with warning; no abort |
| `#8 C-5` | Prevent `describes` list crash | Modify: `ontos/core/validation.py` | Normalize scalar/list and validate each entry; no direct set-membership on raw object | No `TypeError` on list/dict input |
| `#9 C-7` | Normalize dependency reference fields safely | Modify: `ontos/core/frontmatter.py`, `ontos/io/files.py` | Introduce shared `normalize_reference_list`; use for `depends_on` and `impacts` | Scalar -> single-item list; invalid object -> warning + skip |
| `#10 C-8` | Eliminate silent duplicate-ID overwrite | Modify: `ontos/io/files.py`, `ontos/commands/map.py`, `ontos/commands/maintain.py`, `ontos/commands/query.py`, snapshot loader | Detect duplicates centrally in loader; keep deterministic canonical doc; report all collisions | Severity decided by caller; Track B must fail on duplicates (B5 groundwork) |
| `#25 C-6` | Handle invalid enum types robustly | Modify: `ontos/io/files.py` | Catch `(ValueError, TypeError)` for `DocumentType`/`DocumentStatus` coercion | Must emit clear issue with bad value and fallback used |
| `#33 CC-01` | Restore core/IO boundary in snapshot | Create: `ontos/io/snapshot.py`; Modify: `ontos/core/snapshot.py`, `ontos/commands/export_data.py`, `ontos/commands/migration_report.py` | Move runtime scanning/loading into IO wrapper; keep core snapshot pure | `ontos/core/snapshot.py` must not import `ontos.io.*` |
| `#36 CC-05` | Remove duplicate graph implementation | Modify: `ontos/commands/query.py` | Delete local `build_graph`; use `ontos.core.graph.build_graph` | Query behavior parity must be preserved |
| `#37 CC-06` | Remove obsolete enum defensive branches | Modify: `ontos/core/graph.py`, `ontos/core/migration.py`, `ontos/core/snapshot.py`, `ontos/core/validation.py`, `ontos/commands/export_data.py`, `ontos/commands/map.py` | Replace `hasattr(..., 'value')` patterns with direct `.value` | Update tests that use string mocks (`test_map_compact.py`, `test_map_filter.py`) |
| `#40 CC-09` | Establish canonical document-loading pattern | Modify: `ontos/io/files.py`, `ontos/commands/map.py`, `ontos/commands/maintain.py`, `ontos/commands/query.py`, `ontos/commands/verify.py`, `ontos/commands/promote.py` | Introduce and adopt shared `load_documents` result contract | No new scope semantics here (Track B handles unified scan scope) |
| `#41 CC-11` | Remove duplicate normalization logic | Modify: `ontos/core/frontmatter.py`, `ontos/io/files.py` | `io/files.py` delegates to frontmatter normalizer only | Single source of truth for dependency normalization |
| `#42 CC-16` | Ensure concepts are validated in orchestrator | Modify: `ontos/core/validation.py`, `ontos/commands/map.py` | Add `validate_concepts()` stage with structural + optional vocabulary checks | Must define invalid concepts semantics (non-string, empty, duplicate) |
| `#44 CC-19` | Make severity asymmetry explicit and configurable | Modify: `ontos/core/validation.py`, `ontos/core/graph.py` | Add `REFERENCE_SEVERITY_DEFAULT` + rationale + overrides | Preserve default asymmetry unless caller overrides |

---

## 5. Open Questions

1. Should `map` treat duplicate IDs as hard errors (exit 1) or warnings (exit 0/2)?
- Recommendation: **hard error (exit 1)**.
- Why: context map is a graph artifact; duplicates make graph identity ambiguous and nondeterministic (`#10`, prerequisite `B5`).

2. Should legacy `parse_frontmatter()` be removed now or left callable but deprecated?
- Recommendation: **keep callable in v3.3, mark internal-legacy, remove internal command usage now**.
- Why: enables low-risk migration while still enforcing canonical parser usage in runtime command paths (`#1`, S4).

---

## 6. Test Strategy

## 6.1 New/Updated Tests by Item Group

### Parser/Loader (`#1`, `#40`, `#41`, `#25`, `#9`)

Add `tests/io/test_document_loading_contract.py`:
- `load_documents` skips invalid YAML with `parse_error` issue
- `load_documents` records duplicate IDs with all paths
- enum coercion handles `TypeError` for list/dict `type`/`status`
- `depends_on`/`impacts` normalization cases:
  - scalar string
  - scalar numeric
  - dict object
  - mixed list with invalid nested object

Update command tests:
- `tests/commands/test_maintain.py`
  - `check_links` includes parse-skip details (no silent skip)
- `tests/commands/test_query_parity.py`
  - query still works with canonical loader path

### Graph Integrity (`#10`, `#36`, `#8`)

Add `tests/core/test_graph_contracts_a1.py`:
- duplicate handling policy receives deterministic canonical ID path
- `query` depended-by path uses core graph results (no local graph function)

Add `tests/core/test_validation_describes_a1.py`:
- `describes` as list no crash
- list with unknown ID produces warnings
- list with non-string element emits schema warning, no exception

### Validation Contract (`#42`, `#44`)

Add `tests/core/test_validation_concepts_a1.py`:
- concepts structural validation (scalar/list/invalid entries)
- duplicate concept warnings
- unknown concepts warning when `known_concepts` provided

Add `tests/core/test_validation_severity_policy_a1.py`:
- default severity mapping is applied
- override mapping changes emitted severity without code duplication

### Cleanup (`#37`, `#33`)

Update tests that use string doc mocks:
- `tests/test_map_compact.py`
- `tests/test_map_filter.py`

Snapshot boundary tests:
- update `tests/core/test_snapshot.py` and `tests/core/test_migration.py` to use IO snapshot entrypoint
- add architecture test assertion that `ontos/core/snapshot.py` contains no `from ontos.io` imports

## 6.2 Minimum Regression Suite for Track A1 PR Gate

Run at minimum:

```bash
pytest \
  tests/io/test_document_loading_contract.py \
  tests/io/test_files_status_parsing.py \
  tests/core/test_validation_describes_a1.py \
  tests/core/test_validation_concepts_a1.py \
  tests/core/test_validation_severity_policy_a1.py \
  tests/core/test_snapshot.py \
  tests/core/test_migration.py \
  tests/commands/test_maintain.py \
  tests/commands/test_query_parity.py \
  tests/test_map_compact.py \
  tests/test_map_filter.py
```

---

## 7. Migration / Compatibility

### Backward-Compatible

- CLI command names/flags unchanged in Track A1.
- Core graph primitives remain same callable entry points (`build_graph`, `detect_cycles`, etc.), with additive optional severity plumbing.
- `parse_frontmatter()` remains callable (legacy-compatible), but internal command code path should no longer rely on it.

### Potentially Breaking (Python API/Internal Imports)

- Snapshot runtime API moves out of `core/snapshot.py` into IO layer (`ontos/io/snapshot.py`).
- Internal modules importing `create_snapshot` from core must be updated in-track.
- Tests using raw-string type/status mocks must switch to enums due removal of defensive checks.

### Deprecation Notes

- `parse_frontmatter()` is deprecated for runtime command loading paths.
- `parse_frontmatter_yaml()` remains compatibility shim; no new call sites should be added.

---

## 8. Risk Assessment

### Overall Track Risk

**High** due contract refactors touching IO boundary, graph construction, validation semantics, and one architecture boundary split.

### Per-Item Risk

- High: `#1`, `#40` (contract unification + caller migration)
- Medium: `#10`, `#33`, `#44`
- Low/Medium: `#8`, `#9`, `#25`, `#36`, `#37`, `#41`, `#42`

### Mitigations

1. Implement contract APIs first (`io/files.py`), then migrate callers.
2. Keep deterministic duplicate policy (sorted paths, first-wins canonical) to avoid flaky behavior.
3. Keep severity model configurable (default + overrides) to avoid hard-coding Track B policy prematurely.
4. Land snapshot boundary refactor and all import updates in the same PR to avoid half-migrated state.
5. Require focused regression suite above before merge.

---

## 9. Item-to-Change Traceability

| Item | Primary Files | Core Acceptance Condition |
|---|---|---|
| `#1 CC-03` | `core/frontmatter.py`, `io/yaml.py`, `io/files.py`, command callers | Canonical parser path used in runtime loading; no mixed parser contracts in key command paths |
| `#8 C-5` | `core/validation.py` | `describes` list input never raises `TypeError` |
| `#9 C-7` | `core/frontmatter.py`, `io/files.py` | `depends_on`/`impacts` always normalized to `List[str]` with warnings on invalid input |
| `#10 C-8` | `io/files.py`, `map.py`, `maintain.py`, `query.py`, snapshot loader | Duplicate IDs are detected and reported; no silent overwrite |
| `#25 C-6` | `io/files.py` | Enum coercion handles both `ValueError` and `TypeError` |
| `#33 CC-01` | `core/snapshot.py`, `io/snapshot.py`, command imports | No IO imports remain in `core/snapshot.py` |
| `#36 CC-05` | `commands/query.py` | Local query graph builder removed; core graph builder is only implementation |
| `#37 CC-06` | 6 files listed in 4.4 | 21 defensive enum checks removed; direct enum access used |
| `#40 CC-09` | `io/files.py`, `map.py`, `maintain.py`, `query.py`, `verify.py`, `promote.py` | Canonical loading contract is used by all 5 targeted command flows |
| `#41 CC-11` | `core/frontmatter.py`, `io/files.py` | One normalization implementation used everywhere |
| `#42 CC-16` | `core/validation.py` | Concepts validation executes via orchestrator |
| `#44 CC-19` | `core/validation.py`, `core/graph.py` | Severity policy is explicit, documented, and configurable |
