# v3.3 Audit: Correctness & Edge Case Gaps (Codex)

Scope audited: `ontos/` and `tests/`.

Backlog exclusions applied: `X-H2`, `X-M1` through `X-M12` from `.ontos-internal/strategy/v3.2/v3_2_backlog.md`.

## ontos/cli.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-1` |
| **File** | `ontos/cli.py:1037`, `ontos/cli.py:1040`, `ontos/cli.py:1043` |
| **Category** | Input Validation |
| **Severity** | P1 |
| **Current behavior** | When no command is provided, CLI emits an error message (`E_NO_CMD` in JSON mode) but exits with code `0`. |
| **Expected behavior** | Exit non-zero when command is missing so scripts/CI can detect failure. |
| **Effort** | Small (<30 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-2` |
| **File** | `ontos/cli.py:629`, `ontos/cli.py:643`, `ontos/commands/env.py:586`, `ontos/commands/env.py:590` |
| **Category** | Input Validation |
| **Severity** | P1 |
| **Current behavior** | Global `--json` does not force JSON for `env`; if `--format` is left as default (`text`), `_cmd_env` still prints text output even with `--json`. |
| **Expected behavior** | `--json` should guarantee JSON output (or fail with a clear conflict message). |
| **Effort** | Small (<30 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-3` |
| **File** | `ontos/cli.py:934`, `ontos/cli.py:947`, `ontos/commands/query.py:28`, `ontos/commands/query.py:182`, `ontos/commands/query.py:240` |
| **Category** | Input Validation |
| **Severity** | P2 |
| **Current behavior** | `query` receives `json_output=True` but never branches on it; output remains human text despite global `--json`. |
| **Expected behavior** | Either implement JSON output for `query` or reject `--json` for commands that do not support it. |
| **Effort** | Medium (30-100 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-4` |
| **File** | `ontos/cli.py:444`, `ontos/cli.py:447`, `ontos/cli.py:972`, `ontos/cli.py:975` |
| **Category** | Input Validation |
| **Severity** | P1 |
| **Current behavior** | `scaffold` parser accepts both `--apply` and `--dry-run`, but handler ignores `args.dry_run` and sets `dry_run=not args.apply`. `--apply --dry-run` still writes. |
| **Expected behavior** | Enforce mutual exclusion or prioritize `--dry-run` safely with explicit conflict handling. |
| **Effort** | Small (<30 LOC) |

## ontos/core/validation.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-5` |
| **File** | `ontos/core/validation.py:40`, `ontos/core/validation.py:41` |
| **Category** | Edge Case |
| **Severity** | P1 |
| **Current behavior** | `validate_describes_field()` assumes `describes` is scalar. If YAML provides a list (`describes: [a, b]`), membership check against a set throws `TypeError` and can abort map validation. |
| **Expected behavior** | Normalize list/scalar forms and validate each reference without raising. |
| **Effort** | Small (<30 LOC) |

## ontos/io/files.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-6` |
| **File** | `ontos/io/files.py:151`, `ontos/io/files.py:152`, `ontos/io/files.py:156`, `ontos/io/files.py:157` |
| **Category** | Input Validation |
| **Severity** | P2 |
| **Current behavior** | Enum coercion catches `ValueError` only; malformed YAML types (e.g., list/dict for `type`/`status`) raise `TypeError`, which bubbles and drops docs in callers. |
| **Expected behavior** | Catch `TypeError` as input-invalid and downgrade safely with diagnostics. |
| **Effort** | Small (<30 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-7` |
| **File** | `ontos/io/files.py:167`, `ontos/io/files.py:174`, `ontos/core/graph.py:64`, `ontos/core/validation.py:160` |
| **Category** | Input Validation |
| **Severity** | P1 |
| **Current behavior** | `depends_on`/`impacts` are only normalized for `None` and `str`; numeric/object values remain non-iterable and later cause `TypeError` during graph/validation iteration. |
| **Expected behavior** | Normalize any non-list input deterministically (`[]` or `[str(v)]`) and surface a warning. |
| **Effort** | Medium (30-100 LOC) |

## Duplicate-ID Handling (Multiple Modules)

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-8` |
| **File** | `ontos/commands/map.py:737`, `ontos/commands/maintain.py:255`, `ontos/core/snapshot.py:152`, `ontos/commands/query.py:44` |
| **Category** | Edge Case |
| **Severity** | P1 |
| **Current behavior** | Duplicate IDs overwrite earlier documents silently (`dict` assignment), so graph/report outputs can become nondeterministic and incorrect. |
| **Expected behavior** | Detect duplicate IDs and fail fast with explicit file collision diagnostics. |
| **Effort** | Medium (30-100 LOC) |

## ontos/commands/maintain.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-9` |
| **File** | `ontos/commands/maintain.py:251`, `ontos/commands/maintain.py:256`, `ontos/commands/maintain.py:258` |
| **Category** | Silent Failure |
| **Severity** | P1 |
| **Current behavior** | `_load_docs_for_graph()` swallows all per-file parse/load exceptions and silently skips files, which can under-report broken links. |
| **Expected behavior** | Track skipped files and include them as warnings/failures in task output. |
| **Effort** | Small (<30 LOC) |

## ontos/commands/consolidate.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-10` |
| **File** | `ontos/commands/consolidate.py:230`, `ontos/commands/consolidate.py:232`, `ontos/commands/consolidate.py:240` |
| **Category** | Edge Case |
| **Severity** | P1 |
| **Current behavior** | Log files are moved immediately (`shutil.move`) before decision-history updates are committed, so failures can leave partial state (archived logs without ledger update). |
| **Expected behavior** | Use one atomic transaction (or explicit rollback path) for move + ledger update. |
| **Effort** | Medium (30-100 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-11` |
| **File** | `ontos/commands/consolidate.py:237`, `ontos/commands/consolidate.py:246` |
| **Category** | Silent Failure |
| **Severity** | P1 |
| **Current behavior** | Per-log errors are printed but command still exits `0` unconditionally. |
| **Expected behavior** | Return non-zero if any archive/update operation failed. |
| **Effort** | Small (<30 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-12` |
| **File** | `ontos/commands/consolidate.py:180`, `ontos/commands/consolidate.py:112` |
| **Category** | Input Validation |
| **Severity** | P2 |
| **Current behavior** | If `impacts` is scalar string, `', '.join(impacts)` splits into characters in decision history rows. |
| **Expected behavior** | Normalize `impacts` to list semantics before joining. |
| **Effort** | Small (<30 LOC) |

## ontos/commands/doctor.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-13` |
| **File** | `ontos/commands/doctor.py:216`, `ontos/commands/doctor.py:249`, `ontos/commands/doctor.py:290` |
| **Category** | Edge Case |
| **Severity** | P1 |
| **Current behavior** | Several checks use `Path.cwd()` + config paths instead of resolved repo root; running from a subdirectory can produce false "missing docs/context map" failures. |
| **Expected behavior** | Resolve project root once, and evaluate all repo-relative paths against that root. |
| **Effort** | Medium (30-100 LOC) |

## ontos/core/paths.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-14` |
| **File** | `ontos/core/paths.py:22`, `ontos/core/paths.py:32`, `ontos/core/paths.py:137`, `ontos/core/paths.py:144` |
| **Category** | Edge Case |
| **Severity** | P1 |
| **Current behavior** | Path helpers are anchored to module install location (`PROJECT_ROOT` from `__file__`), not the active project root. Commands relying on these helpers can target the wrong filesystem tree. |
| **Expected behavior** | Resolve paths from runtime project root discovery, not package location. |
| **Effort** | Large (100+ LOC) |

## ontos/core/proposals.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-15` |
| **File** | `ontos/core/proposals.py:48`, `ontos/core/proposals.py:49`, `ontos/core/proposals.py:51` |
| **Category** | Edge Case |
| **Severity** | P2 |
| **Current behavior** | Markdown table separator rows can be parsed as ledger entries because only `|:` and `| Date` are excluded. This pollutes slug/outcome sets. |
| **Expected behavior** | Skip separator rows and validate parsed column payload before recording entries. |
| **Effort** | Small (<30 LOC) |

## ontos/core/history.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-16` |
| **File** | `ontos/core/history.py:259` |
| **Category** | Input Validation |
| **Severity** | P2 |
| **Current behavior** | `generate_decision_history()` calls `os.makedirs(os.path.dirname(output_path))`; passing a bare filename (`decision_history.md`) yields empty dirname and fails. |
| **Expected behavior** | Handle file-in-cwd output paths safely (`Path(output_path).parent`). |
| **Effort** | Small (<30 LOC) |

## ontos/commands/migrate.py

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-17` |
| **File** | `ontos/commands/migrate.py:23`, `ontos/commands/migrate.py:49`, `ontos/commands/migrate.py:106`, `ontos/commands/migrate.py:140` |
| **Category** | Input Validation |
| **Severity** | P2 |
| **Current behavior** | `MigrateOptions.apply` exists but is never used; non-CLI callers can trigger writes with `apply=False` when `dry_run=False`. |
| **Expected behavior** | Gate all writes on explicit `apply=True` inside command logic. |
| **Effort** | Small (<30 LOC) |

## Test Coverage Gaps

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-18` |
| **File** | `ontos/core/graph.py:44`, `ontos/core/graph.py:86`, `ontos/core/graph.py:129`, `ontos/core/graph.py:148` |
| **Category** | Test Gap |
| **Severity** | P2 |
| **Current behavior** | No direct tests for core graph primitives (`build_graph`, cycle/orphan/depth). Failures can propagate into multiple commands undetected. |
| **Expected behavior** | Add direct unit tests for malformed dependency types, self-deps, empty graphs, and duplicate-node behavior. |
| **Effort** | Medium (30-100 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-19` |
| **File** | `ontos/core/schema.py:78`, `ontos/core/schema.py:117`, `ontos/core/schema.py:173`, `ontos/core/schema.py:255`, `ontos/core/schema.py:295` |
| **Category** | Test Gap |
| **Severity** | P2 |
| **Current behavior** | No direct tests for schema parse/compatibility/serialization functions. Behavior around unknown schemas and serialization edge cases is unguarded. |
| **Expected behavior** | Add focused tests for version parsing, unknown schema policy, and serialization round-trip edge cases. |
| **Effort** | Medium (30-100 LOC) |

| Field | Content |
|-------|---------|
| **ID** | `AUDIT-C-20` |
| **File** | `ontos/commands/log.py:63`, `ontos/commands/log.py:173`, `ontos/commands/log.py:238` |
| **Category** | Test Gap |
| **Severity** | P2 |
| **Current behavior** | No command-level tests for `log` path resolution/frontmatter creation/error paths; coverage is mostly indirect via golden harness scripts. |
| **Expected behavior** | Add direct unit/integration tests for `log_command`, including config path handling and JSON mode behavior. |
| **Effort** | Medium (30-100 LOC) |
