# v3.2.4 Pre-Phase A: Peer Review â€” Library Maintenance Commands

**Reviewer:** Gemini (Peer Reviewer)
**Author:** Codex (Chief Architect)
**Status:** Request Changes
**Date:** 2026-02-10

---

## 1. Executive Summary

The v3.2.4 proposal is a well-grounded response to the discovery reports, particularly in its decision to defer the high-risk/low-value `retrofit` variants in favor of `link-check` and `rename`. The data in the **Content Report** (48 broken links, 40% orphans) makes the case for these commands undeniable.

However, there are significant gaps in the **execution model** (scope consistency) and **safety logic** (duplicate IDs) that would lead to a flawed specification if not addressed.

---

## 2. Issues Found

### Critical (Blocks Spec Development)

1.  **Divergent Default Scope:** The proposal recommends `library` as the default scope for `link-check` and `rename`. While logically sound (given that .ontos-internal contains 90% of the strategy docs), this creates a **UX split** with every other command (`map`, `maintain`, `query`) which defaults to `docs`. A user running `ontos rename` might inadvertently modify files that `ontos map` doesn't even see. 
    *   **Requirement:** Either unify the system-wide scan scope first, or make `docs` the default with a very prominent "Discovery" warning if orphans/broken links exist outside that scope.
2.  **Silent ID Collision in Scan Phase:** The **Feasibility Report** notes that existing loaders (`docs[doc.id] = doc`) silently overwrite duplicate IDs. If `rename` or `link-check` runs on a library with duplicate IDs, they will operate on a "partial" graph, potentially missing references or renaming the wrong document.
    *   **Requirement:** The spec must mandate an explicit `collision-check` in the scanning phase for both commands. `link-check` must report duplicate IDs as P0 errors. `rename` must abort if any duplicates exist in the requested scope.

### Major (Should Fix Before Spec)

1.  **Exit Code Over-Sensitivity:** The proposal sets exit `1` if *any* orphan is found. The **Content Report** shows that 40% of the library (237 docs) are orphans. This ensures `link-check` will fail in CI for almost any real-world project.
    *   **Requirement:** Distinguish between **Hard Failures** (broken `depends_on`, `impacts`, `describes`) and **Soft Warnings** (orphans, staleness). Exit code `1` should be reserved for broken references.
2.  **Zone-Aware Parser Ambiguity:** The "zone-aware" body parser is the highest-risk new code. The proposal does not specify if this is a regex-based approximation or a formal Markdown AST (e.g., `mistune`).
    *   **Requirement:** Specify the parsing strategy. A regex approach is likely sufficient for "code block detection" but the spec must define the boundaries (e.g., does it handle nested fences? indented code blocks?).
3.  **Template Destruction Risk:** The **Design Report** confirms that `serialize_frontmatter()` strips YAML comments. `rename` will touch any file referencing the renamed ID. If the `_template.md` or a manual with commented YAML is touched, the comments are lost.
    *   **Requirement:** The spec should explicitly exclude `.ontos-internal/templates` from the `rename` write-loop or implement a "comment-safe" serializer.

### Minor (Consider)

1.  **Missing "Census" Data:** The **Content Report** suggests a `census` command to track the "39% untagged" iceberg. Adding a "Coverage" stat to the `link-check` summary (e.g., "593 files found, 363 tracked") would be a low-effort, high-value addition.
2.  **Confidence-Based Fixes:** Since `link-check` already calculates confidence scores for suggestions, a future `ontos link-check --fix --min-confidence 0.9` would be a natural evolution. The spec should ensure the internal API supports this.

---

## 3. Reference Verification

| Proposal Claim | Reference Verification | Result |
|----------------|------------------------|--------|
| `link-check` is ~90% built. | **Design Report** confirms Task 7 in `maintain` is the core logic. | **Verified** |
| Broken links are a high-volume problem. | **Content Report** identifies 48 broken `depends_on` and 13 broken `impacts`. | **Verified** |
| `rename` addresses stale reference patterns. | **Content Report** shows specific examples (`v2_9_implementation_plan`). | **Verified** |
| `SessionContext` handles atomicity. | **Feasibility Report** confirms Phase 1/2 logic but warns on Phase 2 failures. | **Verified w/ Warning** |

---

## 4. Positive Observations

- **Evidence-Led Descoping:** Excellent job deferring `retrofit --lint-fix`. The **Content Report** proved that "excessive concepts" and `summary` fields were ghosts.
- **Safety Precedents:** Adopting the `scaffold` precedent (dry-run by default, `--apply` to commit) and the "clean git" requirement is the correct way to handle cross-library writes.
- **JSON Support:** Including `--json` in the initial proposal ensures this utility can be used in specialized CI workflows from day one.

---

## 5. Verdict

**Request Changes**

The proposal is 90% of the way there. Once the **scope consistency**, **collision detection**, and **exit code sensitivity** are refined, it will be ready for specification.
