---
id: v3_2_4_prea_consolidation
type: review
status: active
depends_on: [v3_2_4_prea_peer_review, v3_2_4_prea_alignment_review, v3_2_4_prea_adversarial_review]
concepts: [consolidation, v3.2.4, proposal-review, pre-phase-a]
---

# v3.2.4 Pre-Phase A: Review Consolidation

> **Consolidator:** Antigravity, powered by Gemini 2.5 Pro
> **Date:** 2026-02-10
> **Inputs:** Peer Review (Gemini), Alignment Review (Antigravity), Adversarial Review (Claude)
> **Proposal:** `v3.2.4_Proposal_Library_Maintenance.md`

---

## Verdict Summary

| Reviewer | Role | Verdict | Blocking Issues Count |
|----------|------|---------|----------------------|
| Gemini | Peer | Request Changes | 2 |
| Antigravity | Alignment | Approve with Observations | 0 |
| Claude | Adversarial | Request Changes | 3 |

**Consensus:** 1/3 Approve
**Overall:** Needs Revision

---

## Blocking Issues

Combined list of issues that block moving to Phase A spec development.

| # | Issue | Flagged By | Category | Action Required |
|---|-------|------------|----------|-----------------|
| B1 | **Body-link bare-ID matching semantics are unspecified.** IDs contain regex metacharacters (dots in `v3.0.4_Code_Review_Claude`), and `\b` word boundaries interact unpredictably with dots/hyphens. A rename of `v3_2` when body text contains `v3_2.1` would false-positive match because `.` creates a word boundary. 14 broken references in the library already use mixed dot/underscore conventions, proving these patterns exist in practice. | Claude (Critical) | Safety / Correctness | Define exact tokenization rules for bare-ID matching: (a) regex escaping of metacharacters, (b) whether `_`, `-`, `.` are word-internal or word-boundary for matching, (c) explicit handling of "ID is a prefix separated by non-word char" case with test vectors from real library IDs. |
| B2 | **`link-check` and `rename` operate on different reference models.** `link-check` validates frontmatter only (`depends_on`, `impacts`, `describes`). `rename` modifies frontmatter AND body-text references. After rename, `link-check` cannot verify body-text changes were correct, nor detect false-positive rewrites. The proposal positions `link-check` as a validation gate for `rename`, but it can only validate half of what `rename` touches. | Claude (Critical) | Architecture / Validation Gap | Either: (a) expand `link-check` to detect body references, (b) add post-apply verification to `rename`, or (c) explicitly document the gap with user-facing warnings. |
| B3 | **Dry-run output for body-text matches is file-level counts, not line-level context.** "3 body refs changed" in a 500-line manual gives users no way to verify correctness before `--apply`. The clean-git mitigation (`git diff`) only works AFTER apply, when damage is done. | Claude (Critical) | UX / Safety | Dry-run must include: line number, matched text with surrounding context (min 1 line before/after), and zone classification for each body-text match. |
| B4 | **Divergent default scope creates UX split with existing commands.** Proposal defaults to `library` scope, but `map`, `maintain`, `query` default to `docs`. A user running `rename` might modify files that `map` doesn't see. `link-check --scope library` would report 48 broken links while `map` shows 38 — different numbers for the same library with no explanation. | Gemini (Critical), Claude (Major — M4) | UX / Consistency | Either unify system-wide scan scope first, or make `docs` the default with prominent warning if issues exist outside that scope. |
| B5 | **Silent ID collision in scan phase.** Existing loaders (`docs[doc.id] = doc`) silently overwrite duplicate IDs. Both `link-check` and `rename` would operate on a partial graph if duplicates exist. | Gemini (Critical) | Correctness | Mandate explicit collision-check in scanning phase. `link-check` must report duplicates as P0 errors. `rename` must abort if duplicates exist in scope. |

---

## Should-Fix Issues

Non-blocking but recommended before or during spec development.

| # | Issue | Flagged By | Category | Recommendation |
|---|-------|------------|----------|----------------|
| S1 | **Exit code over-sensitivity.** 40% of library (237 docs) are orphans. Orphans triggering exit `1` means `link-check` will never return `0` in CI. | Gemini (Major), Claude (Minor — m1) | UX / CI Integration | Distinguish hard failures (broken refs → exit 1) from soft warnings (orphans → exit 0 or separate code 2). |
| S2 | **Zone-aware body parser strategy unspecified.** The highest-risk new component is described in 4 bullet points. Does not specify regex vs. AST approach, handling of nested fences, or indented code blocks. Ontos_Manual.md has 24 `---` markers and YAML code blocks inside markdown code fences. | Gemini (Major), Claude (Failure Mode) | Implementation Risk | Specify parsing strategy explicitly. Define boundary handling (nested fences, indented code blocks). |
| S3 | **Template/comment destruction risk via `serialize_frontmatter()`.** Rename touching `depends_on` in 50 files produces 50 files of formatting noise (field reordering, comment stripping, list reformatting) obscuring the actual semantic change. Code review becomes impractical. | Gemini (Major), Claude (Major — M2) | UX / Code Review | Either implement targeted field-update (modify only the specific line), exclude `templates/` from write-loop, or document the noise prominently as a risk factor. |
| S4 | **Two frontmatter parsing paths produce different results on edge cases.** `core.frontmatter.parse_frontmatter()` returns `None` silently on malformed YAML. `io.yaml.parse_frontmatter_content()` raises `ValueError`. Proposal doesn't specify which parser `rename` uses. | Claude (Major — M1), Antigravity (§2.1 — noted as constraint) | Spec Gap | Spec must mandate which parsing path `rename` uses and define behavior on parse failure (skip with warning? abort entire rename?). |
| S5 | **Post-rename artifact regeneration not specified.** `AGENTS.md`, `Ontos_Context_Map.md`, and `CLAUDE.md` contain document IDs that become stale after rename. Proposal doesn't specify regeneration steps. | Claude (Major — M3) | Completeness | `rename --apply` output should warn: "Run `ontos map` and `ontos agents` to regenerate." Or run regeneration automatically. |
| S6 | **`rename` JSON output shape underspecified.** Proposal defines detailed JSON for `link-check` but only says rename emits "a full change plan." | Antigravity (O1, O2) | Spec Completeness | Define explicit JSON shape during spec (e.g., `{files: [{path, changes}], summary: {...}}`). Follow `JsonOutputHandler.result()` pattern. |
| S7 | **`rename` exit codes not specified.** Proposal defines exit codes for `link-check` (0 = clean, 1 = issues) but not for `rename`. | Antigravity (O3) | Spec Completeness | Suggested: 0 = applied/dry-run valid, 1 = pre-validation failure or execution error. |

---

## Minor Issues

Consider but not required.

| # | Issue | Flagged By | Recommendation |
|---|-------|------------|----------------|
| M1 | Missing "census" coverage stat in `link-check` output (e.g., "593 files found, 363 tracked"). | Gemini | Low-effort addition. Content Report's "39% untagged" ice berg supports this. |
| M2 | Future `link-check --fix --min-confidence 0.9` path. Internal API should support confidence-based auto-fix. | Gemini | Ensure API design doesn't preclude this extension. |
| M3 | `validate_concepts()` exists (`suggestions.py:127-149`) but is never called by `ValidationOrchestrator`. Orphaned validation function. | Claude (m2) | Document or integrate before it bitrots. |
| M4 | Symlink following in `scan_documents()` — `Path.rglob("*.md")` follows symlinks by default. Rename could modify files outside the repo. | Claude (m3) | Consider `follow_symlinks=False` or document the behavior. |
| M5 | `describes` validation doesn't call suggestion engine — only emits bare warnings without candidates. `link-check` will need to extend this. | Antigravity (O4) | Small extension of `suggest_candidates_for_broken_ref` pattern. |
| M6 | `concepts` field excluded from `rename` scope. If a doc ID matches a concept value, the concept won't be updated, and `link-check` won't catch it. | Claude (Failure Mode) | Acceptable IF documented. Concepts are tags, not references. Currently undocumented. |
| M7 | `--scope` is a new CLI pattern — no existing command has this flag. Establishes a precedent. | Antigravity (O1) | Track as a design precedent decision. Consider whether future commands adopt it. |

---

## Agreement Analysis

### Strong Agreement (2+ reviewers flagged the same concern)

| Concern | Flagged By | Severity |
|---------|------------|----------|
| **Default scope divergence** with existing commands (`library` vs `docs`) | Gemini (Critical), Claude (Major), Antigravity (Observation) | **Blocking** — all three reviewers raised scope consistency concerns. Highest-confidence finding. |
| **Duplicate ID silent overwrite** in scan phase | Gemini (Critical), Antigravity (§2.2 — verified), Claude (Assumption Attack) | **Blocking** — Gemini and Claude flag as critical risk. Antigravity confirms the code behavior (`maintain.py:255`). |
| **Frontmatter serialization noise** defeating code review of rename diffs | Gemini (Major), Claude (Major — M2) | **Should-Fix** — both agree the current serializer makes 50-file rename diffs impractical to review. |
| **Exit code sensitivity** with 40% orphan rate | Gemini (Major), Claude (Minor) | **Should-Fix** — Gemini rates Major, Claude rates Minor. Both agree exit 1 for orphans is problematic at current scale. |
| **Zone-aware body parser** needs more specification | Gemini (Major), Claude (Critical + Failure Mode) | **Blocking/Should-Fix** — overlaps with B1. Claude's concern is broader (exact matching semantics); Gemini's is about implementation strategy. |
| **`SessionContext` Phase 2 partial-commit limitation** | Gemini (verified w/ warning), Antigravity (§1.4 — verified), Claude (Assumption Attack) | **Acknowledged by all** — the proposal's mitigation (clean-git + fail-fast) is accepted as adequate by Gemini and Antigravity. Claude notes users may not realize a failure occurred. |

### Disagreements

| Topic | Reviewer A View | Reviewer B View | Type | Recommendation |
|-------|----------------|-----------------|------|----------------|
| **Overall verdict** | Antigravity: Approve with Observations (0 blockers) | Gemini: Request Changes (2 blockers); Claude: Request Changes (3 blockers) | Priority | Antigravity's review focused on architecture compliance and backward compatibility (all pass). Gemini and Claude focused on execution safety and UX — finding gaps the alignment lens doesn't cover. **CA should treat as "Needs Revision."** |
| **Duplicate ID handling** | Antigravity: "net improvement over current behavior, not a violation" | Gemini: "Critical — must mandate collision-check" | Priority | Both agree the proposal correctly identifies the issue. Disagreement is whether the proposal's current language is sufficient (Antigravity) or needs stronger mandating (Gemini). **CA should strengthen the mandate.** |
| **Exit code for orphans** | Gemini: Major — exit 1 will always fail in CI | Claude: Minor — "consider separate exit codes" | Priority | Same concern, different severity. **CA decides.** |
| **`SessionContext` adequacy** | Antigravity: "architecturally sound mitigation" | Claude: "`commit()` return value is never checked by any existing command — user may not know failure occurred" | Factual + Priority | Claude's observation that the return value is unchecked is a factual finding (code-verified). Antigravity's finding that the mitigation strategy is architecturally precedented is also correct. **CA should ensure rename checks commit return value and reports clearly on partial failure.** |

### Single-Reviewer Findings (unique insights)

| Finding | Reviewer | Why It Matters |
|---------|----------|---------------|
| **`link-check` and `rename` have no shared reference model** — two commands operating on "references" define them differently (frontmatter-only vs. frontmatter + body). Post-rename validation gap. | Claude (C2) | This is the deepest architectural insight. If `link-check` can't validate what `rename` modified, the safety model has a hole that users can't see. |
| **Dry-run must show line-level context for body-text matches**, not just file-level counts. | Claude (C3) | Without this, the dry-run safety model is theater for body-text changes. Users can't verify correctness of the highest-risk operation. |
| **230 files without frontmatter** — rename can't update structured fields that don't exist. Body text in these files (e.g., release notes) may contain the renamed ID. | Claude (Edge Case) | Rename may silently skip these files or attempt body-only rewrite. Behavior is unspecified. |
| **Post-rename derived artifact staleness** — `AGENTS.md`, `Ontos_Context_Map.md` become stale. | Claude (Blind Spot #2) | Users who trust these files after rename get stale information. No warning in proposal. |
| **`describes` field uses WARNING severity, not ERROR** — stale `describes` after partial rename appears as warning only. | Claude (Blind Spot #4) | Users filtering on errors miss this. |
| **Idempotency of rename is correct by accident** — second run fails with "old_id not found" (correct behavior, but unspecified). | Claude (Failure Mode) | Not an issue, but should be documented for completeness. |
| **`--scope` flag is a new UX pattern** with no precedent in existing commands. | Antigravity (O1) | Establishes a pattern. Decision to track: should future commands adopt it? |
| **`describes` validation doesn't call suggestion engine** — no confidence-scored candidates for `describes` broken refs. | Antigravity (O4) | `link-check` implementation will need a small extension here. |
| **Census/coverage stats** as low-effort addition to `link-check` output. | Gemini (Minor) | High-value UX addition. "593 files found, 363 tracked" surfaces the untagged iceberg. |

---

## Required Actions for CA

Prioritized list of what the CA must address before moving to Phase A.

| Priority | Action | Addresses | Effort Estimate |
|----------|--------|-----------|-----------------|
| 1 | **Define exact bare-ID tokenization and matching rules** with test vectors from real library IDs (IDs with dots, prefix IDs, mixed conventions). Answer: given `v3_2` and body text `v3_2.1`, does the parser match? | B1 | Medium — design decision + test vectors |
| 2 | **Resolve the `link-check` / `rename` reference model gap.** Choose: expand link-check, add post-apply verification to rename, or explicitly disclaim + document. | B2 | Low–Medium — design decision |
| 3 | **Specify dry-run output for body-text matches at line-level granularity** (line number, context, zone classification). | B3 | Low — output format specification |
| 4 | **Resolve default scope divergence.** Choose: unify system-wide scope, or default to `docs` with opt-in `library`, or label scope prominently in all output. | B4 | Low — design decision |
| 5 | **Strengthen duplicate ID collision-check mandate** — make it explicit that both commands detect and fail on duplicates in scanning phase. | B5 | Low — language strengthening |
| 6 | **Decide exit code semantics for orphans** — separate from broken references or combined? | S1 | Low — design decision |
| 7 | **Specify body-link parser strategy** — regex vs. AST, nested fences, indented code blocks. | S2 | Medium — design decision |
| 8 | **Address serialization noise** — targeted field update, template exclusion, or documented acceptance. | S3 | Medium — design or implementation decision |
| 9 | **Mandate parsing path for `rename`** and define parse-failure behavior. | S4 | Low — specification |
| 10 | **Specify post-rename regeneration** for derived artifacts. | S5 | Low — add warning or auto-regeneration |

---

## Decision Summary

**Status:** Needs CA Response First

The CA must resolve the following before the proposal can move to Phase A specification:

1. **B1 — Bare-ID matching semantics:** Define tokenization rules with real library test vectors. This is the most critical unresolved design question — it determines whether `rename` is safe for body-text operations.

2. **B2 — Reference model gap:** Decide how body-text changes are validated post-rename. This is an architectural decision that shapes both commands.

3. **B3 — Dry-run granularity:** Specify line-level output for body-text matches. This is straightforward but non-negotiable for safety.

4. **B4 — Scope default:** Resolve the divergence with existing commands. Three reviewers flagged this independently — highest-confidence finding.

5. **B5 — Duplicate ID mandate:** Strengthen the language. Both reviewers who flagged this agree on the fix; the proposal already identifies the problem but needs stronger specification.

**Verification needed:** Items B1 and B2 require design decisions that should be reviewed (brief CA response is sufficient). Items B3–B5 are straightforward specification additions that can be verified during spec review.
