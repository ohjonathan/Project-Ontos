---
id: v3_0_2_hybrid_review_alignment_claude
type: atom
status: complete
depends_on: [v3.0.2_Implementation_Spec, 20260116_bug-log]
concepts: [alignment-review, code-review, bug-fixes, scope-validation]
---

# v3.0.2 Hybrid Review: Alignment Reviewer (Claude)

**Version:** 1.0
**Date:** 2026-01-18
**Role:** Alignment Reviewer
**Model:** Claude Opus 4.5 (via Antigravity)
**Phase:** B+D Hybrid (Spec + Implementation Review)

---

## Part 1: Bug Log Alignment

The bug log (2026-01-16) is **ground truth**. Every user-experienced issue must be addressed or explicitly deferred.

### Bug Log Issue Inventory

| Line(s) | User Issue | Spec Status | Acceptable? |
|---------|-----------|-------------|-------------|
| 92-93 | `ontos map` fails with `ModuleNotFoundError: No module named 'ontos_config'` | CA: "WORKS NOW" | ✅ **Verified** — `cli.py:240-251` uses native `map_command()` |
| 80-81 | `ontos init` context map generation returned code 1 | Implicitly fixed | ✅ **Verified** — `init.py:104-145` uses native `map_command()` |
| 107-109 | `ontos doctor` shows context_map not found | CA: Native | ✅ **Verified** — Native command, symptom was due to map failure |
| 164-176 | Legacy scripts expect user-created `ontos_config.py` that may not exist | **NOT ADDRESSED** | ⚠️ **Gap** — Deferred commands still have this problem |
| 297-306 | User created shim files as workaround | N/A (user workaround) | ✅ Not a bug — user mitigation |
| 371-376 | CLI wrapper changes cwd to package root | **NOT ADDRESSED** | ⚠️ **Gap** — `cli.py:410` sets `cwd` to package root for wrappers |
| 499-503 | `.ontos.toml` settings ignored by legacy scripts | **NOT ADDRESSED** | ❌ **Critical Gap** — Not mentioned in spec |

### Bug Log Alignment Verdict

| Status | Count |
|--------|-------|
| Issues addressed | 3/7 |
| Issues deferred with rationale | 3/7 (verify, query, consolidate) |
| Issues missing | 1/7 (`.ontos.toml` ignored) |

**Key Concern:** The bug log explicitly documents that `.ontos.toml` settings (`docs_dir`) are ignored by legacy scripts (line 499-503). This is **not mentioned** in the spec at all — not as fixed, not as deferred, not as known issue.

---

## Part 2: Proposal Alignment

### Bug Fixes Plan Alignment

| Proposal Item | Spec Status | Justified? |
|---------------|-------------|------------|
| Replace `_generate_initial_context_map()` with native call | CA: "Already fixed" | ✅ **Verified** — Code at `init.py:104-145` matches proposal intent |
| Remove unused `subprocess` import from init.py | **NOT MENTIONED** | ⚠️ **Minor Gap** — `subprocess` still imported in `cli.py:10` but not in `init.py` |
| Fix 4 legacy script syntax errors | ✅ Included | ✅ Correct |

### Legacy Remediation Proposal Alignment

| Proposal Item | Spec Status | Justified? |
|---------------|-------------|------------|
| Phase 1: Fix 4 syntax errors | ✅ Included | ✅ Correct |
| Phase 2: Fix 3 import errors | Deferred to v3.0.3 | ⚠️ **Rationale unclear** |
| Document known issues | Partially done | ⚠️ Incomplete — no workarounds documented |

**Observation:** The proposal recommended a 3-phase approach. The spec adopts Phase 1 only. The rationale for deferring Phases 2-3 is "import structure issue" — this is vague. Why can't the import issue be fixed the same way as syntax errors?

### Tech Debt Proposal Alignment

| Proposal Item | Spec Status | Justified? |
|---------------|-------------|------------|
| Fix uninstall docs order | CA: "Already correct" | ✅ **Verified** — `Ontos_Manual.md:380-400` shows correct order |
| Delete duplicate Common_Concepts.md | CA: "Already resolved" | ✅ **Verified** — `find_by_name` returns 0 results |

---

## Part 3: Scope Boundary Check

### Items Marked "Already Fixed"

| Item | CA's Evidence | Sufficient? | My Verification |
|------|---------------|-------------|-----------------|
| Init subprocess issue | "init.py:104-145 uses native map_command()" | Code ref only | ✅ **CONFIRMED** — Code uses `from ontos.commands.map import map_command, MapOptions` |
| Map command | "cli.py:240-251 native implementation" | Code ref only | ✅ **CONFIRMED** — `_cmd_map()` calls `map_command()` directly |
| Common_Concepts | "Single copy exists" | No evidence | ✅ **CONFIRMED** — `find_by_name` search returns 0 files |
| Uninstall docs | "Frontmatter removal is step 1" | No evidence | ✅ **CONFIRMED** — Line 384-385 shows correct order |

**Finding:** All "already fixed" claims are accurate. However, CA provided code references only, not test evidence.

### Items Deferred to v3.0.3

| Item | Rationale Given | Rationale Sufficient? |
|------|-----------------|----------------------|
| `ontos verify` | "Import structure issue" | ❌ **Insufficient** — What specifically? |
| `ontos query` | "Import structure issue" | ❌ **Insufficient** — Same vague reason |
| `ontos consolidate` | "Import structure issue" | ❌ **Insufficient** — Same vague reason |

**Key Question:** The 4 syntax-error scripts were fixed with single-line insertions. Why can't the 3 import-error scripts receive equivalent treatment? The spec doesn't explain why `verify`/`query`/`consolidate` require architectural changes while `migrate`/`scaffold`/`promote`/`stub` don't.

**Investigation:** Looking at `cli.py:365-436`, the wrapper commands all use identical pattern: `subprocess.run()` with `env=_get_subprocess_env()`. The difference is likely in the *scripts themselves* — the deferred ones import from `ontos.core.*` which fails due to path resolution. But this explanation is not in the spec.

---

## Part 4: Unauthorized Changes Check

| Change | Authorized By | Notes |
|--------|---------------|-------|
| Dropped init.py rewrite | CA decision | ✅ **Authorized** — Init was already fixed, rewrite unnecessary |
| Dropped subprocess import removal | Not mentioned | ⚠️ **Oversight** — Minor, but proposal explicitly called for it |
| Changed scope from 6 files to 4 files | CA decision | ✅ **Partially Authorized** — 2 files (init changes) were already fixed |

**Finding:** No major unauthorized changes. The scope reduction is justified by prior fixes.

---

## Part 5: Known Issues Documentation

| Remaining Issue | Documented in Spec? | Workaround Provided? |
|-----------------|--------------------|--------------------|
| `ontos verify` broken | ✅ Listed (Section 5: "Broken v3.0.3") | ❌ None |
| `ontos query` broken | ✅ Listed | ❌ None |
| `ontos consolidate` broken | ✅ Listed | ❌ None |
| `.ontos.toml` ignored by legacy scripts | ❌ **Not documented** | ❌ None |

**Critical Finding:** The bug log explicitly shows a user struggling for 2+ hours because `.ontos.toml` settings were ignored. The spec:
1. Doesn't acknowledge this issue
2. Doesn't explain if it's fixed
3. Doesn't defer it
4. Doesn't document it as known issue

**Workaround from bug log (lines 297-306):** User created shim files (`ontos_config.py`, `ontos_config_defaults.py`) as workaround. This should be documented if not fixed.

---

## Part 6: Issues Found

### Critical (Alignment)

| # | Issue | Type | Evidence |
|---|-------|------|----------|
| A-C1 | `.ontos.toml` settings ignored by legacy scripts is not addressed | Bug Log Gap | Bug log lines 499-503: "The script uses a fixed docs path ignoring .ontos.toml" |

### Major (Alignment)

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-M1 | Deferred commands lack sufficient rationale | Proposal Gap | Add explicit explanation: what "import structure issue" means and why it requires v3.0.3 |
| A-M2 | No workarounds documented for broken commands | Known Issues Gap | Add Section 5.1 "Workarounds" or update Section 2.3 |
| A-M3 | Scope change from 6→4 files lacks paper trail | Documentation Gap | Add note: "2 files (init.py changes) were verified as already implemented" |

### Minor (Alignment)

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-m1 | Proposal's "remove subprocess import" not addressed | Proposal Drift | Either remove import or note it's intentionally kept |

---

## Part 7: Verdict

### Bug Log Alignment

| Status | Count |
|--------|-------|
| Issues addressed | 3/7 |
| Issues deferred with rationale | 3/7 |
| Issues missing | **1/7** |

### Proposal Alignment

| Proposal | Alignment |
|----------|-----------|
| Bug Fixes Plan | **Partially Aligned** — init changes already done, subprocess import not addressed |
| Legacy Proposal | **Partially Aligned** — Phase 1 only, rationale for deferral weak |
| Tech Debt Proposal | **Fully Aligned** — Both items verified as resolved |

---

## Recommendation: **Request Changes**

### Blocking Issues: **1**

| # | Issue | Resolution Required |
|---|-------|---------------------|
| A-C1 | `.ontos.toml` ignored | Either: (1) confirm this is fixed by existing changes, (2) add to v3.0.2 scope, or (3) explicitly defer to v3.0.3 with documented workaround |

### Non-Blocking Changes Requested

1. **Clarify deferral rationale:** Replace "Import structure issue" with specific technical reason (e.g., "These scripts import `ontos.core.*` which requires PYTHONPATH manipulation that the current `_get_subprocess_env()` doesn't handle for user-project contexts")

2. **Document workarounds:** Add to Section 5 or create Section 5.1:
   > **Known Issue Workaround:** For commands that remain broken in v3.0.2, users can create shim files in their project root. See [bug log] for details.

3. **Add scope reduction justification:** In Section 1 or 2:
   > The original Bug Fixes Plan proposed 6 file changes. Two (init.py context map generation) were verified as already implemented during v3.0.0.

---

## Appendix: Code Evidence

### A1: Init.py Uses Native Map (Verified)

```python
# init.py:104-145
def _generate_initial_context_map(root: Path, config) -> None:
    """Generate initial context map by running the map command.
    Non-fatal on failure - creates placeholder if native command fails.
    """
    try:
        from ontos.commands.map import map_command, MapOptions
        # ... native implementation
```

### A2: CLI Map Command Is Native (Verified)

```python
# cli.py:240-251
def _cmd_map(args) -> int:
    """Handle map command."""
    from ontos.commands.map import map_command, MapOptions
    options = MapOptions(...)
    return map_command(options)
```

### A3: Uninstall Docs Order Is Correct (Verified)

```markdown
# Ontos_Manual.md:384-391
# 1. Remove frontmatter FIRST (requires .ontos/ to exist)
python3 .ontos/scripts/ontos_remove_frontmatter.py --yes
# 2. Remove git hooks
rm -f .git/hooks/pre-push .git/hooks/pre-commit
# 3. Remove Ontos files
rm -rf .ontos/ .ontos.toml
```

### A4: Subprocess Env Sets PYTHONPATH (But Not User Project Root)

```python
# cli.py:19-32
def _get_subprocess_env() -> dict:
    env = os.environ.copy()
    project_root = str(Path(__file__).parent.parent)  # <-- Package root, NOT user project
    # ...
```

This is the root cause of the `.ontos.toml` issue: subprocess env uses *package* root, not *user project* root.

---

*End of Alignment Review*
