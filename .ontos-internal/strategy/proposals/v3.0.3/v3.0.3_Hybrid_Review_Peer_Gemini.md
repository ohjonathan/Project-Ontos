# v3.0.2 Hybrid Review: Peer Reviewer (Gemini)

**Version:** 1.0
**Date:** 2026-01-18
**Role:** Peer Reviewer
**Model:** Gemini 2.5 Pro
**Phase:** B+D Hybrid (Spec + Implementation Review)

---

## 1. Executive Summary

**Verdict:** **REQUEST REVISION**

The Chief Architect's claim that `ontos init` and `ontos map` are "already fixed" is **FACTUALLY INCORRECT**. Code inspection confirms both commands still rely on `subprocess.call` to invoke legacy scripts, which is the root cause of the `ModuleNotFoundError` observed in the bug log.

While the 4 syntax fixes for legacy scripts are correct and verified, releasing v3.0.2 with the current broken `init`/`map` implementation will not solve the user's primary issue.

---

## 2. "Already Fixed" Claims Verification

| Claim | CA Statement | My Verification | Verdict |
|-------|--------------|-----------------|---------|
| **Init uses native map_command** | "init.py:104-145 uses native map_command()" | **FALSE**. `ontos/commands/init.py` uses `subprocess.call` (lines 135-141). | ❌ **FAILED** |
| **ontos map works now (native)** | "cli.py:240-251 native implementation" | **FALSE**. `ontos/cli.py` uses `subprocess.call` to run `ontos._scripts...` (lines 249-253). | ❌ **FAILED** |
| **Common_Concepts duplicate** | "Single copy exists" | **TRUE**. Found only one instance in `.ontos-internal/reference`. | ✅ Verified |
| **Uninstall docs correct** | "Frontmatter removal is step 1" | **TRUE**. Docs correctly list removal step first. | ✅ Verified |

**Evidence (from codebase):**

`ontos/commands/init.py`:
```python
# Line 135
print("Generating initial context map...")
subprocess.call([sys.executable, "-m", "ontos", "map"])
```

`ontos/cli.py`:
```python
# Line 249
def _cmd_map(args):
    """Wrapper for map command."""
    # ...
    return subprocess.call([sys.executable, "-m", "ontos._scripts.ontos_generate_context_map"] + pass_args)
```

---

## 3. Confirmed Fixes Verification

I verified the 4 legacy scripts flagged for syntax errors.

| File | Issue | Fix Proposed | Verdict |
|------|-------|--------------|---------|
| `ontos_scaffold.py` | Empty `if` body (Line 28) | Add `sys.path.insert` | ✅ Verified |
| `ontos_stub.py` | Empty `if` body (Line 28) | Add `sys.path.insert` | ✅ Verified |
| `ontos_promote.py` | Empty `if` body (Line 28) | Add `sys.path.insert` | ✅ Verified |
| `ontos_migrate_schema.py` | Empty `if` body (Line 32) | Add `sys.path.insert` | ✅ Verified |

**Note:** These fixes are necessary but **insufficient** if the calling mechanism (`ontos map`) is still broken.

---

## 4. Bug Log Cross-Reference

The bug log (`20260116_bug-log.md`) highlights `ModuleNotFoundError` when running `ontos map`.
- **Cause:** `subprocess` call to legacy script fails to find `ontos_config` due to path/cwd issues.
- **Spec Claim:** "Works now" (native implementation).
- **Reality:** The code still uses the exact same `subprocess` mechanism that caused the failure. **The bug is NOT fixed.**

---

## 5. Critical Issues (Blocking Release)

| # | Issue | Severity | Description |
|---|-------|----------|-------------|
| **P-C1** | **False Claim: Native Init/Map** | **CRITICAL** | `init` and `map` commands are NOT native. They use `subprocess`, ensuring the bug log issues will persist in v3.0.2. |
| **P-C2** | **Broken User Experience** | **CRITICAL** | Users cannot run `ontos init` or `ontos map` successfully in the current state, rendering the tool unusable for new users. |

---

## 6. Recommendations

1.  **Retract "Already Fixed" Claims:** The Spec must acknowledge that `init` and `map` are currently wrapping legacy scripts via subprocess.
2.  **Scope Expansion (Required):** v3.0.2 MUST include the refactoring of `ontos/commands/init.py` and `ontos/commands/map.py` to use **native function calls** (importing `core` logic directly) instead of `subprocess`. This was the original intent of v3.0 and is necessary to fix the pathing bugs.
    *   *Alternative:* If native refactoring is too risky for a patch release, the `subprocess` calls MUST be fixed to correctly set `PYTHONPATH` and `cwd` to ensure the legacy scripts can find `ontos_config`.
3.  **Approve Syntax Fixes:** The 4 syntax fixes for legacy scripts should proceed, as they are correct.

**Final Verdict:** The implementation spec relies on false premises about the codebase state. It cannot be approved until the `init` and `map` commands are actually fixed.
