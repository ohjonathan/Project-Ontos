# v3.0.2 Hybrid Review: Adversarial Reviewer (Codex)

**Version:** 1.0  
**Date:** 2026-01-18  
**Role:** Adversarial Reviewer  
**Model:** Codex (OpenAI)  
**Phase:** B+D Hybrid (Spec + Implementation Review)

---

## 1. Your Role

You are the **Adversarial Reviewer**. Your job is to break things. Find edge cases, failure modes, and assumptions that might be wrong.

**Your mindset:** Skeptical. The CA says these are trivial single-line fixes with LOW risk. Prove them wrong.

---

## 2. Context

The spec proposes adding one line to each of 4 files:
```python
sys.path.insert(0, str(SCRIPTS_DIR))
```

This looks simple. But:
- Why was the line missing in the first place?
- What happens if `SCRIPTS_DIR` is wrong?
- What happens if something else is already at `sys.path[0]`?
- Does inserting at position 0 shadow something important?

---

## 3. Input Documents

| Document | Purpose |
|----------|---------|
| `v3.0.2_Implementation_Spec.md` | Fixes under attack |
| Ontos codebase | Your target |

---

## 4. Attack Instructions

### Attack 1: Path Injection

The fix inserts a path at `sys.path[0]`. What if that path contains malicious code?

```python
# The fix:
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))
```

**Test:**
```bash
ls -la ontos/_scripts/
python3 -c "import sys; print([m for m in sys.modules if 'ontos' in m])"
python3 -c "from ontos._scripts.ontos_config_defaults import *; print(dir())"
```

| Attack | Applicable? | Risk Level | Notes |
|--------|-------------|------------|-------|
| `__file__` manipulation | No | Low | No evidence of `__file__` manipulation in test runs. |
| Path shadowing stdlib | Yes | Medium | `sys.path.insert(0, ...)` can shadow stdlib if future files collide. No stdlib collisions observed now. |
| Malicious module in `SCRIPTS_DIR` | Yes | Medium | `ontos/_scripts` contains executable modules; inserting at index 0 trusts that directory before stdlib. |
| Path shadowing *package* `ontos` | **Yes** | **High** | `ontos/_scripts/ontos.py` exists; inserting scripts dir at index 0 can shadow the package `ontos` during `import ontos.core`, causing `ModuleNotFoundError`. |

---

### Attack 2: Order of Operations

**Test:**
```bash
python3 -c "
from pathlib import Path
p = Path('ontos/_scripts')
print('Absolute:', p.resolve())
print('Str:', str(p))
print('In sys.path check:', str(p) in ['ontos/_scripts'])
"

python3 -c "
import sys
print('Before:', len(sys.path))
from pathlib import Path
SCRIPTS_DIR = Path('ontos/_scripts').resolve()
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))
print('After:', len(sys.path))
print('Duplicates?', sys.path.count(str(SCRIPTS_DIR)))
"
```

| Attack | Applicable? | Risk Level | Notes |
|--------|-------------|------------|-------|
| Stale import state | Yes | Medium | `sys.path` mutation happens before imports; if `ontos` package is not loaded, path shadowing occurs. |
| Path form mismatch | Yes | Low | `Path(__file__).parent` is absolute but comparisons are string-based; symlink/relative mismatch could bypass the guard. |
| Duplicate insertions | No | Low | Guard prevents duplication in simple test (count=1). |

---

### Attack 3: The Fix Doesn't Match the Bug

Bug log shows:
```
ModuleNotFoundError: No module named 'ontos_config'
```

**Test:**
```bash
rg "from ontos_config" ontos/_scripts/ontos_scaffold.py
rg "from ontos_config" ontos/_scripts/ontos_stub.py
rg "from ontos_config" ontos/_scripts/ontos_promote.py
rg "from ontos_config" ontos/_scripts/ontos_migrate_schema.py
ls ontos/_scripts/ontos_config*.py
```

| Attack | Applicable? | Risk Level | Notes |
|--------|-------------|------------|-------|
| Wrong module being fixed | **Yes** | **High** | Current runtime failure is `ModuleNotFoundError: No module named 'ontos.core'` after inserting `SCRIPTS_DIR`; fixing `ontos_config_defaults` does not address this. |
| Both configs needed | Yes | Medium | `ontos_config.py` exists; multiple scripts import `ontos_config` as well as defaults, so a fix only addressing defaults is incomplete. |
| Fix incomplete | **Yes** | **High** | Actual errors observed in runtime are unrelated to the original IndentationError once the insertion is added. |

---

### Attack 4: Working Directory Assumptions

**Test:**
```bash
cd /tmp && python3 -m ontos scaffold --help
cd ~ && python3 -m ontos scaffold --help
cd /var && python3 -m ontos scaffold --help 2>&1 | head -5
```

| Attack | Applicable? | Risk Level | Notes |
|--------|-------------|------------|-------|
| Breaks from non-project dir | No | Low | Help output works from `/tmp`, home, and `/var`. |
| Assumes `.ontos` exists | Unclear | Medium | Actual command execution crashes before repo detection due to import error. |
| Assumes git repo | Unclear | Medium | Same as above; cannot test behavior due to early crash. |

---

### Attack 5: Regression in Working Commands

**Test:**
```bash
python3 -m ontos doctor
python3 -m ontos map --help
python3 -m ontos init --help
rg -r "from ontos._scripts" ontos/commands/
```

**Observed runtime failure (post-insertion):**
```bash
python3 -m ontos scaffold
python3 -m ontos stub
python3 -m ontos promote
python3 -m ontos migrate
```

| Attack | Applicable? | Risk Level | Notes |
|--------|-------------|------------|-------|
| Shared imports affected | **Yes** | **Critical** | All four fixed commands fail at runtime with `ModuleNotFoundError: No module named 'ontos.core'; 'ontos' is not a package`. |
| sys.path pollution | **Yes** | **High** | `sys.path.insert(0, ...)` causes `ontos/_scripts/ontos.py` to shadow the package `ontos`. |
| Config state leakage | Yes | Medium | Script-level imports run at module import time; path mutation can affect other imports in the process. |

---

### Attack 6: The "Deferred" Commands

**Test:**
```bash
python3 -m ontos verify --help 2>&1
python3 -m ontos query --help 2>&1
python3 -m ontos consolidate --help 2>&1

python3 -m ontos query "test" 2>&1
python3 -m ontos verify 2>&1
python3 -m ontos consolidate 2>&1

head -40 ontos/_scripts/ontos_verify.py
rg -l "if str(SCRIPTS_DIR) not in sys.path:" ontos/_scripts/ontos_*.py
```

| Attack | Applicable? | Risk Level | Notes |
|--------|-------------|------------|-------|
| Same bug, not fixed | **Yes** | **High** | `verify`, `query`, and `consolidate` fail with the same `ModuleNotFoundError: No module named 'ontos.core'` root cause. |
| Different bug | No | Low | Failures are consistent with the same path shadowing issue. |
| Arbitrary scope boundary | **Yes** | Medium | Limiting fixes to 4 scripts ignores the broader import shadowing problem. |

---

### Attack 7: Edge Case Inputs

**Test:**
```bash
python3 -m ontos scaffold
python3 -m ontos stub
python3 -m ontos promote
python3 -m ontos migrate
```

| Input | Command | Result | Issue? |
|-------|---------|--------|--------|
| No args | scaffold | Fails before arg parsing | Yes — import crash |
| No args | stub | Fails before arg parsing | Yes — import crash |
| No args | promote | Fails before arg parsing | Yes — import crash |
| No args | migrate | Fails before arg parsing | Yes — import crash |

---

### Part 5: Assumption Audit

| Assumption | Evidence | Could Be Wrong? | Impact If Wrong |
|------------|----------|-----------------|-----------------|
| Single-line fix is complete | Spec says so | **Yes** | Root cause appears to be path shadowing; fix breaks runtime. |
| `SCRIPTS_DIR` is always valid | Uses `Path(__file__).parent` | **Yes** | Valid but unsafe at `sys.path[0]` due to `ontos.py` shadowing package. |
| No circular imports | Not checked | **Yes** | `ontos` module shadowing masks package imports. |
| Order of `sys.path` doesn't matter | Inserts at position 0 | **Yes** | Breaks `import ontos.core` by shadowing package with `ontos.py`. |
| Scripts are only run via CLI | Not stated | **Yes** | Direct script use would be even more fragile. |

---

### Part 6: Blind Spot Identification

**What's the CA not seeing?**
1. `ontos/_scripts/ontos.py` shadows the package `ontos` when `SCRIPTS_DIR` is inserted at index 0.
2. Runtime execution fails even though `--help` works, so the testing plan misses the failure.
3. Root cause affects more than 4 scripts; limiting scope is arbitrary and unsafe.

**What seems too simple?**
- The change assumes import order is harmless, but it redefines the module resolution root and breaks package imports.

**What's conspicuously absent?**
- No runtime CLI execution tests (only `py_compile`/`--help`).
- No rollback plan for new import-order regressions.
- No monitoring strategy for CLI failures in the field.

---

### Part 7: Issues Found

**Critical (Blocks Release):**
| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-C1 | `sys.path.insert(0, SCRIPTS_DIR)` shadows package `ontos` with `ontos/_scripts/ontos.py`, causing `ModuleNotFoundError: No module named 'ontos.core'` for `scaffold/stub/promote/migrate` | Attack 5 (runtime CLI execution) | Commands fail at runtime; release-blocking regression |

**High (Security/Stability):**
| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-H1 | Same shadowing root cause breaks deferred `verify/query/consolidate` | Attack 6 (runtime CLI execution) | Deferred commands still fail; scope boundary is unsafe |
| X-H2 | Fix addresses `ontos_config_defaults` but runtime errors are now in `ontos.core` imports | Attack 3 | Fix does not solve reported error and introduces a new failure mode |

**Medium (Should Consider):**
| # | Issue | Attack Vector | Recommendation |
|---|-------|---------------|----------------|
| X-M1 | `sys.path` insertion at index 0 increases risk of module shadowing and injection | Attack 1 | Insert after package root or use explicit `from ontos._scripts...` imports |
| X-M2 | Guard uses string equality; symlink/relative mismatch may insert duplicates | Attack 2 | Normalize with `resolve()` and compare against normalized sys.path |

---

### Part 8: Verdict

**Spec Robustness:** Fragile

**Risk Assessment Override:**
- CA says: LOW
- You say: **HIGH**
- Reasoning: The change introduces a deterministic runtime failure in the very commands it intends to fix, and it does not address the broader import shadowing problem.

**Top 3 Concerns:**
1. `sys.path.insert(0, ...)` shadows package `ontos` due to `ontos/_scripts/ontos.py`, breaking imports.
2. Runtime CLI execution fails even though `--help` passes, so the test plan misses the failure.
3. The issue is systemic across scripts, not limited to the 4 files in scope.

**Recommendation:** Request Changes

