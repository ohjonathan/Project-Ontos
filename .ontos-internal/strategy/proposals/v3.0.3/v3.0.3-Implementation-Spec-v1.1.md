---
id: v3_0_2_implementation_spec_v1_1
type: spec
status: complete
depends_on: [v3_0_2_implementation_spec, v3_0_2_chief_architect_response]
concepts: [implementation-spec, patch-release, sys-path-fix, cli-remediation]
---

# v3.0.2 Implementation Spec v1.1

**Version:** 1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-18
**Status:** Verified - Ready for Release
**Previous Version:** [v3.0.2 Implementation Spec v1.0](v3.0.2_Implementation_Spec.md)

---

## 1. Executive Summary

This is a **minimal scope** patch release that was implemented in commit `c00165f`. The fix addresses `sys.path` shadowing issues in 4 legacy wrapper scripts.

| Category | Count | Status |
|----------|-------|--------|
| Already Fixed (init/map native) | 2 | Verified - no action needed |
| sys.path Shadowing Fix | 4 | **IMPLEMENTED** (c00165f) |
| Deferred to v3.0.3 | 3 | Documented with rationale |

**Scope Clarification:** Original proposals mentioned 6 files; scope reduced to 4 because `init.py` and `cli.py` already use native implementations (not subprocess calls).

---

## 2. Verification Summary

### 2.1 Issues ALREADY RESOLVED (No Fix Needed)

| Issue | Proposal Claim | Verification | Evidence |
|-------|----------------|--------------|----------|
| Init uses subprocess | "Fix needed" | **ALREADY FIXED** | `init.py:104-145` uses native `map_command()` |
| `ontos map` broken | "ModuleNotFoundError" | **WORKS NOW** | `cli.py:240-251` native implementation |
| Common_Concepts duplicate | "Tech debt" | **RESOLVED** | Single copy exists |
| Uninstall docs wrong | "Frontmatter after delete" | **CORRECT** | Frontmatter removal is step 1 |

### 2.2 Issues FIXED in v3.0.2 (Commit c00165f)

4 legacy scripts had `sys.path` configuration that caused the `ontos/_scripts/ontos.py` file to shadow the `ontos` package, resulting in `ModuleNotFoundError: No module named 'ontos.core'`.

**Root Cause:** Python auto-inserts the script directory at `sys.path[0]`. The file `ontos/_scripts/ontos.py` was then found before the `ontos/` package, causing import failures.

**Fix Pattern:** Remove scripts directory from `sys.path[0]`, import `ontos` package modules, then append scripts directory for local imports.

### 2.3 Issues DEFERRED to v3.0.3

| Command | Error | Technical Rationale |
|---------|-------|---------------------|
| `ontos verify` | ModuleNotFoundError | Deep dependency on `ontos.core.frontmatter` validation functions with circular import pattern. Requires refactoring module boundaries. |
| `ontos query` | ModuleNotFoundError | Uses `ontos.core.schema` traversal functions that assume package-level initialization completed. |
| `ontos consolidate` | ModuleNotFoundError | Combines frontmatter parsing and schema operations in ways that expose import order sensitivity. |

**v3.0.3 Plan:** These commands will be migrated to native implementations following the pattern established by `map`, `agents`, and `doctor`.

---

## 3. Exact Code Changes (REVISED)

The original spec proposed `sys.path.insert(0, str(SCRIPTS_DIR))`. The actual implementation uses a safer approach that prevents package shadowing.

### 3.1 Fix Pattern (Applied to All 4 Scripts)

```python
# Fix sys.path to avoid ontos.py shadowing the ontos package.
# Python auto-inserts script dir at sys.path[0]; remove it before importing ontos.
SCRIPTS_DIR = Path(__file__).parent.resolve()
if sys.path and Path(sys.path[0]).resolve() == SCRIPTS_DIR:
    sys.path.pop(0)

# Import ontos package BEFORE adding scripts dir back to path
from ontos.core.context import SessionContext
from ontos.core.frontmatter import parse_frontmatter
# ... other ontos.* imports

# Now add scripts dir to import ontos_config_defaults
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.append(str(SCRIPTS_DIR))
from ontos_config_defaults import PROJECT_ROOT
```

### 3.2 Files Modified

| File | Change Summary |
|------|----------------|
| `ontos/_scripts/ontos_scaffold.py` | Lines 25-46: sys.path fix with pop/import/append pattern |
| `ontos/_scripts/ontos_stub.py` | Lines 25-46: sys.path fix with pop/import/append pattern |
| `ontos/_scripts/ontos_promote.py` | Lines 25-46: sys.path fix with pop/import/append pattern |
| `ontos/_scripts/ontos_migrate_schema.py` | Lines 25-46: sys.path fix with pop/import/append pattern |

### 3.3 Key Differences from Spec v1.0

| Aspect | Spec v1.0 | Spec v1.1 (Implemented) |
|--------|-----------|-------------------------|
| Path handling | String comparison | `Path().resolve()` for symlink handling |
| Insert position | `insert(0, ...)` | `pop(0)` then `append()` |
| Import order | Not specified | Explicit: ontos package first, then local |

---

## 4. Verification Protocol (ENHANCED)

### 4.1 Syntax Check (Must Pass)

```bash
python3 -m py_compile ontos/_scripts/ontos_scaffold.py && echo "scaffold: OK"
python3 -m py_compile ontos/_scripts/ontos_stub.py && echo "stub: OK"
python3 -m py_compile ontos/_scripts/ontos_promote.py && echo "promote: OK"
python3 -m py_compile ontos/_scripts/ontos_migrate_schema.py && echo "migrate: OK"
```

### 4.2 CLI Help Check (Must Show Help)

```bash
python3 -m ontos scaffold --help
python3 -m ontos stub --help
python3 -m ontos promote --help
python3 -m ontos migrate --help
```

### 4.3 Runtime Execution Test (NEW - Must Not Raise ModuleNotFoundError)

```bash
# Verify imports succeed (the actual commands may require project context)
python3 -c "
import sys
from pathlib import Path

# Simulate direct script execution
script_dir = Path('ontos/_scripts').resolve()
sys.path.insert(0, str(script_dir))

# This import pattern should NOT raise ModuleNotFoundError
try:
    # Temporarily execute scaffold's import sequence
    exec(open('ontos/_scripts/ontos_scaffold.py').read().split('def ')[0])
    print('scaffold: imports OK')
except ModuleNotFoundError as e:
    print(f'scaffold: FAILED - {e}')
    exit(1)
"
```

### 4.4 Regression Check

```bash
python3 -m ontos --version       # 3.0.2
python3 -m ontos doctor          # Should pass
python3 -m ontos map --help      # Works (native)
python3 -m ontos init --help     # Works (native)
pytest tests/ -v --ignore=tests/golden/
```

---

## 5. Known Issues (NEW SECTION)

### 5.1 `.ontos.toml` Settings Ignored by Legacy Scripts

**Description:** Legacy wrapper commands (`scaffold`, `stub`, `promote`, `migrate`) do not read project-specific settings from `.ontos.toml`. They use hardcoded defaults from `ontos_config_defaults.py`.

**Affected Commands:**
- `ontos scaffold`
- `ontos stub`
- `ontos promote`
- `ontos migrate`

**Not Affected:** Native commands (`init`, `map`, `doctor`, `agents`, `log`, `hook`) correctly read `.ontos.toml`.

**Workaround:** Use the CLI wrapper which sets proper environment:
```bash
# Instead of direct script execution:
python3 ontos/_scripts/ontos_scaffold.py --apply

# Use the CLI:
python3 -m ontos scaffold --apply
```

**Fix Timeline:** Scheduled for v3.0.3 when these commands are migrated to native implementations.

### 5.2 Commands Deferred to v3.0.3

The following commands are known to fail with `ModuleNotFoundError`:
- `ontos verify`
- `ontos query`
- `ontos consolidate`

These require architectural changes to resolve circular import dependencies.

---

## 6. Command Status After v3.0.2

| Command | Status | Implementation |
|---------|--------|----------------|
| `ontos init` | ✅ Working | Native (`ontos/commands/init.py`) |
| `ontos map` | ✅ Working | Native (`ontos/commands/map.py`) |
| `ontos doctor` | ✅ Working | Native (`ontos/commands/doctor.py`) |
| `ontos agents` | ✅ Working | Native (`ontos/commands/agents.py`) |
| `ontos log` | ✅ Working | Native (`ontos/commands/log.py`) |
| `ontos hook` | ✅ Working | Native (`ontos/commands/hook.py`) |
| `ontos scaffold` | ✅ **FIXED** | Wrapper (sys.path fix applied) |
| `ontos stub` | ✅ **FIXED** | Wrapper (sys.path fix applied) |
| `ontos promote` | ✅ **FIXED** | Wrapper (sys.path fix applied) |
| `ontos migrate` | ✅ **FIXED** | Wrapper (sys.path fix applied) |
| `ontos verify` | ❌ Broken | Deferred to v3.0.3 |
| `ontos query` | ❌ Broken | Deferred to v3.0.3 |
| `ontos consolidate` | ❌ Broken | Deferred to v3.0.3 |

---

## 7. Implementation Checklist

- [x] Apply sys.path fix to `ontos/_scripts/ontos_scaffold.py`
- [x] Apply sys.path fix to `ontos/_scripts/ontos_stub.py`
- [x] Apply sys.path fix to `ontos/_scripts/ontos_promote.py`
- [x] Apply sys.path fix to `ontos/_scripts/ontos_migrate_schema.py`
- [x] Run py_compile on all 4 files (passed)
- [x] Run CLI help on all 4 commands (passed)
- [x] Run test suite (passed)
- [x] Commit: `c00165f` - "fix(scripts): Fix sys.path to avoid ontos.py package shadowing"
- [x] Update CHANGELOG.md with known issues
- [ ] Tag release v3.0.2

---

## 8. Critical Files

| File | Purpose | Status |
|------|---------|--------|
| `ontos/_scripts/ontos_scaffold.py` | Legacy scaffold command | Fixed |
| `ontos/_scripts/ontos_stub.py` | Legacy stub command | Fixed |
| `ontos/_scripts/ontos_promote.py` | Legacy promote command | Fixed |
| `ontos/_scripts/ontos_migrate_schema.py` | Legacy migrate command | Fixed |
| `ontos/_scripts/ontos.py` | Entry point (causes shadowing) | Documented |
| `ontos/commands/init.py` | Native init (evidence) | Verified native |
| `ontos/cli.py` | Native CLI (evidence) | Verified native |

---

## 9. Changelog from v1.0

| Section | Change Description |
|---------|-------------------|
| 1. Executive Summary | Added scope clarification (6→4 files explained) |
| 2.3 Deferred Issues | Added technical rationale for each deferred command (NB1) |
| 3. Code Changes | REVISED to match actual implementation (pop/append vs insert) |
| 4. Verification | ENHANCED with runtime execution tests beyond syntax/help |
| 5. Known Issues | NEW SECTION documenting .ontos.toml limitation and workarounds |
| 7. Checklist | Updated with actual commit reference |
| 8. Critical Files | Added `ontos.py` as documented shadowing source |
| 9. Changelog | NEW SECTION for version tracking |

---

## 10. Risk Assessment

**Overall Risk: LOW** ✅

| Factor | Assessment |
|--------|------------|
| Change scope | 4 files, isolated to legacy scripts |
| Pattern safety | Uses standard Python path manipulation |
| Regression risk | Native commands unaffected |
| Rollback path | Simple revert of commit c00165f |

---

*End of Spec v1.1*
