# v3.0.2 CLI Bug Fixes: Comprehensive Remediation Plan

**Release:** v3.0.2 (Bug Patch & Tech Debt Reduction)
**Related:** `v3.0.2_CLI_Legacy_Remediation_Proposal.md`
**Priority:** P0 - Critical (blocks fresh project initialization and multiple CLI commands)

---

## Overview

Based on debugging session and codebase investigation, v3.0.2 needs to fix:

| Issue | Command(s) | Error Type | Status |
|-------|-----------|------------|--------|
| Init uses subprocess for map | `init` | ModuleNotFoundError | Fix needed |
| 4 legacy scripts missing if-body | `migrate`, `scaffold`, `promote`, `stub` | IndentationError | Fix needed |
| 3 legacy scripts import errors | `verify`, `query`, `consolidate` | ModuleNotFoundError | Deferred to v3.0.3 |

**Note:** `ontos map` is already fixed - it uses native `map_command()` in `cli.py:240-251`.

---

## Problem 1: `ontos init` ModuleNotFoundError

`ontos init` fails with:
```
ModuleNotFoundError: No module named 'ontos_config'
```

**Root cause:** `_generate_initial_context_map()` in `init.py` uses subprocess to call the legacy script `ontos/_scripts/ontos_generate_context_map.py`. That script has a hard import `from ontos_config import (...)` which fails when running in the user's project directory because `ontos_config.py` isn't in sys.path.

**Note:** The CLI Legacy Remediation Proposal marks `init` as "Working/Native" but this internal function still relies on legacy subprocess pattern.

---

## Problem 2: 4 Legacy Scripts with Syntax Errors

Four legacy scripts have IndentationError due to missing `if` body:

```python
# Current (broken):
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
                                      # <- Empty body
from ontos_config_defaults import ...  # IndentationError here
```

**Affected files:**
- `ontos/_scripts/ontos_scaffold.py` lines 27-28
- `ontos/_scripts/ontos_stub.py` lines 27-28
- `ontos/_scripts/ontos_promote.py` lines 27-28
- `ontos/_scripts/ontos_migrate_schema.py` lines 31-32

---

## Solution

### For Problem 1 (init):
Replace subprocess call with direct `map_command()` call - matching the pattern already used by:
- `_cmd_map()` in `cli.py:240-251`
- `_generate_agents_file()` in `init.py:137-162`

### For Problem 2 (syntax errors):
Add the missing `sys.path.insert()` statement to fix the IndentationError:
```python
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))  # Add this line
```

---

## Files to Modify

### File 1: `ontos/commands/init.py`

**Change 1:** Replace `_generate_initial_context_map()` function (lines 105-134):

```python
def _generate_initial_context_map(root: Path, config) -> None:
    """Generate initial context map by running the map command.

    Non-fatal on failure - creates placeholder if native command fails.
    """
    try:
        from ontos.commands.map import map_command, MapOptions

        # Save current working directory and change to project root
        import os
        original_cwd = os.getcwd()
        try:
            os.chdir(str(root))

            options = MapOptions(
                output=root / config.paths.context_map,
                strict=False,
                json_output=False,
                quiet=True,  # Suppress verbose output during init
            )
            exit_code = map_command(options)

            if exit_code == 0:
                print("   ✓ Context map generated", file=sys.stderr)
            else:
                print(f"Warning: Context map generation returned code {exit_code}", file=sys.stderr)
        finally:
            os.chdir(original_cwd)

    except Exception as e:
        # Fallback: create a minimal context map placeholder
        print(f"Warning: Could not generate context map: {e}", file=sys.stderr)
        try:
            context_map_path = root / config.paths.context_map
            if not context_map_path.exists():
                context_map_path.write_text(
                    "# Ontos Context Map\n\n"
                    "> Run `ontos map` to generate the full context map.\n"
                )
                print("   ✓ Created placeholder context map", file=sys.stderr)
        except Exception as fallback_error:
            print(f"Warning: Could not create placeholder: {fallback_error}", file=sys.stderr)
```

**Change 2:** Remove unused `subprocess` import (line 5)

---

### File 2: `ontos/_scripts/ontos_scaffold.py`

**Change:** Add missing if-body at lines 27-28

**Before:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:

from ontos_config_defaults import PROJECT_ROOT
```

**After:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos_config_defaults import PROJECT_ROOT
```

---

### File 3: `ontos/_scripts/ontos_stub.py`

**Change:** Add missing if-body at lines 27-28 (same pattern as scaffold)

---

### File 4: `ontos/_scripts/ontos_promote.py`

**Change:** Add missing if-body at lines 27-28 (same pattern as scaffold)

---

### File 5: `ontos/_scripts/ontos_migrate_schema.py`

**Change:** Add missing if-body at lines 31-32 (same pattern as scaffold)

---

## Verification

### 1. Unit tests for init:
```bash
pytest tests/commands/test_init_phase3.py -v
```

### 2. Manual test (fresh project):
```bash
cd /tmp && rm -rf test-ontos && mkdir test-ontos && cd test-ontos
git init
python3 -m ontos init
# Should succeed without ModuleNotFoundError
cat Ontos_Context_Map.md
```

### 3. Verify map still works standalone:
```bash
python3 -m ontos map
```

### 4. Verify fixed legacy commands parse:
```bash
# These should show help text, not IndentationError
python3 -m ontos scaffold --help
python3 -m ontos stub --help
python3 -m ontos promote --help
python3 -m ontos migrate --help
```

---

## Summary of Changes

| File | Change | Lines |
|------|--------|-------|
| `ontos/commands/init.py` | Replace subprocess with native `map_command()` | 105-134 |
| `ontos/commands/init.py` | Remove unused `subprocess` import | 5 |
| `ontos/_scripts/ontos_scaffold.py` | Add `sys.path.insert(0, str(SCRIPTS_DIR))` | 28 |
| `ontos/_scripts/ontos_stub.py` | Add `sys.path.insert(0, str(SCRIPTS_DIR))` | 28 |
| `ontos/_scripts/ontos_promote.py` | Add `sys.path.insert(0, str(SCRIPTS_DIR))` | 28 |
| `ontos/_scripts/ontos_migrate_schema.py` | Add `sys.path.insert(0, str(SCRIPTS_DIR))` | 32 |

**Total: 6 files modified**
