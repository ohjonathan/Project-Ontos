---
id: v3_0_2_cli_legacy_remediation
type: strategy
status: draft
depends_on: [v3_0_technical_architecture, v3_0_0_implementation_specs]
concepts: [cli, legacy-scripts, subprocess, syntax-errors, imports, v3-transition, technical-debt]
---

# LLM Board Briefing: v3.0.2 CLI Legacy Script Remediation

**To:** LLM Board Advisors (Claude, Codex, Gemini)
**From:** Technical Analysis Team
**Date:** 2026-01-18
**Subject:** Multiple CLI commands fail due to legacy script issues - Remediation Proposal

---

## 1. Executive Summary

**Situation:** Seven `ontos` CLI commands fail when invoked due to issues in the legacy `_scripts/` directory. These commands use a wrapper pattern that spawns Python subprocesses to execute legacy scripts, but the scripts contain syntax errors and import resolution failures.

**Impact:**
- 7 of 13 CLI commands are non-functional
- User experience severely degraded
- Installation verification fails
- CI/CD pipelines cannot rely on full CLI functionality

**Root Causes:**
1. **Syntax Errors:** Four scripts have incomplete `if` statements (missing body)
2. **Import Failures:** Subprocess execution breaks Python package resolution
3. **Config Dependencies:** Scripts expect user-created config files that may not exist

**Recommendation:** Hybrid approach - immediate syntax fixes for v3.0.2, with native command migration planned for v3.1.

---

## 2. Current State Analysis

### 2.1 Command Status Overview

| Command | Status | Implementation | Error Type |
|---------|--------|----------------|------------|
| `init` | Working | Native | - |
| `map` | Working | Native (just fixed) | - |
| `log` | Working | Native (just fixed) | - |
| `doctor` | Working | Native | - |
| `agents` | Working | Native | - |
| `hook` | Working | Native | - |
| `export` | Deprecated | Alias for agents | - |
| `verify` | **FAILS** | Wrapper → legacy | ModuleNotFoundError |
| `query` | **FAILS** | Wrapper → legacy | ModuleNotFoundError |
| `consolidate` | **FAILS** | Wrapper → legacy | ModuleNotFoundError |
| `migrate` | **FAILS** | Wrapper → legacy | IndentationError |
| `scaffold` | **FAILS** | Wrapper → legacy | IndentationError |
| `promote` | **FAILS** | Wrapper → legacy | IndentationError |
| `stub` | **FAILS** | Wrapper → legacy | IndentationError |

### 2.2 Architecture Pattern

The v3.0 CLI uses two implementation patterns:

**Native Commands (Working):**
```
ontos <command> → ontos/commands/<command>.py → *_command() function
```

**Legacy Wrapper Commands (Failing):**
```
ontos <command> → ontos/commands/<command>.py → subprocess.run() → ontos/_scripts/ontos_<command>.py
```

---

## 3. Root Cause Analysis

### 3.1 Issue Category 1: Syntax Errors (IndentationError)

Four legacy scripts contain malformed `if` statements where the body is missing:

```python
# Current (broken):
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
                                      # <- Empty body - IndentationError
from ontos_config_defaults import ...

# Expected:
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))  # <- Body required

from ontos_config_defaults import ...
```

**Affected Scripts:**
| Script | Location | Line Numbers |
|--------|----------|--------------|
| `ontos_scaffold.py` | `ontos/_scripts/` | 27-28 |
| `ontos_stub.py` | `ontos/_scripts/` | 27-28 |
| `ontos_promote.py` | `ontos/_scripts/` | 27-28 |
| `ontos_migrate_schema.py` | `ontos/_scripts/` | 31-32 |

### 3.2 Issue Category 2: Module Import Errors (ModuleNotFoundError)

When legacy scripts execute via `subprocess.run()`, Python cannot resolve the `ontos` package:

```
ModuleNotFoundError: No module named 'ontos.core'; 'ontos' is not a package
```

**Root Cause:** The subprocess inherits PATH but not the installed package context. Scripts attempt to import from `ontos.core` but Python finds the `ontos/` directory (a folder) before finding the installed package.

**Affected Commands:** `verify`, `query`, `consolidate`

### 3.3 Issue Category 3: Config File Dependencies

Legacy scripts import from `ontos_config`:
```python
from ontos_config import PROJECT_ROOT, ONTOS_DIR, ...
```

This module expects a user-created `ontos_config.py` file that may not exist after fresh installation.

---

## 4. Remediation Options

### Option A: Quick Fix (Syntax Errors Only)

Fix the immediate syntax errors by adding the missing `sys.path.insert()` statements.

**Changes Required:**

For each of the 4 affected files, change:
```python
if str(SCRIPTS_DIR) not in sys.path:

from ontos_config_defaults import ...
```

To:
```python
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos_config_defaults import ...
```

| Metric | Value |
|--------|-------|
| **Files Modified** | 4 |
| **Lines Changed** | 4 (1 per file) |
| **Risk Level** | Low |
| **Commands Fixed** | `migrate`, `scaffold`, `promote`, `stub` |
| **Commands Still Broken** | `verify`, `query`, `consolidate` |

**Pros:**
- Minimal change footprint
- Low regression risk
- Fast to implement and test

**Cons:**
- Only fixes 4 of 7 broken commands
- Doesn't address ModuleNotFoundError issues
- Technical debt remains

### Option B: Full Legacy Script Repair

Fix syntax errors AND resolve import issues in all legacy scripts.

**Additional Changes Required:**
1. Fix syntax errors (same as Option A)
2. Modify subprocess invocation to set `PYTHONPATH` correctly
3. Add fallback config loading when `ontos_config.py` doesn't exist

**Implementation:**

```python
# In wrapper commands (verify.py, query.py, consolidate.py):
import os
env = os.environ.copy()
env['PYTHONPATH'] = str(Path(__file__).parent.parent.parent)
subprocess.run([sys.executable, script_path, ...], env=env)
```

| Metric | Value |
|--------|-------|
| **Files Modified** | 7-10 |
| **Lines Changed** | ~50 |
| **Risk Level** | Medium |
| **Commands Fixed** | All 7 broken commands |

**Pros:**
- All commands functional
- No architectural changes needed
- Preserves existing test coverage

**Cons:**
- Still maintains fragile subprocess architecture
- Technical debt persists
- Future maintenance burden

### Option C: Native Command Migration

Migrate all failing commands to native implementations following the pattern established for `map` and `log`.

**Implementation Pattern:**
```python
# ontos/commands/verify.py (native version)
from ontos.core.document import Document
from ontos.core.config import get_project_config

def verify_command(paths: list[str], fix: bool = False) -> int:
    """Native verification - no subprocess."""
    config = get_project_config()
    # ... implementation
    return 0
```

| Metric | Value |
|--------|-------|
| **Files Modified** | 7 command files + shared utilities |
| **Lines Changed** | ~500-800 |
| **Risk Level** | Medium-High |
| **Commands Fixed** | All 7 broken commands |

**Pros:**
- Clean architecture aligned with v3.0 design
- No subprocess fragility
- Proper error handling and testing
- Eliminates legacy script dependency

**Cons:**
- Significant development effort
- Higher regression risk
- Requires new test coverage

---

## 5. Recommendation: Hybrid Approach

We recommend a phased approach combining immediate fixes with planned migration:

### Phase 1: v3.0.2 Release (Immediate)

**Scope:** Option A - Fix syntax errors only

**Rationale:**
- Restores 4 commands (`migrate`, `scaffold`, `promote`, `stub`)
- Minimal risk for patch release
- Demonstrates progress to users

**Deliverables:**
1. Fix 4 syntax errors in legacy scripts
2. Add regression tests for fixed commands
3. Update CHANGELOG
4. Document known issues for remaining 3 commands

### Phase 2: v3.0.3 Release (Short-term)

**Scope:** Option B - Full legacy repair

**Rationale:**
- Restores remaining 3 commands (`verify`, `query`, `consolidate`)
- Buys time for proper native migration

**Deliverables:**
1. Fix subprocess environment issues
2. Add PYTHONPATH handling to wrapper commands
3. Full CLI command verification

### Phase 3: v3.1.0 Release (Medium-term)

**Scope:** Option C - Native migration

**Rationale:**
- Aligns with v3.0 architecture vision
- Eliminates technical debt
- Enables new features (streaming output, progress bars, etc.)

**Deliverables:**
1. Native implementations for all 7 wrapper commands
2. Deprecate `_scripts/` directory
3. Comprehensive test suite
4. Performance benchmarks

---

## 6. Implementation Plan (Phase 1)

### 6.1 Files to Modify

| File | Change |
|------|--------|
| `ontos/_scripts/ontos_scaffold.py` | Line 27-28: Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
| `ontos/_scripts/ontos_stub.py` | Line 27-28: Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
| `ontos/_scripts/ontos_promote.py` | Line 27-28: Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
| `ontos/_scripts/ontos_migrate_schema.py` | Line 31-32: Add `sys.path.insert(0, str(SCRIPTS_DIR))` |

### 6.2 Exact Code Changes

**Before (all 4 files have similar pattern):**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:

from ontos_config_defaults import ONTOS_DIR, ...
```

**After:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos_config_defaults import ONTOS_DIR, ...
```

### 6.3 Verification Steps

1. Run `ontos scaffold --help` - should show help text
2. Run `ontos stub --help` - should show help text
3. Run `ontos promote --help` - should show help text
4. Run `ontos migrate --help` - should show help text
5. Run full test suite: `pytest tests/`
6. Run CLI integration tests: `pytest tests/test_cli*.py`

---

## 7. Impact Assessment

### 7.1 Stakeholder Impact

| Stakeholder | Current Impact | After Phase 1 | After Phase 3 |
|-------------|---------------|---------------|---------------|
| **Users** | 7 commands fail | 4 commands restored | All commands work |
| **CI/CD** | Cannot verify full install | Partial verification | Full verification |
| **AI Agents** | Limited CLI usage | Most commands available | Full CLI access |
| **Maintainers** | Technical debt burden | Reduced urgency | Clean architecture |

### 7.2 Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Syntax fix breaks something else | Low | Medium | Comprehensive testing |
| Fix doesn't resolve all issues | Medium | Low | Phase 2 planned |
| Users encounter unfixed commands | High | Low | Document known issues |
| Native migration introduces bugs | Medium | High | Incremental rollout |

---

## 8. Board Questions

The LLM Board is asked to advise on:

1. **Phasing:** Is the 3-phase approach appropriate, or should we accelerate to native migration?

2. **Documentation:** Should v3.0.2 release notes explicitly list which commands are known-broken?

3. **Deprecation Timeline:** When should the `_scripts/` directory be formally deprecated?

4. **Test Coverage:** What level of test coverage should be required before merging Phase 1?

5. **User Communication:** How should we communicate partial functionality to users?

---

## 9. Reference Files

| Document | Path | Relevant Sections |
|----------|------|-------------------|
| v3.0 Technical Architecture | `.ontos-internal/strategy/v3.0/V3.0-Technical-Architecture.md` | §7.1 CLI Commands |
| CLI Implementation | `ontos/cli.py` | Command dispatch logic |
| Scaffold Script | `ontos/_scripts/ontos_scaffold.py` | Lines 27-28 |
| Stub Script | `ontos/_scripts/ontos_stub.py` | Lines 27-28 |
| Promote Script | `ontos/_scripts/ontos_promote.py` | Lines 27-28 |
| Migrate Script | `ontos/_scripts/ontos_migrate_schema.py` | Lines 31-32 |
| Map Command (Native) | `ontos/commands/map.py` | Reference implementation |
| Log Command (Native) | `ontos/commands/log.py` | Reference implementation |

---

## 10. Appendix: Error Reproduction

### A1: IndentationError (4 commands)

```bash
$ ontos scaffold
Traceback (most recent call last):
  File "/path/to/ontos/_scripts/ontos_scaffold.py", line 28
    from ontos_config_defaults import ONTOS_DIR, ...
    ^
IndentationError: expected an indented block after 'if' statement on line 27
```

### A2: ModuleNotFoundError (3 commands)

```bash
$ ontos verify
Traceback (most recent call last):
  File "/path/to/ontos/_scripts/ontos_verify.py", line 15, in <module>
    from ontos.core.document import Document
ModuleNotFoundError: No module named 'ontos.core'; 'ontos' is not a package
```

---

*End of Proposal - Awaiting LLM Board Review*
