---
id: v2_7_implementation_synthesis
type: atom
status: complete
depends_on: []
concepts: [synthesis, describes, immutable-history, consensus]
---

# v2.7 Implementation Plan: Review Synthesis

**Author:** Claude Code (Opus 4.5) as Chief Architect
**Date:** 2025-12-19
**Status:** FINAL CONSENSUS - Ready for Implementation
**Inputs:** Reviews from Codex, Claude, Gemini

---

## Executive Summary

Three technical co-founders reviewed the v2.7 Implementation Plan. The verdict:

| Reviewer | Status | Grade/Notes |
|----------|--------|-------------|
| **Codex** | Findings + Votes | Detailed concerns, no blocking issues |
| **Gemini** | **APPROVE** | "Exceptionally thorough and well-crafted" |
| **Claude** | **APPROVE WITH CHANGES** | Grade A-, 5 required changes |

**Bottom line:** The plan is approved. All 16 open questions have **unanimous consensus**. One point of divergence (pre-push staleness) is resolved below. Implementation can proceed after incorporating the required changes identified by reviewers.

---

## Part 1: Open Question Resolutions

### Unanimous Consensus (All 16 Questions)

| ID | Question | Final Decision | Votes |
|----|----------|----------------|-------|
| **2.3.A** | What types can USE `describes`? | **Atom only** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.3.B** | What types can BE described? | **Atom only** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.3.C** | Can a doc describe itself? | **Disallow** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.4.A** | How to determine last modified? | **Git with mtime fallback** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.4.B** | Date precision? | **Day (YYYY-MM-DD)** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.4.C** | When does staleness check run? | **See divergence resolution below** | — |
| **2.6.A** | How to update verified date? | **Manual + Command helper** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.8.A** | Staleness audit format? | **Both (inline flag + section)** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.8.B** | Verify script structure? | **New script (migrate to CLI in v2.8)** | Codex ✓ Gemini ✓ Claude ✓ |
| **2.9.A** | Migration strategy? | **Silent opt-in for v2.7** | Codex ✓ Gemini ✓ Claude ✓ |
| **3.3.A** | When to regenerate history? | **On context map generation** | Codex ✓ Gemini ✓ Claude ✓ |
| **3.3.B** | Date source for sorting? | **Frontmatter with filename fallback** | Codex ✓ Gemini ✓ Claude ✓ |
| **3.3.C** | History file location? | **Current location (no change)** | Codex ✓ Gemini ✓ Claude ✓ |
| **3.3.D** | Git tracking for history? | **Committed + GENERATED header** | Codex ✓ Gemini ✓ Claude ✓ |
| **3.5.A** | Consolidation vs history gen? | **Independent operations** | Codex ✓ Gemini ✓ Claude ✓ |
| **3.6.A** | Merge conflict helper? | **No helper for v2.7** | Codex ✓ Gemini ✓ Claude ✓ |

---

### Divergence Resolution: Question 2.4.C (When to check staleness?)

**The disagreement:**

| Reviewer | Position | Rationale |
|----------|----------|-----------|
| Gemini | All (map + archive + pre-push) | "The check is computationally cheap" |
| Codex | All + optional strict mode | "Add optional blocking mode for CI/pre-push" |
| Claude | Map + Archive only (NO pre-push) | "Warning fatigue. Users will learn to ignore all warnings." |

**Chief Architect Resolution:**

Claude's warning fatigue argument is compelling. The pre-push hook already has:
- Unarchived session warnings
- Consolidation reminders (in prompted mode)
- Potential blocking behavior

Adding staleness warnings to pre-push creates a "wall of warnings" effect. Users will stop reading them.

**Final Decision:**

```
Staleness check runs at:
  ✅ Context map generation (persistent state for agents)
  ✅ Archive Ontos (natural "end of session" checkpoint)
  ❌ Pre-push (skip to reduce warning fatigue)
```

**Codex's strict mode request:** Noted for v2.8. In v2.7, staleness is advisory (warnings), not blocking. A `--strict` flag that fails on staleness can be added for CI use cases in v2.8.

---

## Part 2: Required Changes Before Implementation

These changes were identified as **blocking** by reviewers. All must be addressed.

### R1: Validate `describes_verified` Not in Future (Claude)

**Problem:** A user setting `describes_verified: 2030-01-01` would never see staleness warnings.

**Solution:** Add validation rule:

```
| describes_verified is in the future | WARN — date is in the future, staleness check will never trigger |
```

**Implementation:** In `ontos_lib.py` validation, compare `describes_verified` to `date.today()`.

---

### R2: Handle Uncommitted Files (Claude)

**Problem:** `git log -1 --format=%ci -- new_file.md` returns empty string for files not yet committed.

**Solution:** If git returns empty/fails for a file:
1. Check if file exists on disk
2. If exists but no git history → treat as "modified today"
3. This is conservative — assumes uncommitted files are fresh

**Implementation:**
```python
def get_git_last_modified(filepath: Path) -> Tuple[Optional[date], str]:
    result = subprocess.run(...)
    if not result.stdout.strip():
        if filepath.exists():
            return (date.today(), "uncommitted")
        return (None, "missing")
    return (parse_date(result.stdout), "git")
```

---

### R3: Handle Git Not Installed (All Three)

**Problem:** `subprocess.run(["git", ...])` raises `FileNotFoundError` if git is not in PATH.

**Solution:** Wrap in try/except, fall back to mtime with clear warning:

```python
try:
    result = subprocess.run(["git", "log", ...], ...)
except FileNotFoundError:
    print("WARN: git not found. Falling back to file modification time (less reliable).")
    return (date.fromtimestamp(os.path.getmtime(filepath)), "mtime")
```

---

### R4: Handle Malformed Archived Logs (Claude, Codex)

**Problem:** Archived logs may have incomplete/inconsistent frontmatter. History generation could fail on one bad log.

**Solution:** Graceful degradation:
1. Log a warning for unparseable logs
2. Skip the malformed log
3. Continue with parseable logs
4. Report count of skipped logs at end

**Implementation:**
```python
def generate_decision_history(logs_dir: Path) -> str:
    parsed = []
    skipped = []
    for log_file in logs_dir.glob("*.md"):
        try:
            parsed.append(parse_log(log_file))
        except ParseError as e:
            skipped.append((log_file, str(e)))
            print(f"WARN: Skipping malformed log: {log_file} ({e})")

    if skipped:
        print(f"Skipped {len(skipped)} malformed logs")

    return render_history(sorted(parsed))
```

---

### R5: Add `--skip-history` Flag (Claude)

**Problem:** Regenerating `decision_history.md` on every context map generation may surprise users who just want to validate the map.

**Solution:** Add flag:
```bash
python3 .ontos/scripts/ontos_generate_context_map.py --skip-history
```

Default behavior: regenerate history. Flag allows skipping.

---

## Part 3: Recommended Changes

These improve the implementation but are not blocking.

### C1: Add Caching to Git Lookups (Gemini, Codex)

**Recommendation:** Use in-memory dict cache within a single script run:

```python
_git_cache: Dict[Path, date] = {}

def get_git_last_modified(filepath: Path) -> date:
    if filepath not in _git_cache:
        _git_cache[filepath] = _fetch_from_git(filepath)
    return _git_cache[filepath]
```

**Benefit:** For 20 describes relationships, only call git once per unique file.

---

### C2: Return `ModifiedSource` Enum (Claude)

**Recommendation:** Change function signature to indicate data source:

```python
class ModifiedSource(Enum):
    GIT = "git"
    MTIME = "mtime"
    UNCOMMITTED = "uncommitted"
    MISSING = "missing"

def get_git_last_modified(filepath: Path) -> Tuple[Optional[date], ModifiedSource]:
    ...
```

**Benefit:** Downstream code can show different warnings for reliable (git) vs unreliable (mtime) dates.

---

### C3: Add Log Count to History Header (Claude)

**Recommendation:** Include counts in the generated header:

```markdown
<!--
GENERATED FILE - DO NOT EDIT MANUALLY
Regenerated by: ontos_generate_context_map.py
Source: .ontos-internal/logs/, .ontos-internal/archive/logs/
Last generated: 2025-12-19T14:30:00Z
Log count: 47 active, 123 archived, 2 skipped
-->
```

---

### C4: Archive Existing `decision_history.md` Before v2.7 (Claude)

**Problem:** Current `decision_history.md` may contain manually written content that predates the log system.

**Recommendation:** Before v2.7 ships:
1. Review current `decision_history.md` content
2. Migrate any entries that don't have corresponding logs into legacy logs
3. Then regeneration won't lose information

**For Ontos itself:** Check if current `decision_history.md` has entries not covered by logs.

---

### C5: Specify `--all` Behavior for `ontos_verify.py` (Gemini)

**Problem:** A "yes-to-all" footgun where user verifies without reading.

**Recommendation:** `--all` iterates and prompts individually:

```bash
$ python3 .ontos/scripts/ontos_verify.py --all

Found 3 stale documents:

[1/3] Ontos_Manual.md
      Stale because: ontos_end_session changed 2025-12-18
      Verify as current? [y/N]: y
      ✅ Updated describes_verified to 2025-12-19

[2/3] Ontos_Agent_Instructions.md
      ...
```

**Alternative:** List all stale files and exit, forcing user to verify one by one.

---

### C6: Test for Circular Describes (Gemini)

**Problem:** Doc A describes Doc B, Doc B describes Doc A.

**Recommendation:** Add validation and test:

```python
def validate_describes_no_cycles(docs: List[Document]) -> List[Error]:
    """Detect circular describes relationships."""
```

Test case:
```python
def test_circular_describes_detected():
    """A describes B, B describes A should error."""
```

---

### C7: Cookbook Examples for Common Docs (Codex)

**Recommendation:** Add to documentation:

```markdown
## Examples: Using `describes`

### Manual describing scripts
```yaml
# Ontos_Manual.md
describes:
  - ontos_end_session
  - ontos_maintain
  - ontos_init
describes_verified: 2025-12-19
```

### Agent Instructions describing Manual
```yaml
# Ontos_Agent_Instructions.md
describes:
  - ontos_manual
describes_verified: 2025-12-19
```
```

---

## Part 4: Deferred to v2.8+

These were explicitly noted for future versions.

| Item | Reason for Deferral |
|------|---------------------|
| **Section-level tracking** | Complexity; start with doc-level |
| **`verified_by` attribution** | Enterprise feature; not needed for v2.7 |
| **Suggest-links based on content** | Requires content analysis; future feature |
| **Strict mode (`--strict` fails on stale)** | Staleness is advisory in v2.7 |
| **Stale backlog command** | Can use context map section for now |
| **Git batch operations** | Optimization; caching sufficient for v2.7 |
| **Migration helper for ID renames** | Edge case; document carefully for now |
| **Unified CLI integration** | v2.8 feature per master plan |
| **Shallow clone / detached worktree handling** | Edge case; document limitations |

---

## Part 5: Additional Insights from Reviewers

### From Codex

1. **Path alignment:** Verify `.ontos-internal/atom/schema.md` is the correct path before implementation. (Chief Architect note: Path is correct per current structure.)

2. **Backcompat for legacy logs:** Define handling for logs missing `date` field or with malformed frontmatter. **Resolution:** Fall back to filename date pattern `YYYY-MM-DD_*.md`. If that fails too, skip with warning.

3. **CI enforcement:** Consider adding CI check comparing history file hash to regenerated hash. **Resolution:** Deferred to v2.8; document the regeneration workflow for now.

### From Gemini

1. **Performance constraint reaffirmed:** All operations must complete in < 1 second. Caching is the mitigation.

2. **Human discipline risk acknowledged:** The system's value depends on developers maintaining `describes` fields. This is inherent to the "Librarian's Wager" philosophy.

### From Claude

1. **Transitive staleness explicitly rejected:** If A describes B, and B describes C, and C changes — A is NOT flagged stale. Only direct relationships matter. This was already in the plan; Claude confirmed correctness.

2. **Field name `describes` confirmed:** This is the final name. Changing it later is a breaking change.

3. **`--strict` behavior:** Should NOT fail on staleness (advisory), should NOT fail on missing `describes_verified` (also advisory). Only fail on broken links, cycles, etc.

---

## Part 6: Final Implementation Checklist

### Before Writing Code

- [ ] Confirm all paths in File Change Summary are correct
- [ ] Review current `decision_history.md` for content that needs migration
- [ ] Confirm `describes` is the final field name (no more bikeshedding)

### Required Changes (Blocking)

- [ ] R1: Add future-date validation for `describes_verified`
- [ ] R2: Handle uncommitted files (treat as "today")
- [ ] R3: Handle git not installed (fallback with warning)
- [ ] R4: Handle malformed archived logs (skip with warning)
- [ ] R5: Add `--skip-history` flag to context map generation

### Recommended Changes

- [ ] C1: Add in-memory caching for git lookups
- [ ] C2: Return `ModifiedSource` enum from git function
- [ ] C3: Add log count to history header
- [ ] C4: Archive existing decision_history.md content if needed
- [ ] C5: Make `--all` flag iterate and prompt individually
- [ ] C6: Add circular describes validation and test
- [ ] C7: Add cookbook examples to documentation

### Implementation Phases (Updated)

**Phase 1: Core Implementation**
1. Add schema fields to `schema.md`
2. Implement `describes` parsing in `ontos_lib.py`
3. Implement validation (including R1, R2, R3, C2, C6)
4. Implement staleness check logic (with C1 caching)
5. Add `[STALE]` flag to context map output

**Phase 2: Tooling**
6. Add warnings to `ontos_end_session.py`
7. ~~Add warnings to `ontos_pre_push_check.py`~~ (Removed per consensus)
8. Create `ontos_verify.py` helper (with C5 `--all` behavior)
9. Implement immutable history generation (with R4, R5, C3)

**Phase 3: Documentation**
10. Update `schema.md`
11. Update `Ontos_Manual.md` (with C7 examples)
12. Update `Ontos_Agent_Instructions.md`
13. Update `Common_Concepts.md`

**Phase 4: Validation**
14. Add unit tests (including C6 circular test)
15. Add integration tests
16. Performance benchmarks
17. Self-hosting: Apply `describes` to Ontos's own docs

---

## Part 7: Risk Register (Updated)

| Risk | Likelihood | Impact | Mitigation | Owner |
|------|------------|--------|------------|-------|
| Git command performance | Medium | Medium | Cache results (C1) | Implementation |
| User forgets to verify | High | Low | Non-blocking warnings | Design decision |
| ID rename breaks describes | Medium | Medium | Document carefully; helper in v2.8 | Documentation |
| History generation slow | Low | Medium | Lazy generation; `--skip-history` flag (R5) | Implementation |
| Circular describes | Low | Low | Validate at parse time (C6) | Implementation |
| Git not installed | Low | Medium | Graceful fallback (R3) | Implementation |
| Malformed archived logs | Medium | Low | Skip with warning (R4) | Implementation |
| Warning fatigue | Medium | Medium | Limit to context map + Archive Ontos | Design decision |
| Future describes_verified date | Low | Low | Warn on future dates (R1) | Implementation |

---

## Conclusion

**The v2.7 Implementation Plan is approved by the Review Board.**

All 16 open questions have unanimous consensus. The one point of divergence (pre-push staleness) is resolved in favor of warning fatigue reduction.

Five required changes and seven recommended changes have been identified. These are incorporated into the updated implementation phases above.

**Next step:** Proceed to implementation.

---

*Synthesis complete. This document represents the final consensus of the LLM Review Board.*

*Ready for implementation.*
