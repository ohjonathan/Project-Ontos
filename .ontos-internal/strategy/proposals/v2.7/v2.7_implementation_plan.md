---
id: v2_7_implementation_plan
type: strategy
status: complete
depends_on: []
concepts: [implementation, describes, immutable-history, staleness]
---

# v2.7 Implementation Plan

**Version:** 1.1.0 (Post-Review Final)
**Date:** 2025-12-19
**Author:** Claude Code (Opus 4.5) as Chief Architect
**Status:** APPROVED - Ready for Implementation
**Reviewed By:** Codex, Claude, Gemini (LLM Review Board)

---

## 0. Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-19 | Initial draft for review |
| 1.1.0 | 2025-12-19 | Incorporated review feedback, resolved all open questions |

**Key changes in v1.1.0:**
- All 16 open questions resolved with unanimous consensus
- Removed pre-push staleness check (warning fatigue concern)
- Added 5 required changes (R1-R5) from reviews
- Added 7 recommended changes (C1-C7)
- Updated function signatures with `ModifiedSource` enum
- Added edge case handling (uncommitted files, git not installed, malformed logs)
- Added `--skip-history` flag specification

---

## 1. Executive Summary

### 1.1 What v2.7 Delivers

v2.7 introduces **bidirectional documentation awareness** to the Ontos ontology. Currently, Ontos tracks dependencies downward (strategy → product → atom) but cannot detect when user-facing documentation becomes stale after implementation changes.

**Two features:**

| Feature | Purpose | User Value |
|---------|---------|------------|
| **`describes` Field** | Declare which atoms a doc describes | Staleness warnings when implementations change |
| **Immutable History** | Regenerate `decision_history.md` from logs | Eliminate git merge conflicts on history file |

### 1.2 Core Invariants (From Master Plan)

All implementation must respect these constraints:

1. **Zero-Dependency (v2.x):** Python Standard Library 3.9+ ONLY. No pip install.
2. **Local-First:** Data lives in user's git repo.
3. **Functional Core, Imperative Shell:** Logic separated from I/O.
4. **Deterministic Purity:** No probabilistic retrieval. Structural graph traversal only.
5. **Performance:** All operations < 1 second (per Architect Synthesis).

### 1.3 Scope Boundary

**In scope:**
- `describes` field schema and validation
- `describes_verified` field schema and validation
- Staleness detection logic
- `[STALE]` flag in context map
- Warning output in Archive Ontos
- Immutable history generation
- `--skip-history` flag for context map generation
- Schema documentation updates
- Agent Instructions updates

**Out of scope (deferred to v2.8+):**
- Section-level tracking (`describes.sections`)
- `verified_by` attribution
- Suggest-links based on content analysis
- Migration helper for ID renames
- Strict mode (`--strict` fails on stale)
- Pre-push staleness warnings (removed to reduce warning fatigue)

---

## 2. Feature 1: `describes` Field

### 2.1 Problem Statement

From the philosophy proposal:

> "Ontos tracks dependencies downward (strategy → product → atom) but has no mechanism for tracking when user-facing documentation (README, Manual, Guides) becomes stale after atoms change."

**Example scenario:**
1. Developer modifies `ontos_end_session.py` to add a new flag
2. Developer runs Archive Ontos, commits, pushes
3. `Ontos_Manual.md` still documents the old behavior
4. New user reads stale documentation, gets confused
5. Context death occurs — the opposite of Ontos's mission

### 2.2 Solution Overview

Introduce a new frontmatter relationship: `describes`

```yaml
# In Ontos_Manual.md
---
id: ontos_manual
type: atom
status: complete
depends_on: []
describes:
  - ontos_end_session
  - ontos_maintain
  - ontos_init
describes_verified: 2025-12-18
---
```

**Semantics:**
- `describes: [id, ...]` — "This document describes the behavior of these atoms"
- `describes_verified: <date>` — "I last verified this doc was current on this date"

When any described atom changes after `describes_verified`, the system flags `[STALE]`.

### 2.3 Schema Changes

#### 2.3.1 New Fields

Add to `schema.md` Section 3:

```markdown
### 3.3 Type: `atom` (when used as documentation)
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `describes` | list | No | List of atom IDs this document describes |
| `describes_verified` | string | Conditional | ISO date (YYYY-MM-DD) when doc was last verified. Required if `describes` is present. |
```

#### 2.3.2 Field Validation Rules

| Rule | Behavior |
|------|----------|
| `describes` contains unknown ID | **FAIL** context map generation with actionable error |
| `describes` contains valid ID | OK |
| `describes` present but `describes_verified` missing | **WARN** — doc has never been verified |
| `describes_verified` is invalid date format | **FAIL** with parse error |
| `describes_verified` is in the future | **WARN** — suspicious, staleness check may never trigger |
| `describes` is empty list | **WARN** — why declare empty describes? |
| `describes` contains self-reference | **FAIL** — semantically meaningless |
| `describes` creates circular reference (A→B, B→A) | **FAIL** — circular describes not allowed |
| Non-atom type uses `describes` | **FAIL** — only atoms can use describes |
| `describes` targets non-atom type | **FAIL** — can only describe atoms |

#### 2.3.3 Type Constraints (FINAL DECISIONS)

| Question | Decision | Consensus |
|----------|----------|-----------|
| What types can USE `describes`? | **Atom only** | Unanimous |
| What types can BE described? | **Atom only** | Unanimous |
| Can a doc describe itself? | **No (validation error)** | Unanimous |

---

### 2.4 Staleness Detection Logic

#### 2.4.1 The Core Algorithm

```
For each document D with `describes` field:
    For each atom_id in D.describes:
        atom_last_modified, source = get_last_modified(atom_id)
        if atom_last_modified > D.describes_verified:
            flag D as [STALE] for atom_id
```

#### 2.4.2 Determining `atom_last_modified` (FINAL DECISION)

**Decision:** Git commit timestamp with fallback to mtime.

**Implementation with `ModifiedSource` enum:**

```python
from enum import Enum
from datetime import date
from pathlib import Path
from typing import Tuple, Optional
import subprocess
import os

class ModifiedSource(Enum):
    GIT = "git"
    MTIME = "mtime"
    UNCOMMITTED = "uncommitted"
    MISSING = "missing"

# In-memory cache for performance (C1)
_git_cache: dict[Path, Tuple[date, ModifiedSource]] = {}

def get_git_last_modified(filepath: Path) -> Tuple[Optional[date], ModifiedSource]:
    """
    Get last modification date for a file.

    Returns:
        (date, source) where source indicates reliability:
        - GIT: From git log (reliable)
        - MTIME: From filesystem (unreliable, git resets this)
        - UNCOMMITTED: File exists but not in git yet (treat as today)
        - MISSING: File doesn't exist
    """
    # Check cache first (C1)
    if filepath in _git_cache:
        return _git_cache[filepath]

    result = _fetch_last_modified(filepath)
    _git_cache[filepath] = result
    return result

def _fetch_last_modified(filepath: Path) -> Tuple[Optional[date], ModifiedSource]:
    # Handle missing file
    if not filepath.exists():
        return (None, ModifiedSource.MISSING)

    try:
        result = subprocess.run(
            ["git", "log", "-1", "--format=%ci", "--", str(filepath)],
            capture_output=True, text=True, timeout=5
        )

        if result.returncode == 0 and result.stdout.strip():
            # Git has history for this file
            date_str = result.stdout.strip().split()[0]  # "2025-12-19 14:30:00 -0800" → "2025-12-19"
            return (date.fromisoformat(date_str), ModifiedSource.GIT)
        else:
            # File exists but no git history (uncommitted) - treat as today (R2)
            return (date.today(), ModifiedSource.UNCOMMITTED)

    except FileNotFoundError:
        # Git not installed (R3) - fall back to mtime with warning
        print("WARN: git not found. Falling back to file modification time (less reliable).")
        mtime = os.path.getmtime(filepath)
        return (date.fromtimestamp(mtime), ModifiedSource.MTIME)

    except subprocess.TimeoutExpired:
        # Git command hung - fall back to mtime
        print("WARN: git command timed out. Falling back to file modification time.")
        mtime = os.path.getmtime(filepath)
        return (date.fromtimestamp(mtime), ModifiedSource.MTIME)
```

#### 2.4.3 Date Precision (FINAL DECISION)

**Decision:** Day precision (YYYY-MM-DD).

Git timestamps are truncated to date for comparison. This avoids timezone complexity and matches user mental model.

#### 2.4.4 When Staleness Check Runs (FINAL DECISION)

**Decision:** Context map generation + Archive Ontos only. **NOT pre-push.**

| Checkpoint | Staleness Check | Rationale |
|------------|-----------------|-----------|
| Context map generation | ✅ Yes | Persistent state for agents |
| Archive Ontos | ✅ Yes | Natural "end of session" checkpoint |
| Pre-push | ❌ No | Reduces warning fatigue (Claude's recommendation) |

---

### 2.5 Output Formats

#### 2.5.1 Context Map Format

In the hierarchy section:

```markdown
### ATOM
- **ontos_manual** [STALE] (Ontos_Manual.md) ~2,700 tokens
  - Status: active
  - Depends On: v2_strategy
  - Describes: ontos_end_session, ontos_maintain
  - Verified: 2025-12-15
  - ⚠️ Stale: ontos_end_session changed 2025-12-18
```

#### 2.5.2 Documentation Staleness Audit Section

New section in context map:

```markdown
## 5. Documentation Staleness Audit

| Document | Describes | Verified | Status |
|----------|-----------|----------|--------|
| ontos_manual | ontos_end_session, ontos_maintain | 2025-12-15 | ⚠️ STALE |
| ontos_agent_instructions | ontos_manual | 2025-12-18 | ✅ Current |

*1 stale document found. Run `python3 .ontos/scripts/ontos_verify.py <path>` to mark as current.*
```

#### 2.5.3 Archive Ontos Warning

```
✅ Session archived: 2025-12-19_feature-describes-field.md

⚠️  Documentation may be stale:

   Ontos_Manual.md describes:
     - ontos_end_session (changed 2025-12-18, verified 2025-12-15)

   Review and update describes_verified if current.
   Run: python3 .ontos/scripts/ontos_verify.py docs/reference/Ontos_Manual.md
```

---

### 2.6 Verification Workflow (FINAL DECISION)

**Decision:** Manual edit (primary) + Command helper (convenience).

#### 2.6.1 Manual Edit

User opens the file, updates the frontmatter:
```yaml
describes_verified: 2025-12-19  # Updated manually
```

#### 2.6.2 Command Helper

```bash
# Verify single doc
python3 .ontos/scripts/ontos_verify.py docs/reference/Ontos_Manual.md

# Verify all stale docs (interactive - iterates and prompts individually) (C5)
python3 .ontos/scripts/ontos_verify.py --all

# Verify with specific date (backdating)
python3 .ontos/scripts/ontos_verify.py docs/manual.md --date 2025-12-15
```

**`--all` behavior (C5):** Iterates through each stale file and prompts individually to prevent "yes-to-all" footgun:

```
$ python3 .ontos/scripts/ontos_verify.py --all

Found 3 stale documents:

[1/3] Ontos_Manual.md
      Stale because: ontos_end_session changed 2025-12-18
      Verify as current? [y/N]: y
      ✅ Updated describes_verified to 2025-12-19

[2/3] Ontos_Agent_Instructions.md
      Stale because: ontos_manual changed 2025-12-18
      Verify as current? [y/N]: n
      ⏭️  Skipped

[3/3] README.md
      ...
```

---

### 2.7 Error Messages

#### 2.7.1 Unknown ID in `describes`

```
ERROR: Unknown atom ID 'nonexistent_script' in describes field

  File: docs/reference/Ontos_Manual.md
  Field: describes: [ontos_end_session, nonexistent_script]
                                        ^^^^^^^^^^^^^^^^^^^

  To fix:
    - Create an atom doc with id: nonexistent_script
    - Or remove 'nonexistent_script' from the describes list

  Context map generation failed.
```

#### 2.7.2 Missing `describes_verified`

```
WARN: Document has 'describes' but no 'describes_verified'

  File: docs/reference/Ontos_Manual.md

  This document has never been verified as current.
  Add 'describes_verified: YYYY-MM-DD' to track freshness.
```

#### 2.7.3 Invalid Date Format

```
ERROR: Invalid date format in describes_verified

  File: docs/reference/Ontos_Manual.md
  Value: describes_verified: "Dec 18 2025"
  Expected: YYYY-MM-DD (e.g., 2025-12-18)
```

#### 2.7.4 Future Date Warning (R1)

```
WARN: describes_verified date is in the future

  File: docs/reference/Ontos_Manual.md
  Value: describes_verified: 2030-01-01

  Staleness check will never trigger until this date passes.
  This is likely an error. Did you mean 2025-01-01?
```

#### 2.7.5 Self-Reference Error

```
ERROR: Document describes itself

  File: docs/reference/some_doc.md
  Field: describes: [some_doc]
                     ^^^^^^^^

  Self-reference is semantically meaningless.
  Remove the self-reference from the describes list.
```

#### 2.7.6 Circular Reference Error (C6)

```
ERROR: Circular describes relationship detected

  doc_a.md describes doc_b
  doc_b.md describes doc_a

  Circular describes relationships are not allowed.
  Remove one of the describes references to break the cycle.
```

#### 2.7.7 Type Constraint Errors

```
ERROR: Only atoms can use the 'describes' field

  File: .ontos-internal/strategy/some_strategy.md
  Type: strategy

  The 'describes' field is only valid for type: atom.
  Remove the describes field or change the document type.
```

```
ERROR: Can only describe atoms

  File: docs/reference/Ontos_Manual.md
  Field: describes: [v2_strategy]
                     ^^^^^^^^^^^

  'v2_strategy' is type: strategy, not atom.
  The describes field can only reference atoms.
```

---

### 2.8 Script Modifications

#### 2.8.1 `ontos_lib.py`

**Changes:**
1. Add `describes` and `describes_verified` to frontmatter parsing
2. Add validation for `describes` field (must be list of strings)
3. Add validation for `describes_verified` (must be valid ISO date, not in future)
4. Add validation for type constraints (atom-only)
5. Add validation for self-reference and circular references
6. Add helper: `resolve_id_to_path(id: str) -> Path`
7. Add helper: `get_git_last_modified(path: Path) -> Tuple[date, ModifiedSource]`
8. Add in-memory cache for git lookups

**New types and functions:**
```python
class ModifiedSource(Enum):
    GIT = "git"
    MTIME = "mtime"
    UNCOMMITTED = "uncommitted"
    MISSING = "missing"

def validate_describes_field(doc: Document, all_docs: Dict[str, Document]) -> List[ValidationError]:
    """Validate describes field: references exist, type constraints, no self-reference, no cycles."""

def get_git_last_modified(filepath: Path) -> Tuple[Optional[date], ModifiedSource]:
    """Get last git commit date for a file with caching. Returns source for reliability indication."""

def check_staleness(doc: Document, all_docs: Dict[str, Document]) -> List[StalenessWarning]:
    """Check if any described atoms are newer than describes_verified."""

def detect_describes_cycles(docs: List[Document]) -> List[Tuple[str, str]]:
    """Detect circular describes relationships. Returns list of (doc_a, doc_b) pairs."""
```

#### 2.8.2 `ontos_generate_context_map.py`

**Changes:**
1. Parse `describes` and `describes_verified` from frontmatter
2. Validate `describes` targets exist (fail-fast)
3. Validate type constraints
4. Detect circular describes
5. Run staleness check for all docs with `describes`
6. Add `[STALE]` flag to hierarchy output
7. Add "Describes" and "Verified" lines to doc entries
8. Add Section 5: Documentation Staleness Audit
9. Regenerate `decision_history.md` (unless `--skip-history`)
10. Add `--skip-history` flag (R5)

**New command-line option:**
```bash
# Normal behavior: regenerate history
python3 .ontos/scripts/ontos_generate_context_map.py

# Skip history regeneration (for quick validation)
python3 .ontos/scripts/ontos_generate_context_map.py --skip-history
```

#### 2.8.3 `ontos_end_session.py`

**Changes:**
1. After creating/enhancing log, run staleness check
2. Display warning if any docs are stale
3. Suggest verification command

#### 2.8.4 `ontos_pre_push_check.py`

**No changes for staleness.** Pre-push does NOT check staleness (per review consensus to reduce warning fatigue).

#### 2.8.5 New Script: `ontos_verify.py`

**Purpose:** Convenience helper to update `describes_verified`.

**Usage:**
```bash
# Verify single doc
python3 .ontos/scripts/ontos_verify.py docs/reference/Ontos_Manual.md

# Verify all stale docs (interactive, prompts individually)
python3 .ontos/scripts/ontos_verify.py --all

# Verify with specific date (backdating)
python3 .ontos/scripts/ontos_verify.py docs/manual.md --date 2025-12-15
```

**Behavior:**
1. If `--all`: Find all stale docs, iterate and prompt for each
2. Read file
3. Update `describes_verified` to today (or specified date)
4. Write file
5. Print confirmation

**Note:** This script will migrate to unified CLI in v2.8 as `python3 ontos.py verify`.

---

### 2.9 Migration Strategy (FINAL DECISION)

**Decision:** Silent opt-in for v2.7.

- Repos without `describes` fields simply don't get staleness warnings
- Feature is opt-in by adding fields manually
- Prompted suggestions deferred to v2.8

---

## 3. Feature 2: Immutable History

### 3.1 Problem Statement

From the master plan:

> "**Immutable History** — Regenerate `decision_history.md` from logs on-demand (Read-Only). **Collaboration.** Solves Git Merge Conflicts."

**Current state:**
- `decision_history.md` is manually maintained
- Lives in `.ontos-internal/strategy/`
- Contains consolidated session log summaries
- Created by `ontos_consolidate.py`

**The problem:**
When two developers work on branches and both archive sessions:
1. Branch A adds entries to `decision_history.md`
2. Branch B adds entries to `decision_history.md`
3. Merge → conflict on `decision_history.md`
4. Manual conflict resolution required

### 3.2 Solution Overview

Make `decision_history.md` a **generated artifact** rather than a source of truth.

**Key insight:** Session logs are the source of truth. `decision_history.md` is just a VIEW of the logs — like a database query result. If logs don't conflict (they're separate files), the history view shouldn't conflict either.

**New workflow:**
1. Logs are the source of truth (individual files, rarely conflict)
2. `decision_history.md` is regenerated from logs
3. Regeneration is deterministic (same logs → same output)
4. Merge conflicts become impossible (just regenerate after merge)

### 3.3 Design Decisions (FINAL)

| Question | Decision | Consensus |
|----------|----------|-----------|
| When to regenerate? | On context map generation (with `--skip-history` opt-out) | Unanimous |
| Date source for sorting? | Frontmatter with filename fallback | Unanimous |
| History file location? | Current location (no change) | Unanimous |
| Git tracking? | Committed + GENERATED header | Unanimous |
| Consolidation relationship? | Independent | Unanimous |
| Merge helper? | No helper for v2.7 | Unanimous |

### 3.4 Deterministic Sorting

**CRITICAL:** The generated history MUST be deterministic. Same logs must always produce same output, regardless of filesystem order or machine.

**Sort order:**
1. **Primary:** Date descending (newest first) — from frontmatter `date` field, fallback to filename
2. **Secondary:** Event type alphabetically — `chore`, `decision`, `exploration`, `feature`, `fix`, `refactor`
3. **Tertiary:** Log ID alphabetically — for logs on same date with same type

**Implementation:**
```python
def get_log_date(log: Log) -> date:
    """Get date from frontmatter or filename."""
    if log.frontmatter.get('date'):
        return date.fromisoformat(log.frontmatter['date'])
    # Fallback: parse from filename YYYY-MM-DD_slug.md
    match = re.match(r'^(\d{4}-\d{2}-\d{2})_', log.filename)
    if match:
        return date.fromisoformat(match.group(1))
    # Last resort: file mtime (least reliable)
    return date.fromtimestamp(os.path.getmtime(log.path))

def sort_logs(logs: List[Log]) -> List[Log]:
    return sorted(logs, key=lambda l: (
        -get_log_date(l).toordinal(),  # Descending date
        l.event_type,                   # Alphabetical type
        l.id                            # Alphabetical ID
    ))
```

### 3.5 Handling Malformed Logs (R4)

Archived logs may have incomplete/inconsistent frontmatter. History generation must handle this gracefully.

**Behavior:**
1. Attempt to parse each log
2. If parsing fails, log a warning and skip
3. Continue with parseable logs
4. Report count of skipped logs at end

```python
def generate_decision_history(logs_dirs: List[Path]) -> Tuple[str, List[str]]:
    """
    Generate decision_history.md from logs.

    Returns:
        (markdown_content, list_of_warnings)
    """
    parsed = []
    warnings = []

    for logs_dir in logs_dirs:
        for log_file in logs_dir.glob("*.md"):
            try:
                parsed.append(parse_log(log_file))
            except ParseError as e:
                warnings.append(f"Skipping malformed log: {log_file} ({e})")

    if warnings:
        for w in warnings:
            print(f"WARN: {w}")
        print(f"\nSkipped {len(warnings)} malformed logs")

    sorted_logs = sort_logs(parsed)
    return render_history(sorted_logs, len(parsed), len(warnings))
```

### 3.6 Output Format

Generated `decision_history.md` structure:

```markdown
<!--
GENERATED FILE - DO NOT EDIT MANUALLY
Regenerated by: ontos_generate_context_map.py
Source: .ontos-internal/logs/, .ontos-internal/archive/logs/
Last generated: 2025-12-19T14:30:00Z
Log count: 47 active, 123 archived, 2 skipped
-->

---
id: decision_history
type: strategy
status: complete
depends_on: []
---

# Decision History

This file is auto-generated from session logs. Do not edit directly.

To regenerate: `python3 .ontos/scripts/ontos_generate_context_map.py`

## 2025-12-19

### [feature] Describes Field Implementation
- **Log:** `log_20251219_describes_field`
- **Impacts:** schema, ontos_manual, ontos_agent_instructions
- **Concepts:** describes, staleness, bidirectional

> Implemented the `describes` field for documentation staleness tracking...

### [chore] Maintenance Run
- **Log:** `log_20251219_maintenance`
- **Impacts:** decision_history
- **Concepts:** maintenance

> Weekly maintenance: consolidated logs, regenerated context map...

## 2025-12-18

### [feature] v2.7 Philosophy Proposal
- **Log:** `log_20251218_v2_7_philosophy_proposal`
...
```

### 3.7 Script Modifications

#### 3.7.1 `ontos_generate_context_map.py`

**Changes:**
1. After generating context map, regenerate `decision_history.md` (unless `--skip-history`)
2. Read all logs from `.ontos-internal/logs/` and `.ontos-internal/archive/logs/`
3. Sort deterministically
4. Handle malformed logs gracefully (R4)
5. Generate markdown with GENERATED header and log counts (C3)
6. Write to `.ontos-internal/strategy/decision_history.md`

#### 3.7.2 `ontos_consolidate.py`

**Changes:**
- Remove any logic that manually edits `decision_history.md`
- Consolidation now just archives old logs
- History regeneration happens in context map generation

### 3.8 Merge Conflict Resolution Workflow

**Documented workflow after merge:**

```bash
# 1. Merge branch (may have log conflicts, but unlikely)
git merge feature-branch

# 2. If decision_history.md conflicts:
git checkout --theirs .ontos-internal/strategy/decision_history.md
# (Or just delete the conflicted file - it will be regenerated)

# 3. Regenerate history
python3 .ontos/scripts/ontos_generate_context_map.py

# 4. Commit the regenerated file
git add .ontos-internal/strategy/decision_history.md
git commit -m "Regenerate decision history after merge"
```

---

## 4. Testing Strategy

### 4.1 Unit Tests

**`describes` field tests:**
- Parse `describes` field from frontmatter
- Parse `describes_verified` field from frontmatter
- Validate `describes` contains valid IDs
- Validate `describes_verified` is valid date format
- Reject `describes_verified` in the future (warn)
- Reject self-referential describes
- Reject circular describes (A→B, B→A) (C6)
- Reject unknown IDs in describes
- Reject non-atom types using describes
- Reject describes targeting non-atom types

**Git lookup tests:**
- Return git date for committed file
- Return today for uncommitted file (R2)
- Return mtime with warning when git not installed (R3)
- Cache results across multiple calls (C1)

**Staleness detection tests:**
- Doc with describes_verified older than atom → STALE
- Doc with describes_verified newer than atom → Current
- Doc with describes but no describes_verified → WARN
- Doc without describes → No staleness check
- Handle ModifiedSource.UNCOMMITTED correctly
- Handle ModifiedSource.MTIME correctly

**History generation tests:**
- Deterministic output (same logs → same hash)
- Correct sort order (date desc, type alpha, id alpha)
- Generated header present with log counts
- All logs included (active and archived)
- Malformed logs skipped with warning (R4)
- Frontmatter date preferred over filename date

### 4.2 Integration Tests

**End-to-end workflow:**
1. Create a project with Ontos
2. Add a doc with `describes: [some_atom]`
3. Modify the atom
4. Run context map generation
5. Verify `[STALE]` flag appears
6. Run `ontos_verify.py`
7. Verify staleness clears

**Merge conflict simulation:**
1. Create two branches
2. Add different logs on each
3. Merge
4. Verify history regeneration resolves conflicts

**`--skip-history` test:**
1. Run context map generation with `--skip-history`
2. Verify `decision_history.md` is NOT regenerated

### 4.3 Performance Tests

**Constraint:** All operations < 1 second

**Benchmarks:**
- Context map generation with 100 docs, 50 logs: < 1s
- Staleness check with 20 describes relationships: < 100ms (with caching)
- History regeneration with 200 logs: < 500ms

---

## 5. Documentation Updates

### 5.1 Schema.md

Add Section 3.3 for `describes` and `describes_verified` fields.

### 5.2 Ontos_Manual.md

Add section: "Documentation Staleness Tracking"
- Explain `describes` field
- Explain `describes_verified` field
- Workflow for verification
- Cookbook examples (C7)

**Cookbook examples to include:**

```yaml
# Manual describing scripts
# Ontos_Manual.md
---
id: ontos_manual
type: atom
describes:
  - ontos_end_session
  - ontos_maintain
  - ontos_init
describes_verified: 2025-12-19
---
```

```yaml
# Agent Instructions describing Manual
# Ontos_Agent_Instructions.md
---
id: ontos_agent_instructions
type: atom
describes:
  - ontos_manual
describes_verified: 2025-12-19
---
```

### 5.3 Ontos_Agent_Instructions.md

Add to "Validation Errors" table:
```
| `[STALE]` | Review doc, update describes_verified if current |
```

Add to commands section:
```
### "Verify Ontos" (Mark Doc Current)
python3 .ontos/scripts/ontos_verify.py path/to/doc.md
```

### 5.4 Common_Concepts.md

Add concepts:
- `describes` — Documentation relationship tracking
- `staleness` — Detection of outdated documentation
- `immutable-history` — Generated decision history

---

## 6. Rollout Plan

### Phase 1: Core Implementation
1. Add schema fields to `schema.md`
2. Implement `ModifiedSource` enum and `get_git_last_modified()` with caching in `ontos_lib.py`
3. Implement `describes` parsing and validation in `ontos_lib.py`
4. Implement circular describes detection
5. Implement staleness check logic
6. Add `[STALE]` flag and Section 5 to context map output

### Phase 2: Tooling
7. Add warnings to `ontos_end_session.py`
8. Create `ontos_verify.py` helper with `--all` interactive mode
9. Implement immutable history generation with malformed log handling
10. Add `--skip-history` flag to context map generation
11. Update `ontos_consolidate.py` to remove manual history editing

### Phase 3: Documentation
12. Update `schema.md`
13. Update `Ontos_Manual.md` with cookbook examples
14. Update `Ontos_Agent_Instructions.md`
15. Update `Common_Concepts.md`

### Phase 4: Validation
16. Add unit tests (including circular describes, git edge cases)
17. Add integration tests
18. Performance benchmarks
19. Self-hosting: Apply `describes` to Ontos's own docs

---

## 7. Resolved Questions Summary

All questions resolved with **unanimous consensus** from LLM Review Board:

| ID | Question | Final Decision |
|----|----------|----------------|
| 2.3.A | What types can USE `describes`? | Atom only |
| 2.3.B | What types can BE described? | Atom only |
| 2.3.C | Can a doc describe itself? | No (validation error) |
| 2.4.A | How to determine atom last modified? | Git with mtime fallback |
| 2.4.B | Date comparison precision? | Day (YYYY-MM-DD) |
| 2.4.C | When does staleness check run? | Context map + Archive Ontos (NOT pre-push) |
| 2.6.A | How does user update verified date? | Manual + Command helper |
| 2.8.A | Staleness audit section format? | Both (inline flag + section) |
| 2.8.B | Verify script structure? | New script (migrate to CLI in v2.8) |
| 2.9.A | Migration strategy? | Silent opt-in |
| 3.3.A | When to regenerate history? | Context map generation (with --skip-history opt-out) |
| 3.3.B | Date source for sorting? | Frontmatter with filename fallback |
| 3.3.C | History file location? | Current location |
| 3.3.D | Git tracking for history? | Committed + GENERATED header |
| 3.5.A | Consolidation vs history gen? | Independent |
| 3.6.A | Merge conflict helper? | No helper for v2.7 |

---

## 8. Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Git command performance | Medium | Medium | Cache results (C1) |
| User forgets to verify | High | Low | Non-blocking warnings, trust users |
| ID rename breaks describes | Medium | Medium | Document carefully, helper in v2.8 |
| History generation slow | Low | Medium | `--skip-history` flag (R5) |
| Circular describes | Low | Low | Validate at parse time (C6) |
| Git not installed | Low | Medium | Graceful fallback with warning (R3) |
| Malformed archived logs | Medium | Low | Skip with warning, continue (R4) |
| Warning fatigue | Medium | Medium | Limit to context map + Archive Ontos |
| Future describes_verified date | Low | Low | Warn on future dates (R1) |
| Uncommitted files | Low | Low | Treat as "today" (R2) |

---

## 9. Success Criteria

v2.7 is complete when:

1. ✅ `describes` field parses correctly in all contexts
2. ✅ `describes_verified` field parses correctly
3. ✅ Unknown IDs in `describes` fail with actionable error
4. ✅ Type constraints enforced (atom-only)
5. ✅ Self-reference and circular describes detected
6. ✅ Staleness detection works (git-based comparison with caching)
7. ✅ `[STALE]` flag appears in context map hierarchy
8. ✅ Section 5 (Staleness Audit) appears in context map
9. ✅ Warnings appear in Archive Ontos
10. ✅ `ontos_verify.py` helper works (including `--all` interactive mode)
11. ✅ `decision_history.md` is generated, not manually maintained
12. ✅ History generation is deterministic
13. ✅ History generation handles malformed logs gracefully
14. ✅ `--skip-history` flag works
15. ✅ All documentation updated (including cookbook examples)
16. ✅ Tests pass (including edge cases)
17. ✅ Performance < 1 second for all operations
18. ✅ Ontos's own docs use `describes` (self-hosting)

---

## Appendix A: Glossary

| Term | Definition |
|------|------------|
| **describes** | Frontmatter field declaring which atoms a doc describes |
| **describes_verified** | Date when doc was last verified as current |
| **staleness** | State where described atom changed after verification date |
| **immutable history** | Generated decision_history.md from logs |
| **second-order atom** | Doc that describes implementations (internal term, not user-facing) |
| **ModifiedSource** | Enum indicating reliability of last-modified date (git/mtime/uncommitted/missing) |

---

## Appendix B: File Change Summary

| File | Change Type | Description |
|------|-------------|-------------|
| `.ontos-internal/atom/schema.md` | MODIFY | Add describes fields, type constraints |
| `.ontos/scripts/ontos_lib.py` | MODIFY | Add ModifiedSource enum, parsing, validation, git helpers with caching |
| `.ontos/scripts/ontos_generate_context_map.py` | MODIFY | Add staleness check, Section 5, history gen, --skip-history flag |
| `.ontos/scripts/ontos_end_session.py` | MODIFY | Add staleness warning |
| `.ontos/scripts/ontos_verify.py` | CREATE | New verification helper with --all interactive mode |
| `.ontos/scripts/ontos_consolidate.py` | MODIFY | Remove manual history editing |
| `docs/reference/Ontos_Manual.md` | MODIFY | Add staleness documentation with cookbook examples |
| `docs/reference/Ontos_Agent_Instructions.md` | MODIFY | Add verify command, STALE error |
| `docs/reference/Common_Concepts.md` | MODIFY | Add new concepts |

---

## Appendix C: Review Board Decisions

This plan was reviewed by:
- **Codex** — Raised strict mode, CI enforcement, edge cases
- **Gemini** — Approved, emphasized performance and caching
- **Claude** — Approved with changes, identified warning fatigue and 5 required changes

See `v2_7_implementation_synthesis.md` for full synthesis of reviews.

---

*End of v2.7 Implementation Plan v1.1.0*

*Approved for implementation.*
