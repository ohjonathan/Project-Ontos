---
id: v2_7_1_implementation_plan
type: strategy
status: complete
depends_on: []
concepts: [patch, fixes, documentation, config]
---

# v2.7.1 Implementation Plan

**Author:** Claude Code (Opus 4.5) as Chief Architect
**Date:** 2025-12-19
**Goal:** Polish v2.7 from A- to A grade
**Scope:** Bug fixes, documentation polish, and test organization
**Status:** APPROVED FOR IMPLEMENTATION

---

## LLM Review Board Approval

| Reviewer | Verdict | Key Feedback |
|----------|---------|--------------|
| **Claude** | ✅ APPROVE | Inline import is fine for v2.7.1; proper logging setup can be part of v2.8 Context Object refactor |
| **Codex** | ✅ APPROVE | No major blockers; stays within v4 master plan (zero-dep, local-first, no new features) |
| **Gemini** | ✅ APPROVE | Excellent, well-defined plan for a polish release; clear, concise, appropriately scoped |

### Reviewer Recommendations Incorporated

| Recommendation | Source | Resolution |
|----------------|--------|------------|
| Mark status as `active` | Codex | ✅ Done |
| Add comment explaining sys.path fix | Codex | ✅ Added to Task 1 |
| Pick canonical Common_Concepts location | Codex | ✅ Clarified as `.ontos-internal/reference/Common_Concepts.md` |
| Clarify warning format enhancement scope | Claude | ✅ Intentionally dropped (see Out of Scope) |
| Consider try/finally for sys.path | Gemini | Deferred — current fix is acceptable for config file |
| Consider pytest markers for legacy | Gemini | Deferred to v3.0 test overhaul |

---

## Executive Summary

v2.7.0 shipped successfully with all 225 tests passing. However, there is a latent bug in the root `ontos_config.py` (broken relative import) and missing documentation polish. This plan addresses these issues.

**Current State:** A- (functional, tests pass)
**Target State:** A (clean, no latent bugs, documentation complete)

---

## Issue Analysis

### Issue #1: Broken Import in Root Config

**Location:**
- `ontos_config.py` (root) line 42
- `ontos_init.py` line 133 (template source)

**Current Code:**
```python
from .ontos.scripts.ontos_config_defaults import *
```

**Problem:** Relative import (`.ontos`) only works inside a Python package. The root `ontos_config.py` is a standalone file.

**Evidence:**
```bash
$ python3 -c "import ontos_config"
ImportError: attempted relative import with no known parent package
```

**Why Tests Pass:** `tests/conftest.py` adds `.ontos/scripts` to `sys.path` before imports.

**Why Scripts Work:** Scripts use `.ontos/scripts/ontos_config.py`, not the root file.

**Impact:** Low-Medium. Users who try to import the root config directly will hit an error.

---

### Issue #2: Missing Documentation Polish

| Item | File | Status |
|------|------|--------|
| v2.7 concepts | `Common_Concepts.md` | ❌ Missing |
| Cookbook examples | `Ontos_Manual.md` | ❌ Missing |
| Exception logging | `ontos_end_session.py` | ⚠️ Silent `pass` |

---

### Issue #3: Test Organization Debt

| Problem | Files | Impact |
|---------|-------|--------|
| Version-specific naming | `test_v26_validation.py` | Creates accumulation pattern |
| One-time utility tests | `test_migrate_frontmatter.py` | Rarely executed after initial migration |

**Analysis:** The test suite (225 tests) is functional but has organizational debt:
- Version-suffixed test files suggest future `test_v27`, `test_v28`... accumulation
- Migration tests are for a one-time operation and clutter the main test run

**Scope for v2.7.1:** Minimal polish only (rename, move to legacy folder)
**Deferred to v3.0:** Comprehensive test overhaul (directory restructure, consolidation)

---

## Implementation Tasks

### Task 1: Fix Root Config Import (Priority: High)

**Files to modify:**
1. `ontos_config.py` (root)
2. `ontos_init.py` (template)

**Fix Strategy:**
Replace relative import with sys.path-based import:

```python
# Before (broken)
from .ontos.scripts.ontos_config_defaults import *

# After (working)
import sys
import os
# Note: sys.path modification is required because this file is a standalone config,
# not part of a Python package. The relative import only works inside packages.
# This pattern is safe for standalone use and idempotent (checks before inserting).
_scripts_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), '.ontos', 'scripts')
if _scripts_dir not in sys.path:
    sys.path.insert(0, _scripts_dir)
from ontos_config_defaults import *
```

**Update Required In:**
1. `ontos_config.py` line 42 — fix the current file
2. `ontos_init.py` line 133 — fix the template for future generations

**Test:**
```bash
python3 -c "import ontos_config; print('SUCCESS')"
```

---

### Task 2: Add Exception Logging (Priority: Low)

**File:** `.ontos/scripts/ontos_end_session.py`

**Current (line ~1420):**
```python
except Exception:
    pass
```

**Proposed:**
```python
except Exception as e:
    # Non-fatal: log for debugging but don't block archive
    import logging
    logging.debug(f"Staleness check skipped: {e}")
```

**Rationale:** Silent failures make debugging difficult.

---

### Task 3: Update Common_Concepts.md (Priority: Low)

**File:** `.ontos-internal/reference/Common_Concepts.md` (canonical location for Project Ontos)

**Note:** Per Codex review, use `.ontos-internal/reference/` as the canonical location to avoid split-brain with `docs/reference/`.

**Add rows to concepts table:**

| Concept | Definition |
|---------|------------|
| `describes` | Documentation relationship tracking - marks which atoms a doc describes (v2.7) |
| `staleness` | Detection of outdated documentation when described atoms change (v2.7) |
| `immutable-history` | Auto-generated decision_history.md from session logs (v2.7) |

---

### Task 4: Add Cookbook Examples to Manual (Priority: Low)

**File:** `docs/reference/Ontos_Manual.md`

**Add new section after Scripts Reference:**

```markdown
## Documentation Staleness Tracking (v2.7)

Track when documentation becomes outdated after code changes.

### Adding Staleness Tracking

Add `describes` to your documentation frontmatter:

​```yaml
---
id: my_readme
type: atom
describes:
  - cli_module
  - api_handler
describes_verified: 2025-12-19
---
​```

### Checking for Stale Docs

Staleness is checked automatically:
- When generating context map (Section 5: Staleness Audit)
- When archiving sessions (Archive Ontos warning)

### Marking Documentation Current

After reviewing and updating your docs:

​```bash
# Single file
python3 .ontos/scripts/ontos_verify.py docs/readme.md

# All stale docs interactively
python3 .ontos/scripts/ontos_verify.py --all
​```

### Example: Documentation Chain

​```yaml
# Manual describes scripts
# docs/reference/Ontos_Manual.md
describes:
  - ontos_end_session
  - ontos_verify
describes_verified: 2025-12-19

# Agent Instructions describes Manual
# docs/reference/Ontos_Agent_Instructions.md
describes:
  - ontos_manual
describes_verified: 2025-12-19
​```
```

---

### Task 5: Rename Version-Specific Test File (Priority: Low)

**File:** `tests/test_v26_validation.py`

**Action:** Rename to `tests/test_validation.py`

```bash
git mv tests/test_v26_validation.py tests/test_validation.py
```

**Rationale:** Prevents accumulation of `test_v27_validation.py`, `test_v28_validation.py`, etc. The validation logic is not version-specific — it validates status values which are ongoing.

**Update Required:** None — pytest discovers tests by function name, not file name.

---

### Task 6: Move Migration Tests to Legacy (Priority: Low)

**File:** `tests/test_migrate_frontmatter.py`

**Action:** Move to `tests/legacy/` directory

```bash
mkdir -p tests/legacy
git mv tests/test_migrate_frontmatter.py tests/legacy/
touch tests/legacy/__init__.py
```

**Rationale:** Migration is a one-time operation. These tests are rarely needed but shouldn't be deleted (in case migration script is reused).

**CI Impact:**
- Default `pytest tests/` will still run legacy tests (no exclusion needed for v2.7.1)
- Future v3.0 can exclude legacy: `pytest tests/ --ignore=tests/legacy/`

---

## Implementation Order

| Order | Task | Effort | Risk |
|-------|------|--------|------|
| 1 | Fix root config import | 10 min | Low |
| 2 | Fix ontos_init.py template | 5 min | Low |
| 3 | Add exception logging | 5 min | None |
| 4 | Update Common_Concepts.md | 5 min | None |
| 5 | Add cookbook examples | 15 min | None |
| 6 | Rename test_v26_validation.py | 5 min | Low |
| 7 | Move migration tests to legacy | 5 min | Low |

**Total estimated effort:** ~50 minutes

---

## Testing Requirements

### Before PR

1. **Import test:**
   ```bash
   python3 -c "import ontos_config; print('Root config imports successfully')"
   ```

2. **Init test:**
   ```bash
   cd /tmp && mkdir test_ontos && cd test_ontos
   python3 /path/to/ontos_init.py
   python3 -c "import ontos_config; print('Generated config imports successfully')"
   ```

3. **Full test suite:**
   ```bash
   python3 -m pytest tests/ -v
   # Expected: 225/225 pass
   ```

4. **Scripts still work:**
   ```bash
   python3 .ontos/scripts/ontos_generate_context_map.py --help
   python3 .ontos/scripts/ontos_verify.py --help
   ```

---

## Success Criteria

v2.7.1 is complete when:

1. ✅ `python3 -c "import ontos_config"` succeeds
2. ✅ Newly generated configs via `ontos_init.py` import correctly
3. ✅ All 225 tests still pass
4. ✅ Exception logging added to staleness check
5. ✅ Common_Concepts.md has v2.7 terms
6. ✅ Manual has cookbook examples for describes
7. ✅ `test_v26_validation.py` renamed to `test_validation.py`
8. ✅ Migration tests moved to `tests/legacy/`

**Grade after v2.7.1:** A

---

## Out of Scope

- schema.md updates (deferred to v2.9)
- Performance benchmarks (informal testing sufficient)
- New features (bug fixes only)
- Warning format enhancement (from patch_plan Task 5 — intentionally dropped as low priority)
- try/finally cleanup for sys.path (Gemini suggestion — current fix acceptable for config file)
- pytest markers for legacy tests (Gemini suggestion — deferred to v3.0)
- Comprehensive test overhaul (deferred to v3.0)
  - Directory restructure (core/, features/, scripts/, hooks/)
  - Hook test consolidation (26 tests → fewer)
  - Test deduplication audit

---

## Rollback Plan

If issues arise:
1. Revert to relative import (broken but doesn't affect scripts)
2. All scripts continue to work regardless

Risk is minimal since the root config file is not used by any scripts.

---

*End of v2.7.1 Implementation Plan*
