---
id: v2_8_implementation_plan_review_codex
type: strategy
status: draft
depends_on: [v2_8_implementation_plan]
---

# Review: v2.8 Implementation Plan (Context Object Refactor + Unified CLI)

Source: `.ontos-internal/strategy/proposals/v2.8/v2.8_implementation_plan.md` (v1.0.0 Draft, 2025-12-20).

## Findings
- **Transactions/locking underspecified:** `SessionContext.commit()` writes sequentially without a locking strategy or rollback-on-failure plan. This risks partial writes and violates the “transaction boundary” watch-out from the master plan.
- **Subprocess abstraction unresolved:** Git calls remain in “core” with Q1 open. Without an injection point (provider/callback), purity and MCP/testability stay shaky.
- **CLI location/deprecation unclear:** Where `ontos.py` lives and when to warn on direct scripts/imports is undecided; a sloppy choice can confuse users or delay migration.
- **Package name collision risk:** Introducing an `ontos/` package under `.ontos/scripts` could shadow/fight the future PyPI package unless import precedence is controlled.
- **Locking approach (Q10) conflicts with zero-dep:** `filelock` would break the V2.x invariant; no stdlib cross-platform approach is selected yet.
- **Commit API limits:** Pending writes only handle text writes/delete/move; no binary/chmod support, no staged atomic rename, and errors aren’t surfaced cleanly to callers.
- **Tests/coverage gaps:** No committed plan to test commit/rollback under contention, CLI alias/help behavior, or staleness/history with injected git provider.

## Suggestions
- **Transactions/locking:** Use a stdlib lock file (PID + atomic `os.open(..., O_EXCL)`) with fail-fast on contention; stage to temp + rename for atomic writes where feasible; ensure commit either completes or raises before partial application.
- **Subprocess abstraction:** Pick a light abstraction (callbacks or small `GitProvider`) and inject into staleness/history to keep core testable and MCP-ready without over-engineering.
- **CLI placement/deprecation:** Place `ontos.py` at repo root (primary) with an optional wrapper in `.ontos/scripts`; v2.8 silent, v2.9 emit DeprecationWarning for direct scripts/imports, v3.0 hard switch. Filter warnings in tests to avoid noise.
- **Package naming/imports:** Consider `ontos_core`/`ontos_local` internally or explicitly manage `sys.path` so local package and future PyPI package don’t shadow each other; document intended import precedence.
- **Commit API polish:** Support binary writes and chmod where needed; surface errors to callers; capture env/cwd in context per master plan for reproducibility.
- **Testing:** Add regression for CLI dispatch (aliases, help exit codes), commit/rollback with lock contention, and staleness/history using an injected git provider. Ensure zero-dep remains intact.

## Alignment with Master Plan
- Matches v2.8 roadmap items (Context Object Refactor, Unified CLI) and core invariants (zero-dep V2.x, functional core/imperative shell, local-first). Tightening locking, subprocess abstraction, and deprecation cadence will better enforce the “transaction boundary” and pave the v2.8 → v3.0 transition.
