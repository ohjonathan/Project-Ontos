---
id: v3_1_0_implementation_spec
type: strategy
status: draft
depends_on: [v3_0_5_implementation_spec, v3_1_0_implementation_plan, v3_1_tech_debt_wrapper_commands]
concepts: [implementation-spec, native-migration, obsidian, token-efficiency, wrapper-commands]
---

# Ontos v3.1.0 Implementation Spec

**Version:** 1.0
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-20
**Status:** Draft — Pending Review

---

## 1. Executive Summary

v3.1.0 is a **major feature release** combining two workstreams:

| Track | Theme | Deliverables |
|-------|-------|--------------|
| **A** | Obsidian Compatibility + Token Efficiency | `--obsidian`, `--compact`, `--filter`, caching |
| **B** | Native Command Migration | 7 wrapper commands → native implementations |

**Impact Summary:**

| Category | Count | Action |
|----------|-------|--------|
| New Files | ~12 | Command modules, cache, obsidian utilities, tests |
| Modified Files | ~8 | `cli.py`, `frontmatter.py`, `map.py`, `README.md`, etc. |
| Lines Changed | ~2,000+ | New implementations + tests |
| Known Issues Resolved | 7 | All wrapper command issues |

---

## 2. Scope Items Overview

### Track A: Obsidian Compatibility + Token Efficiency

| ID | Feature | Priority | Effort | Summary |
|----|---------|----------|--------|---------|
| OBS-1 | `tags` field | P0 | Low | Mirror `concepts` for Obsidian tag pane |
| OBS-2 | `aliases` field | P0 | Low | Alternative names for wikilink resolution |
| OBS-3 | `--obsidian` flag | P0 | Medium | Enable Obsidian output mode |
| OBS-4 | Wikilink output | P0 | Medium | `[[doc_id]]` format in context map |
| TOK-1 | Document cache | P0 | Medium | mtime-based invalidation for faster `ontos map` |
| TOK-2 | `--compact` flag | P0 | Medium | 30-50% token reduction in output |
| TOK-3 | `--filter` flag | P1 | Medium | Selective document loading |
| ERR-1 | YAML error messages | P0 | Low | Actionable parse errors with line numbers |

### Track B: Native Command Migration

| ID | Command | Priority | Effort | Current Issue |
|----|---------|----------|--------|---------------|
| CMD-1 | `scaffold` | P0 | Low | ❌ Broken: rejects positional arguments |
| CMD-2 | `verify` | P0 | Medium | ⚠️ Limited: lacks positional argument support |
| CMD-3 | `query` | P0 | Medium | ⚠️ Limited: requires legacy flags |
| CMD-4 | `consolidate` | P1 | Low | ⚠️ Limited: requires specific file |
| CMD-5 | `stub` | P1 | Low | ✅ Working (subprocess overhead) |
| CMD-6 | `promote` | P1 | Low | ✅ Working (subprocess overhead) |
| CMD-7 | `migrate` | P1 | Medium | ✅ Working (subprocess overhead) |

---

## 3. Track A: Exact Code Changes

### 3.1 OBS-1/OBS-2: Tags and Aliases Fields

**File:** `ontos/core/frontmatter.py`

**New Functions:**
```python
def normalize_tags(frontmatter: dict) -> list[str]:
    """Extract tags from frontmatter, merging concepts + explicit tags.

    Priority:
    1. Explicit 'tags' field (if present)
    2. 'concepts' field (Ontos standard)

    Returns:
        List of unique tag strings, sorted alphabetically.
    """
    tags = set()

    if 'tags' in frontmatter:
        raw_tags = frontmatter['tags']
        if isinstance(raw_tags, list):
            tags.update(str(t) for t in raw_tags if t)
        elif isinstance(raw_tags, str):
            tags.add(raw_tags)

    if 'concepts' in frontmatter:
        concepts = frontmatter['concepts']
        if isinstance(concepts, list):
            tags.update(str(c) for c in concepts if c)

    return sorted(tags)


def normalize_aliases(frontmatter: dict, doc_id: str) -> list[str]:
    """Extract aliases from frontmatter, auto-generating from id.

    Returns:
        List of alias strings including auto-generated variants.
    """
    aliases = set()

    if 'aliases' in frontmatter:
        raw = frontmatter['aliases']
        if isinstance(raw, list):
            aliases.update(str(a) for a in raw if a)
        elif isinstance(raw, str):
            aliases.add(raw)

    # Auto-generate aliases from id
    if doc_id:
        # snake_case → Title Case
        aliases.add(doc_id.replace('_', ' ').title())
        # snake_case → kebab-case
        aliases.add(doc_id.replace('_', '-'))

    return sorted(aliases)
```

---

### 3.2 OBS-3/OBS-4: Obsidian Mode for Map Command

**File:** `ontos/commands/map.py`

**CLI Flag Addition:**
```python
# In _register_map() in cli.py
p.add_argument("--obsidian", action="store_true",
               help="Enable Obsidian-compatible output (wikilinks, tags)")
```

**Options Update:**
```python
@dataclass
class MapOptions:
    output: Optional[Path] = None
    strict: bool = False
    json_output: bool = False
    quiet: bool = False
    obsidian: bool = False  # NEW
    compact: bool = False   # NEW (TOK-2)
    filter: Optional[str] = None  # NEW (TOK-3)
```

**Wikilink Output Logic:**
```python
def _format_doc_link(doc_id: str, obsidian_mode: bool) -> str:
    """Format document link based on output mode."""
    if obsidian_mode:
        return f"[[{doc_id}]]"
    return f"`{doc_id}`"
```

---

### 3.3 TOK-1: Document Cache

**File:** `ontos/core/cache.py` (NEW)

```python
"""Document caching with mtime-based invalidation."""
from dataclasses import dataclass, field
from pathlib import Path
from typing import Dict, Optional, Tuple, Any
import time


@dataclass
class CacheEntry:
    """Single cache entry with metadata."""
    mtime: float
    data: Any


@dataclass
class DocumentCache:
    """In-memory document cache with mtime invalidation.

    Usage:
        cache = DocumentCache()

        # Check cache
        if (cached := cache.get(path)) is not None:
            return cached

        # Parse and store
        data = parse_document(path)
        cache.set(path, data)
        return data
    """
    _entries: Dict[Path, CacheEntry] = field(default_factory=dict)
    _hits: int = 0
    _misses: int = 0

    def get(self, path: Path) -> Optional[Any]:
        """Get cached document if mtime unchanged."""
        path = path.resolve()

        if path not in self._entries:
            self._misses += 1
            return None

        entry = self._entries[path]
        try:
            current_mtime = path.stat().st_mtime
            if current_mtime == entry.mtime:
                self._hits += 1
                return entry.data
        except OSError:
            pass

        # Invalidated
        del self._entries[path]
        self._misses += 1
        return None

    def set(self, path: Path, data: Any) -> None:
        """Store document in cache."""
        path = path.resolve()
        try:
            mtime = path.stat().st_mtime
            self._entries[path] = CacheEntry(mtime=mtime, data=data)
        except OSError:
            pass  # Don't cache if we can't stat

    def invalidate(self, path: Path) -> None:
        """Remove specific path from cache."""
        path = path.resolve()
        self._entries.pop(path, None)

    def clear(self) -> None:
        """Clear entire cache."""
        self._entries.clear()
        self._hits = 0
        self._misses = 0

    @property
    def stats(self) -> dict:
        """Return cache statistics."""
        total = self._hits + self._misses
        return {
            "entries": len(self._entries),
            "hits": self._hits,
            "misses": self._misses,
            "hit_rate": self._hits / total if total > 0 else 0.0,
        }
```

---

### 3.4 TOK-2: Compact Output Format

**File:** `ontos/commands/map.py`

**Compact Format Implementation:**
```python
def _generate_compact_output(docs: Dict[str, Document], rich: bool = False) -> str:
    """Generate compact context map format.

    Standard compact: id:type:status
    Rich compact: id:type:status:"summary"

    Args:
        docs: Document dictionary
        rich: Include summary field if True

    Returns:
        Compact format string, one doc per line
    """
    lines = []
    for doc_id, doc in sorted(docs.items()):
        if rich and doc.summary:
            lines.append(f'{doc_id}:{doc.type}:{doc.status}:"{doc.summary}"')
        else:
            lines.append(f'{doc_id}:{doc.type}:{doc.status}')
    return '\n'.join(lines)
```

**CLI Flag:**
```python
p.add_argument("--compact", nargs="?", const=True, default=False,
               help="Compact output format (use --compact=rich for summaries)")
```

---

### 3.5 ERR-1: Better YAML Error Messages

**File:** `ontos/core/frontmatter.py`

```python
@dataclass
class FrontmatterParseError:
    """Structured YAML parse error with location."""
    filepath: str
    line: int
    column: int
    message: str
    suggestion: Optional[str] = None

    def __str__(self) -> str:
        loc = f"{self.filepath}:{self.line}:{self.column}"
        msg = f"{loc}: {self.message}"
        if self.suggestion:
            msg += f"\n  Suggestion: {self.suggestion}"
        return msg


def parse_frontmatter_safe(content: str, filepath: str = "<string>") -> Tuple[dict, list]:
    """Parse frontmatter with detailed error reporting.

    Returns:
        Tuple of (frontmatter_dict, list of FrontmatterParseError)
    """
    errors = []
    # ... implementation with error collection
    return frontmatter, errors
```

---

## 4. Track B: Native Command Implementations

### 4.1 CMD-1: scaffold (CRITICAL)

**File:** `ontos/commands/scaffold.py` (NEW)

**Purpose:** Add Ontos frontmatter to untagged markdown files

**Options:**
```python
@dataclass
class ScaffoldOptions:
    path: Optional[Path] = None  # File or directory (positional)
    dry_run: bool = False
    interactive: bool = True
    json_output: bool = False
    quiet: bool = False
```

**CLI Registration:**
```python
def _register_scaffold(subparsers, parent):
    """Register scaffold command."""
    p = subparsers.add_parser("scaffold", help="Add frontmatter to markdown files", parents=[parent])
    p.add_argument("path", nargs="?", type=Path,
                   help="File or directory to scaffold")
    p.add_argument("--dry-run", action="store_true",
                   help="Show what would be changed without modifying files")
    p.add_argument("--yes", "-y", action="store_true",
                   help="Non-interactive mode")
    p.set_defaults(func=_cmd_scaffold)
```

**Core Logic:** Extract and refactor from `ontos/_scripts/ontos_scaffold.py`

**Key Functions:**
- `find_untagged_files(path: Path) -> List[Path]`
- `scaffold_file(path: Path, dry_run: bool) -> bool`
- `scaffold_command(options: ScaffoldOptions) -> Tuple[int, str]`

---

### 4.2 CMD-2: verify

**File:** `ontos/commands/verify.py` (enhance existing)

**Options:**
```python
@dataclass
class VerifyOptions:
    path: Optional[Path] = None  # Specific file (positional)
    all: bool = False            # Verify all stale
    days: int = 30               # Staleness threshold
    interactive: bool = True
    json_output: bool = False
    quiet: bool = False
```

**CLI Registration:**
```python
def _register_verify(subparsers, parent):
    p = subparsers.add_parser("verify", help="Verify document describes dates", parents=[parent])
    p.add_argument("path", nargs="?", type=Path,
                   help="Specific file to verify")
    p.add_argument("--all", "-a", action="store_true",
                   help="Verify all stale documents")
    p.add_argument("--days", "-d", type=int, default=30,
                   help="Staleness threshold in days (default: 30)")
    p.set_defaults(func=_cmd_verify)
```

---

### 4.3 CMD-3: query

**File:** `ontos/commands/query.py` (NEW)

**Options:**
```python
@dataclass
class QueryOptions:
    depends_on: Optional[str] = None
    depended_by: Optional[str] = None
    concept: Optional[str] = None
    stale: Optional[int] = None
    health: bool = False
    list_ids: bool = False
    json_output: bool = False
    quiet: bool = False
```

**CLI Registration:**
```python
def _register_query(subparsers, parent):
    p = subparsers.add_parser("query", help="Query document graph", parents=[parent])
    p.add_argument("--depends-on", metavar="ID",
                   help="Show dependencies of document")
    p.add_argument("--depended-by", metavar="ID",
                   help="Show documents that depend on this")
    p.add_argument("--concept", metavar="TAG",
                   help="Find documents with concept")
    p.add_argument("--stale", metavar="DAYS", type=int,
                   help="Find documents older than N days")
    p.add_argument("--health", action="store_true",
                   help="Show graph health metrics")
    p.add_argument("--list-ids", action="store_true",
                   help="List all document IDs")
    p.set_defaults(func=_cmd_query)
```

---

### 4.4 CMD-4: consolidate

**File:** `ontos/commands/consolidate.py` (NEW)

**Options:**
```python
@dataclass
class ConsolidateOptions:
    keep: int = 15               # Number of logs to keep
    dry_run: bool = False
    json_output: bool = False
    quiet: bool = False
```

---

### 4.5 CMD-5: stub

**File:** `ontos/commands/stub.py` (NEW)

**Options:**
```python
@dataclass
class StubOptions:
    doc_type: str = "reference"
    id: Optional[str] = None
    output: Optional[Path] = None
    interactive: bool = True
    json_output: bool = False
    quiet: bool = False
```

---

### 4.6 CMD-6: promote

**File:** `ontos/commands/promote.py` (NEW)

**Options:**
```python
@dataclass
class PromoteOptions:
    path: Optional[Path] = None
    interactive: bool = True
    json_output: bool = False
    quiet: bool = False
```

---

### 4.7 CMD-7: migrate

**File:** `ontos/commands/migrate.py` (NEW)

**Options:**
```python
@dataclass
class MigrateOptions:
    path: Optional[Path] = None
    check: bool = False
    dry_run: bool = False
    apply: bool = False
    json_output: bool = False
    quiet: bool = False
```

---

## 5. Configuration Additions

### 5.1 `.ontos.toml` Schema Updates

```toml
[obsidian]
enabled = false              # Opt-in to Obsidian mode
generate_tags = true         # Mirror concepts → tags
generate_aliases = true      # Auto-generate from id
wikilink_format = true       # [[wikilinks]] in output

[frontmatter]
preserve_unknown_fields = true  # Keep Jekyll/Hugo fields

[validation]
yaml_mode = "standard"       # lenient | standard | strict

[performance]
cache_enabled = true         # Document caching
parallel_loading = false     # Concurrent file scanning
```

---

## 6. Files Summary

### New Files

| File | Purpose |
|------|---------|
| `ontos/core/cache.py` | Document cache with mtime invalidation |
| `ontos/io/obsidian.py` | Wikilink utilities, vault detection |
| `ontos/commands/scaffold.py` | Native scaffold implementation |
| `ontos/commands/query.py` | Native query implementation |
| `ontos/commands/consolidate.py` | Native consolidate implementation |
| `ontos/commands/stub.py` | Native stub implementation |
| `ontos/commands/promote.py` | Native promote implementation |
| `ontos/commands/migrate.py` | Native migrate implementation |
| `tests/core/test_cache.py` | Cache unit tests |
| `tests/test_obsidian.py` | Obsidian unit tests |
| `tests/commands/test_scaffold.py` | Scaffold tests |
| `tests/commands/test_query.py` | Query tests |

### Modified Files

| File | Changes |
|------|---------|
| `ontos/core/frontmatter.py` | `normalize_tags()`, `normalize_aliases()`, `FrontmatterParseError` |
| `ontos/commands/map.py` | `--obsidian`, `--compact`, `--filter` flags, cache integration |
| `ontos/commands/verify.py` | Enhance to full native implementation |
| `ontos/cli.py` | Update all command registrations |
| `README.md` | Remove Known Issues section |

---

## 7. Implementation Order

### Phase 1: Critical Fixes (Week 1)

| Priority | Item | Effort |
|----------|------|--------|
| P0 | CMD-1: `scaffold` native | Low |
| P0 | CMD-2: `verify` native | Medium |
| P0 | OBS-1/2: Tags & aliases | Low |

### Phase 2: Core Features (Week 2)

| Priority | Item | Effort |
|----------|------|--------|
| P0 | CMD-3: `query` native | Medium |
| P0 | CMD-4: `consolidate` native | Low |
| P0 | TOK-1: Document cache | Medium |
| P0 | OBS-3/4: `--obsidian` flag | Medium |

### Phase 3: Remaining Commands (Week 3)

| Priority | Item | Effort |
|----------|------|--------|
| P1 | CMD-5: `stub` native | Low |
| P1 | CMD-6: `promote` native | Low |
| P1 | CMD-7: `migrate` native | Medium |
| P0 | TOK-2: `--compact` flag | Medium |

### Phase 4: Polish (Week 4)

| Priority | Item | Effort |
|----------|------|--------|
| P1 | TOK-3: `--filter` flag | Medium |
| P0 | ERR-1: YAML error messages | Low |
| P1 | Obsidian auto-detection | Low |
| - | Documentation updates | Low |

---

## 8. Verification Protocol

### 8.1 Track A Verification

```bash
# Obsidian mode
ontos map --obsidian
# Verify: wikilinks in output, tags normalized

# Compact output
ontos map --compact
wc -c Ontos_Context_Map.md  # Should be 30-50% smaller

ontos map --compact=rich
# Verify: summaries included

# Caching
time ontos map  # First run
time ontos map  # Second run (should be <100ms)

# Filtering
ontos map --filter "type:strategy"
# Verify: only strategy docs in output
```

### 8.2 Track B Verification

```bash
# scaffold (CRITICAL - currently broken)
ontos scaffold docs/ --dry-run
ontos scaffold docs/new_file.md
# Verify: positional argument works

# verify
ontos verify docs/some_file.md
ontos verify --all --days 30
# Verify: positional argument works

# query
ontos query --health
ontos query --depends-on some_doc_id
ontos query --concept auth
# Verify: all query modes work

# consolidate
ontos consolidate --dry-run
# Verify: works without decision_history.md requirement

# stub
ontos stub --type reference
# Verify: generates stub

# promote
ontos promote
# Verify: interactive flow works

# migrate
ontos migrate --check
# Verify: schema check works
```

### 8.3 Full Test Suite

```bash
pytest tests/ -v
# Expected: All tests pass, >90% coverage on new code
```

---

## 9. Risk Assessment

**Overall Risk: MEDIUM**

| Risk Factor | Assessment | Mitigation |
|-------------|------------|------------|
| Scope size | Large (2 tracks) | Clear phase boundaries |
| Breaking changes | Low | Native commands preserve behavior |
| Regression | Medium | Comprehensive tests |
| Timeline | 4 weeks | Prioritized implementation order |

---

## 10. Success Criteria

### Track A
- [ ] `ontos map --obsidian` generates wikilinks
- [ ] `ontos map --compact` produces 30-50% smaller output
- [ ] `ontos map --filter "type:strategy"` works
- [ ] Cache improves repeat `ontos map` to <100ms
- [ ] YAML errors include line numbers

### Track B
- [ ] All 7 commands work as native implementations
- [ ] `ontos scaffold docs/` accepts positional argument
- [ ] `ontos verify file.md` accepts positional argument
- [ ] All existing functionality preserved
- [ ] `.ontos.toml` configuration honored
- [ ] No subprocess/PYTHONPATH manipulation

### Quality
- [ ] Test coverage >90% for new code
- [ ] README Known Issues section cleared or "No known issues"
- [ ] All golden master tests pass

---

## 11. Post-Release

### Documentation Updates
- [ ] Update README.md (remove Known Issues)
- [ ] Update Ontos_Manual.md with new flags
- [ ] Update CHANGELOG.md

### Cleanup
- [ ] Deprecate legacy scripts (add warnings)
- [ ] Consider removing `ontos/_scripts/` in v3.2

---

*Chief Architect (Claude Opus 4.5) — 2026-01-20*
