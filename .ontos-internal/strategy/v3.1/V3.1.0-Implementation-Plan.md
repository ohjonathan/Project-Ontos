---
id: v3_1_0_implementation_plan
type: strategy
status: draft
depends_on: [v3_0_implementation_roadmap, v3_1_0_obsidian_compatibility_spec, v3_1_0_sidecar_pattern]
concepts: [obsidian, performance, tokens, compatibility, yaml, caching, sidecar]
---

# v3.1.0 Implementation Plan

**Theme:** "Document Compatibility & Token Efficiency"
**Status:** DRAFT - Pending Approval
**Date:** 2026-01-18
**Author:** Chief Architect (Claude Opus 4.5)
**Prerequisite:** v3.0.2 CLI fixes complete

---

## 1. Theme Statement

v3.1 enhances Ontos's document processing foundation with two goals:

1. **Cross-Tool Compatibility** - Work seamlessly with Obsidian, Jekyll, Hugo, mkdocs, and other markdown ecosystems
2. **Token Efficiency** - Reduce context consumption for AI agents through caching, selective loading, and compact output formats

---

## 2. P0: Must Have

### 2.1 Obsidian Compatibility

| Feature | Description | Tokens Saved |
|---------|-------------|--------------|
| `tags` field | Mirror `concepts` for Obsidian | N/A |
| `aliases` field | Alternative names for linking | N/A |
| `--obsidian` flag | CLI flag for `ontos map` | N/A |
| Wikilink output | `[[doc_id]]` in Context Map | ~5% smaller |

**Files:**
- `ontos/core/frontmatter.py` - Add `normalize_tags()`, `normalize_aliases()`
- `ontos/commands/map.py` - Add `--obsidian` flag, wikilink output
- `ontos/io/obsidian.py` (NEW) - Wikilink utilities, vault detection
- `tests/test_obsidian.py` (NEW)

### 2.2 Document Cache

In-memory cache with mtime-based invalidation. Eliminates re-parsing unchanged documents.

**Token Benefit:** Faster `ontos map` means faster agent bootstrap.

**Files:**
- `ontos/core/cache.py` (NEW) - `DocumentCache` class with mtime invalidation
- `ontos/commands/map.py` - Integrate cache

```python
@dataclass
class DocumentCache:
    """In-memory document cache."""
    _cache: Dict[Path, Tuple[float, DocumentData]]

    def get(self, path: Path) -> Optional[DocumentData]:
        """Return cached doc if mtime unchanged."""

    def invalidate(self, path: Path) -> None: ...
    def clear(self) -> None: ...
```

### 2.3 Better YAML Error Messages

Replace opaque `YAMLError` with actionable messages.

**Files:**
- `ontos/core/frontmatter.py` - Add `FrontmatterParseError`

```python
@dataclass
class FrontmatterParseError:
    filepath: str
    line: int
    column: int
    message: str
    suggestion: str  # "Did you mean 'status: active'?"
```

### 2.4 Compact Context Map Format

New `--compact` flag for token-efficient output. Supports levels of detail for different agent needs.

**Token Benefit:** 30-50% smaller context map for AI consumption.

**Modes:**
1. **Standard:** (Default) Markdown table. ~2.5 tokens/doc.
2. **Compact:** (`--compact`) `id:type:status`. ~1.5 tokens/doc.
3. **Rich:** (`--compact=rich`) `id:type:status:"Summary string"`. ~4 tokens/doc. Enables "Scanner" agents to filter without reading files.

**Format Examples:**
```text
# Compact
auth:atom:active

# Rich
auth:atom:active:"Handles user authentication and session management."
```

**Files:**
- `ontos/commands/map.py` - Add `--compact` flag (bool or string)
- `ontos/ui/output.py` - Compact formatter with 'rich' support

---

## 3. P1: Should Have

### 3.1 Obsidian Auto-Detection

Prompt to enable Obsidian mode when `.obsidian/` folder detected.

### 3.2 Progressive Validation Modes

Three-tier validation for different use cases:

| Mode | Behavior | Use Case |
|------|----------|----------|
| `lenient` | Best-effort, warn only | Quick iteration |
| `standard` | Balanced | Normal usage |
| `strict` | Error on issues | CI/CD |

**Config:**
```toml
[validation]
yaml_mode = "standard"
```

### 3.3 Cross-Tool Field Preservation

Preserve non-Ontos fields for other tools:

```toml
[frontmatter]
preserve_unknown_fields = true  # Default
```

Preserved fields: `date`, `title`, `categories`, `layout`, `nav`

### 3.4 Standardized Summary Field

Formalize `summary` field in frontmatter to support "Rich Compact Map" and Agent scanning.

**Action:**
- Update `ontos/templates/common_concepts_template.md` and others to include `summary`.
- Update `ontos/core/frontmatter.py` to prioritize `summary` or `description` fields.

### 3.5 Selective Document Loading

`--filter` flag to load only relevant docs, reducing tokens.

**Token Benefit:** Load 5 docs instead of 377.

```bash
# Load only strategy docs
ontos map --filter "type:strategy"

# Load docs matching concept
ontos map --filter "concept:auth"
```

**Files:**
- `ontos/commands/map.py` - Add `--filter` flag
- `ontos/core/query.py` - Filter logic

### 3.6 IO-Efficient Frontmatter Parsing

Optimize file reading to read *only* the header (lines between `---`) when scanning, avoiding full file I/O for `ontos map`.

**Implementation:**
- Update `parse_frontmatter` to read line-by-line until second `---`.
- Fallback to full read only if parsing fails or body is needed.

### 3.7 Parallel File Loading

Optional concurrent scanning with `concurrent.futures`.

```toml
[performance]
parallel_loading = true  # Default: false
```

---

## 4. Token Efficiency Summary

| Optimization | Token Reduction | Implementation |
|--------------|-----------------|----------------|
| Compact context map | 30-50% | `--compact` flag |
| Selective loading | 80-95% | `--filter` flag |
| Wikilink format | ~5% | `--obsidian` flag |
| Document caching | N/A (speed) | `DocumentCache` |
| **Lazy/Partial IO** | N/A (IO/Memory) | `frontmatter.py` update |

**Example:**
- Full context map (377 docs): ~15,000 tokens
- Compact format: ~9,000 tokens (40% reduction)
- Filtered to 10 docs: ~400 tokens (97% reduction)

---

## 5. P2: Nice to Have / Deferred

| Feature | Target |
|---------|--------|
| mkdocs `nav` field passthrough | v3.1 if time |
| CommonMark link validation | v3.2 |
| Unicode normalization | v3.2 |
| Parallel `doctor` checks | v3.2 |
| Performance benchmark suite | v3.2 |
| `ontos watch` command | v4.0 |
| Retrofit existing 314 docs | v3.2 |

---

## 6. Out of Scope

| Feature | Reason | Target |
|---------|--------|--------|
| Wikilinks in doc body | Content transformation | v3.2+ |
| MCP integration | Per roadmap | v3.2+ |
| Daemon mode | v4.0 architecture | v4.0 |
| Real-time sync | Anti-scope | Never |

---

## 7. Configuration Additions

### 7.1 `.ontos.toml` Changes

```toml
[obsidian]
enabled = false              # Opt-in
generate_tags = true         # Mirror concepts â†’ tags
generate_aliases = true      # Auto-generate from id
wikilink_format = true       # [[wikilinks]] in output

[frontmatter]
preserve_unknown_fields = true  # Keep Jekyll/Hugo fields

[validation]
yaml_mode = "standard"       # lenient | standard | strict

[performance]
parallel_loading = false     # Concurrent file scanning
lazy_parsing = true          # Read headers only when possible
```

---

## 8. Success Criteria

### 8.1 Functional

| Criterion | Verification |
|-----------|--------------|
| `ontos map --obsidian` generates wikilinks | Golden master |
| Tags appear in Obsidian tag pane | Manual test |
| `ontos map --compact` produces smaller output | Token count |
| `ontos map --compact=rich` includes summaries | Output check |
| `ontos map --filter` loads subset | Unit tests |
| Standard mode unchanged | Golden master |
| Malformed YAML produces helpful errors | Unit tests |

### 8.2 Performance

| Operation | v3.0 | v3.1 Target |
|-----------|------|-------------|
| `ontos map` (<100 docs) | <500ms | <300ms |
| `ontos map` (cached) | N/A | <100ms |
| `ontos doctor` | <1s | <500ms |

### 8.3 Token Efficiency

| Scenario | v3.0 | v3.1 Target |
|----------|------|-------------|
| Full context map (377 docs) | ~15k tokens | ~9k (compact) |
| Filtered load (10 docs) | N/A | ~400 tokens |

### 8.4 Quality

- Test coverage >90% (new code)
- Golden master: all tests pass
- Docs updated: README, Ontos_Manual.md

---

## 9. Implementation Sequence

### Week 1: Obsidian Core & Efficiency Foundation

- [ ] `normalize_tags()`, `normalize_aliases()` in frontmatter.py
- [ ] **IO-Efficient Partial Parsing** in frontmatter.py
- [ ] `--obsidian` flag in map.py
- [ ] Wikilink output format
- [ ] Unit tests for Obsidian

### Week 2: Caching & Compact Output

- [ ] `DocumentCache` class in cache.py
- [ ] Integrate cache in map.py
- [ ] `--compact` flag (and `rich` mode) for context map
- [ ] Compact formatter in output.py
- [ ] **Standardize `summary` field** in templates

### Week 3: Filtering & Errors

- [ ] `--filter` flag in map.py
- [ ] Filter logic in query.py
- [ ] `FrontmatterParseError` with locations
- [ ] Better error messages

### Week 4: Polish & Performance

- [ ] Obsidian auto-detection
- [ ] Progressive validation modes
- [ ] Cross-tool field preservation
- [ ] Optional parallel loading

---

## 10. Verification Commands

```bash
# Run tests
pytest tests/test_obsidian.py -v
pytest tests/core/test_cache.py -v
pytest tests/golden/ -v

# Test Obsidian mode
ontos map --obsidian
# Verify wikilinks in Ontos_Context_Map.md

# Test compact mode (token efficiency)
ontos map --compact
ontos map --compact=rich # Verify summaries
wc -c Ontos_Context_Map.md  # Compare size

# Test filtering (token efficiency)
ontos map --filter "type:strategy" --compact
# Should output only strategy docs

# Test caching (performance)
time ontos map  # First run
time ontos map  # Second run (should be <100ms)

# Test error messages
# Create file with malformed YAML, verify helpful error
```

---

## 11. Key Files to Modify

| File | Changes |
|------|---------|
| `ontos/core/frontmatter.py` | `normalize_tags()`, `normalize_aliases()`, `FrontmatterParseError`, **IO optimization** |
| `ontos/core/cache.py` (NEW) | `DocumentCache` class |
| `ontos/core/query.py` | Filter logic for `--filter` |
| `ontos/commands/map.py` | `--obsidian`, `--compact`, `--filter` flags |
| `ontos/io/obsidian.py` (NEW) | Wikilink utilities, vault detection |
| `ontos/ui/output.py` | Compact formatter |
| `tests/test_obsidian.py` (NEW) | Obsidian unit tests |
| `tests/core/test_cache.py` (NEW) | Cache unit tests |

---

## 12. References

| Document | Path |
|----------|------|
| Obsidian Spec | `.ontos-internal/strategy/v3.1/V3.1.0-Obsidian-Compatibility-Spec.md` |
| Sidecar Strategy | `.ontos-internal/strategy/v3.1/V3.1.0-Sidecar-Pattern.md` |
| Technical Architecture | `.ontos-internal/analysis/Ontos-Technical-Architecture-Map-Codex.md` |
| v3.0 Strategy | `.ontos-internal/strategy/v3.0/V3.0-Strategy-Decisions-Final.md` |
| Strategic Analysis | `.ontos-internal/analysis/Ontos-Strategic-Analysis-Codex.md` |

---

*Chief Architect (Claude Opus 4.5) - 2026-01-18*