---
id: v2_6_proposals_and_tooling
type: strategy
status: complete
depends_on: [v2_strategy]
concepts: [architecture, ontology, proposals, workflow, validation]
---

# V2.6 Proposal: Proposals Workflow & Validation

**Date:** 2025-12-17
**Author:** Claude Opus 4.5 (Architect)
**Status:** Approved - Implemented in v2.6.0
**Revision:** 3.2 - Incorporating Round 3 review feedback

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-12-17 | Initial proposal with 3 new scripts |
| 2.0 | 2025-12-17 | Simplified: removed scripts, manual workflow |
| 3.0 | 2025-12-17 | Round 1 review amendments (Claude, Codex, Gemini) |
| 3.1 | 2025-12-17 | Round 2 review refinements: type-status hard errors, approval path enforcement, decision history ledger validation |
| 3.2 | 2025-12-17 | Round 3 review refinements: archive path matching, error plumbing spec, approval ledger symmetry |

---

## 1. Executive Summary

This proposal extends Ontos v2.5 with:

1. **Rejection Recording** - Using existing decision_history.md format
2. **Status Validation** - `VALID_STATUS` enum with type-status matrix (hard errors for invalid combos)
3. **Schema Fixes** - Correcting event_type mismatch
4. **Lint Improvements** - Stale proposals, draft indicators, rejection enforcement, approval path enforcement
5. **Version Release Workflow** - Contributor-mode changelog reminder
6. **Complete Proposal Lifecycle** - Both approval and rejection workflows with ledger validation
7. **Decision History Ledger Enforcement** - Lint validates rejected items are recorded

**Key principle:** All features work in both contributor mode and user mode.

**Design philosophy:** Type-status violations are hard errors (semantic corruption), not warnings. Other lint rules use `--strict` for CI enforcement.

**What was removed:** Three new scripts - manual workflow with lint enforcement is simpler.

---

## 2. Problem Statement

### 2.1 Problems Identified

| # | Issue | Impact | Evidence | Status |
|---|-------|--------|----------|--------|
| P1 | Rejected ideas not recorded | Re-analyzing same ideas | No rejections in decision_history.md | Solving |
| P2 | No status validation | Invalid statuses accepted | No `VALID_STATUS` enum | Solving |
| P3 | Schema/config event_type mismatch | Confusion | Schema: `implementation` / Config: `feature` | Solving |
| P4 | No stale proposal detection | Proposals accumulate | No lint warning | Solving |
| P5 | Version releases miss changelog | v2.5.1, v2.5.2 missed | No reminder | Solving |
| P6 | Invalid type-status combinations | Semantic nonsense | `type: log, status: rejected` possible | **NEW** - Solving |
| P7 | Approved proposal workflow undefined | Where do they go? | Not documented | **NEW** - Solving |

### 2.2 What Already Exists (No Change Needed)

| Feature | Location |
|---------|----------|
| `proposals/` directory | Created by ontos_init.py |
| `status: draft` | In schema |
| Outcome column in decision_history | `Decision / Outcome` column |

---

## 3. Design Decisions

### 3.1 Rejection Recording (Using Existing Format)

**Current decision_history.md format (no change needed):**
```markdown
| Date | Slug | Event | Decision / Outcome | Impacted | Archive Path |
|:-----|:-----|:------|:-------------------|:---------|:-------------|
```

**Recording a rejection:**
```markdown
| 2025-12-17 | redis-cache | decision | REJECTED: Too complex for current scale. | v2_strategy | `archive/proposals/redis-cache.md` |
```

### 3.2 Status Validation with Type-Status Matrix

**Add to `ontos_config_defaults.py`:**

```python
# =============================================================================
# STATUS VALUES (v2.6+)
# =============================================================================

VALID_STATUS = {'draft', 'active', 'deprecated', 'archived', 'rejected'}

# Status descriptions - clarifying archived vs rejected
STATUS_DEFINITIONS = {
    'draft': 'Work in progress (proposals, incomplete docs)',
    'active': 'Current truth (approved, in use)',
    'deprecated': 'Past truth (superseded, kept for reference)',
    'archived': 'Historical record (completed logs moved to archive)',
    'rejected': 'Considered but NOT approved (proposals only - never became truth)',
}

# Valid (type, status) combinations - prevents semantic nonsense
# Example: type: log cannot have status: rejected (logs record what happened)
VALID_TYPE_STATUS = {
    'kernel': {'active', 'draft', 'deprecated'},
    'strategy': {'active', 'draft', 'deprecated', 'rejected'},  # Only strategy can be rejected
    'product': {'active', 'draft', 'deprecated'},
    'atom': {'active', 'draft', 'deprecated'},
    'log': {'active', 'archived'},  # Logs cannot be draft or rejected
}

# Stale thresholds (days)
PROPOSAL_STALE_DAYS = 60  # Configurable
```

**Rationale for type-status matrix (from Claude review):**
> "A `type: log` with `status: rejected` would be semantically invalid but pass validation."

This prevents nonsensical combinations at validation time.

### 3.3 Schema Fix (event_type Mismatch)

**Current schema.md (WRONG):**
```yaml
event_type: enum | exploration, decision, implementation, chore
```

**Corrected to match config:**
```yaml
event_type: enum | feature, fix, refactor, exploration, chore, decision
```

### 3.4 Complete Proposal Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PROPOSAL LIFECYCLE                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │   CREATE    │
                              │status: draft│
                              │ proposals/  │
                              └──────┬──────┘
                                     │
                              ┌──────▼──────┐
                              │   REVIEW    │
                              │(multi-model)│
                              └──────┬──────┘
                                     │
                      ┌──────────────┴──────────────┐
                      ▼                              ▼
             ┌────────────────┐            ┌────────────────┐
             │    APPROVE     │            │    REJECT      │
             └────────┬───────┘            └────────┬───────┘
                      │                              │
                      ▼                              ▼
             ┌────────────────┐            ┌────────────────┐
             │ 1. Change to   │            │ 1. Change to   │
             │ status: active │            │ status: rejected│
             │                │            │ 2. Add required │
             │ 2. Move to     │            │    metadata     │
             │ strategy/      │            │ 3. Move to      │
             │ (graduate)     │            │ archive/proposals│
             └────────┬───────┘            └────────┬───────┘
                      │                              │
                      └──────────────┬──────────────┘
                                     ▼
                              ┌─────────────┐
                              │  Record in  │
                              │decision_hist│
                              └─────────────┘
```

**Approval workflow (NEW - addressing Claude review gap):**
1. Change `status: draft` → `status: active`
2. Move file from `proposals/` to parent `strategy/` directory ("graduate")
3. Record in decision_history.md with `APPROVED` outcome

**Rejection workflow:**
1. Change `status: draft` → `status: rejected`
2. Add **required** rejection metadata (see 3.5)
3. Move file to `archive/proposals/`
4. Record in decision_history.md with `REJECTED` outcome

### 3.5 Rejection Metadata (Required Fields)

When rejecting a proposal, **required** frontmatter:

```yaml
---
id: redis_cache_proposal
type: strategy

rejected_date: 2025-12-17      # REQUIRED
rejected_reason: "Too complex"  # REQUIRED - whole point is capturing WHY
rejected_by: "Claude Opus 4.5"  # Optional - useful context
revisit_when: "10k users"       # Optional - conditions to reconsider
depends_on: [v2_strategy]
---
```

**Rationale for required `rejected_reason` (from Claude review):**
> "The whole point of recording rejections is to capture WHY."

Lint will warn if `status: rejected` without `rejected_reason`.

---

## 4. Deliverables

### 4.1 Config Changes

**File:** `.ontos/scripts/ontos_config_defaults.py`

Add `VALID_STATUS`, `STATUS_DEFINITIONS`, `VALID_TYPE_STATUS`, `PROPOSAL_STALE_DAYS` as shown in Section 3.2.

### 4.2 Schema Fix

**File:** `.ontos-internal/atom/schema.md`

1. Update status enum to include `rejected`
2. Fix event_type enum to match config
3. Add rejection metadata fields for strategy type

### 4.3 Context Map Updates

**File:** `.ontos/scripts/ontos_generate_context_map.py`

**4.3.1 Status Indicator**
```python
def get_status_indicator(status: str) -> str:
    """Return status indicator for non-active documents."""
    if status in ('draft', 'rejected', 'deprecated'):
        return f' [{status}]'
    return ''
```

**4.3.2 Status Validation (Wired to VALID_STATUS)**

**Design decision (v3.1):** Type-status violations are **hard errors**, not warnings.

**Rationale (Claude, Gemini Round 2):**
> "Invalid combinations like `type: log, status: rejected` are fundamentally broken, not just lint issues."
> "A rule violation for invalid status against `VALID_TYPE_STATUS` should *always* be an error."

This is semantic corruption - it represents data that violates the ontology's rules.

```python
from ontos_config_defaults import VALID_STATUS, VALID_TYPE_STATUS

# Basic status validation - WARNING (unknown status could be typo)
if status not in VALID_STATUS:
    warnings.append(f"- [LINT] **{doc_id}**: Invalid status '{status}'")

# Type-status combination validation - ERROR (semantic corruption)
doc_type = data.get('type', 'unknown')
if doc_type in VALID_TYPE_STATUS:
    valid_statuses = VALID_TYPE_STATUS[doc_type]
    if status not in valid_statuses:
        errors.append(  # Hard error, not warning
            f"- [ERROR] **{doc_id}**: Invalid status '{status}' for type '{doc_type}' "
            f"(valid: {valid_statuses}). This violates the type-status matrix."
        )
```

**Error behavior:**
- Hard errors are always shown, regardless of `--strict` flag
- If any hard errors exist, context map generation fails with exit code 1
- This prevents corrupted data from entering the knowledge base

**v3.2 Error Plumbing Specification (Codex Round 3):**

The current `ontos_generate_context_map.py` uses only `warnings`. To support hard errors:

```python
# At module level - initialize both collections
warnings: list[str] = []
errors: list[str] = []  # NEW: hard errors

# In main() after validation loop:
def main():
    # ... validation loop populates warnings and errors ...

    # Print warnings (always)
    if warnings:
        print("\n## Lint Warnings\n")
        for w in warnings:
            print(w)

    # Print errors and exit (hard failures)
    if errors:
        print("\n## ERRORS (blocking)\n")
        for e in errors:
            print(e)
        print("\n❌ Context map generation failed due to errors above.")
        sys.exit(1)

    # Continue with context map generation only if no errors
    # ... rest of generation ...
```

**Rationale (Codex Round 3):**
> "Type/status violations are defined as hard errors, but the plan assumes an `errors` collection and exit path without stating how it integrates."

This explicit specification ensures implementers understand:
1. Both `warnings` and `errors` lists must be initialized
2. Errors block generation with exit code 1
3. Warnings are advisory, errors are fatal

**4.3.3 Stale Proposal Warning (with mtime fallback)**
```python
from ontos_config_defaults import PROPOSAL_STALE_DAYS
from ontos_lib import get_git_last_modified
import os
from datetime import datetime

if status == 'draft' and 'proposals/' in filepath:
    # Try git date first, fall back to filesystem mtime
    last_modified = get_git_last_modified(filepath)
    if last_modified is None:
        # Fallback for new/untracked files
        mtime = os.path.getmtime(filepath)
        last_modified = datetime.fromtimestamp(mtime)

    age_days = (datetime.now() - last_modified).days
    if age_days > PROPOSAL_STALE_DAYS:
        warnings.append(
            f"- [LINT] **{doc_id}**: Draft proposal is {age_days} days old\n"
            f"  Action: Approve (move to strategy/, status: active) or "
            f"reject (move to archive/proposals/, status: rejected)"
        )
```

**Rationale for mtime fallback (from Codex review):**
> "New/untracked proposals will yield no date and skip warning."

**4.3.4 Skip Orphan Check for Draft Proposals Only**
```python
# Skip orphan check ONLY for draft proposals, not all drafts
if status == 'draft' and 'proposals/' in filepath:
    continue  # Proposals are naturally orphans until approved
```

**Rationale for proposal-specific skip (from Claude/Codex reviews):**
> "A draft `type: atom` with no dependents might be a real orphan, not an intentional proposal."

**4.3.5 Rejection Metadata and Location Enforcement**

```python
REJECTED_REASON_MIN_LENGTH = 10  # Minimum characters for meaningful reason

if status == 'rejected':
    rejected_reason = frontmatter.get('rejected_reason', '')

    # Check required metadata exists
    if not rejected_reason:
        warnings.append(
            f"- [LINT] **{doc_id}**: status: rejected requires 'rejected_reason' field\n"
            f"  Action: Add rejected_reason explaining WHY this was rejected"
        )
    # Check reason has meaningful length (v3.1 - Gemini)
    elif len(rejected_reason) < REJECTED_REASON_MIN_LENGTH:
        warnings.append(
            f"- [LINT] **{doc_id}**: rejected_reason too short ({len(rejected_reason)} chars)\n"
            f"  Action: Provide meaningful context (minimum {REJECTED_REASON_MIN_LENGTH} chars)"
        )

    # Check recommended metadata (v3.1 - Codex)
    if not frontmatter.get('rejected_date'):
        warnings.append(
            f"- [LINT] **{doc_id}**: Consider adding 'rejected_date' for temporal context"
        )

    # Check location
    if 'archive/proposals/' not in filepath:
        warnings.append(
            f"- [LINT] **{doc_id}**: Rejected proposals should be in archive/proposals/\n"
            f"  Action: Move to archive/proposals/ and record in decision_history.md"
        )
```

**Rationale for minimum length (Gemini Round 2):**
> "A reason of 'No' is useless; enforcing a minimal length encourages meaningful context."

**Rationale for rejection enforcement (Codex Round 1):**
> "Nothing checks that `status: rejected` docs were moved to `archive/proposals/`"

**Rationale for recommended `rejected_date` (Codex Round 2):**
> "`rejected_date` provides temporal context." Made recommended (warning), not required (error), because git history can provide the date if needed.

**4.3.6 `--include-rejected` Flag**
```python
parser.add_argument('--include-rejected', action='store_true',
                    help='Include rejected proposals in context map')

# In document collection:
if status == 'rejected' and not args.include_rejected:
    continue  # Skip rejected by default
```

**Rationale (from all reviewers):**
> Default exclude to save tokens, but provide flag for historical recall.

**4.3.7 Approval Path Enforcement (v3.1 - Codex)**

Prevent "approved but forgotten" proposals from lingering in `proposals/` directory.

```python
# Active documents should not remain in proposals/ - they should graduate
if status == 'active' and 'proposals/' in filepath:
    warnings.append(
        f"- [LINT] **{doc_id}**: Active document in proposals/ directory\n"
        f"  Action: Graduate to strategy/ (approved proposals should move up)"
    )
```

**Rationale (Codex Round 2):**
> "Lifecycle says 'graduate to strategy/' on approval, but no lint enforces 'active + proposals/ path' as invalid."

This ensures the approval workflow is actually followed, not just documented.

**4.3.8 Decision History Ledger Validation (v3.1 - Codex, refined v3.2)**

Ensure rejected proposals are recorded in `decision_history.md`, fulfilling the whole point of tracking rejections.

**v3.2 refinement:** Use archive path matching instead of slug heuristics.

```python
from ontos_lib import get_decision_history_path

def load_decision_history_entries() -> dict[str, set[str]]:
    """Load decision_history.md entries for validation.

    Returns dict with:
      - 'archive_paths': set of archive paths from the ledger
      - 'slugs': set of slugs (for fallback matching)
      - 'outcomes': dict mapping slug -> outcome (APPROVED/REJECTED)
    """
    history_path = get_decision_history_path()
    entries = {'archive_paths': set(), 'slugs': set(), 'outcomes': {}}

    if os.path.exists(history_path):
        with open(history_path) as f:
            for line in f:
                # Parse table rows: | date | slug | event | outcome | impacted | archive_path |
                if line.startswith('|') and not line.startswith('|:') and not line.startswith('| Date'):
                    parts = [p.strip() for p in line.split('|')]
                    if len(parts) >= 7:
                        slug = parts[2]
                        outcome = parts[4]
                        archive_path = parts[6].strip('`')  # Remove backticks

                        entries['slugs'].add(slug)
                        entries['outcomes'][slug] = outcome
                        if archive_path:
                            entries['archive_paths'].add(archive_path)
    return entries

# In validation loop:
if status == 'rejected':
    ledger = load_decision_history_entries()

    # Primary match: by archive path (unambiguous)
    relative_path = os.path.relpath(filepath, PROJECT_ROOT)
    path_matched = relative_path in ledger['archive_paths']

    # Fallback: by slug (for backward compatibility)
    slug_matched = doc_id.replace('_', '-') in ledger['slugs']

    if not path_matched and not slug_matched:
        warnings.append(
            f"- [LINT] **{doc_id}**: Rejected proposal not in decision_history.md\n"
            f"  Action: Add row with REJECTED outcome and archive path `{relative_path}`"
        )
```

**Rationale for archive path matching (Codex Round 3):**
> "Matching is via a slug heuristic (`doc_id` → hyphenated) and only for rejections. If the ledger uses a different slug, this yields false warnings/false negatives."

Archive path matching is unambiguous because:
1. The ledger already has an `Archive Path` column
2. File paths are unique - no heuristic conversion needed
3. Slug matching is kept as fallback for older entries without paths

**Rationale (Codex Round 2):**
> "There is no lint to ensure a `status: rejected` has a decision_history row. Without this, rejected decisions can disappear from the ledger."

This closes the loop on rejection recording - the whole point of P1 (rejected ideas not recorded).

**4.3.9 Approval Ledger Validation (v3.2 - Codex Round 3)**

For symmetry with rejection ledger validation, approved proposals should also be recorded in the decision history.

**Design Decision:** This is a **soft recommendation**, not a hard requirement.

```python
# In validation loop - for graduated proposals in strategy/
if status == 'active' and 'strategy/' in filepath and 'proposals/' not in filepath:
    ledger = load_decision_history_entries()

    # Check if this might be a graduated proposal (heuristic: has "proposal" in id or was recently created)
    might_be_graduated_proposal = 'proposal' in doc_id.lower()

    if might_be_graduated_proposal:
        # Check for APPROVED entry
        relative_path = os.path.relpath(filepath, PROJECT_ROOT)
        has_approval_entry = any(
            'APPROVED' in ledger['outcomes'].get(slug, '')
            for slug in ledger['slugs']
            if doc_id.replace('_', '-') in slug or slug in doc_id.replace('_', '-')
        )

        if not has_approval_entry:
            warnings.append(
                f"- [LINT] **{doc_id}**: Graduated proposal may not be in decision_history.md\n"
                f"  Action: Consider adding row with APPROVED outcome"
            )
```

**Rationale (Codex Round 3):**
> "Approvals are not validated at all—an approved proposal could graduate without a ledger entry."
> "Add a corresponding check for approved/graduated proposals so both outcomes are captured."

**Why soft recommendation (warning) instead of hard requirement:**

1. **Detection uncertainty**: Unlike rejected proposals (which have `status: rejected`), graduated proposals look like normal active strategy docs. We can only heuristically guess based on naming.

2. **Historical entries**: Existing strategy docs that weren't created via the proposal workflow would generate false positives if we required ledger entries.

3. **Lower stakes**: Missing an approval entry is less severe than missing a rejection entry. Approved ideas become visible as active docs. Rejected ideas disappear entirely without ledger recording.

4. **Symmetry is valuable, but not equally weighted**: The core problem (P1) was "rejected ideas not recorded." Approval recording is a bonus, not the primary goal.

**Alternative considered but not adopted:** Make approval ledger entry required.
- Rejected because: Would generate noise for all existing strategy docs.

### 4.4 Config Cleanup

**File:** `.ontos/scripts/ontos_config.py`

Remove `drafts/` from SKIP_PATTERNS (we use `proposals/`, not `drafts/`).

### 4.5 Version Release Workflow (Contributor-Mode Only)

**File:** `.ontos/scripts/ontos_pre_push_check.py`

```python
def check_version_reminder() -> list[str]:
    """Remind contributors to update changelog when shipping new versions.

    v3.1 improvements:
    - Uses origin tracking ref to catch multi-commit pushes (Codex)
    - Includes Dual_Mode_Matrix.md reminder (Gemini)
    """
    from ontos_config_defaults import is_ontos_repo

    if not is_ontos_repo():
        return []  # Skip for users

    # Get current branch and its upstream
    branch_result = subprocess.run(
        ['git', 'rev-parse', '--abbrev-ref', 'HEAD'],
        capture_output=True, text=True
    )
    if branch_result.returncode != 0:
        return []

    branch = branch_result.stdout.strip()

    # Get files changed since upstream (catches multi-commit pushes)
    # Falls back to HEAD~1 if no upstream exists
    result = subprocess.run(
        ['git', 'diff', '--name-only', f'origin/{branch}..HEAD'],
        capture_output=True, text=True
    )
    if result.returncode != 0:
        # Fallback for new branches without upstream
        result = subprocess.run(
            ['git', 'diff', '--name-only', 'HEAD~1..HEAD'],
            capture_output=True, text=True
        )
        if result.returncode != 0:
            return []

    changed_files = result.stdout.strip().split('\n')
    scripts_changed = any(f.startswith('.ontos/scripts/') for f in changed_files if f)
    matrix_changed = '.ontos-internal/reference/Dual_Mode_Matrix.md' in changed_files

    reminders = []

    if scripts_changed:
        reminder = (
            "⚠️  CONTRIBUTOR REMINDER: .ontos/scripts/ modified\n"
            "   If shipping a new version, remember to update:\n"
            "   1. ONTOS_VERSION in ontos_config_defaults.py\n"
            "   2. Ontos_CHANGELOG.md with release notes\n"
        )
        # Also remind about Dual_Mode_Matrix if script behavior changed
        if not matrix_changed:
            reminder += "   3. reference/Dual_Mode_Matrix.md if behavior changed\n"
        reminders.append(reminder)

    return reminders
```

**Rationale for upstream diff (Codex Round 2):**
> "Pre-push check looks at `HEAD~1..HEAD`; if multiple commits are pushed, earlier script changes won't trigger the reminder."

Using `origin/{branch}..HEAD` catches all commits being pushed, not just the last one.

**Rationale for Dual_Mode_Matrix reminder (Gemini Round 2):**
> "If a file listed in the matrix is modified, the hook could check if `Dual_Mode_Matrix.md` was also part of the commit."

### 4.6 Dual-Mode Matrix Document

**File:** `.ontos-internal/reference/Dual_Mode_Matrix.md`

Already created. Tracks dual-mode support for all features.

---

## 5. Dual-Mode Support

| Feature | Contributor | User |
|---------|-------------|------|
| proposals/ directory | `.ontos-internal/strategy/proposals/` | `docs/strategy/proposals/` |
| archive/proposals/ | `.ontos-internal/archive/proposals/` | `docs/archive/proposals/` |
| Status validation | ✅ | ✅ |
| Type-status validation | ✅ | ✅ |
| Stale proposal lint | ✅ | ✅ |
| Rejection enforcement lint | ✅ | ✅ |
| `--include-rejected` flag | ✅ | ✅ |
| Version release reminder | ✅ | ❌ (not applicable) |

---

## 6. File Changes Summary

| File | Change | Version |
|------|--------|---------|
| `.ontos/scripts/ontos_config_defaults.py` | Add VALID_STATUS, VALID_TYPE_STATUS, PROPOSAL_STALE_DAYS, REJECTED_REASON_MIN_LENGTH | v3.0, v3.1 |
| `.ontos/scripts/ontos_generate_context_map.py` | Status indicator, validation (hard errors for type-status), stale lint, rejection enforcement, approval path enforcement, decision history ledger validation (archive path matching), approval ledger symmetry (soft), error plumbing, --include-rejected | v3.0, v3.1, **v3.2** |
| `.ontos/scripts/ontos_pre_push_check.py` | Version release reminder (multi-commit aware, Dual_Mode_Matrix hint) | v3.0→v3.1 |
| `.ontos/scripts/ontos_lib.py` | Add `get_git_last_modified()`, `load_decision_history_entries()` helpers | v3.0, v3.1, **v3.2** |
| `.ontos/scripts/ontos_config.py` | Remove `drafts/` from SKIP_PATTERNS | v3.0 |
| `.ontos-internal/atom/schema.md` | Fix event_type, add rejected status, rejection metadata | v3.0 |
| `.ontos-internal/reference/Dual_Mode_Matrix.md` | Already created | v3.0 |
| `Ontos_Manual.md` | Document proposal workflow (approve + reject) | v3.0 |
| `Ontos_Agent_Instructions.md` | Add proposal awareness | v3.0 |

---

## 7. Testing Plan

### 7.1 Unit Tests

| ID | Test | Mode | Expected | Version |
|----|------|------|----------|---------|
| T1 | Valid status values accepted | Both | No warning | v3.0 |
| T2 | Invalid status triggers lint warning | Both | Warning shown | v3.0 |
| T3 | Invalid type-status combo triggers **ERROR** | Both | **Hard error** (exit 1) | v3.1 |
| T4 | Draft proposal shows [draft] indicator | Both | Indicator in context map | v3.0 |
| T5 | Stale draft (>60 days) triggers warning | Both | Lint warning with action hint | v3.0 |
| T6 | Fresh draft (<60 days) no warning | Both | No warning | v3.0 |
| T7 | Stale draft with no git history uses mtime | Both | Lint warning (mtime fallback) | v3.0 |
| T8 | Orphan check skips draft proposals | Both | No orphan warning | v3.0 |
| T9 | Orphan check runs on draft atoms | Both | Orphan warning if applicable | v3.0 |
| T10 | Version reminder runs in contributor mode | Contributor | Warning shown | v3.0 |
| T11 | Version reminder skipped in user mode | User | No warning | v3.0 |
| T12 | `status: rejected` without reason triggers warning | Both | Lint warning | v3.0 |
| T13 | `status: rejected` not in archive/ triggers warning | Both | Lint warning | v3.0 |
| T14 | `type: log, status: rejected` triggers **ERROR** | Both | **Hard error** (exit 1) | v3.1 |
| T15 | `--include-rejected` shows rejected docs | Both | Rejected docs in map | v3.0 |
| T16 | Default excludes rejected docs | Both | No rejected docs in map | v3.0 |
| T17 | `status: active` in proposals/ triggers warning | Both | Graduate action hint | **v3.1** |
| T18 | `rejected_reason` too short triggers warning | Both | Min length warning | **v3.1** |
| T19 | Rejected doc not in decision_history triggers warning | Both | Ledger warning | **v3.1** |
| T20 | Rejected doc in decision_history - no warning | Both | No warning | **v3.1** |
| T21 | Multi-commit push detects scripts changed | Contributor | Warning shown | **v3.1** |
| T22 | Version reminder includes Dual_Mode_Matrix hint | Contributor | Matrix reminder | **v3.1** |
| T23 | Rejected doc matched by archive path | Both | No false warning | **v3.2** |
| T24 | Rejected doc matched by slug fallback | Both | No false warning | **v3.2** |
| T25 | Graduated proposal without ledger entry warns | Both | Soft warning | **v3.2** |
| T26 | Non-proposal strategy doc - no warning | Both | No false positive | **v3.2** |

### 7.2 Integration Tests

| ID | Test | Expected | Version |
|----|------|----------|---------|
| T23 | Full lint run with mixed statuses | Correct warnings/errors for each | v3.0 |
| T24 | Context map with proposals | [draft] indicators shown | v3.0 |
| T25 | Full approval workflow | Proposal graduates to strategy/, lint passes | v3.0 |
| T26 | Full rejection workflow | Proposal in archive/proposals/ with metadata | v3.0 |
| T27 | **Type-status error blocks generation** | Exit code 1, no context map | **v3.1** |
| T28 | **Approval path enforcement end-to-end** | Lint warns until graduated | **v3.1** |
| T29 | **Decision history ledger validation end-to-end** | Lint warns until recorded | **v3.1** |
| T30 | **Error plumbing: errors list populated and exit** | Hard errors cause sys.exit(1) | **v3.2** |
| T31 | **Archive path matching preferred over slug** | Path match succeeds even if slug differs | **v3.2** |
| T32 | **Approval ledger symmetry soft warning** | Graduated proposals get advisory warning | **v3.2** |

### 7.3 Dual-Mode Test Coverage

All tests T1-T32 must pass in both modes with explicit `DOCS_DIR` fixture:

```python
@pytest.fixture(params=['contributor', 'user'])
def mode_aware_project(request, tmp_path):
    """Create temp project with mode-appropriate structure."""
    if request.param == 'contributor':
        docs_dir = tmp_path / '.ontos-internal'
    else:
        docs_dir = tmp_path / 'docs'
    docs_dir.mkdir(parents=True)
    # Setup structure...
    return docs_dir
```

**Rationale (Codex Round 2):**
> "Ensure fixtures exercise custom `DOCS_DIR` as well so validation logic isn't hardcoded to `docs/`."

---

## 8. Migration

### 8.1 Existing Documents

**No migration needed.** All changes are additive:
- Existing `status: active` documents work unchanged
- New validations are advisory (warnings, not errors)

### 8.2 Schema Event Type

Existing logs with `event_type: implementation` should be updated to `feature` or `chore`. Validation will warn but not fail.

---

## 9. Review Feedback Analysis

### 9.1 Round 1 Reviewers

| Reviewer | Verdict | Key Contributions |
|----------|---------|-------------------|
| Claude | APPROVE w/ amendments | Type-status matrix, required rejected_reason, approval workflow gap |
| Codex | CHANGES REQUIRED | VALID_STATUS wiring, mtime fallback, rejection enforcement |
| Gemini | APPROVED | Semi-automation idea, SRP for lint, actionable warnings |

### 9.2 Feedback Adopted

| # | Feedback | Source | Implementation |
|---|----------|--------|----------------|
| A1 | Make `rejected_reason` required | Claude | Section 3.5, 4.3.5 |
| A2 | Document approval workflow | Claude | Section 3.4 (graduate to strategy/) |
| A3 | Add type-status validation matrix | Claude | Section 3.2 (VALID_TYPE_STATUS) |
| A4 | Wire VALID_STATUS explicitly | Codex | Section 4.3.2 |
| A5 | Fallback to filesystem mtime | Codex | Section 4.3.3 |
| A6 | Add lint for rejected location | Codex | Section 4.3.5 |
| A7 | Orphan skip proposal-specific | Claude, Codex | Section 4.3.4 |
| A8 | Add `--include-rejected` flag | Claude, Codex | Section 4.3.6 |
| A9 | Clarify archived vs rejected | Gemini | Section 3.2 (STATUS_DEFINITIONS) |
| A10 | Make lint warnings actionable | Gemini | Section 4.3.3, 4.3.5 |
| A11 | Add tests T12-T16 | Claude | Section 7.1 |

### 9.3 Feedback Refined (Adjusted Approach)

| # | Feedback | Source | Original | Refinement | Rationale |
|---|----------|--------|----------|------------|-----------|
| R1 | Semi-automated rejection helper | Gemini | Add `--reject` to maintain.py | Lint prints actionable message | Avoids new tooling while providing guidance |
| R2 | Dedicated ontos_lint.py | Gemini | Separate script | Defer to v2.7 | Good SRP but scope creep for v2.6 |
| R3 | `rejected_by` auto-populate | Gemini | Auto from get_source() | Keep optional | Useful context, not critical for all rejections |
| R4 | CI check for Dual_Mode_Matrix.md | Gemini | Pre-commit hook | Document in matrix itself | Over-engineering for now |
| R5 | Version reminder parse actual version | Claude | Parse ONTOS_VERSION diff | Accept false positives | Simpler, reliability > precision |

### 9.4 Feedback Not Adopted

| # | Feedback | Source | Reason for Not Adopting |
|---|----------|--------|------------------------|
| N1 | Proposal ID naming convention | Claude | Over-specification - flexibility is appropriate for varying project conventions |
| N2 | Dual_Mode_Matrix.md in user-visible docs/ | Claude | It's contributor reference - users don't need internal mode details |
| N3 | Concepts template drift risk | Codex | Already handled by template loader in v2.5.2 - templates.py loads from canonical source |

### 9.5 Round 2 Reviewers

| Reviewer | R1 Verdict | R2 Verdict | Shift |
|----------|------------|------------|-------|
| Claude | APPROVED w/ amendments | **APPROVED** | All amendments addressed |
| Codex | CHANGES REQUIRED | **CHANGES REQUIRED** | Refinements adopted |
| Gemini | APPROVED | **APPROVED** | Satisfied with v3.0 |

### 9.6 Round 2 Feedback Adopted (v3.1)

| # | Feedback | Source | Implementation | Section |
|---|----------|--------|----------------|---------|
| A12 | Type-status violations → hard errors | Claude, Gemini | `errors.append()` instead of `warnings.append()` | 4.3.2 |
| A13 | Approval path enforcement | Codex | New lint: `active` + `proposals/` warns | 4.3.7 |
| A14 | Decision history ledger validation | Codex | New lint: rejected must have ledger entry | 4.3.8 |
| A15 | Minimum length for `rejected_reason` | Gemini | 10+ char requirement | 4.3.5 |
| A16 | Multi-commit push detection | Codex | `origin/{branch}..HEAD` instead of `HEAD~1..HEAD` | 4.5 |
| A17 | Dual_Mode_Matrix reminder in pre-push | Gemini | Conditional reminder added | 4.5 |
| A18 | Resolve Q1 (separate flags) | All | Separate `--include-rejected`, `--include-archived` | 10/Q1 |
| A19 | Resolve Q2 (graduate to strategy/) | All | Enforced via lint | 10/Q2, 4.3.7 |
| A20 | Resolve Q3 (hybrid error/warning) | Claude, Gemini | Type-status = error, rest = warning | 10/Q3, 4.3.2 |

### 9.7 Round 2 Feedback Refined (Adjusted Approach)

| # | Feedback | Source | Original | Refinement | Rationale |
|---|----------|--------|----------|------------|-----------|
| R6 | Require `rejected_date` | Codex | Required field | **Recommended** (warning) | Git history provides date if needed; reduces friction |
| R7 | Status indicator for archived | Codex | Show `[archived]` always | **Defer to v2.7** | Logs already in `archive/` path - redundant indicator |

### 9.8 Round 2 Feedback Not Adopted

| # | Feedback | Source | Reason for Not Adopting |
|---|----------|--------|------------------------|
| N4 | Logs should carry `status: archived` | Codex Residual Q | Logs use path-based archival (`archive/logs/`), not status-based. Changing would break existing pattern. |

### 9.9 Codex Round 2 - Detailed Response

Codex remained at "CHANGES REQUIRED" in Round 2. Here's our response to each finding:

| # | Codex Finding | Response | Status |
|---|---------------|----------|--------|
| 1 | Decision history enforcement missing | **ADOPTED** - Added Section 4.3.8 | ✅ Addressed |
| 2 | Approval path not enforced | **ADOPTED** - Added Section 4.3.7 | ✅ Addressed |
| 3 | `rejected_date` not enforced | **REFINED** - Made recommended, not required | ✅ Addressed |
| 4 | Type/status matrix edge cases | **CLARIFIED** - Logs use `active`, path indicates archive | ✅ Addressed |
| 5 | Flag semantics unresolved | **RESOLVED** - Q1 decided: separate flags | ✅ Addressed |
| 6 | Multi-commit push detection | **ADOPTED** - Changed to `origin/{branch}..HEAD` | ✅ Addressed |
| 7 | Dual-mode test coverage | **ADOPTED** - Added Section 7.3 with fixture | ✅ Addressed |

All Codex concerns have been addressed in v3.1.

### 9.10 Round 3 Reviewers

| Reviewer | R1 | R2 | R3 | Shift |
|----------|----|----|-----|-------|
| Claude | APPROVED w/ amendments | APPROVED | **APPROVED** | Ready for implementation |
| Codex | CHANGES REQUIRED | CHANGES REQUIRED | **CHANGES REQUIRED (minor)** | 3 refinements |
| Gemini | APPROVED | APPROVED | **UNCONDITIONAL APPROVAL** | "Masterclass in iteration" |

### 9.11 Round 3 Feedback Adopted (v3.2)

| # | Feedback | Source | Implementation | Section |
|---|----------|--------|----------------|---------|
| A21 | Archive path matching (not slug heuristics) | Codex | `load_decision_history_entries()` uses archive path | 4.3.8 |
| A22 | Error plumbing specification | Codex | Explicit `errors` list and `sys.exit(1)` spec | 4.3.2 |
| A23 | Approval ledger symmetry | Codex | Soft warning for graduated proposals | 4.3.9 |

### 9.12 Round 3 Design Decisions with Rationale

| Decision | Options Considered | Choice | Rationale |
|----------|-------------------|--------|-----------|
| Ledger matching strategy | (A) Slug heuristic, (B) Archive path, (C) Both with fallback | **C: Both** | Path is unambiguous, slug fallback for older entries |
| Approval ledger enforcement | (A) Hard requirement, (B) Soft warning | **B: Soft warning** | Can't reliably detect graduated proposals vs. normal strategy docs |
| Error plumbing | (A) Implicit, (B) Explicit specification | **B: Explicit** | Implementers need clear integration guidance |

### 9.13 Codex Round 3 - Detailed Response

| # | Codex Finding | Response | Status |
|---|---------------|----------|--------|
| 1 | Slug heuristic is fragile and asymmetric | **ADOPTED** - Archive path matching as primary, slug as fallback | ✅ Addressed |
| 2 | Error plumbing not fully specified | **ADOPTED** - Added explicit `errors` list and exit code spec | ✅ Addressed |
| 3 | Approval ledger symmetry missing | **ADOPTED** - Added soft warning for graduated proposals | ✅ Addressed |

**All Codex Round 3 concerns have been addressed in v3.2.**

### 9.14 Rationale for Soft vs Hard Approval Ledger Enforcement

This deserves special explanation because it's a judgment call.

**Codex's request:** "Add a corresponding check for approved/graduated proposals so both outcomes are captured."

**Our response:** Implemented as soft warning, not hard requirement.

**Reasoning:**

| Factor | Rejection | Approval | Implication |
|--------|-----------|----------|-------------|
| Detection | Explicit (`status: rejected`) | Heuristic (`'proposal' in id`) | Approval detection is unreliable |
| False positives | None (explicit status) | High (many strategy docs) | Hard requirement would be noisy |
| Stakes of missing | High (idea disappears) | Low (idea is visible as active doc) | Rejection enforcement is more critical |
| User friction | Low (clear workflow) | High (existing docs flagged) | Hard requirement hurts adoption |

**Conclusion:** Symmetry is valuable for completeness, but not equally weighted. The core problem (P1) was about rejected ideas being lost. Approval recording is a nice-to-have bonus that shouldn't create friction.

---

## 10. Open Questions - RESOLVED (Round 2)

All open questions from Round 2 have been resolved based on reviewer consensus.

### Q1: `--include-rejected` vs `--include-archived` ✅ RESOLVED

| Option | Decision |
|--------|----------|
| **A: Separate flags** | **ADOPTED** |

**Decision:** Separate `--include-rejected` and `--include-archived` flags.

**Round 2 Consensus:**
- Claude: "Rejected proposals and archived logs serve fundamentally different purposes... Users may want one without the other."
- Gemini: "I **strongly agree** with Option A. `rejected` proposals and `archived` logs are ontologically distinct concepts ('never true' vs. 'was true')."

**Rationale:** Rejected proposals capture "why we didn't do X" (decision context), while archived logs capture "what we did in the past" (historical record). These serve different retrieval needs and should not be bundled.

### Q2: Approved Proposal Location ✅ RESOLVED

| Option | Decision |
|--------|----------|
| **A: Graduate to strategy/** | **ADOPTED** |

**Decision:** Approved proposals graduate to parent `strategy/` directory.

**Round 2 Consensus:**
- Claude: "Symmetry with rejection workflow is elegant: Approved -> graduates UP to `strategy/`, Rejected -> moves DOWN to `archive/proposals/`"
- Gemini: "This provides a clear and meaningful state transition."
- Codex: "Mandate graduation for consistency and discoverability."

**Rationale:** Creates a clear "promotion/demotion" mental model. Enforced via lint (Section 4.3.7).

### Q3: Should Lint Block or Warn? ✅ RESOLVED

| Option | Decision |
|--------|----------|
| **B + C Hybrid** | **ADOPTED** |

**Decision:**
- Type-status violations are **hard errors** (always block)
- Other lint rules are **warnings** by default, errors with `--strict`

**Round 2 Consensus:**
- Claude: "Type-status violations should be hard errors by default... Invalid combinations like `type: log, status: rejected` are fundamentally broken."
- Gemini: "I would argue that a rule violation for invalid status against `VALID_TYPE_STATUS` should *always* be an error, even without `--strict`."

**Rationale:** Semantic corruption (invalid type-status combo) is different from workflow guidance (stale proposals, missing metadata). The former breaks the ontology; the latter is advisory.

---

## 11. Approval Checklist

| Reviewer | Round 1 | Round 2 | Round 3 | Round 4 | Notes |
|----------|---------|---------|---------|---------|-------|
| Claude (Architect) | REVISED | AUTHOR | AUTHOR | AUTHOR | v3.2 incorporating R3 feedback |
| Claude Reviewer | APPROVED w/ amendments | APPROVED | **APPROVED** | PENDING | Ready for implementation |
| Codex | CHANGES REQUIRED | CHANGES REQUIRED | CHANGES REQUIRED (minor) | PENDING | All R3 concerns addressed in v3.2 |
| Gemini | APPROVED | APPROVED | **UNCONDITIONAL APPROVAL** | PENDING | "Masterclass in iteration" |
| Human (Jonathan) | PENDING | PENDING | PENDING | PENDING | — |

---

## 12. Implementation Priority

Based on Round 1 + Round 2 + Round 3 review consensus:

| Priority | Deliverable | Rationale | Version |
|----------|-------------|-----------|---------|
| P0 | Type-status validation matrix (hard errors) | Prevents semantic corruption | v3.0→v3.1 |
| P0 | Wire VALID_STATUS in context map | Without this, enum is dead code | v3.0 |
| P0 | Rejection enforcement lint | Ensures workflow compliance | v3.0 |
| P0 | Approval path enforcement lint | Prevents forgotten graduates | v3.1 |
| P0 | Decision history ledger validation (archive path) | Closes rejection recording loop, unambiguous matching | v3.1→**v3.2** |
| P0 | Error plumbing (`errors` list + exit code) | Required for hard error behavior | **v3.2** |
| P1 | Stale proposal lint with mtime fallback | Core value proposition | v3.0 |
| P1 | Approval/rejection workflow documentation | Completes lifecycle | v3.0 |
| P1 | `--include-rejected` flag | Discoverability without bloat | v3.0 |
| P1 | `rejected_reason` minimum length | Ensures meaningful context | v3.1 |
| P1 | Approval ledger symmetry (soft warning) | Completeness, optional | **v3.2** |
| P2 | Version release reminder (multi-commit) | Contributor convenience | v3.0→v3.1 |
| P2 | Dual_Mode_Matrix reminder | Reduces matrix rot | v3.1 |
| P2 | Schema event_type fix | Cleanup | v3.0 |

**v3.2 additions bolded.** All P0 items are blocking for v2.6 release.

---

## 13. References

### Round 1 Reviews
- [Round 1 Review: Claude](Claude_2.6_v1.md)
- [Round 1 Review: Codex](Codex_2.6_v1.md)
- [Round 1 Review: Gemini](Gemini_2.6_v1.md)

### Round 2 Reviews
- [Round 2 Review: Claude](Claude_2.6_v2.md)
- [Round 2 Review: Codex](Codex_2.6_v2.md)
- [Round 2 Review: Gemini](Gemini_2.6_v2.md)

### Round 3 Reviews
- [Round 3 Review: Claude](Claude_2.6_v3.md)
- [Round 3 Review: Codex](Codex_2.6_v3.md)
- [Round 3 Review: Gemini](Gemini_2.6_v3.md)

### Related Documents
- [Session Log: Proposals Architecture](../../logs/2025-12-17_v2-5-1-proposals-architecture.md)
- [Dual Mode Matrix](../../reference/Dual_Mode_Matrix.md)
- [Schema Specification](../../atom/schema.md)
