---
id: v2_9_4_implementation_plan
type: strategy
status: complete
depends_on: [v2_9_implementation_plan]
concepts: [documentation, testing, release, bugfix]
---

# v2.9.4 Implementation Plan

**Author:** Claude Code (Opus 4.5) as Chief Architect
**Date:** 2025-12-23
**Version:** 1.0.0
**Goal:** Complete v2.9 release with documentation, tests, and bug fixes
**Status:** DRAFT — Pending Chief Architect Approval

---

## 1. Executive Summary

v2.9.4 is the **documentation and polish release** that completes the v2.9 milestone. All core features (Schema Versioning, Curation Levels, Deprecation Warnings, install.py Bootstrap) are implemented. This release focuses on:

| Category | Items |
|----------|-------|
| **Bug Fix** | Config merge write (install.py) |
| **Documentation** | README, Manual, Agent Instructions |
| **Testing** | install.py unit tests |
| **Release** | Version bump, CHANGELOG |

**Current State:** v2.9.3 stable (397 tests, all features complete)
**Target State:** v2.9.4 with complete documentation and test coverage

---

## 2. Current State Analysis

### 2.1 What Actually Exists (vs Plan)

| Component | Plan (v2.9 spec) | Actual | Delta |
|-----------|------------------|--------|-------|
| install.py | PR #34 | PR #35 ✅ | PR numbers shifted |
| checksums.json | PR #34 | PR #35 ✅ | - |
| ontos_create_bundle.py | PR #34 | PR #35 ✅ | - |
| Schema Versioning | PR #31 | PR #31 ✅ | Match |
| Curation Levels | PR #32 | PR #33 ✅ | PR number shifted |
| Deprecation Warnings | PR #33 | PR #34 ✅ | PR number shifted |
| Documentation | PR #35 | **MISSING** | Deferred |
| Install tests | PR #34.6 | **MISSING** | Deferred |
| Release workflow | PR #34.3 | **MISSING** | Deferred |

### 2.2 Deferred Items from PR Reviews

| Item | Source | Priority |
|------|--------|----------|
| Config merge doesn't write | Chief Architect PR #35 Review | MEDIUM |
| tests/test_install.py | Spec Section 6 Task 35.6 | MEDIUM |
| README curl-bootstrap | Spec Section 6 Task 35.3 | HIGH |
| Manual v2.9 update | Spec Section 6 Task 35.1 | HIGH |
| Agent Instructions update | Spec Section 6 Task 35.2 | MEDIUM |
| Release workflow | Spec Section 6 Task 35.3 | LOW |

### 2.3 Deviation Decisions

| Deviation | Decision | Rationale |
|-----------|----------|-----------|
| PR numbers don't match spec | **Work with reality** | Renumbering would cause confusion |
| Documentation deferred | **Implement in v2.9.4** | Core features took priority |
| Release workflow missing | **Defer to v3.0** | Not blocking; manual release works |

---

## 3. Implementation Tasks

### 3.1 Task A: Fix Config Merge Write Bug

**Priority:** MEDIUM
**Files:** `install.py`

**Problem:** Lines 528-532 compute merged config but don't persist it:
```python
if upgrade and old_config:
    new_config = read_user_config()
    merged = merge_configs(new_config, old_config)
    # BUG: merged dict never written!
    log("Config merged...", "success")
```

**Solution:** Add `write_user_config()` function and call it:

```python
# Add after merge_configs() function (around line 270)
def write_user_config(config: dict) -> bool:
    """Write merged config values back to ontos_config.py.

    Strategy: Read existing file, update only the values we have,
    preserve any comments and structure.
    """
    config_path = Path.cwd() / "ontos_config.py"

    if not config_path.exists():
        # No user config to update
        return True

    try:
        lines = config_path.read_text().splitlines()
        new_lines = []

        for line in lines:
            # Check if this line sets a config value we want to update
            updated = False
            for key, value in config.items():
                if line.strip().startswith(f"{key} =") or line.strip().startswith(f"{key}="):
                    new_lines.append(f"{key} = {value}")
                    updated = True
                    break

            if not updated:
                new_lines.append(line)

        config_path.write_text('\n'.join(new_lines) + '\n')
        return True
    except Exception as e:
        log(f"Failed to write config: {e}", "warning")
        return False
```

**Update install() function** (around line 528):
```python
# Step 10: Merge config if upgrading
if upgrade and old_config:
    new_config = read_user_config()
    merged = merge_configs(new_config, old_config)
    if write_user_config(merged):
        log("Config merged: your customizations preserved + new defaults added", "success")
    else:
        log("Config merge completed but write failed. Your customizations may need manual restoration.", "warning")
```

**Test Manually:**
1. Create project with custom `ontos_config.py` setting `LOG_THRESHOLD = 5`
2. Run `python3 install.py --upgrade`
3. Verify `LOG_THRESHOLD = 5` is preserved in `ontos_config.py`

---

### 3.2 Task B: Create tests/test_install.py

**Priority:** MEDIUM
**Files:** `tests/test_install.py` (NEW)

**Test Categories:**

#### B.1 Security Tests (CRITICAL)

```python
# tests/test_install.py
"""Tests for install.py security and functionality."""

import sys
import tempfile
from pathlib import Path

# Add install.py to path for testing
sys.path.insert(0, str(Path(__file__).parent.parent))
from install import (
    is_path_traversal,
    sha256_file,
    check_python_version,
    verify_local_checksum,
)


class TestPathTraversalSecurity:
    """Security: Path traversal detection."""

    def test_rejects_posix_absolute_path(self):
        assert is_path_traversal("/etc/passwd") is True

    def test_rejects_parent_directory_traversal(self):
        assert is_path_traversal("../../../etc/passwd") is True
        assert is_path_traversal("foo/../../../bar") is True

    def test_rejects_windows_drive_letter(self):
        assert is_path_traversal("C:\\Windows\\System32") is True
        assert is_path_traversal("D:\\Users\\evil.bat") is True

    def test_rejects_windows_unc_path(self):
        assert is_path_traversal("\\\\server\\share\\file") is True
        assert is_path_traversal("//server/share/file") is True

    def test_allows_normal_relative_path(self):
        assert is_path_traversal(".ontos/scripts/ontos_lib.py") is False
        assert is_path_traversal("ontos.py") is False
        assert is_path_traversal("docs/reference/Ontos_Manual.md") is False

    def test_allows_path_with_dots_in_name(self):
        assert is_path_traversal(".ontos") is False
        assert is_path_traversal("file.tar.gz") is False
```

#### B.2 Checksum Tests

```python
class TestChecksumVerification:
    """Security: Checksum verification."""

    def test_sha256_file_computes_correctly(self, tmp_path):
        test_file = tmp_path / "test.txt"
        test_file.write_text("hello world")
        # Known SHA256 of "hello world"
        expected = "b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9"
        assert sha256_file(test_file) == expected

    def test_verify_local_checksum_accepts_match(self, tmp_path):
        test_file = tmp_path / "test.txt"
        test_file.write_text("hello world")
        checksum = "b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9"
        assert verify_local_checksum(test_file, checksum) is True

    def test_verify_local_checksum_rejects_mismatch(self, tmp_path):
        test_file = tmp_path / "test.txt"
        test_file.write_text("hello world")
        wrong_checksum = "0000000000000000000000000000000000000000000000000000000000000000"
        assert verify_local_checksum(test_file, wrong_checksum) is False
```

#### B.3 Python Version Tests

```python
class TestPythonVersionCheck:
    """Utility: Python version validation."""

    def test_check_python_version_passes_on_39_plus(self):
        # Current Python must be 3.9+ to run tests
        assert check_python_version() is True
```

#### B.4 Installation Detection Tests

```python
class TestInstallationDetection:
    """Utility: Existing installation detection."""

    def test_detects_no_installation(self, tmp_path, monkeypatch):
        monkeypatch.chdir(tmp_path)
        from install import detect_existing_installation
        result = detect_existing_installation()
        assert result["installed"] is False
        assert result["incomplete"] is False

    def test_detects_existing_installation(self, tmp_path, monkeypatch):
        monkeypatch.chdir(tmp_path)
        (tmp_path / ".ontos").mkdir()
        (tmp_path / ".ontos" / "scripts").mkdir()
        config = tmp_path / ".ontos" / "scripts" / "ontos_config_defaults.py"
        config.write_text('ONTOS_VERSION = "2.9.3"')

        from install import detect_existing_installation
        result = detect_existing_installation()
        assert result["installed"] is True
        assert result["version"] == "2.9.3"

    def test_detects_incomplete_installation(self, tmp_path, monkeypatch):
        monkeypatch.chdir(tmp_path)
        (tmp_path / ".ontos").mkdir()
        (tmp_path / ".ontos" / ".install_incomplete").touch()

        from install import detect_existing_installation
        result = detect_existing_installation()
        assert result["installed"] is True
        assert result["incomplete"] is True
```

**Expected Test Count:** ~15-20 new tests

---

### 3.3 Task C: Update README.md

**Priority:** HIGH
**Files:** `README.md`

**Changes Required:**

#### C.1 Replace Quick Start Section (lines 81-106)

**Current:**
```markdown
## Quick Start

**Install** (paste into Claude Code, Cursor, or any agentic CLI):

```
Install Project Ontos in this repository.

1. Clone or download the Ontos scripts from: https://github.com/ohjona/Project-Ontos
2. Copy the `.ontos/` folder and `ontos_init.py` into my project root
...
```

**Replace With:**
```markdown
## Quick Start

### Option 1: Curl Bootstrap (Recommended)

```bash
# Download and run the installer
curl -sO https://raw.githubusercontent.com/ohjona/Project-Ontos/v2.9.4/install.py
python3 install.py
```

### Option 2: Offline Installation

```bash
# Download bundle from GitHub Releases
curl -LO https://github.com/ohjona/Project-Ontos/releases/download/v2.9.4/ontos-bundle.tar.gz

# Get checksum from release page, then install
python3 install.py --bundle ./ontos-bundle.tar.gz --checksum <sha256>
```

### Option 3: Manual Installation

For environments without curl or when you prefer manual control:

1. Clone: `git clone https://github.com/ohjona/Project-Ontos.git /tmp/ontos`
2. Copy: `cp -r /tmp/ontos/.ontos /tmp/ontos/ontos.py /tmp/ontos/ontos_init.py your-project/`
3. Initialize: `cd your-project && python3 ontos_init.py`

> See the [Ontos Manual](docs/reference/Ontos_Manual.md) for configuration options.
```

#### C.2 Update "Updating" Section (lines 129-142)

**Replace With:**
```markdown
## Updating

To upgrade to the latest version:

```bash
python3 install.py --upgrade --latest
```

Or specify a version:

```bash
python3 install.py --upgrade --version 2.9.4
```

Your `ontos_config.py` customizations are preserved during upgrades.
```

---

### 3.4 Task D: Update Ontos_Manual.md

**Priority:** HIGH
**Files:** `docs/reference/Ontos_Manual.md`

**Changes Required:**

#### D.1 Update Version Header (line 8)

```markdown
# Ontos Manual v2.9
```

#### D.2 Replace Quick Start Section (lines 14-31)

**Replace With:**
```markdown
## Quick Start

### Recommended: Curl Bootstrap

```bash
# Download and run installer
curl -sO https://raw.githubusercontent.com/ohjona/Project-Ontos/v2.9.4/install.py
python3 install.py

# Activate
# Tell your AI: "Ontos"
```

### Offline Installation (Air-Gapped Environments)

```bash
# On machine with internet: download bundle
curl -LO https://github.com/ohjona/Project-Ontos/releases/download/v2.9.4/ontos-bundle.tar.gz

# Get checksum from GitHub release page or checksums.json

# On air-gapped machine: install with explicit checksum
python3 install.py --bundle ./ontos-bundle.tar.gz --checksum <sha256>
```

### Upgrading

```bash
python3 install.py --upgrade --latest
```
```

#### D.3 Add New Section: "9. v2.9 Features" (after Section 8)

```markdown
---

## 9. v2.9 Features

### 9.1 Schema Versioning (v2.9.0)

Documents now support explicit schema versions:

```yaml
---
id: my_feature
type: product
status: active
ontos_schema: "2.2"
---
```

**Schema Versions:**
| Version | Ontos Version | Key Features |
|---------|---------------|--------------|
| 2.0 | v2.0-v2.6 | Base schema |
| 2.1 | v2.7+ | `describes` field |
| 2.2 | v2.9+ | `curation_level` field |
| 3.0 | v3.0+ | Typed edges (future) |

**Migration:** Run `python3 ontos.py migrate` to add schema versions to existing documents.

### 9.2 Curation Levels (v2.9.1)

Documents can have different levels of completeness:

| Level | Name | Validation | Use Case |
|-------|------|------------|----------|
| 0 | Scaffold | Minimal | Quick capture, auto-generated |
| 1 | Stub | Relaxed | Work in progress |
| 2 | Full | Strict | Production-ready |

**Commands:**
```bash
# Create Level 0 scaffold
python3 ontos.py scaffold path/to/file.md

# Create Level 1 stub
python3 ontos.py stub --goal "Implement auth" --type product

# Promote to next level
python3 ontos.py promote path/to/file.md
```

### 9.3 Deprecation Warnings (v2.9.2)

Direct script execution shows deprecation warnings:

```
[DEPRECATION] Direct execution of ontos_query.py is deprecated.
Use 'python3 ontos.py query' instead.
```

**Suppression:** Set `ONTOS_NO_DEPRECATION_WARNINGS=1` to suppress CLI notices.

Note: Import warnings from `ontos_lib` are intentionally NOT suppressible to encourage migration.

### 9.4 install.py Bootstrap (v2.9.3)

Single-file installer with security features:

| Feature | Description |
|---------|-------------|
| SHA256 verification | Checksums from tag-aligned `checksums.json` |
| Offline support | `--bundle` + `--checksum` flags |
| Upgrade support | `--upgrade` preserves config |
| Path traversal protection | POSIX + Windows |
| Symlink protection | Rejects symlinks in bundles |

```bash
# Standard install
python3 install.py

# Offline install
python3 install.py --bundle ./bundle.tar.gz --checksum abc123...

# Check integrity
python3 install.py --check
```
```

---

### 3.5 Task E: Update Agent Instructions

**Priority:** MEDIUM
**Files:** `docs/reference/Ontos_Agent_Instructions.md`

**Changes Required:**

#### E.1 Add Installation Command (after "Update Ontos" section, ~line 74)

```markdown
### "Install Ontos" (New Project)
1. Download installer:
   ```bash
   curl -sO https://raw.githubusercontent.com/ohjona/Project-Ontos/v2.9.4/install.py
   ```
2. Run: `python3 install.py`
3. Activate: Say "Ontos"

### "Upgrade Ontos"
1. `python3 install.py --upgrade --latest`
```

---

### 3.6 Task F: Version Bump and CHANGELOG

**Priority:** HIGH
**Files:**
- `.ontos/scripts/ontos_config_defaults.py`
- `Ontos_CHANGELOG.md`

#### F.1 Version Bump

Change line 26 of `ontos_config_defaults.py`:
```python
ONTOS_VERSION = "2.9.4"
```

#### F.2 CHANGELOG Entry

Add after line 22 (after the header, before v2.9.3 entry):

```markdown
## [2.9.4] - 2025-12-24

### Theme: "Documentation & Polish"

Complete documentation update for v2.9 features and bug fixes.

### Fixed
- **Config merge write bug** - Upgrade now correctly preserves user customizations in `ontos_config.py`

### Added
- **`tests/test_install.py`** - Unit tests for install.py security functions
  - Path traversal detection (POSIX + Windows)
  - Checksum verification
  - Installation detection

### Changed
- **README.md** - Updated with curl-bootstrap installation instructions
- **Ontos_Manual.md** - Updated to v2.9 with new features documentation:
  - Schema Versioning (v2.9.0)
  - Curation Levels (v2.9.1)
  - Deprecation Warnings (v2.9.2)
  - install.py Bootstrap (v2.9.3)
- **Ontos_Agent_Instructions.md** - Added "Install Ontos" and "Upgrade Ontos" commands

---
```

---

## 4. Implementation Order

Execute tasks in this order to minimize conflicts:

```
1. Task A: Fix config merge bug (install.py)
2. Task B: Create test_install.py
3. Run tests: pytest tests/test_install.py -v
4. Task C: Update README.md
5. Task D: Update Ontos_Manual.md
6. Task E: Update Agent Instructions
7. Task F: Version bump + CHANGELOG
8. Run full test suite: pytest tests/ .ontos/scripts/tests/ -v
9. Verify context map: python3 ontos.py map --strict
```

---

## 5. Exit Criteria

Before PR submission, verify:

| Criterion | Command | Expected |
|-----------|---------|----------|
| All tests pass | `pytest tests/ .ontos/scripts/tests/` | 410+ tests, 0 failures |
| New tests exist | `pytest tests/test_install.py -v` | 15+ tests |
| Context map valid | `python3 ontos.py map --strict` | No errors |
| Version correct | `grep ONTOS_VERSION .ontos/scripts/ontos_config_defaults.py` | "2.9.4" |
| README has curl | `grep "curl -sO" README.md` | Match found |
| Manual is v2.9 | `grep "Ontos Manual v2.9" docs/reference/Ontos_Manual.md` | Match found |

---

## 6. Constraints Inherited from Previous Decisions

| Constraint | Source | Impact |
|------------|--------|--------|
| Zero-dependency | Master Plan | tests/test_install.py can only use pytest, no mocks |
| No release.yml | Deferred | Manual release process continues |
| Python 3.9+ | Master Plan | Tests must work on 3.9+ |
| Config location | v2.8 | User config is `ontos_config.py` in project root |

---

## 7. Out of Scope (Explicitly NOT in v2.9.4)

| Item | Reason | Deferred To |
|------|--------|-------------|
| Release workflow (.github/workflows/release.yml) | Not blocking, manual release works | v3.0 |
| PyPI distribution | Master Plan defers to v3.0 | v3.0 |
| Comprehensive install integration tests | Would require mock HTTP | v3.0 |

---

## 8. Risk Analysis

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Config write breaks existing installs | Low | Medium | Test with real upgrade scenario |
| Documentation changes break examples | Low | Low | Run examples after updating |
| Test imports fail on install.py | Medium | Low | Careful sys.path management |

---

## 9. Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-23 | Initial draft |

---

*End of v2.9.4 Implementation Plan v1.0.0*

*Status: DRAFT — Pending Chief Architect Approval*
