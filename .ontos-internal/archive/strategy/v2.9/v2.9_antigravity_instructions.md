---
id: antigravity_v2_9_instructions
type: strategy
status: complete
depends_on: [v2_9_implementation_plan]
concepts: [implementation, onboarding, v2.9]
---

# Antigravity v2.9.4 Implementation Instructions

**To:** Antigravity (Implementation Agent)
**From:** Chief Architect (Claude Code)
**Date:** 2025-12-24
**Subject:** PR #36 - Documentation & Release (v2.9.4)
**Plan Version:** v2.9_implementation_plan.md v1.5.0 (APPROVED)

---

## 0. Executive Summary

You are tasked with implementing **v2.9.4** of Project Ontosâ€”the final release of the v2.9 milestone. All core features are complete. Your job is **documentation, testing, and polish**.

| Task | Description | Priority |
|------|-------------|----------|
| Fix config merge bug | `install.py` doesn't persist merged config | MEDIUM |
| Create install tests | Security tests for `install.py` | MEDIUM |
| Update README | Add curl-bootstrap instructions | HIGH |
| Update Manual | Document all v2.9 features | HIGH |
| Update Agent Instructions | Add new CLI commands | MEDIUM |
| Version bump | 2.9.3 â†’ 2.9.4 | HIGH |
| CHANGELOG entry | Document v2.9.4 release | MEDIUM |

**Current State:** v2.9.3 stable (397 tests, all features complete)
**Target State:** v2.9.4 release-ready

---

## 1. Current State (v2.9.3)

### 1.1 What's Already Done

| PR | Feature | Version | Status |
|----|---------|---------|--------|
| **#31** | Schema Versioning | v2.9.0 | âœ… MERGED |
| **#33** | Curation Levels | v2.9.1 | âœ… MERGED |
| **#34** | Deprecation Warnings | v2.9.2 | âœ… MERGED |
| **#35** | install.py Bootstrap | v2.9.3 | âœ… MERGED |
| **#36** | Documentation & Release | v2.9.4 | ðŸ”„ **YOU ARE HERE** |

### 1.2 Key Files

```
ontos.py                                    # CLI dispatcher (11 commands, 13 aliases)
install.py                                  # Curl-bootstrapped installer (26KB)
.ontos/scripts/ontos_config_defaults.py     # ONTOS_VERSION = "2.9.3"
.ontos/scripts/ontos/core/schema.py         # Schema versioning (v2.9.0)
.ontos/scripts/ontos/core/curation.py       # Curation levels (v2.9.1)
.ontos/scripts/ontos_lib.py                 # Deprecated shim (FutureWarning)
docs/reference/Ontos_Manual.md              # Currently "v2.8" - NEEDS UPDATE
docs/reference/Ontos_Agent_Instructions.md  # Missing new commands - NEEDS UPDATE
README.md                                   # Old install method - NEEDS UPDATE
```

### 1.3 Test Status

| Category | Count |
|----------|-------|
| Total tests | 397 |
| Root tests (`tests/`) | 285 |
| Scripts tests (`.ontos/scripts/tests/`) | 112 |

---

## 2. Your Tasks

### Task A: Fix Config Merge Write Bug

**File:** `install.py`
**Priority:** MEDIUM

**Problem:** Lines 528-532 compute merged config but don't persist it:

```python
if upgrade and old_config:
    new_config = read_user_config()
    merged = merge_configs(new_config, old_config)
    # BUG: merged dict is never written back!
    log("Config merged...", "success")
```

**Solution:** Add `write_user_config()` function after `merge_configs()` (~line 270):

```python
def write_user_config(config: dict) -> bool:
    """Write merged config values back to ontos_config.py.

    Strategy: Read existing file, update only the values we have,
    preserve any comments and structure.
    """
    config_path = Path.cwd() / "ontos_config.py"

    if not config_path.exists():
        # No user config to update
        return True

    try:
        lines = config_path.read_text().splitlines()
        new_lines = []

        for line in lines:
            # Check if this line sets a config value we want to update
            updated = False
            for key, value in config.items():
                # Match "KEY = value" or "KEY= value" patterns
                if line.strip().startswith(f"{key} =") or line.strip().startswith(f"{key}="):
                    # Preserve indentation
                    indent = len(line) - len(line.lstrip())
                    new_lines.append(" " * indent + f"{key} = {repr(value)}")
                    updated = True
                    break

            if not updated:
                new_lines.append(line)

        config_path.write_text('\n'.join(new_lines) + '\n')
        return True
    except Exception as e:
        log(f"Failed to write config: {e}", "warning")
        return False
```

**Update install() function** (~line 528):

```python
# Step 10: Merge config if upgrading
if upgrade and old_config:
    new_config = read_user_config()
    merged = merge_configs(new_config, old_config)
    if write_user_config(merged):
        log("Config merged: your customizations preserved + new defaults added", "success")
    else:
        log("Config merge computed but write failed. Check ontos_config.py manually.", "warning")
```

**Manual Test:**
1. Create a test project with custom `ontos_config.py` containing `LOG_RETENTION_COUNT = 5`
2. Run `python3 install.py --upgrade`
3. Verify `LOG_RETENTION_COUNT = 5` is preserved in `ontos_config.py`

---

### Task B: Create tests/test_install.py

**File:** `tests/test_install.py` (NEW)
**Priority:** MEDIUM

Create a new test file with security-focused tests:

```python
"""Tests for install.py security and functionality."""

import sys
import tempfile
from pathlib import Path

# Add project root to path for importing install.py
sys.path.insert(0, str(Path(__file__).parent.parent))
from install import (
    is_path_traversal,
    sha256_file,
    check_python_version,
    verify_local_checksum,
    detect_existing_installation,
)


class TestPathTraversalSecurity:
    """Security: Path traversal detection."""

    def test_rejects_posix_absolute_path(self):
        assert is_path_traversal("/etc/passwd") is True

    def test_rejects_parent_directory_traversal(self):
        assert is_path_traversal("../../../etc/passwd") is True
        assert is_path_traversal("foo/../../../bar") is True

    def test_rejects_windows_drive_letter(self):
        assert is_path_traversal("C:\\Windows\\System32") is True
        assert is_path_traversal("D:\\Users\\evil.bat") is True

    def test_rejects_windows_unc_path(self):
        assert is_path_traversal("\\\\server\\share\\file") is True
        assert is_path_traversal("//server/share/file") is True

    def test_allows_normal_relative_path(self):
        assert is_path_traversal(".ontos/scripts/ontos_lib.py") is False
        assert is_path_traversal("ontos.py") is False
        assert is_path_traversal("docs/reference/Ontos_Manual.md") is False

    def test_allows_path_with_dots_in_name(self):
        assert is_path_traversal(".ontos") is False
        assert is_path_traversal("file.tar.gz") is False
        assert is_path_traversal(".ontos/scripts/ontos_config_defaults.py") is False


class TestChecksumVerification:
    """Security: Checksum verification."""

    def test_sha256_file_computes_correctly(self, tmp_path):
        test_file = tmp_path / "test.txt"
        test_file.write_text("hello world")
        # Known SHA256 of "hello world"
        expected = "b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9"
        assert sha256_file(test_file) == expected

    def test_sha256_file_handles_binary(self, tmp_path):
        test_file = tmp_path / "test.bin"
        test_file.write_bytes(b"\x00\x01\x02\x03")
        result = sha256_file(test_file)
        assert len(result) == 64  # SHA256 hex length
        assert all(c in "0123456789abcdef" for c in result)

    def test_verify_local_checksum_accepts_match(self, tmp_path):
        test_file = tmp_path / "test.txt"
        test_file.write_text("hello world")
        checksum = "b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9"
        assert verify_local_checksum(test_file, checksum) is True

    def test_verify_local_checksum_rejects_mismatch(self, tmp_path):
        test_file = tmp_path / "test.txt"
        test_file.write_text("hello world")
        wrong_checksum = "0000000000000000000000000000000000000000000000000000000000000000"
        assert verify_local_checksum(test_file, wrong_checksum) is False


class TestPythonVersionCheck:
    """Utility: Python version validation."""

    def test_check_python_version_passes_on_current(self):
        # Current Python must be 3.9+ to run tests
        assert check_python_version() is True


class TestInstallationDetection:
    """Utility: Existing installation detection."""

    def test_detects_no_installation(self, tmp_path, monkeypatch):
        monkeypatch.chdir(tmp_path)
        result = detect_existing_installation()
        assert result["installed"] is False
        assert result["incomplete"] is False

    def test_detects_existing_installation(self, tmp_path, monkeypatch):
        monkeypatch.chdir(tmp_path)
        # Create minimal installation structure
        scripts_dir = tmp_path / ".ontos" / "scripts"
        scripts_dir.mkdir(parents=True)
        config = scripts_dir / "ontos_config_defaults.py"
        config.write_text('ONTOS_VERSION = "2.9.3"')

        result = detect_existing_installation()
        assert result["installed"] is True
        assert result["version"] == "2.9.3"

    def test_detects_incomplete_installation(self, tmp_path, monkeypatch):
        monkeypatch.chdir(tmp_path)
        ontos_dir = tmp_path / ".ontos"
        ontos_dir.mkdir()
        (ontos_dir / ".install_incomplete").touch()

        result = detect_existing_installation()
        assert result["installed"] is True
        assert result["incomplete"] is True


class TestConfigMerge:
    """Utility: Config merge functionality."""

    def test_write_user_config_preserves_comments(self, tmp_path, monkeypatch):
        """New test for the bug fix."""
        monkeypatch.chdir(tmp_path)

        # Create user config with comment
        config_path = tmp_path / "ontos_config.py"
        config_path.write_text('''# My custom config
LOG_RETENTION_COUNT = 5  # Keep fewer logs
DEFAULT_SOURCE = "My AI"
''')

        # Import and test write_user_config
        from install import write_user_config

        merged = {"LOG_RETENTION_COUNT": 10, "NEW_SETTING": True}
        result = write_user_config(merged)

        assert result is True
        content = config_path.read_text()
        # Original comment preserved
        assert "# My custom config" in content
        # Value updated
        assert "LOG_RETENTION_COUNT = 10" in content
        # Original setting preserved (not in merged dict)
        assert 'DEFAULT_SOURCE = "My AI"' in content
```

**Expected:** ~15-20 tests

---

### Task C: Update README.md

**File:** `README.md`
**Priority:** HIGH

**Replace the Quick Start section** (around lines 81-106) with:

```markdown
## Quick Start

### Recommended: Curl Bootstrap

```bash
# Download and run the installer
curl -sO https://raw.githubusercontent.com/ohjona/Project-Ontos/v2.9.4/install.py
python3 install.py
```

### Offline Installation

For air-gapped environments:

```bash
# On machine with internet: download bundle from GitHub Releases
curl -LO https://github.com/ohjona/Project-Ontos/releases/download/v2.9.4/ontos-bundle.tar.gz

# Get checksum from the release page, then install
python3 install.py --bundle ./ontos-bundle.tar.gz --checksum <sha256>
```

### Manual Installation

For environments without curl:

1. Clone: `git clone https://github.com/ohjona/Project-Ontos.git /tmp/ontos`
2. Copy: `cp -r /tmp/ontos/.ontos /tmp/ontos/ontos.py /tmp/ontos/ontos_init.py your-project/`
3. Initialize: `cd your-project && python3 ontos_init.py`

> See the [Ontos Manual](docs/reference/Ontos_Manual.md) for configuration options.
```

**Replace the Updating section** (around lines 129-142) with:

```markdown
## Updating

```bash
# Upgrade to latest version
python3 install.py --upgrade --latest

# Or specify a version
python3 install.py --upgrade --version 2.9.4
```

Your `ontos_config.py` customizations are preserved during upgrades.
```

---

### Task D: Update Ontos_Manual.md

**File:** `docs/reference/Ontos_Manual.md`
**Priority:** HIGH

#### D.1 Update Version Header (line 8)

Change from:
```markdown
# Ontos Manual v2.8
```
To:
```markdown
# Ontos Manual v2.9
```

#### D.2 Update Quick Start Section (around lines 14-31)

Replace with:

```markdown
## Quick Start

### Recommended: Curl Bootstrap

```bash
# Download and run installer
curl -sO https://raw.githubusercontent.com/ohjona/Project-Ontos/v2.9.4/install.py
python3 install.py

# Activate: Tell your AI "Ontos"
```

### Offline Installation

```bash
# On machine with internet
curl -LO https://github.com/ohjona/Project-Ontos/releases/download/v2.9.4/ontos-bundle.tar.gz

# On air-gapped machine
python3 install.py --bundle ./ontos-bundle.tar.gz --checksum <sha256>
```

### Upgrading

```bash
python3 install.py --upgrade --latest
```
```

#### D.3 Add New Section: "9. v2.9 Features"

Add this section after Section 8:

```markdown
---

## 9. v2.9 Features

### 9.1 Schema Versioning (v2.9.0)

Documents now support explicit schema versions for forward compatibility:

```yaml
---
id: my_feature
type: product
status: active
ontos_schema: "2.2"
---
```

**Schema Versions:**

| Version | Ontos Version | Key Features |
|---------|---------------|--------------|
| 2.0 | v2.0-v2.6 | Base schema |
| 2.1 | v2.7+ | `describes` field |
| 2.2 | v2.9+ | `curation_level` field |
| 3.0 | v3.0+ | Typed edges (future) |

**Migration:**

```bash
# Check which documents need migration
python3 ontos.py migrate --check

# Apply schema versions (dry-run first)
python3 ontos.py migrate --dry-run
python3 ontos.py migrate --apply
```

### 9.2 Curation Levels (v2.9.1)

Documents can have different levels of completeness:

| Level | Name | Validation | Use Case |
|-------|------|------------|----------|
| 0 | Scaffold | Minimal | Quick capture, auto-generated |
| 1 | Stub | Relaxed | Work in progress |
| 2 | Full | Strict | Production-ready |

**Commands:**

```bash
# Generate Level 0 scaffolds for undocumented files
python3 ontos.py scaffold          # Dry-run (preview)
python3 ontos.py scaffold --apply  # Apply changes

# Create Level 1 stub
python3 ontos.py stub --goal "Implement user auth" --type product

# Promote to next level (interactive)
python3 ontos.py promote path/to/file.md
```

**Context Map Markers:**

Documents show their curation level in the context map:
- `[L0]` - Scaffold (minimal)
- `[L1]` - Stub (work in progress)
- `[L2]` - Full (production-ready)

**Strict Mode:**

```bash
# Fail if any L0/L1 documents exist
python3 ontos.py map --strict
```

### 9.3 Deprecation Warnings (v2.9.2)

Direct script execution now shows deprecation warnings:

```
[DEPRECATION] Direct execution of ontos_query.py is deprecated.
Use 'python3 ontos.py query' instead.
```

**Suppression:**

```bash
# Suppress CLI notices (for CI/CD)
ONTOS_NO_DEPRECATION_WARNINGS=1 python3 ontos.py map --strict
```

**Note:** Import warnings from `ontos_lib` are intentionally NOT suppressibleâ€”they remind developers to migrate to `ontos.core` before v3.0.

### 9.4 install.py Bootstrap (v2.9.3)

Single-file installer with security features:

| Feature | Description |
|---------|-------------|
| SHA256 verification | Checksums from tag-aligned `checksums.json` |
| Offline support | `--bundle` + `--checksum` flags |
| Upgrade support | `--upgrade` preserves config |
| Path traversal protection | POSIX + Windows |
| Symlink protection | Rejects symlinks in bundles |

**Commands:**

```bash
# Fresh install
python3 install.py

# Offline install
python3 install.py --bundle ./bundle.tar.gz --checksum abc123...

# Upgrade
python3 install.py --upgrade --latest

# Check integrity
python3 install.py --check
```
```

---

### Task E: Update Agent Instructions

**File:** `docs/reference/Ontos_Agent_Instructions.md`
**Priority:** MEDIUM

Add after the "Update Ontos" section (around line 74):

```markdown
### "Install Ontos" (New Project)

1. Download installer:
   ```bash
   curl -sO https://raw.githubusercontent.com/ohjona/Project-Ontos/v2.9.4/install.py
   ```
2. Run: `python3 install.py`
3. Activate: Tell your AI "Ontos"

### "Upgrade Ontos"

```bash
python3 install.py --upgrade --latest
```

### "Create Scaffold" (Quick Document Capture)

```bash
# Preview scaffolds for undocumented files
python3 ontos.py scaffold

# Apply scaffolds
python3 ontos.py scaffold --apply
```

### "Create Stub" (Work-in-Progress Document)

```bash
python3 ontos.py stub --goal "Implement feature X" --type product
```

### "Promote Document" (L0/L1 â†’ L2)

```bash
python3 ontos.py promote path/to/document.md
```

### "Check Schema Migration"

```bash
python3 ontos.py migrate --check
```
```

---

### Task F: Version Bump and CHANGELOG

**Priority:** HIGH

#### F.1 Version Bump

**File:** `.ontos/scripts/ontos_config_defaults.py`

Change line 26:
```python
ONTOS_VERSION = "2.9.4"
```

#### F.2 CHANGELOG Entry

**File:** `Ontos_CHANGELOG.md`

Add after the header, before the v2.9.3 entry:

```markdown
## [2.9.4] - 2025-12-24

### Theme: "Documentation & Polish"

Complete documentation update for v2.9 features and bug fixes.

### Fixed
- **Config merge write bug** - Upgrade now correctly preserves user customizations in `ontos_config.py`

### Added
- **`tests/test_install.py`** - Unit tests for install.py security functions
  - Path traversal detection (POSIX + Windows)
  - Checksum verification
  - Installation detection
  - Config merge functionality

### Changed
- **README.md** - Updated with curl-bootstrap installation instructions
- **Ontos_Manual.md** - Updated to v2.9 with new features documentation:
  - Schema Versioning (v2.9.0)
  - Curation Levels (v2.9.1)
  - Deprecation Warnings (v2.9.2)
  - install.py Bootstrap (v2.9.3)
- **Ontos_Agent_Instructions.md** - Added new CLI commands

---
```

---

## 3. Implementation Order

Execute tasks in this sequence to minimize conflicts:

```
1. Task A: Fix config merge bug (install.py)
2. Task B: Create tests/test_install.py
3. Run tests: pytest tests/test_install.py -v
4. Task C: Update README.md
5. Task D: Update Ontos_Manual.md
6. Task E: Update Agent Instructions
7. Task F: Version bump + CHANGELOG
8. Run full test suite: pytest tests/ .ontos/scripts/tests/ -v
9. Verify context map: python3 ontos.py map --strict
```

---

## 4. Exit Criteria

Before PR submission, verify ALL criteria pass:

| Criterion | Command | Expected |
|-----------|---------|----------|
| All tests pass | `pytest tests/ .ontos/scripts/tests/ -v` | 410+ tests, 0 failures |
| New tests exist | `pytest tests/test_install.py -v` | ~15 tests |
| Context map valid | `python3 ontos.py map --strict` | No errors |
| Version correct | `grep ONTOS_VERSION .ontos/scripts/ontos_config_defaults.py` | "2.9.4" |
| README has curl | `grep "curl -sO" README.md` | Match found |
| Manual is v2.9 | `grep "Ontos Manual v2.9" docs/reference/Ontos_Manual.md` | Match found |

---

## 5. Constraints

| Constraint | Source | Impact |
|------------|--------|--------|
| Zero-dependency | Master Plan | tests/test_install.py can only use pytest |
| Python 3.9+ | Master Plan | Tests must work on 3.9+ |
| No release.yml changes | Deferred to v3.0 | Manual release process continues |

---

## 6. Out of Scope (NOT in v2.9.4)

| Item | Reason |
|------|--------|
| Release workflow automation | Deferred to v3.0 |
| Integration tests for HTTP | Would require mock infrastructure |
| PyPI distribution | Per Master Plan |

---

## 7. Reference Documents

| Document | Location |
|----------|----------|
| Implementation Plan (v1.5.0) | `.ontos-internal/strategy/v2.9/v2.9_implementation_plan.md` |
| v2.9.4 Detailed Spec | `.ontos-internal/strategy/v2.9/v2.9.4_implementation_plan.md` |
| Master Plan | `.ontos-internal/strategy/master_plan.md` |
| LLM Reviews | `.ontos-internal/strategy/proposals/v2.9/*_v2.9.4_*.md` |

---

## 8. Commit Guidelines

```bash
# Use conventional commits
git commit -m "fix(install): persist merged config during upgrade

- Add write_user_config() function
- Preserve comments and structure in ontos_config.py
- Log success/failure appropriately

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## 9. PR Description Template

```markdown
## Summary
- Fix config merge bug in install.py
- Add unit tests for install.py security functions
- Update README with curl-bootstrap instructions
- Update Manual with v2.9 features documentation
- Update Agent Instructions with new commands
- Bump version to 2.9.4

## Test plan
- [ ] All 410+ tests pass
- [ ] `python3 ontos.py map --strict` passes
- [ ] Fresh install test: `curl ... && python3 install.py`
- [ ] Upgrade test: preserves custom config values

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

---

*Good luck, Antigravity. Ship v2.9.4!*

*â€” Chief Architect*
