---
id: v2_9_6_antigravity_instructions
type: strategy
status: complete
depends_on: [v2_9_6_implementation_specification]
concepts: [implementation, agent-prompt, ontology, developer-instructions]
---

# Antigravity Developer Instructions: v2.9.6 Ontology Architecture

---

## Your Inputs

- **Spec:** `.ontos-internal/strategy/proposals/v2.9.6/v2.9.6_Implementation_Specification.md`
- **Branch:** `v2.9.6`
- **Current State:** 303 passing tests, no `ontology.py` exists

---

## Your Job

Implement exactly what the spec says. Nothing more, nothing less.

**Mission:** Create a single source of truth (`ontology.py`) for Ontos document type definitions, eliminating scattered definitions across multiple files.

---

## Rules

1. **Follow the implementation order exactly** (Section 2.8 of spec)
2. **If something is ambiguous, STOP and ask** ‚Äî don't guess
3. **Commit incrementally** (one commit per major step)
4. **Write tests as specified** (Section 4 of spec)
5. **All 303 existing tests must pass** after every step

---

## Constraints

### Readability
- No metaprogramming unless spec requires it
- No clever one-liners (prefer 3 clear lines)
- No deep inheritance (prefer composition)

### Abstraction
- No base classes with one implementation
- No utility functions used only once
- Keep related logic together (80-100 line functions OK)

### YAGNI (Already Applied)
The spec already removed these ‚Äî **DO NOT ADD THEM BACK:**
- ‚ùå `ValidationRule` dataclass
- ‚ùå `VALIDATION_RULES` list
- ‚ùå `STATUS_TRANSITIONS` dataclass
- ‚ùå `examples`, `philosophy`, `rationale`, `default` fields

---

## REFUSAL AUTHORITY: Complexity Flag

You may REFUSE to implement if the spec violates engineering principles.

**Raise a ComplexityFlag if spec asks for:**
- Plugin system with no concrete plugins
- Interface with only one implementation
- Config system for hardcoded values
- Generic solution for one specific case

**How to raise:**

```
‚ö†Ô∏è COMPLEXITY FLAG

I cannot implement [X] as specified because it violates [YAGNI/DRY/KISS]:
- Spec asks for: [what]
- Problem: [why over-engineered]
- Suggestion: [simpler alternative]

Awaiting decision before proceeding.
```

---

## Implementation Steps (Follow Exactly)

### Step 1: Create `ontology.py` (~120 lines)

**File:** `.ontos/scripts/ontos/core/ontology.py`

**What to include:**
1. Module docstring explaining single source of truth
2. Imports: `dataclass`, `Dict`, `List`, `Optional`, `Set`
3. `__all__` with 7 exports
4. `TypeDefinition` frozen dataclass (6 fields)
5. `FieldDefinition` frozen dataclass (6 fields)
6. `_CURATION_STATUSES` constant
7. `TYPE_DEFINITIONS` dict (5 types: kernel, strategy, product, atom, log)
8. `FIELD_DEFINITIONS` dict (10 fields)
9. Three backward-compat helper functions

**Copy code exactly from spec Section 2.2-2.5.**

**Verify:**
```bash
cd .ontos/scripts && python3 -c "from ontos.core.ontology import TYPE_DEFINITIONS; print(TYPE_DEFINITIONS.keys())"
# Expected: dict_keys(['kernel', 'strategy', 'product', 'atom', 'log'])
```

**Commit:** `feat(v2.9.6): add ontology.py - single source of truth for type definitions`

---

### Step 2: Update `__init__.py`

**File:** `.ontos/scripts/ontos/core/__init__.py`

**Add at the end:**
```python
# Ontology definitions (v2.9.6+)
from ontos.core.ontology import (
    TypeDefinition,
    FieldDefinition,
    TYPE_DEFINITIONS,
    FIELD_DEFINITIONS,
    get_type_hierarchy,
    get_valid_types,
    get_valid_type_status,
)
```

**Commit:** `feat(v2.9.6): export ontology module from core`

---

### Step 3: Create Generator Script (~80 lines)

**File:** `.ontos/scripts/ontos_generate_ontology_spec.py`

**Copy code exactly from spec Section 2.7.**

**Verify:**
```bash
python3 .ontos/scripts/ontos_generate_ontology_spec.py
cat docs/reference/ontology_spec.md | head -20
# Should see frontmatter with id: ontology_spec
```

**Commit:** `feat(v2.9.6): add ontology spec generator`

---

### Step 4: Run Verification Script (CRITICAL)

**Before modifying config_defaults**, verify parity between old hardcoded values and new derived values.

**Create temporary file `verify_migration.py`:**
```python
import sys
sys.path.insert(0, '.ontos/scripts')

from ontos.core.ontology import get_valid_type_status

EXPECTED_AFTER_FIX = {
    'kernel': {'active', 'draft', 'deprecated', 'scaffold', 'pending_curation'},
    'strategy': {'active', 'draft', 'deprecated', 'rejected', 'complete', 'scaffold', 'pending_curation'},
    'product': {'active', 'draft', 'deprecated', 'scaffold', 'pending_curation'},
    'atom': {'active', 'draft', 'deprecated', 'complete', 'scaffold', 'pending_curation'},
    'log': {'active', 'archived', 'auto-generated', 'scaffold', 'pending_curation'},
}

derived = get_valid_type_status()
all_ok = True
for type_name, expected in EXPECTED_AFTER_FIX.items():
    actual = derived[type_name]
    if actual != expected:
        print(f"MISMATCH {type_name}: expected {expected}, got {actual}")
        all_ok = False
    else:
        print(f"OK {type_name}")

if all_ok:
    print("\n‚úÖ All types match. Safe to proceed with migration.")
else:
    print("\n‚ùå STOP. Fix mismatches before proceeding.")
```

**Run it:**
```bash
python3 verify_migration.py
```

**Delete the file after verification passes.** Do NOT commit it.

---

### Step 5: Update `ontos_config_defaults.py`

**File:** `.ontos/scripts/ontos_config_defaults.py`

**Changes:**

1. **Add sys.path fix at TOP** (after docstring, before other imports):
```python
import os
import sys

# Ensure ontos package is importable when this file is imported directly
# (v2.9.6: fixes import path fragility per Gemini feedback)
_scripts_dir = os.path.dirname(os.path.abspath(__file__))
if _scripts_dir not in sys.path:
    sys.path.insert(0, _scripts_dir)

from ontos.core.ontology import (
    TYPE_DEFINITIONS as _TYPE_DEFS,
    get_type_hierarchy,
    get_valid_types,
    get_valid_type_status,
)
```

2. **Replace the inline TYPE_DEFINITIONS dict** (around lines 44-74) with:
```python
# Document type definitions (v2.9.6: now derived from ontology.py)
# Backward-compatible dict format for existing code
TYPE_DEFINITIONS = {
    name: {
        'rank': td.rank,
        'description': td.description,
        'allows_depends_on': not td.uses_impacts,
    }
    for name, td in _TYPE_DEFS.items()
}
```

3. **Replace hardcoded derived values:**
```python
# Valid types for early validation
VALID_TYPES = get_valid_types()

# Derived hierarchy for backward compatibility
TYPE_HIERARCHY = get_type_hierarchy()
```

4. **Update VALID_TYPE_STATUS** (around line 137):
```python
# v2.9.6: Now derived from ontology.py (includes scaffold, pending_curation, auto-generated fixes)
VALID_TYPE_STATUS = get_valid_type_status()
```

**Verify:**
```bash
cd .ontos/scripts && python3 -c "from ontos_config_defaults import TYPE_HIERARCHY; print(TYPE_HIERARCHY)"
# Expected: {'kernel': 0, 'strategy': 1, 'product': 2, 'atom': 3, 'log': 4}
```

**Commit:** `feat(v2.9.6): migrate config_defaults to import from ontology.py`

---

### Step 6: Generate Final Spec

```bash
python3 .ontos/scripts/ontos_generate_ontology_spec.py
```

**Verify `docs/reference/ontology_spec.md`:**
- Has valid Ontos frontmatter (`id`, `type`, `status`, `depends_on`)
- Contains "DO NOT EDIT" warning
- Lists all 5 document types with correct statuses
- Lists all frontmatter fields

**Commit:** `docs(v2.9.6): generate ontology_spec.md`

---

### Step 7: Run Full Test Suite

```bash
python3 -m pytest -v
```

**Expected:** All 303 tests pass.

**Also verify:**
```bash
python3 .ontos/scripts/ontos_generate_context_map.py
# Should complete without errors
```

---

### Step 8: Write New Tests (Section 4.1 of spec)

**File:** `tests/test_ontology.py`

Copy the test functions from spec Section 4.1. Add necessary imports:
```python
import pytest
from ontos.core.ontology import (
    TYPE_DEFINITIONS,
    FIELD_DEFINITIONS,
    get_type_hierarchy,
    get_valid_types,
    get_valid_type_status,
)
```

**Run tests:**
```bash
python3 -m pytest tests/test_ontology.py -v
```

**Commit:** `test(v2.9.6): add ontology module tests`

---

## Key Files Summary

| File | Action | Lines |
|------|--------|-------|
| `.ontos/scripts/ontos/core/ontology.py` | CREATE | ~120 |
| `.ontos/scripts/ontos_generate_ontology_spec.py` | CREATE | ~80 |
| `docs/reference/ontology_spec.md` | GENERATE | ~60-80 |
| `.ontos/scripts/ontos_config_defaults.py` | MODIFY | Net ~-20 |
| `.ontos/scripts/ontos/core/__init__.py` | MODIFY | +8 |
| `tests/test_ontology.py` | CREATE | ~50 |

---

## Behavior Changes (Intentional Fixes)

**These are BUGS being fixed, not new features:**

| Change | Why |
|--------|-----|
| `log` type gains `auto-generated` status | Logs already use this in Agent Instructions. Code was wrong. |
| All types gain `scaffold`, `pending_curation` | These curation meta-statuses were in global VALID_STATUS but not per-type. |

---

## Error Handling Reference

| Error | Cause | Fix |
|-------|-------|-----|
| `ImportError: cannot import from ontology` | __init__.py not updated | Add exports to __init__.py |
| `KeyError: 'kernel'` | TYPE_DEFINITIONS incomplete | Verify all 5 types defined |
| `AttributeError: 'dict' has no attribute 'rank'` | Mixing dict and dataclass | Use backward-compat helpers |
| `ModuleNotFoundError: ontos.core.ontology` | sys.path not set | Add sys.path fix to config_defaults |

---

## Pre-PR Checklist

- [ ] All 303+ tests pass
- [ ] `ontology.py` < 150 lines
- [ ] `ontos_generate_ontology_spec.py` < 100 lines
- [ ] `ontology_spec.md` generated and contains all types/fields
- [ ] `ontos_generate_context_map.py` runs without errors
- [ ] No new dependencies added
- [ ] ONTOS_VERSION still "2.9.5" (bump separately on release)

---

## Output

When complete, create PR with:

**Title:** `v2.9.6: Ontology Architecture - Single Source of Truth`

**Description:**
```markdown
## Summary

Implements the Ontology Architecture spec (v2.9.6) to establish a single source of truth for document type definitions.

**Spec:** `.ontos-internal/strategy/proposals/v2.9.6/v2.9.6_Implementation_Specification.md`

## Changes

- **New:** `ontology.py` with TypeDefinition/FieldDefinition dataclasses
- **New:** `ontos_generate_ontology_spec.py` doc generator
- **New:** `docs/reference/ontology_spec.md` generated specification
- **Modified:** `ontos_config_defaults.py` now imports from ontology.py
- **Modified:** `core/__init__.py` exports ontology module

## Behavior Fixes (Intentional)

- Log type now includes `auto-generated` status (was missing)
- All types now include `scaffold`, `pending_curation` statuses

## Test Plan

- [x] All 303 existing tests pass
- [x] New ontology tests pass
- [x] `ontos_generate_context_map.py` runs without errors
- [x] Generated `ontology_spec.md` validates

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
```

---

## Final Notes

1. **Do NOT add anything not in the spec** ‚Äî no extra abstractions, no "nice to have" features
2. **Code snippets in the spec are exact** ‚Äî copy them, don't rewrite
3. **The spec was reviewed by 3 LLMs** ‚Äî trust it, but flag if something seems wrong
4. **Commit incrementally** ‚Äî easier to debug if something breaks
