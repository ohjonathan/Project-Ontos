# Ontos v3.0.4 Implementation Spec

**Version:** 1.1
**Author:** Claude Opus 4.5 (Chief Architect)
**Date:** 2026-01-19
**Status:** Approved

---

## 1. Executive Summary

This is a **targeted bug fix** release addressing the CLI wrapper command execution bug. Three wrapper commands (`verify`, `query`, `consolidate`) that were marked as broken in v3.0.3 will be fixed.

| Category | Count | Action |
|----------|-------|--------|
| Files Modified | 2 | `cli.py`, `__init__.py` |
| Lines Changed | ~15 | Function rewrite + line removal |
| Commands Fixed | 3 | verify, query, consolidate |

**Total changes:** 2 files, minimal code modifications

---

## 2. Exact Code Changes

### 2.1 `ontos/cli.py` - Function `_get_subprocess_env()` (Lines 19-32)

**Current Code:**
```python
def _get_subprocess_env() -> dict:
    """Get environment for subprocess calls with PYTHONPATH set.

    Ensures subprocesses can import from ontos package in source checkouts
    by adding the project root to PYTHONPATH.
    """
    env = os.environ.copy()
    project_root = str(Path(__file__).parent.parent)
    existing_pythonpath = env.get('PYTHONPATH', '')
    if existing_pythonpath:
        env['PYTHONPATH'] = f"{project_root}{os.pathsep}{existing_pythonpath}"
    else:
        env['PYTHONPATH'] = project_root
    return env
```

**New Code:**
```python
def _get_subprocess_env() -> dict:
    """Get environment for subprocess calls.

    Sets:
    - ONTOS_PROJECT_ROOT: User's current working directory (for legacy script compatibility)
    - PYTHONPATH: Includes user's project root for config imports
    """
    env = os.environ.copy()
    # Use user's CWD as project root, not package installation directory
    project_root = str(Path.cwd())
    env['ONTOS_PROJECT_ROOT'] = project_root
    # Add project root to PYTHONPATH for legacy config imports
    existing_pythonpath = env.get('PYTHONPATH', '')
    if existing_pythonpath:
        env['PYTHONPATH'] = f"{project_root}{os.pathsep}{existing_pythonpath}"
    else:
        env['PYTHONPATH'] = project_root
    return env
```

**Key Differences:**
1. Changed `Path(__file__).parent.parent` → `Path.cwd()` (uses user's working dir)
2. Added `env['ONTOS_PROJECT_ROOT'] = project_root` (enables legacy script discovery)
3. Updated docstring to reflect actual behavior

### 2.2 `ontos/cli.py` - Function `_cmd_wrapper()` (Line 410)

**Current Code:**
```python
        result = subprocess.run(cmd, capture_output=True, text=True, env=_get_subprocess_env(), cwd=str(Path(__file__).parent.parent))
```

**New Code:**
```python
        result = subprocess.run(cmd, capture_output=True, text=True, env=_get_subprocess_env())
```

**Key Difference:** Removed `cwd=str(Path(__file__).parent.parent)` parameter. Subprocess now inherits user's CWD.

### 2.3 `ontos/__init__.py` - Version (Line 10)

**Current Code:**
```python
__version__ = "3.0.3"
```

**New Code:**
```python
__version__ = "3.0.4"
```

---

## 3. Verification Protocol

### 3.1 Post-Fix Syntax Check (Must Pass)

```bash
python3 -m py_compile ontos/cli.py && echo "cli.py: OK"
python3 -m py_compile ontos/__init__.py && echo "__init__.py: OK"
```

### 3.2 Version Check

```bash
python3 -m ontos --version
# Expected: ontos 3.0.4
```

### 3.3 Native Command Regression Check (Must Still Work)

```bash
python3 -m ontos doctor
python3 -m ontos map --help
python3 -m ontos init --help
```

### 3.4 Wrapper Command Fix Check (Must Now Work)

```bash
# Create temporary test environment
cd /tmp && mkdir ontos-v304-test && cd ontos-v304-test
git init

# Initialize Ontos
python3 -m ontos init

# Create minimal document
mkdir docs
echo '---
id: test_doc
type: atom
status: active
---
# Test' > docs/test.md

# Test wrapper commands (these were broken before)
python3 -m ontos verify --help    # Should show help, not error
python3 -m ontos query --help     # Should show help, not error
python3 -m ontos consolidate --help  # Should show help, not error

# Test actual execution
python3 -m ontos map              # Generate context map
python3 -m ontos verify --all     # Should work, not ModuleNotFoundError

# Cleanup
cd /tmp && rm -rf ontos-v304-test
```

### 3.5 Test Suite (Must Pass)

```bash
pytest tests/ -v --ignore=tests/golden/
```

---

## 4. Command Status After v3.0.4

| Command | Type | Status |
|---------|------|--------|
| `ontos init` | Native | Working |
| `ontos map` | Native | Working |
| `ontos doctor` | Native | Working |
| `ontos agents` | Native | Working |
| `ontos log` | Native | Working |
| `ontos hook` | Native | Working |
| `ontos export` | Native (deprecated) | Working |
| `ontos scaffold` | Wrapper | Working |
| `ontos stub` | Wrapper | Working |
| `ontos promote` | Wrapper | Working |
| `ontos migrate` | Wrapper | Working |
| `ontos verify` | Wrapper | **FIXED** |
| `ontos query` | Wrapper | **FIXED** |
| `ontos consolidate` | Wrapper | **FIXED** |

---

## 5. Implementation Checklist

- [ ] Read `ontos/cli.py` to verify current code matches expected
- [ ] Apply fix to `_get_subprocess_env()` function (lines 19-32)
- [ ] Apply fix to `_cmd_wrapper()` subprocess.run call (line 410)
- [ ] Update version in `ontos/__init__.py` (line 10)
- [ ] Run `py_compile` on both files (must pass)
- [ ] Run version check (must show 3.0.4)
- [ ] Run native command regression check (must work)
- [ ] Run wrapper command fix check in temp directory (must work)
- [ ] Run test suite (must pass)
- [ ] Commit with message per proposal Section 11

---

## 6. Risk Assessment

**Overall Risk: LOW**

| Risk Factor | Assessment |
|-------------|------------|
| Code complexity | Simple - function rewrite, line removal |
| Scope of change | Minimal - 2 files, 15 lines |
| Regression potential | Low - native commands unaffected |
| Backward compatibility | Full - adds information, removes nothing |

---

## 7. Critical Files Summary

| File | Location | Change Type |
|------|----------|-------------|
| `ontos/cli.py` | Lines 19-32 | Rewrite `_get_subprocess_env()` |
| `ontos/cli.py` | Line 410 | Remove `cwd=` parameter |
| `ontos/__init__.py` | Line 10 | Version bump `3.0.3` → `3.0.4` |

---

*Claude Opus 4.5 - 2026-01-19*
