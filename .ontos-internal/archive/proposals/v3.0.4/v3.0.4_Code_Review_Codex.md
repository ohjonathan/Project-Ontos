# Adversarial Code Review — Ontos v3.0.4 (PR #50)

Loaded: [phase_v3_0_4_implementation_spec, v3.0.3_Implementation_Spec, v3_0_4_cli_wrapper_fix_proposal]

## Part 1: Regression Hunt

| Test | Result | Notes |
|------|--------|-------|
| pytest suite | Fail | `pytest` not available in environment (command not found). |
| `python3 -m ontos doctor` | Pass | 2 warnings: missing hooks, AGENTS.md staleness. |
| `python3 -m ontos map --help` | Pass | Help output OK. |
| `python3 -m ontos init --help` | Pass | Help output OK. |
| `python3 -m ontos agents --help` | Pass | Help output OK. |
| `python3 -m ontos log --help` | Pass | Help output OK. |
| `python3 -m ontos verify --help` | Pass | Help output OK. |
| `python3 -m ontos query --help` | Pass | Help output OK. |
| `python3 -m ontos consolidate --help` | Pass | Help output OK. |
| `python3 -m ontos scaffold --help` | Pass | Help output OK. |
| `python3 -m ontos stub --help` | Pass | Help output OK. |
| `python3 -m ontos promote --help` | Pass | Help output OK. |
| `python3 -m ontos migrate --help` | Pass | Help output OK. |

Additional wrapper execution (not just help):
- `python3 -m ontos verify` in fresh repo **FAILED** with `ModuleNotFoundError: No module named 'ontos.core'; 'ontos' is not a package`.
- `python3 -m ontos query` in fresh repo **FAILED** with the same error.

## Part 2: Edge Case Testing

| Edge Case | Tested? | Result | Expected | Match? |
|-----------|---------|--------|----------|--------|
| Fresh repo (`verify --help`) | Yes | Exit 0, help printed | Works | Yes |
| Subdirectory execution (`map` from docs/) | Yes | Context map generated at project root | Partial | Mostly (works; not partial) |
| Non-project dir (`verify --help`) | Yes | Help printed | Graceful fail/help | Yes |
| Root `/` (`verify --help`) | Yes | Help printed | Graceful fail/help | Yes |
| Path with spaces | Yes | Help printed | Works | Yes |
| Pre-set env var (`ONTOS_PROJECT_ROOT=/custom/path verify --help`) | Yes | Help printed | Respected | Inconclusive (help path doesn’t exercise config imports) |

Unexpected behaviors:
- `python3 -m ontos verify --all` is rejected by CLI (argparse) before wrapper execution; wrapper args are not pass-through.
- `python3 -m ontos verify` (no args) crashes before doing useful work (see findings).

## Part 3: Error Path Analysis

Try/except:
```python
try:
    project_root = str(Path.cwd())
except OSError:
    project_root = "/"
```

| Question | Answer |
|----------|--------|
| Is `OSError` the right exception? | Mostly yes; covers `FileNotFoundError`/`PermissionError`. |
| Could other exceptions occur? | Rare, but `RuntimeError` or unexpected `ValueError` are possible if CWD state is corrupted. |
| Is `/` a safe fallback? | Risky; it pollutes `PYTHONPATH` with `/` and can lead to unexpected imports or writes when run as privileged user. |
| Is the error logged/reported? | No; failure is silent until later errors. |

## Part 4: Security Review

PYTHONPATH injection test (`ontos_config.py` in CWD):
- `python3 -m ontos verify --help` did **not** execute malicious code (help path doesn’t import config).
- Could not validate actual import path via `verify --all` (arg not supported by wrapper).
- The risk still stands: wrapper execution imports `ontos_config` from `PYTHONPATH`, and `PYTHONPATH` now includes CWD.

| Security Check | Result | Acceptable? |
|----------------|--------|-------------|
| CWD in PYTHONPATH | Yes (by design) | Documented risk; still exploitable if run in untrusted dirs. |
| Import shadowing possible | Yes | Not mitigated; should be acknowledged. |
| Actual exploitation | Not observed via `--help` | Inconclusive without running wrapper script with real args. |

## Part 5: Code Path Analysis

```
python3 -m ontos verify --help
  → argparse handles help; _cmd_wrapper never runs
```

```
python3 -m ontos verify
  → cli.py:_cmd_wrapper
    → _get_subprocess_env()
    → subprocess.run([sys.executable, ontos/_scripts/ontos_verify.py], env=...)
```

`_get_subprocess_env` usage:
- Only referenced by `_cmd_wrapper` (confirmed via `rg _get_subprocess_env`).
- Other subprocess calls exist elsewhere; no similar fix applied.

## Part 6: Concurrency / Race Conditions

No new concurrency hazards identified beyond existing low-risk patterns.

## Part 7: Issues Found

### Critical (Will Cause Failure)

| # | Issue | How Found | Impact | Fix |
|---|-------|-----------|--------|-----|
| X-C1 | Wrapper commands still crash on fresh repo due to `ontos` shadowing | Ran `python3 -m ontos verify` and `query` in new repo | The primary fix claim (wrapper commands usable in new repos) fails; errors: `ModuleNotFoundError: No module named 'ontos.core'; 'ontos' is not a package` | Execute legacy scripts via module (`python -m ontos._scripts.ontos_verify`) or ensure `sys.path` order avoids `ontos/_scripts/ontos.py` shadowing. Consider removing/renaming `ontos/_scripts/ontos.py` from package data. |

### High (Significant Risk)

| # | Issue | How Found | Impact | Fix |
|---|-------|-----------|--------|-----|
| X-H1 | `ONTOS_PROJECT_ROOT` is not respected for `PYTHONPATH` | Code review of `ontos/cli.py` | If user sets `ONTOS_PROJECT_ROOT` to a different path, wrapper imports `ontos_config` from CWD instead, leading to wrong config or unexpected behavior | When env var is set, use it for `project_root` used in `PYTHONPATH`, not `Path.cwd()`. |

### Medium (Should Address)

| # | Issue | How Found | Impact | Fix |
|---|-------|-----------|--------|-----|
| X-M1 | Verification protocol uses `--help` which never hits wrapper execution | Observed CLI behavior | Tests can pass while wrappers still fail (as seen) | Add a real wrapper execution test (e.g., `python3 -m ontos verify` or a safe no-op call). |
| X-M2 | Fallback `project_root = "/"` silently broadens import surface | Code review | `PYTHONPATH` includes `/` on error; could import unexpected modules or attempt writes to root | Log a warning and avoid adding `/` to `PYTHONPATH` when it is not a valid project root. |

## Part 8: Verdict

**Implementation Robustness:** Fragile

**Recommendation:** Request Changes

**Top 3 Concerns:**
1. Wrapper commands still fail to import `ontos.core` when executed (primary bug not fixed).
2. `ONTOS_PROJECT_ROOT` is ignored for `PYTHONPATH`, breaking the expected override semantics.
3. Validation steps don’t exercise the wrapper path; false confidence in fix.

**The thing most likely to bite us:** Wrapper commands still crash in new repos because `ontos/_scripts/ontos.py` shadows the `ontos` package.

---
**Review signed by:**
- **Role:** Adversarial Reviewer
- **Model:** Codex (OpenAI)
- **Date:** 2026-01-19
- **Review Type:** Code Review (Phase D.2)
- **PR:** #50
