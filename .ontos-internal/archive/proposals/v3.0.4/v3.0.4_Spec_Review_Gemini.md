# v3.0.4 Spec Review: Gemini 2.5 Pro

**Reviewer:** Gemini 2.5 Pro (Peer Reviewer)
**Phase:** B.1 (Spec Review — Parallel)
**Spec Version:** v1.0
**Date:** 2026-01-19

---

## Part 1: Completeness Check

| Expected Section | Present? | Adequate? | Notes |
|------------------|:--------:|:---------:|-------|
| Overview | ✅ | Yes | Clear summary of the bug and fix scope. |
| Scope (In/Out) | ✅ | Yes | Explicitly excludes migrating commands to native (v3.1). |
| Dependencies | ✅ | **No** | **Critical Issue:** Frontmatter lists `v3_0_3_implementation_spec` but the actual file ID is `v3.0.3_Implementation_Spec`. |
| Technical Design | ✅ | Yes | Code changes are explicitly defined. |
| Open Questions | ✅ | Yes | None identified, which is appropriate for a focused bug fix. |
| Test Strategy | ✅ | Yes | Manual protocol is robust; acknowledges lack of auto-tests. |
| Edge Cases | ✅ | Yes | Covers subdirectory execution and non-project directories. |
| Risks & Mitigations | ✅ | Yes | Low risk assessment is accurate. |
| Acceptance Criteria | ✅ | Yes | Clear and verifiable. |
| Implementation Checklist | ✅ | Yes | Step-by-step guide is solid. |

**Missing Elements:**
- None. The spec structure is complete.

---

## Part 2: Quality Assessment

| Aspect | Rating | Notes |
|--------|--------|-------|
| Technical approach | Good | Switching to `Path.cwd()` is the correct fix for the root cause. |
| Clarity of changes | Good | Diff-style presentation is unambiguous. |
| Code snippet accuracy | **Adequate** | `_get_subprocess_env` logic is sound, but see Technical Soundness regarding variable naming. |
| Testability | Adequate | Manual testing is heavy but necessary given subprocess complexity. |
| Risk assessment | Good | "Low" is appropriate; regression risk is minimal. |

---

## Part 3: Implementability Review

Can a developer (Antigravity/Codex) implement this spec without asking questions?

| Question | Answer | Issue? |
|----------|--------|--------|
| Are all file paths explicit? | Yes | `ontos/cli.py`, `ontos/__init__.py`. |
| Are line numbers verified and current? | Yes | Verified against current codebase. |
| Are code snippets copy-paste ready? | Yes | Snippets are complete. |
| Are test commands runnable as-is? | Yes | `py_compile` and manual steps are clear. |
| Is the commit message specified? | Yes | Section 10, Item 8. |

**Ambiguities Found:**
- None in the instructions themselves.

---

## Part 4: Technical Soundness

Review the actual fix:

| Check | Assessment |
|-------|------------|
| Does `Path.cwd()` solve the root cause? | **Yes**. It removes the hardcoded package path restriction. |
| Is removing `cwd=` parameter correct? | **Yes**. Subprocess inherits parent CWD by default. |
| Is `ONTOS_PROJECT_ROOT` necessary? | **Yes**. Legacy scripts rely on this variable. |
| Will PYTHONPATH change cause issues? | **Minor Concern**. See below. |

**Technical Concerns:**
- **Variable Naming vs Value:** The variable is named `ONTOS_PROJECT_ROOT`, but the value assigned is `Path.cwd()`. If the user runs `ontos verify` from a subdirectory (e.g., `docs/`), `ONTOS_PROJECT_ROOT` will be set to `.../project/docs`, which is **not** the project root.
    - *Impact:* If legacy scripts blindly trust `ONTOS_PROJECT_ROOT` to find `.ontos.toml` or `.ontos/` relative to it, they might fail when run from subdirectories.
    - *Mitigation:* The Spec's "Edge Cases" section claims scripts "walk up" to find the root. If this is true, the misnamed variable might be ignored or used only as a fallback hint. However, the naming is technically incorrect in subdirectory scenarios.

---

## Part 5: Documentation Quality

| Check | Status | Notes |
|-------|--------|-------|
| Docstrings updated? | ✅ | Yes, `_get_subprocess_env` docstring is updated. |
| Rationale explained? | ✅ | Yes, Section 4.2 explains rationale clearly. |
| Edge cases documented? | ✅ | Yes, Section 7 covers subdirectory execution. |
| Verification steps clear? | ✅ | Yes, step-by-step protocol. |

---

## Part 6: Issues Found

**Critical (Blocks Implementation):**

| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| P-C1 | Broken Dependency ID | Frontmatter | Change `v3_0_3_implementation_spec` to `v3.0.3_Implementation_Spec` to match the actual ID of the previous spec. |

**Major (Should Fix Before Implementation):**

| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| P-M1 | `ONTOS_PROJECT_ROOT` is semantically ambiguous | 4.1 | The variable is set to `Path.cwd()`. In subdirectories, this is not the project root. Either rename the variable to `ONTOS_CWD` (if scripts support it) or clarify in the spec that legacy scripts *must* perform their own root discovery regardless of this variable. If scripts rely *solely* on this variable for root detection, the fix is incomplete for subdirectory support. |

**Minor (Consider Fixing):**

| # | Issue | Section | Suggestion |
|---|-------|---------|------------|
| P-m1 | Docstring wording | 4.1 | The new docstring says "Sets: ONTOS_PROJECT_ROOT: User's current working directory". This is accurate to the code, but confirms the ambiguity noted in P-M1. |

---

## Part 7: Verdict

**Recommendation:** [ ] Approve / [x] Approve with changes / [ ] Request revision

**Blocking Issues Count:** 1 (Dependency ID)

**Summary:**
The spec provides a solid technical fix for the directory execution bug. The switch to `Path.cwd()` is correct. However, a critical dependency ID mismatch in the frontmatter must be fixed to maintain graph integrity. Additionally, the semantic difference between `CWD` and `PROJECT_ROOT` in subdirectory scenarios warrants a double-check to ensure legacy scripts don't fail when run from `docs/`.

**Top Concerns:**
1. **Broken Dependency Link:** `v3_0_3...` does not exist; `v3.0.3...` does.
2. **Subdirectory Execution:** Will legacy scripts fail if `ONTOS_PROJECT_ROOT` points to `docs/` instead of the actual root?

---
**Review signed by:**
- **Role:** Peer Reviewer
- **Model:** Gemini 2.5 Pro
- **Date:** 2026-01-19
- **Review Type:** Spec Review (Phase B.1)
- **Spec Version:** v1.0
