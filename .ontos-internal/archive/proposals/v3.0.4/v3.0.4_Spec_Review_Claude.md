# v3.0.4 Spec Review — Alignment Reviewer

**Phase:** B.1 (Spec Review — Parallel)  
**Reviewer:** Alignment Reviewer  
**Model:** Claude Opus 4.5 (Antigravity, powered by Gemini 2.5 Pro)  
**Review Type:** Compliance, Consistency, Constraints  
**Spec Version:** v1.1  

---

## Part 1: Patch Phase Compliance

Per playbook Section 13.2, this is a **patch/polish phase**.

| Constraint | Compliant? | Evidence |
|------------|------------|----------|
| No breaking changes | ✓ Yes | Spec Section 4 shows all commands retain same behavior; only internal path resolution changes |
| Bug fixes only (no new features) | ⚠ Partial | Sets `ONTOS_PROJECT_ROOT` env var unconditionally—this is new behavior (see A-M1) |
| Backward compatibility maintained | ✓ Yes | Exit codes, CLI flags, output locations unchanged |
| Scope limited to fixing existing issues | ✓ Yes | Fixes wrapper command CWD bug only |

**Deviations from Patch Phase Guidelines:**

| Deviation | Spec Section | Why This Matters |
|-----------|--------------|------------------|
| Unconditional `ONTOS_PROJECT_ROOT` export | Section 2.1 | Could override user-set env vars; adds behavior not present in v3.0.3 |

---

## Part 2: Playbook Template Compliance

Does the spec follow the required template (Section 6.4)?

| Required Section | Present? | Complete? | Notes |
|------------------|----------|-----------|-------|
| Overview with Risk Level | ⚠ Partial | ✓ | Risk in Section 6, not Section 1 |
| Scope (In/Out) | ✗ Missing | — | No explicit In-Scope/Out-of-Scope list |
| Dependencies | ✗ Missing | — | No explicit dependencies listed |
| Technical Design (file-level) | ✓ Present | ✓ | Sections 2.1–2.3 with exact line numbers |
| Open Questions | ✗ Missing | — | CA Notes has caveats but spec lacks "Open Questions" |
| Test Strategy (unit/integration/manual) | ⚠ Partial | ⚠ | Manual verification only (Section 3), no new automated tests |
| Risks & Mitigations | ✓ Present | ✓ | Section 6 |
| Acceptance Criteria (measurable) | ✓ Present | ✓ | Section 3 verification steps = implicit criteria |

> [!NOTE]
> Missing sections are minor template deviations for a patch spec. The core technical content is complete.

---

## Part 3: Consistency with Native Commands

The fix changes wrapper commands to use `Path.cwd()`. Native commands use `find_project_root()` from `ontos/io/files.py`.

| Aspect | Native Commands | Wrapper Commands (After Fix) | Consistent? |
|--------|-----------------|------------------------------|-------------|
| Path resolution | `find_project_root()` from CWD (L19-57) | `Path.cwd()` directly | ⚠ Different |
| Config loading | Via `find_project_root()` → `.ontos.toml` | Via `ONTOS_PROJECT_ROOT` env var | ⚠ Different mechanism |
| Error handling | Raises `FileNotFoundError` if no project root | Passes CWD regardless; script handles errors | ✓ Scripts maintain own error handling |

**Consistency Concerns:**

| Concern | Details |
|---------|---------|
| **Path resolution asymmetry** | Native commands walk up to find `.ontos.toml` or `.git`; wrapper commands assume CWD is project root. If user runs from subdir, wrapper commands will use wrong root. |
| **Mitigation acknowledged** | CA Notes Section 2.2 documents this as technical debt for v3.1 migration. |

---

## Part 4: Prior Decision Alignment

| Prior Decision | Spec Aligned? | Evidence |
|----------------|---------------|----------|
| Wrapper commands use subprocess | ✓ Yes | `subprocess.run()` retained (L410) |
| Native commands use `find_project_root()` | ✓ Yes | No changes to native commands |
| PYTHONPATH manipulation for source checkouts | ✓ Yes | Spec Section 2.1 preserves PYTHONPATH logic |
| `ONTOS_PROJECT_ROOT` env var pattern | ✓ Yes | Pattern established in v3.0.2 scripts |

**Deviations from Prior Decisions:**

| Deviation | Spec Says | Prior Decision | Severity |
|-----------|-----------|----------------|----------|
| None identified | — | — | — |

---

## Part 5: Backward Compatibility Check

| Interface | Changed? | Breaking? | Notes |
|-----------|----------|-----------|-------|
| CLI commands (user-facing) | No | No | Same commands, same flags |
| Output locations | No | No | Files still go to project root |
| Exit codes | No | No | Unchanged |
| Environment variables | **Yes** | No | `ONTOS_PROJECT_ROOT` now always set in subprocess |
| Config file handling | No | No | Scripts still read `.ontos.toml` via `ONTOS_PROJECT_ROOT` |

---

## Part 6: Constraint Verification

| Constraint | Respected? | Evidence |
|------------|------------|----------|
| No changes to native commands | ✓ Yes | Only `cli.py` modified; no changes to `commands/` |
| No new dependencies | ✓ Yes | Uses stdlib `Path`, `os`, `subprocess` only |
| No new CLI flags | ✓ Yes | No flag additions |
| Version bump follows semver | ✓ Yes | 3.0.3 → 3.0.4 (patch increment) |

---

## Part 7: CA Notes Review

| Decision | Justified? | Concerns |
|----------|------------|----------|
| Use `Path.cwd()` instead of config-based root | ✓ Yes | Avoids import dependency in `_get_subprocess_env()` |
| Set `ONTOS_PROJECT_ROOT` unconditionally | ⚠ Arguable | Could use `env.setdefault()` to respect user overrides |
| Remove `cwd=` parameter entirely | ✓ Yes | Correct—subprocess inherits parent CWD |
| Accept PYTHONPATH includes user's CWD | ✓ Yes | Same as editable install behavior |

---

## Part 8: Issues Found

**Critical (Alignment Violations):**

| # | Issue | Type | Why Critical |
|---|-------|------|--------------|
| — | None | — | — |

**Major (Should Address):**

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-M1 | Unconditional `ONTOS_PROJECT_ROOT` overrides user env | Compliance | Use `env.setdefault('ONTOS_PROJECT_ROOT', project_root)` to respect pre-set values |
| A-M2 | Spec claims v1.0 in CA Notes but is v1.1 | Consistency | Update CA Notes reference to match spec version |
| A-M3 | Missing Scope (In/Out) section per template | Compliance | Add explicit scope boundaries |

**Minor (Consider):**

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-m1 | No new automated tests for fix | Compliance | CA Notes acknowledges this; acceptable for patch |
| A-m2 | Path resolution asymmetry with native commands | Consistency | Document in Known Issues; defer to v3.1 |
| A-m3 | Spec has 7 wrapper commands but only fixes 3 | Consistency | CA Notes Section 1.1 corrects this—spec Section 4 should match |

---

## Part 9: Verdict

**Alignment Status:** [x] Minor Deviations

**Recommendation:** [x] Approve (with requested changes)

**Blocking Issues Count:** 0

**Summary:**
The spec is fundamentally sound and addresses the root cause correctly. The `Path.cwd()` fix aligns with how native commands resolve paths. Three minor-to-major issues identified: (1) unconditional env var override, (2) version reference mismatch between spec and CA Notes, (3) missing template sections. None are blocking for a patch release, but A-M1 should be addressed before merge to avoid surprising users who intentionally set `ONTOS_PROJECT_ROOT`.

---

## Critical Instructions Compliance

1. ✓ Flagged deviations (A-M1, A-M2, A-M3)
2. ✓ Checked all constraints (Part 6)
3. ✓ Verified backward compatibility (Part 5)
4. ✓ Objective assessment without judgment
5. ✓ Reviewed CA Notes (Part 7)
6. ✓ No unauthorized scope expansion detected

---

**Review signed by:**
- **Role:** Alignment Reviewer
- **Model:** Claude Opus 4.5 (Antigravity, powered by Gemini 2.5 Pro)
- **Date:** 2026-01-19
- **Review Type:** Spec Review (Phase B.1)
- **Spec Version:** v1.1

---

*Workflow Position: Phase B.1 (Parallel with Peer and Adversarial reviews)*  
*Next: Consolidation (B.2)*
