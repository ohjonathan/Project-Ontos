# Ontos v3.0.5 Implementation Spec

**Version:** 1.1
**Author:** Claude Opus 4.5 (Chief Architect)
**Date:** 2026-01-20
**Status:** Approved (post-review)

---

## Changelog (v1.0 → v1.1)

| Section | Change | Reason |
|---------|--------|--------|
| 3.1 VER-1 | "3.0.4" → "3.0.5" | B1: Version must match release |
| 3.3.4 | Updated KeyboardInterrupt handling | N2: Abort entire init on Ctrl+C |
| 3.4 | Added Ctrl+C test case | N7: Test edge case |
| 5.1 | Updated verification grep | B1: Check for 3.0.4, not 3.0.3 |
| 7.1 | "Breaking Change" → "Behavioral Change" | N3: Accurate terminology |
| 7.1 | Clarified TTY-attached script behavior | N4: Disambiguation |
| 9, 10 | Updated version targets | B1: Sync with v1.1 changes |

---

## 1. Executive Summary

This is a **targeted maintenance release** addressing version hygiene, UX improvements for hook consent, and wrapper command documentation. The release implements 5 scope items from the Chief Architect Triage Response.

| Category | Count | Action |
|----------|-------|--------|
| Files Modified | 6 | `ontos_config_defaults.py`, `mcp/__init__.py`, `cli.py`, `init.py`, `test_init_phase3.py`, `README.md` |
| Lines Changed | ~110 | Version fix, warning addition, consent flow, tests, documentation |
| Scope Items | 5 | VER-1, MCP-1, UX-1, WRP-1, UX-2 |

**Total changes:** 6 files, moderate code modifications focused on UX and hygiene

---

## 2. Scope Items Overview

| ID | Issue | Severity | Effort | Summary |
|----|-------|----------|--------|---------|
| VER-1 | Version string mismatch | High | Trivial | Legacy config still shows "3.0.3" |
| MCP-1 | MCP extra is no-op | Medium | Low | Users install `ontos[mcp]` expecting functionality |
| UX-1 | Init hooks consent | Medium | Low | Silent hook installation erodes trust |
| WRP-1 | Wrapper command testing | Medium | Medium | Document actual wrapper command behavior |
| UX-2 | Known Issues outdated | Medium | Low | README doesn't reflect current reality |

---

## 3. Exact Code Changes

### 3.1 VER-1: Version String Mismatch

**File:** `ontos/_scripts/ontos_config_defaults.py` (Line 56)

**Current Code:**
```python
ONTOS_VERSION = "3.0.3"
```

**New Code:**
```python
ONTOS_VERSION = "3.0.5"
```

**Rationale:** Legacy scripts use `ONTOS_VERSION` for compatibility checks. This must match the release version (v3.0.5) to avoid confusion.

---

### 3.2 MCP-1: MCP Import Warning

**File:** `ontos/mcp/__init__.py`

**Current Code:**
```python
"""MCP module - Placeholder for Phase 2."""
```

**New Code:**
```python
"""MCP module - Placeholder for Phase 2."""
import warnings

warnings.warn(
    "The 'ontos.mcp' module is a placeholder for Phase 2. "
    "No functionality is currently available.",
    FutureWarning,
    stacklevel=2
)
```

**Rationale:** Users who install `pip install ontos[mcp]` or import `from ontos import mcp` expect functionality. FutureWarning clearly communicates the placeholder status without breaking imports. `FutureWarning` is semantically correct—this module *will* become functional in Phase 2.

**Note:** `stacklevel=2` will be verified during implementation to ensure it points to the user's import statement.

---

### 3.3 UX-1: Init Hooks Consent

#### 3.3.1 Add `--yes` Flag to CLI

**File:** `ontos/cli.py` (Lines 103-111)

**Current Code:**
```python
def _register_init(subparsers, parent):
    """Register init command."""
    p = subparsers.add_parser("init", help="Initialize Ontos in a project", parents=[parent])
    p.add_argument("--force", "-f", action="store_true",
                   help="Overwrite existing config and hooks")
    p.add_argument("--skip-hooks", action="store_true",
                   help="Don't install git hooks")
    p.set_defaults(func=_cmd_init)
```

**New Code:**
```python
def _register_init(subparsers, parent):
    """Register init command."""
    p = subparsers.add_parser("init", help="Initialize Ontos in a project", parents=[parent])
    p.add_argument("--force", "-f", action="store_true",
                   help="Overwrite existing config and hooks")
    p.add_argument("--skip-hooks", action="store_true",
                   help="Don't install git hooks")
    p.add_argument("--yes", "-y", action="store_true",
                   help="Non-interactive mode: accept all defaults")
    p.set_defaults(func=_cmd_init)
```

#### 3.3.2 Update `_cmd_init` to Pass `yes` Flag

**File:** `ontos/cli.py` (Lines 234-240)

**Current Code:**
```python
    options = InitOptions(
        path=Path.cwd(),
        force=args.force,
        skip_hooks=getattr(args, "skip_hooks", False),
    )
```

**New Code:**
```python
    options = InitOptions(
        path=Path.cwd(),
        force=args.force,
        skip_hooks=getattr(args, "skip_hooks", False),
        yes=getattr(args, "yes", False),
    )
```

#### 3.3.3 Update `InitOptions` Dataclass

**File:** `ontos/commands/init.py` (Lines 14-21)

**Current Code:**
```python
@dataclass
class InitOptions:
    """Configuration for init command."""
    path: Path = None
    force: bool = False
    interactive: bool = False  # Reserved for v3.1
    skip_hooks: bool = False
```

**New Code:**
```python
@dataclass
class InitOptions:
    """Configuration for init command."""
    path: Path = None
    force: bool = False
    interactive: bool = False  # Reserved for v3.1
    skip_hooks: bool = False
    yes: bool = False
```

#### 3.3.4 Add `_confirm_hooks()` Function

**File:** `ontos/commands/init.py` (Insert after line 21, before `init_command`)

**New Code:**
```python
def _confirm_hooks(options: InitOptions) -> bool:
    """Confirm hook installation with user in TTY contexts.

    Returns:
        True if hooks should be installed, False otherwise.

    Raises:
        KeyboardInterrupt: If user presses Ctrl+C (aborts entire init)

    Behavioral matrix:
        skip_hooks=True  -> False (user explicitly skipped)
        yes=True         -> True  (non-interactive mode)
        non-TTY          -> True  (CI/scripts proceed)
        TTY              -> prompt user
    """
    if options.skip_hooks:
        return False  # User explicitly skipped
    if options.yes:
        return True   # Non-interactive mode
    if not sys.stdin.isatty():
        return True   # Non-TTY: proceed (CI/scripts)

    # Print preflight message
    print("\nGit hooks to be installed:")
    print("  - pre-commit: Validates documentation before commits")
    print("  - pre-push: Ensures context map exists before push")
    print("\nHooks location: .git/hooks/")
    print("Use --skip-hooks to skip installation.\n")

    try:
        response = input("Install git hooks? [Y/n] ").strip().lower()
        return response in ('', 'y', 'yes')
    except EOFError:
        print("\nSkipping hooks.")
        return False
    except KeyboardInterrupt:
        print("\nAborted.")
        raise  # Re-raise to abort init entirely
```

**v1.1 Change:** KeyboardInterrupt now re-raises to abort the entire init operation, rather than silently skipping hooks. Users expect Ctrl+C to abort operations entirely.

#### 3.3.5 Update `init_command` to Use `_confirm_hooks()`

**File:** `ontos/commands/init.py` (Lines 63-64)

**Current Code:**
```python
    # 7. Install hooks (with collision safety)
    hooks_status = _install_hooks(project_root, options)
```

**New Code:**
```python
    # 7. Install hooks (with collision safety and consent)
    try:
        if _confirm_hooks(options):
            hooks_status = _install_hooks(project_root, options)
        else:
            hooks_status = 0  # Skipped by user choice
    except KeyboardInterrupt:
        # Cleanup partial initialization on Ctrl+C
        config_path = project_root / ".ontos.toml"
        if config_path.exists():
            config_path.unlink()
        print("Init aborted. No changes made.")
        return 130, "Aborted by user"  # Standard SIGINT exit code
```

**v1.1 Change:** Added KeyboardInterrupt handling with cleanup to ensure clean abort state.

---

### 3.4 UX-1: Tests for Confirmation Flow

**File:** `tests/commands/test_init_phase3.py` (Append new test class)

**New Code:**
```python
class TestHookConfirmation:
    """Tests for hook confirmation flow (v3.0.5 UX-1)."""

    def test_skip_hooks_flag_skips_confirmation(self, git_repo):
        """--skip-hooks bypasses confirmation entirely."""
        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)

        assert code == 0
        # No hooks should be installed
        pre_commit = git_repo / ".git" / "hooks" / "pre-commit"
        if pre_commit.exists():
            assert ONTOS_HOOK_MARKER not in pre_commit.read_text()

    def test_yes_flag_skips_confirmation(self, git_repo):
        """--yes installs hooks without prompting."""
        options = InitOptions(path=git_repo, yes=True)
        code, _ = init_command(options)

        assert code in (0, 3)  # 0 success, 3 if collision
        # In clean repo, hooks should be installed
        if code == 0:
            pre_commit = git_repo / ".git" / "hooks" / "pre-commit"
            assert pre_commit.exists()
            assert ONTOS_HOOK_MARKER in pre_commit.read_text()

    def test_skip_hooks_wins_over_yes(self, git_repo):
        """--skip-hooks takes precedence over --yes."""
        options = InitOptions(path=git_repo, skip_hooks=True, yes=True)
        code, _ = init_command(options)

        assert code == 0
        pre_commit = git_repo / ".git" / "hooks" / "pre-commit"
        if pre_commit.exists():
            assert ONTOS_HOOK_MARKER not in pre_commit.read_text()

    def test_ctrl_c_aborts_init(self, git_repo, monkeypatch):
        """Ctrl+C during hook confirmation aborts entire init."""
        # Simulate KeyboardInterrupt during input()
        def mock_input(prompt):
            raise KeyboardInterrupt()
        monkeypatch.setattr('builtins.input', mock_input)
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo)
        code, msg = init_command(options)

        # Should return SIGINT exit code
        assert code == 130
        assert "Aborted" in msg

        # Config should NOT exist (init aborted and cleaned up)
        assert not (git_repo / ".ontos.toml").exists()
```

**v1.1 Addition:** Added `test_ctrl_c_aborts_init` to verify KeyboardInterrupt behavior.

---

### 3.5 WRP-1: Wrapper Command Testing

**Action:** Execute each wrapper command and document results.

**Commands to test:**
```bash
ontos verify --help
ontos query --help
ontos consolidate --help
ontos migrate --help
ontos promote --help
ontos scaffold --help
ontos stub --help
```

**Expected Documentation Format:**

| Command | --help works | Basic execution | Limitations |
|---------|--------------|-----------------|-------------|
| verify | ? | ? | ? |
| query | ? | ? | ? |
| consolidate | ? | ? | ? |
| migrate | ? | ? | ? |
| promote | ? | ? | ? |
| scaffold | ? | ? | ? |
| stub | ? | ? | ? |

**Note:** Results from WRP-1 testing will inform UX-2 README updates.

---

### 3.6 UX-2: Update README Known Issues

**File:** `README.md` (Lines 216-219)

**Current Code:**
```markdown
## Known Issues (v3.0.4)

No known critical issues as of 2026-01-19. See [Changelog](https://github.com/ohjona/Project-Ontos/blob/main/Ontos_CHANGELOG.md) and [Issues](https://github.com/ohjona/Project-Ontos/issues) for updates.
```

**New Code:** (Depends on WRP-1 findings)
```markdown
## Known Issues (v3.0.5)

### Wrapper Commands

Some commands delegate to legacy scripts and may have limitations:

| Command | Status | Notes |
|---------|--------|-------|
| `verify` | [result] | [notes] |
| `query` | [result] | [notes] |
| `consolidate` | [result] | [notes] |
| `migrate` | [result] | [notes] |
| `promote` | [result] | [notes] |
| `scaffold` | [result] | [notes] |
| `stub` | [result] | [notes] |

**Workaround:** For full functionality, use native commands: `map`, `doctor`, `agents`, `log`, `init`.

### Configuration

Legacy wrapper commands do not honor `.ontos.toml` configuration. This will be addressed in v3.1.

See [Changelog](https://github.com/ohjona/Project-Ontos/blob/main/Ontos_CHANGELOG.md) and [Issues](https://github.com/ohjona/Project-Ontos/issues) for updates.
```

---

## 4. Implementation Order

| Order | ID | Dependency | Rationale |
|-------|-----|------------|-----------|
| 1 | VER-1 | None | Trivial, zero risk, can be done first |
| 2 | MCP-1 | None | Low effort, independent |
| 3 | UX-1 | None | Low effort, addresses blocking challenge |
| 4 | WRP-1 | None | Testing task, informs documentation |
| 5 | UX-2 | WRP-1 | Documentation depends on test findings |

---

## 5. Verification Protocol

### 5.1 VER-1 Verification

```bash
# No matches for "3.0.3" or "3.0.4" in ontos/ directory
grep -r "3\.0\.[34]" ontos/
# Expected: No output (empty result)

# Version should now be 3.0.5
grep "ONTOS_VERSION" ontos/_scripts/ontos_config_defaults.py
# Expected: ONTOS_VERSION = "3.0.5"
```

### 5.2 MCP-1 Verification

```bash
python -W all -c "from ontos import mcp"
# Expected output:
# <string>:1: FutureWarning: The 'ontos.mcp' module is a placeholder for Phase 2. No functionality is currently available.
```

### 5.3 UX-1 Verification

```bash
# Test 1: TTY shows preflight message + prompt
ontos init
# Expected: Shows "Git hooks to be installed:" + "Install git hooks? [Y/n]"

# Test 2: --yes installs hooks without prompt
cd /tmp && mkdir test-ux1 && cd test-ux1 && git init
ontos init --yes
ls -la .git/hooks/pre-commit
# Expected: Hook file exists, no prompt shown

# Test 3: --skip-hooks skips without prompt
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
ontos init --skip-hooks
# Expected: No hooks installed, no prompt shown

# Test 4: Non-TTY proceeds without prompt
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
echo "" | ontos init
# Expected: Hooks installed, no prompt shown

# Test 5: Ctrl+C aborts init entirely (manual test)
cd /tmp && rm -rf test-ux1 && mkdir test-ux1 && cd test-ux1 && git init
ontos init
# Press Ctrl+C at prompt
# Expected: "Aborted." message, no .ontos.toml created

# Cleanup
cd /tmp && rm -rf test-ux1
```

### 5.4 WRP-1 Verification

```bash
# Test each wrapper command
ontos verify --help    # Should show help text
ontos query --help     # Should show help text
ontos consolidate --help  # Should show help text
ontos migrate --help   # Should show help text
ontos promote --help   # Should show help text
ontos scaffold --help  # Should show help text
ontos stub --help      # Should show help text

# Document any that fail or show unexpected behavior
```

### 5.5 Full Test Suite

```bash
pytest tests/ -v
# Expected: All tests pass
```

---

## 6. Behavioral Matrix for UX-1

| Context | `--yes` | `--skip-hooks` | stdin.isatty() | Behavior |
|---------|---------|----------------|----------------|----------|
| CI pipeline | No | No | False | Install hooks (no prompt) |
| CI pipeline | Yes | No | False | Install hooks (no prompt) |
| Terminal | No | No | True | **Prompt user** |
| Terminal | Yes | No | True | Install hooks (no prompt) |
| Terminal | No | Yes | True | Skip hooks |
| Any | Yes | Yes | Any | Skip hooks (`--skip-hooks` wins) |
| Any (Ctrl+C) | Any | No | True | **Abort init entirely** |

---

## 7. Risk Assessment

**Overall Risk: LOW**

| Risk Factor | Assessment |
|-------------|------------|
| Code complexity | Low - straightforward consent flow |
| Scope of change | Moderate - 6 files, ~110 lines |
| Regression potential | Low - new flag, existing behavior preserved |
| Backward compatibility | High - see behavioral change note |
| Test coverage | Good - new tests added for consent flow including Ctrl+C |

### 7.1 Behavioral Change Note

Scripts that run `ontos init` interactively (with TTY stdin attached) will now see a confirmation prompt. To preserve non-interactive behavior:
- Use `--yes` flag: `ontos init --yes`
- Use `--skip-hooks` flag: `ontos init --skip-hooks`
- Run without TTY: `ontos init < /dev/null`

Scripts run via CI pipelines, cron jobs, or with redirected stdin automatically proceed without prompts.

**Ctrl+C Behavior:** Pressing Ctrl+C during the hook confirmation prompt will abort the entire init operation and clean up any partial state. This matches user expectations for interrupt handling.

---

## 8. Files Modified Summary

| File | Change Type | Lines Affected |
|------|-------------|----------------|
| `ontos/_scripts/ontos_config_defaults.py` | Edit | Line 56 |
| `ontos/mcp/__init__.py` | Add | 7 lines |
| `ontos/cli.py` | Edit | Lines 109-110, 239 |
| `ontos/commands/init.py` | Edit + Add | Lines 21, 63-74, +40 lines new function |
| `tests/commands/test_init_phase3.py` | Add | +45 lines new test class |
| `README.md` | Edit | Lines 216-235 (depends on WRP-1) |

---

## 9. Implementation Checklist

- [ ] **VER-1:** Update `ontos/_scripts/ontos_config_defaults.py:56` from "3.0.3" to "3.0.5"
- [ ] **VER-1:** Verify no "3.0.3" or "3.0.4" matches in `ontos/`
- [ ] **MCP-1:** Add FutureWarning to `ontos/mcp/__init__.py`
- [ ] **MCP-1:** Verify warning emits on import
- [ ] **MCP-1:** Verify stacklevel points to user's import statement
- [ ] **UX-1:** Add `--yes` flag to `ontos/cli.py`
- [ ] **UX-1:** Update `_cmd_init` to pass `yes` flag
- [ ] **UX-1:** Add `yes` field to `InitOptions` dataclass
- [ ] **UX-1:** Add `_confirm_hooks()` function with KeyboardInterrupt handling
- [ ] **UX-1:** Update `init_command` with try/except for Ctrl+C cleanup
- [ ] **UX-1:** Add tests to `tests/commands/test_init_phase3.py` (including Ctrl+C test)
- [ ] **UX-1:** Verify TTY prompt behavior
- [ ] **UX-1:** Verify `--yes` flag behavior
- [ ] **UX-1:** Verify `--skip-hooks` precedence
- [ ] **UX-1:** Verify Ctrl+C aborts and cleans up
- [ ] **WRP-1:** Test all 7 wrapper commands
- [ ] **WRP-1:** Document results in implementation notes
- [ ] **UX-2:** Update README Known Issues with WRP-1 findings
- [ ] **Final:** Run full test suite `pytest tests/`
- [ ] **Final:** Commit with appropriate message

---

## 10. Commit Message Template

```
feat(init): add hook consent prompt with --yes flag (v3.0.5)

- VER-1: Sync legacy script version to 3.0.5
- MCP-1: Add FutureWarning for placeholder mcp module
- UX-1: Add preflight message and TTY confirmation for hook installation
  - New --yes/-y flag for non-interactive mode
  - --skip-hooks takes precedence over --yes
  - CI/scripts (non-TTY) proceed without prompt
  - Ctrl+C aborts entire init with cleanup
- WRP-1: Document wrapper command behavior
- UX-2: Update README Known Issues section

Addresses blocking challenge from triage review board.
```

---

*Claude Opus 4.5 - 2026-01-20 (v1.1)*
