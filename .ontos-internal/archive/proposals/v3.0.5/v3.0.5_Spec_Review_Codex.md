# v3.0.5 Spec Review — Codex (Adversarial Reviewer)

**Project:** Ontos v3.0.5  
**Phase:** B.1 (Spec Review)  
**Role:** Adversarial Reviewer  
**Model:** Codex (OpenAI)  
**Date:** 2026-01-20  

Under review: `v3.0.5-Implementation-Spec.md` v1.0. fileciteturn6file8L1-L7

---

## Part 1: Assumption Attack

| Assumption in Spec | Why It Might Be Wrong | Impact If Wrong |
|--------------------|----------------------|-----------------|
| `sys.stdin.isatty()` reliably detects CI/scripts | CI can allocate a pseudo-TTY, and lots of “scripts” run inside a terminal where `isatty()` is True. Conversely, stdin can be redirected while still being a human-run terminal. | Init may hang waiting for input in automation, or silently install hooks when stdin is redirected. This is the trust/footgun surface UX-1 is trying to reduce. fileciteturn6file0L87-L103 |
| `--skip-hooks` wins over `--yes` | Implemented as first check in `_confirm_hooks`, but precedence must hold across the full call path. If any later code installs hooks regardless, precedence is moot. | Users explicitly asking to skip could still get repo mutation. Current tests only check marker absence, not that *no* hooks are created or modified. fileciteturn6file1L62-L96 |
| Version mismatch fix sets legacy scripts to `"3.0.4"` | This spec is for v3.0.5, but VER-1 sets `ONTOS_VERSION` to `"3.0.4"`. If package `__version__` becomes 3.0.5 on release, you reintroduce mismatch immediately. | Shipping v3.0.5 with legacy scripts still reporting 3.0.4 is a “trust tax” and breaks the stated purpose of VER-1. fileciteturn6file8L38-L53 |
| MCP warning category choice is user-visible | `FutureWarning` is not reliably visible in default warning filters in all environments. The spec verification uses `-W all`, which is not what users do. | Users still experience “no-op extra” confusion because they never see the warning. fileciteturn6file8L56-L79 |
| Warning uses correct `stacklevel` | Module-level warnings often need different stacklevel values to point at the user import site. `stacklevel=2` can land on importlib frames. | Warning points to internal files, looks sloppy, reduces credibility. fileciteturn6file8L70-L75 |
| Printed preflight list matches actual installed hooks | Preflight hard-codes `pre-commit` and `pre-push`, but the installer could evolve or differ by platform. | Users see a promise then discover different mutations, which is worse than no prompt. fileciteturn6file0L90-L95 |

---

## Part 2: Edge Case Analysis (UX-1)

Based on `_confirm_hooks()` as specified. fileciteturn6file1L6-L38

| Scenario | Handled? | If Not, What Happens? |
|----------|----------|----------------------|
| User presses Ctrl+C during prompt | ✅ | Caught; prints “Skipping hooks.” and returns False. Potential UX mismatch: Ctrl+C often means “abort init”, but here it continues init without hooks. fileciteturn6file1L33-L38 |
| User presses Ctrl+D (EOF) | ✅ | Same as above. fileciteturn6file1L33-L38 |
| stdin is redirected from file | ⚠️ | `isatty()` False → proceeds to install hooks silently. If redirection was accidental, user loses the consent prompt. fileciteturn6file0L87-L89 |
| stdin is `/dev/null` | ⚠️ | Same: installs hooks silently. fileciteturn6file0L87-L89 |
| User types "YES" (uppercase) | ✅ | `.lower()` handles it. fileciteturn6file0L97-L100 |
| User types " y " (whitespace) | ✅ | `.strip()` handles it. fileciteturn6file0L97-L100 |
| `--yes` and `--skip-hooks` both passed | ✅ | Precedence implemented and tested. fileciteturn6file0L83-L87 fileciteturn6file2L35-L43 |
| Hooks directory doesn't exist | ❓ | Not specified. If `_install_hooks` assumes `.git/hooks/` exists, it can fail. Preflight claims the location regardless. fileciteturn6file0L94-L95 |
| Not in a git repo | ❓ | Not addressed in UX-1 section. If `init_command` still attempts `_install_hooks` without verifying git root, it can error or create misleading output. fileciteturn6file1L52-L58 |

---

## Part 3: Failure Mode Analysis

| Failure | How It Happens | Detection | Recovery |
|---------|----------------|-----------|----------|
| `input()` raises unexpected exception | Closed stdin, platform-specific I/O errors other than EOFError | Only EOFError/KeyboardInterrupt are caught. Anything else crashes init mid-flight. fileciteturn6file0L97-L102 | Catch broader `Exception` and treat as “skip hooks + emit warning”, or abort init with a clear error and no partial repo mutation. |
| `.git/hooks/` is read-only | Permissions, worktrees, locked-down repos | Not specified. `_install_hooks` might error. UX-1 path uses `hooks_status=0` for skip, which can hide distinctions elsewhere. fileciteturn6file1L52-L58 | Ensure `_install_hooks` failures propagate non-zero exit and clear messaging. |
| Existing hook has no write permission | Immutable hook file owned by another user | Not specified. Could yield exception or partial write. | Detect writability before write. If not writable, treat as collision and return collision code consistently. |
| Hook collision semantics are unclear | Tests accept `code in (0, 3)` for `--yes`. fileciteturn6file2L28-L33 | User may think init succeeded but hooks are not installed. | On collision, print actionable next steps: use `--force` or manual merge guidance. |

---

## Part 4: Regression Hunt

| Existing Behavior | Could This Change Break It? | Evidence |
|-------------------|----------------------------|----------|
| `ontos init` in CI | Possibly: CI with TTY would now prompt and hang unless `--yes` used. Spec assumes non-TTY CI. fileciteturn6file0L87-L89 | Behavioral matrix says non-TTY installs hooks. fileciteturn6file4L60-L67 |
| `ontos init --skip-hooks` | Low risk: precedence implemented and tested. | `_confirm_hooks` checks skip first; test exists. fileciteturn6file2L35-L43 |
| Scripts calling `ontos init` | Medium risk: scripts run from a terminal likely have TTY stdin, so they now block unless `--yes` is passed. Spec language is ambiguous: “scripts need `--yes`” vs “non-TTY proceeds.” fileciteturn6file4L60-L67 fileciteturn6file8L91-L99 | Clarify: “scripts executed with TTY need `--yes`” vs “CI non-TTY doesn’t”. |
| Default human behavior | Minor regression: swallowing Ctrl+C means init continues instead of aborting. | Ctrl+C is caught and treated as “skip hooks.” fileciteturn6file1L33-L38 |

---

## Part 5: Code Review

| Code Snippet | Potential Issue |
|--------------|-----------------|
| `response in ('', 'y', 'yes')` | Parsing is OK after `.strip().lower()`. Bigger issue is silent install on non-TTY contexts. fileciteturn6file0L97-L100 |
| `stacklevel=2` | Likely wrong for module-level warning usability. Validate against real import stacks. fileciteturn6file8L70-L75 |
| `getattr(args, "yes", False)` | Defensive but odd given argparse defines it. If there’s a reason, document it; otherwise use `args.yes` for strictness. fileciteturn6file0L30-L35 |
| `_confirm_hooks` references `sys` | Ensure `ontos/commands/init.py` imports `sys` in actual code. The triage snippet shows `import sys`, but the spec block must match final implementation. fileciteturn6file5L40-L49 fileciteturn6file0L87-L89 |
| Catching `KeyboardInterrupt` | Ctrl+C usually means abort, not “decline hooks.” Decide intentionally, document, and test. fileciteturn6file0L100-L102 |

---

## Part 6: Test Coverage Gaps

| Scenario | Test Exists? | Should It? |
|----------|--------------|------------|
| Ctrl+C during prompt | ❌ | ✅ |
| Ctrl+D during prompt | ❌ | ✅ |
| Uppercase input | ❌ | Optional (currently handled) fileciteturn6file0L97-L100 |
| Whitespace input | ❌ | Optional (currently handled) fileciteturn6file0L97-L100 |
| Prompt path parsing (TTY True) | ❌ | ✅ |
| stdin redirected (TTY False) behavior | ❌ | ✅ |
| Not in git repo | ❌ | ✅ |
| Hooks dir missing / worktree | ❌ | ✅ |
| Read-only hook file | ❌ | ✅ |
| MCP warning visible by default | ❌ | ✅ |

Existing tests only cover skip-hooks, yes, and precedence plus partial install assertions. fileciteturn6file2L9-L43

---

## Part 7: Issues Found

### Critical (Adversarial)

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-C1 | VER-1 likely wrong for a v3.0.5 release | Sets legacy constant to **3.0.4** in a **v3.0.5** spec fileciteturn6file8L38-L53 | Version mismatch persists on release, undermining the entire VER-1 intent. |
| X-C2 | MCP warning may be invisible to real users | Uses `FutureWarning`; verification relies on `-W all` fileciteturn6file8L56-L79 | Users still think `ontos[mcp]` is broken or misleading. |

### High (Adversarial)

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-H1 | Confusing script/CI behavior contract | Behavioral matrix vs “scripts need `--yes`” wording is ambiguous fileciteturn6file4L60-L67 fileciteturn6file8L91-L99 | Automation can hang or silently mutate repos; docs mislead. |
| X-H2 | Silent install still occurs with redirected stdin | `isatty()` False auto-installs fileciteturn6file0L87-L89 | Consent goal partly defeated in common shell edge cases. |
| X-H3 | Ctrl+C semantics likely wrong | Ctrl+C is swallowed and init proceeds fileciteturn6file1L33-L38 | Users cannot reliably abort init. |

---

## Part 8: Verdict

**Spec Robustness:** Fragile  
**Recommendation:** Request changes  

**Top 3 Concerns:**
1. VER-1 targets 3.0.4 instead of the release version under discussion. fileciteturn6file8L38-L53  
2. MCP warning likely won’t be seen by users without forcing warnings. fileciteturn6file8L56-L79  
3. UX-1 still has silent-install corners and untested prompt/interruption behavior. fileciteturn6file0L87-L103 fileciteturn6file2L9-L43  

---

## Minimal Patch-Sized Change Requests

1. **VER-1:** Set legacy `ONTOS_VERSION` to the actual release version (3.0.5) or explicitly state the intended policy and enforce it.  
2. **MCP-1:** Use a warning class that is visible by default, and validate `stacklevel` so it points to user code.  
3. **UX-1:** Decide Ctrl+C behavior (abort vs decline hooks) and lock it with tests.  
4. **Tests:** Add at least one test covering prompt parsing and one covering redirected stdin behavior.  

