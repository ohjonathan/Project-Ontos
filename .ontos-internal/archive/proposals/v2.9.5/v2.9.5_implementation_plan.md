---
id: v2_9_5_implementation_plan
type: strategy
status: complete
depends_on: [v2_8_implementation_plan]
concepts: [architecture, quality, testing, pure-impure]
---

# Implementation Plan: Project Ontos v2.9.5 Quality Release

**Version:** 2.0.0 (Revised)
**Date:** 2026-01-08
**Author:** Claude Opus 4.5 (Architect)
**Status:** REVISED - Incorporated LLM Review Board Feedback

---

## Revision Summary

| Issue | Resolution | Reasoning |
|-------|------------|-----------|
| Caller update pattern impossible (All 3 reviewers) | **Fixed** — Use `warnings.warn()` | Path functions return `str`, have no OutputHandler access. `warnings.warn()` requires zero caller changes. |
| Multi-option warning handling (Codex) | **Removed** — Deleted Question #4 | Speculative generality. Single solution picked. |
| Over-specified test code (Claude, Codex) | **Simplified** — Test requirements table only | 200 lines of verbatim code was brittle. Agent can write tests from requirements. |
| Tests assert internal mechanics (Codex) | **Accepted** — Removed temp-suffix and _acquire_lock tests | Resume-driven development. Test behavior, not implementation. |
| TestFromRepo patches wrong function (Codex) | **Fixed** — Patch `ontos_config` not `resolve_config` | Verified: `from_repo()` imports `ontos_config` directly (line 86). |
| Cross-filesystem temp issue (Gemini) | **Clarified** — Already correct | Verified: Line 163 creates `.tmp` sibling files, not system `/tmp`. |
| Quiet flag on errors hides failures (Codex) | **Kept with constraint** — Exit codes preserved | Consistency matters; exit codes prevent silent CI failures. |
| MOVE data loss on failure (Codex) | **Acknowledged** — Documented as residual risk | Existing bug in context.py, out of scope for v2.9.5 but flagged. |

## Complexity Removals

| Removed | Reason |
|---------|--------|
| 200 lines of verbatim test code | Replaced with 15-line requirements table |
| Three warning routing options (A/B/C) | Single solution: `warnings.warn()` |
| Caller update instructions | Not needed — `warnings.warn()` is drop-in |
| Question #4 in review section | Unnecessary — decision made |
| `_acquire_lock()` / `_release_lock()` unit tests | Internal mechanics — test `commit()` behavior instead |
| Temp filename suffix assertions | Implementation detail — test file creation instead |

---

## Executive Summary

This implementation plan addresses critical quality gaps identified in the architectural review of Project Ontos v2.9.4. The primary goal is to prepare the codebase for v3.0 (MCP Server) by fixing pure/impure violations and establishing test coverage for the core transaction system.

**Verdict from Review:** REQUEST CHANGES → REVISED
**Overall Compliance:** 92%
**Blocking Issue:** 1 critical violation prevents v3.0 API exposure

---

## Part 1: Product Scope

### Problem Statement

Project Ontos v2.9.4 has architectural violations that block the v3.0 release:
1. Core module calls `print()` directly, preventing API/MCP usage
2. Zero test coverage for the transaction system means atomicity guarantees are unverified
3. Dead/duplicate code increases maintenance burden

### Scope Boundaries

#### IN SCOPE (v2.9.5)
| Item | Reason |
|------|--------|
| Fix `paths._warn_deprecated()` print violation | Blocks v3.0 |
| Add SessionContext behavioral tests | Core functionality untested |
| Remove duplicate `normalize_type()` | Dead code |

#### OUT OF SCOPE (Explicitly NOT Building)
| Item | Reason | Deferred To |
|------|--------|-------------|
| OutputHandler quiet flag on errors | Behavior change risks silent failures (Codex) | Dropped |
| Context map generation tests | Lower priority than SessionContext | v2.9.6 |
| MOVE operation data-loss fix | Existing bug, architectural change needed | v2.10 |
| Windows atomic rename fallback | POSIX sufficient for v2.x | v3.0 |

---

## Part 2: Technical Specification

### File Structure

```
Files to MODIFY:
├── .ontos/scripts/ontos/core/paths.py          # Fix print() violation
├── .ontos/scripts/ontos/core/frontmatter.py    # Remove duplicate function
└── .ontos/scripts/ontos_config_defaults.py     # Version bump to 2.9.5

Files to CREATE:
└── .ontos/scripts/tests/test_context.py        # SessionContext tests
```

### Change 1: Fix `paths._warn_deprecated()` Using `warnings.warn()`

**File:** `.ontos/scripts/ontos/core/paths.py`
**Lines:** 64-71

**Current (BROKEN):**
```python
def _warn_deprecated(old_path: str, new_path: str) -> None:
    """Issue deprecation warning (once per path per session)."""
    if old_path in _deprecation_warned:
        return
    _deprecation_warned.add(old_path)
    print(f"[DEPRECATION WARNING] Using old path '{old_path}'.")
    print(f"   Expected: '{new_path}'")
    print("   Run 'python3 ontos_init.py' to update your project structure.")
```

**After (FIXED):**
```python
import warnings

def _warn_deprecated(old_path: str, new_path: str) -> None:
    """Issue deprecation warning using Python's warnings system.

    Uses stdlib warnings module for proper filtering, deduplication,
    and CLI suppression. No caller changes required.
    """
    if old_path in _deprecation_warned:
        return
    _deprecation_warned.add(old_path)
    warnings.warn(
        f"Using deprecated path '{old_path}'. "
        f"Expected: '{new_path}'. "
        f"Run 'python3 ontos_init.py' to update.",
        DeprecationWarning,
        stacklevel=3  # Point to caller's caller
    )
```

**Why `warnings.warn()`:**
1. **No caller changes** — All 3 callers (lines 198, 250, 304) continue working unchanged
2. **Standard Python** — Zero learning curve, integrates with `-W` flag
3. **Testable** — Use `pytest.warns(DeprecationWarning)`
4. **Filterable** — CLI can suppress with `warnings.filterwarnings('ignore')`
5. **Pure** — `warnings.warn()` is the accepted stdlib pattern for core modules

### Change 2: Remove Duplicate `normalize_type()`

**File:** `.ontos/scripts/ontos/core/frontmatter.py`
**Action:** Delete lines 125-147 (second definition)

**Verification:**
```bash
python3 -c "from ontos.core.frontmatter import normalize_type; print(normalize_type('ATOM'))"
# Should print: atom
```

### Change 3: Create SessionContext Behavioral Tests

**File:** `.ontos/scripts/tests/test_context.py` (NEW)

**Test Requirements:**

| Test Class | What to Test | Edge Cases |
|------------|--------------|------------|
| `TestBufferOperations` | `buffer_write/delete/move` add to `pending_writes` list | Multiple ops in order |
| `TestCommit` | Creates files, clears buffer, returns modified paths | Empty buffer, nested dirs |
| `TestCommitFailure` | Cleans up temp files on error, raises exception | Rename failure |
| `TestRollback` | Clears buffer without creating files | Buffered ops discarded |
| `TestLocking` | `commit()` raises on lock timeout | Mock time for determinism |
| `TestFromRepo` | Factory creates context with config dict | Patch `ontos_config` import |
| `TestDiagnostics` | `warn()/error()` collect messages in lists | Multiple messages |

**Expected: ~15-20 tests**

**Test Constraints (per Codex):**
- Do NOT test `_acquire_lock()` / `_release_lock()` directly — internal mechanics
- Do NOT assert temp file naming patterns — implementation detail
- DO test `commit()` behavior: files created, cleanup on failure
- DO use `pytest.fixture` with `tmp_path` for filesystem tests
- DO mock time/PID for locking tests to avoid flakiness

**Correct Mock for `TestFromRepo`:**
```python
# WRONG (spec v1.0.0):
with patch('ontos.core.context.resolve_config') as mock:  # doesn't exist!

# CORRECT (verified from context.py line 86):
with patch.dict('sys.modules', {'ontos_config': MagicMock(DOCS_DIR='docs')}):
    ctx = SessionContext.from_repo(tmp_path)
```

---

## Part 3: Implementation Order

| Step | Task | Dependencies | Est. Time |
|------|------|--------------|-----------|
| 1 | Fix `paths._warn_deprecated()` with `warnings.warn()` | None | 10 min |
| 2 | Remove duplicate `normalize_type()` | None | 5 min |
| 3 | Create `test_context.py` with behavioral tests | None | 45 min |
| 4 | Run tests, verify all pass | Steps 1-3 | 10 min |
| 5 | Version bump to 2.9.5 | Step 4 | 2 min |
| 6 | Update CHANGELOG | All | 10 min |
| **Total** | | | **~1.5 hours** |

---

## Part 4: Assumptions (Validated)

| Assumption | Status | Evidence |
|------------|--------|----------|
| `paths.py` has 3 print() at lines 69-71 | ✓ VERIFIED | grep confirmed |
| 3 callers at lines 198, 250, 304 | ✓ VERIFIED | grep confirmed |
| Callers return `str`, no OutputHandler | ✓ VERIFIED | Code inspection |
| Duplicate `normalize_type()` at lines 57, 125 | ✓ VERIFIED | grep confirmed |
| Temp files use sibling `.tmp` pattern | ✓ VERIFIED | Line 163: `op.path.with_suffix('.tmp')` |
| `from_repo()` imports `ontos_config` | ✓ VERIFIED | Line 86: `import ontos_config` |

---

## Part 5: Test Strategy

### Unit Tests (test_context.py)

| Coverage Area | Tests | Approach |
|--------------|-------|----------|
| Buffer operations | 4 | Direct method calls |
| Commit success | 5 | `tmp_path` fixture, verify file content |
| Commit failure | 2 | Mock `Path.rename` to raise, verify cleanup |
| Rollback | 2 | Verify no files created |
| Locking (behavioral) | 2 | Test `commit()` lock behavior, not internals |
| Factory | 1 | Patch `ontos_config` module |
| Diagnostics | 2 | Verify list accumulation |

**Total: ~18 tests**

### Acceptance Tests

```bash
# 1. All existing tests pass
pytest .ontos/scripts/tests/ -v

# 2. New context tests pass
pytest .ontos/scripts/tests/test_context.py -v

# 3. Deprecation warning emits correctly
python3 -W default -c "from ontos.core.paths import get_decision_history_path; get_decision_history_path()"
# Should emit DeprecationWarning if old path exists

# 4. Unified CLI still works
python3 ontos.py map --help
```

---

## Part 6: Developer Instructions

### Step 1: Fix paths._warn_deprecated()

Edit `.ontos/scripts/ontos/core/paths.py`:
- Add `import warnings` at top
- Replace print() calls with `warnings.warn()` as specified

Verify:
```bash
grep -n "print(" .ontos/scripts/ontos/core/*.py
# Should return no matches in paths.py (except strings/docstrings)
```

### Step 2: Remove Duplicate normalize_type()

Edit `.ontos/scripts/ontos/core/frontmatter.py`:
- Delete lines 125-147 (second `def normalize_type`)

Verify:
```bash
grep -n "^def normalize_type" .ontos/scripts/ontos/core/frontmatter.py
# Should return exactly 1 match (line 57)
```

### Step 3: Create Behavioral Tests

Create `.ontos/scripts/tests/test_context.py` following requirements table in Part 2.

Key points:
- Use `tmp_path` fixture for all file operations
- Mock `ontos_config` module for `TestFromRepo`
- Test `commit()` lock behavior through public API, not `_acquire_lock()`
- Assert on file existence and content, not temp file naming

### Step 4: Run Tests

```bash
pytest .ontos/scripts/tests/ -v
# Expect: All existing + new tests pass
```

### Step 5: Version Bump

Edit `.ontos/scripts/ontos_config_defaults.py`:
```python
ONTOS_VERSION = "2.9.5"
```

### Step 6: Update CHANGELOG

Add to `Ontos_CHANGELOG.md`:

```markdown
## [2.9.5] - 2026-01-08

### Theme: "Quality & Testing"

Fixes architectural violations and adds test coverage for core transaction system.

### Fixed
- **Pure/Impure Violation** — `paths._warn_deprecated()` now uses `warnings.warn()`
  - Standard Python deprecation pattern
  - No caller changes required
  - Enables v3.0 MCP Server exposure

- **DRY Violation** — Removed duplicate `normalize_type()` in frontmatter.py

### Added
- **18 new tests** for SessionContext in `test_context.py`
  - Buffer operations (4 tests)
  - Commit behavior (7 tests)
  - Rollback (2 tests)
  - Locking behavior (2 tests)
  - Factory and diagnostics (3 tests)

### Tests
- Total: ~128 tests (110 existing + 18 new)
```

---

## Part 7: Files to Modify (Summary)

| File | Action | Lines Changed |
|------|--------|---------------|
| `.ontos/scripts/ontos/core/paths.py` | MODIFY | ~10 lines |
| `.ontos/scripts/ontos/core/frontmatter.py` | MODIFY | -23 lines (delete) |
| `.ontos/scripts/tests/test_context.py` | CREATE | ~150 lines |
| `.ontos/scripts/ontos_config_defaults.py` | MODIFY | 1 line |
| `Ontos_CHANGELOG.md` | MODIFY | ~20 lines |

---

## Part 8: Remaining Concerns

### 1. MOVE Operation Data Loss (Codex)

**Issue:** In `context.py` lines 170-172, MOVE operations stage `(source, destination)`. On failure after staging, cleanup (line 192) calls `temp.unlink()` which deletes the **source file**.

**Current Code:**
```python
elif op.operation == FileOperation.MOVE:
    if op.path.exists():
        staged.append((op.path, op.destination))  # temp = source!
# ...
# In cleanup:
if temp.exists():
    temp.unlink()  # Deletes source file!
```

**Impact:** Potential data loss on commit failure for MOVE operations.

**Resolution:** Out of scope for v2.9.5. Flagged for v2.10 as architectural fix requiring careful design (copy-then-delete pattern, or atomic move with rollback).

### 2. Locking Flakiness in CI

**Issue:** PID-based stale lock detection and timeouts may be unreliable across platforms.

**Resolution:** Tests will use mocked time and controlled scenarios. Real-world flakiness accepted as known limitation until v3.0 when proper locking solution (fcntl/msvcrt) can be explored.

---

## LLM Review Board Approval Status

| Reviewer | Original Verdict | Issue Addressed | New Status |
|----------|-----------------|-----------------|------------|
| Claude | APPROVED (after decision) | N/A | ✓ APPROVED |
| Codex | REJECT | All demands addressed except quiet-flag (kept with constraints) | Pending |
| Gemini | NEEDS REVISION | All issues addressed | Pending |

---

*End of Implementation Plan v2.0.0*
