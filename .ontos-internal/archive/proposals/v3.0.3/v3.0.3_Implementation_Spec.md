# Ontos v3.0.2 Implementation Spec

**Version:** 1.0
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-18
**Status:** Verified - Ready for Implementation

---

## 1. Executive Summary

This is a **minimal scope** patch release addressing only **4 confirmed syntax errors** in legacy scripts. Multiple issues originally identified in the v3.0.2 proposals have been **verified as already resolved** and require no action.

| Category | Count | Action |
|----------|-------|--------|
| Already Fixed | 4 | No action needed |
| Confirmed Bugs | 4 | Fix in this release |
| Deferred | 3 | Track for v3.0.3 |

**Total changes:** 4 files, 4 single-line insertions

---

## 2. Verification Summary

### 2.1 Issues ALREADY RESOLVED (No Fix Needed)

| Issue | Proposal Claim | Verification | Evidence |
|-------|----------------|--------------|----------|
| Init uses subprocess | "Fix needed" | **ALREADY FIXED** | `init.py:104-145` uses native `map_command()` |
| `ontos map` broken | "ModuleNotFoundError" | **WORKS NOW** | `cli.py:240-251` native implementation |
| Common_Concepts duplicate | "Tech debt" | **RESOLVED** | Single copy exists |
| Uninstall docs wrong | "Frontmatter after delete" | **CORRECT** | Frontmatter removal is step 1 |

### 2.2 Issues CONFIRMED (Fix Required)

4 legacy scripts have `IndentationError` due to empty `if` body:

```python
# BROKEN pattern (all 4 files):
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
                                      # <- Empty body
from ontos_config_defaults import ... # IndentationError
```

### 2.3 Issues DEFERRED to v3.0.3

| Command | Error | Reason |
|---------|-------|--------|
| `ontos verify` | ModuleNotFoundError | Import structure issue |
| `ontos query` | ModuleNotFoundError | Import structure issue |
| `ontos consolidate` | ModuleNotFoundError | Import structure issue |

---

## 3. Exact Code Changes

### 3.1 `ontos/_scripts/ontos_scaffold.py` (Line 28)

**Before:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:

from ontos_config_defaults import PROJECT_ROOT
```

**After:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos_config_defaults import PROJECT_ROOT
```

### 3.2 `ontos/_scripts/ontos_stub.py` (Line 28)

**Before:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:

from ontos_config_defaults import PROJECT_ROOT, VALID_TYPES
```

**After:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos_config_defaults import PROJECT_ROOT, VALID_TYPES
```

### 3.3 `ontos/_scripts/ontos_promote.py` (Line 28)

**Before:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:

from ontos_config_defaults import PROJECT_ROOT, VALID_TYPES
```

**After:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos_config_defaults import PROJECT_ROOT, VALID_TYPES
```

### 3.4 `ontos/_scripts/ontos_migrate_schema.py` (Line 32)

**Before:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:

from ontos.core.schema import (
```

**After:**
```python
SCRIPTS_DIR = Path(__file__).parent
if str(SCRIPTS_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPTS_DIR))

from ontos.core.schema import (
```

---

## 4. Verification Protocol

### 4.1 Post-Fix Syntax Check (Must Pass)

```bash
python3 -m py_compile ontos/_scripts/ontos_scaffold.py && echo "scaffold: OK"
python3 -m py_compile ontos/_scripts/ontos_stub.py && echo "stub: OK"
python3 -m py_compile ontos/_scripts/ontos_promote.py && echo "promote: OK"
python3 -m py_compile ontos/_scripts/ontos_migrate_schema.py && echo "migrate: OK"
```

### 4.2 CLI Help Check (Must Show Help)

```bash
python3 -m ontos scaffold --help
python3 -m ontos stub --help
python3 -m ontos promote --help
python3 -m ontos migrate --help
```

### 4.3 Regression Check

```bash
python3 -m ontos --version       # 3.0.2
python3 -m ontos doctor          # Should pass
python3 -m ontos map --help      # Works (native)
pytest tests/ -v --ignore=tests/golden/
```

---

## 5. Command Status After v3.0.2

| Command | Status |
|---------|--------|
| `ontos init` | Working (native) |
| `ontos map` | Working (native) |
| `ontos doctor` | Working (native) |
| `ontos agents` | Working (native) |
| `ontos log` | Working (native) |
| `ontos hook` | Working (native) |
| `ontos scaffold` | **FIXED** |
| `ontos stub` | **FIXED** |
| `ontos promote` | **FIXED** |
| `ontos migrate` | **FIXED** |
| `ontos verify` | Broken (v3.0.3) |
| `ontos query` | Broken (v3.0.3) |
| `ontos consolidate` | Broken (v3.0.3) |

---

## 6. Implementation Checklist

- [x] Apply fix to `ontos/_scripts/ontos_scaffold.py` line 28
- [x] Apply fix to `ontos/_scripts/ontos_stub.py` line 28
- [x] Apply fix to `ontos/_scripts/ontos_promote.py` line 28
- [x] Apply fix to `ontos/_scripts/ontos_migrate_schema.py` line 32
- [x] Run py_compile on all 4 files (must pass)
- [x] Run CLI help on all 4 commands (must work)
- [x] Run test suite (must pass)
- [ ] Commit: `fix(scripts): Add missing sys.path.insert body in legacy scripts`

---

## 7. Risk Assessment

**Overall Risk: LOW**

- Single-line insertions following existing pattern
- Changes isolated to legacy scripts
- Each script is independent

---

## 8. Critical Files

| File | Line | Change |
|------|------|--------|
| `ontos/_scripts/ontos_scaffold.py` | 28 | Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
| `ontos/_scripts/ontos_stub.py` | 28 | Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
| `ontos/_scripts/ontos_promote.py` | 28 | Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
| `ontos/_scripts/ontos_migrate_schema.py` | 32 | Add `sys.path.insert(0, str(SCRIPTS_DIR))` |
