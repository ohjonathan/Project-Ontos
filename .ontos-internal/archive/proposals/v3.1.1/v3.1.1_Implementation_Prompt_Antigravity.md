---
id: v3_1_1_implementation_prompt_antigravity
type: strategy
status: approved
depends_on: [v3_1_1_implementation_spec]
concepts: [init, scaffold, implementation, developer-prompt]
---

# v3.1.1 Implementation Prompt for Antigravity

**Written by:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-22
**Spec:** v3.1.1-Implementation-Spec.md (v1.1, approved)

---

## 1. Overview

- **Phase:** v3.1.1 — `ontos init` Improvements
- **Risk level:** LOW (additive changes, safety guards)
- **Branch:** `feature/init-improvements-v3.1.1`
- **Scope:** 4 source files modified, 1 reference doc updated, 1 new test file

---

## 2. Pre-Implementation Checklist

```bash
git checkout main && git pull origin main
git checkout -b feature/init-improvements-v3.1.1
pytest tests/ -v  # Must pass before starting
```

---

## 3. Architecture Constraints

- Python 3.9+ minimum (can use `Path.is_relative_to()`)
- Commands can import from other commands (established pattern: init imports map, agents)
- Non-fatal error pattern: `try/except` with `print(..., file=sys.stderr)` warning
- `SessionContext.commit()` is atomic (all buffered writes happen together)
- `find_project_root()` returns the repo root Path or None

---

## 4. Task Sequence

---

### Task 1: Add DEFAULT_IGNORES constant to scaffold.py

**Spec Reference:** Section 2.3
**Priority:** Must (blocking issue B1)

**File:** `ontos/commands/scaffold.py`

**Current Code (lines 1-12):**
```python
"""Native scaffold command implementation."""

from dataclasses import dataclass
from pathlib import Path
from typing import List, Optional, Tuple

from ontos.core.frontmatter import parse_frontmatter
from ontos.core.curation import create_scaffold, load_ontosignore, should_ignore
from ontos.core.schema import serialize_frontmatter
from ontos.core.context import SessionContext
from ontos.io.files import find_project_root, scan_documents
from ontos.ui.output import OutputHandler
```

**New Code (insert after line 12, before the ScaffoldOptions class):**
```python
"""Native scaffold command implementation."""

from dataclasses import dataclass
from pathlib import Path
from typing import List, Optional, Tuple

from ontos.core.frontmatter import parse_frontmatter
from ontos.core.curation import create_scaffold, load_ontosignore, should_ignore
from ontos.core.schema import serialize_frontmatter
from ontos.core.context import SessionContext
from ontos.io.files import find_project_root, scan_documents
from ontos.ui.output import OutputHandler

# Hardcoded exclusion patterns for dependency directories.
# These are always skipped regardless of .ontosignore presence.
# Mirrors legacy _scripts/ontos_scaffold.py behavior.
DEFAULT_IGNORES = [
    'node_modules', '.venv', 'venv', 'vendor',
    '__pycache__', '.pytest_cache', '.mypy_cache',
    'dist', 'build', '.tox', '.eggs',
]
```

**Instructions:**
1. Open `ontos/commands/scaffold.py`
2. After line 12 (the last import), add a blank line, then the `DEFAULT_IGNORES` constant with its comment block
3. Save

---

### Task 2: Apply DEFAULT_IGNORES in find_untagged_files()

**Spec Reference:** Section 2.3
**Priority:** Must (blocking issue B1)

**File:** `ontos/commands/scaffold.py`

**Current Code (lines 60-62):**
```python
        if any(part.startswith('.') for part in rel_path.parts[:-1]):
            if '.ontos' not in str(f) and '.ontos-internal' not in str(f):
                continue
```

**New Code (insert AFTER line 62, before the "Check for frontmatter" comment on line 64):**
```python
        if any(part.startswith('.') for part in rel_path.parts[:-1]):
            if '.ontos' not in str(f) and '.ontos-internal' not in str(f):
                continue

        # Skip DEFAULT_IGNORES directories (safety: prevents modifying dependency files)
        if any(ignore in rel_path.parts for ignore in DEFAULT_IGNORES):
            continue
```

**Instructions:**
1. Open `ontos/commands/scaffold.py`
2. Find line 62 (the `continue` after the hidden directory check)
3. After line 62, add a blank line and the DEFAULT_IGNORES check (3 lines)
4. Note: we check `rel_path.parts` (tuple of path components) rather than `str(rel_path)` to avoid false positives (e.g., a file named "build_notes.md" should not be skipped)
5. Save

**Test:**
```bash
pytest tests/commands/test_scaffold_parity.py -v
```

**Commit:**
```
fix(scaffold): add DEFAULT_IGNORES for dependency directories

Restores safety exclusions (node_modules, .venv, vendor, etc.) that
were present in the legacy scaffold script but dropped during v3.0
native rewrite. Prevents accidental scaffolding of files in dependency
directories when .ontosignore is absent.
```

---

### Task 3: Expand directory list in init.py (both locations)

**Spec Reference:** Section 2.1
**Priority:** Must

**File:** `ontos/commands/init.py`

**Location 1 — Current Code (lines 105-111):**
```python
        dirs = [
            config.paths.docs_dir,
            config.paths.logs_dir,
            f"{config.paths.docs_dir}/strategy",
            f"{config.paths.docs_dir}/reference",
            f"{config.paths.docs_dir}/archive",
        ]
```

**Location 1 — New Code:**
```python
        # 5. Create directory structure (full type hierarchy)
        dirs = [
            config.paths.docs_dir,
            config.paths.logs_dir,
            f"{config.paths.docs_dir}/kernel",
            f"{config.paths.docs_dir}/strategy",
            f"{config.paths.docs_dir}/product",
            f"{config.paths.docs_dir}/atom",
            f"{config.paths.docs_dir}/reference",
            f"{config.paths.docs_dir}/archive",
        ]
```

**Location 2 — Current Code (lines 174-180):**
```python
    dirs = [
        config.paths.docs_dir,
        config.paths.logs_dir,
        f"{config.paths.docs_dir}/strategy",
        f"{config.paths.docs_dir}/reference",
        f"{config.paths.docs_dir}/archive",
    ]
```

**Location 2 — New Code:**
```python
    dirs = [
        config.paths.docs_dir,
        config.paths.logs_dir,
        f"{config.paths.docs_dir}/kernel",
        f"{config.paths.docs_dir}/strategy",
        f"{config.paths.docs_dir}/product",
        f"{config.paths.docs_dir}/atom",
        f"{config.paths.docs_dir}/reference",
        f"{config.paths.docs_dir}/archive",
    ]
```

**Instructions:**
1. Open `ontos/commands/init.py`
2. Replace the `dirs` list at lines 105-111 with the expanded version
3. Replace the `dirs` list at lines 174-180 with the same expanded version
4. Save

**Commit:**
```
feat(init): create full type hierarchy directories

Add kernel/, product/, atom/ to the directory structure created by
ontos init. Maps 1:1 to the Ontos type ranking and enables reliable
path-based type inference during scaffolding.
```

---

### Task 4: Add scaffold/no_scaffold to InitOptions

**Spec Reference:** Section 2.2.1
**Priority:** Must

**File:** `ontos/commands/init.py`

**Current Code (lines 14-21):**
```python
@dataclass
class InitOptions:
    """Configuration for init command."""
    path: Path = None
    force: bool = False
    interactive: bool = False  # Reserved for v3.1
    skip_hooks: bool = False
    yes: bool = False
```

**New Code:**
```python
@dataclass
class InitOptions:
    """Configuration for init command."""
    path: Path = None
    force: bool = False
    interactive: bool = False  # Reserved for v3.1
    skip_hooks: bool = False
    yes: bool = False
    scaffold: bool = False      # Force scaffold without prompt
    no_scaffold: bool = False   # Suppress scaffold prompt entirely
```

**Instructions:**
1. Open `ontos/commands/init.py`
2. Add the two new fields after line 21 (`yes: bool = False`)
3. Save

---

### Task 5: Implement _prompt_scaffold()

**Spec Reference:** Sections 2.2.3, 2.2.4, 2.4
**Priority:** Must

**File:** `ontos/commands/init.py`

**Instructions:** Add this function AFTER `_confirm_hooks()` (after line 61) and BEFORE `init_command()` (line 64):

```python
def _prompt_scaffold(project_root: Path, config, options: InitOptions):
    """Prompt user to scaffold untagged markdown files during init.

    Returns:
        List[Path] of directories to scaffold, or None to skip.

    Behavioral matrix:
        no_scaffold=True     -> None (skip)
        scaffold=True        -> [docs_dir] (force, docs scope)
        non-TTY              -> None (skip silently)
            Rationale: hooks proceed in non-TTY because they add new files.
            Scaffold modifies existing files, requiring explicit opt-in.
        TTY, 0 untagged      -> None (no prompt)
        TTY, N untagged      -> prompt user for confirmation + scope
    """
    from typing import List

    # Short-circuit on flags
    if options.no_scaffold:
        return None

    docs_path = project_root / config.paths.docs_dir

    if options.scaffold:
        return [docs_path]

    # Non-TTY: skip silently
    if not sys.stdin.isatty():
        return None

    # Detect untagged files in docs_dir
    try:
        from ontos.commands.scaffold import find_untagged_files
        untagged = find_untagged_files(paths=[docs_path])
    except Exception:
        return None

    if not untagged:
        return None

    # Large file count warning
    count = len(untagged)
    if count > 50:
        print(f"\nNote: Found {count} untagged files. This may take a moment.", file=sys.stderr)

    # Prompt for confirmation
    print(f"\nFound {count} untagged markdown file(s).")
    print("Scaffold adds YAML headers to identify each file.")
    try:
        response = input("Would you like to scaffold them? [y/N] ").strip().lower()
    except (EOFError, KeyboardInterrupt):
        return None

    if response not in ('y', 'yes'):
        return None

    # Prompt for scope
    print(f"\nWhere should we scan?")
    print(f"  (1) {config.paths.docs_dir}/ directory only")
    print("  (2) Entire repository (excludes node_modules, .venv, etc.)")
    print("  (3) Custom path")

    try:
        choice = input("Choice [1]: ").strip()
    except (EOFError, KeyboardInterrupt):
        return None

    if choice == '2':
        return [project_root]
    elif choice == '3':
        try:
            custom_input = input("Path (relative to project root): ").strip()
        except (EOFError, KeyboardInterrupt):
            return None

        if not custom_input:
            return [docs_path]

        custom_path = Path(custom_input)
        if not custom_path.is_absolute():
            custom_path = project_root / custom_path
        resolved = custom_path.resolve()

        # Path escape guard (B2)
        if not resolved.is_relative_to(project_root.resolve()):
            print("Error: Path must be within project root.", file=sys.stderr)
            return None

        if not resolved.exists():
            print(f"Error: Path '{custom_input}' does not exist.", file=sys.stderr)
            return None

        return [resolved]
    elif choice in ('1', ''):
        return [docs_path]
    else:
        print("Invalid choice, using docs/ directory.", file=sys.stderr)
        return [docs_path]
```

---

### Task 6: Implement _run_scaffold()

**Spec Reference:** Section 2.2.6
**Priority:** Must

**File:** `ontos/commands/init.py`

**Instructions:** Add this function immediately AFTER `_prompt_scaffold()`:

```python
def _run_scaffold(project_root: Path, paths) -> None:
    """Run scaffold on given paths during init. Non-fatal on failure.

    Matches the non-fatal pattern of _generate_agents_file().
    Note: Scaffold writes persist even if init is subsequently aborted.
    """
    try:
        from ontos.commands.scaffold import ScaffoldOptions, scaffold_command

        options = ScaffoldOptions(
            paths=paths,
            apply=True,
            dry_run=False,
            quiet=True,
        )
        exit_code, message = scaffold_command(options)

        if exit_code == 0:
            print("   Scaffold complete.", file=sys.stderr)
        else:
            print(f"Warning: Scaffold completed with errors: {message}", file=sys.stderr)
    except Exception as e:
        print(f"Warning: Could not run scaffold: {e}", file=sys.stderr)
```

---

### Task 7: Insert scaffold step in init_command

**Spec Reference:** Section 2.2.5
**Priority:** Must

**File:** `ontos/commands/init.py`

**Current Code (lines 118-120):**
```python
            p.mkdir(parents=True, exist_ok=True)

        # 6. Generate initial context map
```

**New Code (insert between the directory creation loop and the context map step):**
```python
            p.mkdir(parents=True, exist_ok=True)

        # 5.5 Scaffold integration (optional, interactive)
        scaffold_paths = _prompt_scaffold(project_root, config, options)
        if scaffold_paths is not None:
            _run_scaffold(project_root, scaffold_paths)

        # 6. Generate initial context map
```

**Instructions:**
1. Open `ontos/commands/init.py`
2. Find the line `# 6. Generate initial context map` (currently line 120)
3. Insert the scaffold step (4 lines) BEFORE it, after the directory creation loop ends
4. Save

**Commit:**
```
feat(init): add interactive scaffold integration

After creating directories, optionally scaffold existing untagged
markdown files. Supports --scaffold/--no-scaffold flags for CI.
Includes path escape guard (B2) and input validation (H3).
Non-fatal on failure, matching _generate_agents_file pattern.
```

---

### Task 8: Add CLI flags to _register_init

**Spec Reference:** Section 2.2.2
**Priority:** Must

**File:** `ontos/cli.py`

**Current Code (lines 104-113):**
```python
def _register_init(subparsers, parent):
    """Register init command."""
    p = subparsers.add_parser("init", help="Initialize Ontos in a project", parents=[parent])
    p.add_argument("--force", "-f", action="store_true",
                   help="Overwrite existing config and hooks")
    p.add_argument("--skip-hooks", action="store_true",
                   help="Don't install git hooks")
    p.add_argument("--yes", "-y", action="store_true",
                   help="Non-interactive mode: accept all defaults")
    p.set_defaults(func=_cmd_init)
```

**New Code:**
```python
def _register_init(subparsers, parent):
    """Register init command."""
    p = subparsers.add_parser("init", help="Initialize Ontos in a project", parents=[parent])
    p.add_argument("--force", "-f", action="store_true",
                   help="Overwrite existing config and hooks")
    p.add_argument("--skip-hooks", action="store_true",
                   help="Don't install git hooks")
    p.add_argument("--yes", "-y", action="store_true",
                   help="Non-interactive mode: accept all defaults")
    # Scaffold flags (mutually exclusive)
    scaffold_group = p.add_mutually_exclusive_group()
    scaffold_group.add_argument("--scaffold", action="store_true",
                                help="Auto-scaffold untagged files (uses docs/ scope)")
    scaffold_group.add_argument("--no-scaffold", action="store_true",
                                help="Skip scaffold prompt")
    p.set_defaults(func=_cmd_init)
```

---

### Task 9: Pass new fields in _cmd_init

**Spec Reference:** Section 2.2.2
**Priority:** Must

**File:** `ontos/cli.py`

**Current Code (lines 360-381):**
```python
def _cmd_init(args) -> int:
    """Handle init command."""
    from ontos.commands.init import init_command, InitOptions

    options = InitOptions(
        path=Path.cwd(),
        force=args.force,
        skip_hooks=getattr(args, "skip_hooks", False),
        yes=getattr(args, "yes", False),
    )
    code, msg = init_command(options)

    if args.json:
        emit_json({
            "status": "success" if code == 0 else "error",
            "message": msg,
            "exit_code": code
        })
    elif not args.quiet:
        print(msg)

    return code
```

**New Code:**
```python
def _cmd_init(args) -> int:
    """Handle init command."""
    from ontos.commands.init import init_command, InitOptions

    options = InitOptions(
        path=Path.cwd(),
        force=args.force,
        skip_hooks=getattr(args, "skip_hooks", False),
        yes=getattr(args, "yes", False),
        scaffold=getattr(args, "scaffold", False),
        no_scaffold=getattr(args, "no_scaffold", False),
    )
    code, msg = init_command(options)

    if args.json:
        emit_json({
            "status": "success" if code == 0 else "error",
            "message": msg,
            "exit_code": code
        })
    elif not args.quiet:
        print(msg)

    return code
```

**Commit:**
```
feat(cli): add --scaffold/--no-scaffold flags to init
```

---

### Task 10: Update Dual_Mode_Matrix.md

**Spec Reference:** Section 4 (Matrix update for B3)
**Priority:** Must

**File:** `.ontos-internal/reference/Dual_Mode_Matrix.md`

**Current Code (lines 19-29):**
```markdown
| Directory | Contributor Mode | User Mode | Notes |
|-----------|------------------|-----------|-------|
| Documentation root | `.ontos-internal/` | `docs/` | Set by `is_ontos_repo()` |
| Session logs | `.ontos-internal/logs/` | `docs/logs/` | |
| Strategy docs | `.ontos-internal/strategy/` | `docs/strategy/` | |
| Proposals | `.ontos-internal/strategy/proposals/` | `docs/strategy/proposals/` | v2.5.2+ |
| Archive (logs) | `.ontos-internal/archive/logs/` | `docs/archive/logs/` | v2.5.2+ |
| Archive (proposals) | `.ontos-internal/archive/proposals/` | `docs/archive/proposals/` | v2.5.2+ |
| Reference docs | `.ontos-internal/reference/` | `docs/reference/` | |
| Kernel docs | `.ontos-internal/kernel/` | `docs/` (flat) | Users don't need kernel/ |
| Atom docs | `.ontos-internal/atom/` | `docs/` (flat) | Users don't need atom/ |
```

**New Code:**
```markdown
| Directory | Contributor Mode | User Mode | Notes |
|-----------|------------------|-----------|-------|
| Documentation root | `.ontos-internal/` | `docs/` | Set by `is_ontos_repo()` |
| Session logs | `.ontos-internal/logs/` | `docs/logs/` | |
| Kernel docs | `.ontos-internal/kernel/` | `docs/kernel/` | v3.1.1+ |
| Strategy docs | `.ontos-internal/strategy/` | `docs/strategy/` | |
| Product docs | — | `docs/product/` | v3.1.1+ |
| Atom docs | `.ontos-internal/atom/` | `docs/atom/` | v3.1.1+ |
| Proposals | `.ontos-internal/strategy/proposals/` | `docs/strategy/proposals/` | v2.5.2+ |
| Archive (logs) | `.ontos-internal/archive/logs/` | `docs/archive/logs/` | v2.5.2+ |
| Archive (proposals) | `.ontos-internal/archive/proposals/` | `docs/archive/proposals/` | v2.5.2+ |
| Reference docs | `.ontos-internal/reference/` | `docs/reference/` | |
```

Also update **Section 9 (Version History)** — current content (lines 154-162):
```markdown
| Version | Changes |
|---------|---------|
| v2.5.2 | Added nested directory structure, template loader, path helpers with backward compat |
| v2.5.1 | Added proposals directory concept |
| v2.5.0 | Mode promises, consolidation behavior per mode |
| v2.4.0 | Mode system (automated/prompted/advisory) |
| v1.5.0 | Initial dual-mode support via `is_ontos_repo()` |
```

**New version table:**
```markdown
| Version | Changes |
|---------|---------|
| v3.1.1 | Full type hierarchy in user mode: kernel/, product/, atom/ subdirectories |
| v2.5.2 | Added nested directory structure, template loader, path helpers with backward compat |
| v2.5.1 | Added proposals directory concept |
| v2.5.0 | Mode promises, consolidation behavior per mode |
| v2.4.0 | Mode system (automated/prompted/advisory) |
| v1.5.0 | Initial dual-mode support via `is_ontos_repo()` |
```

**Commit:**
```
docs(reference): update Dual Mode Matrix for v3.1.1 type hierarchy
```

---

### Task 11: Update test_init_phase3.py

**Spec Reference:** Section 6
**Priority:** Must

**File:** `tests/commands/test_init_phase3.py`

**Current Code (lines 34-43):**
```python
    def test_init_creates_directory_structure(self, git_repo):
        """Init creates the expected directory structure."""
        options = InitOptions(path=git_repo)
        init_command(options)

        assert (git_repo / "docs").is_dir()
        assert (git_repo / "docs" / "logs").is_dir()
        assert (git_repo / "docs" / "strategy").is_dir()
        assert (git_repo / "docs" / "reference").is_dir()
        assert (git_repo / "docs" / "archive").is_dir()
```

**New Code:**
```python
    def test_init_creates_directory_structure(self, git_repo):
        """Init creates the full type hierarchy directory structure."""
        options = InitOptions(path=git_repo, no_scaffold=True)
        init_command(options)

        assert (git_repo / "docs").is_dir()
        assert (git_repo / "docs" / "logs").is_dir()
        assert (git_repo / "docs" / "kernel").is_dir()
        assert (git_repo / "docs" / "strategy").is_dir()
        assert (git_repo / "docs" / "product").is_dir()
        assert (git_repo / "docs" / "atom").is_dir()
        assert (git_repo / "docs" / "reference").is_dir()
        assert (git_repo / "docs" / "archive").is_dir()
```

**Also:** Add `no_scaffold=True` to other test InitOptions calls that don't need scaffold prompting. Specifically update these lines to prevent scaffold prompts from interfering with unrelated tests:
- Line 27: `InitOptions(path=git_repo)` -> `InitOptions(path=git_repo, no_scaffold=True)`
- Line 123: `InitOptions(path=git_repo)` -> `InitOptions(path=git_repo, no_scaffold=True)`
- Line 151: `InitOptions(path=git_repo)` -> `InitOptions(path=git_repo, no_scaffold=True)`
- Line 259: `InitOptions(path=git_repo)` -> `InitOptions(path=git_repo, no_scaffold=True)`

(Only add `no_scaffold=True` where the test doesn't explicitly test scaffold behavior and runs in a git_repo that might trigger the prompt.)

**Commit:**
```
test(init): update directory assertions for full type hierarchy
```

---

### Task 12: Create test_init_scaffold.py

**Spec Reference:** Section 6
**Priority:** Must

**File:** `tests/commands/test_init_scaffold.py` (NEW)

**Full content:**
```python
"""Tests for scaffold integration in ontos init (v3.1.1)."""
import pytest
from pathlib import Path
import subprocess

from ontos.commands.init import init_command, InitOptions
from ontos.commands.scaffold import DEFAULT_IGNORES


@pytest.fixture
def git_repo(tmp_path):
    """Create a temporary git repository."""
    subprocess.run(["git", "init"], cwd=tmp_path, capture_output=True, check=True)
    return tmp_path


class TestInitDirectories:
    """Tests for full type hierarchy directory creation."""

    def test_init_creates_kernel_dir(self, git_repo):
        """Init creates docs/kernel/ directory."""
        options = InitOptions(path=git_repo, skip_hooks=True, no_scaffold=True)
        init_command(options)
        assert (git_repo / "docs" / "kernel").is_dir()

    def test_init_creates_product_dir(self, git_repo):
        """Init creates docs/product/ directory."""
        options = InitOptions(path=git_repo, skip_hooks=True, no_scaffold=True)
        init_command(options)
        assert (git_repo / "docs" / "product").is_dir()

    def test_init_creates_atom_dir(self, git_repo):
        """Init creates docs/atom/ directory."""
        options = InitOptions(path=git_repo, skip_hooks=True, no_scaffold=True)
        init_command(options)
        assert (git_repo / "docs" / "atom").is_dir()

    def test_init_creates_all_type_hierarchy_dirs(self, git_repo):
        """Init creates complete type hierarchy."""
        options = InitOptions(path=git_repo, skip_hooks=True, no_scaffold=True)
        init_command(options)
        for subdir in ['kernel', 'strategy', 'product', 'atom', 'logs', 'reference', 'archive']:
            assert (git_repo / "docs" / subdir).is_dir(), f"Missing docs/{subdir}/"


class TestScaffoldFlags:
    """Tests for --scaffold / --no-scaffold flags."""

    def test_no_scaffold_flag_skips(self, git_repo, monkeypatch):
        """--no-scaffold suppresses scaffold entirely."""
        (git_repo / "docs").mkdir()
        (git_repo / "docs" / "test.md").write_text("# Test\nContent.")

        monkeypatch.setattr('sys.stdin.isatty', lambda: True)
        options = InitOptions(path=git_repo, skip_hooks=True, no_scaffold=True)
        code, _ = init_command(options)

        assert code in (0, 3)
        # File should NOT have frontmatter
        content = (git_repo / "docs" / "test.md").read_text()
        assert "id:" not in content

    def test_scaffold_flag_forces(self, git_repo, monkeypatch):
        """--scaffold runs scaffold without prompting."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent here.")

        monkeypatch.setattr('sys.stdin.isatty', lambda: True)
        options = InitOptions(path=git_repo, skip_hooks=True, scaffold=True)
        code, _ = init_command(options)

        assert code in (0, 3)
        content = (docs / "test.md").read_text()
        assert "id:" in content

    def test_non_tty_skips_scaffold(self, git_repo, monkeypatch):
        """Non-TTY mode skips scaffold silently."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        monkeypatch.setattr('sys.stdin.isatty', lambda: False)
        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)

        assert code in (0, 3)
        content = (docs / "test.md").read_text()
        assert "id:" not in content


class TestScaffoldPrompt:
    """Tests for interactive scaffold prompt flow."""

    def test_no_untagged_skips_prompt(self, git_repo, monkeypatch):
        """No prompt when no untagged files exist."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "tagged.md").write_text("---\nid: tagged\ntype: atom\n---\n# Tagged")

        input_called = []
        def mock_input(prompt):
            input_called.append(prompt)
            return 'n'
        monkeypatch.setattr('builtins.input', mock_input)
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)
        # Scaffold-related prompt should NOT have been called
        assert not any('scaffold' in p.lower() for p in input_called)

    def test_prompt_decline(self, git_repo, monkeypatch):
        """User declining scaffold prompt skips scaffold."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        inputs = iter(['n'])
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)
        content = (docs / "test.md").read_text()
        assert "id:" not in content

    def test_prompt_accept_docs_scope(self, git_repo, monkeypatch):
        """User accepts scaffold with docs/ scope."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        inputs = iter(['y', '1'])
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)
        content = (docs / "test.md").read_text()
        assert "id:" in content

    def test_prompt_accept_repo_scope(self, git_repo, monkeypatch):
        """User accepts scaffold with entire repo scope."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")
        # Also create a file outside docs/
        (git_repo / "notes.md").write_text("# Notes\nSome notes.")

        inputs = iter(['y', '2'])
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)

    def test_eof_skips_gracefully(self, git_repo, monkeypatch):
        """EOFError during scaffold prompt skips gracefully."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        def mock_input(prompt):
            raise EOFError()
        monkeypatch.setattr('builtins.input', mock_input)
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)  # Init still succeeds

    def test_keyboard_interrupt_skips(self, git_repo, monkeypatch):
        """KeyboardInterrupt during scaffold prompt skips (does not abort init)."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        call_count = [0]
        def mock_input(prompt):
            call_count[0] += 1
            if 'scaffold' in prompt.lower() or 'y/N' in prompt:
                raise KeyboardInterrupt()
            return 'n'
        monkeypatch.setattr('builtins.input', mock_input)
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        # Init should still succeed (scaffold skipped, not aborted)
        assert code in (0, 3)


class TestScaffoldSafety:
    """Tests for scaffold safety guards."""

    def test_default_ignores_node_modules(self, git_repo, monkeypatch):
        """node_modules/ files are NOT scaffolded even with repo-wide scan."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "legit.md").write_text("# Legit\nContent.")

        nm = git_repo / "node_modules"
        nm.mkdir()
        (nm / "README.md").write_text("# Some Package\nDo not scaffold me.")

        inputs = iter(['y', '2'])  # Accept, entire repo
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        init_command(options)

        # node_modules file should NOT have frontmatter
        nm_content = (nm / "README.md").read_text()
        assert "id:" not in nm_content

    def test_default_ignores_venv(self, git_repo, monkeypatch):
        """Files in .venv/ are NOT scaffolded."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "legit.md").write_text("# Legit\nContent.")

        venv = git_repo / ".venv" / "lib"
        venv.mkdir(parents=True)
        (venv / "guide.md").write_text("# Venv Doc\nShould be ignored.")

        inputs = iter(['y', '2'])
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        init_command(options)

        venv_content = (venv / "guide.md").read_text()
        assert "id:" not in venv_content

    def test_custom_path_escape_rejected(self, git_repo, monkeypatch):
        """Path escaping project root is rejected."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        inputs = iter(['y', '3', '../outside'])
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        # Init succeeds but scaffold is skipped
        assert code in (0, 3)
        content = (docs / "test.md").read_text()
        assert "id:" not in content

    def test_custom_path_absolute_rejected(self, git_repo, monkeypatch):
        """Absolute path outside project is rejected."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        inputs = iter(['y', '3', '/tmp/other'])
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)
        content = (docs / "test.md").read_text()
        assert "id:" not in content

    def test_invalid_scope_defaults_to_docs(self, git_repo, monkeypatch):
        """Invalid scope input defaults to docs/ with message."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        inputs = iter(['y', '5'])  # Invalid scope
        monkeypatch.setattr('builtins.input', lambda prompt: next(inputs))
        monkeypatch.setattr('sys.stdin.isatty', lambda: True)

        options = InitOptions(path=git_repo, skip_hooks=True)
        code, _ = init_command(options)
        assert code in (0, 3)
        # Should still scaffold (defaulted to docs/)
        content = (docs / "test.md").read_text()
        assert "id:" in content

    def test_scaffold_failure_nonfatal(self, git_repo, monkeypatch):
        """scaffold_command failure doesn't abort init."""
        docs = git_repo / "docs"
        docs.mkdir()
        (docs / "test.md").write_text("# Test\nContent.")

        # Mock scaffold_command to raise
        def mock_scaffold_cmd(options):
            raise RuntimeError("Simulated failure")

        monkeypatch.setattr(
            'ontos.commands.scaffold.scaffold_command',
            mock_scaffold_cmd
        )

        options = InitOptions(path=git_repo, skip_hooks=True, scaffold=True)
        code, _ = init_command(options)
        # Init should still succeed despite scaffold failure
        assert code in (0, 3)
        assert (git_repo / ".ontos.toml").exists()


class TestDefaultIgnoresConstant:
    """Tests for the DEFAULT_IGNORES constant itself."""

    def test_default_ignores_contains_node_modules(self):
        """DEFAULT_IGNORES includes node_modules."""
        assert 'node_modules' in DEFAULT_IGNORES

    def test_default_ignores_contains_venv(self):
        """DEFAULT_IGNORES includes .venv."""
        assert '.venv' in DEFAULT_IGNORES

    def test_default_ignores_contains_vendor(self):
        """DEFAULT_IGNORES includes vendor."""
        assert 'vendor' in DEFAULT_IGNORES

    def test_default_ignores_minimum_count(self):
        """DEFAULT_IGNORES has at least 8 patterns."""
        assert len(DEFAULT_IGNORES) >= 8
```

**Commit:**
```
test(init): add scaffold integration and safety tests

Covers: --scaffold/--no-scaffold flags, interactive prompt flow,
DEFAULT_IGNORES exclusions, path escape guard, input validation,
and non-fatal scaffold failure.
```

---

## 5. Regression Testing Protocol

After completing tasks 1-2:
```bash
pytest tests/commands/test_scaffold_parity.py -v
```

After completing tasks 3-7:
```bash
pytest tests/commands/test_init_phase3.py -v
```

After completing tasks 8-9:
```bash
pytest tests/ -k "init" -v
```

After completing all tasks:
```bash
pytest tests/ -v
```

---

## 6. Final Verification

```bash
# Full test suite
pytest tests/ -v

# Manual smoke test 1: directory structure
rm -rf /tmp/ontos-test && mkdir /tmp/ontos-test && cd /tmp/ontos-test && git init
ontos init --no-scaffold --skip-hooks
ls docs/
# Expected output includes: kernel/ strategy/ product/ atom/ logs/ reference/ archive/

# Manual smoke test 2: scaffold with DEFAULT_IGNORES
rm -rf /tmp/ontos-test && mkdir /tmp/ontos-test && cd /tmp/ontos-test && git init
mkdir -p node_modules docs
echo "# Package" > node_modules/README.md
echo "# Design" > docs/design.md
ontos init --scaffold --skip-hooks
cat docs/design.md      # Should have frontmatter (id: design)
cat node_modules/README.md  # Should NOT have frontmatter

# Manual smoke test 3: path escape rejection
rm -rf /tmp/ontos-test && mkdir /tmp/ontos-test && cd /tmp/ontos-test && git init
mkdir docs && echo "# X" > docs/x.md
ontos init --skip-hooks
# When prompted: y, 3, ../outside
# Should see: "Error: Path must be within project root."
```

---

## 7. PR Preparation

**Branch:** `feature/init-improvements-v3.1.1`

**Squash commits into logical units:**
1. `fix(scaffold): add DEFAULT_IGNORES for dependency directories`
2. `feat(init): full type hierarchy + scaffold integration`
3. `docs(reference): update Dual Mode Matrix for v3.1.1`
4. `test(init): add scaffold integration and safety tests`

**PR Title:** `feat(init): Full type hierarchy + scaffold integration (v3.1.1)`

**PR Body:**
```markdown
## Summary
- Add kernel/, product/, atom/ directories to `ontos init`
- Add interactive scaffold prompt during init (--scaffold/--no-scaffold)
- Add DEFAULT_IGNORES safety (node_modules, .venv, vendor, etc.)
- Add path escape guard for custom scaffold paths
- Update Dual Mode Matrix to reflect v3.1.1 type hierarchy

## Spec Compliance
Implements `v3.1.1-Implementation-Spec.md` v1.1 (approved 2026-01-22)

## Testing
- [x] All existing tests pass
- [x] 20+ new tests for scaffold integration and safety
- [x] Manual verification (3 smoke tests)

## Review Checklist
- [ ] Peer Review
- [ ] Alignment Review
- [ ] Adversarial Review
```
