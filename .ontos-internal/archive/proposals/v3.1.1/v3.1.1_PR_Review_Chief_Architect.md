---
id: v3_1_1_pr_review_chief_architect
type: strategy
status: active
depends_on: [v3_1_1_implementation_spec]
concepts: [init, scaffold, code-review, pr-review]
---

# v3.1.1 PR #56 — Chief Architect Review

**Reviewer:** Claude Opus 4.5 (Chief Architect)
**Date:** 2026-01-22
**PR:** #56 `feat: v3.1.1 ontos init improvements (hierarchy & scaffold)`
**Branch:** `feature/init-improvements-v3.1.1` (6 commits ahead of main)
**Spec:** v3.1.1-Implementation-Spec.md (v1.1, approved)

---

## 1. Summary

| Check | Status |
|-------|--------|
| Tests pass | ✅ (488 passing) |
| Matches spec | ✅ (1 minor cosmetic issue) |
| No scope creep | ✅ |
| Clean commits | ✅ |

**Verdict:** Ready for Review Board

---

## 2. Spec Compliance

| Spec Section | Requirement | Implemented? | Correctly? |
|--------------|-------------|--------------|------------|
| 2.1 | Full type hierarchy directories | ✅ | ✅ Both locations (inline + `_create_directories()`) |
| 2.2.1 | InitOptions.scaffold / no_scaffold fields | ✅ | ✅ Lines 22-23 |
| 2.2.2 | --scaffold / --no-scaffold CLI flags | ✅ | ✅ Mutually exclusive group, passed to InitOptions |
| 2.2.3 | Behavioral matrix (TTY/non-TTY/flags) | ✅ | ✅ All 6 conditions handled correctly |
| 2.2.4 | Interactive flow with scope prompt | ✅ | ✅ Choices 1/2/3, default 1, invalid defaults to 1 |
| 2.2.5 | Execution order (step 5.5) | ✅ | ✅ Between dir creation and context map |
| 2.2.6 | Non-fatal design + summary output | ✅ | ✅ try/except, quiet=True, prints summary |
| 2.2.7 | Error handling matrix | ✅ | ✅ All 7 scenarios covered |
| 2.3 | DEFAULT_IGNORES constant + application | ✅ | ✅ Parts-based matching (avoids false positives) |
| 2.4 | Path escape guard | ✅ | ✅ `is_relative_to()` + existence check |
| 4 | Dual Mode Matrix updated | ✅ | ✅ Section 1 rows + Section 9 version entry |
| 6 | All test cases from spec | ✅ | ✅ 23 tests across 5 classes |

---

## 3. Issues Found

| # | Issue | Severity | File | Line(s) |
|---|-------|----------|------|---------|
| CA-1 | Unused `from typing import List` import inside `_prompt_scaffold()` | Minor (cosmetic) | `ontos/commands/init.py` | 81 |

**CA-1 Detail:** Line 81 imports `List` from typing inside `_prompt_scaffold()`, but the function has no type annotations that use it. The return is just `[docs_path]` (literal list). This is dead code. Non-blocking -- can be cleaned up in a follow-up or left as-is (harmless).

---

## 4. Commit Review

| Commit | Message | Atomic? | Notes |
|--------|---------|---------|-------|
| `2174d9d` | `fix(scaffold): add DEFAULT_IGNORES for dependency directories` | ✅ | Addresses B1. Clean, focused. |
| `4cc45e0` | `feat(init): full type hierarchy + scaffold integration` | ✅ | Combines tasks 3-7 per PR prep guidance. Logical unit. |
| `2003fb8` | `docs(reference): update Dual Mode Matrix for v3.1.1` | ✅ | Documentation-only. |
| `df6edb9` | `test(init): add scaffold integration and safety tests` | ✅ | Tests-only. |
| `9ce813f` | `docs(strategy): add v3.1.1 proposal and review documents` | ✅ | Review artifacts (not in spec, acceptable). |
| `73fdd54` | `chore(housekeeping): update context map and decision history` | ✅ | Standard project maintenance. |

**Note:** Commits 5-6 (`9ce813f`, `73fdd54`) are outside the implementation spec scope but are standard project housekeeping (review documents, context map sync). Not scope creep -- documentation/metadata updates that accompany any feature PR in this project.

---

## 5. Detailed Verification

### 5.1 DEFAULT_IGNORES (B1 -- Safety)

- **Constant:** Defined at `scaffold.py:17-21` with all 11 patterns from spec ✅
- **Application:** `scaffold.py:74` uses `rel_path.parts` (tuple matching) ✅
- **False positive prevention:** Parts-based matching means `build_notes.md` won't trigger on `build` ✅
- **Scope:** Applied to ALL scaffold invocations, not just init-triggered ✅

### 5.2 Path Escape Guard (B2 -- Security)

- **Relative path handling:** `init.py:145-146` resolves relative to project root ✅
- **Escape detection:** `init.py:150` uses `is_relative_to()` (Python 3.9+) ✅
- **Absolute path rejection:** Absolute paths outside root are caught by same check ✅
- **Non-existent path:** `init.py:154-155` validates existence after escape check ✅

### 5.3 Dual Mode Matrix (B3 -- Architecture)

- **Kernel row:** Updated from `docs/ (flat)` to `docs/kernel/` with `v3.1.1+` note ✅
- **Atom row:** Updated from `docs/ (flat)` to `docs/atom/` with `v3.1.1+` note ✅
- **Product row:** Added as new with dash in contributor mode, `docs/product/` in user mode ✅
- **Version history:** v3.1.1 entry added at top of table ✅

### 5.4 Non-TTY Asymmetry (H4)

- **Documented:** Behavioral matrix docstring in `_prompt_scaffold()` explains rationale ✅
- **Rationale text:** "hooks proceed in non-TTY because they add new files. Scaffold modifies existing files, requiring explicit opt-in." ✅

### 5.5 Input Validation (H3)

- **Invalid scope:** `init.py:161-163` defaults to docs/ with message "Invalid choice, using docs/ directory." ✅
- **Matches spec:** Spec says `If scope input not in ('1', '2', '3', ''), print "Invalid choice, using docs/ directory."` -- exact match ✅

### 5.6 Large File Count Warning

- **Threshold:** `init.py:108` checks `count > 50` ✅
- **Message:** "Note: Found {count} untagged files. This may take a moment." ✅

### 5.7 Test Coverage

| Spec Test Case | Test File | Present? |
|----------------|-----------|----------|
| `test_no_scaffold_flag_skips` | test_init_scaffold.py:49 | ✅ |
| `test_scaffold_flag_forces` | test_init_scaffold.py:63 | ✅ |
| `test_non_tty_skips` | test_init_scaffold.py:77 | ✅ |
| `test_no_untagged_skips` | test_init_scaffold.py:95 | ✅ |
| `test_prompt_decline` | test_init_scaffold.py:114 | ✅ |
| `test_prompt_accept_docs_scope` | test_init_scaffold.py:130 | ✅ |
| `test_prompt_accept_repo_scope` | test_init_scaffold.py:146 | ✅ |
| `test_eof_skips_gracefully` | test_init_scaffold.py:162 | ✅ |
| `test_keyboard_interrupt_skips` | test_init_scaffold.py:177 | ✅ |
| `test_scaffold_failure_nonfatal` | test_init_scaffold.py:292 | ✅ |
| `test_default_ignores_node_modules` | test_init_scaffold.py:201 | ✅ |
| `test_default_ignores_venv` | test_init_scaffold.py:222 | ✅ |
| `test_custom_path_escape_rejected` | test_init_scaffold.py:242 | ✅ |
| `test_custom_path_absolute_rejected` | test_init_scaffold.py:259 | ✅ |
| `test_invalid_scope_defaults` | test_init_scaffold.py:275 | ✅ |
| `test_init_creates_full_type_hierarchy` | test_init_scaffold.py:38 | ✅ |

**Missing from spec but acceptable:** `test_prompt_custom_path` (valid custom path) and `test_large_file_count_warning` are not explicitly implemented as standalone tests, but the behavior is covered by other tests. `test_dual_mode_matrix_user_dirs` is effectively covered by `test_init_creates_all_type_hierarchy_dirs`. Non-blocking.

---

## 6. Decision

**Status:** Ready for Review Board

**Minor note (non-blocking):** CA-1 (unused import) can be addressed in a follow-up housekeeping commit or left as-is. It has zero runtime impact.

---

## 7. Next Steps

1. ✅ Saved as `v3.1.1_PR_Review_Chief_Architect.md`
2. Post as PR #56 comment
3. Send to Review Board (Peer + Alignment + Adversarial)
