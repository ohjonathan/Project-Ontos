# Chief Architect Response: v3.0.0 Spec Review

**Author:** Chief Architect (Codex)
**Date:** 2026-01-17
**Status:** REQUIRES SECOND REVIEW

---

## 1. Blocking Issues Response

### B1: AGENTS.md template content not defined

**Issue:** Spec provides only an excerpt; full template is missing.
**Flagged by:** Claude (Adversarial)

**Response:** Accept

**Action:** Define the complete AGENTS.md template and add it to the spec appendix.

**Deliverable:** Full template provided in Appendix A below (and mirrored in spec v1.1 Appendix A).

**Reasoning:** Implementation requires exact content; this is a hard blocker.

---

### B2: .cursorrules transform rules not specified

**Issue:** Spec does not define the mapping from AGENTS.md to .cursorrules.
**Flagged by:** Claude (Adversarial)

**Response:** Accept

**Action:** Specify explicit transform rules and include them in the spec appendix.

**Deliverable:** Mapping table provided in Appendix B below (and mirrored in spec v1.1 Appendix B).

**Reasoning:** `--format=cursor` cannot be implemented without explicit rules.

---

## 2. Major Issues Response

### M1: Missing PyPI functional verification

**Response:** Accept
**Action:** Add a TestPyPI install verification step before PyPI publish (`pip install --index-url https://test.pypi.org/simple/ --no-deps ontos` + `ontos --version`).
**Spec Change:** PyPI spec §4.3.1 and §9 acceptance criteria.

### M2: Staleness logic misses package updates

**Response:** Defer
**Action:** Defer to v3.0.3; avoid scope creep not in Cofounder response.
**Spec Change:** None (tracked in review notes/risk table).

### M3: Data cleanup verification mismatch

**Response:** Accept
**Action:** Require `ontos doctor` to show 0 validation errors in addition to `ontos map --strict`.
**Spec Change:** Data cleanup spec §4.1, §4.3.1, §6.2, §9 acceptance criteria.

### M4: Golden test requirement for agents output

**Response:** Accept
**Action:** Make golden baseline required for AGENTS.md (and .cursorrules if cursor format is implemented).
**Spec Change:** agents spec §6.3 and §9 acceptance criteria.

### M5: Publish workflow not gated on tests

**Response:** Accept
**Action:** Gate publish on tests (either run tests in publish workflow or use workflow_run from CI). Use in-workflow tests for simplicity.
**Spec Change:** PyPI spec §4.3.1 and §9 acceptance criteria.

### M6: No version stamp in AGENTS.md

**Response:** Accept
**Action:** Add generation metadata line (`Generated by Ontos vX.Y.Z on YYYY-MM-DD HH:MM:SS UTC`).
**Spec Change:** agents spec §3.1 FR10, §4.3.2, and Appendix A.

### M7: Template injection via stats

**Response:** Accept
**Action:** Restrict template placeholders to numeric/timestamp values; avoid user-controlled strings in template.
**Spec Change:** agents spec §3.2 NFR5 and §4.3.1.

### M8: No backup before overwrite

**Response:** Accept
**Action:** When `--force` is used, create `.bak` backup of the existing file before overwrite.
**Spec Change:** agents spec §3.1 FR11 and §4.3.1 key logic.

---

## 3. Open Questions Decisions

### Q1: Keep `ontos export` as alias?

**Consolidation Recommendation:** Keep as deprecated alias with warning
**Decision:** Keep as deprecated alias; warn to stderr and delegate to `agents`.
**Reasoning:** Avoid breaking existing workflows while guiding users to the new command.
**Spec Change:** agents spec §4.1 and tests (alias warning test).

### Q2: Add success signal to AGENTS.md?

**Consolidation Recommendation:** Defer
**Decision:** Defer
**Reasoning:** Not in Cofounder scope; avoid increasing template length in v3.0.0.

### Q3: Manual approval between TestPyPI and PyPI?

**Consolidation Recommendation:** Automate with verification step
**Decision:** Automate with verification step (no manual approval)
**Reasoning:** Keeps release flow simple while adding safety via TestPyPI install check.
**Spec Change:** PyPI spec §4.3.1 and §9 acceptance criteria.

### Q4: Logs dir default?

**Consolidation Recommendation:** Use config path
**Decision:** Use config path (fallback to `docs/logs` if config unavailable)
**Reasoning:** Config is the source of truth.

### Q5: Time-based staleness?

**Consolidation Recommendation:** Reject
**Decision:** Reject
**Reasoning:** Time-based checks are arbitrary; mtime vs source files is sufficient for v3.0.0.

---

## 4. Minor Issues Disposition

| Issue | Decision | Rationale |
|-------|----------|-----------|
| m1: Cursorrules output filename | Accept | Explicitly set default output to repo root `.cursorrules`. |
| m2: Output directory creation | Accept | Create parent directories for `--output` path. |
| m3: Windows file locking | Accept | Add clear `PermissionError` message to guide users. |
| m4: Stats gathering unbounded | Accept | Use generator + cap at 5000 files; show `5000+` if exceeded. |
| m5: last_updated format | Accept | Define `YYYY-MM-DD HH:MM:SS UTC`. |
| m6: TestPyPI version collision | Defer | Known limitation; require version bump on failure. |
| m7: Export alias deprecation test | Accept | Add unit test for warning and delegation. |

---

## 5. Uncomfortable Questions Answered

### Q: Have you tested the AGENTS.md content with multiple LLMs?

**Answer:** Not yet. I will add a manual test step for 2 LLMs in v3.0.0 verification, but no results exist today.

### Q: What's your fallback if PyPI trusted publisher fails?

**Answer:** Use manual publish with a one-time token from the PyPI project owners (temporary fallback), and point users to the README git+ install path until resolved.

### Q: Why no Windows CI?

**Answer:** Scope and time; Windows CI is deferred to v3.0.3. For v3.0.0 we accept the risk and add clearer error messaging for Windows file locking.

---

## 6. Unique Insights Incorporated

| Insight | From | Incorporated? | How |
|---------|------|---------------|-----|
| Template needs "Invariants" section | Gemini | Yes | Added Core Invariants section to template. |
| LLMs won't remember `ontos log` | Gemini | Yes | Added explicit Session End protocol in template. |
| `find_repo_root()` fallback dangerous | Claude | Yes | Prefer `.ontos.toml`, then `git rev-parse --show-toplevel`, then fallback. |
| doctor.py vs export.py root inconsistency | Claude | Yes | Require doctor staleness check to use same repo-root helper. |
| init.py hardcoded "ontos export" tip | Claude | Yes | Update init success message to reference `ontos agents`. |

---

## 7. Changelog for v1.1

| Section | Change | Addresses |
|---------|--------|-----------|
| agents §3.1/§4.3 | Add generation metadata + backup on `--force` + stats cap | M6, M8, m4 |
| agents §4.3.1 | Define repo root resolution using `.ontos.toml` or `git rev-parse` | Unique insight |
| agents §6.3/§9 | Golden tests required for AGENTS.md (and .cursorrules if implemented) | M4 |
| PyPI §4.3.1/§9 | Add test gating + TestPyPI install verification step | M1, M5 |
| Data cleanup §4.3/§6/§9 | Add `ontos doctor` validation clean requirement | M3 |
| Init auto-gen §2/§3/§9 | Update init tip to `ontos agents` | Unique insight |
| Appendices | Add full AGENTS template + cursor transform rules | B1, B2 |

---

## 8. Verification Review Decision

**Required?** Yes

**If Yes:**
- Scope: AGENTS template content, .cursorrules transform rules, PyPI workflow verification steps, and data cleanup verification change.
- Reviewer(s): Claude (Adversarial), Gemini (Peer), Codex (Alignment).

---

## 9. Deliverables

1. [ ] Complete AGENTS.md template (Appendix A)
2. [ ] .cursorrules transform rules (Appendix B)
3. [ ] Updated spec v1.1
4. [ ] Updated PyPI workflow guidance (verification step)

---

## Appendix A: Complete AGENTS.md Template

```markdown
# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{ontos_version} on {generated_at}

## Ontos Activation
1. Run `ontos map` to regenerate the context map.
2. Read `Ontos_Context_Map.md` to understand the documentation graph.
3. Load only the relevant documents for the task.
4. Follow `depends_on` upward as needed.
5. Confirm: "Loaded: [ids]".

## Session End
1. Run `ontos log -e "slug"` to archive session work.
2. Fill in Goal, Key Decisions, Alternatives Considered, and Impacts.

## Quick Reference
| Command | Purpose |
|---------|---------|
| `ontos map` | Regenerate context map |
| `ontos agents` | Generate instruction files |
| `ontos doctor` | Health check and validation |
| `ontos log -e "slug"` | Archive session work |
| `ontos query <id>` | Find document by ID |

## Project Stats
- Doc Count: {doc_count}
- Last Updated: {last_updated}

## Core Invariants
- Do not edit `Ontos_Context_Map.md` manually; regenerate with `ontos map`.
- Do not edit `AGENTS.md` manually; regenerate with `ontos agents`.
- If a command fails, read the error message and avoid guessing fixes.

## Staleness
If `AGENTS.md` is older than the context map or logs, regenerate with `ontos agents`.
```

---

## Appendix B: .cursorrules Transform Rules

| AGENTS.md Section | .cursorrules Treatment |
|-------------------|------------------------|
| Title (`# AGENTS.md`) | Replace with `# Ontos Protocol for Cursor` |
| Project declaration | Keep as-is |
| Generation metadata | Keep as-is |
| `## Ontos Activation` | Rename to `## Activation` and keep numbered steps. Prepend: `When the user says "Ontos" or "Activate Ontos":` |
| `## Session End` | Keep section and steps. Prepend: `When ending a session:` |
| `## Quick Reference` | Keep table as-is (Markdown) |
| `## Project Stats` | Keep bullet list as-is |
| `## Core Invariants` | Keep as-is |
| `## Staleness` | Keep as-is |
| Any other section | Remove |

Additional rules:
- Ensure all commands use v3.0 CLI (`ontos map`, `ontos agents`, etc.); no v2.x script paths.
- Output filename for cursor format is always `.cursorrules` at repo root.
- Preserve ASCII-only content.

---

**Document signed by:**
- **Role:** Chief Architect
- **Model:** Codex
- **Date:** 2026-01-17
