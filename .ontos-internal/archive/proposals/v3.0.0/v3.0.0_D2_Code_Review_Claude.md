# D.2: Alignment Code Review (Codex)

PR: https://github.com/ohjona/Project-Ontos/pull/47
Branch: v3.0.0
Spec: `v3.0.0-Implementation-Specs-v1.1.md`

---

## Part 1: Spec Compliance — Feature by Feature

### Feature 1: ontos agents

| Requirement ID | Requirement | Implemented? | Correctly? | Evidence |
|----------------|-------------|--------------|------------|----------|
| FR1 | `ontos agents` CLI with default AGENTS.md | YES | YES | `ontos/cli.py:130`, `ontos/commands/agents.py:262` |
| FR2 | `--format=cursor` outputs .cursorrules | YES | YES | `ontos/cli.py:135`, `ontos/commands/agents.py:292` |
| FR3 | `--all` outputs both files | YES | YES | `ontos/cli.py:137`, `ontos/commands/agents.py:260` |
| FR4 | Template includes top-5 commands | YES | YES | `ontos/commands/agents.py:46` |
| FR5 | Stats: doc count, last updated | YES | NO | `ontos/commands/agents.py:117-152` (docs dir default + log mtime) |
| FR6 | Staleness warning in template | YES | YES | `ontos/commands/agents.py:63-65` |
| FR7 | Single-source (AGENTS canonical) | YES | NO | `ontos/commands/agents.py:285`, `ontos/commands/agents.py:306` (regenerates, timestamps can diverge) |
| FR8 | `export` renamed/aliased to `agents` | YES | YES | `ontos/cli.py:340` |
| FR9 | .cursorrules uses v3.0 commands only | YES | YES | `ontos/commands/agents.py:41-55`, `ontos/commands/agents.py:180-218` |
| FR10 | Generation metadata (version + timestamp) | YES | YES | `ontos/commands/agents.py:33`, `ontos/commands/agents.py:165-176` |
| FR11 | `--force` creates .bak backup | YES | YES | `ontos/commands/agents.py:281-304` |

**Template Compliance (Appendix A):**

| Template Element | Spec Says | Code Does | Match? |
|------------------|-----------|-----------|--------|
| Title | `# AGENTS.md` | `# AGENTS.md` | YES |
| Project declaration | "This project uses **Ontos**..." | Same string | YES |
| Generation metadata format | `Generated by Ontos v{version} on {timestamp}` | Same format | YES |
| Activation steps (5 steps) | As specified | Same steps | YES |
| Session End steps (2 steps) | As specified | Same steps | YES |
| Quick Reference table (5 commands) | map, agents, doctor, log, query | Same table | YES |
| Stats format | `Doc Count: {n}`, `Last Updated: {timestamp}` | Same format | YES |
| Core Invariants (3 items) | As specified | Same items | YES |
| Staleness section | As specified | Same text | YES |

**.cursorrules Transform Compliance (Appendix B):**

| Transform Rule | Implemented? | Correctly? |
|----------------|--------------|------------|
| Title becomes "# Ontos Protocol for Cursor" | YES | YES (`ontos/commands/agents.py:194-196`) |
| Activation prepends trigger phrase | YES | YES (`ontos/commands/agents.py:203-208`) |
| Session End prepends trigger phrase | YES | YES (`ontos/commands/agents.py:210-214`) |
| Backticks preserved | YES | YES (no stripping in transform) |
| No v2.x script paths | YES | YES (template uses `ontos` CLI) |

---

### Feature 2: PyPI Publishing

| Requirement ID | Requirement | Implemented? | Correctly? | Evidence |
|----------------|-------------|--------------|------------|----------|
| FR1 | Triggers on `v*` tags | YES | YES | `.github/workflows/publish.yml:11-15` |
| FR2 | TestPyPI before PyPI | YES | YES | `.github/workflows/publish.yml:59-108` |
| FR3 | Trusted publisher (OIDC) | YES | YES | `.github/workflows/publish.yml:17-20` |
| FR5 | README git+ fallback | NO | NO | `README.md` (missing command) |
| FR6 | TestPyPI install verification | YES | YES | `.github/workflows/publish.yml:69-97` |
| FR7 | Tests pass before publish | YES | YES | `.github/workflows/publish.yml:22-57` |

---

### Feature 3: Init Exit Code

| Requirement ID | Requirement | Implemented? | Correctly? | Evidence |
|----------------|-------------|--------------|------------|----------|
| FR1 | Return 0 if already initialized | YES | YES | `ontos/commands/init.py:27-34` |
| FR2 | Same message text preserved | YES | YES | `ontos/commands/init.py:32` |

---

### Feature 4: Init Auto-Generation

| Requirement ID | Requirement | Implemented? | Correctly? | Evidence |
|----------------|-------------|--------------|------------|----------|
| FR1 | Init generates AGENTS.md | YES | YES | `ontos/commands/init.py:67-68`, `ontos/commands/init.py:137-160` |
| FR2 | Init succeeds if agents fails | YES | YES | `ontos/commands/init.py:137-162` |
| FR3 | Warning on agents failure | YES | YES | `ontos/commands/init.py:160-162` |
| FR5 | Success message says `ontos agents` | YES | YES | `ontos/commands/init.py:72-73` |

---

### Feature 5: Doctor Staleness

| Requirement ID | Requirement | Implemented? | Correctly? | Evidence |
|----------------|-------------|--------------|------------|----------|
| FR1 | Staleness check in doctor | YES | YES | `ontos/commands/doctor.py:369-466` |
| FR2 | Compares to context map, archives, config | YES | PARTIAL | `ontos/commands/doctor.py:388-415` (no repo-root helper; logs fallback differs) |
| FR3 | Warning only, no auto-fix | YES | YES | `ontos/commands/doctor.py:417-430` |
| FR4 | Specific warning message | YES | YES | `ontos/commands/doctor.py:426-431` |

---

### Feature 6: Data Cleanup

| Requirement ID | Requirement | Implemented? | Correctly? | Evidence |
|----------------|-------------|--------------|------------|----------|
| FR1 | Stale `depends_on` fixed | NO | NO | `Phase3/Phase3-Implementation-Spec.md:5` depends on missing `phase2_implementation_spec` |
| FR2 | `ontos map --strict` exits 0 | NO | NO | Missing `phase2_implementation_spec` ID in repo (no `id: phase2_implementation_spec`) |

---

## Part 2: Architecture Compliance

**File Structure:**

| Spec Says | Actual | Match? |
|-----------|--------|--------|
| `ontos/commands/agents.py` CREATE | Present | YES |
| `ontos/cli.py` MODIFY | Modified | YES |
| `ontos/commands/export.py` MODIFY | Still generates `CLAUDE.md` | NO |
| `ontos/_templates/agents_template.md` CREATE | Missing | NO |
| `tests/commands/test_agents.py` CREATE | Present | YES |
| `.github/workflows/publish.yml` CREATE | Present | YES |

**Code Pattern Compliance:**

| Pattern | Spec Reference | Followed? | Notes |
|---------|----------------|-----------|-------|
| AgentsOptions dataclass | §4.3.1 | YES | `ontos/commands/agents.py:18-25` |
| `agents_command()` returns `(int, str)` | §4.3.1 | YES | `ontos/commands/agents.py:242-319` |
| Repo root resolution hierarchy | §4.3.1 | YES | `ontos/commands/agents.py:71-101` |
| Stats cap at 5000 files | §4.3.1 | YES | `ontos/commands/agents.py:135-139` |
| CheckResult pattern for doctor | Existing pattern | YES | `ontos/commands/doctor.py` |

---

## Part 3: Consistency Check

| Aspect | Consistent with Codebase? | Notes |
|--------|---------------------------|-------|
| CLI registration pattern | YES | Matches existing argparse structure. |
| Command return signature | YES | `(exit_code, message)` preserved. |
| Error message style | YES | Consistent with existing commands. |
| Test organization | YES | New tests under `tests/commands/`. |
| Docstring format | YES | Matches existing command modules. |

---

## Part 4: Backward Compatibility

| Change | Breaking? | Spec Addresses? | Notes |
|--------|-----------|-----------------|-------|
| `export` → `agents` rename | Potentially | YES (alias) | CLI alias implemented. |
| CLAUDE.md no longer generated | Potentially | YES (rename decision) | `ontos export` now produces AGENTS.md. |
| Init now generates AGENTS.md | NO | YES | Additive. |
| Doctor has new check | NO | YES | Warn-only. |

**Unauthorized breaking changes:**

| Change | Impact | Severity |
|--------|--------|----------|
| None | - | - |

---

## Part 5: Deviations Found

**Deviations from Spec:**

| # | Deviation | Spec Says | Code Does | Severity |
|---|-----------|-----------|-----------|----------|
| A-D1 | Docs dir default for stats | Default to `docs/` when no config | Defaults to `.ontos-internal` | Minor |
| A-D2 | `last_updated` uses max mtime | Use max mtime across context map, logs, config | Uses first log file only | Minor |
| A-D3 | Single-source output | .cursorrules derived from AGENTS content | Regenerates content for cursor output, timestamps can diverge | Minor |
| A-D4 | Doctor repo-root helper | Use shared repo-root resolution | Uses `Path.cwd()` only | Major |
| A-D5 | Template file location | Use `ontos/_templates/agents_template.md` | Template embedded in code | Major |

**Unauthorized Additions:**

| # | Addition | Not in Spec | Concern |
|---|----------|-------------|---------|
| A-A1 | None | - | - |

**Missing Implementations:**

| # | Missing | Spec Requirement | Impact |
|---|---------|------------------|--------|
| A-M1 | Data cleanup for stale `depends_on` | Data cleanup FR1/FR2 | Broken validation remains; `phase2_implementation_spec` missing. |
| A-M2 | Golden test baselines for AGENTS/.cursorrules | Agents §6.3 + §9 | Success criterion not verifiable. |
| A-M3 | README git+ fallback install | PyPI FR5 | Install fallback not documented. |
| A-M4 | Update agent instructions doc | Agents §8 | Docs still reference v2.8 commands. |
| A-M5 | Doctor staleness tests | Doctor §6.1 | Coverage gap for new check. |

---

## Part 6: Issues Found

**Critical (Alignment):**

| # | Issue | Type | Why Critical |
|---|-------|------|--------------|
| A-C1 | Data cleanup not completed (stale depends_on still present) | Missing | Spec requires clean validation; missing `phase2_implementation_spec` breaks graph. |
| A-C2 | Golden test baselines for AGENTS/.cursorrules missing | Missing | Success criteria require golden validation of output. |

**Major (Alignment):**

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-M1 | Doctor staleness check does not use shared repo-root helper | Spec/Arch | Reuse agents repo-root helper for consistent root resolution. |
| A-M2 | Agents template file missing from `ontos/_templates/` | Spec/Arch | Move template into `ontos/_templates/agents_template.md` and load it. |
| A-M3 | README missing git+ fallback | Spec | Add fallback install command to README. |
| A-M4 | `docs/reference/Ontos_Agent_Instructions.md` not updated | Spec | Update activation instructions to reflect `ontos agents`/AGENTS.md. |
| A-M5 | Doctor staleness tests missing | Spec | Add tests for missing/stale/fresh AGENTS.md. |

---

## Part 7: Verdict

**Spec Compliance:** Major Deviations
**Architecture Compliance:** Major Deviations
**Consistency:** Consistent
**Backward Compatibility:** Maintained

**Recommendation:** Request revision

**Blocking Issues:** 2

**Summary:**
Core command behavior is in place, but the PR misses required data cleanup and golden baselines, and it diverges from the approved architecture in template placement and repo-root resolution for doctor. Documentation updates (README fallback + agent instructions) are also missing. Addressing these brings the implementation into full alignment with spec v1.1.
