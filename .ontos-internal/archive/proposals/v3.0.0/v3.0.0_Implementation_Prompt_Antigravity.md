# v3.0.0 Implementation Prompt (Phase C.1)

**Role:** Implementer (Antigravity/Codex)
**Date:** 2026-01-17
**Primary Spec:** `v3.0.0-Implementation-Specs-v1.1.md`
**Status:** Ready for Implementation

---

## 0. Scope and Authority

Implement v3.0.0 per the spec v1.1. Do not expand scope beyond the spec. Prioritize correctness, deterministic output, and alignment with `v3.0.0_Cofounder_Response.md`.

---

## 1. Required Inputs (Read First)

1. `v3.0.0-Implementation-Specs-v1.1.md`
2. `v3.0.0_Cofounder_Response.md`

---

## 2. Implementation Tasks

### 2.1 New `ontos agents` Command (Rename from `export`)

- Add `ontos/commands/agents.py` and register `agents` in `ontos/cli.py`.
- Rename `export` to `agents` in CLI. Keep `export` as a deprecated alias that prints a warning to stderr and delegates to `agents`.
- Default output: `AGENTS.md` at repo root.
- Flags:
  - `--format=cursor` outputs `.cursorrules` only (repo root).
  - `--all` outputs both.
  - `--output` applies to AGENTS only.
- Implement repo-root resolution:
  1) Find `.ontos.toml` in current/parent dirs.
  2) Else use `git rev-parse --show-toplevel` if available.
  3) Else fallback to current `find_repo_root()` walk.
- Stats gathering:
  - `doc_count`: count `*.md` under docs dir (config if available, else `docs/`), cap at 5000 (`5000+`).
  - `last_updated`: max mtime among context map, logs dir, and `.ontos.toml`.
  - Format `last_updated` as `YYYY-MM-DD HH:MM:SS UTC`.
- Generation metadata in AGENTS: `Generated by Ontos v{ontos_version} on {generated_at}`.
- On `--force`, create `.bak` backup before overwrite.
- Create parent dirs for `--output`.
- Path safety: output must be within repo root.
- Template injection mitigation: only numeric/timestamp placeholders; no user-controlled strings interpolated into template.

### 2.2 `.cursorrules` Transform Rules

Implement the mapping in Appendix B (below). Preserve backticks in `.cursorrules` output.

### 2.3 Init Auto-Generation

- In `ontos/commands/init.py`, invoke agents generation after hooks install and before final message.
- Failure of agents generation must not fail init (warn only).
- Update init success tip to reference `ontos agents` (not `ontos export`).

### 2.4 Init Exit Code Change

- When `.ontos.toml` exists and `--force` not set, return `(0, "Already initialized...")`.

### 2.5 Doctor Staleness Check

- Add `check_agents_staleness()` using the same repo-root helper as `agents`.
- Compare AGENTS.md mtime against context map, logs dir, config.
- If a source file is missing: skip and log (verbose only). If all sources missing: warn `Cannot determine AGENTS.md staleness - no source files found`.
- Warning message: `AGENTS.md may be stale. Run 'ontos agents' to regenerate.`

### 2.6 PyPI Publishing Workflow

- Create `.github/workflows/publish.yml`.
- Trigger on `v*` tags.
- Run tests (in workflow or gate on CI via workflow_run).
- Build sdist/wheel.
- Publish to TestPyPI first.
- Verify install from TestPyPI: `pip install --index-url https://test.pypi.org/simple/ --no-deps ontos` and run `ontos --version`.
- Publish to PyPI via trusted publisher only if verification succeeds.

### 2.7 Data Cleanup (Prerequisite)

- Fix stale `depends_on` references in `.ontos-internal/strategy/v3.0/Phase2/Phase3/Phase4` per `ontos map --strict`.
- Verify with both `ontos map --strict` and `ontos doctor` validation clean.

---

## 3. Tests to Add/Update

- `tests/commands/test_agents.py`:
  - default creates AGENTS.md
  - `--format=cursor` creates `.cursorrules`
  - `--all` creates both
  - `--force` overwrites and creates `.bak`
  - path safety
  - export alias warning
- Update/init tests for exit code change.
- Add/update golden baselines for AGENTS.md and `.cursorrules`.

---

## 4. Acceptance Criteria (Must Pass)

- `ontos agents` produces AGENTS.md and `.cursorrules` per spec.
- Golden tests for AGENTS.md (and `.cursorrules` if implemented) pass.
- `ontos init` auto-generates AGENTS.md and exits 0 on already-initialized.
- `ontos doctor` warns on stale AGENTS.md and handles missing sources gracefully.
- Publish workflow gates on tests + TestPyPI verification.
- `.cursorrules` uses v3.0 CLI commands (no v2.x script paths).

---

## Appendix A: Complete AGENTS.md Template

```markdown
# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{ontos_version} on {generated_at}

## Ontos Activation
1. Run `ontos map` to regenerate the context map.
2. Read `Ontos_Context_Map.md` to understand the documentation graph.
3. Load only the relevant documents for the task.
4. Follow `depends_on` upward as needed.
5. Confirm: "Loaded: [ids]".

## Session End
1. Run `ontos log -e "slug"` to archive session work.
2. Fill in Goal, Key Decisions, Alternatives Considered, and Impacts.

## Quick Reference
| Command | Purpose |
|---------|---------|
| `ontos map` | Regenerate context map |
| `ontos agents` | Generate instruction files |
| `ontos doctor` | Health check and validation |
| `ontos log -e "slug"` | Archive session work |
| `ontos query <id>` | Find document by ID |

## Project Stats
- Doc Count: {doc_count}
- Last Updated: {last_updated}

## Core Invariants
- Do not edit `Ontos_Context_Map.md` manually; regenerate with `ontos map`.
- Do not edit `AGENTS.md` manually; regenerate with `ontos agents`.
- If a command fails, read the error message and avoid guessing fixes.

## Staleness
If `AGENTS.md` is older than the context map or logs, regenerate with `ontos agents`.
```

---

## Appendix B: .cursorrules Transform Rules

| AGENTS.md Section | .cursorrules Treatment |
|-------------------|------------------------|
| Title (`# AGENTS.md`) | Replace with `# Ontos Protocol for Cursor` |
| Project declaration | Keep as-is |
| Generation metadata | Keep as-is |
| `## Ontos Activation` | Rename to `## Activation` and keep numbered steps. Prepend: `When the user says "Ontos" or "Activate Ontos":` |
| `## Session End` | Keep section and steps. Prepend: `When ending a session:` |
| `## Quick Reference` | Keep table as-is (Markdown) |
| `## Project Stats` | Keep bullet list as-is |
| `## Core Invariants` | Keep as-is |
| `## Staleness` | Keep as-is |
| Any other section | Remove |

Additional rules:
- Ensure all commands use v3.0 CLI (`ontos map`, `ontos agents`, etc.); no v2.x script paths.
- Output filename for cursor format is always `.cursorrules` at repo root.
- Preserve ASCII-only content.
- Preserve backticks around commands (e.g., `ontos map`) in .cursorrules output.
