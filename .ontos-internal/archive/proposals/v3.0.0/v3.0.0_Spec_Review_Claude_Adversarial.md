# v3.0.0 Spec Review: Adversarial Analysis

**Reviewer:** Claude Opus 4.5 (Adversarial Reviewer)
**Date:** 2026-01-17
**Status:** COMPLETE

---

## Part 1: Assumption Attack

The spec makes assumptions. I challenge them.

| Assumption in Spec | Location | Why It Might Be Wrong | Impact If Wrong |
|--------------------|----------|----------------------|-----------------|
| `find_repo_root()` works reliably | agents §4.3.1 | Current implementation in `export.py` walks up from `cwd()` looking for `.ontos.toml` or `.git`. In a monorepo or when running from a subdirectory 10 levels deep, this could be slow. More critically: what if there's a `.git` in a parent directory that isn't the project root (nested repos)? | Wrong repo root = AGENTS.md written to wrong location, potentially exposing project structure to wrong repo |
| mtime comparison is sufficient for staleness | doctor §4.3.1 | File system mtime is unreliable: (1) `git checkout` preserves original mtime on some systems, (2) `touch` can set arbitrary mtimes, (3) clock skew between machines in CI, (4) WSL/Windows filesystem quirks, (5) network filesystems (NFS, SMB) have mtime resolution issues | False positives/negatives on staleness. User trusts "fresh" AGENTS.md that's actually stale |
| Stats gathering won't be slow | agents §4.3.2 | Spec says count `*.md` files and find max mtime in logs dir. With 1000+ log files (active project over 2 years) or a docs directory with thousands of generated markdown files, `rglob("*.md")` becomes expensive | `ontos agents` becomes slow, breaks "instant" UX promise. In CI, adds latency to every init |
| AGENTS.md at repo root is always correct | agents §4.3.1 | Some projects have multiple packages (monorepo), use non-standard project roots, or have AGENTS.md conflicts with existing files. What about repos where root is read-only (some CI environments)? | Can't write AGENTS.md where expected; confusing error or silent failure |
| Trusted publisher setup will succeed | PyPI §4.3.1 | PyPI trusted publisher requires: (1) exact repo name match, (2) correct workflow filename, (3) GitHub environment configuration, (4) OIDC provider availability. First-time setup is notoriously finicky | Release blocked at worst time (when you think you're ready). Manual token fallback not specified |
| `--force` is sufficient for overwrites | agents §4.5 | User may have customized AGENTS.md with project-specific instructions. `--force` destroys without merge or backup. No diff preview. | User loses customizations silently. Erodes trust in tooling |
| Config path fallback (`docs/` if no .ontos.toml) | agents §4.3.2, doctor §4.3.1 | Different commands use different fallbacks. Doctor uses hardcoded `docs/`, agents spec says "from config or `docs/`". What if they disagree? | Inconsistent behavior between commands; staleness check looks at wrong directory |
| Subprocess call to agents from init will work | init auto-gen §4.3.1 | Spec says "prefer direct function call to agents command to avoid env issues" but doesn't specify what happens if agents module import fails (circular import, missing dependency) | `ontos init` fails unexpectedly; user gets cryptic ImportError |

---

## Part 2: Edge Case Analysis

| Scenario | Spec Handles? | If Not, What Happens? |
|----------|---------------|----------------------|
| **agents command** | | |
| Repo has no docs directory | Partial (NFR2 says "best-effort defaults") | Spec unclear: does it create empty stats? Error? The existing `export.py` doesn't check for docs dir at all |
| `.ontos.toml` doesn't exist | Partial (NFR2) | Says "work without .ontos.toml" but doesn't specify how stats are gathered without config paths |
| AGENTS.md is open in editor (locked on Windows) | NO | Windows file locking will cause `write_text()` to fail with `PermissionError`. No retry logic specified |
| Output path is symlink outside repo | YES (§4.5) | Path safety uses `resolve()` + `relative_to()`. Symlinks get resolved. Good. |
| Repo is in a submodule | PARTIAL | `find_repo_root()` will find the submodule's `.git` file, not the parent. Might work, might not |
| Very large repo (10k+ files in docs) | NO | No pagination, no early termination. `rglob("*.md")` loads all paths into memory |
| Template has unicode characters (non-ASCII) | PARTIAL | Constraint says "ASCII-only content" but what validates this? |
| User runs `ontos agents` before `ontos init` | NO | No spec for this case. Will `find_repo_root()` fail gracefully? |
| **init auto-gen** | | |
| `agents_command` import fails | PARTIAL | §4.5 says "continue, warn only" but import failure happens before try/catch |
| Disk full during AGENTS.md write | NO | Standard Python exception. No graceful handling specified |
| Init in a directory with no write permission | NO | Will fail at config creation, before agents |
| **doctor staleness** | | |
| AGENTS.md has future mtime (clock skew) | NO | Spec only checks "AGENTS older than sources". Future mtime = always "fresh" |
| Logs directory has 1000s of files | PARTIAL | §11 risk says "early exit on max" but §4.3.1 just says "newest file in logs directory" with no algorithm |
| Context map doesn't exist yet | PARTIAL | §4.5 says "skip that source" but should this be a separate warning? |
| AGENTS.md is a directory (malicious or accident) | NO | `mtime` comparison will fail; what error does user see? |
| **PyPI publishing** | | |
| Tag pushed but tests fail | NO | Workflow triggers on tag push. If tests fail in CI, does publish still run? Need to depend on CI workflow |
| TestPyPI is down | NO | Spec says "stop workflow" but no retry or fallback logic |
| Version in pyproject.toml doesn't match tag | NO | This is a common mistake. Should validate v-prefix stripping matches version |
| Package already exists on TestPyPI (from previous attempt) | NO | TestPyPI doesn't allow re-upload of same version. Workflow will fail |
| **data cleanup** | | |
| Cleanup breaks something that was working | PARTIAL | §4.3.1 says "verify each removal" but no automated validation |
| Removal introduces new broken links | NO | Removing A might break B->A dependency. Iterative process not fully specified |

---

## Part 3: Failure Mode Analysis

| Failure | How It Happens | Detection | Recovery |
|---------|----------------|-----------|----------|
| AGENTS.md generation produces invalid markdown | Template has unescaped special chars, stats contain markdown syntax | LLM parsing fails silently | Regenerate with `ontos agents --force` |
| PyPI publish succeeds but package is broken | Missing `__init__.py`, wrong entry points, dependency not declared | User `pip install` fails or import fails | Yank release, fix, republish (requires PyPI access) |
| Doctor false positive (claims stale when not) | Clock skew, filesystem quirks, git operations that touch mtime | User runs unnecessary `ontos agents` | Annoying but not harmful |
| Doctor false negative (misses actual staleness) | File modified without mtime change (rare), content-identical regeneration | User trusts stale AGENTS.md | LLM gets outdated instructions |
| Init succeeds but AGENTS.md is malformed | agents template has syntax error, stats gathering returns garbage | Manual inspection required | Delete and regenerate |
| Circular import when init calls agents | agents imports something that imports init | `ImportError` at runtime | Hard to diagnose; need stack trace |
| Race condition: two processes run `ontos agents` simultaneously | CI parallelism, user runs in multiple terminals | File corruption or partial write | One AGENTS.md wins, other is lost |
| Template placeholder not substituted | Bug in format string, KeyError swallowed | `{doc_count}` literal appears in output | Fix template code |

---

## Part 4: Implementation Feasibility

| Sub-Spec | Can Be Implemented As Written? | Ambiguities / Blockers |
|----------|-------------------------------|------------------------|
| agents command | **Partial** | Template content not fully specified (§5.2 is "example excerpt"). What exactly goes in Quick Reference? What's the full activation protocol text? Implementer will have to guess or ask. |
| PyPI publishing | **Yes** | Clear enough. Standard GHA pattern. Only ambiguity: should it depend on CI passing? |
| Init exit code | **Yes** | One-line change. Completely clear. |
| Init auto-gen | **Partial** | "Call `agents_command()` after hooks installation" - but where exactly? Before or after legacy warning? What if hooks_status is 3 (skipped)? Does agents still run? |
| Doctor staleness | **Partial** | "max mtime among sources" - but which sources exactly? Spec says "Context_Map.md, session archives, config changes" but not the full list. What about docs changes? |
| Data cleanup | **No (Manual)** | This is a manual process. "Run map strict, fix errors, repeat." Not automatable without knowing the specific broken references. |

**Where would I get stuck implementing this tomorrow?**

1. **AGENTS.md template content**: The spec provides an "excerpt" but not the full template. I'd need to write 50+ lines of template content with proper escaping and placeholder handling.

2. **Single-source transform to .cursorrules**: The spec says "simple mapping" but doesn't define the mapping rules. Is it just removing markdown headers? What stays, what goes?

3. **Stats `last_updated` format**: Is it ISO 8601? Human-readable? Timezone-aware? The example shows `2026-01-16 19:33:42 UTC` but that's not a standard format.

4. **Error messages for LLMs**: The spec focuses on human-readable errors. What should an LLM see? JSON? Structured output?

---

## Part 5: Security Review

| Attack Vector | Applicable? | Mitigation in Spec? | Notes |
|---------------|-------------|---------------------|-------|
| Path traversal via --output | **Yes** | **YES** (§4.5) | Uses `resolve()` + `relative_to()`. Correctly implemented in existing `export.py` |
| Arbitrary file overwrite | **Yes** | **Partial** | `--force` required for overwrite. But no backup created. User could lose data |
| PyPI token exposure | **Yes** | **YES** | Trusted publisher uses OIDC, no stored tokens. Good. |
| Template injection | **Yes** | **NO** | If stats contain user-controlled content (e.g., doc filename with `{`), could break template. Needs escaping |
| Symlink following | **Yes** | **YES** | `resolve()` follows symlinks, then validates against repo root. Safe |
| World-writable AGENTS.md | **No** | N/A | Uses default umask. Low risk |
| Command injection in hook | **No** | N/A | Hooks are Python scripts, not shell. Safe |

---

## Part 6: Blind Spot Identification

**What's the Chief Architect not seeing?**

### Where is the spec overconfident?

| Area | Why It's Probably Harder Than It Looks |
|------|---------------------------------------|
| Template content | Writing good LLM instructions is an art. The spec assumes a template "just works" but activation protocols need testing with multiple LLMs. What if Claude interprets it differently than Cursor's AI? |
| Single-source generation | Transforming AGENTS.md to .cursorrules sounds simple but format requirements differ. Cursor may have length limits, forbidden characters, or expect specific sections. Without Cursor docs, this is guesswork |
| "Zero-friction activation" | The spec promises `pip install && ontos init` works. But pip install can fail (permissions, network), init can fail (not git repo), agents can fail (no docs). Each step has failure modes that compound |

### What seems too simple?

| Element | Suspiciously Simple Because... |
|---------|------------------------------|
| "One-line change" for exit code | What about tests? The test `test_init_already_initialized` probably asserts exit code 1. That test must change too |
| Stats gathering | "Count *.md files" hides complexity: exclude archives? Include generated files? What about .md files with no frontmatter? |
| "Warning only" for staleness | What if AGENTS.md is critically stale and the project has changed architecture? A warning feels insufficient. But auto-fix could be worse. The UX is actually hard |

### What's conspicuously absent?

| Missing Element | Why It Might Matter |
|-----------------|---------------------|
| Rollback plan | What if v3.0.0 release has a critical bug? No mention of yanking, patching, or communication plan |
| Telemetry / analytics | How will you know if `ontos agents` is being used? If staleness warnings are ignored? |
| Versioning in AGENTS.md | AGENTS.md should declare which Ontos version generated it. Helps debugging "why does my AGENTS.md look different?" |
| Cursor-specific testing | The spec mentions `.cursorrules` but no acceptance criteria for Cursor users. How do you verify it works in Cursor? |
| CI integration testing | Workflow exists but no test that runs the workflow in a fork/sandbox before merging |
| Windows testing | Spec acknowledges Windows risk but doesn't specify any Windows CI or testing requirement |
| Deprecation timeline for `export` | Q1 asks about keeping `export` alias but no deprecation plan. When does it go away? |

---

## Part 7: LLM Perspective

I am an LLM. Evaluating whether I could follow these specs as an implementing developer.

**Ambiguous instructions that would make me guess:**

1. **"Fill AGENTS template placeholders"** (§4.3.1) - What placeholders? The template isn't defined. I'd have to invent `{project_name}`, `{doc_count}`, etc.

2. **"Transform AGENTS content to cursor-specific format"** (§4.3.2) - No transformation rules provided. Is it substring? Regex? Markdown-to-plaintext?

3. **"Resolve source files... from config if available, else fallback"** (doctor §4.3.1) - Which config keys? `config.paths.logs_dir`? `config.paths.context_map`? Are these guaranteed to exist?

**Missing context that would make me ask clarifying questions:**

1. **What's the full AGENTS.md template?** The spec gives an excerpt. I need the complete template to implement this.

2. **How should `--all` behave with `--output`?** If user specifies `--output /custom/path`, does that apply to AGENTS.md only? Both files? The spec says `--output` is "ignored for .cursorrules unless a separate flag is added later" which is confusing.

3. **What happens if `ontos map` hasn't been run yet?** During init, agents runs after context map generation. But if user runs `ontos agents` standalone before `ontos map`, is that an error? A warning? Does it generate without stats?

**Instructions that are technically correct but practically unhelpful:**

1. **"Keep `.cursorrules` section minimal and tested"** (§11 Risks) - What does "minimal" mean? 10 lines? 100 lines? Without examples, I'd guess wrong.

2. **"Validate output is inside repo root"** (§4.3.1) - Already implemented in `export.py`. The spec should say "reuse existing path safety from export.py" instead of describing the algorithm.

3. **"Use ASCII-only content"** (Constraint) - For template, yes. But what about user's project name if it contains unicode? Does that appear in AGENTS.md?

---

## Part 8: Issues Found

### Critical (Blocks Implementation)

| # | Issue | Attack Vector / Failure Mode | Impact |
|---|-------|------------------------------|--------|
| X-C1 | **AGENTS.md template not defined** | Implementer must guess content | Inconsistent output, poor LLM activation, requires revision |
| X-C2 | **.cursorrules transform rules not specified** | No mapping from AGENTS format to Cursor format | Cannot implement `--format=cursor` without guessing |

### High (Should Fix)

| # | Issue | Attack Vector / Failure Mode | Impact |
|---|-------|------------------------------|--------|
| X-H1 | **No version stamp in AGENTS.md** | User can't tell which Ontos version generated their file | Debugging difficult; users may report bugs from old versions |
| X-H2 | **PyPI workflow doesn't depend on CI passing** | Tag push triggers publish even if tests fail | Broken package published to PyPI |
| X-H3 | **Template injection via stats** | Doc filename containing `{` or `}` | Template rendering error or injection |
| X-H4 | **Windows file locking not handled** | AGENTS.md open in editor | `PermissionError` with no guidance |
| X-H5 | **No backup before `--force` overwrite** | User loses custom AGENTS.md content | Data loss, erodes trust |
| X-H6 | **Staleness check doesn't handle missing sources gracefully** | Context map not generated yet | Confusing warning or false negative |

### Medium (Consider)

| # | Issue | Attack Vector / Failure Mode | Impact |
|---|-------|------------------------------|--------|
| X-M1 | **Stats gathering unbounded** | 10k+ files in docs directory | Slow `ontos agents`, breaks UX promise |
| X-M2 | **No test for `export` alias deprecation warning** | Alias behavior untested | May silently break or never warn |
| X-M3 | **Clock skew causes false staleness** | CI machines with different system clocks | Unnecessary regeneration warnings |
| X-M4 | **TestPyPI version collision** | Same version already uploaded from failed attempt | Workflow fails, manual intervention needed |
| X-M5 | **`last_updated` format unspecified** | Inconsistent datetime formatting | Display issues in AGENTS.md |

---

## Part 9: Verdict

**Spec Robustness:** **Adequate** (with reservations)

**Recommendation:** **Request Changes** (2 critical, 6 high issues)

**Top 3 Concerns:**

1. **Missing template definition** - The agents command cannot be implemented without the full AGENTS.md template. This is blocking.

2. **Missing transform rules for .cursorrules** - "Single-source generation" is the right architecture but the spec doesn't define the transformation. Implementer will guess wrong.

3. **No safety net for PyPI publishing** - The workflow should depend on CI tests passing. Publishing a broken package to PyPI is high-visibility failure that damages project credibility.

**Uncomfortable Questions:**

1. **Have you actually tested the AGENTS.md content with multiple LLMs?** The spec assumes the template "works" for LLM activation, but LLMs are notoriously sensitive to instruction phrasing. A template that works for Claude may confuse Cursor's AI or Gemini.

2. **What's your fallback if PyPI trusted publisher fails?** First-time OIDC setup is finicky. If it doesn't work on release day, can you publish with an API token? Is that documented?

3. **Why no Windows CI?** The spec acknowledges Windows as an accepted risk but Cursor has significant Windows user base. If `.cursorrules` generation fails on Windows, you've broken P0 functionality for a major platform.

---

## Appendix: Specific Code Concerns

### In `export.py` (basis for agents)

```python
def find_repo_root() -> Path:
    current = Path.cwd()
    for parent in [current] + list(current.parents):
        if (parent / ".ontos.toml").exists():
            return parent
        if (parent / ".git").exists():
            return parent
    return current  # <-- Fallback returns cwd even if not a repo!
```

**Issue:** If user runs `ontos agents` in `/tmp`, this returns `/tmp` and writes AGENTS.md there. Should probably error instead of silently writing to arbitrary directory.

### In `init.py` (where agents will be called)

```python
# Line 70: current tip message
msg += "Tip: Run 'ontos export' for AI assistant integration"
```

**Issue:** This will become stale after rename. The spec mentions updating docs but not this hardcoded string.

### In `doctor.py` (staleness check will be added here)

```python
def check_context_map() -> CheckResult:
    # ...
    context_map = Path.cwd() / config.paths.context_map
```

**Issue:** Uses `Path.cwd()` not `find_repo_root()`. Inconsistent with how `export.py` finds files. Staleness check must use same root-finding logic or comparisons will be wrong.

---

**Document signed by:**
- **Role:** Adversarial Reviewer
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-17
- **Status:** Review Complete - Changes Requested
