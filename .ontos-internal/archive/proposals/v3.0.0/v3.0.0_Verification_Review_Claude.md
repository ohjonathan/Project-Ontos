# v3.0.0 Verification Review: Adversarial Reviewer

**Reviewer:** Claude Opus 4.5 (Adversarial Reviewer - Verification)
**Date:** 2026-01-17
**Status:** COMPLETE

---

## B1: AGENTS.md Template (MY CRITICAL ISSUE)

**I said:**
> "The agents command cannot be implemented without the full AGENTS.md template. This is blocking."

**CA provided:** Full template in Appendix A (lines 206-244)

### Verification Checklist

| Check | Pass? | Notes |
|-------|-------|-------|
| Template is complete (not an excerpt) | ✅ | Full template with all sections: Activation, Session End, Quick Reference, Stats, Core Invariants, Staleness |
| All placeholders defined | ✅ | Four placeholders: `{ontos_version}`, `{generated_at}`, `{doc_count}`, `{last_updated}` |
| Placeholder types are safe (no injection risk) | ✅ | All are numeric or timestamp values per M7 response (§2 M7: "Restrict template placeholders to numeric/timestamp values") |
| Implementer can build this without guessing | ✅ | Template is copy-paste implementable. Clear sections, clear placeholders |
| Escape handling specified (or not needed) | ✅ | Not needed - placeholders are numeric/timestamp only. No user-controlled strings |

**Additional Observations:**
- The "Core Invariants" section was added based on Gemini's feedback - good addition
- The template includes explicit "Confirm: Loaded [ids]" which helps LLM compliance verification
- Session End is properly structured with numbered steps

**B1 Resolution:** **RESOLVED**

---

## B2: .cursorrules Transform Rules (MY CRITICAL ISSUE)

**I said:**
> "Cannot implement `--format=cursor` without guessing"

**CA provided:** Transform rules in Appendix B (lines 248-266)

### Verification Checklist

| Check | Pass? | Notes |
|-------|-------|-------|
| Every section has explicit treatment | ✅ | All 9 sections have explicit Keep/Remove/Transform rules |
| Transform logic is unambiguous | ✅ | "Replace with", "Keep as-is", "Rename to", "Prepend" are all clear directives |
| "Prepend" instructions are clear | ✅ | Two prepends specified with exact text: "When the user says..." and "When ending a session:" |
| Output filename explicit | ✅ | "Output filename for cursor format is always `.cursorrules` at repo root" |
| No v2.x paths | ✅ | "Ensure all commands use v3.0 CLI (`ontos map`, `ontos agents`, etc.); no v2.x script paths" |
| Implementer can build this without guessing | ✅ | Table format is implementable as a series of string operations |

**Additional Observations:**
- The rule "Any other section: Remove" provides a good safety net for future template changes
- ASCII-only constraint preserved: "Preserve ASCII-only content"
- Transform is simple string manipulation, no regex needed

**B2 Resolution:** **RESOLVED**

---

## My High Issues

| My Issue | CA Response | Adequate? | Notes |
|----------|-------------|-----------|-------|
| X-H1: No version stamp | Added `Generated by Ontos v{ontos_version}` in template line 211 | ✅ | Version and timestamp now in template. Good. |
| X-H2: PyPI not gated on tests | M5: "Gate publish on tests... Use in-workflow tests for simplicity" + M1: TestPyPI install verification | ✅ | Two layers of safety: tests must pass AND TestPyPI install verified |
| X-H3: Template injection via stats | M7: "Restrict template placeholders to numeric/timestamp values; avoid user-controlled strings" | ✅ | Clean solution - only safe types allowed |
| X-H4: Windows file locking | m3: "Add clear `PermissionError` message to guide users" | ⚠️ | Improved but not resolved. Error message helps but Windows users still can't write. Should suggest closing editor or use temp-file-then-rename pattern. Acceptable for v3.0.0. |
| X-H5: No backup before --force | M8: "When `--force` is used, create `.bak` backup of the existing file before overwrite" | ✅ | Good mitigation - user can recover |
| X-H6: Missing sources not handled | Not explicitly addressed in CA response | ❌ | **Gap:** CA response doesn't mention handling when context map or sources don't exist yet. Original spec said "skip that source" but no explicit error handling added. |

**X-H6 Gap Detail:**
The CA incorporated my `find_repo_root()` and `doctor.py` consistency insights but didn't explicitly address what happens when:
- AGENTS.md staleness check runs but context map doesn't exist
- Logs directory is empty or doesn't exist
- `.ontos.toml` doesn't exist (which affects how sources are located)

**Recommendation:** Add explicit behavior: "If source file doesn't exist, skip it from mtime comparison and log at debug level. If ALL sources are missing, emit warning 'Cannot determine staleness - sources not found'."

---

## My Medium Issues

| My Issue | CA Response | Adequate? |
|----------|-------------|-----------|
| X-M1: Stats unbounded | m4: "Use generator + cap at 5000 files; show `5000+` if exceeded" | ✅ |
| X-M2: Export alias untested | m7: "Add unit test for warning and delegation" | ✅ |
| X-M3: Clock skew | Accepted risk (Q5 rejects time-based staleness) | ✅ |
| X-M4: TestPyPI collision | m6: Deferred, "require version bump on failure" | ✅ |
| X-M5: last_updated format | m5: "Define `YYYY-MM-DD HH:MM:SS UTC`" | ✅ |

All medium issues adequately addressed or consciously deferred.

---

## My Unique Insights

| Insight | CA Says "Incorporated" | Actually Incorporated? | Notes |
|---------|------------------------|------------------------|-------|
| `find_repo_root()` fallback dangerous | Yes (§6 row 3) | ✅ | "Prefer `.ontos.toml`, then `git rev-parse --show-toplevel`, then fallback" - much safer hierarchy |
| doctor.py vs export.py inconsistency | Yes (§6 row 4) | ✅ | "Require doctor staleness check to use same repo-root helper" |
| init.py hardcoded "ontos export" | Yes (§6 row 5) | ✅ | "Update init success message to reference `ontos agents`" |

All three code-level insights addressed.

---

## New Problems Introduced?

The CA made changes. Checking for new issues:

| Change | New Edge Case / Failure Mode? | Severity |
|--------|------------------------------|----------|
| Backup creates `.bak` file | What if `.bak` already exists? | **Low** - Standard behavior is to overwrite `.bak`. Could chain backups (`.bak.1`, `.bak.2`) but overkill for v3.0.0 |
| Stats cap at 5000 | User might not know count is approximate | **Low** - `5000+` suffix makes it clear |
| TestPyPI install with `--no-deps` | Might miss dependency issues | **Medium** - `--no-deps` avoids index mixing issues but won't catch missing deps. However, main PyPI build would still fail on import if deps are wrong. Acceptable tradeoff. |
| `git rev-parse --show-toplevel` for repo root | Requires git installed; subprocess call | **Low** - Git is already a requirement (hooks, repo detection). Subprocess is fast. |
| Transform rules prepend instructions | Double "When..." in Cursor output might be verbose | **Low** - Slightly longer output but clearer for LLMs |

**New issue identified:** The template in Appendix A uses backticks around commands (e.g., `` `ontos map` ``). When transformed to `.cursorrules`, are these backticks preserved? The transform rules say "Keep as-is" for Quick Reference, but `.cursorrules` is plain text - backticks might render differently or confuse Cursor's parser.

**Recommendation:** Verify backticks work in Cursor's `.cursorrules` format, or specify "strip backticks" in transform rules if needed.

---

## Uncomfortable Questions — Were They Answered?

| Question | CA Answer | Satisfactory? |
|----------|-----------|---------------|
| Have you tested AGENTS.md with multiple LLMs? | "Not yet. Will add manual test step for 2 LLMs in v3.0.0 verification" | ✅ | Honest answer with commitment to test. Manual test is pragmatic for v3.0.0. |
| What's your PyPI fallback? | "Use manual publish with a one-time token... point users to README git+ install path" | ✅ | Two fallbacks specified: manual token and git+ install. Good risk mitigation. |
| Why no Windows CI? | "Scope and time; deferred to v3.0.3... add clearer error messaging" | ✅ | Pragmatic. Windows CI is substantial work. Error messaging is reasonable mitigation for now. |

---

## Summary of Remaining Gaps

| Gap | Severity | Blocking? |
|-----|----------|-----------|
| X-H6: Missing sources not explicitly handled | Medium | No |
| Backticks in .cursorrules | Low | No |

Neither gap is blocking. Both can be addressed during implementation or as follow-ups.

---

## Verdict

**Verification Status:** **PASS**

**Blocking issues remaining:** 0

**Critical issues resolved:**
- ✅ B1: AGENTS.md template is now complete and implementable
- ✅ B2: .cursorrules transform rules are now explicit and unambiguous

**Notes:**
- All High issues addressed (X-H1 through X-H5 resolved; X-H6 has minor gap but non-blocking)
- All Medium issues addressed or consciously deferred
- All unique insights incorporated
- No new blocking issues introduced by fixes
- Minor gap: X-H6 (missing sources) could use explicit error handling specification
- Minor gap: Verify backticks work in .cursorrules format

**Confidence level:** High. An implementer can now build the `agents` command without guessing. The template is complete, transform rules are clear, and safety mechanisms (backup, stats cap, test gating) are specified.

---

**Document signed by:**
- **Role:** Adversarial Reviewer (Verification)
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-17
- **Status:** Verification Complete - PASS
