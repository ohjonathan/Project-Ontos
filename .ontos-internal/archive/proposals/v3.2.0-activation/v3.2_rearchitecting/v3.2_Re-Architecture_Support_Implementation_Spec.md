---
id: v3_2_implementation_spec
type: strategy
status: draft
depends_on: [v3_2_proposal_finalization_ca]
concepts: [migration, architecture, implementation]
---

# v3.2 Re-Architecture Support — Implementation Spec

**Version:** 1.0
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-28
**Status:** Draft — Pending Review

---

## 1. Overview

This release adds **Re-Architecture Support** to Ontos—bulk data export, migration analysis, and agent workflow integration. It enables developers to extract institutional knowledge when migrating projects to new technology stacks.

**Target Version:** 3.2
**Theme:** Re-Architecture Support
**Risk Level:** LOW (additive commands, no breaking changes)

---

## 2. Scope

### 2.1 In Scope

- [x] `ontos export data` — Bulk data export to JSON with dependency graph
- [x] `ontos export claude` — CLAUDE.md generation (moved from bare `export`)
- [x] `ontos export` — Deprecated alias (warns, runs `export claude`)
- [x] `ontos migration-report` — Dependency analysis (safe/review/rewrite)
- [x] `ontos migrate` — Convenience command (runs both, outputs to `--out-dir`)
- [x] New frontmatter fields (5 optional fields)
- [x] Shared snapshot primitive (internal architecture)
- [x] Documentation updates

### 2.2 Out of Scope (Deferred)

| Item | Deferred To | Reason |
|------|-------------|--------|
| `--format yaml` output | v3.3+ | Requires `pyyaml` dependency evaluation |
| `ontos decisions` command | v3.3+ | Await field adoption feedback |
| `ontos-decision` fenced blocks | v3.3+ | Richer structure than frontmatter |
| Typed dependency edges | v3.3+ | `depends_on` vs `references` distinction |
| `ontos import` capability | v3.3+ | Reverse of export |
| MCP compatibility | v4.0 | Different architectural scope |

---

## 3. Dependencies

### 3.1 Prerequisites

- [x] v3.1.1 released (current baseline)
- [x] CLI architecture established (`cli.py` argparse pattern)
- [x] Document scanning infrastructure (`io/files.py`, `core/frontmatter.py`)
- [x] Dependency graph logic (`core/graph.py`)

### 3.2 Blocked By

| Blocker | Status | Mitigation |
|---------|--------|------------|
| None | — | — |

---

## 4. Command Specifications

### 4.1 `ontos export data`

**Purpose:** Bulk export documents as structured JSON with full content, metadata, and dependency graph.

**Usage:**
```bash
ontos export data [OPTIONS]
```

**Options:**
| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `-o, --output` | PATH | stdout | Output file path |
| `--type` | STRING | all | Filter by document type (comma-separated) |
| `--status` | STRING | all | Filter by status (comma-separated) |
| `--concept` | STRING | all | Filter by concept (comma-separated) |
| `--no-content` | FLAG | false | Exclude document content (metadata only) |
| `--deterministic` | FLAG | false | Stable output for testing |
| `--force` | FLAG | false | Overwrite existing output file |

**Output Schema (JSON):**
```json
{
  "schema_version": "ontos-export-v1",
  "provenance": {
    "exported_at": "2026-01-28T12:00:00Z",
    "ontos_version": "3.2.0",
    "git_commit": "abc1234",
    "project_root": "/path/to/project"
  },
  "filters": {
    "types": ["strategy", "product"],
    "status": ["active"],
    "concepts": null
  },
  "summary": {
    "total_documents": 15,
    "by_type": {"kernel": 2, "strategy": 8, "product": 5},
    "by_status": {"active": 12, "draft": 3}
  },
  "documents": [
    {
      "id": "pricing_strategy",
      "type": "strategy",
      "status": "active",
      "path": "docs/strategy/pricing.md",
      "depends_on": ["mission", "audience"],
      "concepts": ["pricing", "business-model"],
      "decision_summary": "Usage-based pricing with free tier",
      "decision_rationale": "Aligns incentives...",
      "alternatives_rejected": ["Flat-rate | Punishes light users", "Per-seat | Doesn't fit solo use"],
      "migration_status": null,
      "migration_status_reason": null,
      "inferred_migration_status": "safe",
      "effective_migration_status": "safe",
      "content": "# Pricing Strategy\n\nWe chose...",
      "content_hash": "sha256:abc123..."
    }
  ],
  "graph": {
    "nodes": ["mission", "pricing_strategy", "data_model"],
    "edges": [
      {"from": "pricing_strategy", "to": "mission", "type": "depends_on"},
      {"from": "data_model", "to": "mission", "type": "depends_on"}
    ]
  }
}
```

**Deterministic Mode (`--deterministic`):**

Guarantees reproducible output for golden tests:
1. **Document ordering:** Sorted by `id` alphabetically
2. **Key ordering:** JSON keys sorted alphabetically at all levels
3. **Dependency ordering:** `depends_on`, `edges` sorted alphabetically
4. **Volatile fields:** Fixed values in `provenance`:
   - `exported_at: "deterministic"`
   - `git_commit: "deterministic"`
   - `ontos_version: "<actual version>"` (preserved for compatibility testing)
5. **Content hashes:** Included (stable by definition)

**Exit Codes:**
| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Error (file exists without --force, invalid filter, etc.) |

**Error Handling:**
- Output file exists → Exit 1 with message (unless `--force`)
- Invalid filter value → Exit 1 with message listing valid options
- No documents match filter → Exit 0 with empty `documents` array

---

### 4.2 `ontos export claude`

**Purpose:** Generate CLAUDE.md file for Claude's project memory feature (existing functionality, moved to subcommand).

**Usage:**
```bash
ontos export claude [OPTIONS]
```

**Options:**
| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `-o, --output` | PATH | ./CLAUDE.md | Output file path |
| `--force` | FLAG | false | Overwrite existing file |

**Behavior:** Identical to current `ontos export` command.

**Exit Codes:**
| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | File exists (use --force) |
| 2 | Configuration error |

---

### 4.3 `ontos export` (Deprecated Alias)

**Purpose:** Backward compatibility alias for `ontos export claude`.

**Behavior:**
1. Print deprecation warning to stderr
2. Execute `ontos export claude` with same arguments

**Warning Message:**
```
Warning: 'ontos export' is deprecated. Use 'ontos export claude' or 'ontos export data'.
This alias will be removed in v3.4.
```

**Removal Timeline:** Deprecated in v3.2, removed in v3.4.

---

### 4.4 `ontos migration-report`

**Purpose:** Analyze dependency graph to classify documents by migration safety.

**Usage:**
```bash
ontos migration-report [OPTIONS]
```

**Options:**
| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `-o, --output` | PATH | stdout | Output file path |
| `--format` | STRING | md | Output format: `md` or `json` |
| `--force` | FLAG | false | Overwrite existing file |

**Output Format (Markdown):**
```markdown
# Migration Report

**Generated:** 2026-01-28 12:00:00
**Project:** finance-engine
**Ontos Version:** 3.2.0

---

## Summary

| Classification | Count | Action |
|----------------|-------|--------|
| Safe to migrate | 10 | Copy to new project |
| Needs review | 5 | Update references |
| Needs rewrite | 23 | Preserve intent, reimplement |

---

## Safe to Migrate

These documents have no dependencies on implementation-specific atoms.

| ID | Type | Path |
|----|------|------|
| mission | kernel | .ontos-internal/kernel/mission.md |
| constitution | kernel | .ontos-internal/kernel/constitution.md |
| pricing_strategy | strategy | docs/strategy/pricing.md |

---

## Needs Review

These documents depend on atoms (directly or indirectly).

| ID | Type | Atom Dependencies | Reason |
|----|------|-------------------|--------|
| api_spec | product | parser_implementation | References Python-specific implementation |
| categorization_ux | product | categorization_engine | Depends on atom |

---

## Needs Rewrite

These are atoms—implementation-specific documents.

| ID | Type | Intent to Preserve |
|----|------|-------------------|
| parser_implementation | atom | Multi-format CSV support, graceful error handling |
| categorization_engine | atom | Suggest → Review → Approve flow |

---

## Override Warnings

Documents where manual override downgrades risk:

| ID | Inferred | Override | Reason |
|----|----------|----------|--------|
| api_spec | review | safe | "API is abstract enough" |

**Warning:** Override downgrades inferred classification. Verify this is intentional.
```

**Output Format (JSON):**
```json
{
  "schema_version": "ontos-migration-report-v1",
  "provenance": { ... },
  "summary": {
    "safe": 10,
    "review": 5,
    "rewrite": 23
  },
  "classifications": [
    {
      "id": "pricing_strategy",
      "type": "strategy",
      "path": "docs/strategy/pricing.md",
      "inferred_migration_status": "safe",
      "effective_migration_status": "safe",
      "override": null,
      "override_reason": null,
      "atom_dependencies": []
    },
    {
      "id": "api_spec",
      "type": "product",
      "path": "docs/product/api_spec.md",
      "inferred_migration_status": "review",
      "effective_migration_status": "safe",
      "override": "safe",
      "override_reason": "API is abstract enough",
      "atom_dependencies": ["parser_implementation"]
    }
  ],
  "warnings": [
    {
      "id": "api_spec",
      "type": "override_downgrade",
      "message": "Override downgrades inferred classification from 'review' to 'safe'"
    }
  ]
}
```

**Classification Algorithm:**

```
For each document:
  1. If type == 'atom' → inferred = 'rewrite'
  2. Else if has_transitive_atom_dependency(doc) → inferred = 'review'
  3. Else → inferred = 'safe'

  4. If migration_status override present:
     - effective = override value
     - If override < inferred (downgrade), emit warning
  5. Else:
     - effective = inferred
```

**Two-Classification Model:**
- `inferred_migration_status`: Computed from dependency graph (never overridden)
- `effective_migration_status`: Equals inferred unless `migration_status` override present

**Exit Codes:**
| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Error |

---

### 4.5 `ontos migrate`

**Purpose:** Convenience command that runs `export data` + `migration-report` together.

**Usage:**
```bash
ontos migrate [OPTIONS]
```

**Options:**
| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `--out-dir` | PATH | ./migration/ | Output directory |
| `--force` | FLAG | false | Overwrite existing files |

**Behavior:**
1. Create output directory if needed
2. Run `ontos export data -o {out-dir}/snapshot.json`
3. Run `ontos migration-report -o {out-dir}/analysis.md`
4. Print summary to stdout

**Output Files:**
- `{out-dir}/snapshot.json` — Full document export
- `{out-dir}/analysis.md` — Migration classification report

**Exit Codes:**
| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Error (directory creation failed, sub-command failed, etc.) |

---

## 5. Schema Changes

### 5.1 New Optional Frontmatter Fields

| Field | Type | Description |
|-------|------|-------------|
| `decision_summary` | string | One-line summary of key decision |
| `decision_rationale` | string | Explanation of why this decision was made |
| `alternatives_rejected` | list[string] | Rejected options with pipe convention: `"Option | reason"` |
| `migration_status` | enum | Manual override: `safe`, `review`, `rewrite` |
| `migration_status_reason` | string | Justification for override |

**Example:**
```yaml
---
id: pricing_strategy
type: strategy
status: active
depends_on: [mission]
decision_summary: Usage-based pricing with free tier
decision_rationale: Aligns incentives with customer success
alternatives_rejected:
  - "Flat-rate subscription | Punishes light users"
  - "Per-seat licensing | Doesn't fit solo use case"
migration_status: safe
migration_status_reason: Core business logic, not implementation-specific
---
```

**Validation:**
- All fields optional
- `migration_status` must be one of: `safe`, `review`, `rewrite`
- Invalid values → warning in output, not error (graceful degradation)

### 5.2 Backward Compatibility

- All new fields are optional
- Existing documents work unchanged
- No migration required

---

## 6. Internal Architecture

### 6.1 Shared Snapshot Primitive

**Purpose:** Single scanning/parsing layer used by all export commands. Prevents divergent implementations and ensures consistent behavior.

**Location:** `ontos/core/snapshot.py` (NEW)

**Dataclass:**
```python
@dataclass
class DocumentSnapshot:
    """Immutable snapshot of all documents at a point in time."""
    timestamp: datetime
    config: OntosConfig
    documents: Dict[str, DocumentData]
    graph: DependencyGraph
    validation_result: ValidationResult

    # Computed properties
    @property
    def by_type(self) -> Dict[str, List[DocumentData]]: ...

    @property
    def by_status(self) -> Dict[str, List[DocumentData]]: ...
```

**Factory Function:**
```python
def create_snapshot(
    root: Path,
    config: Optional[OntosConfig] = None,
    include_content: bool = True,
    filters: Optional[SnapshotFilters] = None
) -> DocumentSnapshot:
    """
    Create a snapshot of all documents.

    Args:
        root: Project root directory
        config: Optional config (loads from .ontos.toml if not provided)
        include_content: Whether to include document content
        filters: Optional filters (type, status, concept)

    Returns:
        Immutable DocumentSnapshot
    """
```

**Filter Dataclass:**
```python
@dataclass
class SnapshotFilters:
    types: Optional[List[str]] = None
    status: Optional[List[str]] = None
    concepts: Optional[List[str]] = None
```

**Consumers:**
- `ontos export data` — Uses snapshot for JSON serialization
- `ontos migration-report` — Uses snapshot for classification
- `ontos migrate` — Orchestrates both consumers

### 6.2 Migration Classification Logic

**Location:** `ontos/core/migration.py` (NEW)

```python
@dataclass
class MigrationClassification:
    id: str
    inferred_status: str  # 'safe', 'review', 'rewrite'
    effective_status: str
    override: Optional[str]
    override_reason: Optional[str]
    atom_dependencies: List[str]
    warnings: List[str]

def classify_documents(
    snapshot: DocumentSnapshot
) -> Dict[str, MigrationClassification]:
    """
    Classify all documents for migration.

    Algorithm:
    1. Identify all atoms
    2. Build transitive atom dependency map
    3. Classify each document
    4. Apply overrides, emit warnings for downgrades
    """
```

### 6.3 Module Structure

```
ontos/
├── cli.py                          # MODIFY: Add export subparser
├── commands/
│   ├── export_data.py              # NEW: export data command
│   ├── export_claude.py            # NEW: export claude (refactored from export.py)
│   ├── export.py                   # MODIFY: Deprecated alias
│   ├── migration_report.py         # NEW: migration-report command
│   └── migrate.py                  # NEW: migrate convenience command
├── core/
│   ├── snapshot.py                 # NEW: Shared snapshot primitive
│   ├── migration.py                # NEW: Classification logic
│   ├── frontmatter.py              # MODIFY: Handle new optional fields
│   ├── types.py                    # MODIFY: Add new field types
│   └── graph.py                    # (existing - no changes)
└── io/
    └── files.py                    # (existing - no changes)
```

### 6.4 CLI Registration (Subcommand Pattern)

The `export` command needs subcommands (`data`, `claude`). This is the first subcommand in Ontos CLI.

**Implementation in `cli.py`:**

```python
def _register_export(subparsers, parent):
    """Register export command with subcommands."""
    export_parser = subparsers.add_parser(
        "export",
        help="Export documents (use 'export data' or 'export claude')",
        parents=[parent]
    )
    export_subparsers = export_parser.add_subparsers(
        dest="export_command",
        title="export commands"
    )

    # export data
    data_parser = export_subparsers.add_parser(
        "data",
        help="Export documents as structured JSON",
        parents=[parent]
    )
    data_parser.add_argument("-o", "--output", type=Path, help="Output file")
    data_parser.add_argument("--type", help="Filter by type (comma-separated)")
    data_parser.add_argument("--status", help="Filter by status")
    data_parser.add_argument("--concept", help="Filter by concept")
    data_parser.add_argument("--no-content", action="store_true")
    data_parser.add_argument("--deterministic", action="store_true")
    data_parser.add_argument("--force", "-f", action="store_true")
    data_parser.set_defaults(func=_cmd_export_data)

    # export claude
    claude_parser = export_subparsers.add_parser(
        "claude",
        help="Generate CLAUDE.md file",
        parents=[parent]
    )
    claude_parser.add_argument("-o", "--output", type=Path, default=Path("CLAUDE.md"))
    claude_parser.add_argument("--force", "-f", action="store_true")
    claude_parser.set_defaults(func=_cmd_export_claude)

    # Deprecated: bare 'export' defaults to 'export claude' with warning
    export_parser.set_defaults(func=_cmd_export_deprecated)
```

---

## 7. Test Strategy

### 7.1 Unit Tests

| Component | Test File | Coverage |
|-----------|-----------|----------|
| Snapshot primitive | `tests/core/test_snapshot.py` | Creation, filtering, immutability |
| Migration classification | `tests/core/test_migration.py` | Algorithm, overrides, warnings |
| Frontmatter fields | `tests/core/test_frontmatter.py` | New field parsing |

### 7.2 Command Tests

| Command | Test File | Coverage |
|---------|-----------|----------|
| `export data` | `tests/commands/test_export_data_parity.py` | JSON output, filters, deterministic |
| `export claude` | `tests/commands/test_export_claude_parity.py` | CLAUDE.md generation |
| `migration-report` | `tests/commands/test_migration_report_parity.py` | Classification, formats |
| `migrate` | `tests/commands/test_migrate_parity.py` | Orchestration |

### 7.3 Golden File Tests

| Fixture | Baseline Files |
|---------|---------------|
| small (5 docs) | `export_data_stdout.json`, `migration_report_stdout.md` |
| medium (25 docs) | `export_data_stdout.json`, `migration_report_stdout.md` |

**Deterministic test approach:**
1. Run `ontos export data --deterministic -o output.json` on fixture
2. Compare output.json against golden baseline
3. Fail on any diff

### 7.4 Integration Tests

| Scenario | Test |
|----------|------|
| Full export pipeline | Export → verify JSON valid → verify content matches |
| Deprecation warning | Run `ontos export` → verify stderr contains warning |
| Override warning | Doc with downgrade override → verify warning in report |
| Migrate convenience | Run `ontos migrate` → verify both files created |

---

## 8. Documentation Updates

### 8.1 Ontos_Manual.md

Add sections:
- `ontos export data` command reference
- `ontos export claude` command reference
- `ontos migration-report` command reference
- `ontos migrate` command reference
- Deprecation notice for bare `ontos export`

### 8.2 Ontos_Agent_Instructions.md

Add new workflow section:

```markdown
### "Migrate Ontos" (Re-Architecture Support)

When a user requests help migrating to a new technology stack:

**Step 1: Generate migration artifacts**
```bash
ontos migrate --out-dir ./migration/
```

**Step 2: Analyze output**
- Read `./migration/analysis.md` for classification (safe/review/rewrite)
- Read `./migration/snapshot.json` for full document content

**Step 3: Present findings**
- List safe documents (copy to new project)
- List review documents (update references)
- List rewrite documents (preserve intent)

**Step 4: Assist with migration**
- Copy safe documents to new project structure
- Identify Python-specific references to update
- Extract intent from atoms to guide reimplementation
```

### 8.3 JSON Schema Documentation

Document the `export data` JSON schema in `docs/reference/export_schema.md`:
- Field descriptions
- Example output
- Filter behavior

---

## 9. Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Subcommand pattern unfamiliar | Low | Low | Clear help text, deprecation warning guides users |
| Large projects slow to export | Low | Medium | Content hashing, potential caching in v3.3 |
| Classification algorithm edge cases | Medium | Low | Conservative defaults (review > safe), override capability |
| Golden test churn | Low | Low | Deterministic mode with precise definition |

---

## 10. Acceptance Criteria

- [ ] `ontos export data` outputs valid JSON matching schema
- [ ] `ontos export data --deterministic` produces identical output on repeated runs
- [ ] `ontos export claude` works identically to old `ontos export`
- [ ] Bare `ontos export` prints deprecation warning, still works
- [ ] `ontos migration-report` classifies all documents correctly
- [ ] `migration_status` override is respected with warning on downgrade
- [ ] `ontos migrate` creates both files in output directory
- [ ] All new frontmatter fields are parsed and exported when present
- [ ] Invalid frontmatter values produce warnings, not errors
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Golden file tests pass
- [ ] Documentation updated
- [ ] CHANGELOG updated

---

## 11. Implementation Order

1. **Phase A: Snapshot Primitive**
   - `ontos/core/snapshot.py`
   - `tests/core/test_snapshot.py`

2. **Phase B: Export Data**
   - `ontos/commands/export_data.py`
   - CLI registration (subcommand pattern)
   - `tests/commands/test_export_data_parity.py`
   - Golden file baselines

3. **Phase C: Export Claude Refactor**
   - `ontos/commands/export_claude.py`
   - Deprecation alias in `cli.py`
   - `tests/commands/test_export_claude_parity.py`

4. **Phase D: Migration Classification**
   - `ontos/core/migration.py`
   - `tests/core/test_migration.py`

5. **Phase E: Migration Report**
   - `ontos/commands/migration_report.py`
   - `tests/commands/test_migration_report_parity.py`
   - Golden file baselines

6. **Phase F: Migrate Convenience**
   - `ontos/commands/migrate.py`
   - `tests/commands/test_migrate_parity.py`

7. **Phase G: Documentation**
   - `Ontos_Manual.md`
   - `Ontos_Agent_Instructions.md`
   - `docs/reference/export_schema.md`
   - `CHANGELOG.md`

---

## 12. Verification Commands

After implementation, verify with:

```bash
# Export data
ontos export data -o test.json
ontos export data --type strategy --deterministic -o test2.json

# Export claude
ontos export claude -o CLAUDE.md
ontos export  # Should warn and run export claude

# Migration report
ontos migration-report -o report.md
ontos migration-report --format json -o report.json

# Migrate convenience
ontos migrate --out-dir ./migration/
ls ./migration/  # Should contain snapshot.json, analysis.md

# Run tests
pytest tests/core/test_snapshot.py
pytest tests/core/test_migration.py
pytest tests/commands/test_export_data_parity.py
pytest tests/commands/test_migration_report_parity.py
python tests/golden/compare_golden_master.py --fixture small
```

---

*Spec Version: 1.0*
*Ready for Review Board*
