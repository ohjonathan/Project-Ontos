---
id: v3_2_proposal_finalization_ca
type: strategy
status: active
depends_on: [v3_2_ca_response_consolidation]
concepts: [migration, architecture, proposal-finalization]
---

# Chief Architect: Consolidation Review & Proposal Finalization

**Role:** Chief Architect (Claude Opus 4.5)
**Phase:** Pre-A — Final Proposal Review
**Date:** 2026-01-28
**Version:** 2.0

---

## 1. Consolidation Summary

**Consensus:** 1/3 reviewers say ready for spec

| Reviewer | Verdict | Blocking? |
|----------|---------|-----------|
| Claude (Alignment) | Ready (after revisions) | No |
| ChatGPT (Adversarial) | Needs one more revision | No |
| Gemini (Peer) | Needs revision | No |

**Blocking Issues Status:**

| Issue | Status After Response Review |
|-------|------------------------------|
| BLOCK-1: YAML | **Resolved** — Removed from scope, JSON only |
| BLOCK-2: Export rename | **Resolved** — Subcommand approach adopted |
| BLOCK-3: Heuristics | **Resolved** — Dropped heuristics, added explicit fields |

All three blocking issues from Round 1 are now resolved. The remaining concerns are spec-level details, not architectural disagreements.

---

## 2. Pushback Response

### Pushback 1: Migration Override Hides Inferred Truth

**My Original Decision:** Add `migration_status: safe|review|rewrite` override field; if present, overrides graph-inferred classification.

**Reviewer Pushback:** ChatGPT (Strong) — "Override replaces inferred classification" is too blunt. Export/report should show **both** `inferred_migration_status` and `effective_migration_status`, warn on discrepancies, and consider a monotonic rule (overrides can only increase severity by default).

**My Final Decision:** **MODIFY**

**Reasoning:** ChatGPT is correct. Allowing silent downgrades (marking a doc "safe" when the graph says "review") creates false confidence. The two-classification model is minimal overhead and prevents abuse.

**Proposal Impact:**
- `export data` and `migration-report` will output **both** fields:
  - `inferred_migration_status`: Computed from dependency graph
  - `effective_migration_status`: Inferred unless override present
- When override **downgrades** risk (e.g., inferred=review, override=safe), emit warning
- No monotonic rule enforcement (too restrictive) — just warnings

---

### Pushback 2: Nested Frontmatter Structures May Break Parser

**My Original Decision:** Add `alternatives_rejected` as list of dicts:
```yaml
alternatives_rejected:
  - option: "Use None"
    reason: "Downstream math fails on None"
```

**Reviewer Pushback:** ChatGPT (Strong) — Ontos's frontmatter parser likely cannot handle YAML list-of-maps reliably without a proper YAML dependency. This reintroduces "YAML without YAML" failure mode.

**My Final Decision:** **ACCEPT — MODIFY**

**Reasoning:** ChatGPT is correct. We banned YAML output because Python stdlib can't serialize it reliably. The same limitation applies to parsing complex nested structures. Our parser handles scalars and list-of-strings safely; list-of-dicts is risky.

**Proposal Impact:**
- v3.2 decision fields constrained to parseable structures:
  - `decision_summary: <string>`
  - `decision_rationale: <string | multiline>`
  - `alternatives_rejected: [<string>, <string>, ...]` — List of strings with pipe convention: `"Option A | reason"`
- Defer structured alternatives to v3.3 with `ontos-decision` blocks

---

### Pushback 3: Frontmatter State Causes Git Merge Conflicts

**My Original Decision:** Store `migration_status` override in file frontmatter.

**Reviewer Pushback:** Gemini (Moderate) — Storing mutable state in source-controlled frontmatter causes merge conflicts when two developers run migration checks on different branches.

**My Final Decision:** **MAINTAIN — Clarify Semantics**

**Reasoning:** Gemini's concern assumes `migration_status` is tool-generated state. It's not — it's an **author-declared override**. Ontos tools never auto-write this field. Only humans set it, explicitly, when they have domain knowledge the graph can't capture.

This is the same pattern as `status: deprecated` — it's human-curated metadata, not computed state. Git conflicts only happen if two humans independently decide to override the same document, which is a legitimate conflict to resolve manually.

**Proposal Impact:**
- Clarify in documentation: `migration_status` is a **manual override** field, never auto-written by tools
- Tools should warn if `migration_status` is set but seems inconsistent with graph analysis

---

### Pushback 4: `export claude` Hardcodes Vendor Name

**My Original Decision:** Use `export claude` subcommand.

**Reviewer Pushback:** Gemini (Minor) — Hardcoding a vendor name into CLI verbs is an anti-pattern. Suggests `export context --preset=claude`.

**My Final Decision:** **MAINTAIN**

**Reasoning:** This is existing behavior being moved to a subcommand. The `claude` name reflects the specific format (CLAUDE.md file for Claude's memory feature). If/when we support other formats:
- `export openai` → OPENAI.md
- `export cursor` → .cursorrules (already handled by `ontos agents`)

The `--preset=` flag pattern adds complexity for aesthetic purity. Real extensibility comes from new subcommands, not configuration flags.

**Proposal Impact:** None — decision stands.

---

### Pushback 5: `--deterministic` Flag Needs Precise Definition

**My Original Decision:** Add `--deterministic` flag for testing.

**Reviewer Pushback:** ChatGPT (Moderate) — Define concretely: stable document ordering, stable key ordering, stable dependency ordering, treatment of volatile fields (`exported_at`, git commit, timestamps).

**My Final Decision:** **ACCEPT — Specify in Detail**

**Reasoning:** Valid concern. "Deterministic" is meaningless without a precise definition. Golden tests will still churn if we don't specify exactly what's frozen.

**Proposal Impact:**
`--deterministic` mode guarantees:
1. **Document ordering:** Sorted by `id` alphabetically
2. **Key ordering:** JSON keys sorted alphabetically at all levels
3. **Dependency ordering:** `depends_on`, `edges` sorted alphabetically
4. **Volatile fields:** Moved under `provenance` object with fixed values:
   - `exported_at: "deterministic"`
   - `git_commit: "deterministic"`
   - `ontos_version: "<actual version>"` (preserved for compatibility testing)
5. **Content hashes:** Included (stable by definition)

---

### Pushback 6: `-o` Flag Semantics Are Inconsistent

**My Original Decision:** `export data -o snapshot.json` (file) vs `migrate -o ./migration/` (directory).

**Reviewer Pushback:** ChatGPT (Moderate) — Inconsistent `-o` semantics (file vs directory) is a UX trap.

**My Final Decision:** **ACCEPT — Separate Flags**

**Reasoning:** Using the same flag for different purposes is confusing. Users will misuse it.

**Proposal Impact:**
- `export data`: Use `-o/--output <file>` for file output
- `migration-report`: Use `-o/--output <file>` for file output
- `migrate`: Use `--out-dir <directory>` for directory output
- All commands: Define overwrite behavior — fail if target exists unless `--force`

---

## 3. New Issues Response

| New Issue | Raised By | Response | Action |
|-----------|-----------|----------|--------|
| `migration_status_reason` field missing | ChatGPT | **Accept** | Add optional `migration_status_reason: <string>` for override justification |
| Schema sprawl (3 new optional fields) | Claude | **Accept** | Note for future: track cumulative complexity; consider `ontos doctor` hints in v3.3 |
| Agent workflow must be written before spec | Claude | **Accept** | Required deliverable before spec — will add section to proposal |
| Deprecation sunset criteria missing | ChatGPT | **Accept** | Specify: "Deprecated in v3.2, removed in v3.4" for `ontos export` alias |
| Snapshot schema undocumented | Gemini | **Accept** | Add JSON schema reference to documentation |
| `migration-report` discoverability | Gemini | **Defer** | Valid UX concern; defer alias decisions to post-v3.2 user feedback |

---

## 4. Final Proposal Changes

All changes to be applied to the proposal before spec:

| Change | Source | Section Affected |
|--------|--------|------------------|
| Two-classification model (`inferred_` + `effective_`) | Pushback 1 | Output Schema (3.1.3), Migration Report (3.3) |
| Constrain `alternatives_rejected` to list-of-strings | Pushback 2 | Decision Fields (new section) |
| Clarify `migration_status` is manual override only | Pushback 3 | New frontmatter fields |
| Define `--deterministic` precisely | Pushback 5 | CLI Interface (3.1.2), Implementation Notes |
| Separate `-o` and `--out-dir` flags | Pushback 6 | CLI Interface (all commands) |
| Add `migration_status_reason` field | New Issue 1 | New frontmatter fields |
| Add deprecation sunset: "removed in v3.4" | New Issue 4 | Command structure (4.4) |
| Add agent workflow protocol section | New Issue 3 | New section 3.4 |
| Document snapshot JSON schema | New Issue 5 | Output Schema (3.1.3) |

---

## 5. Proposal Lock

**Proposal Status:** **LOCKED FOR SPEC**

All blocking issues resolved:
- BLOCK-1 (YAML): Removed from scope
- BLOCK-2 (Export rename): Subcommand approach adopted
- BLOCK-3 (Heuristics): Explicit fields, no extraction

All pushback addressed:
- Migration override: Modified to two-classification model
- Nested frontmatter: Modified to list-of-strings only
- Git conflicts: Maintained with clarified semantics
- Vendor name: Maintained (existing pattern)
- Deterministic flag: Specified in detail
- Output flags: Separated `-o` vs `--out-dir`

New issues addressed:
- Override reason field: Added
- Agent workflow: Required before spec
- Deprecation sunset: Specified (v3.4 removal)
- Schema docs: Will include

**No further review cycle required.** Proceed to implementation spec after applying changes.

---

## 6. Pre-Spec Checklist

Confirm before writing spec:

- [x] All blocking issues resolved
- [x] All pushback addressed (maintained, modified, or reversed with reasoning)
- [x] New issues addressed
- [ ] Proposal document updated with final changes
- [x] Command structure finalized
- [x] Scope clearly defined (what's in v3.2, what's deferred)

---

## 7. Scope Summary for Spec

### v3.2 Scope (FINAL)

**Commands:**
- [x] `ontos export data` — Bulk data export to JSON with dependency graph
- [x] `ontos export claude` — CLAUDE.md generation (moved from bare `export`)
- [x] `ontos export` — Deprecated alias (warns, runs `export claude`)
- [x] `ontos migration-report` — Dependency analysis (safe/review/rewrite)
- [x] `ontos migrate` — Convenience command (runs both, outputs to `--out-dir`)

**New Frontmatter Fields (all optional):**
- [x] `decision_summary: <string>`
- [x] `decision_rationale: <string>`
- [x] `alternatives_rejected: [<string>, ...]` (pipe-delimited convention)
- [x] `migration_status: safe|review|rewrite` (manual override)
- [x] `migration_status_reason: <string>` (justification for override)

**Internal Architecture:**
- [x] Shared snapshot primitive (single scan/parse layer for all commands)

**Documentation:**
- [x] Update `Ontos_Manual.md` with new commands
- [x] Update `Ontos_Agent_Instructions.md` with migration workflow
- [x] Document JSON schema for `export data` output
- [x] Document deprecation timeline for `ontos export` alias

### Explicitly Deferred to v3.3+

- `--format yaml` output (requires `pyyaml` dependency evaluation)
- `ontos decisions` command (await field adoption feedback)
- `ontos-decision` fenced blocks (richer structure than frontmatter)
- Typed dependency edges (`depends_on` vs `references`)
- `ontos import` capability
- MCP compatibility (v4.0 scope)

---

## 8. Next Step

**Ready for:** Phase A — Implementation Spec

**Spec should cover:**
1. **CLI registration** — How commands are wired into `cli.py`
2. **Shared snapshot primitive** — `DocumentSnapshot` dataclass and scanning logic
3. **Export data module** — Filtering, serialization, deterministic mode
4. **Migration report module** — Classification algorithm, two-status model
5. **Migrate convenience command** — Orchestration of export + report
6. **Frontmatter parser updates** — Handle new optional fields
7. **Test strategy** — Golden files, classification edge cases
8. **Documentation updates** — Manual, agent instructions, schema reference

---

## 9. Agent Workflow Protocol (Required Section)

This section must be added to the proposal before spec.

### Agent Migration Workflow

When a user requests migration help, the agent should:

**Step 1: Understand Intent**
```
User: "We're rebuilding this project in TypeScript"
Agent: I'll analyze your Ontos documentation for migration.
```

**Step 2: Generate Artifacts**
```bash
# Run the convenience command
ontos migrate --out-dir ./migration/

# Or run separately for more control
ontos export data -o ./migration/snapshot.json
ontos migration-report -o ./migration/analysis.md
```

**Step 3: Analyze Output**
Agent reads:
- `snapshot.json` — Full document content and metadata
- `analysis.md` — Classification (safe/review/rewrite) with recommendations

**Step 4: Present Findings**
```markdown
## Migration Analysis

**Safe to carry forward (10 documents):**
- mission, constitution (kernel)
- pricing_strategy, data_model (strategy)

**Needs review (5 documents):**
- api_spec — references Python-specific implementation
- categorization_ux — depends on categorization_engine atom

**Likely rewrite (23 documents):**
- parser_implementation, categorization_engine (atoms)

Shall I help you start with the foundation documents?
```

**Step 5: Assist with Migration**
Agent can:
- Copy safe documents to new project structure
- Identify Python-specific references to update
- Extract intent from atoms to guide reimplementation

### AGENTS.md Template Addition

```markdown
## Migration Workflow

When asked to help with project migration or re-architecture:

1. Run: `ontos migrate --out-dir ./migration/`
2. Read `./migration/analysis.md` for classification
3. Read `./migration/snapshot.json` for full document content
4. Present findings: safe/review/rewrite with recommendations
5. Assist with copying safe docs and updating reviewed docs
```

---

**Signed:** Claude Opus 4.5, Chief Architect
**Date:** 2026-01-28
