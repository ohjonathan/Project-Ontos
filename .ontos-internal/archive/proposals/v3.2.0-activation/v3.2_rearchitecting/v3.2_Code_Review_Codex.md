# Code Review: Adversarial Reviewer (ChatGPT/Codex)

**Role:** Adversarial Reviewer (ChatGPT/Codex)
**Phase:** D.2 — Code Review
**Version:** 3.2
**PR:** #57 — Re-Architecture Support

---

## 1. Regression Hunt

Tests/commands not run (no PR checkout executed here).

| Existing Feature | Still Works? | Evidence |
|------------------|--------------|----------|
| `ontos status` | ⚠️ Not verified | Not run |
| `ontos agents` | ⚠️ Not verified | Not run |
| `ontos export` → CLAUDE.md | ⚠️ Likely regression | Behavior differs vs prior `export` (see H1) |
| Other existing commands | ⚠️ Not verified | Not run |

**Regressions Found:**
| Regression | How to Reproduce | Impact |
|------------|------------------|--------|
| `ontos export` now fails outside a git/.ontos project | Run `ontos export` in a plain directory without `.git` or `.ontos.toml` | Previously created `CLAUDE.md`; now returns error and blocks workflows |

---

## 2. Edge Case Analysis

### `ontos export data`

| Edge Case | Handled? | Test Exists? | What Happens? |
|-----------|----------|--------------|---------------|
| Empty vault (no documents) | ✅ | ✅ | Produces empty `documents` array |
| Single document | ✅ | ✅ | Exports 1 doc |
| Circular dependencies | ⚠️ Partial | ❌ | DFS stops on cycles; no warning surfaced in export output |
| Missing `depends_on` targets | ⚠️ Partial | ❌ | Missing deps ignored for classification; no warning in export output |
| Invalid frontmatter YAML | ❌ | ❌ | Parsed as empty frontmatter, defaults type/status silently |
| Non-UTF8 file content | ❌ | ❌ | File skipped silently on decode error |
| Very large vault (1000+ docs) | ⚠️ Unknown | ❌ | Loads all content into memory; no streaming/backpressure |
| `--output` to non-existent dir | ✅ | ✅ | Parent dirs created |
| `--output` to read-only path | ❌ | ❌ | Uncaught exception on write |
| `--type` with invalid type | ❌ | ❌ | No validation; returns empty set with exit 0 |
| `--deterministic` output stability | ⚠️ Partial | ✅ | Stable within same root; project_root varies across machines |

### `ontos migration-report`

| Edge Case | Handled? | Test Exists? | What Happens? |
|-----------|----------|--------------|---------------|
| All docs classified "safe" | ✅ | ❌ | Report renders safe section |
| All docs classified "rewrite" | ✅ | ❌ | Report renders rewrite section |
| `migration_status` override works | ✅ | ✅ | Effective status changes |
| Invalid `migration_status` value | ⚠️ Partial | ❌ | JSON warning only; markdown omits invalid override warnings |
| Orphan documents (no deps) | ✅ | ❌ | Classified as safe unless atom |

### `ontos migrate`

| Edge Case | Handled? | Test Exists? | What Happens? |
|-----------|----------|--------------|---------------|
| Output dir already exists | ✅ | ✅ | Uses `exist_ok=True`; file overwrite governed by `--force` |
| Output dir creation fails | ✅ | ❌ | Returns error |
| Partial failure (export ok, report fails) | ⚠️ Partial | ❌ | Leaves `snapshot.json` behind; no cleanup |

---

## 3. Error Handling Analysis

| Error Scenario | Code Handles? | Error Message Clear? | Exit Code Correct? |
|----------------|---------------|----------------------|-------------------|
| File not found (no project root) | ✅ | ✅ | ✅ |
| Permission denied (write output) | ❌ | ❌ | ❌ |
| Invalid JSON output path (dir path) | ❌ | ❌ | ❌ |
| Malformed frontmatter | ❌ | ❌ | ❌ |

**Error Handling Gaps:**
| Gap | Scenario | Impact |
|-----|----------|--------|
| Uncaught write errors | Read-only output path or invalid file path | Crash/stack trace instead of controlled exit 1 |
| Silent parse/encoding failures | Invalid YAML or non-UTF8 content | Missing docs, misleading migration/export output |

---

## 4. Test Adequacy

For each new test:

| Test | What It Tests | Actually Catches Bugs? | Missing Cases? |
|------|---------------|------------------------|----------------|
| `tests/commands/test_export_data_parity.py` | Basic export, deterministic, filters | ✅ | Invalid filters, read-only output, invalid YAML, non-UTF8 |
| `tests/commands/test_migration_report_parity.py` | Markdown/JSON output, migrate | ✅ | Invalid overrides, missing deps, permission errors |
| `tests/core/test_snapshot.py` | Snapshot creation, filtering, content stripping | ✅ | Encoding errors, skip pattern correctness |
| `tests/core/test_migration.py` | Classification, overrides, warnings | ✅ | Missing deps, cycles, filtered snapshots |

**Tests That Don't Test What They Claim:**
| Test | Claims to Test | Actually Tests | Fix |
|------|----------------|----------------|-----|
| None | | | |

**Missing Test Coverage:**
| Untested Scenario | Risk | Should Add? |
|-------------------|------|-------------|
| Invalid filter values for `--type/--status` | Silent empty output, false positives | Yes |
| Output path permission errors | Unhandled exceptions | Yes |
| Filtered export with atom deps excluded | Misclassified `inferred_migration_status` | Yes |
| Invalid YAML / non-UTF8 input | Silent data loss | Yes |

---

## 5. Security Review

| Attack Vector | Applicable? | Mitigated? | Notes |
|---------------|-------------|------------|-------|
| Path traversal in `--output` | Yes | ❌ | `export data` / `migration-report` allow writes outside repo |
| Command injection | No | ✅ | No shell execution |
| Symlink attacks | Yes | ❌ | No safeguard against symlinked output paths |
| Resource exhaustion (huge vault) | Yes | ❌ | Full in-memory load; no limits |

---

## 6. Assumption Attack

| Assumption in Code | Why It Might Be Wrong | Impact If Wrong |
|--------------------|----------------------|-----------------|
| Filtered snapshot is OK for migration classification | Filters can exclude atoms and hide dependencies | `inferred_migration_status` becomes incorrectly safe |
| All docs are UTF-8 | Legacy content may be non-UTF8 | Silent data loss in exports/reports |
| Invalid YAML can be ignored | Users expect warnings, not silent defaults | Wrong types/status and misleading reports |

---

## 7. Issues Found

**Critical (Will Break):**
| # | Issue | How It Breaks | File | Line(s) |
|---|-------|---------------|------|---------|
| X-C1 | None | | | |

**High (Likely to Break):**
| # | Issue | Attack Vector | File | Line(s) |
|---|-------|---------------|------|---------|
| X-H1 | `ontos export` no longer works outside a git/.ontos project (regression vs old `export`) | Breaks workflows that run export before init or outside repo | ontos/commands/export_claude.py | 59-62 |
| X-H2 | `export data` classification uses filtered snapshot, can hide atom deps and mark docs safe | `--type/--status` filters cause incorrect migration status | ontos/commands/export_data.py | 151-162 |

**Medium (Edge Case):**
| # | Issue | Scenario | File | Line(s) |
|---|-------|----------|------|---------|
| X-M1 | Output write errors are uncaught | Read-only path or invalid output file crashes | ontos/commands/export_data.py | 174-176 |
| X-M2 | Output write errors are uncaught | Read-only path or invalid output file crashes | ontos/commands/migration_report.py | 182-184 |
| X-M3 | Silent skipping or defaulting on invalid YAML / non-UTF8 | Missing docs or wrong types without warning | ontos/core/snapshot.py | 129-153 |
| X-M4 | Invalid `migration_status` warnings not shown in default markdown report | Users miss critical override issues | ontos/commands/migration_report.py | 99-117 |

---

## 8. Verdict

**Code Robustness:** Adequate (but with high-impact regressions)

**Recommendation:** Request revision

**Blocking Issues:** 2

**Top 3 Concerns:**
1. `ontos export` regression outside repo
2. Filtered export misclassifies migration status
3. Unhandled write/parse errors (silent data loss)

