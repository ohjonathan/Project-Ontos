# Antigravity Implementation Prompt: v3.2 Re-Architecture Support

**Role:** Antigravity (Developer)
**Phase:** C.2 — Implementation
**Version:** 3.2

---

## Overview

**What you're building:** Re-Architecture Support for Ontos. This includes bulk data export, migration analysis, and agent workflow integration. You will implement a shared "Snapshot" primitive, new subcommands for `export`, a `migration-report` command, and a `migrate` convenience command.
**Risk Level:** LOW (additive commands, one refactor of a deprecated alias)
**Estimated Scope:** 7-8 new/modified files, medium complexity.

---

## Pre-Implementation Checklist

Before writing any code:

- [ ] Create feature branch: `git checkout -b feature/v3.2-rearch-support`
- [ ] **Fix Environment:** Tests are currently failing due to missing `pyyaml`. Install it: `pip install "pyyaml>=6.0,<7.0"`
- [ ] Verify tests pass: `pytest tests/ -v` (Note: skip `legacy/` if they fail due to environment differences)
- [ ] Read the spec: [v3.2_Re-Architecture_Support_Implementation_Spec.md](file:///.ontos-internal/strategy/proposals/v3.2/v3.2_rearchitecting/v3.2_Re-Architecture_Support_Implementation_Spec.md)
- [ ] Review existing command patterns in [ontos/commands/map.py](file:///Users/jonathanoh/Dev/Ontos-dev/ontos/commands/map.py) (especially `MapOptions` and `map_command`).

---

## Architecture Constraints

**Must follow:**
- **Shared Primitive:** All export/migration commands MUST use `ontos.core.snapshot.create_snapshot()`. No redundant scanning logic.
- **Argparse Pattern:** Follow the `_register_cmd` and `_cmd_wrapper` pattern in `ontos/cli.py`.
- **Exit Codes:** Use specific exit codes as defined in the spec (0 for success, 1 for errors, etc.).
- **Deterministic Output:** The `--deterministic` flag in `export data` must produce byte-for-byte identical output (sorted keys, stable timestamps).

**Patterns to match:**
- **Options Dataclasses:** Use `dataclass` for all command options (match `ontos/commands/map.py`).
- **IO Isolation:** Logic should be in `core/` or `commands/`, with IO operations clearly identified.

---

## Task Sequence

Complete tasks in order. Commit after each task.

### Task 1: Create Shared Snapshot Primitive

**Purpose:** Provide a unified scanning/parsing layer for all document data.
**Files:** 
- `ontos/core/snapshot.py` — [NEW]

**Requirement:**
Implement `DocumentSnapshot` dataclass and `create_snapshot()` factory as specified in Section 6.1 of the spec.

**Test:**
Create `tests/core/test_snapshot.py` and verify filtering and snapshot creation works.

---

### Task 2: Implement `export data` Command

**Purpose:** Bulk export documents to JSON.
**Files:** 
- `ontos/commands/export_data.py` — [NEW]
- `ontos/cli.py` — [MODIFY] (Register `export` subparser)

**Steps:**
1. Implement `export_data_command()` using the snapshot primitive.
2. Implement JSON serialization matching the schema in Section 4.1.
3. Update `cli.py` to add `export data` subcommand.

**Test:**
```bash
pytest tests/commands/test_export_data_parity.py -v
```

---

### Task 3: Refactor `export` to `export claude`

**Purpose:** Move existing `CLAUDE.md` logic to its own file and add a deprecation warning for the bare command.
**Files:** 
- `ontos/commands/export_claude.py` — [NEW] (Move logic from `export.py`)
- `ontos/commands/export.py` — [DELETE/REFRESH] (Keep only if needed for imports, otherwise move logic)
- `ontos/cli.py` — [MODIFY] (Update registration)

**Steps:**
1. Move `export_command` and `CLAUDE_MD_TEMPLATE` from `export.py` to `export_claude.py`.
2. Update `cli.py` to register `export claude`.
3. Update bare `ontos export` to print the deprecation warning and call `export_claude`.

**Test:**
```bash
ontos export  # Verify warning and file creation
```

---

### Task 4: Migration Classification Logic

**Purpose:** Implement the logic to classify documents by migration risk.
**Files:** 
- `ontos/core/migration.py` — [NEW]
- `ontos/core/frontmatter.py` — [MODIFY] (Handle new fields)

**Logic:** Follow the algorithm in Section 4.4:
- safe = No transitive atom dependencies.
- review = Transitive atom dependency found.
- rewrite = Document is an atom.

---

### Task 5: `migration-report` Command

**Purpose:** Generate a markdown/JSON report of migration safety.
**Files:** 
- `ontos/commands/migration_report.py` — [NEW]

**Requirement:** Support `--format md` and `--format json`.

---

### Task 6: `migrate` Convenience Command

**Purpose:** Run both export and report to a target directory.
**Files:** 
- `ontos/commands/migrate.py` — [MODIFY]

> [!IMPORTANT]
> The existing `migrate.py` handles "Schema Migration". You MUST decide whether to rename the existing command to `schema-migrate` or integrate the "Re-architecture Migration" into it. The spec says `ontos migrate` is a convenience command. **Action:** Rename existing `_register_migrate` to `_register_schema_migrate` and implement the new convenience logic in `ontos migrate`.

---

## Regression Testing Protocol

After EACH task:
```bash
pytest tests/ -v
```

---

## Final Verification

```bash
# Full test suite
pytest tests/ -v

# Manual smoke tests
ontos export data -o snapshot.json
ontos migration-report -o report.md
ontos migrate --out-dir ./migration/
```

---

## PR Preparation

**Branch:** `feature/v3.2-rearch-support`
**PR Title:** `feat: v3.2 Re-Architecture Support`

**Expected Commits:**
1. `feat(core): add snapshot primitive`
2. `feat(export): add export data command`
3. `refactor(export): move claude export to subcommand`
4. `feat(core): add migration classification logic`
5. `feat(migration): add migration-report command`
6. `feat(migration): add migrate convenience command`
7. `docs: update CLI reference and agent instructions`

---

## Quality Checklist

- [x] All new subcommands registered correctly in `cli.py`.
- [x] Snapshot primitive is used by all migration commands.
- [x] Deterministic mode verified with multiple runs.
- [x] Deprecation warning appears on `ontos export`.
- [x] Tests added for all new components.
