---
id: v3_2_ontos_activation_proposal
type: strategy
status: approved
depends_on: []
concepts: [activation, agents, context-recovery, cross-tool, tiered-context]
---

# v3.2.1 Proposal: Ontos Activation Resilience

**Version:** v1.1
**Author:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-29
**Status:** Approved — Ready for Implementation

---

## Executive Summary

This proposal addresses a critical gap in Ontos's cross-tool activation strategy: **context loss after compaction**. When AI tools compact their context (e.g., Claude's `/compact`), the project context loaded via "Activate Ontos" is lost. This proposal introduces enhancements to make Ontos re-activation cheaper and more efficient.

**Key Principle:** Ontos manages **project context** (documentation, structure, knowledge graph), NOT **session context** (current task, decisions made). Session context recovery is the tooling's responsibility and will improve as LLM/CLI tools evolve.

> **Important Limitation:** This proposal optimizes *manual* re-activation after context loss. It does NOT provide automatic recovery — that depends on tool behavior we don't control. The value is reducing friction when users *do* re-activate, not eliminating the need to re-activate.

**Primary Deliverable:** Tiered Context Map — cheaper manual re-activation (~2k tokens vs ~12k)
**Secondary Deliverable:** AGENTS.md freshness — benefits tools that re-read instruction files

---

## Problem Statement

### The Context Loss Scenario

1. User starts session, runs "Activate Ontos"
2. AI loads project context from `Ontos_Context_Map.md` (~12k tokens)
3. User works, context fills up
4. Tool automatically compacts context (e.g., `/compact`)
5. **Project context from Ontos is lost**
6. AI continues working without project orientation

### Why This Matters

- Claude's context window (200k) is small compared to Gemini (1M+) and Codex
- Compaction is automatic and unpredictable — happens mid-work
- Users continuing after compaction need continuous context — **the core reason Ontos exists**
- Manual re-activation adds friction and is easy to forget

### What We Are NOT Solving

**Session context recovery is explicitly out of scope.** This includes:
- Current task being worked on
- Decisions made during the session
- Work-in-progress state

Rationale: Session context recovery is a tooling concern that will improve naturally as LLM/CLI tools evolve. Ontos should not overreach into this domain.

---

## Design Philosophy

### Separation of Concerns

| Concern | Owner | Rationale |
|---------|-------|-----------|
| Project context (docs, structure, graph) | **Ontos** | Persistent, tool-agnostic |
| Session context (task, decisions, progress) | **Tooling** | Ephemeral, tool-specific |
| Context compaction/recovery mechanics | **Tooling** | Will improve over time |
| Cross-tool activation consistency | **Ontos** | Universal anchor needed |

### Guiding Principles

1. **Tool-agnostic by design** — Solutions must work across Claude, Gemini, Codex, Cursor, etc.
2. **No session capture** — Don't try to summarize or capture session state before compaction
3. **Lightweight re-activation** — Make it cheap to re-activate after compaction
4. **Living anchor** — AGENTS.md should stay current, not be a "generate once" artifact
5. **Honest about limitations** — Don't overclaim; this optimizes manual re-activation, not automatic recovery

---

## Current State Analysis

### Ontos Agents (`ontos agents`)

**Current behavior:**
- Generates `AGENTS.md` and `.cursorrules` files
- Contains activation instructions, quick reference, project stats
- Static after generation — can become stale
- User must manually regenerate

**AGENTS.md template includes:**
- Activation steps (run `ontos map`, read context map)
- Session end protocol (run `ontos log`)
- Quick reference table
- Project stats (doc count, last updated)
- Staleness warning

**Gap:** AGENTS.md tells tools *how* to activate but not *when* to re-activate. No mechanism for staying current.

### Ontos Context Map

**Current behavior:**
- Generated by `ontos map`
- Full document listing (~50k tokens for large projects)
- Activation typically reads first ~12k tokens (overview + document table)

**Gap:** No tiered structure optimized for post-compaction recovery.

---

## Proposed Solution

### Overview

Three complementary enhancements:

1. **AGENTS.md Sync Flag** — Keep AGENTS.md current with explicit opt-in
2. **Tiered Context Map** — Structure context map for efficient re-activation
3. **Staleness Detection** — Doctor checks and warnings for stale files (already implemented)

### 1. AGENTS.md Sync Flag

**Trigger:** Sync AGENTS.md when `ontos map --sync-agents` is used.

**Rationale:**
- `ontos map` remains a pure read-operation (single responsibility)
- Users who want sync can opt in explicitly
- Tools that re-read AGENTS.md get fresh orientation

**Implementation:**

```python
# In ontos/commands/map.py
def map_command(..., sync_agents: bool = False):
    # ... existing map logic ...

    # Sync AGENTS.md only if flag is set AND file exists
    if sync_agents:
        agents_path = repo_root / "AGENTS.md"
        if agents_path.exists():
            print("Syncing AGENTS.md...")
            from ontos.commands.agents import agents_command, AgentsOptions
            agents_command(AgentsOptions(force=True))
            print("✓ AGENTS.md synced")
        else:
            print("⚠ AGENTS.md not found. Run 'ontos agents' to create.")
```

**CLI:**

```bash
# Standard map (no sync)
ontos map

# Map with AGENTS.md sync
ontos map --sync-agents
```

**New AGENTS.md sections:**

```markdown
## Current Project State

> Auto-synced on: {timestamp}

- **Branch:** {current_branch}
- **Recent Activity:** {last_log_date} — {last_log_slug}
- **Doc Count:** {doc_count}
- **Health:** {doctor_summary}

## Re-Activation

If you've lost project context (don't recognize the structure above), run:

1. `ontos map` — Regenerate context map
2. Read `Ontos_Context_Map.md` — Reload project orientation
```

### 2. Tiered Context Map

**Concept:** Structure `Ontos_Context_Map.md` so that the first ~2k tokens provide complete essential orientation.

**Tiers:**

| Tier | Tokens | Content | Purpose |
|------|--------|---------|---------|
| 1 | ~2k (hard cap) | Project summary, recent activity, critical paths | Survival minimum |
| 2 | ~10k | Full document table, dependency overview | Standard activation |
| 3 | ~50k+ | Complete graph details, all metadata | Deep exploration |

**Implementation:**

```markdown
# Ontos Context Map

<!-- ontos-map-version: 2 -->

## Tier 1: Essential Context (~2k tokens)

### Project Summary
- **Name:** {project_name}
- **Purpose:** {one_line_description}
- **Doc Count:** {count}
- **Last Updated:** {timestamp}

### Recent Activity
| Recent Logs | Status |
|-------------|--------|
| {log_1} | {status} |
| {log_2} | {status} |
| {log_3} | {status} |
| ... and {N} more |

### Critical Paths
- Entry point: `docs/reference/Ontos_Manual.md`
- Architecture: `.ontos-internal/strategy/...`
- Logs: `.ontos-internal/logs/`

---

## Tier 2: Document Index (~10k tokens)

| Path | ID | Type | Status |
|------|-----|------|--------|
...

---

## Tier 3: Full Graph Details

### Dependency Matrix
...

### Validation Results
...
```

**Tier 1 Hard Cap:**
- Maximum 2k tokens enforced
- Truncate "Recent Activity" to 3 most recent logs
- Add "... and N more" indicators when truncating
- Prioritize: Project summary > Recent activity > Critical paths

**Benefit:** After compaction, reading just Tier 1 (~2k tokens) provides enough orientation to continue or decide to load more.

### 3. Staleness Detection

**Note:** Already implemented in `doctor.py:369-453` as `check_agents_staleness()`.

**Existing behavior:**
- Doctor warns if AGENTS.md is older than context map
- Users can run `ontos doctor` to check staleness

**No new implementation needed** — reference existing check.

---

## Cross-Tool Compatibility

### Tool-Specific Behaviors

| Tool | Instruction File | Re-reads After Compaction? | Notes |
|------|------------------|---------------------------|-------|
| Claude Code | CLAUDE.md | Yes (every turn) | Small file preferred |
| Cursor | .cursorrules | Unknown | Transform from AGENTS.md |
| Gemini | AGENTS.md | Varies | May need explicit prompt |
| Codex | AGENTS.md | Varies | May need explicit prompt |

**Caveat:** Auto-sync provides value only if tools re-read instruction files. This behavior is unverified for most tools. The primary value is the Tiered Context Map (cheaper manual re-activation).

### Strategy

1. **AGENTS.md as universal anchor** — Tool-agnostic, contains activation instructions
2. **CLAUDE.md kept minimal and user-maintained** — References AGENTS.md, user customizes
3. **.cursorrules auto-generated** — Transformed from AGENTS.md via `ontos agents`
4. **Tiered context map** — Any tool reading partially still gets value

### CLAUDE.md (User-Maintained)

```markdown
# CLAUDE.md

## Ontos Activation

This project uses **Ontos** for documentation management.

At the start of every session (or after context loss):
1. Run `ontos map` to generate the context map
2. Read `Ontos_Context_Map.md` (Tier 1 minimum)
3. Read `AGENTS.md` for quick reference

For full instructions, see `AGENTS.md`.
```

**Note:** CLAUDE.md remains user-maintained. Ontos does NOT auto-modify it.

---

## Implementation Plan

### Phase 1: Tiered Context Map

| Task | File(s) | Effort |
|------|---------|--------|
| Restructure map template with tiers | `ontos/commands/map.py` | Medium |
| Add Tier 1 summary generation | `ontos/core/graph.py` | Medium |
| Add "recent activity" summary (logs + in_progress) | `ontos/core/graph.py` | Medium |
| Implement Tier 1 hard cap (~2k tokens) with truncation | `ontos/commands/map.py` | Small |
| Add `ontos-map-version: 2` header | `ontos/commands/map.py` | Small |
| Update tests | `tests/commands/test_map.py` | Small |

### Phase 2: AGENTS.md Sync Flag

| Task | File(s) | Effort |
|------|---------|--------|
| Add `--sync-agents` flag to `ontos map` | `ontos/commands/map.py`, `ontos/cli.py` | Small |
| Add "Current Project State" section to template | `ontos/commands/agents.py` | Medium |
| Add `# USER CUSTOM` section protection | `ontos/commands/agents.py` | Small |
| Add file locking or last-write-wins warning | `ontos/commands/agents.py` | Small |
| Update tests | `tests/commands/test_agents.py` | Small |

### Phase 3: Cross-Tool Polish

| Task | File(s) | Effort |
|------|---------|--------|
| Ensure .cursorrules stays synced when AGENTS.md synced | `ontos/commands/agents.py` | Small |
| Documentation | `docs/reference/Ontos_Manual.md` | Medium |

---

## Testing Strategy

### Unit Tests

- `test_tiered_context_map_structure()` — Tier markers present
- `test_tier1_under_2k_tokens()` — Hard cap enforced
- `test_tier1_contains_essentials()` — Project summary, recent activity present
- `test_tier1_hard_cap_large_repo()` — Truncation works for 100+ doc repos
- `test_agents_sync_flag_only_if_exists()` — No creation without `ontos agents`
- `test_agents_sync_preserves_user_custom()` — USER CUSTOM section untouched
- `test_concurrent_map_access()` — File locking or warning works

### Integration Tests

- `test_activation_after_fresh_clone()` — Full activation flow
- `test_reactivation_minimal()` — Tier 1 provides enough context
- `test_cross_tool_consistency()` — AGENTS.md and .cursorrules aligned
- `test_map_sync_agents_workflow()` — Flag triggers sync correctly

### Manual Verification

- [ ] Run `ontos map`, verify tiered structure
- [ ] Run `ontos map --sync-agents`, verify AGENTS.md updated
- [ ] Run `ontos doctor`, verify staleness warning works
- [ ] Read only Tier 1 of context map, verify sufficient orientation
- [ ] Test with Claude, Cursor, verify activation works
- [ ] Test with 100+ doc repo, verify Tier 1 stays under 2k tokens

---

## Open Questions — Resolved

### Q1: Auto-Sync Scope

**Decision:** **B — Only sync if exists**

Creating files users didn't ask for is intrusive. `ontos agents` remains the explicit creation command.

### Q2: Tier 1 Token Budget

**Decision:** **B — ~2k tokens, with hard cap and overflow handling**

2k is the sweet spot. For large repos, truncate with "... and N more" indicators.

### Q3: Recent Activity Detection

**Decision:** **Modified D — Recent logs + in_progress docs, NO uncommitted changes**

- Recent logs (last 3): Low noise, project-level
- `status: in_progress` docs: Explicit project metadata
- Git branch: Repository state, acceptable
- Uncommitted changes: **Excluded** — too noisy, too slow

**Implementation:** Only read log frontmatter (not full content) for performance.

### Q4: CLAUDE.md Relationship

**Decision:** **B — Keep manual**

CLAUDE.md is often customized with project-specific rules. Ontos does NOT auto-modify it.

---

## Success Criteria

1. **Re-activation cost < 3k tokens** — Tier 1 provides sufficient orientation
2. **Minimal friction re-activation** — Two commands: `ontos map` + read Tier 1
3. **Cross-tool works** — Same flow for Claude, Cursor, Gemini, Codex
4. **No session capture** — Ontos doesn't try to preserve session state
5. **Doctor catches staleness** — Users warned when files out of sync

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Tools don't re-read AGENTS.md** | **High** | Primary value is Tiered Context Map (manual re-activation); document this limitation clearly |
| Auto-sync overwrites user edits | Medium | Backup before overwrite; add `# USER CUSTOM` section protection |
| Tier 1 too large for large repos | Low | Hard cap at 2k tokens with truncation |
| Breaking change to map output | High | Version the format (`ontos-map-version: 2`); migration guide in docs |
| Concurrent `ontos map` runs | Low | File locking or last-write-wins with warning |

---

## Appendix: AGENTS.md Template (Proposed v1.1)

```markdown
# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{version} on {timestamp}

## Current Project State

> Auto-synced: {sync_timestamp}

| Metric | Value |
|--------|-------|
| Branch | {branch} |
| Doc Count | {count} |
| Last Log | {last_log} |
| Health | {health_summary} |

## Ontos Activation

**Run these steps at session start or after context loss:**

1. Run `ontos map` (or `python3 -m ontos map`)
2. Read `Ontos_Context_Map.md` (Tier 1 minimum: first ~2k tokens)
3. Load relevant documents for your task
4. Follow `depends_on` upward as needed
5. Confirm: "Loaded: [ids]"

## Re-Activation Trigger

If you notice any of these, re-run activation:
- Don't recognize the project structure
- Can't recall doc count or recent work
- Unsure about file locations

## Session End

1. Run `ontos log -e "slug"` to archive session work
2. Fill in Goal, Key Decisions, Alternatives, Impacts

## Quick Reference

| Command | Purpose |
|---------|---------|
| `ontos map` | Regenerate context map |
| `ontos map --sync-agents` | Regenerate map + sync AGENTS.md |
| `ontos agents` | Regenerate instruction files |
| `ontos doctor` | Health check and validation |
| `ontos log -e "slug"` | Archive session work |
| `ontos query <id>` | Find document by ID |

## Core Invariants

- Do not edit `Ontos_Context_Map.md` manually
- Do not edit `AGENTS.md` manually (except `# USER CUSTOM` section)
- If a command fails, read the error message

# USER CUSTOM

<!-- Add your project-specific notes below. This section is preserved during auto-sync. -->

## Staleness

If this file shows outdated stats, run `ontos map --sync-agents` to refresh.
```

---

## Appendix: Tiered Context Map Template (Proposed)

```markdown
---
id: ontos_context_map
type: reference
status: generated
generated_by: ontos map
generated_at: {timestamp}
ontos_map_version: 2
---

# {Project} Context Map

> Auto-generated by Ontos {version}
> Last updated: {timestamp}

## Tier 1: Essential Context

### Project Summary

- **Name:** {project_name}
- **Purpose:** {one_line_description}
- **Doc Count:** {doc_count}
- **Last Updated:** {timestamp}

### Recent Activity

| Log | Date | Status |
|-----|------|--------|
| {log_1_slug} | {date} | {status} |
| {log_2_slug} | {date} | {status} |
| {log_3_slug} | {date} | {status} |
| ... and {N} more logs |

### In Progress

| Document | ID |
|----------|-----|
| {doc_1} | {id} |
| {doc_2} | {id} |

### Critical Paths

- **Entry:** `docs/reference/Ontos_Manual.md`
- **Strategy:** `.ontos-internal/strategy/`
- **Logs:** `.ontos-internal/logs/`

---

## Tier 2: Document Index

| Path | ID | Type | Status |
|------|-----|------|--------|
| {path} | {id} | {type} | {status} |
...

---

## Tier 3: Full Graph Details

### Dependency Matrix

...

### Validation Results

...
```

---

## Review Trail

| Phase | Outcome | Date |
|-------|---------|------|
| v1.0 Draft | Submitted for review | 2026-01-29 |
| Gemini (Peer) | Approve with changes | 2026-01-29 |
| Claude (Alignment) | Request changes (2 blocking) | 2026-01-29 |
| Codex (Adversarial) | Request changes (1 blocking) | 2026-01-29 |
| Consolidation | 3 blocking issues identified | 2026-01-29 |
| CA Response | All issues addressed | 2026-01-29 |
| **v1.1 Approved** | Ready for implementation | 2026-01-29 |

---

**Proposal signed by:**
- **Role:** Chief Architect
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-29
- **Version:** v1.1 (Approved)
