---
id: v3_2_ontos_activation_implementation_prompt
type: strategy
status: ready
depends_on: [v3_2_ontos_activation_proposal, v3_2_ontos_activation_ca_response]
concepts: [implementation, antigravity, v3.2, activation]
---

# v3.2 Ontos Activation — Implementation Prompt for Antigravity

**Phase:** v3.2.1 (Ontos Activation Resilience)
**Spec Version:** v1.1 (Approved)
**Risk Level:** MEDIUM (format changes to context map)
**Prepared by:** Chief Architect (Claude Opus 4.5)
**Date:** 2026-01-29

---

## Overview

This implementation delivers **Tiered Context Map** (primary) and **AGENTS.md sync flag** (secondary) to reduce re-activation cost after context compaction. After implementation, users can re-orient with ~2k tokens (Tier 1) instead of ~12k tokens.

**Branch name:** `feature/v3.2.1-ontos-activation`

---

## Pre-Implementation Checklist

```bash
# 1. Start from clean main
git checkout main
git pull origin main

# 2. Create feature branch
git checkout -b feature/v3.2.1-ontos-activation

# 3. Verify tests pass before starting
.venv/bin/pytest tests/ -v

# 4. Read these files before coding:
cat ontos/commands/map.py
cat ontos/commands/agents.py
cat ontos/cli.py
```

---

## Architecture Constraints

**Import rules:**
- Commands (`ontos/commands/`) may import from `ontos/core/` and `ontos/io/`
- `ontos/core/` must NOT import from `ontos/commands/`
- CLI (`ontos/cli.py`) imports from `ontos/commands/`

**Patterns to follow:**
- Use dataclasses for options (see `MapOptions`, `AgentsOptions`)
- Return exit codes (0=success, 1=error, 2=config error)
- Use `CheckResult` for doctor checks

**Verification:**
```bash
# Check no constraint violations
grep -rn "from ontos.commands" ontos/core/
# Should return empty
```

---

## Task Sequence

Complete tasks in order. Run tests after each task. Commit at marked checkpoints.

---

### Task 1: Add `--sync-agents` Flag to Map Command

**Spec Reference:** Section "AGENTS.md Sync Flag"
**Priority:** Must

**Files:**
- `ontos/cli.py` — MODIFY (lines 130-146)
- `ontos/commands/map.py` — MODIFY (lines 437-447, 450-570)

**Step 1.1: Add CLI argument**

**Current Code (`ontos/cli.py:130-146`):**
```python
def _register_map(subparsers, parent):
    """Register map command."""
    p = subparsers.add_parser("map", help="Generate context map", parents=[parent])
    p.add_argument("--strict", action="store_true",
                   help="Treat warnings as errors")
    p.add_argument("--output", "-o", type=Path,
                   help="Output path (default: Ontos_Context_Map.md)")
    p.add_argument("--obsidian", action="store_true",
                   help="Enable Obsidian-compatible output (wikilinks, tags)")
    p.add_argument("--compact", nargs="?", const="basic", default="off",
                   choices=["basic", "rich"],
                   help="Compact output: 'basic' (default) or 'rich' (with summaries)")
    p.add_argument("--filter", "-f", metavar="EXPR",
                   help="Filter documents by expression (e.g., 'type:strategy')")
    p.add_argument("--no-cache", action="store_true",
                   help="Bypass document cache (for debugging)")
    p.set_defaults(func=_cmd_map)
```

**New Code (`ontos/cli.py:130-148`):**
```python
def _register_map(subparsers, parent):
    """Register map command."""
    p = subparsers.add_parser("map", help="Generate context map", parents=[parent])
    p.add_argument("--strict", action="store_true",
                   help="Treat warnings as errors")
    p.add_argument("--output", "-o", type=Path,
                   help="Output path (default: Ontos_Context_Map.md)")
    p.add_argument("--obsidian", action="store_true",
                   help="Enable Obsidian-compatible output (wikilinks, tags)")
    p.add_argument("--compact", nargs="?", const="basic", default="off",
                   choices=["basic", "rich"],
                   help="Compact output: 'basic' (default) or 'rich' (with summaries)")
    p.add_argument("--filter", "-f", metavar="EXPR",
                   help="Filter documents by expression (e.g., 'type:strategy')")
    p.add_argument("--no-cache", action="store_true",
                   help="Bypass document cache (for debugging)")
    p.add_argument("--sync-agents", action="store_true",
                   help="Also sync AGENTS.md if it exists")
    p.set_defaults(func=_cmd_map)
```

**Step 1.2: Update MapOptions dataclass**

**Current Code (`ontos/commands/map.py:437-447`):**
```python
@dataclass
class MapOptions:
    """CLI-level options for map command."""
    output: Optional[Path] = None
    strict: bool = False
    json_output: bool = False
    quiet: bool = False
    obsidian: bool = False
    compact: CompactMode = CompactMode.OFF
    filter_expr: Optional[str] = None
    no_cache: bool = False
```

**New Code (`ontos/commands/map.py:437-448`):**
```python
@dataclass
class MapOptions:
    """CLI-level options for map command."""
    output: Optional[Path] = None
    strict: bool = False
    json_output: bool = False
    quiet: bool = False
    obsidian: bool = False
    compact: CompactMode = CompactMode.OFF
    filter_expr: Optional[str] = None
    no_cache: bool = False
    sync_agents: bool = False
```

**Step 1.3: Update CLI handler**

**Current Code (`ontos/cli.py:531-546`):**
```python
def _cmd_map(args) -> int:
    """Handle map command."""
    from ontos.commands.map import map_command, MapOptions

    options = MapOptions(
        output=args.output,
        strict=args.strict,
        json_output=args.json,
        quiet=args.quiet,
        obsidian=args.obsidian,
        compact=CompactMode(args.compact) if args.compact != "off" else CompactMode.OFF,
        filter_expr=getattr(args, 'filter', None),
        no_cache=getattr(args, 'no_cache', False),
    )

    return map_command(options)
```

**New Code (`ontos/cli.py:531-547`):**
```python
def _cmd_map(args) -> int:
    """Handle map command."""
    from ontos.commands.map import map_command, MapOptions

    options = MapOptions(
        output=args.output,
        strict=args.strict,
        json_output=args.json,
        quiet=args.quiet,
        obsidian=args.obsidian,
        compact=CompactMode(args.compact) if args.compact != "off" else CompactMode.OFF,
        filter_expr=getattr(args, 'filter', None),
        no_cache=getattr(args, 'no_cache', False),
        sync_agents=getattr(args, 'sync_agents', False),
    )

    return map_command(options)
```

**Step 1.4: Implement sync logic in map_command**

Find the end of `map_command()` function (around line 544 where it writes the file). Add sync logic AFTER writing the context map but BEFORE returning.

**Add this code after line 544 (after `output_path.write_text(content, encoding='utf-8')`):**

```python
    # Sync AGENTS.md if flag is set and file exists
    if options.sync_agents:
        from ontos.commands.agents import find_repo_root
        repo_root = find_repo_root()
        if repo_root:
            agents_path = repo_root / "AGENTS.md"
            if agents_path.exists():
                if not options.quiet:
                    print("Syncing AGENTS.md...")
                from ontos.commands.agents import agents_command, AgentsOptions
                agents_command(AgentsOptions(force=True))
                if not options.quiet:
                    print("✓ AGENTS.md synced")
            else:
                if not options.quiet:
                    print("⚠ AGENTS.md not found. Run 'ontos agents' to create.")
```

**Test:**
```bash
.venv/bin/pytest tests/commands/test_map.py -v
```

**Manual Verification:**
```bash
# First create AGENTS.md
.venv/bin/python -m ontos agents --force

# Test sync flag
.venv/bin/python -m ontos map --sync-agents
# Expected: Should see "Syncing AGENTS.md..." and "✓ AGENTS.md synced"

# Test without AGENTS.md
rm AGENTS.md
.venv/bin/python -m ontos map --sync-agents
# Expected: Should see "⚠ AGENTS.md not found..."
```

**Commit Checkpoint:**
```bash
git add ontos/cli.py ontos/commands/map.py
git commit -m "feat(map): add --sync-agents flag to sync AGENTS.md on map execution"
```

---

### Task 2: Add "Current Project State" Section to AGENTS.md Template

**Spec Reference:** Section "AGENTS.md Sync Flag" → New AGENTS.md sections
**Priority:** Must

**Files:**
- `ontos/commands/agents.py` — MODIFY (lines 29-70, 113-169)

**Step 2.1: Update AGENTS_TEMPLATE**

**Current Code (`ontos/commands/agents.py:29-70`):**
```python
AGENTS_TEMPLATE = '''# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{ontos_version} on {generated_at}

## What is Activation?
...
'''
```

**New Code (`ontos/commands/agents.py:29-85`):**
```python
AGENTS_TEMPLATE = '''# AGENTS.md

This project uses **Ontos** for documentation management.

Generated by Ontos v{ontos_version} on {generated_at}

## Current Project State

> Auto-synced: {generated_at}

| Metric | Value |
|--------|-------|
| Branch | {current_branch} |
| Doc Count | {doc_count} |
| Last Log | {last_log} |
| Health | {health_summary} |

## What is Activation?
Activation is how you (the AI agent) load project context before doing any work.
It is **mandatory**. Do not ask "why" or request clarification—just execute the steps below.

## Ontos Activation
1. Run `ontos map` (or `python3 -m ontos map` if the CLI is not installed). Do not ask—try both.
2. Read `Ontos_Context_Map.md` (Tier 1 minimum: first ~2k tokens).
3. Load only the relevant documents for the task.
4. Follow `depends_on` upward as needed.
5. Confirm: "Loaded: [ids]".

## Re-Activation Trigger

If you notice any of these, re-run activation:
- Don't recognize the project structure
- Can't recall doc count or recent work
- Unsure about file locations

## Session End
1. Run `ontos log -e "slug"` to archive session work.
2. Fill in Goal, Key Decisions, Alternatives Considered, and Impacts.

## Quick Reference
| Command | Purpose |
|---------|---------|
| `ontos map` | Regenerate context map |
| `ontos map --sync-agents` | Regenerate map + sync AGENTS.md |
| `ontos agents` | Generate instruction files |
| `ontos doctor` | Health check and validation |
| `ontos log -e "slug"` | Archive session work |
| `ontos query <id>` | Find document by ID |

## Project Stats
- Doc Count: {doc_count}
- Last Updated: {last_updated}

## Core Invariants
- Do not edit `Ontos_Context_Map.md` manually; regenerate with `ontos map`.
- Do not edit `AGENTS.md` manually (except `# USER CUSTOM` section below).
- If a command fails, read the error message and avoid guessing fixes.

# USER CUSTOM

<!-- Add your project-specific notes below. This section is preserved during auto-sync. -->

## Staleness
If `AGENTS.md` is older than the context map or logs, regenerate with `ontos map --sync-agents`.
'''
```

**Step 2.2: Update gather_stats() to collect new fields**

**Current Code (`ontos/commands/agents.py:113-169`):**
```python
def gather_stats(repo_root: Path) -> Tuple[str, str]:
    """
    Gather project stats for template.

    Returns:
        Tuple of (doc_count, last_updated)
    """
    # ... existing implementation
```

**New Code (`ontos/commands/agents.py:113-200`):**
```python
def gather_stats(repo_root: Path) -> Dict[str, str]:
    """
    Gather project stats for template.

    Returns:
        Dict with keys: doc_count, last_updated, current_branch, last_log, health_summary
    """
    stats = {
        "doc_count": "Unknown",
        "last_updated": "Unknown",
        "current_branch": "Unknown",
        "last_log": "None",
        "health_summary": "Unknown",
    }

    try:
        # Load config to find docs directory
        config_path = repo_root / ".ontos.toml"
        docs_dir = repo_root / ".ontos-internal"  # Default
        logs_dir = repo_root / ".ontos-internal" / "logs"
        context_map = repo_root / "Ontos_Context_Map.md"

        if config_path.exists():
            try:
                from ontos.io.config import load_project_config
                config = load_project_config()
                docs_dir = repo_root / config.paths.docs_dir
                logs_dir = repo_root / config.paths.logs_dir
                context_map = repo_root / config.paths.context_map
            except Exception:
                pass  # Keep defaults

        # Count .md files (cap at 5000)
        count = 0
        if docs_dir.exists():
            for _ in docs_dir.rglob("*.md"):
                count += 1
                if count >= 5000:
                    stats["doc_count"] = "5000+"
                    break
            else:
                stats["doc_count"] = str(count)

        # Find max mtime
        mtimes = []
        for path in [context_map, config_path]:
            if path.exists():
                mtimes.append(path.stat().st_mtime)

        if logs_dir.exists():
            for log_file in logs_dir.glob("*.md"):
                mtimes.append(log_file.stat().st_mtime)

        if mtimes:
            max_mtime = max(mtimes)
            dt = datetime.fromtimestamp(max_mtime, tz=timezone.utc)
            stats["last_updated"] = dt.strftime("%Y-%m-%d %H:%M:%S UTC")

        # Get current git branch
        try:
            result = subprocess.run(
                ["git", "rev-parse", "--abbrev-ref", "HEAD"],
                capture_output=True,
                text=True,
                timeout=5,
                cwd=repo_root
            )
            if result.returncode == 0:
                stats["current_branch"] = result.stdout.strip()
        except (subprocess.TimeoutExpired, FileNotFoundError):
            pass

        # Get most recent log (by filename, assumes YYYY-MM-DD prefix)
        if logs_dir.exists():
            log_files = sorted(logs_dir.glob("*.md"), reverse=True)
            if log_files:
                stats["last_log"] = log_files[0].stem

        # Get health summary (simple version - just check if context map exists)
        if context_map.exists():
            stats["health_summary"] = "✓ Map exists"
        else:
            stats["health_summary"] = "⚠ No map"

    except Exception:
        pass  # Keep defaults on any error

    return stats
```

**Step 2.3: Update generate_agents_content() to use new stats**

**Current Code (`ontos/commands/agents.py:172-184`):**
```python
def generate_agents_content() -> str:
    """Generate AGENTS.md content with stats."""
    repo_root = find_repo_root()
    doc_count, last_updated = gather_stats(repo_root)

    generated_at = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")

    return AGENTS_TEMPLATE.format(
        ontos_version=ontos.__version__,
        generated_at=generated_at,
        doc_count=doc_count,
        last_updated=last_updated,
    )
```

**New Code (`ontos/commands/agents.py:202-220`):**
```python
def generate_agents_content() -> str:
    """Generate AGENTS.md content with stats."""
    repo_root = find_repo_root()
    stats = gather_stats(repo_root)

    generated_at = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")

    return AGENTS_TEMPLATE.format(
        ontos_version=ontos.__version__,
        generated_at=generated_at,
        doc_count=stats["doc_count"],
        last_updated=stats["last_updated"],
        current_branch=stats["current_branch"],
        last_log=stats["last_log"],
        health_summary=stats["health_summary"],
    )
```

**Test:**
```bash
.venv/bin/pytest tests/commands/test_agents.py -v
```

**Manual Verification:**
```bash
.venv/bin/python -m ontos agents --force
cat AGENTS.md
# Expected: Should see "Current Project State" section with Branch, Doc Count, etc.
```

**Commit Checkpoint:**
```bash
git add ontos/commands/agents.py
git commit -m "feat(agents): add current project state section with branch, doc count, last log"
```

---

### Task 3: Implement Tiered Context Map Structure

**Spec Reference:** Section "Tiered Context Map"
**Priority:** Must

**Files:**
- `ontos/commands/map.py` — MODIFY (lines 46-109, 112-303)

**Step 3.1: Add version header to frontmatter**

Update `_generate_header()` to include version marker.

**Find `_generate_header()` (around line 112-135) and modify frontmatter:**

Add `ontos_map_version: 2` to the YAML frontmatter section.

**Step 3.2: Create new Tier 1 section generator**

Add this new function BEFORE `_generate_document_table()` (around line 149):

```python
def _generate_tier1_summary(
    docs: Dict[str, DocumentData],
    config: Dict[str, Any],
    options: GenerateMapOptions = None
) -> str:
    """Generate Tier 1: Essential Context (~2k tokens).

    Includes: Project summary, recent activity, critical paths.
    Hard cap at ~2000 tokens with truncation.
    """
    lines = ["## Tier 1: Essential Context"]
    lines.append("")

    # Project Summary
    lines.append("### Project Summary")
    project_name = config.get("project", {}).get("name", "Unknown Project")
    lines.append(f"- **Name:** {project_name}")
    lines.append(f"- **Doc Count:** {len(docs)}")
    lines.append(f"- **Last Updated:** {datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')}")
    lines.append("")

    # Recent Activity (from logs, limit to 3)
    lines.append("### Recent Activity")
    log_docs = [d for d in docs.values() if d.doc_type == "log"]
    log_docs_sorted = sorted(log_docs, key=lambda d: d.id, reverse=True)[:3]

    if log_docs_sorted:
        lines.append("| Log | Status |")
        lines.append("|-----|--------|")
        for doc in log_docs_sorted:
            status = doc.frontmatter.get("status", "unknown")
            lines.append(f"| {doc.id} | {status} |")

        remaining = len(log_docs) - 3
        if remaining > 0:
            lines.append(f"| ... and {remaining} more logs | |")
    else:
        lines.append("No recent logs found.")
    lines.append("")

    # In Progress Documents
    in_progress = [d for d in docs.values() if d.frontmatter.get("status") == "in_progress"]
    if in_progress:
        lines.append("### In Progress")
        lines.append("| Document | ID |")
        lines.append("|----------|-----|")
        for doc in in_progress[:5]:
            lines.append(f"| {doc.filepath.name} | {doc.id} |")
        if len(in_progress) > 5:
            lines.append(f"| ... and {len(in_progress) - 5} more | |")
        lines.append("")

    # Critical Paths (static for now, could be configurable)
    lines.append("### Critical Paths")
    lines.append("- **Entry:** `docs/reference/Ontos_Manual.md`")
    lines.append("- **Strategy:** `.ontos-internal/strategy/`")
    lines.append("- **Logs:** `.ontos-internal/logs/`")
    lines.append("")

    lines.append("---")
    lines.append("")

    return "\n".join(lines)
```

**Step 3.3: Add Tier markers to existing sections**

Modify `generate_context_map()` (lines 46-109) to structure output with tier markers:

**Current structure:**
```python
def generate_context_map(...):
    sections = [
        _generate_header(...),
        _generate_document_table(...),
        _generate_validation_section(...),
        ...
    ]
```

**New structure:**
```python
def generate_context_map(...):
    sections = [
        _generate_header(...),
        _generate_tier1_summary(docs, config, options),  # NEW - Tier 1
        "## Tier 2: Document Index",  # NEW - Tier 2 marker
        "",
        _generate_document_table(...),
        "",
        "## Tier 3: Full Graph Details",  # NEW - Tier 3 marker
        "",
        _generate_validation_section(...),
        _generate_dependency_tree(...),
        _generate_timeline(...),
        _generate_staleness_section(...),
        _generate_lint_section(...) if options and options.include_lint else None,
    ]
```

**Test:**
```bash
.venv/bin/pytest tests/commands/test_map.py -v
```

**Manual Verification:**
```bash
.venv/bin/python -m ontos map
head -100 Ontos_Context_Map.md
# Expected: Should see "Tier 1: Essential Context" section at top
```

**Commit Checkpoint:**
```bash
git add ontos/commands/map.py
git commit -m "feat(map): implement tiered context map structure (Tier 1/2/3)"
```

---

### Task 4: Add Tests

**Spec Reference:** Testing Strategy
**Priority:** Must

**Files:**
- `tests/commands/test_map.py` — MODIFY
- `tests/commands/test_agents.py` — MODIFY

**Step 4.1: Add map sync-agents tests**

Add to `tests/commands/test_map.py`:

```python
def test_map_sync_agents_flag_exists():
    """--sync-agents flag is recognized."""
    import subprocess
    result = subprocess.run(
        [sys.executable, "-m", "ontos", "map", "--help"],
        capture_output=True,
        text=True
    )
    assert "--sync-agents" in result.stdout


def test_map_sync_agents_updates_agents_md(tmp_path, monkeypatch):
    """When --sync-agents is set and AGENTS.md exists, it gets updated."""
    # Setup: Create minimal ontos project
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".ontos.toml").write_text("[project]\nname = 'test'\n")
    (tmp_path / ".ontos-internal").mkdir()

    # Create initial AGENTS.md
    agents_path = tmp_path / "AGENTS.md"
    agents_path.write_text("# Old content")
    old_mtime = agents_path.stat().st_mtime

    import time
    time.sleep(0.1)  # Ensure mtime difference

    # Run map with --sync-agents
    from ontos.commands.map import map_command, MapOptions
    map_command(MapOptions(sync_agents=True))

    # Verify AGENTS.md was updated
    new_content = agents_path.read_text()
    assert "Current Project State" in new_content
    assert agents_path.stat().st_mtime > old_mtime


def test_map_sync_agents_no_create_if_missing(tmp_path, monkeypatch):
    """When --sync-agents is set but AGENTS.md doesn't exist, don't create it."""
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".ontos.toml").write_text("[project]\nname = 'test'\n")
    (tmp_path / ".ontos-internal").mkdir()

    agents_path = tmp_path / "AGENTS.md"
    assert not agents_path.exists()

    from ontos.commands.map import map_command, MapOptions
    map_command(MapOptions(sync_agents=True))

    # AGENTS.md should NOT be created
    assert not agents_path.exists()
```

**Step 4.2: Add tiered context map tests**

Add to `tests/commands/test_map.py`:

```python
def test_tiered_context_map_has_tier_markers(tmp_path, monkeypatch):
    """Context map includes Tier 1, 2, 3 section markers."""
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".ontos.toml").write_text("[project]\nname = 'test'\n")
    (tmp_path / ".ontos-internal").mkdir()

    from ontos.commands.map import map_command, MapOptions
    map_command(MapOptions())

    content = (tmp_path / "Ontos_Context_Map.md").read_text()
    assert "## Tier 1: Essential Context" in content
    assert "## Tier 2: Document Index" in content
    assert "## Tier 3: Full Graph Details" in content


def test_tier1_contains_project_summary(tmp_path, monkeypatch):
    """Tier 1 includes project summary section."""
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".ontos.toml").write_text("[project]\nname = 'TestProject'\n")
    (tmp_path / ".ontos-internal").mkdir()

    from ontos.commands.map import map_command, MapOptions
    map_command(MapOptions())

    content = (tmp_path / "Ontos_Context_Map.md").read_text()
    assert "### Project Summary" in content
    assert "TestProject" in content or "Doc Count" in content
```

**Step 4.3: Add agents template tests**

Add to `tests/commands/test_agents.py`:

```python
def test_agents_template_has_current_state_section(tmp_path, monkeypatch):
    """AGENTS.md includes Current Project State section."""
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".git").mkdir()
    (tmp_path / ".ontos-internal").mkdir()

    from ontos.commands.agents import agents_command, AgentsOptions
    agents_command(AgentsOptions(force=True))

    content = (tmp_path / "AGENTS.md").read_text()
    assert "## Current Project State" in content
    assert "Branch" in content
    assert "Doc Count" in content


def test_agents_template_has_user_custom_section(tmp_path, monkeypatch):
    """AGENTS.md includes USER CUSTOM section for preservation."""
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".git").mkdir()

    from ontos.commands.agents import agents_command, AgentsOptions
    agents_command(AgentsOptions(force=True))

    content = (tmp_path / "AGENTS.md").read_text()
    assert "# USER CUSTOM" in content


def test_agents_template_has_reactivation_trigger(tmp_path, monkeypatch):
    """AGENTS.md includes Re-Activation Trigger section."""
    monkeypatch.chdir(tmp_path)
    (tmp_path / ".git").mkdir()

    from ontos.commands.agents import agents_command, AgentsOptions
    agents_command(AgentsOptions(force=True))

    content = (tmp_path / "AGENTS.md").read_text()
    assert "## Re-Activation Trigger" in content
```

**Test:**
```bash
.venv/bin/pytest tests/commands/test_map.py tests/commands/test_agents.py -v
```

**Commit Checkpoint:**
```bash
git add tests/commands/test_map.py tests/commands/test_agents.py
git commit -m "test(activation): add tests for sync-agents flag and tiered context map"
```

---

## Regression Testing Protocol

**After EVERY task:**
```bash
# Run affected test file
.venv/bin/pytest tests/commands/test_map.py -v
.venv/bin/pytest tests/commands/test_agents.py -v

# Run full suite before committing
.venv/bin/pytest tests/ -v
```

**If tests fail:**
1. Do NOT proceed to next task
2. Fix the failure
3. Re-run tests
4. Only continue when green

---

## Final Verification

**Before creating PR:**

```bash
# 1. Full test suite
.venv/bin/pytest tests/ -v

# 2. Manual smoke tests
.venv/bin/python -m ontos map
head -80 Ontos_Context_Map.md
# Verify: Tiered structure visible

.venv/bin/python -m ontos agents --force
cat AGENTS.md
# Verify: Current Project State section present

.venv/bin/python -m ontos map --sync-agents
# Verify: "Syncing AGENTS.md..." message appears

.venv/bin/python -m ontos doctor
# Verify: No new errors

# 3. Verify no architecture violations
grep -rn "from ontos.commands" ontos/core/
# Should be empty

# 4. Check commit history is clean
git log --oneline feature/v3.2.1-ontos-activation ^main
```

---

## PR Preparation

**Branch:** `feature/v3.2.1-ontos-activation`

**PR Title:** `feat: v3.2.1 Ontos Activation Resilience`

**PR Description:**
```markdown
## Summary

Implements v3.2.1 Ontos Activation Resilience per approved spec v1.1.

## Changes

- [x] `ontos map --sync-agents` flag to optionally sync AGENTS.md
- [x] Context map now has tiered structure (Tier 1: ~2k tokens)
- [x] AGENTS.md template updated with Current Project State section
- [x] AGENTS.md template includes USER CUSTOM section for preservation
- [x] Re-Activation Trigger section added to AGENTS.md

## Spec Compliance

- Spec: `.ontos-internal/strategy/proposals/v3.2/v3.2_ontos_activation/v3.2_ontos_activation.md` (v1.1)
- CA Response: `.ontos-internal/strategy/proposals/v3.2/v3.2_ontos_activation/v3.2_Chief_Architect_Response.md`

## Testing

- [x] All existing tests pass
- [x] New tests added for --sync-agents flag
- [x] New tests added for tiered context structure
- [x] New tests added for AGENTS.md template changes
- [x] Manual verification completed

## Breaking Changes

- Context map format changed (Tier markers added) - regenerate with `ontos map`
- AGENTS.md format changed - regenerate with `ontos agents --force`
```

**Expected Commits:**
1. `feat(map): add --sync-agents flag to sync AGENTS.md on map execution`
2. `feat(agents): add current project state section with branch, doc count, last log`
3. `feat(map): implement tiered context map structure (Tier 1/2/3)`
4. `test(activation): add tests for sync-agents flag and tiered context map`

---

## Blockers & Escalation

**If you encounter:**
- Unclear instructions → Flag and wait for CA clarification
- Conflicting existing code → Flag, don't guess
- Test failures you can't resolve → Flag with error output
- Scope questions → Don't expand scope, flag for CA

**Do NOT:**
- Make architectural decisions
- Add features not in spec
- Skip tests
- Deviate from spec

---

**Implementation prompt prepared by:**
- **Role:** Chief Architect
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-29
- **Spec Version:** v1.1
