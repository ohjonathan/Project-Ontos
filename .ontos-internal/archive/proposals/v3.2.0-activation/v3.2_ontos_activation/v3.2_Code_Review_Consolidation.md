# v3.2 Ontos Activation — Code Review Consolidation (D.3)

**Consolidation Date:** 2026-01-29  
**PR:** [#59](https://github.com/ohjonathan/Project-Ontos/pull/59)  
**Input Reviews:** CA (D.1), Claude (Alignment), Codex (Adversarial)

> [!NOTE]
> Gemini Peer Code Review not yet posted at time of consolidation. Update this document when available.

---

## 1. Verdict Summary

| Reviewer | Role | Verdict | Blocking Issues |
|----------|------|---------|-----------------|
| Chief Architect | First-Pass (D.1) | ✅ Approve | 0 |
| Claude | Alignment | ✅ Approve | 0 |
| Codex | Adversarial | ⚠️ Request Changes | 2 High, 4 Medium |
| Gemini | Peer | ⏳ Pending | — |

**Consensus:** 2/3 Approve (CA + Claude approve; Codex requests changes)

**Overall Status:** Fixes Required

---

## 2. Blocking Issues

| # | Issue | Flagged By | Category | File(s) | Severity |
|---|-------|------------|----------|---------|----------|
| B1 | Tier 1 token cap not enforced — uses char slice (8000 chars), not token-based truncation | Codex | Bug | `map.py:199` | High |
| B2 | USER CUSTOM preservation replaces entire tail — template updates below it never apply | Codex | Bug | `agents.py:250` | High |
| B3 | Tier 1 tables don't escape pipes/newlines in summaries | Codex | Bug | `map.py:161` | Medium |
| B4 | Sync errors swallowed — failures masked | Codex | Bug | `map.py:623` | Low |

---

## 3. Required Actions for Antigravity

**Priority 1 — Must Fix (Blocking):**

| # | Action | Addresses | File(s) | Guidance |
|---|--------|-----------|---------|----------|
| 1 | Implement proper token-based truncation for Tier 1 | B1 | `map.py:199` | Replace character slice with token estimation; truncate at section boundaries |
| 2 | Update USER CUSTOM preservation to only preserve custom section, not entire tail | B2 | `agents.py:250` | Parse and extract only content between `<!-- USER CUSTOM -->` markers |

**Priority 2 — Should Fix (Non-Blocking):**

| # | Action | Addresses | File(s) |
|---|--------|-----------|---------|
| 1 | Escape pipes (`\|`) and newlines in Tier 1 table cells | B3 | `map.py:161` |
| 2 | Log sync errors instead of swallowing | B4 | `map.py:623` |
| 3 | Sort recent logs by frontmatter date, not ID string | Codex | `map.py:158` |

**Priority 3 — Consider (Minor/Nitpicks):**

| # | Action | Addresses |
|---|--------|-----------|
| 1 | Fix formatting artifact at AGENTS.md line 56-57 | CA M1 |
| 2 | Performance optimization for `gather_stats` on large repos | Codex |

---

## 4. Spec Compliance Summary

From Claude Alignment Review:

| Requirement | Status | Issue (if any) |
|-------------|--------|----------------|
| AGENTS.md auto-sync via `--sync-agents` | ✅ | None |
| Sync only if AGENTS.md exists (Q1-B) | ✅ | None |
| Tiered context map (Tier 1/2/3) | ✅ | None |
| Tier 1 token budget (~2k with cap) | ⚠️ | Token cap uses char approximation (B1) |
| Staleness detection | ✅ | Already in `doctor.py` — correctly not duplicated |
| CLAUDE.md kept manual (Q4-B) | ✅ | None |
| USER CUSTOM protection | ⚠️ | Preservation logic flawed (B2) |
| Format versioning (`ontos_map_version: 2`) | ✅ | None |
| Recent Activity (Q3: logs + in_progress, no uncommitted) | ✅ | Sorting by ID, not date (minor) |

**Spec deviations requiring fix:** B1 (token cap), B2 (USER CUSTOM)

---

## 5. Test Gaps

| Missing/Inadequate Test | Raised By | Priority |
|-------------------------|-----------|----------|
| Token overflow handling (Tier 1 > 2k tokens) | Codex | Should |
| USER CUSTOM preservation with template changes below | Codex | Must |
| Pipe/newline escaping in table cells | Codex | Could |
| Large repo performance for `gather_stats` | Codex | Could |

---

## 6. Edge Cases & Regressions

From Codex Adversarial Review:

| Issue | Status | Action Required |
|-------|--------|-----------------|
| Tier 1 exceeds 2k tokens on large projects | Confirmed | Fix (B1) |
| USER CUSTOM blocks template evolution | Confirmed | Fix (B2) |
| Recent Activity sorted by ID string, not date | Confirmed | Fix (log IDs include date, so low priority) |
| `gather_stats` slow on large repos | Unconfirmed | Defer (profile if needed) |
| Sync errors swallowed | Confirmed | Fix (add logging) |

---

## 7. Agreement Analysis

**Strong Agreement (All 3 reviewers):**

| Issue/Observation | Reviewers |
|-------------------|-----------|
| Spec compliance overall is good | CA, Claude, Codex |
| All existing tests pass (549) | CA, Claude, Codex |
| No architecture violations | CA, Claude |
| Single-responsibility preserved via opt-in flag | CA, Claude |

**Disagreement:**

| Topic | Positions | Consolidation Recommendation |
|-------|-----------|------------------------------|
| Overall readiness | CA/Claude: Approve; Codex: Request Changes | Fix B1/B2 before merge |
| Token cap implementation | Claude: Acceptable approximation; Codex: Bug | Fix to use proper token counting |

---

## 8. Non-Blocking Observations

| Observation | Raised By | Recommendation |
|-------------|-----------|----------------|
| File locking for concurrent access not implemented | Claude A-m3 | Defer — low priority per spec |
| Token cap uses character approximation | Claude A-m2 | Fix (per Codex) |
| Exit code is 1 due to map warnings | CA M2 | Track — expected behavior |
| `gather_stats` scans entire repo | Codex | Track — profile if becomes issue |

---

## 9. Verification Requirements

After Antigravity fixes:

| Fix | Verifier | Verification Method |
|-----|----------|---------------------|
| B1: Token cap | Codex | Test with large project, verify Tier 1 ≤ 2k tokens |
| B2: USER CUSTOM | Codex | Test template update with existing custom content |
| B3: Table escaping | Codex | Test log summary with pipe character |
| B4: Sync errors | Codex | Test with intentional sync failure |

---

## 10. Decision Summary

**PR Status:** Fixes Required

**Antigravity must:**
1. [ ] Fix Tier 1 token cap (B1) — use proper token estimation, not char slice
2. [ ] Fix USER CUSTOM preservation (B2) — preserve only custom section
3. [ ] Add test for token overflow handling
4. [ ] Add test for USER CUSTOM with template changes
5. [ ] (Should) Escape pipes/newlines in tables (B3)
6. [ ] (Should) Log sync errors (B4)
7. [ ] Post fix summary to PR #59
8. [ ] Request D.5 Codex Verification

---

## 11. Post to PR

```markdown
## Code Review Consolidation (D.3)

**Status:** Fixes Required  
**Consensus:** 2/3 Approve (CA ✅, Claude ✅, Codex ⚠️)

### Blocking Issues

| # | Issue | Category | File |
|---|-------|----------|------|
| B1 | Tier 1 token cap uses char slice, not tokens | Bug | `map.py:199` |
| B2 | USER CUSTOM preservation blocks template updates | Bug | `agents.py:250` |

### Required Fixes for Antigravity

**Must Fix:**
- [ ] B1: Implement proper token-based truncation for Tier 1
- [ ] B2: Fix USER CUSTOM preservation to only preserve custom section

**Should Fix:**
- [ ] B3: Escape pipes/newlines in Tier 1 table cells
- [ ] B4: Log sync errors instead of swallowing
- [ ] Sort recent logs by date, not ID string

**Tests to Add:**
- [ ] Token overflow handling
- [ ] USER CUSTOM with template changes

### Spec Compliance
Compliant with 2 deviations requiring fixes (B1, B2).

### Next Steps
1. Antigravity fixes B1, B2 (and B3, B4 if time permits)
2. Post fix summary to PR
3. D.5 Codex Verification
4. D.6 CA Final Approval

---

<details>
<summary>Full Consolidation Details</summary>

See: `.ontos-internal/strategy/proposals/v3.2/v3.2_ontos_activation/v3.2_Code_Review_Consolidation.md`

</details>

---
*Consolidation signed by: Gemini 2.5 Pro (Antigravity) | 2026-01-29*
```

---

## Consolidation Checklist

- [x] All Critical/Major issues from each review appear in Blocking Issues
- [x] Actions are specific and actionable
- [x] Files and locations specified
- [x] Disagreements between reviewers flagged
- [x] Verification requirements clear
- [x] PR comment ready to post

---

**Consolidation signed by:**
- **Role:** Consolidator
- **Model:** Gemini 2.5 Pro, powered by Antigravity
- **Date:** 2026-01-29
- **Input Reviews:** CA (D.1), Claude (Alignment), Codex (Adversarial)
