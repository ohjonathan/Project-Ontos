---
id: v3_2_code_review_alignment_claude
type: atom
status: complete
depends_on: [v3_2_ontos_activation_proposal, v3_2_ontos_activation_ca_response]
concepts: [code-review, alignment, d2-review, pr-59]
---

# v3.2 Ontos Activation — Code Review (Alignment)

**Review signed by:**
- **Role:** Alignment Reviewer
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-29
- **Review Type:** Code Review (D.2)

**PR:** https://github.com/ohjona/Project-Ontos/pull/59

---

## 1. Spec Compliance — Detailed Check

### Requirement: AGENTS.md Sync via `--sync-agents` Flag

**Spec says (v1.1, Section 1):**
> Sync AGENTS.md when `ontos map --sync-agents` is used.
> `ontos map` remains a pure read-operation (single responsibility)

**Code does:**
- `map.py:520` adds `sync_agents: bool = False` to `MapOptions`
- `map.py:618-641` implements sync logic
- `cli.py:145-146` adds CLI flag: `--sync-agents`

**Compliant?** Yes

---

### Requirement: Auto-Sync Only If AGENTS.md Exists

**Spec says (v1.1, Q1 Decision):**
> **B — Only sync if exists**. Creating files users didn't ask for is intrusive.

**Code does:**
- `map.py:625`: `if agents_path.exists():` — only syncs if file exists
- `map.py:634-635`: Prints warning if missing

**Compliant?** Yes

---

### Requirement: "Current Project State" Section

**Spec says (v1.1, Appendix):**
> New AGENTS.md sections with Branch, Doc Count, Last Log, Health

**Code does:**
- `agents.py:35-46` adds "Current Project State" section to template
- `agents.py:133-230` implements `gather_stats()` with all required fields

**Compliant?** Yes

---

### Requirement: Tiered Context Map Structure

**Spec says (v1.1, Section 2):**
> Structure `Ontos_Context_Map.md` with 3 tiers

**Code does:**
- `map.py:70-87` restructures output with explicit tier sections
- Header explains tier structure (lines 131-135)

**Compliant?** Yes

---

### Requirement: Tier 1 Token Budget (~2k with hard cap)

**Spec says (v1.1, Q2 Decision):**
> **B — ~2k tokens, with hard cap and overflow handling**

**Code does:**
- `map.py:140-205` implements `_generate_tier1_summary()` with:
  - 3 log limit with "... and N more logs" indicator
  - 5 in_progress limit
  - Hard cap: `if estimate_tokens(content) > 2000`

**Compliant?** Yes

---

### Requirement: Staleness Detection in Doctor

**Spec says (v1.1, Section 3):**
> Already implemented in `doctor.py:369-453`. No new implementation needed.

**Code does:**
- No changes to `doctor.py` — correctly avoided duplication

**Compliant?** Yes

---

### Requirement: Format Versioning

**Spec says (v1.1, Risks section):**
> Version the format (`ontos-map-version: 2`)

**Code does:**
- `map.py:124`: Adds `ontos_map_version: 2` to frontmatter

**Compliant?** Yes

---

### Requirement: USER CUSTOM Section Protection

**Spec says (v1.1, Implementation Plan):**
> Add `# USER CUSTOM` section protection

**Code does:**
- `agents.py:85-89` adds USER CUSTOM section to template
- `agents.py:268-277` preserves custom content during regeneration

**Compliant?** Yes

---

### Requirement: CLAUDE.md Kept Manual

**Spec says (v1.1, Q4 Decision):**
> **B — Keep manual**. Ontos does NOT auto-modify it.

**Code does:**
- No changes to CLAUDE.md handling
- `map --sync-agents` only syncs AGENTS.md

**Compliant?** Yes

---

### Requirement: Recent Activity Detection (Modified D)

**Spec says (v1.1, Q3 Decision):**
> Recent logs + in_progress docs. Uncommitted changes excluded.

**Code does:**
- `map.py:156-172`: Log sorting, limits to 3
- `map.py:177-186`: In Progress section
- Uncommitted changes NOT detected (correctly excluded)

**Compliant?** Yes

---

## 2. CA Decision Compliance

| CA Decision | Ruling | Implemented Correctly? |
|-------------|--------|------------------------|
| Q1: Auto-Sync Scope | B — Only sync if exists | Yes |
| Q2: Tier 1 Token Budget | B — ~2k with hard cap | Yes |
| Q3: Recent Activity Detection | D minus uncommitted changes | Yes |
| Q4: CLAUDE.md Relationship | B — Keep manual | Yes |
| B1: Rename "Active Work" | Accept | Yes |
| B2: Keep commands separate | Accept with modification | Yes |
| B3: Reframe as "manual optimization" | Accept | Yes |
| Edge: USER CUSTOM protection | Add protection | Yes |
| Edge: Format versioning | Add ontos-map-version: 2 | Yes |

---

## 3. Architecture Check

| Constraint | Respected? | Evidence |
|------------|------------|----------|
| Import rules followed | Yes | Imports within command module |
| Existing patterns matched | Yes | Uses `Options` dataclass pattern |
| No unauthorized dependencies | Yes | Only internal modules |
| Single responsibility | Yes | `--sync-agents` is explicit opt-in |

---

## 4. Backward Compatibility Check

| Interface | Changed? | Breaking? | Notes |
|-----------|----------|-----------|-------|
| `ontos map` CLI | Yes | No | New optional flag |
| `ontos map` output format | Yes | No | Adds structure, preserved content |
| AGENTS.md format | Yes | No | Additive changes |
| Context map format | Yes | No | Tiers are additive |

**Breaking changes found:** None

---

## 5. Test Coverage

| Test | Present? | Passing? |
|------|----------|----------|
| `test_map_sync_agents_flag_exists` | Yes | Yes |
| `test_map_sync_agents_updates_agents_md` | Yes | Yes |
| `test_map_sync_agents_no_create_if_missing` | Yes | Yes |
| `test_tiered_context_map_has_tier_markers` | Yes | Yes |
| `test_tier1_contains_project_summary` | Yes | Yes |
| `test_tiered_map_structure` | Yes | Yes |
| `test_agents_user_custom_preservation` | Yes | Yes |
| `test_map_sync_agents_flag` | Yes | Yes |
| `test_tier1_token_capping` | Yes | Yes |

**All 549 tests pass** (9 new tests added).

---

## 6. Issues Found

### Critical (Alignment):
None

### Major (Alignment):
None

### Minor (Alignment):

| # | Issue | Type | Recommendation |
|---|-------|------|----------------|
| A-m1 | Tier 1 sorting by ID instead of date | Spec Interpretation | Log IDs include date, so acceptable |
| A-m2 | Token cap uses character truncation | Implementation Detail | Approximation acceptable |
| A-m3 | Missing file locking | Edge Case | Low priority per spec |

---

## 7. Verdict

**Spec Compliance:** **Fully Compliant**

**Recommendation:** **Approve**

**Blocking issues:** 0

All CA decisions implemented correctly:
- Q1-Q4 decisions followed precisely
- B1-B3 blocking issues addressed
- Edge case handling implemented
- Single-responsibility preserved via opt-in flag

---

## PR Comment Summary

```markdown
## Alignment Code Review (Claude)

**Recommendation:** Approve
**Spec Compliance:** Fully Compliant

### Spec Compliance Summary
| Requirement | Compliant |
|-------------|-----------|
| AGENTS.md sync via --sync-agents | Yes |
| Sync only if exists (Q1) | Yes |
| Current Project State section | Yes |
| Tiered context map (Tier 1/2/3) | Yes |
| Tier 1 ~2k token hard cap (Q2) | Yes |
| Recent Activity (Q3) | Yes |
| CLAUDE.md manual (Q4) | Yes |
| USER CUSTOM preservation | Yes |
| Format versioning | Yes |

### Breaking Changes
None. All changes are additive or opt-in.

### Test Coverage
9 new tests added, all passing. Total: 549 tests.
```

---

**Review signed by:**
- **Role:** Alignment Reviewer
- **Model:** Claude Opus 4.5
- **Date:** 2026-01-29
- **Review Type:** Code Review (D.2)
