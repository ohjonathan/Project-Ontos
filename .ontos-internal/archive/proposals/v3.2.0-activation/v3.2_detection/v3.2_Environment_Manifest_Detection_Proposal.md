---
id: v3_2_environment_manifest_detection_proposal
type: strategy
status: draft
depends_on: [mission, constitution, ontos_agent_instructions]
concepts: [onboarding, environment, documentation, portability]
---

# Ontos v3.2: Environment Manifest Detection Proposal

**Version:** 1.0
**Author:** Antigravity (Gemini 2.5 Pro)
**Date:** 2026-01-27
**Status:** Draft (Pending Review)

---

## 1. Executive Summary

This proposal introduces **Environment Manifest Detection** to Ontosâ€”a capability that helps teams quickly spin up development environments by detecting and documenting existing environment manifests.

### The Problem

When a new team member clones a repo, they face "environment blindness":
- **Dependencies are scattered** across `pyproject.toml`, `Brewfile`, `package.json`, `.tool-versions`
- **No unified view** of what needs to be installed
- **Ontos promises productivity in <10 minutes**, but environment setup can take hours

Ontos currently captures *what* a project is and *why* decisions were made. It does **not** capture *how* to set up the development environment.

### The Solution

A new `ontos env` command that:

| Capability | What It Does |
|------------|--------------|
| **Detect** existing manifests | Scans for `pyproject.toml`, `Brewfile`, `package.json`, `.tool-versions`, etc. |
| **Document** what they contain | Generates `.ontos/environment.md` with human-readable summary |
| **Integrate** with doctor | Warns if installed tools aren't captured in any manifest |

### Design Philosophy

> **Document, don't manage.**

This proposal explicitly does NOT:
- Create a new environment format (use existing `Brewfile`, `pyproject.toml`, etc.)
- Manage or install dependencies (use `brew bundle`, `poetry install`, etc.)
- Replace existing tooling (use asdf, devcontainer, nix if you want full reproducibility)

Ontos stays in its lane: **context capture and documentation**.

### Impact Assessment

| Category | Scope |
|----------|-------|
| New Files | 1 command module (`ontos/commands/env.py`) |
| Modified Files | 3 (`cli.py`, doctor integration, docs) |
| New Dependencies | None (stdlib only) |
| Breaking Changes | None |
| Backward Compatibility | Full |

---

## 2. Motivation & Context

### 2.1 The Conversation That Led Here

This proposal emerged from a discussion between the maintainer and Antigravity on 2026-01-27. Key points:

**The Core Question:**
> "When Project Ontos is used on multiple different devices...I'm wondering if it can capture some additional information that isn't directly coding. I'm wondering if I need to have a record doc of all those caches or what library or ever installed so it is easy for people to spin up the new environment very quickly."

**Critical Insight from Claude (separate conversation):**
> "A Brewfile is the record doc. It's a manifest that also happens to be runnable. Same with a requirements.txt or package.json. Documentation that can't drift out of sync because it's the actual source of truth."
>
> "What you want to avoid: a markdown file that says 'I installed Homebrew, then I installed Node, then I installed...' â€” that will rot within weeks."

### 2.2 The Key Principle: "Documentation That Can't Drift"

The hierarchy of reliability:

| Type | Example | Drift Risk |
|------|---------|------------|
| **Executable manifest** | `Brewfile`, `pyproject.toml`, `package.json` | âœ… None â€“ it IS the source |
| **Config as code** | `.zshrc`, `rectangle.json` | âœ… Low â€“ symlinked from dotfiles |
| **Minimal manual docs** | `SETUP.md` with only non-automatable steps | ðŸŸ¡ Medium â€“ small surface area |
| **Narrative documentation** | "I installed X, then Y..." | âŒ Rots immediately |

**Conclusion:** Ontos should point to existing manifests, not create new ones.

### 2.3 Existing Tools in the Market

| Tool | What It Does | Limitation |
|------|--------------|------------|
| **`pyproject.toml`** | Declares Python deps + versions | Python-only |
| **`requirements.txt`** | Pip dependencies | No system tools, no versions |
| **`.tool-versions` (asdf)** | Multi-language version management | Requires asdf installed |
| **`devcontainer.json`** | Full containerized dev environment | Heavy; requires Docker |
| **`flake.nix` (Nix)** | Fully reproducible environments | Steep learning curve |
| **`Brewfile`** | macOS system dependencies | macOS-only |
| **`Makefile` / `justfile`** | Bootstrap scripts | Manual, not declarative |

**The Gap Ontos Fills:**
1. No unified view â€“ you need to know to look at 5 different files
2. No detection â€“ existing tools are declarative, not introspective
3. No onboarding narrative â€“ they don't tell you *what to do first*

### 2.4 Why Not v3.1.2 or v4.0?

| Version | Fit |
|---------|-----|
| **v3.1.2** | âŒ Would be a patch release; this adds a new command |
| **v3.2** | âœ… Described as "improved validation"; manifest detection is validation |
| **v4.0** | âŒ MCP is the headline; this is too small |

---

## 3. Detailed Design

### 3.1 Command: `ontos env`

#### 3.1.1 Purpose

Detect environment manifests in the project and generate a human-readable onboarding summary.

#### 3.1.2 CLI Interface

```bash
# Basic usage - detect and display
ontos env

# Generate persistent documentation
ontos env --write

# JSON output for tooling
ontos env --format json

# Check for stale manifests (compare installed vs. documented)
ontos env --check
```

#### 3.1.3 Output: Terminal (Default)

```
Environment Manifest Detection

âœ“ Detected Manifests:
  â”œâ”€â”€ pyproject.toml (Python dependencies)
  â”‚   â””â”€â”€ 12 dependencies, poetry.lock present
  â”œâ”€â”€ Brewfile (System dependencies)
  â”‚   â””â”€â”€ 8 formulae, 3 casks
  â””â”€â”€ .tool-versions (Runtime versions)
      â””â”€â”€ python 3.11.4, node 20.10.0

âš  Not Detected:
  â””â”€â”€ package.json (npm not found, but node appears in .tool-versions)

Onboarding Steps:
  1. brew bundle --file=Brewfile
  2. poetry install
  3. asdf install (if using asdf for version management)

Run 'ontos env --write' to save to .ontos/environment.md
```

#### 3.1.4 Output: `.ontos/environment.md` (with `--write`)

```markdown
# Environment Setup

> Auto-generated by `ontos env`. Do not edit manually.
> Regenerate with: `ontos env --write`
> Last updated: 2026-01-27T13:15:00Z

---

## Detected Manifests

| Manifest | Type | Purpose | Bootstrap Command |
|----------|------|---------|-------------------|
| [pyproject.toml](../pyproject.toml) | Python deps | Project dependencies | `poetry install` |
| [Brewfile](../Brewfile) | System deps | macOS tools | `brew bundle` |
| [.tool-versions](../.tool-versions) | Runtime versions | Language versions | `asdf install` |

---

## Quick Start

New contributors should run these commands in order:

```bash
# 1. System dependencies (macOS)
brew bundle --file=Brewfile

# 2. Runtime versions (optional, requires asdf)
asdf install

# 3. Python dependencies
poetry install
```

---

## Manual Steps

See [docs/SETUP.md](../docs/SETUP.md) for any non-automatable configuration.

---

## Manifest Details

### pyproject.toml

**Location:** `pyproject.toml`
**Package Manager:** Poetry
**Dependencies:** 12 runtime, 8 dev
**Lock File:** âœ“ Present

### Brewfile

**Location:** `Brewfile`
**Formulae:** gh, jq, ripgrep, fd, fzf, bat, git-delta, starship
**Casks:** visual-studio-code, rectangle, warp

### .tool-versions

**Location:** `.tool-versions`
**Runtimes:**
- python: 3.11.4
- node: 20.10.0
```

#### 3.1.5 Output: JSON (with `--format json`)

```json
{
  "$schema": "ontos-env-v1",
  "generated_at": "2026-01-27T13:15:00Z",
  "ontos_version": "3.2.0",
  "manifests": [
    {
      "path": "pyproject.toml",
      "type": "python_deps",
      "package_manager": "poetry",
      "lock_file": "poetry.lock",
      "lock_present": true,
      "dependency_count": {
        "runtime": 12,
        "dev": 8
      },
      "bootstrap_command": "poetry install"
    },
    {
      "path": "Brewfile",
      "type": "system_deps",
      "platform": "macos",
      "formulae": ["gh", "jq", "ripgrep"],
      "casks": ["visual-studio-code", "rectangle"],
      "mas_apps": [],
      "bootstrap_command": "brew bundle"
    },
    {
      "path": ".tool-versions",
      "type": "runtime_versions",
      "manager": "asdf",
      "runtimes": {
        "python": "3.11.4",
        "node": "20.10.0"
      },
      "bootstrap_command": "asdf install"
    }
  ],
  "not_detected": [
    {
      "type": "npm_deps",
      "expected_file": "package.json",
      "reason": "node in .tool-versions but no package.json found"
    }
  ],
  "onboarding_steps": [
    "brew bundle --file=Brewfile",
    "asdf install",
    "poetry install"
  ]
}
```

---

### 3.2 Integration: `ontos doctor`

Extend `ontos doctor` to include environment manifest validation.

#### 3.2.1 New Checks

```
$ ontos doctor

...existing checks...

Environment Manifest Health:
  âœ“ pyproject.toml present (12 deps)
  âœ“ poetry.lock in sync with pyproject.toml
  âš  Brewfile may be stale
    â””â”€â”€ 'gh' installed but not in Brewfile (run: brew bundle dump --force)
  âš  .tool-versions missing
    â””â”€â”€ Python version not locked (consider: asdf local python 3.11.4)
```

#### 3.2.2 Severity Levels

| Check | Severity | Rationale |
|-------|----------|-----------|
| Lock file missing | Warning | Environment may not be reproducible |
| Lock file out of sync | Warning | `poetry.lock` older than `pyproject.toml` |
| Installed tool not in manifest | Info | Helps keep manifests up to date |
| Manifest references missing tool | Error | New user will fail to bootstrap |

---

### 3.3 Supported Manifests

#### Phase 1 (v3.2.0)

| Manifest | Detection | Parsing | Notes |
|----------|-----------|---------|-------|
| `pyproject.toml` | âœ“ | âœ“ Parse with tomllib | Standard Python |
| `requirements.txt` | âœ“ | âœ“ Line count | Legacy Python |
| `Brewfile` | âœ“ | âœ“ Parse brew/cask/mas | macOS |
| `.tool-versions` | âœ“ | âœ“ Parse key=value | asdf |
| `package.json` | âœ“ | âœ“ Parse dependencies | npm/yarn |
| `.nvmrc` | âœ“ | âœ“ Single value | Node version |
| `.python-version` | âœ“ | âœ“ Single value | pyenv |

#### Future (v3.3+)

| Manifest | Notes |
|----------|-------|
| `devcontainer.json` | VS Code dev containers |
| `flake.nix` | Nix flakes |
| `Dockerfile` | Container builds |
| `docker-compose.yml` | Service dependencies |
| `.envrc` | direnv integration |

---

## 4. Alternatives Considered

### 4.1 Create a New `.ontos-env.yaml` Format

**Rejected:** Would duplicate information already in `pyproject.toml`, `Brewfile`, etc.

**Rationale:** Per the "documentation that can't drift" principle, we should point to existing manifests, not create new ones that will become stale.

### 4.2 Parse and Convert All Manifests to a Single Format

**Rejected:** Loses fidelity and creates maintenance burden.

**Rationale:** Each manifest format has semantics that don't translate cleanly. Better to preserve the original and generate a human-readable summary.

### 4.3 Use `ontos scan` Instead of `ontos env`

**Rejected:** `scan` is already used for document discovery.

**Rationale:** Environment detection is a distinct concern. Separate command is clearer.

### 4.4 Add Environment Info to `ontos init`

**Considered:** Auto-detect during `ontos init` and generate `.ontos/environment.md`.

**Decision:** Make it optional. Many projects won't have environment manifests at init time.

**Implementation:** Add `--env` flag to `ontos init` that runs `ontos env --write` after scaffolding.

---

## 5. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Manifest parsing fails | Degraded output | Graceful fallback: report file exists, skip parsing |
| Too many warnings annoy users | Developer experience | Make doctor checks opt-in via config |
| Platform-specific manifests (Brewfile on Linux) | Confusing output | Detect OS and filter/label appropriately |
| Stale `.ontos/environment.md` | Documentation drift | Add timestamp + regeneration command at top |

---

## 6. Implementation Plan

### Phase 1: Core Detection (v3.2.0)

**Files:**
- `ontos/commands/env.py` â€” NEW
- `ontos/cli.py` â€” MODIFY (register command)
- `docs/reference/Ontos_Manual.md` â€” MODIFY (document command)

**Implementation Notes:**
```python
@dataclass
class ManifestInfo:
    path: Path
    type: str  # python_deps, system_deps, runtime_versions
    package_manager: Optional[str]
    lock_file: Optional[Path]
    lock_present: bool
    details: dict  # parsed contents
    bootstrap_command: str


def detect_manifests(workspace: Path) -> List[ManifestInfo]:
    """Scan workspace for known manifest files."""
    pass


def generate_onboarding(manifests: List[ManifestInfo]) -> List[str]:
    """Generate ordered bootstrap commands."""
    pass
```

**Tests:**
- `tests/commands/test_env.py`
- Golden file tests with fixture projects

**Verification:**
```bash
# In a project with pyproject.toml and Brewfile
ontos env
# Should detect both manifests

ontos env --write
# Should create .ontos/environment.md

ontos env --format json | jq .
# Should produce valid JSON
```

### Phase 2: Doctor Integration (v3.2.0)

**Files:**
- `ontos/commands/doctor.py` â€” MODIFY (add env checks)

**Tests:**
- Extend `tests/commands/test_doctor.py`

### Phase 3: Init Integration (v3.2.1)

**Files:**
- `ontos/commands/init.py` â€” MODIFY (add `--env` flag)

---

## 7. Open Questions

1. **Should `.ontos/environment.md` be git-tracked?**
   - Pro: New cloners see it immediately
   - Con: Can become stale if not regenerated

2. **Should we detect installed-but-not-documented tools?**
   - Requires comparing `brew list` vs. Brewfile, etc.
   - More invasive, slower, but more valuable

3. **How should we handle monorepos?**
   - Multiple `package.json` files in subdirectories
   - Need scoping rules or explicit configuration

---

## 8. Success Criteria

| Metric | Target |
|--------|--------|
| New user can bootstrap environment | < 10 minutes with `ontos env` guidance |
| Manifest detection accuracy | 100% for Phase 1 formats |
| Doctor run time impact | < 500ms additional |
| Zero new dependencies | Stdlib only |

---

## 9. Appendix: Related Work

- **Claude conversation (2026-01-27):** Environment backup strategy using Brewfile + SETUP.md
- **Ontos philosophy:** "The litmus test: Can a new person become productive in under 10 minutes?"
- **v3.2 Re-Architecture Proposal:** Parallel feature for decision extraction

---

## 10. Review Checklist

- [ ] Does this align with Ontos philosophy? (Document, don't manage)
- [ ] Is the scope appropriate for v3.2?
- [ ] Are there edge cases not covered?
- [ ] Is the implementation plan realistic?
- [ ] What should be deferred to v3.3+?
