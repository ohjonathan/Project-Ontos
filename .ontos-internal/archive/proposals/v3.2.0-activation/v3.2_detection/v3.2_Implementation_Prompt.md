---
id: v3_2_implementation_prompt
type: strategy
status: ready
depends_on: [v3_2_env_detection_candidate_suggestions_implementation_plan, v3_2_chief_architect_response]
concepts: [implementation, prompt, antigravity]
---

# v3.2.0 Implementation Prompt for Antigravity

**Target Model:** Gemini 2.5 Pro (Antigravity)
**Task:** Implement Environment Detection + Candidate Suggestions
**Spec Version:** 1.1 (Approved)
**Date:** 2026-01-29

---

## Prompt

You are implementing two v3.2.0 features for the Ontos documentation management system. Follow the approved specification exactly.

### Reference Documents

Read these documents in order before starting:

1. **Implementation Specification (PRIMARY):**
   `.ontos-internal/strategy/proposals/v3.2/v3.2_Env_Detection_Candidate_Suggestions_Implementation_Plan.md`

2. **Chief Architect Decisions:**
   `.ontos-internal/strategy/proposals/v3.2/v3.2_Chief_Architect_Response.md`

3. **Existing CLI Patterns (Reference):**
   - `ontos/cli.py` - Handler registration patterns
   - `ontos/commands/doctor.py` - CheckResult pattern
   - `ontos/commands/map.py` - Output formatting pattern
   - `ontos/core/suggestions.py` - Existing suggestion functions

---

## Implementation Tasks

Execute these tasks in order. Each task has specific files and verification.

### Task 1: Create `ontos/commands/env.py`

**Action:** Create new file with ~380 lines from spec Section 1.1

**Contents:**
- Data structures: `ManifestInfo`, `EnvResult`, `EnvOptions`
- Manifest patterns: `MANIFEST_PATTERNS` dict
- Detection: `detect_manifests()`, `_parse_manifest()`, `_parse_pyproject()`, `_parse_package_json()`, `_parse_tool_versions()`, `_parse_nvmrc()`
- Output: `format_text_output()`, `format_json_output()`, `generate_environment_md()`
- Entry point: `env_command()`

**v1.1 Requirements (CRITICAL):**
```python
# tomli fallback for Python 3.9/3.10
try:
    import tomllib
except ImportError:
    import tomli as tomllib

# parse_warnings field in EnvResult
parse_warnings: List[str] = field(default_factory=list)

# force flag in EnvOptions
force: bool = False

# Safety check in env_command() before writing
if env_md.exists() and not options.force:
    return 1, f"Error: {env_md} already exists. Use --force to overwrite."

# Specific exceptions in _parse_manifest() (NOT bare except Exception)
except (tomllib.TOMLDecodeError, json.JSONDecodeError, FileNotFoundError, UnicodeDecodeError) as e:
```

**Verify:**
```bash
python -c "from ontos.commands.env import env_command, EnvOptions; print('OK')"
```

---

### Task 2: CLI Integration (`ontos/cli.py`)

**Action:** Modify existing file - add ~35 lines

**Changes:**
1. Add `_register_env(subparsers)` function (follow `_register_doctor` pattern)
2. Register flags: `--write/-w`, `--force`, `--format`
3. Add `_cmd_env(args)` handler function
4. Call `_register_env(subparsers)` in `create_parser()`

**Verify:**
```bash
ontos env --help
```

---

### Task 3: Unit Tests for env (`tests/commands/test_env.py`)

**Action:** Create new test file with ~150 lines from spec Section 3.1

**Test Cases:**
- `test_detect_pyproject_toml` - Poetry project detection
- `test_detect_package_json` - Node.js detection
- `test_detect_tool_versions` - asdf detection
- `test_multiple_manifests` - Combined detection
- `test_no_manifests` - Empty project
- `test_env_command_text_output` - CLI text format
- `test_env_command_json_output` - CLI JSON format
- `test_env_command_write_creates_file` - --write flag
- `test_env_command_write_force_overwrites` - --force flag (v1.1)
- `test_env_command_write_existing_without_force` - Error without --force (v1.1)
- `test_parse_warnings_in_json_output` - Parse warnings surfaced (v1.1)

**Verify:**
```bash
pytest tests/commands/test_env.py -v
```

---

### Task 4: Add Candidate Suggestions (`ontos/core/suggestions.py`)

**Action:** Modify existing file - add ~55 lines from spec Section 2.1

**Add Function:**
```python
def suggest_candidates_for_broken_ref(
    broken_ref: str,
    corpus: List[str],
    threshold: float = 0.5
) -> List[Tuple[str, float]]:
```

**Matching Strategies (in order):**
1. Substring match (score 0.85)
2. Alias match via `_extract_aliases()` (score 0.85)
3. Levenshtein fuzzy match (normalized score)

**v1.1 Requirement (CRITICAL):**
```python
# Deterministic sort for ties - secondary key is alphabetical
return sorted(candidates, key=lambda x: (-x[1], x[0]))[:3]
```

**Verify:**
```bash
python -c "from ontos.core.suggestions import suggest_candidates_for_broken_ref; print('OK')"
```

---

### Task 5: Suggestion Tests (`tests/test_suggestions.py`)

**Action:** Modify existing file - add ~60 lines from spec Section 3.2

**Test Cases:**
- `test_suggest_exact_substring_match`
- `test_suggest_alias_match`
- `test_suggest_levenshtein_match`
- `test_suggest_no_match_below_threshold`
- `test_suggest_max_three_results`
- `test_suggest_empty_corpus`
- `test_suggest_deterministic_order` (v1.1)

**Verify:**
```bash
pytest tests/test_suggestions.py -v -k suggest_candidates
```

---

### Task 6: Graph Integration (`ontos/core/graph.py`)

**Action:** Modify existing file - add ~15 lines from spec Section 2.2

**Changes:**
1. Import `suggest_candidates_for_broken_ref` from suggestions
2. In `build_graph()`, after detecting broken link error, call suggestion function
3. Enrich `ValidationError.fix_suggestion` field with candidates

**Location:** Around line 62-72 in `build_graph()` where broken links are detected

**Verify:**
```bash
python -c "from ontos.core.graph import build_graph; print('OK')"
```

---

### Task 7: Map Output (`ontos/commands/map.py`)

**Action:** Modify existing file - add ~5 lines from spec Section 2.3

**Changes:**
In `_generate_validation_section()` (around line 175-191):
- After displaying `error.message`, check for `error.fix_suggestion`
- If present, display: `    Did you mean: {suggestion}`

**Verify:**
```bash
# Create a test doc with broken ref, run ontos map, verify suggestion appears
```

---

### Task 8: Doctor Integration (`ontos/commands/doctor.py`)

**Action:** Modify existing file - add ~40 lines from spec Section 1.2

**Changes:**
1. Import from `commands.env`: `detect_manifests`, `ManifestInfo`
2. Add `check_environment_manifests(workspace: Path) -> CheckResult` function
3. Register check in `run_checks()` list

**Verify:**
```bash
ontos doctor
# Should show "environment_manifests" check
```

---

### Task 9: Integration Tests (`tests/integration/test_cli.py`)

**Action:** Modify existing file - add integration tests from spec Section 3.3

**Test Cases:**
- `test_env_command_basic`
- `test_env_command_write_workflow`
- `test_map_with_suggestions`
- `test_doctor_env_check`

**Verify:**
```bash
pytest tests/integration/test_cli.py -v -k env
```

---

### Task 10: Documentation (`docs/reference/Ontos_Manual.md`)

**Action:** Modify existing file - add documentation for new features

**Sections to Add:**
1. `ontos env` command reference
2. Candidate suggestions feature description
3. Update command list

---

## Final Verification

After all tasks complete, run full verification:

```bash
# 1. All tests pass
pytest tests/ -v

# 2. env command works
ontos env
ontos env --format json | jq .
ontos env --write --force
cat .ontos/environment.md

# 3. Doctor shows env check
ontos doctor

# 4. Map shows suggestions (create broken ref first)
ontos map

# 5. Verify Python 3.9 compatibility (if available)
python3.9 -c "from ontos.commands.env import env_command; print('OK')"
```

---

## Commit Sequence

Create atomic commits for each logical unit:

1. `feat(env): add environment manifest detection module`
2. `feat(cli): register env command`
3. `test(env): add unit tests for environment detection`
4. `feat(suggestions): add candidate suggestions for broken refs`
5. `test(suggestions): add tests for candidate suggestions`
6. `feat(graph): integrate candidate suggestions into validation`
7. `feat(map): display candidate suggestions in error output`
8. `feat(doctor): add environment manifest check`
9. `test(integration): add env and suggestions integration tests`
10. `docs: add env command and suggestions documentation`

---

## Critical Constraints

1. **Python 3.9+ Compatibility:** Must use `tomli` fallback for `tomllib`
2. **No New Dependencies:** All stdlib except existing `tomli` in pyproject.toml
3. **Deterministic Output:** Suggestion sorting must be stable (score DESC, then alpha ASC)
4. **Safe Overwrites:** `--write` requires `--force` to overwrite existing files
5. **Parse Warnings:** Surface failures in output, don't hide them silently
6. **Specific Exceptions:** Catch `TOMLDecodeError`, `JSONDecodeError`, `FileNotFoundError`, `UnicodeDecodeError` - NOT bare `Exception`

---

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `ontos/commands/env.py` | CREATE | ~380 |
| `ontos/cli.py` | MODIFY | +35 |
| `ontos/core/suggestions.py` | MODIFY | +55 |
| `ontos/core/graph.py` | MODIFY | +15 |
| `ontos/commands/map.py` | MODIFY | +5 |
| `ontos/commands/doctor.py` | MODIFY | +40 |
| `tests/commands/test_env.py` | CREATE | ~150 |
| `tests/test_suggestions.py` | MODIFY | +60 |
| `tests/integration/test_cli.py` | MODIFY | +40 |
| `docs/reference/Ontos_Manual.md` | MODIFY | +30 |

---

**End of Implementation Prompt**
