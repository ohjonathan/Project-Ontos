# Phase B.1: Spec Review — Adversarial Reviewer (Codex)

**Version:** v3.2.0  
**Document Under Review:** v3.2 Env Detection + Candidate Suggestions Implementation Plan  
**Role:** Adversarial Reviewer  
**Model:** Codex (OpenAI)

---

## Part 1: Assumption Attack

| Assumption in Spec | Why It Might Be Wrong | Impact If Wrong |
|--------------------|----------------------|-----------------|
| `tomllib` available (Python 3.11+) | Users on 3.9/3.10 still common | Pyproject parsing silently skipped; env output incomplete with no warning |
| Manifest files are valid/parseable | Malformed TOML/JSON/lock formats exist | Detection degrades silently; user thinks env is documented but details missing |
| One manifest per type | Monorepos often have multiple `package.json` / `pyproject.toml` | Missed dependencies or misleading “complete” summary |
| Lock file implies package manager | Lock files can be stale, leftover, or committed accidentally | Wrong bootstrap command recommended (breaks onboarding) |
| Levenshtein 0.6 threshold is correct | No empirical tuning; projects vary in ID conventions | Too many false positives or misses, reducing trust in suggestions |
| Workspace root is the only place to scan | Many repos keep manifests in subdirs | Env command reports “not detected” incorrectly |
| Reading manifests is always allowed | CI / restricted repos can deny read permissions | Exceptions swallowed; user sees missing data with no reason |
| `--write` is always safe | Existing `environment.md` may be curated by humans | Overwrites manual content and loses context |
| OS-specific manifests are always relevant | Brewfile on Linux, asdf not installed | Output gives steps that fail or confuse users |
| Dependency counts are meaningful | `pyproject.toml` can include extras/groups/markers | Counts are misleading and imply completeness |

---

## Part 2: Edge Case Analysis — Environment Detection

| Edge Case | Handled in Spec? | If Not, What Happens? |
|-----------|------------------|----------------------|
| Empty manifest file (0 bytes) | ❌ | `tomllib.loads` or JSON parse throws; exception swallowed; appears detected but with missing details |
| Manifest with syntax errors | ✅ | Try/except drops details; no warning explaining parse failure |
| Symlinked manifest files | ❌ | Could read outside repo; or broken symlink => parse error silently ignored |
| Manifest in subdirectory (monorepo) | ❌ | Not detected; env summary incomplete; user misled |
| Multiple Python package managers detected | ❌ | Lock file detection picks first; bootstrap command may be wrong |
| Read permission denied on manifest | ✅ | Exception swallowed; detection incomplete without visibility |
| Very large manifest (1000+ deps) | ❌ | Full read into memory; parse time spikes; potential hang |
| Unicode in dependency names | ❌ | Read/parse may fail depending on encoding assumptions |
| `.ontos/` directory doesn't exist for `--write` | ✅ | Spec mentions creating `.ontos/environment.md`; assumes directory creation but not explicit |
| `--write` with existing `environment.md` | ❌ | Overwrite without prompt; loses manual edits |
| Running on Windows (path separators) | ❌ | Path handling and output examples assume POSIX; might generate bad links |

---

## Part 3: Edge Case Analysis — Candidate Suggestions

| Edge Case | Handled in Spec? | If Not, What Happens? |
|-----------|------------------|----------------------|
| Broken ref matches nothing (0 candidates) | ✅ | Returns empty list; fallback message used |
| Broken ref matches many (10+ candidates) | ✅ | Top 3 cap exists, but may hide best matches without explanation |
| Broken ref is exact substring of multiple IDs | ❌ | All get same 0.85 score; ordering becomes arbitrary, misleading “best” |
| Very long document ID (100+ chars) | ❌ | Similarity calc becomes slow; scores skewed by length |
| Document ID with special characters | ❌ | Substring/alias might misbehave; comparison isn’t normalized |
| Empty document corpus | ✅ | Returns empty list |
| Broken ref is empty string | ❌ | Substring match hits every doc; returns arbitrary top 3 |
| Circular dependency scenario | ❌ | Suggestions might reinforce cycles; no guardrail |
| All candidates have same confidence score | ❌ | Sorting unstable; output changes run-to-run |

---

## Part 4: Failure Mode Analysis

| Failure | How It Happens | Would We Notice? | Recovery |
|---------|----------------|------------------|----------|
| `tomllib.loads()` raises exception | Invalid TOML, empty file | Likely not; exception swallowed | None; output silently missing details |
| `json.loads()` raises exception | Invalid JSON (`package.json`) | Likely not; exception swallowed | None; output silently missing details |
| File read fails mid-parse | I/O error, permission change | Not surfaced | None; skip details |
| `--write` fails (disk full, permissions) | Filesystem errors | Might crash or partial write | No explicit handling/rollback |
| Levenshtein calculation hangs | Huge corpus; repeated calls per broken ref | Slow `ontos map` runs; user sees lag | No caching or limits |
| Regex parsing Brewfile fails | Non-standard Brewfile syntax | Silent skip of formulae/casks | No warning |

---

## Part 5: Performance Concerns

| Scenario | Potential Issue | Spec Addresses? |
|----------|-----------------|-----------------|
| Large project (10,000 documents) | Suggestions O(N) per broken ref | ❌ |
| Many manifest files (20+) | Detection serial parse; no timing guard | ❌ |
| Nested directories deep scan | Monorepos intentionally out of scope | ❌ |
| Repeated calls to `suggest_candidates` | No memoization; repeated similarity calc | ❌ |

---

## Part 6: Security/Misuse Review

| Attack Vector | Applicable? | Mitigation in Spec? |
|---------------|-------------|---------------------|
| Path traversal via manifest path | Yes (symlinks to outside workspace) | ❌ |
| Code injection via malformed manifest | Low (parse only) | ✅ (stdlib parsers) |
| Denial of service via huge file | Yes (read full file, similarity on large corpora) | ❌ |
| Information disclosure via env output | Yes (lists tools, versions, packages) | ❌ |

---

## Part 7: Blind Spot Identification

**What's the architect not seeing?**
1. Silent degradation hides the real failure; users get incomplete env docs with no signal.
2. Monorepo realities: multiple manifests and nested scopes will be common in real usage.
3. `--write` can overwrite curated documentation without any guard or merge strategy.

**What seems too easy?**
1. “Lock file implies package manager” is optimistic; stale lock files are common.
2. Using a single similarity threshold without tuning or project-specific calibration.
3. Parsing arbitrary Brewfiles/requirements as if format is stable and clean.

**What's conspicuously absent?**
1. Explicit error reporting or warnings when parsing fails.
2. A strategy for deterministic ordering when multiple candidates tie.

---

## Part 8: Test Coverage Gaps

| Scenario | Has Test? | Should Have Test? |
|----------|-----------|-------------------|
| Malformed manifest parsing | ❌ | ✅ |
| Permission denied on file | ❌ | ✅ |
| Empty suggestion results | ✅ | ✅ |
| Concurrent access to env.md | ❌ | ✅ |
| Platform-specific behavior | ❌ | ✅ |

---

## Part 9: Issues Found

**Critical (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-C1 | Silent parse failures produce misleading “complete” environment docs | Invalid/empty TOML/JSON; permission errors | Users follow broken onboarding steps, wasting hours |

**High (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-H1 | `--write` overwrites user-curated `environment.md` | Re-running command in repo with manual edits | Loss of critical setup steps and trust in tool |
| X-H2 | Monorepo manifests ignored | Nested `package.json` / `pyproject.toml` | Critical dependencies missed; false negatives |

**Medium (Adversarial):**

| # | Issue | Attack Vector | Impact |
|---|-------|---------------|--------|
| X-M1 | Suggestion rankings unstable on ties | Multiple substring matches | Suggests wrong doc, causing bad fixes |
| X-M2 | DOS via huge files or large doc corpora | Very large manifests / many docs | Slow or hanging `ontos map` / `ontos env` |

---

## Part 10: Uncomfortable Questions

1. What happens if the user has BOTH `poetry.lock` AND `pdm.lock`? Which wins?
2. Why is Levenshtein threshold 0.6 and not 0.5 or 0.7? Was this tested?
3. If `tomllib` requires 3.11+, what's the actual minimum Python version for Ontos?
4. Could `--write` accidentally overwrite user-edited content in `environment.md`?
5. How do we signal that parsing failed vs. “no dependencies found”?
6. Should `ontos env` refuse to claim completeness if it only scanned the repo root?

---

## Part 11: Verdict

**Spec Robustness:** Fragile  
**Recommendation:** Request changes

**Top 3 Concerns:**
1. Silent failures create false confidence in environment docs.
2. Monorepo and multiple-manifest scenarios are common but excluded.
3. `--write` can overwrite manual content without safeguards.

**Summary:**
The plan is solid for a narrow, happy-path repo, but it underestimates real-world variability. Silent error handling, monorepo realities, and the risks around `--write` make this fragile. Without clear warnings, deterministic suggestion ordering, and safeguards for writes, this will erode user trust quickly.

---

**Review signed by:**
- **Role:** Adversarial Reviewer
- **Model:** Codex (OpenAI)
- **Date:** January 29, 2026
- **Review Type:** Spec Review (Phase B.1)
