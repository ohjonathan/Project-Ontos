# v3.2 Spec Review Consolidation

**Version:** v3.2.0
**Document Under Review:** v3.2 Env Detection + Candidate Suggestions Implementation Plan
**Role:** Review Consolidator
**Date:** 2026-01-29

---

## 1. Verdict Summary

| Reviewer | Role | Verdict | Blocking Issues |
|----------|------|---------|-----------------|
| Gemini | Peer | Approve with changes | 1 |
| Claude | Alignment | Approve with notes | 0 |
| Codex | Adversarial | Request changes | 1 |

**Consensus:** 2/3 Approve (with conditions)

**Overall:** **Needs minor revision** — One consistent blocking issue (Python compatibility) and one significant adversarial concern (`--write` safety).

---

## 2. Blocking Issues

| # | Issue | Flagged By | Category | Impact | Spec Section |
|---|-------|------------|----------|--------|--------------|
| B1 | **`tomllib` crashes on Python <3.11** | Gemini (P-M1), Claude (A-m1), Codex | Compatibility | Project supports 3.9+; direct import of `tomllib` fails at import time | 1.1 New File |
| B2 | **Silent parse failures hide incomplete docs** | Codex (X-C1) | Failure Mode | Users get "complete" env output with missing data; follow broken onboarding steps | 1.1 `_parse_manifest()` |
| B3 | **`--write` overwrites curated content** | Codex (X-H1) | UX | Re-running `ontos env --write` destroys manual edits without warning | Section 1.1 (line 538-546) |

---

## 3. Required Actions for Chief Architect

| Priority | Action | Addresses Issue(s) |
|----------|--------|-------------------|
| 1 | **Add `tomli` fallback import**: `try: import tomllib except ImportError: import tomli as tomllib` in `env.py` | B1 |
| 2 | **Surface parse warnings**: When `_parse_manifest()` catches an exception, add entry to `result.not_detected` with `reason: "parse failed: {error}"` so user sees partial detection | B2 |
| 3 | **Add `--write` safety guard**: Before overwriting existing `environment.md`, either (a) prompt to confirm, (b) show diff, or (c) require `--force` flag. Minimum: print warning that file exists. | B3 |

---

## 4. Non-Blocking Issues

| # | Issue | Flagged By | Recommendation |
|---|-------|------------|----------------|
| NB1 | Detection logic in commands layer (not `core/`) | Claude (A-M1) | Consider extracting `detect_manifests()` to `ontos/core/environment.py`. Acceptable as-is if CA acknowledges trade-off. |
| NB2 | Inconsistent threshold (0.5 vs 0.85 vs 0.6) | Gemini (P-m1), Codex | Clarify: 0.5 is fuzzy baseline; 0.85 is substring/alias confidence. Document explicitly. |
| NB3 | Bare `except Exception` in `_parse_manifest()` | Claude (A-m2) | Catch specific exceptions (`tomllib.TOMLDecodeError`, `json.JSONDecodeError`, `FileNotFoundError`). |
| NB4 | Map output doesn't display `fix_suggestion` | Claude (A-m3) | Verify spec changes to `map.py` actually render the suggestion. |
| NB5 | Monorepo manifests ignored | Codex (X-H2) | Explicitly document limitation. Defer subdirectory scanning to v3.2.1. |
| NB6 | Suggestion ranking unstable on ties | Codex (X-M1) | Add secondary sort key (e.g., alphabetical by `doc_id`) for deterministic output. |
| NB7 | DOS via huge files/corpora | Codex (X-M2) | Add file size limit (e.g., 1MB) for manifest reads. Low priority for v3.2.0. |

---

## 5. Agreement Analysis

### Strong Agreement (2–3 reviewers flagged same concern)

| Topic | Reviewers | Consensus View |
|-------|-----------|----------------|
| Python 3.9/3.10 compatibility | Gemini, Claude, Codex | `tomllib` import crashes; fallback required |
| Silent error handling | Codex, Gemini | Graceful degradation hides failures; needs user-visible warnings |
| Suggestion algorithm is sound | Gemini, Claude | Substring + alias + Levenshtein is appropriate |
| Philosophy alignment | Claude, (implicit Gemini) | Spec follows "Document, don't manage" correctly |

### Disagreement (reviewers differ)

| Topic | Gemini View | Claude View | Codex View | Consolidation Recommendation |
|-------|-------------|-------------|------------|------------------------------|
| Spec readiness | Approve with 1 fix | Approve with notes | Request changes | **Minor revision needed**: Address B1–B3, then ready |
| Architecture (core vs commands) | Not flagged | Soft violation, acceptable | Not flagged | CA discretion; not blocking |
| `--write` behavior | Not flagged | Not flagged | High-risk overwrite | **Address** — add safety guard |

---

## 6. Edge Cases Requiring Decision

| Edge Case | Codex Assessment | CA Must Decide |
|-----------|------------------|----------------|
| Empty manifest file (0 bytes) | Silent exception; appears detected but missing details | Add explicit handling? Or document as parse failure? |
| Both `poetry.lock` AND `pdm.lock` exist | First lock file wins; may pick wrong bootstrap | Clarify detection priority order in spec |
| Symlinked manifest to outside workspace | Could read outside repo | Add symlink resolution check? Or defer? |
| `--write` with existing `environment.md` | Overwrites without prompt | Require `--force`, or auto-backup, or warning? |

---

## 7. Risks Highlighted

| Risk | Flagged By | Severity | Mitigation Adequate? |
|------|------------|----------|----------------------|
| Python version crash | Gemini, Claude | High | **No** — code lacks fallback |
| False confidence from silent failures | Codex | High | **No** — needs warning output |
| Stale lock file → wrong bootstrap | Codex | Medium | **Partial** — lock presence ≠ correctness; acceptable risk |
| Monorepo incomplete detection | Codex | Medium | **Yes** — explicitly deferred to v3.2.1 |
| Path traversal via symlinks | Codex | Low | **No** — add check or document limitation |

---

## 8. Test Coverage Gaps

| Gap | Priority | Recommendation |
|-----|----------|----------------|
| Malformed manifest parsing | **High** | Add unit test with invalid TOML/JSON; verify graceful output |
| Permission denied on file read | Medium | Add test with mocked permission error |
| Platform-specific behavior (Windows paths) | Medium | Add cross-platform test for path separator handling |
| `--write` with existing file | **High** | Add test verifying behavior (overwrite, warning, or failure) |
| Concurrent access to `environment.md` | Low | Defer; edge case for v3.2.1 |

---

## 9. Decision Summary

**Spec Status:** **Minor Revision Needed**

**Chief Architect must:**

1. [ ] Add `tomli` fallback import for Python 3.9/3.10 compatibility
2. [ ] Surface parse failures in output (add to `not_detected` with reason)
3. [ ] Add `--write` safety guard (warning, diff, or `--force` requirement)
4. [ ] (Optional) Add secondary sort key for suggestion ties
5. [ ] Update spec to v1.1

**Estimated revision scope:** **Minor (< 1 hour)**

---

## 10. Verification Review Recommendation

**Recommendation:** **Conditional**

**If blocking issues (B1–B3) are fixed:** No re-review needed. Changes are mechanical.

**If scope changes** (e.g., monorepo scanning added, new edge case handling): Request targeted re-review from Codex.

---

## Appendix: Issue ID Cross-Reference

| Consolidation ID | Gemini ID | Claude ID | Codex ID |
|------------------|-----------|-----------|----------|
| B1 | P-M1 | A-m1 | (Part 1, assumption #1) |
| B2 | — | — | X-C1 |
| B3 | — | — | X-H1 |
| NB1 | — | A-M1 | — |
| NB2 | P-m1 | — | (Part 10, Q2) |
| NB3 | — | A-m2 | — |
| NB4 | — | A-m3 | — |
| NB5 | — | — | X-H2 |
| NB6 | — | — | X-M1 |
| NB7 | — | — | X-M2 |

---

**Consolidation signed by:**
- **Role:** Review Consolidator
- **Model:** Gemini 2.5 Pro (Antigravity)
- **Date:** 2026-01-29
- **Reviews Consolidated:** Gemini (Peer), Claude (Alignment), Codex (Adversarial)
