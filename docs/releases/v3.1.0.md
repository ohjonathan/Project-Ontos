---
id: v310
type: kernel
status: scaffold
ontos_schema: 2.2
curation_level: 0
generated_by: ontos_scaffold
---

## What's Changed

Major feature release delivering two tracks: **Obsidian Compatibility & Token Efficiency** and **Native Command Migration**.

### ðŸŽ¯ Highlights

- All 7 CLI commands now run **natively** â€” no more subprocess overhead.
- New `--obsidian`, `--compact`, and `--filter` flags for context map generation.
- Token-aware caching system with 15-minute TTL for faster repeated operations.
- `scaffold` command fixed after being broken since v3.0.

---

### Track A: Obsidian Compatibility & Token Efficiency

- **`ontos map --obsidian`** â€” Generates Obsidian-compatible wiki-links (`[[doc_id]]`) in the context map, enabling direct integration with Obsidian vaults.
- **`ontos map --compact`** â€” Reduced-token output mode for LLM context windows. Strips verbose formatting while preserving all semantic content.
- **`ontos map --filter`** â€” Type-based filtering (e.g., `--filter strategy,kernel`) to generate focused context maps.
- **Token-aware caching** â€” Caches map generation results with a 15-minute TTL. Subsequent runs within the window return cached output instantly.
- **`ontos doctor -v`** â€” Verbose diagnostics mode showing detailed check results.

### Track B: Native Command Migration

All 7 CLI commands converted from subprocess wrappers to native Python implementations:

| Command | Key Improvement |
|---------|----------------|
| `scaffold` | Fixed positional argument rejection (broken since v3.0) |
| `verify` | Positional path support |
| `query` | All 6 modes: `depends-on`, `depended-by`, `concept`, `stale`, `health`, `list-ids` |
| `consolidate` | Count and age-based modes |
| `stub` | Interactive and CLI modes |
| `promote` | Fuzzy ID matching |
| `migrate` | Schema migration |

### Bug Fixes

- **`scaffold` no longer rejects positional arguments** â€” Was broken since v3.0 due to argparse migration.
- **`consolidate` import crash on missing config defaults** (B1) â€” Fixed missing default values.
- **`promote` crash on absolute paths outside repo** (B2) â€” Now handles edge case gracefully.

### Architecture

- Commands now use `SessionContext` for transactional integrity.
- Centralized CLI registration in `ontos/cli.py`.
- Golden fixture tests ensure parity with legacy behavior.

### Known Limitations (deferred to v3.2)

- `consolidate --count 0` semantics (X-H2)
- `stub` type/id validation (X-M1)
- `scaffold` error messaging improvements (X-M2)
- `migrate` unsupported schema handling (X-M3)
- `query --health` cycle detection (X-M4)

**Full Changelog**: https://github.com/ohjonathan/Project-Ontos/compare/v3.0.5...v3.1.0
