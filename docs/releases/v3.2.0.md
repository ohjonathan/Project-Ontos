## What's Changed

Major feature release delivering three themes: **Re-Architecture Support**, **Environment Detection**, and **Activation Resilience**.

### ðŸŽ¯ Highlights

- New `ontos export data`, `ontos migrate`, and `ontos migration-report` commands for codebase re-architecture support.
- `ontos env` detects environment manifests (pyproject.toml, Brewfile, package.json, .tool-versions) and suggests new documents.
- Tiered context map (Tier 1: ~2k tokens, Tier 2: doc index, Tier 3: full graph) for smarter AI context management.
- `ontos map --sync-agents` auto-syncs AGENTS.md on every map generation.

---

### Theme 1: Re-Architecture Support

New commands to help projects migrate away from or between knowledge graph structures:

| Command | Purpose |
|---------|---------|
| `ontos export data` | Bulk JSON export with full dependency graph |
| `ontos export claude` | Generate CLAUDE.md (deprecates bare `export`) |
| `ontos migration-report` | Dependency analysis with safe/review/rewrite classification |
| `ontos migrate` | Convenience command (runs `export` + `migration-report`) |

### Theme 2: Environment Detection

- **`ontos env`** â€” Detects environment manifests in your repository:
  - `pyproject.toml`, `Brewfile`, `package.json`, `.tool-versions`, `requirements.txt`, and more.
- **`ontos doctor` environment check** â€” Now includes a 9th check that warns about missing or unparseable environment manifests.
- **Candidate suggestions** â€” Suggests documents to scaffold based on detected environments.

### Theme 3: Activation Resilience

- **Tiered context map** â€” New 3-tier structure replaces the flat context map:
  - **Tier 1 (~2k tokens)**: Project summary, recent activity, critical paths â€” enough for AI orientation.
  - **Tier 2**: Full document index with type and status.
  - **Tier 3**: Complete dependency graph, timelines, and health metrics.
- **`ontos map --sync-agents`** â€” Automatically regenerates AGENTS.md alongside the context map.
- **AGENTS.md Current Project State** â€” Shows branch, doc count, last log, and health status.
- **AGENTS.md Re-Activation Trigger** â€” Context recovery hints for when AI agents lose orientation.
- **USER CUSTOM section preservation** â€” Custom sections in AGENTS.md are preserved during regeneration using explicit markers.

### Bug Fixes

- Section-aware token truncation for Tier 1 (was character-based, now respects section boundaries).
- Pipe and newline escaping in Tier 1 tables.
- `gather_stats` optimized â€” only scans `docs/` and `logs/` directories, not the entire repo.

### Breaking Changes

- Context map format updated to `ontos_map_version: 2`. Old parsers expecting v1 format may need updates.
- `ontos export` without a subcommand now emits a deprecation warning and runs `export claude`.

**Full Changelog**: https://github.com/ohjonathan/Project-Ontos/compare/v3.1.1...v3.2.0
